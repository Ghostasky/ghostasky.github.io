<!DOCTYPE html>
<html itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">
  <head>
    
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
    <meta name="robots" content="noodp" />
    <title>Windows内核(九)——内存管理 - Ghostasky&#39;s Blog</title><meta name="author" content="">
<meta name="author-link" content="">
<meta name="description" content="" /><meta name="keywords" content='Win32' /><meta itemprop="name" content="Windows内核(九)——内存管理">
<meta itemprop="description" content=""><meta itemprop="datePublished" content="2023-03-05T00:00:00+00:00" />
<meta itemprop="dateModified" content="2023-03-05T00:00:00+00:00" />
<meta itemprop="wordCount" content="5994">
<meta itemprop="keywords" content="Win32," /><meta property="og:title" content="Windows内核(九)——内存管理" />
<meta property="og:description" content="" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://ghostasky.github.io/posts/2023-3-winkernel%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-03-05T00:00:00+00:00" />
<meta property="article:modified_time" content="2023-03-05T00:00:00+00:00" />

<meta name="twitter:card" content="summary"/><meta name="twitter:title" content="Windows内核(九)——内存管理"/>
<meta name="twitter:description" content=""/>
<meta name="application-name" content="FixIt">
<meta name="apple-mobile-web-app-title" content="FixIt"><meta name="theme-color" data-light="#f8f8f8" data-dark="#252627" content="#f8f8f8"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="canonical" href="http://ghostasky.github.io/posts/2023-3-winkernel%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/" /><link rel="prev" href="http://ghostasky.github.io/posts/2023-3-winkernel%E5%BC%82%E5%B8%B8/" /><link rel="next" href="http://ghostasky.github.io/posts/2023-3-winkernel%E6%B6%88%E6%81%AF%E6%9C%BA%E5%88%B6/" /><link rel="stylesheet" href="/css/style.min.css"><link rel="preload" href="/lib/fontawesome-free/all.min.css" as="style" onload="this.removeAttribute('onload');this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"></noscript><link rel="preload" href="/lib/animate/animate.min.css" as="style" onload="this.removeAttribute('onload');this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="/lib/animate/animate.min.css"></noscript><script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "BlogPosting",
    "headline": "Windows内核(九)——内存管理",
    "inLanguage": "zh-CN",
    "mainEntityOfPage": {
      "@type": "WebPage",
      "@id": "http:\/\/ghostasky.github.io\/posts\/2023-3-winkernel%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86\/"
    },"genre": "posts","keywords": "Win32","wordcount":  5994 ,
    "url": "http:\/\/ghostasky.github.io\/posts\/2023-3-winkernel%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86\/","datePublished": "2023-03-05T00:00:00+00:00","dateModified": "2023-03-05T00:00:00+00:00","publisher": {
      "@type": "Organization",
      "name": ""},"author": {
        "@type": "Person",
        "name": "作者"
      },"description": ""
  }
  </script></head>
  <body data-header-desktop="sticky" data-header-mobile="auto"><script>(window.localStorage?.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('auto' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'auto' === 'dark')) && document.body.setAttribute('data-theme', 'dark');</script><div class="wrapper" data-page-style="normal"><header class="desktop animate__faster" id="header-desktop">
  <div class="header-wrapper">
    <div class="header-title">
      <a href="/" title="Ghostasky&#39;s Blog"><img loading="lazy" src="/images/fixit.png" alt="Ghostasky&#39;s Blog" data-title="Ghostasky&#39;s Blog" class="logo" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/><span class="header-title-text">Ghostasky&#39;s Blog</span></a><span class="header-subtitle"></span></div>
    <nav>
      <ul class="menu"><li class="menu-item">
              <a
                class="menu-link"
                href="/posts/"
                
                
              >文章</a></li><li class="menu-item">
              <a
                class="menu-link"
                href="/categories/"
                
                
              >分类</a></li><li class="menu-item">
              <a
                class="menu-link"
                href="/tags/"
                
                
              >标签</a></li><li class="menu-item">
              <a
                class="menu-link"
                href="/about/"
                
                
              >关于</a></li><li class="menu-item delimiter"></li><li class="menu-item theme-switch" title="切换主题">
          <i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i>
        </li></ul>
    </nav>
  </div>
</header><header class="mobile animate__faster" id="header-mobile">
  <div class="header-container">
    <div class="header-wrapper">
      <div class="header-title">
        <a href="/" title="Ghostasky&#39;s Blog"><img loading="lazy" src="/images/fixit.png" alt="/images/fixit.png" data-title="/images/fixit.png" class="logo" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/><span class="header-title-text">Ghostasky&#39;s Blog</span></a><span class="header-subtitle"></span></div>
      <div class="menu-toggle" id="menu-toggle-mobile">
        <span></span><span></span><span></span>
      </div>
    </div>
    <nav>
      <ul class="menu" id="menu-mobile"><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/posts/"
                  
                  
                >文章</a></li><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/categories/"
                  
                  
                >分类</a></li><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/tags/"
                  
                  
                >标签</a></li><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/about/"
                  
                  
                >关于</a></li><li class="menu-item menu-system">
          <span class="menu-system-item theme-switch" title="切换主题"><i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i></span></li>
      </ul>
    </nav>
  </div>
</header><main class="container"><aside class="aside-collection animate__animated animate__fadeIn animate__faster" aria-label="合集"></aside>

  <article class="page single">
    <div class="header"><h1 class="single-title animate__animated animate__flipInX"><span>Windows内核(九)——内存管理</span>
      </h1></div><div class="post-meta">
      <div class="post-meta-line"><span class="post-author"><span class="author"><i class="fa-solid fa-user-circle" aria-hidden="true"></i>
      Anonymous</span></span><span class="post-included-in">&nbsp;收录于 <a href="/categories/technology/" class="post-category" title="分类 - Technology"><i class="fa-regular fa-folder fa-fw" aria-hidden="true"></i> Technology</a></span></div><div class="post-meta-line"><span title="发布于 2023-03-05 00:00:00"><i class="fa-solid fa-calendar-days fa-fw me-1" aria-hidden="true"></i><time datetime="2023-03-05">2023-03-05</time></span>&nbsp;<span title="5994 字"><i class="fa-solid fa-pencil-alt fa-fw me-1" aria-hidden="true"></i>约 6000 字</span>&nbsp;<span><i class="fa-regular fa-clock fa-fw me-1" aria-hidden="true"></i>预计阅读 12 分钟</span>&nbsp;</div>
    </div><div class="details toc" id="toc-static" data-kept="false">
        <div class="details-summary toc-title">
          <span>目录</span>
          <span><i class="details-icon fa-solid fa-angle-right" aria-hidden="true"></i></span>
        </div>
        <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#01线性地址的管理">01.线性地址的管理</a>
      <ul>
        <li><a href="#理解用户空间线性地址管理">理解用户空间线性地址管理</a></li>
        <li><a href="#总结">总结</a></li>
      </ul>
    </li>
    <li><a href="#02private-memory">02.Private Memory</a></li>
    <li><a href="#03mapped-memory">03.Mapped Memory</a>
      <ul>
        <li><a href="#共享内存">共享内存</a></li>
        <li><a href="#共享文件">共享文件</a></li>
        <li><a href="#总结-1">总结</a></li>
      </ul>
    </li>
    <li><a href="#04物理内存管理">04.物理内存管理</a>
      <ul>
        <li><a href="#物理内存管理">物理内存管理</a></li>
        <li><a href="#pfn">PFN</a></li>
      </ul>
    </li>
    <li><a href="#05缺页异常">05.缺页异常</a>
      <ul>
        <li><a href="#保留与提交">保留与提交</a></li>
        <li><a href="#写拷贝execute_writecopy">写拷贝（EXECUTE_WRITECOPY）</a></li>
      </ul>
    </li>
  </ul>
</nav></div>
      </div><div class="content" id="content"><p>[toc]</p>
<h2 id="01线性地址的管理" class="heading-element">
  <a href="#01%e7%ba%bf%e6%80%a7%e5%9c%b0%e5%9d%80%e7%9a%84%e7%ae%a1%e7%90%86" class="heading-mark"></a>01.线性地址的管理</h2><ol>
<li>每个进程都有自己的用户空间需要管理，当我们使用<strong>VirtualAlloc</strong>等函数申请一块固定的地址空间时，首先需要确认这块空间是否被占用，如果该空间已被占用则申请失败。</li>
<li>用户空间并非像内核空间一样通过一块链表去管理已占用的线性地址空间（效率低）， 而是通过<strong>搜索二叉树</strong></li>
</ol>
<p><strong>申请内存的两种方式</strong>：</p>
<ol>
<li>通过<strong>VirtualAlloc/VirtualAllocEx</strong>申请：<strong>Private Memory（独享物理页）</strong></li>
<li>通过<strong>CreateFileMapping</strong>进行映射：<strong>Mapped Memory（共享物理页）</strong></li>
</ol>
<p>进程空间的地址划分：</p>
<table>
<thead>
<tr>
<th>分区</th>
<th>x86 32位Windows</th>
</tr>
</thead>
<tbody>
<tr>
<td>空指针赋值区</td>
<td>0x00000000 - 0x0000FFFF</td>
</tr>
<tr>
<td>空指针赋值区</td>
<td>0x00010000 - 0x7FFEFFFF</td>
</tr>
<tr>
<td>64KB禁入区</td>
<td>0x7FFF0000 - 0x7FFFFFFF</td>
</tr>
<tr>
<td>内核</td>
<td>0x80000000 - 0xFFFFFFFF</td>
</tr>
</tbody>
</table>
<h3 id="理解用户空间线性地址管理" class="heading-element">
  <a href="#%e7%90%86%e8%a7%a3%e7%94%a8%e6%88%b7%e7%a9%ba%e9%97%b4%e7%ba%bf%e6%80%a7%e5%9c%b0%e5%9d%80%e7%ae%a1%e7%90%86" class="heading-mark"></a>理解用户空间线性地址管理</h3><p>随便找个exe：</p>
<div class="highlight" id="id-1"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">kd</span><span class="o">&gt;</span> <span class="n">dt</span> <span class="n">_eprocess</span> <span class="mf">85f</span><span class="n">d2b88</span>      
</span></span><span class="line"><span class="cl"><span class="n">ntdll</span><span class="o">!</span><span class="n">_EPROCESS</span>
</span></span><span class="line"><span class="cl">   <span class="p">...</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x11c</span> <span class="nl">VadRoot</span>          <span class="p">:</span> <span class="mh">0x86140188</span>   <span class="n">Void</span><span class="c1">//入口点，进去后是搜索二叉树,每一个节点记录了一块已被占用的线性地址空间
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="c1">//对应_MMVAD结构体
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="o">+</span><span class="mh">0x120</span> <span class="nl">VadHint</span>          <span class="p">:</span> <span class="mh">0x86140188</span>   <span class="n">Void</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="c1">////////////////////////////////////////////////////////////////////////////////
</span></span></span></code></pre></div><p>查看<code>_MMVAD</code>结构体：</p>
<div class="highlight" id="id-2"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">kd</span><span class="o">&gt;</span> <span class="n">dt</span> <span class="n">_mmvad</span> <span class="mh">0x86140188</span> 
</span></span><span class="line"><span class="cl"><span class="n">nt_exe</span><span class="o">!</span><span class="n">_MMVAD</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x000</span> <span class="nl">StartingVpn</span>      <span class="p">:</span> <span class="mh">0x2c60</span><span class="c1">//重要，以页为单位，后面添上三个0即是当前节点所描述的线性地址的起始位置
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="o">+</span><span class="mh">0x004</span> <span class="nl">EndingVpn</span>        <span class="p">:</span> <span class="mh">0x2c9f</span><span class="c1">//重要，以页为单位，后面添上三个0即是当前节点所描述的线性地址的结束位置
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="o">+</span><span class="mh">0x008</span> <span class="nl">Parent</span>           <span class="p">:</span> <span class="p">(</span><span class="n">null</span><span class="p">)</span> <span class="c1">//根节点，不存在父节点
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="o">+</span><span class="mh">0x00c</span> <span class="nl">LeftChild</span>        <span class="p">:</span> <span class="mh">0x863536e0</span> <span class="n">_MMVAD</span><span class="c1">//左子树
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="o">+</span><span class="mh">0x010</span> <span class="nl">RightChild</span>       <span class="p">:</span> <span class="mh">0x863392c8</span> <span class="n">_MMVAD</span><span class="c1">//右子树
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="o">+</span><span class="mh">0x014</span> <span class="nl">u</span>                <span class="p">:</span> <span class="n">__unnamed</span><span class="c1">//对应_MMVAD_FLAGS结构体
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="o">+</span><span class="mh">0x018</span> <span class="nl">ControlArea</span>      <span class="p">:</span> <span class="mh">0x0a040004</span> <span class="n">_CONTROL_AREA</span><span class="c1">//包含该节点所对应的线性地址被谁占用等信息
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="o">+</span><span class="mh">0x01c</span> <span class="nl">FirstPrototypePte</span> <span class="p">:</span> <span class="mh">0x53646156</span> <span class="n">_MMPTE</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x020</span> <span class="nl">LastContiguousPte</span> <span class="p">:</span> <span class="mh">0x00002c20</span> <span class="n">_MMPTE</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x024</span> <span class="nl">u2</span>               <span class="p">:</span> <span class="n">__unnamed</span></span></span></code></pre></div><p>查看<strong>CONTROL_AREA</strong>结构体：</p>
<div class="highlight" id="id-3"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">kd</span><span class="o">&gt;</span> <span class="n">dt</span> <span class="n">_CONTROL_AREA</span> <span class="mh">0x865224d8</span> 
</span></span><span class="line"><span class="cl"><span class="n">nt_exe</span><span class="o">!</span><span class="n">_CONTROL_AREA</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x000</span> <span class="nl">Segment</span>          <span class="p">:</span> <span class="mh">0xe14eb9b0</span> <span class="n">_SEGMENT</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x004</span> <span class="nl">DereferenceList</span>  <span class="p">:</span> <span class="n">_LIST_ENTRY</span> <span class="p">[</span> <span class="mh">0x0</span> <span class="o">-</span> <span class="mh">0x0</span> <span class="p">]</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x00c</span> <span class="nl">NumberOfSectionReferences</span> <span class="p">:</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x010</span> <span class="nl">NumberOfPfnReferences</span> <span class="p">:</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x014</span> <span class="nl">NumberOfMappedViews</span> <span class="p">:</span> <span class="mh">0x12</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x018</span> <span class="nl">NumberOfSubsections</span> <span class="p">:</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x01a</span> <span class="nl">FlushInProgressCount</span> <span class="p">:</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x01c</span> <span class="nl">NumberOfUserReferences</span> <span class="p">:</span> <span class="mh">0x13</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x020</span> <span class="nl">u</span>                <span class="p">:</span> <span class="n">__unnamed</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x024</span> <span class="nl">FilePointer</span>      <span class="p">:</span> <span class="p">(</span><span class="n">null</span><span class="p">)</span> <span class="c1">//文件指针,若为空，表示线性地址指向真正的物理页;如果不为null就是自己分配的内存
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="o">+</span><span class="mh">0x028</span> <span class="nl">WaitingForDeletion</span> <span class="p">:</span> <span class="p">(</span><span class="n">null</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x02c</span> <span class="nl">ModifiedWriteCount</span> <span class="p">:</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x02e</span> <span class="nl">NumberOfSystemCacheViews</span> <span class="p">:</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="n">kd</span><span class="o">&gt;</span> <span class="n">dt</span> <span class="n">_FILE_OBJECT</span>
</span></span><span class="line"><span class="cl"><span class="n">nt_exe</span><span class="o">!</span><span class="n">_FILE_OBJECT</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x000</span> <span class="nl">Type</span>             <span class="p">:</span> <span class="n">Int2B</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x002</span> <span class="nl">Size</span>             <span class="p">:</span> <span class="n">Int2B</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x004</span> <span class="nl">DeviceObject</span>     <span class="p">:</span> <span class="n">Ptr32</span> <span class="n">_DEVICE_OBJECT</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x008</span> <span class="nl">Vpb</span>              <span class="p">:</span> <span class="n">Ptr32</span> <span class="n">_VPB</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x00c</span> <span class="nl">FsContext</span>        <span class="p">:</span> <span class="n">Ptr32</span> <span class="n">Void</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x010</span> <span class="nl">FsContext2</span>       <span class="p">:</span> <span class="n">Ptr32</span> <span class="n">Void</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x014</span> <span class="nl">SectionObjectPointer</span> <span class="p">:</span> <span class="n">Ptr32</span> <span class="n">_SECTION_OBJECT_POINTERS</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x018</span> <span class="nl">PrivateCacheMap</span>  <span class="p">:</span> <span class="n">Ptr32</span> <span class="n">Void</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x01c</span> <span class="nl">FinalStatus</span>      <span class="p">:</span> <span class="n">Int4B</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x020</span> <span class="nl">RelatedFileObject</span> <span class="p">:</span> <span class="n">Ptr32</span> <span class="n">_FILE_OBJECT</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x024</span> <span class="nl">LockOperation</span>    <span class="p">:</span> <span class="n">UChar</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x025</span> <span class="nl">DeletePending</span>    <span class="p">:</span> <span class="n">UChar</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x026</span> <span class="nl">ReadAccess</span>       <span class="p">:</span> <span class="n">UChar</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x027</span> <span class="nl">WriteAccess</span>      <span class="p">:</span> <span class="n">UChar</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x028</span> <span class="nl">DeleteAccess</span>     <span class="p">:</span> <span class="n">UChar</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x029</span> <span class="nl">SharedRead</span>       <span class="p">:</span> <span class="n">UChar</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x02a</span> <span class="nl">SharedWrite</span>      <span class="p">:</span> <span class="n">UChar</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x02b</span> <span class="nl">SharedDelete</span>     <span class="p">:</span> <span class="n">UChar</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x02c</span> <span class="nl">Flags</span>            <span class="p">:</span> <span class="n">Uint4B</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x030</span> <span class="nl">FileName</span>         <span class="p">:</span> <span class="n">_UNICODE_STRING</span><span class="c1">//线性地址属于主模块
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="o">+</span><span class="mh">0x038</span> <span class="nl">CurrentByteOffset</span> <span class="p">:</span> <span class="n">_LARGE_INTEGER</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x040</span> <span class="nl">Waiters</span>          <span class="p">:</span> <span class="n">Uint4B</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x044</span> <span class="nl">Busy</span>             <span class="p">:</span> <span class="n">Uint4B</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x048</span> <span class="nl">LastLock</span>         <span class="p">:</span> <span class="n">Ptr32</span> <span class="n">Void</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x04c</span> <span class="nl">Lock</span>             <span class="p">:</span> <span class="n">_KEVENT</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x05c</span> <span class="nl">Event</span>            <span class="p">:</span> <span class="n">_KEVENT</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x06c</span> <span class="nl">CompletionContext</span> <span class="p">:</span> <span class="n">Ptr32</span> <span class="n">_IO_COMPLETION_CONTEXT</span></span></span></code></pre></div><p><strong>查看MMVAD_FLAGS结构体</strong></p>
<div class="highlight" id="id-4"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">kd</span><span class="o">&gt;</span> <span class="n">dt</span> <span class="n">_MMVAD_FLAGS</span> <span class="mh">0x86313578</span><span class="o">+</span><span class="mi">14</span>
</span></span><span class="line"><span class="cl"><span class="n">nt_exe</span><span class="o">!</span><span class="n">_MMVAD_FLAGS</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x000</span> <span class="nl">CommitCharge</span>     <span class="p">:</span> <span class="mi">0</span><span class="n">y0000000000000000000</span> <span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x000</span> <span class="nl">PhysicalMapping</span>  <span class="p">:</span> <span class="mi">0</span><span class="n">y0</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x000</span> <span class="nl">ImageMap</span>         <span class="p">:</span> <span class="mi">0</span><span class="n">y0</span><span class="c1">//为1表示镜像文件（可执行文件），0表示其他
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="o">+</span><span class="mh">0x000</span> <span class="nl">UserPhysicalPages</span> <span class="p">:</span> <span class="mi">0</span><span class="n">y0</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x000</span> <span class="nl">NoChange</span>         <span class="p">:</span> <span class="mi">0</span><span class="n">y0</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x000</span> <span class="nl">WriteWatch</span>       <span class="p">:</span> <span class="mi">0</span><span class="n">y0</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x000</span> <span class="nl">Protection</span>       <span class="p">:</span> <span class="mi">0</span><span class="n">y00100</span> <span class="p">(</span><span class="mh">0x4</span><span class="p">)</span><span class="c1">//表示内存权限
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="o">+</span><span class="mh">0x000</span> <span class="nl">LargePages</span>       <span class="p">:</span> <span class="mi">0</span><span class="n">y0</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x000</span> <span class="nl">MemCommit</span>        <span class="p">:</span> <span class="mi">0</span><span class="n">y0</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x000</span> <span class="nl">PrivateMemory</span>    <span class="p">:</span> <span class="mi">0</span><span class="n">y1</span><span class="c1">//0表示Mapped Memory
</span></span></span></code></pre></div><p><strong>遍历所有节点</strong>：</p>
<div class="highlight" id="id-5"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">kd</span><span class="o">&gt;</span> <span class="o">!</span><span class="n">vad</span> <span class="mh">0x86313578</span> <span class="err">（随便找了个）</span>
</span></span><span class="line"><span class="cl"><span class="n">VAD</span>   <span class="n">Level</span>     <span class="n">Start</span>       <span class="n">End</span> <span class="n">Commit</span>
</span></span><span class="line"><span class="cl"><span class="mi">86322</span><span class="n">b18</span>  <span class="mi">3</span>        <span class="mi">10</span>        <span class="mi">10</span>      <span class="mi">1</span> <span class="n">Private</span>      <span class="n">READWRITE</span>          
</span></span><span class="line"><span class="cl"><span class="mi">864</span><span class="n">ac328</span>  <span class="mi">2</span>        <span class="mi">20</span>        <span class="mi">20</span>      <span class="mi">1</span> <span class="n">Private</span>      <span class="n">READWRITE</span>          
</span></span><span class="line"><span class="cl"><span class="mi">86127360</span>  <span class="mi">5</span>        <span class="mi">30</span>        <span class="mf">3f</span>      <span class="mi">8</span> <span class="n">Private</span>      <span class="n">READWRITE</span>          
</span></span><span class="line"><span class="cl"><span class="mi">86330</span><span class="n">d60</span>  <span class="mi">4</span>        <span class="mi">40</span>        <span class="mf">7f</span>      <span class="mi">4</span> <span class="n">Private</span>      <span class="n">READWRITE</span>          
</span></span><span class="line"><span class="cl"><span class="mf">85f</span><span class="n">b1188</span>  <span class="mi">3</span>        <span class="mi">80</span>        <span class="mi">82</span>      <span class="mi">0</span> <span class="n">Mapped</span>       <span class="n">READONLY</span>           <span class="n">Pagefile</span> <span class="n">section</span><span class="p">,</span> <span class="n">shared</span> <span class="n">commit</span> <span class="mh">0x3</span>
</span></span><span class="line"><span class="cl"><span class="mi">8611</span><span class="n">ee50</span>  <span class="mi">4</span>        <span class="mi">90</span>        <span class="mi">91</span>      <span class="mi">0</span> <span class="n">Mapped</span>       <span class="n">READONLY</span>           <span class="n">Pagefile</span> <span class="n">section</span><span class="p">,</span> <span class="n">shared</span> <span class="n">commit</span> <span class="mh">0x2</span>
</span></span><span class="line"><span class="cl"><span class="mf">85f</span><span class="n">b7a08</span>  <span class="mi">1</span>        <span class="n">a0</span>       <span class="mf">19f</span>     <span class="mi">23</span> <span class="n">Private</span>      <span class="n">READWRITE</span>          
</span></span><span class="line"><span class="cl"><span class="mi">86322</span><span class="n">cf8</span>  <span class="mi">4</span>       <span class="mi">1</span><span class="n">a0</span>       <span class="mi">1</span><span class="n">af</span>      <span class="mi">6</span> <span class="n">Private</span>      <span class="n">READWRITE</span>          
</span></span><span class="line"><span class="cl"><span class="mi">8611</span><span class="n">ee20</span>  <span class="mi">3</span>       <span class="mi">1</span><span class="n">b0</span>       <span class="mi">1</span><span class="n">bf</span>      <span class="mi">0</span> <span class="n">Mapped</span>       <span class="n">READWRITE</span>          <span class="n">Pagefile</span> <span class="n">section</span><span class="p">,</span> <span class="n">shared</span> <span class="n">commit</span> <span class="mh">0x3</span>
</span></span><span class="line"><span class="cl"><span class="mf">8611f</span><span class="mi">6</span><span class="n">d8</span>  <span class="mi">4</span>       <span class="mi">1</span><span class="n">c0</span>       <span class="mi">1</span><span class="n">d5</span>      <span class="mi">0</span> <span class="n">Mapped</span>       <span class="n">READONLY</span>           <span class="err">\</span><span class="n">WINDOWS</span><span class="err">\</span><span class="n">system32</span><span class="err">\</span><span class="n">unicode</span><span class="p">.</span><span class="n">nls</span>
</span></span><span class="line"><span class="cl"><span class="mi">863129</span><span class="n">d0</span>  <span class="mi">2</span>       <span class="mf">1e0</span>       <span class="mi">220</span>      <span class="mi">0</span> <span class="n">Mapped</span>       <span class="n">READONLY</span>           <span class="err">\</span><span class="n">WINDOWS</span><span class="err">\</span><span class="n">system32</span><span class="err">\</span><span class="n">locale</span><span class="p">.</span><span class="n">nls</span>
</span></span><span class="line"><span class="cl"><span class="mi">86312910</span>  <span class="mi">4</span>       <span class="mi">230</span>       <span class="mi">270</span>      <span class="mi">0</span> <span class="n">Mapped</span>       <span class="n">READONLY</span>           <span class="err">\</span><span class="n">WINDOWS</span><span class="err">\</span><span class="n">system32</span><span class="err">\</span><span class="n">sortkey</span><span class="p">.</span><span class="n">nls</span>
</span></span><span class="line"><span class="cl"><span class="mi">86313488</span>  <span class="mi">3</span>       <span class="mi">280</span>       <span class="mi">285</span>      <span class="mi">0</span> <span class="n">Mapped</span>       <span class="n">READONLY</span>           <span class="err">\</span><span class="n">WINDOWS</span><span class="err">\</span><span class="n">system32</span><span class="err">\</span><span class="n">sorttbls</span><span class="p">.</span><span class="n">nls</span>
</span></span><span class="line"><span class="cl"><span class="mi">86313578</span>  <span class="mi">0</span>       <span class="mi">290</span>       <span class="mi">2</span><span class="n">d0</span>      <span class="mi">0</span> <span class="n">Mapped</span>       <span class="n">READONLY</span>           <span class="n">Pagefile</span> <span class="n">section</span><span class="p">,</span> <span class="n">shared</span> <span class="n">commit</span> <span class="mh">0x41</span>
</span></span><span class="line"><span class="cl"><span class="mi">86312</span><span class="n">a00</span>  <span class="mi">4</span>       <span class="mf">2e0</span>       <span class="mi">3</span><span class="n">a7</span>      <span class="mi">0</span> <span class="n">Mapped</span>       <span class="n">EXECUTE_READ</span>       <span class="n">Pagefile</span> <span class="n">section</span><span class="p">,</span> <span class="n">shared</span> <span class="n">commit</span> <span class="mh">0x8</span>
</span></span><span class="line"><span class="cl"><span class="mf">85f</span><span class="mi">96608</span>  <span class="mi">5</span>       <span class="mi">3</span><span class="n">b0</span>       <span class="mi">3</span><span class="n">b0</span>      <span class="mi">1</span> <span class="n">Private</span>      <span class="n">READWRITE</span>          
</span></span><span class="line"><span class="cl"><span class="mf">864583f</span><span class="mi">8</span>  <span class="mi">3</span>       <span class="mi">3</span><span class="n">c0</span>       <span class="mi">3</span><span class="n">c0</span>      <span class="mi">1</span> <span class="n">Private</span>      <span class="n">READWRITE</span>          
</span></span><span class="line"><span class="cl"><span class="mi">86124128</span>  <span class="mi">5</span>       <span class="mi">3</span><span class="n">d0</span>       <span class="mi">3</span><span class="n">df</span>      <span class="mi">5</span> <span class="n">Private</span>      <span class="n">READWRITE</span>          
</span></span><span class="line"><span class="cl"><span class="mi">8611</span><span class="n">ef10</span>  <span class="mi">4</span>       <span class="mf">3e0</span>       <span class="mf">3e1</span>      <span class="mi">0</span> <span class="n">Mapped</span>       <span class="n">READONLY</span>           <span class="n">Pagefile</span> <span class="n">section</span><span class="p">,</span> <span class="n">shared</span> <span class="n">commit</span> <span class="mh">0x2</span>
</span></span><span class="line"><span class="cl"><span class="mf">85f</span><span class="n">b1bc8</span>  <span class="mi">6</span>       <span class="mf">3f</span><span class="mi">0</span>       <span class="mf">3f</span><span class="mi">0</span>      <span class="mi">0</span> <span class="n">Mapped</span>       <span class="n">READWRITE</span>          <span class="n">Pagefile</span> <span class="n">section</span><span class="p">,</span> <span class="n">shared</span> <span class="n">commit</span> <span class="mh">0x1</span>
</span></span><span class="line"><span class="cl"><span class="mf">85f</span><span class="n">b1e68</span>  <span class="mi">5</span>       <span class="mi">400</span>       <span class="mi">401</span>      <span class="mi">0</span> <span class="n">Mapped</span>       <span class="n">READONLY</span>           <span class="n">Pagefile</span> <span class="n">section</span><span class="p">,</span> <span class="n">shared</span> <span class="n">commit</span> <span class="mh">0x2</span>
</span></span><span class="line"><span class="cl"><span class="mf">85f</span><span class="n">bbd98</span>  <span class="mi">2</span>       <span class="mi">410</span>       <span class="mf">41f</span>      <span class="mi">8</span> <span class="n">Private</span>      <span class="n">READWRITE</span>          
</span></span><span class="line"><span class="cl"><span class="mf">8612f</span><span class="mi">808</span>  <span class="mi">4</span>       <span class="mi">420</span>       <span class="mf">42f</span>      <span class="mi">4</span> <span class="n">Private</span>      <span class="n">READWRITE</span>          
</span></span><span class="line"><span class="cl"><span class="mf">85f</span><span class="n">a8e50</span>  <span class="mi">3</span>       <span class="mi">430</span>       <span class="mi">432</span>      <span class="mi">0</span> <span class="n">Mapped</span>       <span class="n">READONLY</span>           <span class="err">\</span><span class="n">WINDOWS</span><span class="err">\</span><span class="n">system32</span><span class="err">\</span><span class="n">ctype</span><span class="p">.</span><span class="n">nls</span>
</span></span><span class="line"><span class="cl"><span class="mf">85f</span><span class="n">b9e28</span>  <span class="mi">5</span>       <span class="mi">440</span>       <span class="mf">47f</span>      <span class="mi">3</span> <span class="n">Private</span>      <span class="n">READWRITE</span>          
</span></span><span class="line"><span class="cl"><span class="mi">8631</span><span class="n">b8e0</span>  <span class="mi">4</span>       <span class="mi">480</span>       <span class="mi">582</span>      <span class="mi">0</span> <span class="n">Mapped</span>       <span class="n">READONLY</span>           <span class="n">Pagefile</span> <span class="n">section</span><span class="p">,</span> <span class="n">shared</span> <span class="n">commit</span> <span class="mh">0x103</span>
</span></span><span class="line"><span class="cl"><span class="mi">863128</span><span class="n">b0</span>  <span class="mi">6</span>       <span class="mi">590</span>       <span class="mf">88f</span>      <span class="mi">0</span> <span class="n">Mapped</span>       <span class="n">EXECUTE_READ</span>       <span class="n">Pagefile</span> <span class="n">section</span><span class="p">,</span> <span class="n">shared</span> <span class="n">commit</span> <span class="mh">0x26</span>
</span></span><span class="line"><span class="cl"><span class="mf">85f</span><span class="n">b79c8</span>  <span class="mi">5</span>       <span class="mi">890</span>       <span class="mf">90f</span>      <span class="mi">1</span> <span class="n">Private</span>      <span class="n">READWRITE</span>          
</span></span><span class="line"><span class="cl"><span class="mf">85f</span><span class="n">b1fa8</span>  <span class="mi">7</span>       <span class="mi">910</span>       <span class="mf">94f</span>      <span class="mi">0</span> <span class="n">Mapped</span>       <span class="n">READWRITE</span>          <span class="n">Pagefile</span> <span class="n">section</span><span class="p">,</span> <span class="n">shared</span> <span class="n">commit</span> <span class="mh">0x10</span>
</span></span><span class="line"><span class="cl"><span class="mf">85f</span><span class="n">b1f78</span>  <span class="mi">6</span>       <span class="mi">950</span>       <span class="mi">95</span><span class="n">d</span>      <span class="mi">0</span> <span class="n">Mapped</span>       <span class="n">READWRITE</span>          <span class="n">Pagefile</span> <span class="n">section</span><span class="p">,</span> <span class="n">shared</span> <span class="n">commit</span> <span class="mh">0xe</span>
</span></span><span class="line"><span class="cl"><span class="mf">85f</span><span class="n">c1610</span>  <span class="mi">7</span>       <span class="mi">960</span>       <span class="n">a5f</span>    <span class="mi">123</span> <span class="n">Private</span>      <span class="n">READWRITE</span>          
</span></span><span class="line"><span class="cl"><span class="mi">86321260</span>  <span class="mi">8</span>       <span class="n">a60</span>       <span class="n">a63</span>      <span class="mi">0</span> <span class="n">Mapped</span>       <span class="n">READWRITE</span>          <span class="n">Pagefile</span> <span class="n">section</span><span class="p">,</span> <span class="n">shared</span> <span class="n">commit</span> <span class="mh">0x4</span>
</span></span><span class="line"><span class="cl"><span class="mi">8631</span><span class="n">ccc8</span>  <span class="mi">9</span>       <span class="n">a80</span>       <span class="n">aff</span>      <span class="mi">0</span> <span class="n">Mapped</span>       <span class="n">READWRITE</span>          <span class="n">Pagefile</span> <span class="n">section</span><span class="p">,</span> <span class="n">shared</span> <span class="n">commit</span> <span class="mh">0x7</span>
</span></span><span class="line"><span class="cl"><span class="mi">86476</span><span class="n">b08</span>  <span class="mi">1</span>      <span class="mi">1000</span>      <span class="mi">101</span><span class="n">e</span>      <span class="mi">3</span> <span class="n">Mapped</span>  <span class="n">Exe</span>  <span class="n">EXECUTE_WRITECOPY</span>  <span class="err">\</span><span class="n">WINDOWS</span><span class="err">\</span><span class="n">system32</span><span class="err">\</span><span class="n">calc</span><span class="p">.</span><span class="n">exe</span>
</span></span><span class="line"><span class="cl"><span class="mi">86313458</span>  <span class="mi">8</span>     <span class="mf">58f</span><span class="n">b0</span>     <span class="mi">59179</span>     <span class="mi">10</span> <span class="n">Mapped</span>  <span class="n">Exe</span>  <span class="n">EXECUTE_WRITECOPY</span>  <span class="err">\</span><span class="n">WINDOWS</span><span class="err">\</span><span class="n">AppPatch</span><span class="err">\</span><span class="n">AcGenral</span><span class="p">.</span><span class="n">dll</span>
</span></span><span class="line"><span class="cl"><span class="mf">863133f</span><span class="mi">8</span>  <span class="mi">9</span>     <span class="mi">5</span><span class="n">adc0</span>     <span class="mi">5</span><span class="n">adf6</span>      <span class="mi">2</span> <span class="n">Mapped</span>  <span class="n">Exe</span>  <span class="n">EXECUTE_WRITECOPY</span>  <span class="err">\</span><span class="n">WINDOWS</span><span class="err">\</span><span class="n">system32</span><span class="err">\</span><span class="n">uxtheme</span><span class="p">.</span><span class="n">dll</span>
</span></span><span class="line"><span class="cl"><span class="mi">86312</span><span class="n">a30</span>  <span class="mi">7</span>     <span class="mi">5</span><span class="n">cc30</span>     <span class="mi">5</span><span class="n">cc55</span>     <span class="mi">21</span> <span class="n">Mapped</span>  <span class="n">Exe</span>  <span class="n">EXECUTE_WRITECOPY</span>  <span class="err">\</span><span class="n">WINDOWS</span><span class="err">\</span><span class="n">system32</span><span class="err">\</span><span class="n">shimeng</span><span class="p">.</span><span class="n">dll</span>
</span></span><span class="line"><span class="cl"><span class="mi">8611</span><span class="n">da38</span> <span class="mi">11</span>     <span class="mi">62</span><span class="n">c20</span>     <span class="mi">62</span><span class="n">c28</span>      <span class="mi">2</span> <span class="n">Mapped</span>  <span class="n">Exe</span>  <span class="n">EXECUTE_WRITECOPY</span>  <span class="err">\</span><span class="n">WINDOWS</span><span class="err">\</span><span class="n">system32</span><span class="err">\</span><span class="n">lpk</span><span class="p">.</span><span class="n">dll</span>
</span></span><span class="line"><span class="cl"><span class="mf">85f</span><span class="n">b2b10</span> <span class="mi">13</span>     <span class="mi">73640</span>     <span class="mi">7366</span><span class="n">d</span>      <span class="mi">2</span> <span class="n">Mapped</span>  <span class="n">Exe</span>  <span class="n">EXECUTE_WRITECOPY</span>  <span class="err">\</span><span class="n">WINDOWS</span><span class="err">\</span><span class="n">system32</span><span class="err">\</span><span class="n">MSCTFIME</span><span class="p">.</span><span class="n">IME</span>
</span></span><span class="line"><span class="cl"><span class="mf">863158f</span><span class="mi">8</span> <span class="mi">12</span>     <span class="mf">73f</span><span class="n">a0</span>     <span class="mi">7400</span><span class="n">a</span>     <span class="mi">17</span> <span class="n">Mapped</span>  <span class="n">Exe</span>  <span class="n">EXECUTE_WRITECOPY</span>  <span class="err">\</span><span class="n">WINDOWS</span><span class="err">\</span><span class="n">system32</span><span class="err">\</span><span class="n">usp10</span><span class="p">.</span><span class="n">dll</span>
</span></span><span class="line"><span class="cl"><span class="mf">85f</span><span class="n">b2c10</span> <span class="mi">13</span>     <span class="mi">74680</span>     <span class="mi">746</span><span class="n">cb</span>      <span class="mi">3</span> <span class="n">Mapped</span>  <span class="n">Exe</span>  <span class="n">EXECUTE_WRITECOPY</span>  <span class="err">\</span><span class="n">WINDOWS</span><span class="err">\</span><span class="n">system32</span><span class="err">\</span><span class="n">MSCTF</span><span class="p">.</span><span class="n">dll</span>
</span></span><span class="line"><span class="cl"><span class="mf">85f</span><span class="n">af260</span> <span class="mi">10</span>     <span class="mi">759</span><span class="n">d0</span>     <span class="mi">75</span><span class="n">a7e</span>      <span class="mi">3</span> <span class="n">Mapped</span>  <span class="n">Exe</span>  <span class="n">EXECUTE_WRITECOPY</span>  <span class="err">\</span><span class="n">WINDOWS</span><span class="err">\</span><span class="n">system32</span><span class="err">\</span><span class="n">userenv</span><span class="p">.</span><span class="n">dll</span>
</span></span><span class="line"><span class="cl"><span class="mi">86313518</span> <span class="mi">11</span>     <span class="mi">76300</span>     <span class="mi">7631</span><span class="n">c</span>      <span class="mi">2</span> <span class="n">Mapped</span>  <span class="n">Exe</span>  <span class="n">EXECUTE_WRITECOPY</span>  <span class="err">\</span><span class="n">WINDOWS</span><span class="err">\</span><span class="n">system32</span><span class="err">\</span><span class="n">imm32</span><span class="p">.</span><span class="n">dll</span>
</span></span><span class="line"><span class="cl"><span class="mf">863128e0</span>  <span class="mi">9</span>     <span class="mi">76990</span>     <span class="mi">76</span><span class="n">acd</span>      <span class="mi">8</span> <span class="n">Mapped</span>  <span class="n">Exe</span>  <span class="n">EXECUTE_WRITECOPY</span>  <span class="err">\</span><span class="n">WINDOWS</span><span class="err">\</span><span class="n">system32</span><span class="err">\</span><span class="n">ole32</span><span class="p">.</span><span class="n">dll</span>
</span></span><span class="line"><span class="cl"><span class="mi">86315830</span>  <span class="mi">8</span>     <span class="mi">76</span><span class="n">b10</span>     <span class="mi">76</span><span class="n">b39</span>      <span class="mi">3</span> <span class="n">Mapped</span>  <span class="n">Exe</span>  <span class="n">EXECUTE_WRITECOPY</span>  <span class="err">\</span><span class="n">WINDOWS</span><span class="err">\</span><span class="n">system32</span><span class="err">\</span><span class="n">winmm</span><span class="p">.</span><span class="n">dll</span>
</span></span><span class="line"><span class="cl"><span class="mf">85f</span><span class="n">a8e20</span>  <span class="mi">9</span>     <span class="mf">770f</span><span class="mi">0</span>     <span class="mi">7717</span><span class="n">a</span>      <span class="mi">4</span> <span class="n">Mapped</span>  <span class="n">Exe</span>  <span class="n">EXECUTE_WRITECOPY</span>  <span class="err">\</span><span class="n">WINDOWS</span><span class="err">\</span><span class="n">system32</span><span class="err">\</span><span class="n">oleaut32</span><span class="p">.</span><span class="n">dll</span>
</span></span><span class="line"><span class="cl"><span class="mi">86313398</span> <span class="mi">11</span>     <span class="mi">77180</span>     <span class="mi">77282</span>      <span class="mi">2</span> <span class="n">Mapped</span>  <span class="n">Exe</span>  <span class="n">EXECUTE_WRITECOPY</span>  <span class="err">\</span><span class="n">WINDOWS</span><span class="err">\</span><span class="n">WinSxS</span><span class="err">\</span><span class="n">x86_Microsoft</span><span class="p">.</span><span class="n">Windows</span><span class="p">.</span><span class="n">Common</span><span class="o">-</span><span class="n">Controls_6595b64144ccf1df_6</span><span class="mf">.0.2600.6028</span><span class="n">_x</span><span class="o">-</span><span class="n">ww_61e65202</span><span class="err">\</span><span class="n">comctl32</span><span class="p">.</span><span class="n">dll</span>
</span></span><span class="line"><span class="cl"><span class="mf">85f</span><span class="n">abd48</span> <span class="mi">10</span>     <span class="mi">77</span><span class="n">bb0</span>     <span class="mi">77</span><span class="n">bc4</span>      <span class="mi">2</span> <span class="n">Mapped</span>  <span class="n">Exe</span>  <span class="n">EXECUTE_WRITECOPY</span>  <span class="err">\</span><span class="n">WINDOWS</span><span class="err">\</span><span class="n">system32</span><span class="err">\</span><span class="n">msacm32</span><span class="p">.</span><span class="n">dll</span>
</span></span><span class="line"><span class="cl"><span class="mf">863134e8</span> <span class="mi">11</span>     <span class="mi">77</span><span class="n">bd0</span>     <span class="mi">77</span><span class="n">bd7</span>      <span class="mi">2</span> <span class="n">Mapped</span>  <span class="n">Exe</span>  <span class="n">EXECUTE_WRITECOPY</span>  <span class="err">\</span><span class="n">WINDOWS</span><span class="err">\</span><span class="n">system32</span><span class="err">\</span><span class="n">version</span><span class="p">.</span><span class="n">dll</span>
</span></span><span class="line"><span class="cl"><span class="mi">86313428</span>  <span class="mi">6</span>     <span class="mi">77</span><span class="n">be0</span>     <span class="mi">77</span><span class="n">c37</span>      <span class="mi">8</span> <span class="n">Mapped</span>  <span class="n">Exe</span>  <span class="n">EXECUTE_WRITECOPY</span>  <span class="err">\</span><span class="n">WINDOWS</span><span class="err">\</span><span class="n">system32</span><span class="err">\</span><span class="n">msvcrt</span><span class="p">.</span><span class="n">dll</span>
</span></span><span class="line"><span class="cl"><span class="mi">8613</span><span class="n">c0e0</span>  <span class="mi">5</span>     <span class="mi">77</span><span class="n">d10</span>     <span class="mi">77</span><span class="n">d9f</span>      <span class="mi">3</span> <span class="n">Mapped</span>  <span class="n">Exe</span>  <span class="n">EXECUTE_WRITECOPY</span>  <span class="err">\</span><span class="n">WINDOWS</span><span class="err">\</span><span class="n">system32</span><span class="err">\</span><span class="n">user32</span><span class="p">.</span><span class="n">dll</span>
</span></span><span class="line"><span class="cl"><span class="mf">8611e1</span><span class="n">d0</span>  <span class="mi">4</span>     <span class="mi">77</span><span class="n">da0</span>     <span class="mf">77e48</span>      <span class="mi">6</span> <span class="n">Mapped</span>  <span class="n">Exe</span>  <span class="n">EXECUTE_WRITECOPY</span>  <span class="err">\</span><span class="n">WINDOWS</span><span class="err">\</span><span class="n">system32</span><span class="err">\</span><span class="n">advapi32</span><span class="p">.</span><span class="n">dll</span>
</span></span><span class="line"><span class="cl"><span class="mi">86312970</span>  <span class="mi">5</span>     <span class="mf">77e50</span>     <span class="mi">77</span><span class="n">ee2</span>      <span class="mi">2</span> <span class="n">Mapped</span>  <span class="n">Exe</span>  <span class="n">EXECUTE_WRITECOPY</span>  <span class="err">\</span><span class="n">WINDOWS</span><span class="err">\</span><span class="n">system32</span><span class="err">\</span><span class="n">rpcrt4</span><span class="p">.</span><span class="n">dll</span>
</span></span><span class="line"><span class="cl"><span class="mf">85f</span><span class="n">a83d8</span>  <span class="mi">7</span>     <span class="mi">77</span><span class="n">ef0</span>     <span class="mf">77f</span><span class="mi">39</span>      <span class="mi">3</span> <span class="n">Mapped</span>  <span class="n">Exe</span>  <span class="n">EXECUTE_WRITECOPY</span>  <span class="err">\</span><span class="n">WINDOWS</span><span class="err">\</span><span class="n">system32</span><span class="err">\</span><span class="n">gdi32</span><span class="p">.</span><span class="n">dll</span>
</span></span><span class="line"><span class="cl"><span class="mi">863133</span><span class="n">c8</span>  <span class="mi">8</span>     <span class="mf">77f</span><span class="mi">40</span>     <span class="mf">77f</span><span class="n">b5</span>      <span class="mi">2</span> <span class="n">Mapped</span>  <span class="n">Exe</span>  <span class="n">EXECUTE_WRITECOPY</span>  <span class="err">\</span><span class="n">WINDOWS</span><span class="err">\</span><span class="n">system32</span><span class="err">\</span><span class="n">shlwapi</span><span class="p">.</span><span class="n">dll</span>
</span></span><span class="line"><span class="cl"><span class="mi">863129</span><span class="n">a0</span>  <span class="mi">6</span>     <span class="mf">77f</span><span class="n">c0</span>     <span class="mf">77f</span><span class="n">d0</span>      <span class="mi">2</span> <span class="n">Mapped</span>  <span class="n">Exe</span>  <span class="n">EXECUTE_WRITECOPY</span>  <span class="err">\</span><span class="n">WINDOWS</span><span class="err">\</span><span class="n">system32</span><span class="err">\</span><span class="n">secur32</span><span class="p">.</span><span class="n">dll</span>
</span></span><span class="line"><span class="cl"><span class="mi">864</span><span class="n">b70d8</span>  <span class="mi">3</span>     <span class="mi">7</span><span class="n">c800</span>     <span class="mi">7</span><span class="n">c91d</span>      <span class="mi">6</span> <span class="n">Mapped</span>  <span class="n">Exe</span>  <span class="n">EXECUTE_WRITECOPY</span>  <span class="err">\</span><span class="n">WINDOWS</span><span class="err">\</span><span class="n">system32</span><span class="err">\</span><span class="n">kernel32</span><span class="p">.</span><span class="n">dll</span>
</span></span><span class="line"><span class="cl"><span class="mi">8611</span><span class="n">eee0</span>  <span class="mi">2</span>     <span class="mi">7</span><span class="n">c920</span>     <span class="mi">7</span><span class="n">c9b2</span>      <span class="mi">5</span> <span class="n">Mapped</span>  <span class="n">Exe</span>  <span class="n">EXECUTE_WRITECOPY</span>  <span class="err">\</span><span class="n">WINDOWS</span><span class="err">\</span><span class="n">system32</span><span class="err">\</span><span class="n">ntdll</span><span class="p">.</span><span class="n">dll</span>
</span></span><span class="line"><span class="cl"><span class="mi">863135</span><span class="n">a8</span>  <span class="mi">5</span>     <span class="mi">7</span><span class="n">d590</span>     <span class="mi">7</span><span class="n">dd83</span>     <span class="mi">31</span> <span class="n">Mapped</span>  <span class="n">Exe</span>  <span class="n">EXECUTE_WRITECOPY</span>  <span class="err">\</span><span class="n">WINDOWS</span><span class="err">\</span><span class="n">system32</span><span class="err">\</span><span class="n">shell32</span><span class="p">.</span><span class="n">dll</span>
</span></span><span class="line"><span class="cl"><span class="mi">863134</span><span class="n">b8</span>  <span class="mi">4</span>     <span class="mf">7f6f</span><span class="mi">0</span>     <span class="mf">7f</span><span class="mi">7</span><span class="n">ef</span>      <span class="mi">0</span> <span class="n">Mapped</span>       <span class="n">EXECUTE_READ</span>       <span class="n">Pagefile</span> <span class="n">section</span><span class="p">,</span> <span class="n">shared</span> <span class="n">commit</span> <span class="mh">0x7</span>
</span></span><span class="line"><span class="cl"><span class="mf">85f</span><span class="n">a21a0</span>  <span class="mi">3</span>     <span class="mf">7ff</span><span class="n">a0</span>     <span class="mf">7ff</span><span class="n">d2</span>      <span class="mi">0</span> <span class="n">Mapped</span>       <span class="n">READONLY</span>           <span class="n">Pagefile</span> <span class="n">section</span><span class="p">,</span> <span class="n">shared</span> <span class="n">commit</span> <span class="mh">0x33</span>
</span></span><span class="line"><span class="cl"><span class="mi">86305638</span>  <span class="mi">4</span>     <span class="mf">7ff</span><span class="n">dd</span>     <span class="mf">7ff</span><span class="n">dd</span>      <span class="mi">1</span> <span class="n">Private</span>      <span class="n">READWRITE</span>          
</span></span><span class="line"><span class="cl"><span class="mi">864</span><span class="n">a8530</span>  <span class="mi">5</span>     <span class="mf">7ff</span><span class="n">df</span>     <span class="mf">7ff</span><span class="n">df</span>      <span class="mi">1</span> <span class="n">Private</span>      <span class="n">READWRITE</span>          
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">Total</span> <span class="nl">VADs</span><span class="p">:</span> <span class="mi">63</span><span class="p">,</span> <span class="n">average</span> <span class="nl">level</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span> <span class="n">maximum</span> <span class="nl">depth</span><span class="p">:</span> <span class="mi">13</span>
</span></span><span class="line"><span class="cl"><span class="n">Total</span> <span class="n">private</span> <span class="nl">commit</span><span class="p">:</span> <span class="mh">0x159</span> <span class="nf">pages</span> <span class="p">(</span><span class="mi">1380</span> <span class="n">KB</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Total</span> <span class="n">shared</span> <span class="nl">commit</span><span class="p">:</span>  <span class="mh">0x1e2</span> <span class="nf">pages</span> <span class="p">(</span><span class="mi">1928</span> <span class="n">KB</span><span class="p">)</span></span></span></code></pre></div><h3 id="总结" class="heading-element">
  <a href="#%e6%80%bb%e7%bb%93" class="heading-mark"></a>总结</h3><ol>
<li>
<p>所有的线性地址空间是需要管理的（哪些地址是占用的，哪些地址是未占用的）</p>
</li>
<li>
<p>所有用户线性地址空间通过搜索二叉树进行管理（占用大小，占用方式，内存属性）</p>
</li>
<li>
<p>所有已占用的线性地址可以分为两类</p>
<ol>
<li>
<p>VirtualAlloc分配的普通内存</p>
</li>
<li>
<p>文件映射（Mapped）的内存（例如dll/exe/txt等）</p>
</li>
</ol>
</li>
<li>
<p>传统的模块隐藏技术，终究会在VadRoot中留下痕迹，假设摘除，操作系统会误认为该地址空间未被分配，从而产生非预期中的错误</p>
</li>
</ol>
<h2 id="02private-memory" class="heading-element">
  <a href="#02private-memory" class="heading-mark"></a>02.Private Memory</h2><p>通过<strong>VirtualAlloc/VirtualAllocEx</strong>申请的内存，叫做Private Memory</p>
<p>函数原型：</p>
<div class="highlight" id="id-6"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">LPVOID</span> <span class="n">VirtualAlloc</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">LPVOID</span> <span class="n">lpAddress</span><span class="p">,</span> 		<span class="c1">// 要分配的内存区域的地址，填0则随机分配一块符合条件的地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">dwSize</span><span class="p">,</span> 			<span class="c1">// 分配的大小，4kb对齐
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">flAllocationType</span><span class="p">,</span> 	<span class="c1">// 分配的类型
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>							<span class="c1">// MEM_RESERVE：只保留线性地址，不分配物理页
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>							<span class="c1">// MEM_COMMIT：既保留线性地址，又分配物理页
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">flProtect</span> 			<span class="c1">// 该内存的初始保护属性
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">};</span></span></span></code></pre></div><p>代码：</p>
<div class="highlight" id="id-7"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">##include &lt;stdio.h&gt;
</span></span></span><span class="line"><span class="cl"><span class="cp">##include &lt;windows.h&gt;
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="n">LPVOID</span> <span class="n">lpAddress</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nf">printf</span><span class="p">(</span><span class="s">&#34;程序运行了...内存还没有申请</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="nf">getchar</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">lpAddress</span> <span class="o">=</span> <span class="nf">VirtualAlloc</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="mh">0x1000</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span> <span class="n">MEM_COMMIT</span><span class="p">,</span> <span class="n">PAGE_READWRITE</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="nf">printf</span><span class="p">(</span><span class="s">&#34;内存地址：%x</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">lpAddress</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nf">getchar</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div><p>可以对比<code>VirtualAlloc</code>前后的不同，这里就不贴图了。</p>
<h2 id="03mapped-memory" class="heading-element">
  <a href="#03mapped-memory" class="heading-mark"></a>03.Mapped Memory</h2><ol>
<li>通过<code>CreateFileMapping</code>映射的内存，叫做Mapped Memory，一个进程中大部分的内存都属于Mapped Memory</li>
<li>Mapped Memory可以分为两类
<ol>
<li>共享内存：当内存为共享内存时，本质是共享一份物理页</li>
<li>共享文件：当内存为共享文件时，这块内存可能被映射到多个进程空间中，但真正占用的物理页只有一份</li>
</ol>
</li>
<li>无论是共享内存还是文件，在底层实现都是一样的，当我们需要共享物理页的时候，系统只需将物理页准备好，当我们需要共享文件时，系统先将物理页准备好，然后将物理页与文件进行关联</li>
</ol>
<h3 id="共享内存" class="heading-element">
  <a href="#%e5%85%b1%e4%ba%ab%e5%86%85%e5%ad%98" class="heading-mark"></a>共享内存</h3><p>代码1：</p>
<div class="highlight" id="id-8"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">##include &lt;stdio.h&gt;
</span></span></span><span class="line"><span class="cl"><span class="cp">##include &lt;windows.h&gt;
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">##define MapFileName &#34;共享内存&#34;
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">//内核对象：1.物理页	2. 文件
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">//准备一块内存，若第一个参数为INVALID_HANDLE_VALUE(-1)表示共享物理页
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">HANDLE</span> <span class="n">g_hMapFile</span> <span class="o">=</span> <span class="nf">CreateFileMapping</span><span class="p">(</span><span class="n">INVALID_HANDLE_VALUE</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">PAGE_READWRITE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">BUFSIZ</span><span class="p">,</span> <span class="n">MapFileName</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">//将物理页与线性地址进行映射
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">LPTSTR</span> <span class="n">g_lpBuff</span> <span class="o">=</span> <span class="p">(</span><span class="n">LPTSTR</span><span class="p">)</span><span class="nf">MapViewOfFile</span><span class="p">(</span><span class="n">g_hMapFile</span><span class="p">,</span> <span class="n">FILE_MAP_ALL_ACCESS</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">BUFSIZ</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="o">*</span><span class="p">(</span><span class="n">PDWORD</span><span class="p">)</span><span class="n">g_lpBuff</span> <span class="o">=</span> <span class="mh">0x12345678</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nf">printf</span><span class="p">(</span><span class="s">&#34;A进程写入地址，内容：%p - %x&#34;</span><span class="p">,</span> <span class="n">g_lpBuff</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">PDWORD</span><span class="p">)</span><span class="n">g_lpBuff</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nf">getchar</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div><p>代码2：</p>
<div class="highlight" id="id-9"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">##include &lt;stdio.h&gt;
</span></span></span><span class="line"><span class="cl"><span class="cp">##include &lt;windows.h&gt;
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">##define MapFileName &#34;共享内存&#34;
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">//内核对象：1.物理页	2. 文件
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">HANDLE</span> <span class="n">g_hMapFile</span> <span class="o">=</span> <span class="nf">OpenFileMapping</span><span class="p">(</span><span class="n">FILE_MAP_ALL_ACCESS</span><span class="p">,</span> <span class="n">FALSE</span><span class="p">,</span> <span class="n">MapFileName</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">//将物理页与线性地址进行映射
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">LPTSTR</span> <span class="n">g_lpBuff</span> <span class="o">=</span> <span class="p">(</span><span class="n">LPTSTR</span><span class="p">)</span><span class="nf">MapViewOfFile</span><span class="p">(</span><span class="n">g_hMapFile</span><span class="p">,</span> <span class="n">FILE_MAP_ALL_ACCESS</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">BUFSIZ</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nf">printf</span><span class="p">(</span><span class="s">&#34;B进程读取地址，内容：%p - %x&#34;</span><span class="p">,</span> <span class="n">g_lpBuff</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">PDWORD</span><span class="p">)</span><span class="n">g_lpBuff</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nf">getchar</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div><h3 id="共享文件" class="heading-element">
  <a href="#%e5%85%b1%e4%ba%ab%e6%96%87%e4%bb%b6" class="heading-mark"></a>共享文件</h3><p>示例代码，ret的地方断点：</p>
<div class="highlight" id="id-10"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">##include &lt;stdio.h&gt;
</span></span></span><span class="line"><span class="cl"><span class="cp">##include &lt;windows.h&gt;
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">//内核对象：1.物理页	2. 文件
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">HANDLE</span> <span class="n">g_hFile</span> <span class="o">=</span> <span class="nf">CreateFile</span><span class="p">(</span><span class="s">&#34;C:</span><span class="se">\\</span><span class="s">NOTEPAD.EXE&#34;</span><span class="p">,</span><span class="n">GENERIC_READ</span><span class="o">|</span><span class="n">GENERIC_WRITE</span><span class="p">,</span><span class="n">FILE_SHARE_READ</span><span class="p">,</span><span class="nb">NULL</span><span class="p">,</span><span class="n">OPEN_ALWAYS</span><span class="p">,</span><span class="n">FILE_ATTRIBUTE_NORMAL</span><span class="p">,</span><span class="nb">NULL</span><span class="p">);</span>	
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="n">HANDLE</span> <span class="n">g_hMapFile</span> <span class="o">=</span> <span class="nf">CreateFileMapping</span><span class="p">(</span><span class="n">g_hFile</span><span class="p">,</span><span class="nb">NULL</span><span class="p">,</span><span class="n">PAGE_READWRITE</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span> <span class="n">BUFSIZ</span><span class="p">,</span><span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">//将物理页与线性地址进行映射
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">LPTSTR</span> <span class="n">g_lpBuff</span> <span class="o">=</span> <span class="p">(</span><span class="n">LPTSTR</span><span class="p">)</span><span class="nf">MapViewOfFile</span><span class="p">(</span><span class="n">g_hMapFile</span><span class="p">,</span> <span class="n">FILE_MAP_ALL_ACCESS</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">BUFSIZ</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div><p>可以看到：</p>
<p><img loading="lazy" src="image-20230226183309832.png" alt="image-20230226183309832" srcset="image-20230226183309832.png?size=small, image-20230226183309832.png?size=medium 1.5x, image-20230226183309832.png?size=large 2x" data-title="image-20230226183309832" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<div class="highlight" id="id-11"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="mf">86128f</span><span class="mi">20</span>  <span class="mi">1</span>        <span class="mi">10</span>        <span class="mi">10</span>      <span class="mi">1</span> <span class="n">Private</span>      <span class="n">READWRITE</span>          
</span></span><span class="line"><span class="cl"><span class="mf">85f</span><span class="mi">9</span><span class="n">d600</span>  <span class="mi">2</span>        <span class="mi">20</span>        <span class="mi">20</span>      <span class="mi">1</span> <span class="n">Private</span>      <span class="n">READWRITE</span>          
</span></span><span class="line"><span class="cl"><span class="mf">860362f</span><span class="mi">8</span>  <span class="mi">0</span>        <span class="mi">30</span>       <span class="mf">12f</span>      <span class="mi">3</span> <span class="n">Private</span>      <span class="n">READWRITE</span>          
</span></span><span class="line"><span class="cl"><span class="mi">8645</span><span class="n">de68</span>  <span class="mi">3</span>       <span class="mi">130</span>       <span class="mi">132</span>      <span class="mi">0</span> <span class="n">Mapped</span>       <span class="n">READONLY</span>           <span class="n">Pagefile</span> <span class="n">section</span><span class="p">,</span> <span class="n">shared</span> <span class="n">commit</span> <span class="mh">0x3</span>
</span></span><span class="line"><span class="cl"><span class="mf">86128f</span><span class="mi">70</span>  <span class="mi">2</span>       <span class="mi">140</span>       <span class="mf">23f</span>      <span class="mi">3</span> <span class="n">Private</span>      <span class="n">READWRITE</span>          
</span></span><span class="line"><span class="cl"><span class="mf">85f</span><span class="mi">96588</span>  <span class="mi">4</span>       <span class="mi">240</span>       <span class="mf">24f</span>      <span class="mi">6</span> <span class="n">Private</span>      <span class="n">READWRITE</span>          
</span></span><span class="line"><span class="cl"><span class="mi">86354738</span>  <span class="mi">3</span>       <span class="mi">250</span>       <span class="mf">25f</span>      <span class="mi">0</span> <span class="n">Mapped</span>       <span class="n">READWRITE</span>          <span class="n">Pagefile</span> <span class="n">section</span><span class="p">,</span> <span class="n">shared</span> <span class="n">commit</span> <span class="mh">0x3</span>
</span></span><span class="line"><span class="cl"><span class="mi">863</span><span class="n">aef38</span>  <span class="mi">5</span>       <span class="mi">260</span>       <span class="mi">275</span>      <span class="mi">0</span> <span class="n">Mapped</span>       <span class="n">READONLY</span>           <span class="err">\</span><span class="n">WINDOWS</span><span class="err">\</span><span class="n">system32</span><span class="err">\</span><span class="n">unicode</span><span class="p">.</span><span class="n">nls</span>
</span></span><span class="line"><span class="cl"><span class="mi">86358510</span>  <span class="mi">4</span>       <span class="mi">280</span>       <span class="mi">2</span><span class="n">c0</span>      <span class="mi">0</span> <span class="n">Mapped</span>       <span class="n">READONLY</span>           <span class="err">\</span><span class="n">WINDOWS</span><span class="err">\</span><span class="n">system32</span><span class="err">\</span><span class="n">locale</span><span class="p">.</span><span class="n">nls</span>
</span></span><span class="line"><span class="cl"><span class="mi">863584</span><span class="n">b0</span>  <span class="mi">6</span>       <span class="mi">2</span><span class="n">d0</span>       <span class="mi">310</span>      <span class="mi">0</span> <span class="n">Mapped</span>       <span class="n">READONLY</span>           <span class="err">\</span><span class="n">WINDOWS</span><span class="err">\</span><span class="n">system32</span><span class="err">\</span><span class="n">sortkey</span><span class="p">.</span><span class="n">nls</span>
</span></span><span class="line"><span class="cl"><span class="mf">85f</span><span class="n">a69b8</span>  <span class="mi">5</span>       <span class="mi">320</span>       <span class="mi">325</span>      <span class="mi">0</span> <span class="n">Mapped</span>       <span class="n">READONLY</span>           <span class="err">\</span><span class="n">WINDOWS</span><span class="err">\</span><span class="n">system32</span><span class="err">\</span><span class="n">sorttbls</span><span class="p">.</span><span class="n">nls</span>
</span></span><span class="line"><span class="cl"><span class="mi">8645</span><span class="n">de08</span>  <span class="mi">7</span>       <span class="mi">330</span>       <span class="mi">370</span>      <span class="mi">0</span> <span class="n">Mapped</span>       <span class="n">READONLY</span>           <span class="n">Pagefile</span> <span class="n">section</span><span class="p">,</span> <span class="n">shared</span> <span class="n">commit</span> <span class="mh">0x41</span>
</span></span><span class="line"><span class="cl"><span class="mi">8614</span><span class="n">a3f8</span>  <span class="mi">6</span>       <span class="mi">380</span>       <span class="mf">38f</span>      <span class="mi">3</span> <span class="n">Private</span>      <span class="n">READWRITE</span>          
</span></span><span class="line"><span class="cl"><span class="mf">8602e848</span>  <span class="mi">7</span>       <span class="mi">390</span>       <span class="mi">392</span>      <span class="mi">0</span> <span class="n">Mapped</span>       <span class="n">READONLY</span>           <span class="err">\</span><span class="n">WINDOWS</span><span class="err">\</span><span class="n">system32</span><span class="err">\</span><span class="n">ctype</span><span class="p">.</span><span class="n">nls</span>
</span></span><span class="line"><span class="cl"><span class="mf">861451e0</span>  <span class="mi">8</span>       <span class="mi">3</span><span class="n">a0</span>       <span class="mi">3</span><span class="n">a0</span>      <span class="mi">0</span> <span class="n">Mapped</span>       <span class="n">READWRITE</span>          <span class="err">\</span><span class="n">NOTEPAD</span><span class="p">.</span><span class="n">EXE</span>
</span></span><span class="line"><span class="cl"><span class="mf">86128f</span><span class="mi">40</span>  <span class="mi">1</span>       <span class="mi">400</span>       <span class="mi">42</span><span class="n">c</span>      <span class="mi">8</span> <span class="n">Mapped</span>  <span class="n">Exe</span>  <span class="n">EXECUTE_WRITECOPY</span>  <span class="err">\</span><span class="n">Documents</span> <span class="n">and</span> <span class="n">Settings</span><span class="err">\</span><span class="n">Administrator</span><span class="err">\桌面\</span><span class="n">VC6</span><span class="mf">.0</span><span class="n">green</span><span class="err">\</span><span class="n">MyProjects</span><span class="err">\</span><span class="n">test</span><span class="err">\</span><span class="n">Debug</span><span class="err">\</span><span class="n">test</span><span class="p">.</span><span class="n">exe</span>
</span></span><span class="line"><span class="cl"><span class="mi">863</span><span class="n">a6b08</span>  <span class="mi">3</span>     <span class="mi">7</span><span class="n">c800</span>     <span class="mi">7</span><span class="n">c91d</span>      <span class="mi">6</span> <span class="n">Mapped</span>  <span class="n">Exe</span>  <span class="n">EXECUTE_WRITECOPY</span>  <span class="err">\</span><span class="n">WINDOWS</span><span class="err">\</span><span class="n">system32</span><span class="err">\</span><span class="n">kernel32</span><span class="p">.</span><span class="n">dll</span>
</span></span><span class="line"><span class="cl"><span class="mf">85f</span><span class="mi">968</span><span class="n">a0</span>  <span class="mi">2</span>     <span class="mi">7</span><span class="n">c920</span>     <span class="mi">7</span><span class="n">c9b2</span>      <span class="mi">5</span> <span class="n">Mapped</span>  <span class="n">Exe</span>  <span class="n">EXECUTE_WRITECOPY</span>  <span class="err">\</span><span class="n">WINDOWS</span><span class="err">\</span><span class="n">system32</span><span class="err">\</span><span class="n">ntdll</span><span class="p">.</span><span class="n">dll</span>
</span></span><span class="line"><span class="cl"><span class="mi">863</span><span class="n">aefd8</span>  <span class="mi">4</span>     <span class="mf">7f6f</span><span class="mi">0</span>     <span class="mf">7f</span><span class="mi">7</span><span class="n">ef</span>      <span class="mi">0</span> <span class="n">Mapped</span>       <span class="n">EXECUTE_READ</span>       <span class="n">Pagefile</span> <span class="n">section</span><span class="p">,</span> <span class="n">shared</span> <span class="n">commit</span> <span class="mh">0x7</span>
</span></span><span class="line"><span class="cl"><span class="mf">85f</span><span class="mi">96870</span>  <span class="mi">3</span>     <span class="mf">7ff</span><span class="n">a0</span>     <span class="mf">7ff</span><span class="n">d2</span>      <span class="mi">0</span> <span class="n">Mapped</span>       <span class="n">READONLY</span>           <span class="n">Pagefile</span> <span class="n">section</span><span class="p">,</span> <span class="n">shared</span> <span class="n">commit</span> <span class="mh">0x33</span></span></span></code></pre></div><h4 id="mapped-exe" class="heading-element">
  <a href="#mapped-exe" class="heading-mark"></a>Mapped Exe</h4><ol>
<li>当一个程序通过<code>LoadLibrary</code>进行加载时，此时该文件所在的线性地址空间的属性为Mapped Exe，权限为<code>EXECUTE_WRITECOPY</code></li>
<li>由于权限为<code>EXECUTE_WRITECOPY</code>的地址空间是需要共享给所有程序使用的，因此当我们对权限为<code>EXECUTE_WRITECOPY</code>的线性地址空间的任何位置进行修改时，系统会先给这块内存重新映射一份物理页，然后再进行修改</li>
</ol>
<p>示例代码：</p>
<div class="highlight" id="id-12"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">##include &lt;stdio.h&gt;
</span></span></span><span class="line"><span class="cl"><span class="cp">##include &lt;windows.h&gt;
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">HMODULE</span> <span class="n">hModule</span> <span class="o">=</span> <span class="nf">LoadLibrary</span><span class="p">(</span><span class="s">&#34;C:</span><span class="se">\\</span><span class="s">NOTEPAD.EXE&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div><h3 id="总结-1" class="heading-element">
  <a href="#%e6%80%bb%e7%bb%93-1" class="heading-mark"></a>总结</h3><p>1）线性地址分为三类：私有内存 | 共享内存 | 共享文件
2）共享内存和共享文件本质相同，都是分配了一块物理页，不同的是共享文件将物理页和文件关联了起来
3）传统的模块隐藏技术很难在VadRoot中进行隐藏（脱钩可能会导致程序崩溃），除非通过VirtualAlloc分配私有内存，手动将文件进行拉伸与贴入等一系列操作，此时能够大大增加寻找该模块的难度</p>
<h2 id="04物理内存管理" class="heading-element">
  <a href="#04%e7%89%a9%e7%90%86%e5%86%85%e5%ad%98%e7%ae%a1%e7%90%86" class="heading-mark"></a>04.物理内存管理</h2><p>32位最大物理内存：</p>
<ol>
<li>10-10-12分页  最多识别物理内存为4GB</li>
<li>2-9-9-12分页  最多识别物理内存为64GB</li>
</ol>
<p>操作系统的 <code>_ExVerifySuite()</code> 函数限制了它无法超越4GB（网上有补丁可以突破4GB）</p>
<p>实际物理内存：</p>
<blockquote>
<p>MmNumberOfPhysicalPages * 4 = 物理内存</p>
</blockquote>
<p>可以看到一共7FF6C个物理页，乘4后得到KB，与人物管理器中的一致。</p>
<div class="highlight" id="id-13"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">kd</span><span class="o">&gt;</span> <span class="n">dd</span> <span class="n">MmNumberOfPhysicalPages</span>
</span></span><span class="line"><span class="cl"><span class="mi">80563128</span>  <span class="mf">0003ff</span><span class="mi">6</span><span class="n">a</span> <span class="mo">00000040</span> <span class="mo">00000000</span> <span class="mf">7ff</span><span class="n">f0000</span>
</span></span><span class="line"><span class="cl"><span class="mi">80563138</span>  <span class="mi">80000000</span> <span class="mf">7ff</span><span class="n">effff</span> <span class="mo">00000000</span> <span class="mo">00000000</span>
</span></span><span class="line"><span class="cl"><span class="mi">80563148</span>  <span class="mo">00000000</span> <span class="mo">00000000</span> <span class="mo">00000000</span> <span class="mo">00000000</span>
</span></span><span class="line"><span class="cl"><span class="mi">80563158</span>  <span class="mo">00000000</span> <span class="mo">00000000</span> <span class="mo">00000004</span> <span class="mo">00000000</span></span></span></code></pre></div><h3 id="物理内存管理" class="heading-element">
  <a href="#%e7%89%a9%e7%90%86%e5%86%85%e5%ad%98%e7%ae%a1%e7%90%86" class="heading-mark"></a>物理内存管理</h3><p>是一个全局数组：</p>
<div class="highlight" id="id-14"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="err">数组指针：</span><span class="n">_MMPFN</span><span class="o">*</span> <span class="n">MmPfnDatabase</span>	
</span></span><span class="line"><span class="cl"><span class="err">数组长度：</span><span class="n">MmNumberOfPhysicalPages</span></span></span></code></pre></div><p>81000000~(81000000+0x18)描述的就是第一个物理页的信息，8100001C~(8100001C+0x18)是第二个物理页的描述信息，以此类推。</p>
<p><code>80c86000+1c*索引 == 这个物理页对应的_MMPFN结构</code></p>
<div class="highlight" id="id-15"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">kd</span><span class="o">&gt;</span> <span class="n">dd</span> <span class="n">MmPfnDatabase</span>
</span></span><span class="line"><span class="cl"><span class="mi">805630</span><span class="n">c8</span>  <span class="mi">81000000</span> <span class="n">ffffffff</span> <span class="mo">00000006</span> <span class="mf">0000003f</span>
</span></span><span class="line"><span class="cl"><span class="mi">805630</span><span class="n">d8</span>  <span class="mo">0000</span><span class="n">cfc5</span> <span class="mo">00030</span><span class="n">c23</span> <span class="mo">00020</span><span class="n">ae2</span> <span class="mf">0000155f</span>
</span></span><span class="line"><span class="cl"><span class="mf">805630e8</span>  <span class="mo">0000</span><span class="n">cb3e</span> <span class="mo">00000000</span> <span class="mf">000114f</span><span class="mi">4</span> <span class="mo">0000</span><span class="mi">9737</span>
</span></span><span class="line"><span class="cl"><span class="mf">805630f</span><span class="mi">8</span>  <span class="mf">00001f</span><span class="mi">9</span><span class="n">c</span> <span class="mo">00000000</span> <span class="mo">00000000</span> <span class="mo">000000</span><span class="n">c0</span>
</span></span><span class="line"><span class="cl"><span class="mi">80563108</span>  <span class="mo">0000000</span><span class="n">c</span> <span class="mo">00000000</span> <span class="mo">00000000</span> <span class="mo">0000001</span><span class="n">e</span>
</span></span><span class="line"><span class="cl"><span class="mi">80563118</span>  <span class="mf">000000f</span><span class="n">a</span> <span class="mf">0002f</span><span class="mi">6</span><span class="n">b3</span> <span class="mf">0003ff</span><span class="n">ff</span> <span class="mf">0003ff</span><span class="n">ff</span></span></span></code></pre></div><h3 id="pfn" class="heading-element">
  <a href="#pfn" class="heading-mark"></a>PFN</h3><p><code>_MMPFN</code>结构体：</p>
<div class="highlight" id="id-16"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">kd</span><span class="o">&gt;</span> <span class="n">dt</span> <span class="n">_MMPFN</span>
</span></span><span class="line"><span class="cl"><span class="n">nt</span><span class="o">!</span><span class="n">_MMPFN</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x000</span> <span class="nl">u1</span>               <span class="p">:</span> <span class="n">__unnamed</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x004</span> <span class="nl">PteAddress</span>       <span class="p">:</span> <span class="n">Ptr32</span> <span class="n">_MMPTE</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x008</span> <span class="nl">u2</span>               <span class="p">:</span> <span class="n">__unnamed</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x00c</span> <span class="nl">u3</span>               <span class="p">:</span> <span class="n">__unnamed</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x010</span> <span class="nl">OriginalPte</span>      <span class="p">:</span> <span class="n">_MMPTE</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x018</span> <span class="nl">u4</span>               <span class="p">:</span> <span class="n">__unnamed</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">struct</span> <span class="n">_MMPFN</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">union</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">PFN_NUMBER</span> <span class="n">Flink</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">ULONG</span> <span class="n">WsIndex</span><span class="p">;</span><span class="c1">//该页面在进程工作集链表中的索引
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">PKEVENT</span> <span class="n">Event</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">NTSTATUS</span> <span class="n">ReadStatus</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">SINGLE_LIST_ENTRY</span> <span class="n">NextStackPfn</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// HACK for ROSPFN
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">SWAPENTRY</span> <span class="n">SwapEntry</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="n">u1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">PMMPTE</span> <span class="n">PteAddress</span><span class="p">;</span><span class="c1">//执行此页面的PTE的虚拟地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">union</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">PFN_NUMBER</span> <span class="n">Blink</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">ULONG_PTR</span> <span class="n">ShareCount</span><span class="p">;</span><span class="c1">//指向该页面的PTE数量
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span> <span class="n">u2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">union</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">struct</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">USHORT</span> <span class="n">ReferenceCount</span><span class="p">;</span><span class="c1">//代表这个页面必须要保留在内存中的引用计数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">MMPFNENTRY</span> <span class="n">e1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">};</span>
</span></span><span class="line"><span class="cl">        <span class="k">struct</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">USHORT</span> <span class="n">ReferenceCount</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">USHORT</span> <span class="n">ShortFlags</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="n">e2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="n">u3</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">union</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">MMPTE</span> <span class="n">OriginalPte</span><span class="p">;</span><span class="c1">//包含了指向此页面的PTE的原始内容
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">LONG</span> <span class="n">AweReferenceCount</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// HACK for ROSPFN
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">PMM_RMAP_ENTRY</span> <span class="n">RmapListHead</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="k">union</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">ULONG_PTR</span> <span class="n">EntireFrame</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">struct</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">ULONG_PTR</span> <span class="nl">PteFrame</span><span class="p">:</span><span class="mi">25</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">ULONG_PTR</span> <span class="nl">InPageError</span><span class="p">:</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">ULONG_PTR</span> <span class="nl">VerifierAllocation</span><span class="p">:</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">ULONG_PTR</span> <span class="nl">AweAllocation</span><span class="p">:</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">ULONG_PTR</span> <span class="nl">Priority</span><span class="p">:</span><span class="mi">3</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">ULONG_PTR</span> <span class="nl">MustBeCached</span><span class="p">:</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="n">u4</span><span class="p">;</span><span class="c1">//指向该页面的PTE所在的页表页面的物理页帧编号,以及一些标志位
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="n">u3</span><span class="p">.</span><span class="n">e1</span><span class="p">.</span><span class="n">PageLocation</span> <span class="err">这个成员标识了当前物理页空闲状态（空闲：使用中，两大类）</span>
</span></span><span class="line"><span class="cl"><span class="mi">0</span><span class="err">：</span><span class="n">MmZeroedPageListHead</span>         <span class="c1">//零化
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="mi">1</span><span class="err">：</span><span class="n">MmFreePageListHead</span>           <span class="c1">//空闲
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="mi">2</span><span class="err">：</span><span class="n">MmStandbyPageListHead</span>        <span class="c1">//备用
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="mi">3</span><span class="err">：</span><span class="n">MmModifiedPageListHead</span>       <span class="c1">//修改 OriginalPte.u.Soft.Prototype=1 或者 外存都会在这
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="mi">4</span><span class="err">：</span><span class="n">MmModifiedNoWritePageListHead</span><span class="c1">//已修改但不写出
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="mi">5</span><span class="err">：</span><span class="n">MmBadPageListHead</span>            <span class="c1">//损坏
</span></span></span></code></pre></div><h4 id="零化链表" class="heading-element">
  <a href="#%e9%9b%b6%e5%8c%96%e9%93%be%e8%a1%a8" class="heading-mark"></a>零化链表</h4><p><code>MmPfnDatabase</code>：第一个物理页描述信息：<code>81000000</code></p>
<div class="highlight" id="id-17"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">kd</span><span class="o">&gt;</span> <span class="n">dd</span> <span class="n">MmPfnDatabase</span> <span class="n">l1</span>
</span></span><span class="line"><span class="cl"><span class="mi">805630</span><span class="n">c8</span>  <span class="mi">81000000</span></span></span></code></pre></div><p>零化链表：</p>
<div class="highlight" id="id-18"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">kd</span><span class="o">&gt;</span> <span class="n">dd</span> <span class="n">MmZeroedPageListHead</span> <span class="n">l4</span>
</span></span><span class="line"><span class="cl"><span class="mf">805528e8</span>  <span class="mo">0002</span><span class="mi">949</span><span class="n">c</span> <span class="mo">00000000</span> <span class="mo">00023</span><span class="n">a24</span> <span class="mo">00023</span><span class="n">ab3</span></span></span></code></pre></div><p>第一个零化链表：</p>
<div class="highlight" id="id-19"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">kd</span><span class="o">&gt;</span> <span class="n">dd</span> <span class="mi">81000000</span> <span class="o">+</span> <span class="mh">0x1C</span><span class="o">*</span><span class="mo">00023</span><span class="n">a24</span> <span class="n">l4</span>
</span></span><span class="line"><span class="cl"><span class="mf">813e5</span><span class="n">bf0</span>  <span class="mo">00023</span><span class="n">a64</span> <span class="mo">0011</span><span class="n">d120</span> <span class="n">ffffffff</span> <span class="mo">00003000</span></span></span></code></pre></div><p>零化链表：</p>
<p><img loading="lazy" src="image-20230227102011045.png" alt="image-20230227102011045" srcset="image-20230227102011045.png?size=small, image-20230227102011045.png?size=medium 1.5x, image-20230227102011045.png?size=large 2x" data-title="image-20230227102011045" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<p>结构如下：</p>
<p><img loading="lazy" src="image-20230227102049345.png" alt="image-20230227102049345" srcset="image-20230227102049345.png?size=small, image-20230227102049345.png?size=medium 1.5x, image-20230227102049345.png?size=large 2x" data-title="image-20230227102049345" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<div class="highlight" id="id-20"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">kd</span><span class="o">&gt;</span> <span class="n">dt</span> <span class="n">_eprocess</span> <span class="mi">86104020</span>  
</span></span><span class="line"><span class="cl"><span class="n">ntdll</span><span class="o">!</span><span class="n">_EPROCESS</span>
</span></span><span class="line"><span class="cl">	<span class="o">+</span><span class="mh">0x1f8</span> <span class="nl">Vm</span>               <span class="p">:</span> <span class="n">_MMSUPPORT</span>
</span></span><span class="line"><span class="cl"><span class="n">kd</span><span class="o">&gt;</span> <span class="n">dt</span> <span class="n">_MMSUPPORT</span>
</span></span><span class="line"><span class="cl"><span class="n">nt_exe</span><span class="o">!</span><span class="n">_MMSUPPORT</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x000</span> <span class="nl">LastTrimTime</span>     <span class="p">:</span> <span class="n">_LARGE_INTEGER</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x008</span> <span class="nl">Flags</span>            <span class="p">:</span> <span class="n">_MMSUPPORT_FLAGS</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x00c</span> <span class="nl">PageFaultCount</span>   <span class="p">:</span> <span class="n">Uint4B</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x010</span> <span class="nl">PeakWorkingSetSize</span> <span class="p">:</span> <span class="n">Uint4B</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x014</span> <span class="nl">WorkingSetSize</span>   <span class="p">:</span> <span class="n">Uint4B</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x018</span> <span class="nl">MinimumWorkingSetSize</span> <span class="p">:</span> <span class="n">Uint4B</span><span class="c1">//最小的物理页大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="o">+</span><span class="mh">0x01c</span> <span class="nl">MaximumWorkingSetSize</span> <span class="p">:</span> <span class="n">Uint4B</span><span class="c1">//最大的物理页大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="o">+</span><span class="mh">0x020</span> <span class="nl">VmWorkingSetList</span> <span class="p">:</span> <span class="n">Ptr32</span> <span class="n">_MMWSLz</span><span class="c1">//这个成员可以找到这个进程使用的所有物理页
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="o">+</span><span class="mh">0x024</span> <span class="nl">WorkingSetExpansionLinks</span> <span class="p">:</span> <span class="n">_LIST_ENTRY</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x02c</span> <span class="nl">Claim</span>            <span class="p">:</span> <span class="n">Uint4B</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x030</span> <span class="nl">NextEstimationSlot</span> <span class="p">:</span> <span class="n">Uint4B</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x034</span> <span class="nl">NextAgingSlot</span>    <span class="p">:</span> <span class="n">Uint4B</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x038</span> <span class="nl">EstimatedAvailable</span> <span class="p">:</span> <span class="n">Uint4B</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x03c</span> <span class="nl">GrowthSinceLastEstimate</span> <span class="p">:</span> <span class="n">Uint4B</span>
</span></span><span class="line"><span class="cl"><span class="c1">/////////////////////////////////////////////////////////////////////////
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">nt</span><span class="o">!</span><span class="n">_MMWSL</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x000</span> <span class="nl">Quota</span>            <span class="p">:</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x004</span> <span class="nl">FirstFree</span>        <span class="p">:</span> <span class="mh">0x1e</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x008</span> <span class="nl">FirstDynamic</span>     <span class="p">:</span> <span class="mh">0xa</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x00c</span> <span class="nl">LastEntry</span>        <span class="p">:</span> <span class="mh">0x217</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x010</span> <span class="nl">NextSlot</span>         <span class="p">:</span> <span class="mi">7</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x014</span> <span class="nl">Wsle</span>             <span class="p">:</span> <span class="mh">0xc0883cfc</span> <span class="n">_MMWSLE</span>			<span class="c1">//物理页起始地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="o">+</span><span class="mh">0x018</span> <span class="nl">LastInitializedWsle</span> <span class="p">:</span> <span class="mh">0x4c0</span>					<span class="c1">//物理页个数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="o">+</span><span class="mh">0x01c</span> <span class="nl">NonDirectCount</span>   <span class="p">:</span> <span class="mh">0x33</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x020</span> <span class="nl">HashTable</span>        <span class="p">:</span> <span class="mh">0xc0a84000</span> <span class="n">_MMWSLE_HASH</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x024</span> <span class="nl">HashTableSize</span>    <span class="p">:</span> <span class="mh">0x200</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x028</span> <span class="nl">NumberOfCommittedPageTables</span> <span class="p">:</span> <span class="mi">2</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x02c</span> <span class="nl">HashTableStart</span>   <span class="p">:</span> <span class="mh">0xc0a84000</span> <span class="n">Void</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x030</span> <span class="nl">HighestPermittedHashAddress</span> <span class="p">:</span> <span class="mh">0xc0e00000</span> <span class="n">Void</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x034</span> <span class="nl">NumberOfImageWaiters</span> <span class="p">:</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x038</span> <span class="nl">VadBitMapHint</span>    <span class="p">:</span> <span class="mh">0x16</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x03c</span> <span class="nl">UsedPageTableEntries</span> <span class="p">:</span> <span class="p">[</span><span class="mi">1536</span><span class="p">]</span> <span class="mh">0x34</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0xc3c</span> <span class="nl">CommittedPageTables</span> <span class="p">:</span> <span class="p">[</span><span class="mi">48</span><span class="p">]</span> <span class="mi">1</span></span></span></code></pre></div><h2 id="05缺页异常" class="heading-element">
  <a href="#05%e7%bc%ba%e9%a1%b5%e5%bc%82%e5%b8%b8" class="heading-mark"></a>05.缺页异常</h2><p>PTE页表：</p>
<p><img loading="lazy" src="image-20230227110744432.png" alt="image-20230227110744432" srcset="image-20230227110744432.png?size=small, image-20230227110744432.png?size=medium 1.5x, image-20230227110744432.png?size=large 2x" data-title="image-20230227110744432" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<p>P位表示当前页是否有效</p>
<blockquote>
<p>Windows是只有正在被使用的线性地址才会给你挂上物理页，如果你的线性地址隔了一段时间没使用或者当前的物理页快被占用完了，这时它会将你这些物理页的数据拿出来存到硬盘上。</p>
<p>右键我的电脑 -&gt; 属性 -&gt; 高级 -&gt; 性能下的设置 -&gt; 高级 -&gt;虚拟内存更改
设置虚拟内存后它会在你的c盘下生成一个pagefile.sys，它的大小刚好是你设置的虚拟内存大小。</p>
<p>当你的物理页不够用了，这时系统会将物理页里的数据放到pagefile.sys这个文件中，再将这个物理页跟程序使用。</p>
<p>如果我们在某个程序中使用了0x12345678这个线性地址，它的物理页被存放的pagefile.sys了，如果我门在次使用这个地址就出问题了，这时就需要用到缺页异常了</p>
</blockquote>
<p>当线性地址对应的物理页被存储到文件中时，PTE结构被拓展为以下四种情形：</p>
<p><img loading="lazy" src="image-20230227111808658.png" alt="image-20230227111808658" srcset="image-20230227111808658.png?size=small, image-20230227111808658.png?size=medium 1.5x, image-20230227111808658.png?size=large 2x" data-title="image-20230227111808658" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<blockquote>
<p>图a：位于页面文件中
当你的线性地址的物理页被存放到页面文件（pagefile.sys）中的时候，你的PTE就会变成这样</p>
<p>CPU访问了这地址你的p:0，进入缺页异常处理程序，缺页异常位于idt表里的E号中断。</p>
<p>进入缺页异常处理它会回头查看你的这个PTE，这时地址时发现你的1-9位，12-31位都是有值的，它就会知道你这个线性地址是有效的，只不过数据放到页面文件里了</p>
<p>异常处理程序会到pagefile.sys中，按照PTE上描述的页面文件偏移将页的数据取出来挂到一个新的物理页上，将12-31位改为新的物理页地址，再将p=1</p>
<p>图b：要求0页面
页面尚未分配，下次访问时请求一个0页面</p>
<p>图c：转移
页面在物理内存中，但已被转移到某个物理页面链表中，可以通过查询_MMPFN数据库获取实际情况</p>
<p>图d：缺页异常处理发现你PTE全部为0就会去查VAD，发现这个线性地址已经分配了它会帮你把物理页挂上，如果这个线性地址没有分配就会报0xC0000005。(具体看 “保留与提交的误区” )</p>
</blockquote>
<h3 id="保留与提交" class="heading-element">
  <a href="#%e4%bf%9d%e7%95%99%e4%b8%8e%e6%8f%90%e4%ba%a4" class="heading-mark"></a>保留与提交</h3><p><code>VirtualAlloc</code>：</p>
<div class="highlight" id="id-21"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">LPVOID</span> <span class="nf">VirtualAlloc</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">	<span class="n">LPVOID</span> <span class="n">lpAddress</span><span class="p">,</span> 	<span class="c1">// 要分配的内存区域的地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">dwSize</span><span class="p">,</span> 		<span class="c1">// 分配的大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">flAllocationType</span><span class="p">,</span> <span class="c1">// 类型：MEM_RESERVE MEM_COMMIT
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">DWORD</span> <span class="n">flProtect</span> 	<span class="c1">// 该内存的初始保护属性
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// MEM_RESERVE：只保留线性地址，不分配物理页
</span></span></span><span class="line"><span class="cl"><span class="c1">// MEM_COMMIT：既保留线性地址，又分配物理页
</span></span></span></code></pre></div><p>示例代码：</p>
<div class="highlight" id="id-22"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">##include &lt;stdio.h&gt;
</span></span></span><span class="line"><span class="cl"><span class="cp">##include &lt;windows.h&gt;
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">LPVOID</span> <span class="n">pAddr</span> <span class="o">=</span> <span class="nf">VirtualAlloc</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="mh">0x1000</span><span class="o">*</span><span class="mi">8</span><span class="p">,</span> <span class="n">MEM_COMMIT</span><span class="p">,</span> <span class="n">PAGE_READWRITE</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="nf">printf</span><span class="p">(</span><span class="s">&#34;%p</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">pAddr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="nf">getchar</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">	<span class="o">*</span><span class="p">(</span><span class="n">PDWORD</span><span class="p">)</span><span class="n">pAddr</span> <span class="o">=</span> <span class="mh">0x12345678</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="nf">getchar</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div><p>结果：</p>
<p><img loading="lazy" src="image-20230304142407074.png" alt="image-20230304142407074" srcset="image-20230304142407074.png?size=small, image-20230304142407074.png?size=medium 1.5x, image-20230304142407074.png?size=large 2x" data-title="image-20230304142407074" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<p>查看该地址有没有物理页：</p>
<div class="highlight" id="id-23"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">kd</span><span class="o">&gt;</span> <span class="o">!</span><span class="n">process</span> <span class="mi">0</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="n">Failed</span> <span class="n">to</span> <span class="n">get</span> <span class="n">VadRoot</span>
</span></span><span class="line"><span class="cl"><span class="n">PROCESS</span> <span class="mi">86301020</span>  <span class="nl">SessionId</span><span class="p">:</span> <span class="mi">0</span>  <span class="nl">Cid</span><span class="p">:</span> <span class="mo">023</span><span class="n">c</span>    <span class="nl">Peb</span><span class="p">:</span> <span class="mf">7ff</span><span class="n">d7000</span>  <span class="nl">ParentCid</span><span class="p">:</span> <span class="mo">023</span><span class="mi">8</span>
</span></span><span class="line"><span class="cl">    <span class="nl">DirBase</span><span class="p">:</span> <span class="mo">06</span><span class="n">bc01c0</span>  <span class="nl">ObjectTable</span><span class="p">:</span> <span class="n">e1bbbd20</span>  <span class="nl">HandleCount</span><span class="p">:</span>  <span class="mf">10.</span>
</span></span><span class="line"><span class="cl">    <span class="nl">Image</span><span class="p">:</span> <span class="n">test</span><span class="p">.</span><span class="n">exe</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">kd</span><span class="o">&gt;</span> <span class="o">!</span><span class="n">vtop</span> <span class="mo">06</span><span class="n">bc01c0</span>  <span class="mi">3</span><span class="n">a0000</span>
</span></span><span class="line"><span class="cl"><span class="nl">X86VtoP</span><span class="p">:</span> <span class="n">Virt</span> <span class="mo">00000000003</span><span class="n">a0000</span><span class="p">,</span> <span class="n">pagedir</span> <span class="mo">0000000006</span><span class="n">bc01c0</span>
</span></span><span class="line"><span class="cl"><span class="nl">X86VtoP</span><span class="p">:</span> <span class="n">PAE</span> <span class="n">PDPE</span> <span class="mo">0000000006</span><span class="n">bc01c0</span> <span class="o">-</span> <span class="mo">000000002</span><span class="n">aa4d801</span>
</span></span><span class="line"><span class="cl"><span class="nl">X86VtoP</span><span class="p">:</span> <span class="n">PAE</span> <span class="n">PDE</span> <span class="mo">000000002</span><span class="n">aa4d008</span> <span class="o">-</span> <span class="mo">000000002</span><span class="n">aaff867</span>
</span></span><span class="line"><span class="cl"><span class="nl">X86VtoP</span><span class="p">:</span> <span class="n">PAE</span> <span class="n">PTE</span> <span class="mo">000000002</span><span class="n">aaffd00</span> <span class="o">-</span> <span class="mo">0000000000000000</span><span class="c1">//这里，没有
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">X86VtoP</span><span class="p">:</span> <span class="n">PAE</span> <span class="n">zero</span> <span class="n">PTE</span>
</span></span><span class="line"><span class="cl"><span class="n">Virtual</span> <span class="n">address</span> <span class="mi">3</span><span class="n">a0000</span> <span class="n">translation</span> <span class="n">fails</span><span class="p">,</span> <span class="n">error</span> <span class="mh">0xD0000147</span><span class="p">.</span></span></span></code></pre></div><p>敲个回车后：</p>
<div class="highlight" id="id-24"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">kd</span><span class="o">&gt;</span> <span class="o">!</span><span class="n">vtop</span> <span class="mo">06</span><span class="n">bc01c0</span>  <span class="mi">3</span><span class="n">a0000</span>
</span></span><span class="line"><span class="cl"><span class="nl">X86VtoP</span><span class="p">:</span> <span class="n">Virt</span> <span class="mo">00000000003</span><span class="n">a0000</span><span class="p">,</span> <span class="n">pagedir</span> <span class="mo">0000000006</span><span class="n">bc01c0</span>
</span></span><span class="line"><span class="cl"><span class="nl">X86VtoP</span><span class="p">:</span> <span class="n">PAE</span> <span class="n">PDPE</span> <span class="mo">0000000006</span><span class="n">bc01c0</span> <span class="o">-</span> <span class="mo">000000002</span><span class="n">aa4d801</span>
</span></span><span class="line"><span class="cl"><span class="nl">X86VtoP</span><span class="p">:</span> <span class="n">PAE</span> <span class="n">PDE</span> <span class="mo">000000002</span><span class="n">aa4d008</span> <span class="o">-</span> <span class="mo">000000002</span><span class="n">aaff867</span>
</span></span><span class="line"><span class="cl"><span class="nl">X86VtoP</span><span class="p">:</span> <span class="n">PAE</span> <span class="n">PTE</span> <span class="mo">000000002</span><span class="n">aaffd00</span> <span class="o">-</span> <span class="mi">800000002</span><span class="n">b62e867</span><span class="c1">//已经挂上了
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">X86VtoP</span><span class="p">:</span> <span class="n">PAE</span> <span class="n">Mapped</span> <span class="n">phys</span> <span class="mo">000000002</span><span class="n">b62e000</span>
</span></span><span class="line"><span class="cl"><span class="n">Virtual</span> <span class="n">address</span> <span class="mi">3</span><span class="n">a0000</span> <span class="n">translates</span> <span class="n">to</span> <span class="n">physical</span> <span class="n">address</span> <span class="mi">2</span><span class="n">b62e000</span><span class="p">.</span></span></span></code></pre></div><p>也可以这样看：</p>
<div class="highlight" id="id-25"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="o">!</span><span class="n">dd</span> <span class="mo">06</span><span class="n">bc01c0</span> <span class="o">+</span> <span class="mi">3</span><span class="n">a0</span><span class="o">*</span><span class="mi">4</span></span></span></code></pre></div><h3 id="写拷贝execute_writecopy" class="heading-element">
  <a href="#%e5%86%99%e6%8b%b7%e8%b4%9dexecute_writecopy" class="heading-mark"></a>写拷贝（EXECUTE_WRITECOPY）</h3><p><img loading="lazy" src="image-20230304144643458.png" alt="image-20230304144643458" srcset="image-20230304144643458.png?size=small, image-20230304144643458.png?size=medium 1.5x, image-20230304144643458.png?size=large 2x" data-title="image-20230304144643458" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<p>先将PTE的R/W=0，<code>_MMVAD_FLAGS</code>设为<code>EXECUTE_WRITECOPY</code></p>
<p>当你HOOK一些属性为EXECUTE_WRITECOPY的模块时：</p>
<ol>
<li>修改它的物理页，这时它PTE.R/W为0就会触发缺页异常</li>
<li>进入异常处理程序发现PTE.R/W=0，查这个页对应的VAD发现 Protection 为写拷贝</li>
<li>创建一份新的物理页，修改的数据放到新的物理页，将你的线性地址会指向这个新的物理页。</li>
</ol>
<p>如果写驱动程序将它的PTE.R/W强行修改为1，这样它就不会触发缺页异常，可实现A进程中hook了这个模块，所有使用这个模块的进程也会被HOOK。</p>
</div><div class="post-footer" id="post-footer">
  <div class="post-info">
    <div class="post-info-line">
      <div class="post-info-mod">
        <span title="更新于 2023-03-05 00:00:00">更新于 2023-03-05&nbsp;</span>
      </div><div class="post-info-license">
            <span><a rel="license external nofollow noopener noreferrer" href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a></span>
          </div></div><div class="post-info-line">
        <div class="post-info-md"></div>
        <div class="post-info-share">
          <span><a href="javascript:void(0);" title="分享到 Twitter" data-sharer="twitter" data-url="http://ghostasky.github.io/posts/2023-3-winkernel%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/" data-title="Windows内核(九)——内存管理" data-hashtags="Win32"><i class="fa-brands fa-twitter fa-fw" aria-hidden="true"></i></a>
  <a href="javascript:void(0);" title="分享到 Facebook" data-sharer="facebook" data-url="http://ghostasky.github.io/posts/2023-3-winkernel%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/" data-hashtag="Win32"><i class="fa-brands fa-facebook-square fa-fw" aria-hidden="true"></i></a>
  <a href="javascript:void(0);" title="分享到 微博" data-sharer="weibo" data-url="http://ghostasky.github.io/posts/2023-3-winkernel%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/" data-title="Windows内核(九)——内存管理"><i class="fa-brands fa-weibo fa-fw" aria-hidden="true"></i></a>
  </span>
        </div>
      </div></div>

  <div class="post-info-more">
    <section class="post-tags"><i class="fa-solid fa-tags fa-fw me-1" aria-hidden="true"></i><a href="/tags/win32/" class="post-tag" title="标签 - Win32">Win32</a></section>
    <section>
      <span><a href="javascript:void(0);" onclick="window.history.back();">返回</a></span>&nbsp;|&nbsp;<span><a href="/">主页</a></span>
    </section>
  </div>

  <div class="post-nav"><a href="/posts/2023-3-winkernel%E5%BC%82%E5%B8%B8/" class="post-nav-item" rel="prev" title="Windows内核(八)——异常"><i class="fa-solid fa-angle-left fa-fw" aria-hidden="true"></i>Windows内核(八)——异常</a>
      <a href="/posts/2023-3-winkernel%E6%B6%88%E6%81%AF%E6%9C%BA%E5%88%B6/" class="post-nav-item" rel="next" title="Windows内核(十)——消息机制">Windows内核(十)——消息机制<i class="fa-solid fa-angle-right fa-fw" aria-hidden="true"></i></a></div>
</div>
</article>

  <aside class="toc" id="toc-auto" aria-label="目录"><h2 class="toc-title">目录&nbsp;<i class="toc-icon fa-solid fa-angle-down fa-fw" aria-hidden="true"></i></h2>
      <div class="toc-content" id="toc-content-auto"></div></aside></main><footer class="footer">
    <div class="footer-container"><div class="footer-line powered">由 <a href="https://gohugo.io/" target="_blank" rel="external nofollow noopener noreferrer" title="Hugo 0.123.8"><img class="hugo-icon" src="/images/hugo.min.svg" alt="Hugo logo" /> Hugo</a> 强力驱动 | 主题 - <a href="https://github.com/hugo-fixit/FixIt" target="_blank" rel="external" title="FixIt v0.3.2"><img class="fixit-icon" src="/images/fixit.min.svg" alt="FixIt logo" /> FixIt</a>
        </div><div class="footer-line copyright" itemscope itemtype="http://schema.org/CreativeWork"><i class="fa-regular fa-copyright fa-fw" aria-hidden="true"></i>
            <span itemprop="copyrightYear">2024</span><span class="author" itemprop="copyrightHolder">
              <a href="/"></a></span></div></div>
  </footer></div><div class="widgets"><div class="fixed-buttons animate__faster d-none"><div class="fixed-button back-to-top" role="button" aria-label="回到顶部"><i class="fa-solid fa-arrow-up fa-fw" aria-hidden="true"></i><span class="variant-numeric d-none">0%</span>
        </div></div><div id="mask"></div><noscript>
    <div class="noscript-warning">FixIt 主题在启用 JavaScript 的情况下效果最佳。</div>
  </noscript>
</div><link rel="preload" href="/lib/katex/katex.min.css" as="style" onload="this.removeAttribute('onload');this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="/lib/katex/katex.min.css"></noscript><link rel="stylesheet" href="/lib/cookieconsent/cookieconsent.min.css"><script src="/lib/sharer/sharer.min.js" async defer></script><script src="/lib/katex/katex.min.js" defer></script><script src="/lib/katex/auto-render.min.js" defer></script><script src="/lib/katex/copy-tex.min.js" defer></script><script src="/lib/katex/mhchem.min.js" defer></script><script src="/lib/cookieconsent/cookieconsent.min.js" defer></script><script>window.config={"code":{"copyTitle":"复制到剪贴板","editLockTitle":"锁定可编辑代码块","editUnLockTitle":"解锁可编辑代码块","editable":true,"maxShownLines":10},"comment":{"enable":false},"cookieconsent":{"content":{"dismiss":"同意","link":"了解更多","message":"本网站使用 Cookies 来改善您的浏览体验。"},"enable":true,"palette":{"button":{"background":"#f0f0f0"},"popup":{"background":"#1aa3ff"}},"theme":"edgeless"},"math":{"delimiters":[{"display":true,"left":"$$","right":"$$"},{"display":true,"left":"\\[","right":"\\]"},{"display":true,"left":"\\begin{equation}","right":"\\end{equation}"},{"display":true,"left":"\\begin{equation*}","right":"\\end{equation*}"},{"display":true,"left":"\\begin{align}","right":"\\end{align}"},{"display":true,"left":"\\begin{align*}","right":"\\end{align*}"},{"display":true,"left":"\\begin{alignat}","right":"\\end{alignat}"},{"display":true,"left":"\\begin{alignat*}","right":"\\end{alignat*}"},{"display":true,"left":"\\begin{gather}","right":"\\end{gather}"},{"display":true,"left":"\\begin{CD}","right":"\\end{CD}"},{"display":false,"left":"$","right":"$"},{"display":false,"left":"\\(","right":"\\)"}],"strict":false}};</script><script src="/js/theme.min.js" defer></script></body>
</html>
