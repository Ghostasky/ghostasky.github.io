<!doctype html><html itemscope itemtype=http://schema.org/WebPage lang=zh-CN><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=2"><meta name=robots content="noodp"><title>YARA规则 - Ghostasky's Blog</title><meta name=author content>
<meta name=author-link content><meta name=description content><meta name=keywords content='Antivirus'><meta itemprop=name content="YARA规则"><meta itemprop=description content><meta itemprop=datePublished content="2022-08-13T00:00:00+00:00"><meta itemprop=dateModified content="2022-08-13T00:00:00+00:00"><meta itemprop=wordCount content="3535"><meta itemprop=keywords content="Antivirus,"><meta property="og:title" content="YARA规则"><meta property="og:description" content><meta property="og:type" content="article"><meta property="og:url" content="http://ghostasky.github.io/posts/2022-8-13-yara/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-08-13T00:00:00+00:00"><meta property="article:modified_time" content="2022-08-13T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="YARA规则"><meta name=twitter:description content><meta name=application-name content="FixIt"><meta name=apple-mobile-web-app-title content="FixIt"><meta name=theme-color data-light=#f8f8f8 data-dark=#252627 content="#f8f8f8"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=canonical href=http://ghostasky.github.io/posts/2022-8-13-yara/><link rel=prev href=http://ghostasky.github.io/posts/rc4/><link rel=next href=http://ghostasky.github.io/posts/2022-9-winkernel%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F/><link rel=stylesheet href=/css/style.min.css><link rel=preload href=/lib/fontawesome-free/all.min.css as=style onload='this.removeAttribute("onload"),this.rel="stylesheet"'><noscript><link rel=stylesheet href=/lib/fontawesome-free/all.min.css></noscript><link rel=preload href=/lib/animate/animate.min.css as=style onload='this.removeAttribute("onload"),this.rel="stylesheet"'><noscript><link rel=stylesheet href=/lib/animate/animate.min.css></noscript><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"YARA规则","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"http:\/\/ghostasky.github.io\/posts\/2022-8-13-yara\/"},"genre":"posts","keywords":"Antivirus","wordcount":3535,"url":"http:\/\/ghostasky.github.io\/posts\/2022-8-13-yara\/","datePublished":"2022-08-13T00:00:00+00:00","dateModified":"2022-08-13T00:00:00+00:00","publisher":{"@type":"Organization","name":""},"author":{"@type":"Person","name":"作者"},"description":""}</script></head><body data-header-desktop=sticky data-header-mobile=auto><script>(window.localStorage?.getItem("theme")?localStorage.getItem("theme")==="dark":"auto"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"auto"==="dark")&&document.body.setAttribute("data-theme","dark")</script><div class=wrapper data-page-style=normal><header class="desktop animate__faster" id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title="Ghostasky's Blog"><img loading=lazy src=/images/fixit.png alt="Ghostasky's Blog" data-title="Ghostasky's Blog" class=logo style="background:url(/images/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title;for(const e of["style","data-title","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title;for(const e of["style","data-title","onerror","onload"])this.removeAttribute(e)'><span class=header-title-text>Ghostasky's Blog</span></a><span class=header-subtitle></span></div><nav><ul class=menu><li class=menu-item><a class=menu-link href=/posts/>文章</a></li><li class=menu-item><a class=menu-link href=/categories/>分类</a></li><li class=menu-item><a class=menu-link href=/tags/>标签</a></li><li class=menu-item><a class=menu-link href=/about/>关于</a></li><li class="menu-item delimiter"></li><li class="menu-item theme-switch" title=切换主题><i class="fa-solid fa-adjust fa-fw" aria-hidden=true></i></li></ul></nav></div></header><header class="mobile animate__faster" id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="Ghostasky's Blog"><img loading=lazy src=/images/fixit.png alt=/images/fixit.png data-title=/images/fixit.png class=logo style="background:url(/images/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title;for(const e of["style","data-title","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title;for(const e of["style","data-title","onerror","onload"])this.removeAttribute(e)'><span class=header-title-text>Ghostasky's Blog</span></a><span class=header-subtitle></span></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><nav><ul class=menu id=menu-mobile><li class=menu-item><a class=menu-link href=/posts/>文章</a></li><li class=menu-item><a class=menu-link href=/categories/>分类</a></li><li class=menu-item><a class=menu-link href=/tags/>标签</a></li><li class=menu-item><a class=menu-link href=/about/>关于</a></li><li class="menu-item menu-system"><span class="menu-system-item theme-switch" title=切换主题><i class="fa-solid fa-adjust fa-fw" aria-hidden=true></i></span></li></ul></nav></div></header><main class=container><aside class="aside-collection animate__animated animate__fadeIn animate__faster" aria-label=合集></aside><article class="page single"><div class=header><h1 class="single-title animate__animated animate__flipInX"><span>YARA规则</span></h1></div><div class=post-meta><div class=post-meta-line><span class=post-author><span class=author><i class="fa-solid fa-user-circle" aria-hidden=true></i>
Anonymous</span></span><span class=post-included-in>&nbsp;收录于 <a href=/categories/technology/ class=post-category title="分类 - Technology"><i class="fa-regular fa-folder fa-fw" aria-hidden=true></i> Technology</a></span></div><div class=post-meta-line><span title="发布于 2022-08-13 00:00:00"><i class="fa-solid fa-calendar-days fa-fw me-1" aria-hidden=true></i><time datetime=2022-08-13>2022-08-13</time></span>&nbsp;<span title="3535 字"><i class="fa-solid fa-pencil-alt fa-fw me-1" aria-hidden=true></i>约 3600 字</span>&nbsp;<span><i class="fa-regular fa-clock fa-fw me-1" aria-hidden=true></i>预计阅读 8 分钟</span>&nbsp;</div></div><div class="details toc" id=toc-static data-kept=false><div class="details-summary toc-title"><span>目录</span>
<span><i class="details-icon fa-solid fa-angle-right" aria-hidden=true></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#1yara简介>1.YARA简介</a></li><li><a href=#2yara示例>2.YARA示例</a></li><li><a href=#3yara规则>3.yara规则</a><ul><li><a href=#31-注释>3.1 注释</a></li><li><a href=#32-strings>3.2 Strings</a></li><li><a href=#33-conditions>3.3 Conditions</a></li><li><a href=#34-more-rules>3.4 More rules</a></li></ul></li><li><a href=#4modules>4.Modules</a><ul><li><a href=#41-pe>4.1 PE</a></li><li><a href=#42-magic>4.2 Magic</a></li><li><a href=#43-hash>4.3 Hash</a></li><li><a href=#44-math>4.4 Math</a></li><li><a href=#45-console-module>4.5 Console module</a></li></ul></li></ul></nav></div></div><div class=content id=content><p>[toc]</p><h2 id=1yara简介 class=heading-element><a href=#1yara%e7%ae%80%e4%bb%8b class=heading-mark></a>1.YARA简介</h2><p>YARA 是一个旨在（但不限于）帮助恶意软件研究人员识别和分类恶意软件样本的开源工具。</p><p>YARA的每一条描述、规则都由一系列字符串和一个布尔型表达式构成，并阐述其逻辑。YARA规则可以与文件或在运行的进程，以帮助研究人员识别其是否属于某个已进行规则描述的恶意软件等。</p><blockquote><p>项目地址：https://github.com/VirusTotal/yara，（yara64.exe ， yarac64.exe ）</p><p>python：https://github.com/VirusTotal/yara-python</p><p>官方文档：https://yara.readthedocs.io/</p></blockquote><h2 id=2yara示例 class=heading-element><a href=#2yara%e7%a4%ba%e4%be%8b class=heading-mark></a>2.YARA示例</h2><div class=highlight id=id-1><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=n>rule</span> <span class=nl>silent_banker</span> <span class=p>:</span> <span class=n>banker</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nl>meta</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>description</span> <span class=o>=</span> <span class=s>&#34;This is just an example&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>thread_level</span> <span class=o>=</span> <span class=mi>3</span>
</span></span><span class=line><span class=cl>        <span class=n>in_the_wild</span> <span class=o>=</span> <span class=nb>true</span>
</span></span><span class=line><span class=cl>    <span class=nl>strings</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=err>$</span><span class=n>a</span> <span class=o>=</span> <span class=p>{</span><span class=mi>6</span><span class=n>A</span> <span class=mi>40</span> <span class=mi>68</span> <span class=mo>00</span> <span class=mi>30</span> <span class=mo>00</span> <span class=mo>00</span> <span class=mi>6</span><span class=n>A</span> <span class=mi>14</span> <span class=mi>8</span><span class=n>D</span> <span class=mi>91</span><span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=err>$</span><span class=n>b</span> <span class=o>=</span> <span class=p>{</span><span class=mi>8</span><span class=n>D</span> <span class=mi>4</span><span class=n>D</span> <span class=n>B0</span> <span class=mi>2</span><span class=n>B</span> <span class=n>C1</span> <span class=mi>83</span> <span class=n>C0</span> <span class=mi>27</span> <span class=mi>99</span> <span class=mi>6</span><span class=n>A</span> <span class=mi>4</span><span class=n>E</span> <span class=mi>59</span> <span class=n>F7</span> <span class=n>F9</span><span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=err>$</span><span class=n>c</span> <span class=o>=</span> <span class=s>&#34;UVODFRYSIHLNWPEJXQZAKCBGMT&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nl>condition</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=err>$</span><span class=n>a</span> <span class=n>or</span> <span class=err>$</span><span class=n>b</span> <span class=n>or</span> <span class=err>$</span><span class=n>c</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div><p>以上规则：</p><ol><li>名为<code>rule silent_banker</code>的规则，其中<code>banker</code>是规则的tag字段(可以有多个tag)</li><li><code>meta</code>字段是规则的描述信息，比如可以有规则说明、作者信息、威胁等级、在野情况、文件MD5、来源等内容；</li><li><code>strings</code>是规则字段</li><li><code>condition</code>则是条件判断的字段</li></ol><h2 id=3yara规则 class=heading-element><a href=#3yara%e8%a7%84%e5%88%99 class=heading-mark></a>3.yara规则</h2><blockquote><p>官方文档：https://yara.readthedocs.io/en/v4.2.3/writingrules.html</p></blockquote><p>yara中的规则都以<code>rule</code>开头，后面跟着的是<code>identifier</code>（标识符），标识符和编程中的变量命名差不多，部分保留的关键字不能用作标识符：</p><table><thead><tr><th style=text-align:center><strong>all</strong></th><th style=text-align:center><strong>and</strong></th><th style=text-align:center><strong>any</strong></th><th style=text-align:center><strong>ascii</strong></th><th style=text-align:center><strong>at</strong></th><th style=text-align:center><strong>base64</strong></th><th style=text-align:center><strong>base64wide</strong></th><th style=text-align:center><strong>condition</strong></th></tr></thead><tbody><tr><td style=text-align:center><strong>contains</strong></td><td style=text-align:center><strong>endswith</strong></td><td style=text-align:center><strong>entrypoint</strong></td><td style=text-align:center><strong>false</strong></td><td style=text-align:center><strong>filesize</strong></td><td style=text-align:center><strong>for</strong></td><td style=text-align:center><strong>fullword</strong></td><td style=text-align:center><strong>global</strong></td></tr><tr><td style=text-align:center><strong>import</strong></td><td style=text-align:center><strong>icontains</strong></td><td style=text-align:center><strong>iendswith</strong></td><td style=text-align:center><strong>iequals</strong></td><td style=text-align:center><strong>in</strong></td><td style=text-align:center><strong>include</strong></td><td style=text-align:center><strong>int16</strong></td><td style=text-align:center><strong>int16be</strong></td></tr><tr><td style=text-align:center><strong>int32</strong></td><td style=text-align:center><strong>int32be</strong></td><td style=text-align:center><strong>int8</strong></td><td style=text-align:center><strong>int8be</strong></td><td style=text-align:center><strong>istartswith</strong></td><td style=text-align:center><strong>matches</strong></td><td style=text-align:center><strong>meta</strong></td><td style=text-align:center><strong>nocase</strong></td></tr><tr><td style=text-align:center><strong>none</strong></td><td style=text-align:center><strong>not</strong></td><td style=text-align:center><strong>of</strong></td><td style=text-align:center><strong>or</strong></td><td style=text-align:center><strong>private</strong></td><td style=text-align:center><strong>rule</strong></td><td style=text-align:center><strong>startswith</strong></td><td style=text-align:center><strong>strings</strong></td></tr><tr><td style=text-align:center><strong>them</strong></td><td style=text-align:center><strong>true</strong></td><td style=text-align:center><strong>uint16</strong></td><td style=text-align:center><strong>uint16be</strong></td><td style=text-align:center><strong>uint32</strong></td><td style=text-align:center><strong>uint32be</strong></td><td style=text-align:center><strong>uint8</strong></td><td style=text-align:center><strong>uint8be</strong></td></tr><tr><td style=text-align:center><strong>wide</strong></td><td style=text-align:center><strong>xor</strong></td><td style=text-align:center><strong>defined</strong></td><td style=text-align:center></td><td style=text-align:center></td><td style=text-align:center></td><td style=text-align:center></td><td style=text-align:center></td></tr></tbody></table><p>strings的部分由<code>$</code>后跟一系列字母数字字符和下划线组成，strings可以以文本或十六进制形式定义，示例：</p><div class=highlight id=id-2><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=n>rule</span> <span class=n>ExampleRule</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nl>strings</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=err>$</span><span class=n>my_text_string</span> <span class=o>=</span> <span class=s>&#34;text here&#34;</span>
</span></span><span class=line><span class=cl>        <span class=err>$</span><span class=n>my_hex_string</span> <span class=o>=</span> <span class=p>{</span> <span class=n>E2</span> <span class=mi>34</span> <span class=n>A1</span> <span class=n>C8</span> <span class=mi>23</span> <span class=n>FB</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nl>condition</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=err>$</span><span class=n>my_text_string</span> <span class=n>or</span> <span class=err>$</span><span class=n>my_hex_string</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div><ol><li>文本使用引号括起来</li><li>十六进制使用大括号（只能是16进制</li></ol><h3 id=31-注释 class=heading-element><a href=#31-%e6%b3%a8%e9%87%8a class=heading-mark></a>3.1 注释</h3><p>跟c语言一样，行注释和段注释都一样。</p><h3 id=32-strings class=heading-element><a href=#32-strings class=heading-mark></a>3.2 Strings</h3><h4 id=321-hex class=heading-element><a href=#321-hex class=heading-mark></a>3.2.1 Hex</h4><p>这里其实有三种，文本，十六进制，还有一种是正则。</p><p>十六进制可以使用占位符<code>?</code>，通配符使用<code>[]</code></p><div class=highlight id=id-3><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=err>$</span><span class=n>hex_string</span> <span class=o>=</span> <span class=p>{</span> <span class=n>E2</span> <span class=mi>34</span> <span class=o>??</span> <span class=n>C8</span> <span class=n>A</span><span class=o>?</span> <span class=n>FB</span> <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=err>$</span><span class=n>hex_string</span> <span class=o>=</span> <span class=p>{</span> <span class=n>F4</span> <span class=mi>23</span> <span class=p>[</span><span class=mi>4</span><span class=o>-</span><span class=mi>6</span><span class=p>]</span> <span class=mi>62</span> <span class=n>B4</span> <span class=p>}</span></span></span></code></pre></div><p>yara2.0之后可以使用无界跳转：</p><div class=highlight id=id-4><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=n>FE</span> <span class=mi>39</span> <span class=mi>45</span> <span class=p>[</span><span class=mi>10</span><span class=o>-</span><span class=p>]</span> <span class=mi>89</span> <span class=mo>00</span>
</span></span><span class=line><span class=cl><span class=n>FE</span> <span class=mi>39</span> <span class=mi>45</span> <span class=p>[</span><span class=o>-</span><span class=p>]</span> <span class=mi>89</span> <span class=mo>00</span></span></span></code></pre></div><p>还有一种给定部分的替换方案：</p><div class=highlight id=id-5><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=err>$</span><span class=n>hex_string</span> <span class=o>=</span> <span class=p>{</span> <span class=n>F4</span> <span class=mi>23</span> <span class=p>(</span> <span class=mi>62</span> <span class=n>B4</span> <span class=o>|</span> <span class=mi>56</span> <span class=p>)</span> <span class=mi>45</span> <span class=p>}</span></span></span></code></pre></div><p>他会匹配：<code>F42362B445 or F4235645</code></p><h4 id=322-text-strings class=heading-element><a href=#322-text-strings class=heading-mark></a>3.2.2 Text strings</h4><h5 id=不区分大小写nocase class=heading-element><a href=#%e4%b8%8d%e5%8c%ba%e5%88%86%e5%a4%a7%e5%b0%8f%e5%86%99nocase class=heading-mark></a>不区分大小写：nocase</h5><p>不区分大小写：</p><div class=highlight id=id-6><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=err>$</span><span class=n>text_string</span> <span class=o>=</span> <span class=s>&#34;foobar&#34;</span> <span class=n>nocase</span></span></span></code></pre></div><h5 id=宽字节wide class=heading-element><a href=#%e5%ae%bd%e5%ad%97%e8%8a%82wide class=heading-mark></a>宽字节：wide</h5><p>如果字符串“Borland”的编码为每个字符两个字节（即B\x00o\x00r\x00l\x00a\x00n\x00d\x00），则以下规则将匹配：</p><div class=highlight id=id-7><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=n>rule</span> <span class=n>WideCharTextExample1</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nl>strings</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=err>$</span><span class=n>wide_string</span> <span class=o>=</span> <span class=s>&#34;Borland&#34;</span> <span class=n>wide</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nl>condition</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=err>$</span><span class=n>wide_string</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div><p>如果要同时搜索ASCII和wide格式的字符串，可以将ASCII修饰符与wide结合使用，先后顺序无所谓：</p><div class=highlight id=id-8><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=err>$</span><span class=n>wide_and_ascii_string</span> <span class=o>=</span> <span class=s>&#34;Borland&#34;</span> <span class=n>wide</span> <span class=n>ascii</span></span></span></code></pre></div><blockquote><p>默认情况下Text就是ascii的。</p></blockquote><h5 id=xorxor class=heading-element><a href=#xorxor class=heading-mark></a>XOR：xor</h5><p>以下规则将搜索应用于字符串“This program cannot”（包括明文字符串）的每个单字节XOR：</p><div class=highlight id=id-9><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=n>rule</span> <span class=n>XorExample1</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nl>strings</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=err>$</span><span class=n>xor_string</span> <span class=o>=</span> <span class=s>&#34;This program cannot&#34;</span> <span class=n>xor</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nl>condition</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=err>$</span><span class=n>xor_string</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div><p>等价于：</p><div class=highlight id=id-10><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=n>rule</span> <span class=n>XorExample2</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nl>strings</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=err>$</span><span class=n>xor_string_00</span> <span class=o>=</span> <span class=s>&#34;This program cannot&#34;</span>
</span></span><span class=line><span class=cl>        <span class=err>$</span><span class=n>xor_string_01</span> <span class=o>=</span> <span class=s>&#34;Uihr!qsnfs`l!b`oonu&#34;</span>
</span></span><span class=line><span class=cl>        <span class=err>$</span><span class=n>xor_string_02</span> <span class=o>=</span> <span class=s>&#34;Vjkq</span><span class=se>\&#34;</span><span class=s>rpmepco</span><span class=se>\&#34;</span><span class=s>acllmv&#34;</span>
</span></span><span class=line><span class=cl>        <span class=c1>// Repeat for every single byte XOR
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nl>condition</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>any</span> <span class=n>of</span> <span class=n>them</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div><p>同样可以结合<code>wide</code>和<code>ascii</code>使用</p><h5 id=base64base64 class=heading-element><a href=#base64base64 class=heading-mark></a>base64：base64</h5><p>以下规则将搜索字符串“此程序无法”的三个base64排列：</p><div class=highlight id=id-11><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=n>rule</span> <span class=n>Base64Example1</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nl>strings</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=err>$</span><span class=n>a</span> <span class=o>=</span> <span class=s>&#34;This program cannot&#34;</span> <span class=n>base64</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nl>condition</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=err>$</span><span class=n>a</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm>VGhpcyBwcm9ncmFtIGNhbm5vd
</span></span></span><span class=line><span class=cl><span class=cm>RoaXMgcHJvZ3JhbSBjYW5ub3
</span></span></span><span class=line><span class=cl><span class=cm>UaGlzIHByb2dyYW0gY2Fubm90
</span></span></span><span class=line><span class=cl><span class=cm>*/</span></span></span></code></pre></div><p>base64wide修改器的工作方式与base64修改器类似，但base64调整器的结果将转换为wide。</p><p>base64和base64宽修饰符还支持自定义字母表，当然字母表长度必须为64</p><div class=highlight id=id-12><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=err>$</span><span class=n>a</span> <span class=o>=</span> <span class=s>&#34;This program cannot&#34;</span> <span class=nf>base64</span><span class=p>(</span><span class=s>&#34;!@#$%^&amp;*(){}[].,|ABCDEFGHIJ</span><span class=se>\x09</span><span class=s>LMNOPQRSTUVWXYZabcdefghijklmnopqrstu&#34;</span><span class=p>)</span></span></span></code></pre></div><h5 id=searching-for-full-wordsfullword class=heading-element><a href=#searching-for-full-wordsfullword class=heading-mark></a>Searching for full words：fullword</h5><p>比如说匹配domain的话，<code>www.mydomain.com</code>这样不会被匹配，但：<code>www.my-domain.com and www.domain.com</code>这样会被匹配</p><h4 id=323-正则 class=heading-element><a href=#323-%e6%ad%a3%e5%88%99 class=heading-mark></a>3.2.3 正则</h4><p>正则同样可以后面跟nocase，ascii等修饰符</p><div class=highlight id=id-13><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=n>rule</span> <span class=n>RegExpExample1</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nl>strings</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=err>$</span><span class=n>re1</span> <span class=o>=</span> <span class=o>/</span><span class=nl>md5</span><span class=p>:</span> <span class=p>[</span><span class=mi>0</span><span class=o>-</span><span class=mi>9</span><span class=n>a</span><span class=o>-</span><span class=n>fA</span><span class=o>-</span><span class=n>F</span><span class=p>]{</span><span class=mi>32</span><span class=p>}</span><span class=o>/</span>
</span></span><span class=line><span class=cl>        <span class=err>$</span><span class=n>re2</span> <span class=o>=</span> <span class=o>/</span><span class=nl>state</span><span class=p>:</span> <span class=p>(</span><span class=n>on</span><span class=o>|</span><span class=n>off</span><span class=p>)</span><span class=o>/</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nl>condition</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=err>$</span><span class=n>re1</span> <span class=n>and</span> <span class=err>$</span><span class=n>re2</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div><p>可以在后面结束的斜杠后面加i或者s，用于指定正则表达式不区分大小写。</p><p><code>.</code>可以匹配新一行的字符：</p><div class=highlight id=id-14><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=n>rule</span> <span class=n>RegExpExample2</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nl>strings</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=err>$</span><span class=n>re1</span> <span class=o>=</span> <span class=o>/</span><span class=n>foo</span><span class=o>/</span><span class=n>i</span>    <span class=c1>// This regexp is case-insentitive
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=err>$</span><span class=n>re2</span> <span class=o>=</span> <span class=o>/</span><span class=n>bar</span><span class=p>.</span><span class=o>/</span><span class=n>s</span>   <span class=c1>// In this regexp the dot matches everything, including new-line
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=err>$</span><span class=n>re3</span> <span class=o>=</span> <span class=o>/</span><span class=n>baz</span><span class=p>.</span><span class=o>/</span><span class=n>is</span>  <span class=c1>// Both modifiers can be used together
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nl>condition</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>any</span> <span class=n>of</span> <span class=n>them</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div><p>YARA正则表达式识别以下元字符：</p><table><thead><tr><th style=text-align:center><code>\</code></th><th style=text-align:center>引用下一个元字符</th></tr></thead><tbody><tr><td style=text-align:center><strong><code>^</code></strong></td><td style=text-align:center><strong>匹配文件的开头，或在用作左括号后的第一个字符时，对字符类求反</strong></td></tr><tr><td style=text-align:center><strong><code>$</code></strong></td><td style=text-align:center><strong>匹配文件的结尾</strong></td></tr><tr><td style=text-align:center><strong><code>.</code></strong></td><td style=text-align:center><strong>匹配除换行符以外的任何单个字符</strong></td></tr><tr><td style=text-align:center>**`</td><td style=text-align:center>`**</td></tr><tr><td style=text-align:center><strong><code>()</code></strong></td><td style=text-align:center><strong>Grouping</strong></td></tr><tr><td style=text-align:center><strong><code>[]</code></strong></td><td style=text-align:center><strong>Bracketed character class</strong></td></tr></tbody></table><p>以下量词也可以识别：</p><table><thead><tr><th style=text-align:center><strong><code>*</code></strong></th><th style=text-align:center><strong>Match 0 or more times</strong></th></tr></thead><tbody><tr><td style=text-align:center><strong><code>+</code></strong></td><td style=text-align:center><strong>Match 1 or more times</strong></td></tr><tr><td style=text-align:center><strong><code>?</code></strong></td><td style=text-align:center><strong>Match 0 or 1 times</strong></td></tr><tr><td style=text-align:center><strong><code>{n}</code></strong></td><td style=text-align:center><strong>Match exactly n times（精确匹配）</strong></td></tr><tr><td style=text-align:center><strong><code>{n,}</code></strong></td><td style=text-align:center><strong>Match at least n times（至少匹配n次）</strong></td></tr><tr><td style=text-align:center><strong><code>{,m}</code></strong></td><td style=text-align:center><strong>Match at most m times（最多匹配n次）</strong></td></tr><tr><td style=text-align:center><strong><code>{n,m}</code></strong></td><td style=text-align:center><strong>Match n to m times</strong></td></tr></tbody></table><p>以下转义字符可识别：</p><table><thead><tr><th style=text-align:center><strong><code>\t</code></strong></th><th style=text-align:center><strong>Tab (HT, TAB)</strong></th></tr></thead><tbody><tr><td style=text-align:center><strong><code>\n</code></strong></td><td style=text-align:center><strong>New line (LF, NL)</strong></td></tr><tr><td style=text-align:center><strong><code>\r</code></strong></td><td style=text-align:center><strong>Return (CR)</strong></td></tr><tr><td style=text-align:center><strong><code>\f</code></strong></td><td style=text-align:center><strong>Form feed (FF)换页</strong></td></tr><tr><td style=text-align:center><strong><code>\a</code></strong></td><td style=text-align:center><strong>Alarm bell</strong></td></tr><tr><td style=text-align:center><strong><code>\xNN</code></strong></td><td style=text-align:center><strong>序号为给定十六进制数的字符</strong></td></tr></tbody></table><p>公认字符类：</p><table><thead><tr><th><code>\w</code></th><th>匹配单词字符 (alphanumeric plus “_”)</th></tr></thead><tbody><tr><td><code>\W</code></td><td>匹配非单词字符</td></tr><tr><td><code>\s</code></td><td>匹配空白字符</td></tr><tr><td><code>\S</code></td><td>Match a non-whitespace character</td></tr><tr><td><code>\d</code></td><td>匹配十进制数字字符</td></tr><tr><td><code>\D</code></td><td>Match a non-digit character</td></tr></tbody></table><h3 id=33-conditions class=heading-element><a href=#33-conditions class=heading-mark></a>3.3 Conditions</h3><p>conditions就是布尔表达式，and or not ，关系运算符，算数运算符，位运算等。</p><p>整数的长度始终为64位，使用位运算符时（例如，~0x01不是0xFE，而是0xFFFFFFFFFE）。</p><h4 id=331-counting-strings class=heading-element><a href=#331-counting-strings class=heading-mark></a>3.3.1 Counting strings</h4><p>如题，就是计算string的次数，这里使用的是井号</p><div class=highlight id=id-15><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=n>rule</span> <span class=n>CountExample</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nl>strings</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=err>$</span><span class=n>a</span> <span class=o>=</span> <span class=s>&#34;dummy1&#34;</span>
</span></span><span class=line><span class=cl>        <span class=err>$</span><span class=n>b</span> <span class=o>=</span> <span class=s>&#34;dummy2&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nl>condition</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=cp>#a == 6 and #b &gt; 10
</span></span></span><span class=line><span class=cl><span class=cp></span><span class=p>}</span></span></span></code></pre></div><p>yara4.2.0后，</p><div class=highlight id=id-16><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cp>##a in (filesize-500..filesize) == 2
</span></span></span><span class=line><span class=cl><span class=cp></span><span class=c1>//文件最后500个字节中的“a”字符串数必须正好等于2。
</span></span></span></code></pre></div><h4 id=332-string-offsets-or-virtual-addresses class=heading-element><a href=#332-string-offsets-or-virtual-addresses class=heading-mark></a>3.3.2 String offsets or virtual addresses</h4><p>需要知道字符串是否位于文件上的某个特定偏移量或进程地址空间中的某个虚拟地址，使用at。</p><div class=highlight id=id-17><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=n>rule</span> <span class=n>AtExample</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nl>strings</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=err>$</span><span class=n>a</span> <span class=o>=</span> <span class=s>&#34;dummy1&#34;</span>
</span></span><span class=line><span class=cl>        <span class=err>$</span><span class=n>b</span> <span class=o>=</span> <span class=s>&#34;dummy2&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nl>condition</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=err>$</span><span class=n>a</span> <span class=n>at</span> <span class=mi>100</span> <span class=n>and</span> <span class=err>$</span><span class=n>b</span> <span class=n>at</span> <span class=mi>200</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div><p>at的优先级高于and</p><p>at运算符允许在文件或进程内存空间中的虚拟地址的某个固定偏移量处搜索字符串，而in运算符允许在偏移量或地址范围内搜索字符串。</p><div class=highlight id=id-18><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=n>rule</span> <span class=n>InExample</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nl>strings</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=err>$</span><span class=n>a</span> <span class=o>=</span> <span class=s>&#34;dummy1&#34;</span>
</span></span><span class=line><span class=cl>        <span class=err>$</span><span class=n>b</span> <span class=o>=</span> <span class=s>&#34;dummy2&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nl>condition</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=err>$</span><span class=n>a</span> <span class=nf>in</span> <span class=p>(</span><span class=mf>0..100</span><span class=p>)</span> <span class=n>and</span> <span class=err>$</span><span class=n>b</span> <span class=nf>in</span> <span class=p>(</span><span class=mf>100.</span><span class=p>.</span><span class=n>filesize</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div><blockquote><p>可以使用@a[i]获得字符串$a第i次出现的偏移量或虚拟地址。索引是基于1的，因此第一次出现是@a[1]，第二次出现是@a[2]，依此类推。如果提供的索引大于字符串的出现次数，则结果将是一个NaN（不是数字）值。</p></blockquote><h4 id=333-file-size class=heading-element><a href=#333-file-size class=heading-mark></a>3.3.3 File size</h4><p>直接就是<code>filesize</code></p><div class=highlight id=id-19><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=n>rule</span> <span class=n>FileSizeExample</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nl>condition</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>filesize</span> <span class=o>&gt;</span> <span class=mi>200</span><span class=n>KB</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div><h4 id=334-executable-entry-point class=heading-element><a href=#334-executable-entry-point class=heading-mark></a>3.3.4 Executable entry point</h4><p>另个一特殊的变量就是<code>entrypoint</code>，当然，使用这个的前提必须是pe文件</p><div class=highlight id=id-20><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=n>rule</span> <span class=n>EntryPointExample1</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nl>strings</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=err>$</span><span class=n>a</span> <span class=o>=</span> <span class=p>{</span> <span class=n>E8</span> <span class=mo>00</span> <span class=mo>00</span> <span class=mo>00</span> <span class=mo>00</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nl>condition</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=err>$</span><span class=n>a</span> <span class=n>at</span> <span class=n>entrypoint</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>rule</span> <span class=n>EntryPointExample2</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nl>strings</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=err>$</span><span class=n>a</span> <span class=o>=</span> <span class=p>{</span> <span class=mi>9</span><span class=n>C</span> <span class=mi>50</span> <span class=mi>66</span> <span class=n>A1</span> <span class=o>??</span> <span class=o>??</span> <span class=o>??</span> <span class=mo>00</span> <span class=mi>66</span> <span class=n>A9</span> <span class=o>??</span> <span class=o>??</span> <span class=mi>58</span> <span class=mf>0F</span> <span class=mi>85</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nl>condition</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=err>$</span><span class=n>a</span> <span class=nf>in</span> <span class=p>(</span><span class=n>entrypoint</span><span class=p>..</span><span class=n>entrypoint</span> <span class=o>+</span> <span class=mi>10</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div><h4 id=335-给定位置的数据访问 class=heading-element><a href=#335-%e7%bb%99%e5%ae%9a%e4%bd%8d%e7%bd%ae%e7%9a%84%e6%95%b0%e6%8d%ae%e8%ae%bf%e9%97%ae class=heading-mark></a>3.3.5 给定位置的数据访问</h4><div class=highlight id=id-21><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=nf>int8</span><span class=p>(</span><span class=o>&lt;</span><span class=n>offset</span> <span class=n>or</span> <span class=n>virtual</span> <span class=n>address</span><span class=o>&gt;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nf>int16</span><span class=p>(</span><span class=o>&lt;</span><span class=n>offset</span> <span class=n>or</span> <span class=n>virtual</span> <span class=n>address</span><span class=o>&gt;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nf>int32</span><span class=p>(</span><span class=o>&lt;</span><span class=n>offset</span> <span class=n>or</span> <span class=n>virtual</span> <span class=n>address</span><span class=o>&gt;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>uint8</span><span class=p>(</span><span class=o>&lt;</span><span class=n>offset</span> <span class=n>or</span> <span class=n>virtual</span> <span class=n>address</span><span class=o>&gt;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nf>uint16</span><span class=p>(</span><span class=o>&lt;</span><span class=n>offset</span> <span class=n>or</span> <span class=n>virtual</span> <span class=n>address</span><span class=o>&gt;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nf>uint32</span><span class=p>(</span><span class=o>&lt;</span><span class=n>offset</span> <span class=n>or</span> <span class=n>virtual</span> <span class=n>address</span><span class=o>&gt;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>int8be</span><span class=p>(</span><span class=o>&lt;</span><span class=n>offset</span> <span class=n>or</span> <span class=n>virtual</span> <span class=n>address</span><span class=o>&gt;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nf>int16be</span><span class=p>(</span><span class=o>&lt;</span><span class=n>offset</span> <span class=n>or</span> <span class=n>virtual</span> <span class=n>address</span><span class=o>&gt;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nf>int32be</span><span class=p>(</span><span class=o>&lt;</span><span class=n>offset</span> <span class=n>or</span> <span class=n>virtual</span> <span class=n>address</span><span class=o>&gt;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>uint8be</span><span class=p>(</span><span class=o>&lt;</span><span class=n>offset</span> <span class=n>or</span> <span class=n>virtual</span> <span class=n>address</span><span class=o>&gt;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nf>uint16be</span><span class=p>(</span><span class=o>&lt;</span><span class=n>offset</span> <span class=n>or</span> <span class=n>virtual</span> <span class=n>address</span><span class=o>&gt;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nf>uint32be</span><span class=p>(</span><span class=o>&lt;</span><span class=n>offset</span> <span class=n>or</span> <span class=n>virtual</span> <span class=n>address</span><span class=o>&gt;</span><span class=p>)</span></span></span></code></pre></div><p>举例：</p><div class=highlight id=id-22><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=n>rule</span> <span class=n>IsPE</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nl>condition</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=c1>// MZ signature at offset 0 and ...
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nf>uint16</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span> <span class=o>==</span> <span class=mh>0x5A4D</span> <span class=n>and</span>
</span></span><span class=line><span class=cl>        <span class=c1>// ... PE signature at offset stored in MZ header at 0x3C
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nf>uint32</span><span class=p>(</span><span class=nf>uint32</span><span class=p>(</span><span class=mh>0x3C</span><span class=p>))</span> <span class=o>==</span> <span class=mh>0x00004550</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div><h4 id=336-字符串集 class=heading-element><a href=#336-%e5%ad%97%e7%ac%a6%e4%b8%b2%e9%9b%86 class=heading-mark></a>3.3.6 字符串集</h4><p>使用<code>of</code>，至少存在字符串集中的一部分。</p><div class=highlight id=id-23><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=n>rule</span> <span class=n>OfExample1</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nl>strings</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=err>$</span><span class=n>a</span> <span class=o>=</span> <span class=s>&#34;dummy1&#34;</span>
</span></span><span class=line><span class=cl>        <span class=err>$</span><span class=n>b</span> <span class=o>=</span> <span class=s>&#34;dummy2&#34;</span>
</span></span><span class=line><span class=cl>        <span class=err>$</span><span class=n>c</span> <span class=o>=</span> <span class=s>&#34;dummy3&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nl>condition</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=mi>2</span> <span class=nf>of</span> <span class=p>(</span><span class=err>$</span><span class=n>a</span><span class=p>,</span><span class=err>$</span><span class=n>b</span><span class=p>,</span><span class=err>$</span><span class=n>c</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div><p>也可以这样：</p><div class=highlight id=id-24><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=n>rule</span> <span class=n>OfExample2</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nl>strings</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=err>$</span><span class=n>foo1</span> <span class=o>=</span> <span class=s>&#34;foo1&#34;</span>
</span></span><span class=line><span class=cl>        <span class=err>$</span><span class=n>foo2</span> <span class=o>=</span> <span class=s>&#34;foo2&#34;</span>
</span></span><span class=line><span class=cl>        <span class=err>$</span><span class=n>foo3</span> <span class=o>=</span> <span class=s>&#34;foo3&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nl>condition</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=mi>2</span> <span class=nf>of</span> <span class=p>(</span><span class=err>$</span><span class=n>foo</span><span class=o>*</span><span class=p>)</span>  <span class=c1>// equivalent to 2 of ($foo1,$foo2,$foo3)
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>rule</span> <span class=n>OfExample3</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nl>strings</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=err>$</span><span class=n>foo1</span> <span class=o>=</span> <span class=s>&#34;foo1&#34;</span>
</span></span><span class=line><span class=cl>        <span class=err>$</span><span class=n>foo2</span> <span class=o>=</span> <span class=s>&#34;foo2&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=err>$</span><span class=n>bar1</span> <span class=o>=</span> <span class=s>&#34;bar1&#34;</span>
</span></span><span class=line><span class=cl>        <span class=err>$</span><span class=n>bar2</span> <span class=o>=</span> <span class=s>&#34;bar2&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nl>condition</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=mi>3</span> <span class=nf>of</span> <span class=p>(</span><span class=err>$</span><span class=n>foo</span><span class=o>*</span><span class=p>,</span><span class=err>$</span><span class=n>bar1</span><span class=p>,</span><span class=err>$</span><span class=n>bar2</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div><p>也可以直接使用<code>($*)</code>引用所有字符串，或者可以使用<code>them</code></p><div class=highlight id=id-25><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=n>rule</span> <span class=n>OfExample4</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nl>strings</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=err>$</span><span class=n>a</span> <span class=o>=</span> <span class=s>&#34;dummy1&#34;</span>
</span></span><span class=line><span class=cl>        <span class=err>$</span><span class=n>b</span> <span class=o>=</span> <span class=s>&#34;dummy2&#34;</span>
</span></span><span class=line><span class=cl>        <span class=err>$</span><span class=n>c</span> <span class=o>=</span> <span class=s>&#34;dummy3&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nl>condition</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=mi>1</span> <span class=n>of</span> <span class=n>them</span> <span class=c1>// equivalent to 1 of ($*)
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span></span></span></code></pre></div><p>还有以下几种：</p><div class=highlight id=id-26><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=n>all</span> <span class=n>of</span> <span class=n>them</span>       <span class=c1>// all strings in the rule
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>any</span> <span class=n>of</span> <span class=n>them</span>       <span class=c1>// any string in the rule
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>all</span> <span class=nf>of</span> <span class=p>(</span><span class=err>$</span><span class=n>a</span><span class=o>*</span><span class=p>)</span>      <span class=c1>// all strings whose identifier starts by $a
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>any</span> <span class=nf>of</span> <span class=p>(</span><span class=err>$</span><span class=n>a</span><span class=p>,</span><span class=err>$</span><span class=n>b</span><span class=p>,</span><span class=err>$</span><span class=n>c</span><span class=p>)</span> <span class=c1>// any of $a, $b or $c
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=mi>1</span> <span class=nf>of</span> <span class=p>(</span><span class=err>$</span><span class=o>*</span><span class=p>)</span>         <span class=c1>// same that &#34;any of them&#34;
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>none</span> <span class=nf>of</span> <span class=p>(</span><span class=err>$</span><span class=n>b</span><span class=o>*</span><span class=p>)</span>     <span class=c1>// zero of the set of strings that start with &#34;$b&#34;
</span></span></span></code></pre></div><h4 id=337-对多个字符串应用相同的条件 class=heading-element><a href=#337-%e5%af%b9%e5%a4%9a%e4%b8%aa%e5%ad%97%e7%ac%a6%e4%b8%b2%e5%ba%94%e7%94%a8%e7%9b%b8%e5%90%8c%e7%9a%84%e6%9d%a1%e4%bb%b6 class=heading-mark></a>3.3.7 对多个字符串应用相同的条件</h4><p>使用的是<code>for...of</code>操作符：</p><p><code>for expression of string_set : ( boolean_expression )</code></p><blockquote><p>从string_ set中的这些字符串中，至少它们的expression必须满足boolean_expression</p></blockquote><p>可以使用<code>$</code>来做占位符：</p><div class=highlight id=id-27><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>for</span> <span class=n>any</span> <span class=nf>of</span> <span class=p>(</span><span class=err>$</span><span class=n>a</span><span class=p>,</span><span class=err>$</span><span class=n>b</span><span class=p>,</span><span class=err>$</span><span class=n>c</span><span class=p>)</span> <span class=o>:</span> <span class=p>(</span> <span class=err>$</span> <span class=n>at</span> <span class=n>pe</span><span class=p>.</span><span class=n>entry_point</span>  <span class=p>)</span></span></span></code></pre></div><h4 id=338-使用带of和forof的匿名字符串 class=heading-element><a href=#338-%e4%bd%bf%e7%94%a8%e5%b8%a6of%e5%92%8cforof%e7%9a%84%e5%8c%bf%e5%90%8d%e5%ad%97%e7%ac%a6%e4%b8%b2 class=heading-mark></a>3.3.8 使用带of和for..of的匿名字符串</h4><div class=highlight id=id-28><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=n>rule</span> <span class=n>AnonymousStrings</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nl>strings</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=err>$</span> <span class=o>=</span> <span class=s>&#34;dummy1&#34;</span>
</span></span><span class=line><span class=cl>        <span class=err>$</span> <span class=o>=</span> <span class=s>&#34;dummy2&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nl>condition</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=mi>1</span> <span class=n>of</span> <span class=n>them</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div><h4 id=339-迭代字符串出现次数 class=heading-element><a href=#339-%e8%bf%ad%e4%bb%a3%e5%ad%97%e7%ac%a6%e4%b8%b2%e5%87%ba%e7%8e%b0%e6%ac%a1%e6%95%b0 class=heading-mark></a>3.3.9 迭代字符串出现次数</h4><div class=highlight id=id-29><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=n>rule</span> <span class=n>Occurrences</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nl>strings</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=err>$</span><span class=n>a</span> <span class=o>=</span> <span class=s>&#34;dummy1&#34;</span>
</span></span><span class=line><span class=cl>        <span class=err>$</span><span class=n>b</span> <span class=o>=</span> <span class=s>&#34;dummy2&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nl>condition</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>all</span> <span class=n>i</span> <span class=nf>in</span> <span class=p>(</span><span class=mi>1</span><span class=p>,</span><span class=mi>2</span><span class=p>,</span><span class=mi>3</span><span class=p>)</span> <span class=o>:</span> <span class=p>(</span> <span class=err>@</span><span class=n>a</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>+</span> <span class=mi>10</span> <span class=o>==</span> <span class=err>@</span><span class=n>b</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=p>)</span>
</span></span><span class=line><span class=cl>    	<span class=c1>//也可以这样写
</span></span></span><span class=line><span class=cl><span class=c1></span>    	<span class=c1>//for all i in (1..3) : ( @a[i] + 10 == @b[i] )
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span></span></span></code></pre></div><p>#a表示$a的出现次数</p><div class=highlight id=id-30><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>for</span> <span class=n>all</span> <span class=n>i</span> <span class=nf>in</span> <span class=p>(</span><span class=mf>1.</span><span class=p>.</span><span class=err>#</span><span class=n>a</span><span class=p>)</span> <span class=o>:</span> <span class=p>(</span> <span class=err>@</span><span class=n>a</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>&lt;</span> <span class=mi>100</span> <span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>//每次出现都在前100字节内
</span></span></span></code></pre></div><h4 id=3310-iterators class=heading-element><a href=#3310-iterators class=heading-mark></a>3.3.10 Iterators</h4><p>yara4.0后<code>for...of</code> 得到了改善</p><div class=highlight id=id-31><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>for</span> <span class=n>any</span> <span class=n>section</span> <span class=n>in</span> <span class=n>pe</span><span class=p>.</span><span class=nl>sections</span> <span class=p>:</span> <span class=p>(</span> <span class=n>section</span><span class=p>.</span><span class=n>name</span> <span class=o>==</span> <span class=s>&#34;.text&#34;</span> <span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>//等价
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>for</span> <span class=n>any</span> <span class=n>i</span> <span class=nf>in</span> <span class=p>(</span><span class=mf>0.</span><span class=p>.</span><span class=n>pe</span><span class=p>.</span><span class=n>number_of_sections</span><span class=o>-</span><span class=mi>1</span><span class=p>)</span> <span class=o>:</span> <span class=p>(</span> <span class=n>pe</span><span class=p>.</span><span class=n>sections</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>name</span> <span class=o>==</span> <span class=s>&#34;.text&#34;</span> <span class=p>)</span></span></span></code></pre></div><h3 id=34-more-rules class=heading-element><a href=#34-more-rules class=heading-mark></a>3.4 More rules</h3><h4 id=341-global-rules class=heading-element><a href=#341-global-rules class=heading-mark></a>3.4.1 Global rules</h4><p>全局规则允许您同时在所有规则中施加限制。全局规则可以有很多</p><div class=highlight id=id-32><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=n>global</span> <span class=n>rule</span> <span class=n>SizeLimit</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nl>condition</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>filesize</span> <span class=o>&lt;</span> <span class=mi>2</span><span class=n>MB</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div><h4 id=342-rule-tags class=heading-element><a href=#342-rule-tags class=heading-mark></a>3.4.2 Rule tags</h4><p>这些tag稍后可以用于过滤YARA的输出</p><h4 id=343-metadata class=heading-element><a href=#343-metadata class=heading-mark></a>3.4.3 Metadata</h4><p>没啥说的，上面写了。</p><h2 id=4modules class=heading-element><a href=#4modules class=heading-mark></a>4.Modules</h2><h3 id=41-pe class=heading-element><a href=#41-pe class=heading-mark></a>4.1 PE</h3><blockquote><p><a href=https://yara.readthedocs.io/en/v4.2.3/modules/pe.html target=_blank rel="external nofollow noopener noreferrer">https://yara.readthedocs.io/en/v4.2.3/modules/pe.html</a></p></blockquote><p>有点多，，没啥写的</p><p>后面那个elf也是</p><h3 id=42-magic class=heading-element><a href=#42-magic class=heading-mark></a>4.2 Magic</h3><p>就是文件的 magic，可以file命令查看</p><p>Magic Module一共两个函数：</p><ul><li><p>type()：returning a string with the type of the file.</p><p><code>magic.type() contains "PDF"</code></p></li><li><p>mime_type()：returning a string with the MIME type of the file.</p><p><code>magic.mime_type() == "application/pdf"</code></p></li></ul><h3 id=43-hash class=heading-element><a href=#43-hash class=heading-mark></a>4.3 Hash</h3><p>不用解释了，，有：MD5，sha1，sha256</p><h3 id=44-math class=heading-element><a href=#44-math class=heading-mark></a>4.4 Math</h3><blockquote><p>允许您从文件的某些部分计算某些值，并基于这些结果创建签名。</p></blockquote><h3 id=45-console-module class=heading-element><a href=#45-console-module class=heading-mark></a>4.5 Console module</h3><ul><li>log(string)：<code>console.log(pe.imphash())</code></li><li>log(message,string)：<code>console.log("The imphash is: ", pe.imphash())</code></li></ul><p>后面的参数不止可以string，int，float也可</p></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span title="更新于 2022-08-13 00:00:00">更新于 2022-08-13&nbsp;</span></div><div class=post-info-license><span><a rel="license external nofollow noopener noreferrer" href=https://creativecommons.org/licenses/by-nc-sa/4.0/ target=_blank>CC BY-NC-SA 4.0</a></span></div></div><div class=post-info-line><div class=post-info-md></div><div class=post-info-share><span><a href=javascript:void(0); title="分享到 Twitter" data-sharer=twitter data-url=http://ghostasky.github.io/posts/2022-8-13-yara/ data-title=YARA规则 data-hashtags=Antivirus><i class="fa-brands fa-twitter fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); title="分享到 Facebook" data-sharer=facebook data-url=http://ghostasky.github.io/posts/2022-8-13-yara/ data-hashtag=Antivirus><i class="fa-brands fa-facebook-square fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); title="分享到 微博" data-sharer=weibo data-url=http://ghostasky.github.io/posts/2022-8-13-yara/ data-title=YARA规则><i class="fa-brands fa-weibo fa-fw" aria-hidden=true></i></a></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fa-solid fa-tags fa-fw me-1" aria-hidden=true></i><a href=/tags/antivirus/ class=post-tag title="标签 - Antivirus">Antivirus</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>返回</a></span>&nbsp;|&nbsp;<span><a href=/>主页</a></span></section></div><div class=post-nav><a href=/posts/rc4/ class=post-nav-item rel=prev title=RC4><i class="fa-solid fa-angle-left fa-fw" aria-hidden=true></i>RC4</a>
<a href=/posts/2022-9-winkernel%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F/ class=post-nav-item rel=next title=Windows内核(一)——保护模式>Windows内核(一)——保护模式<i class="fa-solid fa-angle-right fa-fw" aria-hidden=true></i></a></div></div></article><aside class=toc id=toc-auto aria-label=目录><h2 class=toc-title>目录&nbsp;<i class="toc-icon fa-solid fa-angle-down fa-fw" aria-hidden=true></i></h2><div class=toc-content id=toc-content-auto></div></aside></main><footer class=footer><div class=footer-container><div class="footer-line powered">由 <a href=https://gohugo.io/ target=_blank rel="external nofollow noopener noreferrer" title="Hugo 0.123.8"><img class=hugo-icon src=/images/hugo.min.svg alt="Hugo logo"> Hugo</a> 强力驱动 | 主题 - <a href=https://github.com/hugo-fixit/FixIt target=_blank rel=external title="FixIt v0.3.2"><img class=fixit-icon src=/images/fixit.min.svg alt="FixIt logo"> FixIt</a></div><div class="footer-line copyright" itemscope itemtype=http://schema.org/CreativeWork><i class="fa-regular fa-copyright fa-fw" aria-hidden=true></i>
<span itemprop=copyrightYear>2024</span><span class=author itemprop=copyrightHolder>
<a href=/></a></span></div></div></footer></div><div class=widgets><div class="fixed-buttons animate__faster d-none"><div class="fixed-button back-to-top" role=button aria-label=回到顶部><i class="fa-solid fa-arrow-up fa-fw" aria-hidden=true></i><span class="variant-numeric d-none">0%</span></div></div><div id=mask></div><noscript><div class=noscript-warning>FixIt 主题在启用 JavaScript 的情况下效果最佳。</div></noscript></div><link rel=preload href=/lib/katex/katex.min.css as=style onload='this.removeAttribute("onload"),this.rel="stylesheet"'><noscript><link rel=stylesheet href=/lib/katex/katex.min.css></noscript><link rel=stylesheet href=/lib/cookieconsent/cookieconsent.min.css><script src=/lib/sharer/sharer.min.js async defer></script><script src=/lib/katex/katex.min.js defer></script><script src=/lib/katex/auto-render.min.js defer></script><script src=/lib/katex/copy-tex.min.js defer></script><script src=/lib/katex/mhchem.min.js defer></script><script src=/lib/cookieconsent/cookieconsent.min.js defer></script><script>window.config={code:{copyTitle:"复制到剪贴板",editLockTitle:"锁定可编辑代码块",editUnLockTitle:"解锁可编辑代码块",editable:!0,maxShownLines:10},comment:{enable:!1},cookieconsent:{content:{dismiss:"同意",link:"了解更多",message:"本网站使用 Cookies 来改善您的浏览体验。"},enable:!0,palette:{button:{background:"#f0f0f0"},popup:{background:"#1aa3ff"}},theme:"edgeless"},math:{delimiters:[{display:!0,left:"$$",right:"$$"},{display:!0,left:"\\[",right:"\\]"},{display:!0,left:"\\begin{equation}",right:"\\end{equation}"},{display:!0,left:"\\begin{equation*}",right:"\\end{equation*}"},{display:!0,left:"\\begin{align}",right:"\\end{align}"},{display:!0,left:"\\begin{align*}",right:"\\end{align*}"},{display:!0,left:"\\begin{alignat}",right:"\\end{alignat}"},{display:!0,left:"\\begin{alignat*}",right:"\\end{alignat*}"},{display:!0,left:"\\begin{gather}",right:"\\end{gather}"},{display:!0,left:"\\begin{CD}",right:"\\end{CD}"},{display:!1,left:"$",right:"$"},{display:!1,left:"\\(",right:"\\)"}],strict:!1}}</script><script src=/js/theme.min.js defer></script></body></html>