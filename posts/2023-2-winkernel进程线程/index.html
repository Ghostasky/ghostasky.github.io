<!DOCTYPE html>
<html itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">
  <head>
    
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
    <meta name="robots" content="noodp" />
    <title>Windows内核(四)——进程线程 - Ghostasky&#39;s Blog</title><meta name="author" content="Ghostasky">
<meta name="author-link" content="">
<meta name="description" content="[toc] 进程&amp;线程 滴水中级上 001.进程结构体 每个windows进程在0环都有一个对应的结构体：EPROCESS ，这个结构体包含了进程所有重要的信息。 EPROCESS kd&gt; dt _EPROCESS ntdll!_EPROCESS &#43;0x000 Pcb : _KPROCESS &#43;0x06c ProcessLock : _EX_PUSH_LOCK &#43;0x070 CreateTime : _LARGE_INTEGER//进程的创建时间 &#43;0x078 ExitTime : _L" /><meta name="keywords" content='Win32' /><meta itemprop="name" content="Windows内核(四)——进程线程">
<meta itemprop="description" content="[toc] 进程&amp;线程 滴水中级上 001.进程结构体 每个windows进程在0环都有一个对应的结构体：EPROCESS ，这个结构体包含了进程所有重要的信息。 EPROCESS kd&gt; dt _EPROCESS ntdll!_EPROCESS &#43;0x000 Pcb : _KPROCESS &#43;0x06c ProcessLock : _EX_PUSH_LOCK &#43;0x070 CreateTime : _LARGE_INTEGER//进程的创建时间 &#43;0x078 ExitTime : _L"><meta itemprop="datePublished" content="2023-02-18T00:00:00+00:00" />
<meta itemprop="dateModified" content="2023-02-18T00:00:00+00:00" />
<meta itemprop="wordCount" content="16125">
<meta itemprop="keywords" content="Win32," /><meta property="og:title" content="Windows内核(四)——进程线程" />
<meta property="og:description" content="[toc] 进程&amp;线程 滴水中级上 001.进程结构体 每个windows进程在0环都有一个对应的结构体：EPROCESS ，这个结构体包含了进程所有重要的信息。 EPROCESS kd&gt; dt _EPROCESS ntdll!_EPROCESS &#43;0x000 Pcb : _KPROCESS &#43;0x06c ProcessLock : _EX_PUSH_LOCK &#43;0x070 CreateTime : _LARGE_INTEGER//进程的创建时间 &#43;0x078 ExitTime : _L" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://ghostasky.github.io/posts/2023-2-winkernel%E8%BF%9B%E7%A8%8B%E7%BA%BF%E7%A8%8B/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-02-18T00:00:00+00:00" />
<meta property="article:modified_time" content="2023-02-18T00:00:00+00:00" />
<meta name="twitter:card" content="summary"/><meta name="twitter:title" content="Windows内核(四)——进程线程"/>
<meta name="twitter:description" content="[toc] 进程&amp;线程 滴水中级上 001.进程结构体 每个windows进程在0环都有一个对应的结构体：EPROCESS ，这个结构体包含了进程所有重要的信息。 EPROCESS kd&gt; dt _EPROCESS ntdll!_EPROCESS &#43;0x000 Pcb : _KPROCESS &#43;0x06c ProcessLock : _EX_PUSH_LOCK &#43;0x070 CreateTime : _LARGE_INTEGER//进程的创建时间 &#43;0x078 ExitTime : _L"/>
<meta name="application-name" content="FixIt">
<meta name="apple-mobile-web-app-title" content="FixIt"><meta name="theme-color" data-light="#f8f8f8" data-dark="#252627" content="#f8f8f8"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="canonical" href="http://ghostasky.github.io/posts/2023-2-winkernel%E8%BF%9B%E7%A8%8B%E7%BA%BF%E7%A8%8B/" /><link rel="prev" href="http://ghostasky.github.io/posts/%E5%A4%A7%E5%AD%A6%E4%B9%8B%E8%B7%AF/" /><link rel="next" href="http://ghostasky.github.io/posts/2023-2-winkernel%E5%8F%A5%E6%9F%84%E8%A1%A8/" /><link rel="stylesheet" href="/css/style.min.css"><link rel="preload" href="/lib/fontawesome-free/all.min.css" as="style" onload="this.removeAttribute('onload');this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"></noscript><link rel="preload" href="/lib/animate/animate.min.css" as="style" onload="this.removeAttribute('onload');this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="/lib/animate/animate.min.css"></noscript><script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "BlogPosting",
    "headline": "Windows内核(四)——进程线程",
    "inLanguage": "zh-CN",
    "mainEntityOfPage": {
      "@type": "WebPage",
      "@id": "http:\/\/ghostasky.github.io\/posts\/2023-2-winkernel%E8%BF%9B%E7%A8%8B%E7%BA%BF%E7%A8%8B\/"
    },"genre": "posts","keywords": "Win32","wordcount":  16125 ,
    "url": "http:\/\/ghostasky.github.io\/posts\/2023-2-winkernel%E8%BF%9B%E7%A8%8B%E7%BA%BF%E7%A8%8B\/","datePublished": "2023-02-18T00:00:00+00:00","dateModified": "2023-02-18T00:00:00+00:00","publisher": {
      "@type": "Organization",
      "name": ""},"author": {
        "@type": "Person",
        "name": "Ghostasky"
      },"description": ""
  }
  </script></head>
  <body data-header-desktop="auto" data-header-mobile="auto"><script>(window.localStorage?.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('auto' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'auto' === 'dark')) && document.body.setAttribute('data-theme', 'dark');</script><div class="wrapper" data-page-style="normal"><header class="desktop animate__faster" id="header-desktop">
  <div class="header-wrapper">
    <div class="header-title">
      <a href="/" title="Ghostasky&#39;s Blog"><img loading="lazy" src="/images/fixit.png" alt="Ghostasky&#39;s Blog" data-title="Ghostasky&#39;s Blog" width="26" height="26" class="logo" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/><span class="typeit"><template> Ghostasky&#39;s Blog</template></span></a><span class="header-subtitle">未语之痕</span></div>
    <nav>
      <ul class="menu"><li class="menu-item">
              <a
                class="menu-link"
                href="/posts/"
                
                
              >文章</a></li><li class="menu-item">
              <a
                class="menu-link"
                href="/categories/"
                
                
              >分类</a></li><li class="menu-item">
              <a
                class="menu-link"
                href="/tags/"
                
                
              >标签</a></li><li class="menu-item">
              <a
                class="menu-link"
                href="/about/"
                
                
              >关于</a></li><li class="menu-item delimiter"></li><li class="menu-item theme-switch" title="切换主题">
          <i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i>
        </li></ul>
    </nav>
  </div>
</header><header class="mobile animate__faster" id="header-mobile">
  <div class="header-container">
    <div class="header-wrapper">
      <div class="header-title">
        <a href="/" title="Ghostasky&#39;s Blog"><img loading="lazy" src="/images/fixit.png" alt="Ghostasky&#39;s Blog" data-title="Ghostasky&#39;s Blog" width="26" height="26" class="logo" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/><span class="typeit"><template> Ghostasky&#39;s Blog</template></span></a><span class="header-subtitle">未语之痕</span></div>
      <div class="menu-toggle" id="menu-toggle-mobile">
        <span></span><span></span><span></span>
      </div>
    </div>
    <nav>
      <ul class="menu" id="menu-mobile"><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/posts/"
                  
                  
                >文章</a></li><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/categories/"
                  
                  
                >分类</a></li><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/tags/"
                  
                  
                >标签</a></li><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/about/"
                  
                  
                >关于</a></li><li class="menu-item menu-system">
          <span class="menu-system-item theme-switch" title="切换主题"><i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i></span></li>
      </ul>
    </nav>
  </div>
</header><main class="container"><aside class="aside-collection animate__animated animate__fadeIn animate__faster" aria-label="合集"></aside>

  <article class="page single">
    <div class="header"><h1 class="single-title animate__animated animate__flipInX"><span>Windows内核(四)——进程线程</span>
      </h1></div><div class="post-meta">
      <div class="post-meta-line"><span class="post-author"><span class="author"><img loading="lazy" src="/images/fixit.png" alt="Ghostasky" data-title="Ghostasky" width="20" height="20" class="avatar" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/>&nbsp;Ghostasky</span></span><span class="post-included-in">&nbsp;收录于 <a href="/categories/technology/" class="post-category" title="分类 - Technology"><i class="fa-regular fa-folder fa-fw" aria-hidden="true"></i> Technology</a></span></div><div class="post-meta-line"><span title="发布于 2023-02-18 00:00:00"><i class="fa-solid fa-calendar-days fa-fw me-1" aria-hidden="true"></i><time datetime="2023-02-18">2023-02-18</time></span>&nbsp;<span title="16125 字"><i class="fa-solid fa-pencil-alt fa-fw me-1" aria-hidden="true"></i>约 16200 字</span>&nbsp;<span><i class="fa-regular fa-clock fa-fw me-1" aria-hidden="true"></i>预计阅读 33 分钟</span>&nbsp;</div>
    </div><div class="details toc" id="toc-static" data-kept="false">
        <div class="details-summary toc-title">
          <span>目录</span>
          <span><i class="details-icon fa-solid fa-angle-right" aria-hidden="true"></i></span>
        </div>
        <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#001进程结构体">001.进程结构体</a>
      <ul>
        <li><a href="#eprocess">EPROCESS</a></li>
        <li><a href="#kprocess">KPROCESS</a></li>
        <li><a href="#通过进程结构体遍历所有的进程">通过进程结构体遍历所有的进程</a></li>
      </ul>
    </li>
    <li><a href="#002线程结构体">002.线程结构体</a>
      <ul>
        <li><a href="#kthread">KTHREAD</a></li>
        <li><a href="#ethread">ETHREAD</a></li>
      </ul>
    </li>
    <li><a href="#003kpcr">003.KPCR</a>
      <ul>
        <li><a href="#kpcr">KPCR</a></li>
        <li><a href="#nt_tib">NT_TIB</a></li>
        <li><a href="#kprcb">KPRCB</a></li>
      </ul>
    </li>
    <li><a href="#004等待链表_调度链表">004.等待链表_调度链表</a>
      <ul>
        <li><a href="#线程的三种状态等待运行就绪">线程的三种状态：等待，运行，就绪</a></li>
      </ul>
    </li>
    <li><a href="#005模拟线程切换">005.模拟线程切换</a>
      <ul>
        <li><a href="#registergmthread">RegisterGMThread</a></li>
        <li><a href="#initgmthread">InitGMThread</a></li>
        <li><a href="#gmthreadstartup">GMThreadStartup</a></li>
        <li><a href="#scheduling-线程调度函数">Scheduling 线程调度函数</a></li>
        <li><a href="#switchcontext-切换线程函数">SwitchContext 切换线程函数</a></li>
        <li><a href="#总结">总结</a></li>
      </ul>
    </li>
    <li><a href="#006windows线程切换_主动切换">006.Windows线程切换_主动切换</a>
      <ul>
        <li><a href="#分析-kiswapcontext">分析 KiSwapContext</a></li>
        <li><a href="#分析-swapcontext">分析 SwapContext</a></li>
      </ul>
    </li>
    <li><a href="#007windows线程切换_时钟中断切换">007.Windows线程切换_时钟中断切换</a>
      <ul>
        <li><a href="#总结-1">总结</a></li>
      </ul>
    </li>
    <li><a href="#008windows线程切换_时间片管理">008.Windows线程切换_时间片管理</a>
      <ul>
        <li><a href="#cpu时间片">CPU时间片</a></li>
        <li><a href="#总结-2">总结</a></li>
      </ul>
    </li>
    <li><a href="#009windows线程切换_tss">009.Windows线程切换_TSS</a>
      <ul>
        <li><a href="#tss">TSS</a></li>
      </ul>
    </li>
    <li><a href="#010windows线程切换_fs">010.Windows线程切换_FS</a>
      <ul>
        <li></li>
      </ul>
    </li>
    <li><a href="#011windows线程切换_线程优先级">011.Windows线程切换_线程优先级</a>
      <ul>
        <li><a href="#调度链表-1">调度链表</a></li>
        <li><a href="#kiswapthread">KiSwapThread</a></li>
      </ul>
    </li>
    <li><a href="#012进程挂靠">012.进程挂靠</a>
      <ul>
        <li><a href="#进程线程关系">进程线程关系</a></li>
        <li><a href="#分析ntreadvirtualmemory">分析NtReadVirtualMemory</a></li>
        <li><a href="#进程挂靠总结">进程挂靠总结</a></li>
      </ul>
    </li>
    <li><a href="#013跨进程读写内存">013.跨进程读写内存</a>
      <ul>
        <li><a href="#ntreadvirtualmemory跨进程读">NtReadVirtualMemory跨进程读</a></li>
        <li><a href="#ntwritevirtualmemory跨进程写">NtWriteVirtualMemory跨进程写</a></li>
      </ul>
    </li>
  </ul>
</nav></div>
      </div><div class="content" id="content"><p>[toc]</p>
<blockquote>
<p><a href="https://blog.csdn.net/qq_41490873/category_8987386.html"target="_blank" rel="external nofollow noopener noreferrer">进程&amp;线程</a></p>
<p><a href="https://blog.csdn.net/qq_41490873/category_9930822.html"target="_blank" rel="external nofollow noopener noreferrer">滴水中级上</a></p>
</blockquote>
<h2 id="001进程结构体" class="heading-element"><span>001.进程结构体</span>
  <a href="#001%e8%bf%9b%e7%a8%8b%e7%bb%93%e6%9e%84%e4%bd%93" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><p>每个windows进程在0环都有一个对应的结构体：<code>EPROCESS</code> ，这个结构体包含了进程所有重要的信息。</p>
<h3 id="eprocess" class="heading-element"><span>EPROCESS</span>
  <a href="#eprocess" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">kd</span><span class="o">&gt;</span> <span class="n">dt</span> <span class="n">_EPROCESS</span>
</span></span><span class="line"><span class="cl"><span class="n">ntdll</span><span class="o">!</span><span class="n">_EPROCESS</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x000</span> <span class="nl">Pcb</span>              <span class="p">:</span> <span class="n">_KPROCESS</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x06c</span> <span class="nl">ProcessLock</span>      <span class="p">:</span> <span class="n">_EX_PUSH_LOCK</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x070</span> <span class="nl">CreateTime</span>       <span class="p">:</span> <span class="n">_LARGE_INTEGER</span><span class="c1">//进程的创建时间
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="o">+</span><span class="mh">0x078</span> <span class="nl">ExitTime</span>         <span class="p">:</span> <span class="n">_LARGE_INTEGER</span><span class="c1">//进程的退出时间
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="o">+</span><span class="mh">0x080</span> <span class="nl">RundownProtect</span>   <span class="p">:</span> <span class="n">_EX_RUNDOWN_REF</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x084</span> <span class="nl">UniqueProcessId</span>  <span class="p">:</span> <span class="n">Ptr32</span> <span class="n">Void</span><span class="c1">//进程的编号 任务管理器中的PID
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="o">+</span><span class="mh">0x088</span> <span class="nl">ActiveProcessLinks</span> <span class="p">:</span> <span class="n">_LIST_ENTRY</span><span class="c1">//双向链表 所有的活动进程都连接在一起，构成了一个链表
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>										  <span class="c1">//PsActiveProcessHead指向全局链表头，链的位置是0x88的位置
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="o">+</span><span class="mh">0x090</span> <span class="nl">QuotaUsage</span>       <span class="p">:</span> <span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="n">Uint4B</span><span class="c1">//物理页相关的统计信息
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="o">+</span><span class="mh">0x09c</span> <span class="nl">QuotaPeak</span>        <span class="p">:</span> <span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="n">Uint4B</span><span class="c1">//物理页相关的统计信息
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="o">+</span><span class="mh">0x0a8</span> <span class="nl">CommitCharge</span>     <span class="p">:</span> <span class="n">Uint4B</span><span class="c1">//虚拟内存相关的统计信息
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="o">+</span><span class="mh">0x0ac</span> <span class="nl">PeakVirtualSize</span>  <span class="p">:</span> <span class="n">Uint4B</span><span class="c1">//虚拟内存相关的统计信息
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="o">+</span><span class="mh">0x0b0</span> <span class="nl">VirtualSize</span>      <span class="p">:</span> <span class="n">Uint4B</span><span class="c1">//虚拟内存相关的统计信息
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="o">+</span><span class="mh">0x0b4</span> <span class="nl">SessionProcessLinks</span> <span class="p">:</span> <span class="n">_LIST_ENTRY</span><span class="c1">//可以通过这个链表，遍历到所有进程。 这个是无法隐藏的，隐藏了系统无法管理到该进程。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="o">+</span><span class="mh">0x0bc</span> <span class="nl">DebugPort</span>        <span class="p">:</span> <span class="n">Ptr32</span> <span class="n">Void</span><span class="c1">//调试相关
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="o">+</span><span class="mh">0x0c0</span> <span class="nl">ExceptionPort</span>    <span class="p">:</span> <span class="n">Ptr32</span> <span class="n">Void</span><span class="c1">//调试相关
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="o">+</span><span class="mh">0x0c4</span> <span class="nl">ObjectTable</span>      <span class="p">:</span> <span class="n">Ptr32</span> <span class="n">_HANDLE_TABLE</span><span class="c1">//句柄表
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="o">+</span><span class="mh">0x0c8</span> <span class="nl">Token</span>            <span class="p">:</span> <span class="n">_EX_FAST_REF</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x0cc</span> <span class="nl">WorkingSetLock</span>   <span class="p">:</span> <span class="n">_FAST_MUTEX</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x0ec</span> <span class="nl">WorkingSetPage</span>   <span class="p">:</span> <span class="n">Uint4B</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x0f0</span> <span class="nl">AddressCreationLock</span> <span class="p">:</span> <span class="n">_FAST_MUTEX</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x110</span> <span class="nl">HyperSpaceLock</span>   <span class="p">:</span> <span class="n">Uint4B</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x114</span> <span class="nl">ForkInProgress</span>   <span class="p">:</span> <span class="n">Ptr32</span> <span class="n">_ETHREAD</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x118</span> <span class="nl">HardwareTrigger</span>  <span class="p">:</span> <span class="n">Uint4B</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x11c</span> <span class="nl">VadRoot</span>          <span class="p">:</span> <span class="n">Ptr32</span> <span class="n">Void</span><span class="c1">//标识0-2G哪些地址没占用了
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="o">+</span><span class="mh">0x120</span> <span class="nl">VadHint</span>          <span class="p">:</span> <span class="n">Ptr32</span> <span class="n">Void</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x124</span> <span class="nl">CloneRoot</span>        <span class="p">:</span> <span class="n">Ptr32</span> <span class="n">Void</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x128</span> <span class="nl">NumberOfPrivatePages</span> <span class="p">:</span> <span class="n">Uint4B</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x12c</span> <span class="nl">NumberOfLockedPages</span> <span class="p">:</span> <span class="n">Uint4B</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x130</span> <span class="nl">Win32Process</span>     <span class="p">:</span> <span class="n">Ptr32</span> <span class="n">Void</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x134</span> <span class="nl">Job</span>              <span class="p">:</span> <span class="n">Ptr32</span> <span class="n">_EJOB</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x138</span> <span class="nl">SectionObject</span>    <span class="p">:</span> <span class="n">Ptr32</span> <span class="n">Void</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x13c</span> <span class="nl">SectionBaseAddress</span> <span class="p">:</span> <span class="n">Ptr32</span> <span class="n">Void</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x140</span> <span class="nl">QuotaBlock</span>       <span class="p">:</span> <span class="n">Ptr32</span> <span class="n">_EPROCESS_QUOTA_BLOCK</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x144</span> <span class="nl">WorkingSetWatch</span>  <span class="p">:</span> <span class="n">Ptr32</span> <span class="n">_PAGEFAULT_HISTORY</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x148</span> <span class="nl">Win32WindowStation</span> <span class="p">:</span> <span class="n">Ptr32</span> <span class="n">Void</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x14c</span> <span class="nl">InheritedFromUniqueProcessId</span> <span class="p">:</span> <span class="n">Ptr32</span> <span class="n">Void</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x150</span> <span class="nl">LdtInformation</span>   <span class="p">:</span> <span class="n">Ptr32</span> <span class="n">Void</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x154</span> <span class="nl">VadFreeHint</span>      <span class="p">:</span> <span class="n">Ptr32</span> <span class="n">Void</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x158</span> <span class="nl">VdmObjects</span>       <span class="p">:</span> <span class="n">Ptr32</span> <span class="n">Void</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x15c</span> <span class="nl">DeviceMap</span>        <span class="p">:</span> <span class="n">Ptr32</span> <span class="n">Void</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x160</span> <span class="nl">PhysicalVadList</span>  <span class="p">:</span> <span class="n">_LIST_ENTRY</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x168</span> <span class="nl">PageDirectoryPte</span> <span class="p">:</span> <span class="n">_HARDWARE_PTE_X86</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x168</span> <span class="nl">Filler</span>           <span class="p">:</span> <span class="n">Uint8B</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x170</span> <span class="nl">Session</span>          <span class="p">:</span> <span class="n">Ptr32</span> <span class="n">Void</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x174</span> <span class="nl">ImageFileName</span>    <span class="p">:</span> <span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="n">UChar</span><span class="c1">//进程镜像文件名 最多16个字节
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="o">+</span><span class="mh">0x184</span> <span class="nl">JobLinks</span>         <span class="p">:</span> <span class="n">_LIST_ENTRY</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x18c</span> <span class="nl">LockedPagesList</span>  <span class="p">:</span> <span class="n">Ptr32</span> <span class="n">Void</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x190</span> <span class="nl">ThreadListHead</span>   <span class="p">:</span> <span class="n">_LIST_ENTRY</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x198</span> <span class="nl">SecurityPort</span>     <span class="p">:</span> <span class="n">Ptr32</span> <span class="n">Void</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x19c</span> <span class="nl">PaeTop</span>           <span class="p">:</span> <span class="n">Ptr32</span> <span class="n">Void</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x1a0</span> <span class="nl">ActiveThreads</span>    <span class="p">:</span> <span class="n">Uint4B</span><span class="c1">//活动线程的数量
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="o">+</span><span class="mh">0x1a4</span> <span class="nl">GrantedAccess</span>    <span class="p">:</span> <span class="n">Uint4B</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x1a8</span> <span class="nl">DefaultHardErrorProcessing</span> <span class="p">:</span> <span class="n">Uint4B</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x1ac</span> <span class="nl">LastThreadExitStatus</span> <span class="p">:</span> <span class="n">Int4B</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x1b0</span> <span class="nl">Peb</span>              <span class="p">:</span> <span class="n">Ptr32</span> <span class="n">_PEB</span><span class="c1">//PEB((Process Environment Block 进程环境块)：进程在3环的一个结构体，里面包含了进程的模块列表、是否处于调试状态等信息。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="o">+</span><span class="mh">0x1b4</span> <span class="nl">PrefetchTrace</span>    <span class="p">:</span> <span class="n">_EX_FAST_REF</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x1b8</span> <span class="nl">ReadOperationCount</span> <span class="p">:</span> <span class="n">_LARGE_INTEGER</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x1c0</span> <span class="nl">WriteOperationCount</span> <span class="p">:</span> <span class="n">_LARGE_INTEGER</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x1c8</span> <span class="nl">OtherOperationCount</span> <span class="p">:</span> <span class="n">_LARGE_INTEGER</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x1d0</span> <span class="nl">ReadTransferCount</span> <span class="p">:</span> <span class="n">_LARGE_INTEGER</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x1d8</span> <span class="nl">WriteTransferCount</span> <span class="p">:</span> <span class="n">_LARGE_INTEGER</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x1e0</span> <span class="nl">OtherTransferCount</span> <span class="p">:</span> <span class="n">_LARGE_INTEGER</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x1e8</span> <span class="nl">CommitChargeLimit</span> <span class="p">:</span> <span class="n">Uint4B</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x1ec</span> <span class="nl">CommitChargePeak</span> <span class="p">:</span> <span class="n">Uint4B</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x1f0</span> <span class="nl">AweInfo</span>          <span class="p">:</span> <span class="n">Ptr32</span> <span class="n">Void</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x1f4</span> <span class="nl">SeAuditProcessCreationInfo</span> <span class="p">:</span> <span class="n">_SE_AUDIT_PROCESS_CREATION_INFO</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x1f8</span> <span class="nl">Vm</span>               <span class="p">:</span> <span class="n">_MMSUPPORT</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x238</span> <span class="nl">LastFaultCount</span>   <span class="p">:</span> <span class="n">Uint4B</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x23c</span> <span class="nl">ModifiedPageCount</span> <span class="p">:</span> <span class="n">Uint4B</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x240</span> <span class="nl">NumberOfVads</span>     <span class="p">:</span> <span class="n">Uint4B</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x244</span> <span class="nl">JobStatus</span>        <span class="p">:</span> <span class="n">Uint4B</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x248</span> <span class="nl">Flags</span>            <span class="p">:</span> <span class="n">Uint4B</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x248</span> <span class="nl">CreateReported</span>   <span class="p">:</span> <span class="n">Pos</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span> <span class="n">Bit</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x248</span> <span class="nl">NoDebugInherit</span>   <span class="p">:</span> <span class="n">Pos</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="n">Bit</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x248</span> <span class="nl">ProcessExiting</span>   <span class="p">:</span> <span class="n">Pos</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span> <span class="n">Bit</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x248</span> <span class="nl">ProcessDelete</span>    <span class="p">:</span> <span class="n">Pos</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span> <span class="n">Bit</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x248</span> <span class="nl">Wow64SplitPages</span>  <span class="p">:</span> <span class="n">Pos</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span> <span class="n">Bit</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x248</span> <span class="nl">VmDeleted</span>        <span class="p">:</span> <span class="n">Pos</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">1</span> <span class="n">Bit</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x248</span> <span class="nl">OutswapEnabled</span>   <span class="p">:</span> <span class="n">Pos</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">1</span> <span class="n">Bit</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x248</span> <span class="nl">Outswapped</span>       <span class="p">:</span> <span class="n">Pos</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">1</span> <span class="n">Bit</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x248</span> <span class="nl">ForkFailed</span>       <span class="p">:</span> <span class="n">Pos</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">1</span> <span class="n">Bit</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x248</span> <span class="nl">HasPhysicalVad</span>   <span class="p">:</span> <span class="n">Pos</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">1</span> <span class="n">Bit</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x248</span> <span class="nl">AddressSpaceInitialized</span> <span class="p">:</span> <span class="n">Pos</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">2</span> <span class="n">Bits</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x248</span> <span class="nl">SetTimerResolution</span> <span class="p">:</span> <span class="n">Pos</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">1</span> <span class="n">Bit</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x248</span> <span class="nl">BreakOnTermination</span> <span class="p">:</span> <span class="n">Pos</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">1</span> <span class="n">Bit</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x248</span> <span class="nl">SessionCreationUnderway</span> <span class="p">:</span> <span class="n">Pos</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">1</span> <span class="n">Bit</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x248</span> <span class="nl">WriteWatch</span>       <span class="p">:</span> <span class="n">Pos</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">1</span> <span class="n">Bit</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x248</span> <span class="nl">ProcessInSession</span> <span class="p">:</span> <span class="n">Pos</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">1</span> <span class="n">Bit</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x248</span> <span class="nl">OverrideAddressSpace</span> <span class="p">:</span> <span class="n">Pos</span> <span class="mi">17</span><span class="p">,</span> <span class="mi">1</span> <span class="n">Bit</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x248</span> <span class="nl">HasAddressSpace</span>  <span class="p">:</span> <span class="n">Pos</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">1</span> <span class="n">Bit</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x248</span> <span class="nl">LaunchPrefetched</span> <span class="p">:</span> <span class="n">Pos</span> <span class="mi">19</span><span class="p">,</span> <span class="mi">1</span> <span class="n">Bit</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x248</span> <span class="nl">InjectInpageErrors</span> <span class="p">:</span> <span class="n">Pos</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">1</span> <span class="n">Bit</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x248</span> <span class="nl">VmTopDown</span>        <span class="p">:</span> <span class="n">Pos</span> <span class="mi">21</span><span class="p">,</span> <span class="mi">1</span> <span class="n">Bit</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x248</span> <span class="nl">Unused3</span>          <span class="p">:</span> <span class="n">Pos</span> <span class="mi">22</span><span class="p">,</span> <span class="mi">1</span> <span class="n">Bit</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x248</span> <span class="nl">Unused4</span>          <span class="p">:</span> <span class="n">Pos</span> <span class="mi">23</span><span class="p">,</span> <span class="mi">1</span> <span class="n">Bit</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x248</span> <span class="nl">VdmAllowed</span>       <span class="p">:</span> <span class="n">Pos</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">1</span> <span class="n">Bit</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x248</span> <span class="nl">Unused</span>           <span class="p">:</span> <span class="n">Pos</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">5</span> <span class="n">Bits</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x248</span> <span class="nl">Unused1</span>          <span class="p">:</span> <span class="n">Pos</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">1</span> <span class="n">Bit</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x248</span> <span class="nl">Unused2</span>          <span class="p">:</span> <span class="n">Pos</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">1</span> <span class="n">Bit</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x24c</span> <span class="nl">ExitStatus</span>       <span class="p">:</span> <span class="n">Int4B</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x250</span> <span class="nl">NextPageColor</span>    <span class="p">:</span> <span class="n">Uint2B</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x252</span> <span class="nl">SubSystemMinorVersion</span> <span class="p">:</span> <span class="n">UChar</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x253</span> <span class="nl">SubSystemMajorVersion</span> <span class="p">:</span> <span class="n">UChar</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x252</span> <span class="nl">SubSystemVersion</span> <span class="p">:</span> <span class="n">Uint2B</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x254</span> <span class="nl">PriorityClass</span>    <span class="p">:</span> <span class="n">UChar</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x255</span> <span class="nl">WorkingSetAcquiredUnsafe</span> <span class="p">:</span> <span class="n">UChar</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x258</span> <span class="nl">Cookie</span>           <span class="p">:</span> <span class="n">Uint4B</span></span></span></code></pre></div><h3 id="kprocess" class="heading-element"><span>KPROCESS</span>
  <a href="#kprocess" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">kd</span><span class="o">&gt;</span> <span class="n">dt</span> <span class="n">_KPROCESS</span>
</span></span><span class="line"><span class="cl"><span class="n">ntdll</span><span class="o">!</span><span class="n">_KPROCESS</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x000</span> <span class="nl">Header</span>           <span class="p">:</span> <span class="n">_DISPATCHER_HEADER</span> <span class="c1">//&#34;可等待对象&#34;，有这个成员就可以被WaitForSingleObject等待
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="o">+</span><span class="mh">0x010</span> <span class="nl">ProfileListHead</span>  <span class="p">:</span> <span class="n">_LIST_ENTRY</span> <span class="c1">//性能分析
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="o">+</span><span class="mh">0x018</span> <span class="nl">DirectoryTableBase</span> <span class="p">:</span> <span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="n">Uint4B</span><span class="c1">//页目录表基址，DirectoryTableBase[0] cr3 DirectoryTableBase[1] 超过4GE后的cr3
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="o">+</span><span class="mh">0x020</span> <span class="nl">LdtDescriptor</span>    <span class="p">:</span> <span class="n">_KGDTENTRY</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x028</span> <span class="nl">Int21Descriptor</span>  <span class="p">:</span> <span class="n">_KIDTENTRY</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x030</span> <span class="nl">IopmOffset</span>       <span class="p">:</span> <span class="n">Uint2B</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x032</span> <span class="nl">Iopl</span>             <span class="p">:</span> <span class="n">UChar</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x033</span> <span class="nl">Unused</span>           <span class="p">:</span> <span class="n">UChar</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x034</span> <span class="nl">ActiveProcessors</span> <span class="p">:</span> <span class="n">Uint4B</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x038</span> <span class="nl">KernelTime</span>       <span class="p">:</span> <span class="n">Uint4B</span><span class="c1">//记录一个进程在内核模式下花的时间
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="o">+</span><span class="mh">0x03c</span> <span class="nl">UserTime</span>         <span class="p">:</span> <span class="n">Uint4B</span><span class="c1">//记录一个进程在用户模式下花的时间
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="o">+</span><span class="mh">0x040</span> <span class="nl">ReadyListHead</span>    <span class="p">:</span> <span class="n">_LIST_ENTRY</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x048</span> <span class="nl">SwapListEntry</span>    <span class="p">:</span> <span class="n">_SINGLE_LIST_ENTRY</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x04c</span> <span class="nl">VdmTrapcHandler</span>  <span class="p">:</span> <span class="n">Ptr32</span> <span class="n">Void</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x050</span> <span class="nl">ThreadListHead</span>   <span class="p">:</span> <span class="n">_LIST_ENTRY</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x058</span> <span class="nl">ProcessLock</span>      <span class="p">:</span> <span class="n">Uint4B</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x05c</span> <span class="nl">Affinity</span>         <span class="p">:</span> <span class="n">Uint4B</span><span class="c1">//指定哪一个CPU来运行这个进程
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//如果值为1，那这个进程的所以线程只能在0号CPU上跑(00000001)				
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//如果值为3，那这个进程的所以线程能在0、1号CPU上跑(000000011)	
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//如果值为4，那这个进程的所以线程能在2号CPU上跑(000000100)	
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//如果值为5，那这个进程的所以线程能在0，2号CPU上跑(000000101)	
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//4个字节共32位  所以最多32核 Windows64位 就64核			
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//如果只有一个CPU 把这个设置为4 那么这个进程就死了
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="o">+</span><span class="mh">0x060</span> <span class="nl">StackCount</span>       <span class="p">:</span> <span class="n">Uint2B</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x062</span> <span class="nl">BasePriority</span>     <span class="p">:</span> <span class="n">Char</span><span class="c1">//基础优先级或最低优先级，该进程中的所有线程最起码的优先级
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="o">+</span><span class="mh">0x063</span> <span class="nl">ThreadQuantum</span>    <span class="p">:</span> <span class="n">Char</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x064</span> <span class="nl">AutoAlignment</span>    <span class="p">:</span> <span class="n">UChar</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x065</span> <span class="nl">State</span>            <span class="p">:</span> <span class="n">UChar</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x066</span> <span class="nl">ThreadSeed</span>       <span class="p">:</span> <span class="n">UChar</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x067</span> <span class="nl">DisableBoost</span>     <span class="p">:</span> <span class="n">UChar</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x068</span> <span class="nl">PowerState</span>       <span class="p">:</span> <span class="n">UChar</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x069</span> <span class="nl">DisableQuantum</span>   <span class="p">:</span> <span class="n">UChar</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x06a</span> <span class="nl">IdealNode</span>        <span class="p">:</span> <span class="n">UChar</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x06b</span> <span class="nl">Flags</span>            <span class="p">:</span> <span class="n">_KEXECUTE_OPTIONS</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x06b</span> <span class="nl">ExecuteOptions</span>   <span class="p">:</span> <span class="n">UChar</span></span></span></code></pre></div><h3 id="通过进程结构体遍历所有的进程" class="heading-element"><span>通过进程结构体遍历所有的进程</span>
  <a href="#%e9%80%9a%e8%bf%87%e8%bf%9b%e7%a8%8b%e7%bb%93%e6%9e%84%e4%bd%93%e9%81%8d%e5%8e%86%e6%89%80%e6%9c%89%e7%9a%84%e8%bf%9b%e7%a8%8b" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl">	<span class="n">ULONG</span> <span class="n">ProcessListHead</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">PLIST_ENTRY</span> <span class="n">pListHead</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">PLIST_ENTRY</span> <span class="n">pListNext</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="kr">__asm</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">		<span class="n">mov</span> <span class="n">eax</span><span class="p">,</span><span class="nl">fs</span><span class="p">:</span><span class="mi">124</span><span class="n">h</span>
</span></span><span class="line"><span class="cl">		<span class="n">mov</span> <span class="n">ebx</span><span class="p">,[</span><span class="n">eax</span><span class="o">+</span><span class="mi">220</span><span class="n">h</span><span class="p">]</span>  <span class="c1">//得到线程结构体
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="n">mov</span> <span class="n">ProcessListHead</span><span class="p">,</span><span class="n">ebx</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">pListHead</span><span class="o">=</span><span class="p">(</span><span class="n">PLIST_ENTRY</span><span class="p">)(</span><span class="n">ProcessListHead</span><span class="o">+</span><span class="mh">0x88</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">pListNext</span><span class="o">=</span><span class="n">pListHead</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="k">do</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">		<span class="nf">DbgPrint</span><span class="p">(</span><span class="s">&#34;ImageFileName=%s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,(</span><span class="n">PULONG</span><span class="p">)</span><span class="n">pListNext</span><span class="o">-</span><span class="mh">0x88</span><span class="o">/</span><span class="mi">4</span><span class="o">+</span><span class="mh">0x174</span><span class="o">/</span><span class="mi">4</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		
</span></span><span class="line"><span class="cl">		<span class="n">pListNext</span><span class="o">=</span><span class="n">pListNext</span><span class="o">-&gt;</span><span class="n">Flink</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span><span class="k">while</span><span class="p">(</span><span class="n">pListHead</span><span class="o">!=</span><span class="n">pListNext</span><span class="p">);</span></span></span></code></pre></div><h2 id="002线程结构体" class="heading-element"><span>002.线程结构体</span>
  <a href="#002%e7%ba%bf%e7%a8%8b%e7%bb%93%e6%9e%84%e4%bd%93" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><p>每个windows线程在0环都有一个对应的结构体：ETHREAD  这个结构体包含了线程所有重要的信息。</p>
<h3 id="kthread" class="heading-element"><span>KTHREAD</span>
  <a href="#kthread" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">kd</span><span class="o">&gt;</span> <span class="n">dt</span> <span class="n">_KTHREAD</span>
</span></span><span class="line"><span class="cl"><span class="n">ntdll</span><span class="o">!</span><span class="n">_KTHREAD</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x000</span> <span class="nl">Header</span>           <span class="p">:</span> <span class="n">_DISPATCHER_HEADER</span><span class="c1">//可等待对象
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="o">+</span><span class="mh">0x010</span> <span class="nl">MutantListHead</span>   <span class="p">:</span> <span class="n">_LIST_ENTRY</span><span class="c1">//互斥体对象链表
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="o">+</span><span class="mh">0x018</span> <span class="nl">InitialStack</span>     <span class="p">:</span> <span class="n">Ptr32</span> <span class="n">Void</span><span class="c1">//线程切换相关
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="o">+</span><span class="mh">0x01c</span> <span class="nl">StackLimit</span>       <span class="p">:</span> <span class="n">Ptr32</span> <span class="n">Void</span><span class="c1">//线程切换相关
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="o">+</span><span class="mh">0x020</span> <span class="nl">Teb</span>              <span class="p">:</span> <span class="n">Ptr32</span> <span class="n">Void</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//TEB，Thread Environment Block，线程环境块。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//大小4KB,位于用户地址空间。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//FS:[0] -&gt; TEB(3环时  0环时FS执行KPCR)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x024</span> <span class="nl">TlsArray</span>         <span class="p">:</span> <span class="n">Ptr32</span> <span class="n">Void</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x028</span> <span class="nl">KernelStack</span>      <span class="p">:</span> <span class="n">Ptr32</span> <span class="n">Void</span><span class="c1">//线程切换相关
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="o">+</span><span class="mh">0x02c</span> <span class="nl">DebugActive</span>      <span class="p">:</span> <span class="n">UChar</span><span class="c1">//如果值为-1 不能使用调试寄存器：Dr0 - Dr7
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="o">+</span><span class="mh">0x02d</span> <span class="nl">State</span>            <span class="p">:</span> <span class="n">UChar</span><span class="c1">//线程状态：就绪、等待还是运行
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="o">+</span><span class="mh">0x02e</span> <span class="nl">Alerted</span>          <span class="p">:</span> <span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="n">UChar</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x030</span> <span class="nl">Iopl</span>             <span class="p">:</span> <span class="n">UChar</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x031</span> <span class="nl">NpxState</span>         <span class="p">:</span> <span class="n">UChar</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x032</span> <span class="nl">Saturation</span>       <span class="p">:</span> <span class="n">Char</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x033</span> <span class="nl">Priority</span>         <span class="p">:</span> <span class="n">Char</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x034</span> <span class="nl">ApcState</span>         <span class="p">:</span> <span class="n">_KAPC_STATE</span><span class="c1">//APC相关
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="o">+</span><span class="mh">0x04c</span> <span class="nl">ContextSwitches</span>  <span class="p">:</span> <span class="n">Uint4B</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x050</span> <span class="nl">IdleSwapBlock</span>    <span class="p">:</span> <span class="n">UChar</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x051</span> <span class="nl">Spare0</span>           <span class="p">:</span> <span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="n">UChar</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x054</span> <span class="nl">WaitStatus</span>       <span class="p">:</span> <span class="n">Int4B</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x058</span> <span class="nl">WaitIrql</span>         <span class="p">:</span> <span class="n">UChar</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x059</span> <span class="nl">WaitMode</span>         <span class="p">:</span> <span class="n">Char</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x05a</span> <span class="nl">WaitNext</span>         <span class="p">:</span> <span class="n">UChar</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x05b</span> <span class="nl">WaitReason</span>       <span class="p">:</span> <span class="n">UChar</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x05c</span> <span class="nl">WaitBlockList</span>    <span class="p">:</span> <span class="n">Ptr32</span> <span class="n">_KWAIT_BLOCK</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x060</span> <span class="nl">WaitListEntry</span>    <span class="p">:</span> <span class="n">_LIST_ENTRY</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x060</span> <span class="nl">SwapListEntry</span>    <span class="p">:</span> <span class="n">_SINGLE_LIST_ENTRY</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x068</span> <span class="nl">WaitTime</span>         <span class="p">:</span> <span class="n">Uint4B</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x06c</span> <span class="nl">BasePriority</span>     <span class="p">:</span> <span class="n">Char</span><span class="c1">//其初始值是所属进程的BasePriority值(KPROCESS-&gt;BasePriority)，以后可以通过KeSetBasePriorityThread()函数重新设定
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="o">+</span><span class="mh">0x06d</span> <span class="nl">DecrementCount</span>   <span class="p">:</span> <span class="n">UChar</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x06e</span> <span class="nl">PriorityDecrement</span> <span class="p">:</span> <span class="n">Char</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x06f</span> <span class="nl">Quantum</span>          <span class="p">:</span> <span class="n">Char</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x070</span> <span class="nl">WaitBlock</span>        <span class="p">:</span> <span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="n">_KWAIT_BLOCK</span><span class="c1">//等待哪个对象（WaitForSingleObject）
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="o">+</span><span class="mh">0x0d0</span> <span class="nl">LegoData</span>         <span class="p">:</span> <span class="n">Ptr32</span> <span class="n">Void</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x0d4</span> <span class="nl">KernelApcDisable</span> <span class="p">:</span> <span class="n">Uint4B</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x0d8</span> <span class="nl">UserAffinity</span>     <span class="p">:</span> <span class="n">Uint4B</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x0dc</span> <span class="nl">SystemAffinityActive</span> <span class="p">:</span> <span class="n">UChar</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x0dd</span> <span class="nl">PowerState</span>       <span class="p">:</span> <span class="n">UChar</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x0de</span> <span class="nl">NpxIrql</span>          <span class="p">:</span> <span class="n">UChar</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x0df</span> <span class="nl">InitialNode</span>      <span class="p">:</span> <span class="n">UChar</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x0e0</span> <span class="nl">ServiceTable</span>     <span class="p">:</span> <span class="n">Ptr32</span> <span class="n">Void</span><span class="c1">//指向系统服务表基址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="o">+</span><span class="mh">0x0e4</span> <span class="nl">Queue</span>            <span class="p">:</span> <span class="n">Ptr32</span> <span class="n">_KQUEUE</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x0e8</span> <span class="nl">ApcQueueLock</span>     <span class="p">:</span> <span class="n">Uint4B</span><span class="c1">//APC相关
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="o">+</span><span class="mh">0x0f0</span> <span class="nl">Timer</span>            <span class="p">:</span> <span class="n">_KTIMER</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x118</span> <span class="nl">QueueListEntry</span>   <span class="p">:</span> <span class="n">_LIST_ENTRY</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x120</span> <span class="nl">SoftAffinity</span>     <span class="p">:</span> <span class="n">Uint4B</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x124</span> <span class="nl">Affinity</span>         <span class="p">:</span> <span class="n">Uint4B</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x128</span> <span class="nl">Preempted</span>        <span class="p">:</span> <span class="n">UChar</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x129</span> <span class="nl">ProcessReadyQueue</span> <span class="p">:</span> <span class="n">UChar</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x12a</span> <span class="nl">KernelStackResident</span> <span class="p">:</span> <span class="n">UChar</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x12b</span> <span class="nl">NextProcessor</span>    <span class="p">:</span> <span class="n">UChar</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x12c</span> <span class="nl">CallbackStack</span>    <span class="p">:</span> <span class="n">Ptr32</span> <span class="n">Void</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x130</span> <span class="nl">Win32Thread</span>      <span class="p">:</span> <span class="n">Ptr32</span> <span class="n">Void</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x134</span> <span class="nl">TrapFrame</span>        <span class="p">:</span> <span class="n">Ptr32</span> <span class="n">_KTRAP_FRAME</span><span class="c1">//进0环时保存环境
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="o">+</span><span class="mh">0x138</span> <span class="nl">ApcStatePointer</span>  <span class="p">:</span> <span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="n">Ptr32</span> <span class="n">_KAPC_STATE</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x140</span> <span class="nl">PreviousMode</span>     <span class="p">:</span> <span class="n">Char</span><span class="c1">//某些内核函数会判断程序是0环调用还是3环调用的
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="o">+</span><span class="mh">0x141</span> <span class="nl">EnableStackSwap</span>  <span class="p">:</span> <span class="n">UChar</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x142</span> <span class="nl">LargeStack</span>       <span class="p">:</span> <span class="n">UChar</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x143</span> <span class="nl">ResourceIndex</span>    <span class="p">:</span> <span class="n">UChar</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x144</span> <span class="nl">KernelTime</span>       <span class="p">:</span> <span class="n">Uint4B</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x148</span> <span class="nl">UserTime</span>         <span class="p">:</span> <span class="n">Uint4B</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x14c</span> <span class="nl">SavedApcState</span>    <span class="p">:</span> <span class="n">_KAPC_STATE</span><span class="c1">//APC相关
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="o">+</span><span class="mh">0x164</span> <span class="nl">Alertable</span>        <span class="p">:</span> <span class="n">UChar</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x165</span> <span class="nl">ApcStateIndex</span>    <span class="p">:</span> <span class="n">UChar</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x166</span> <span class="nl">ApcQueueable</span>     <span class="p">:</span> <span class="n">UChar</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x167</span> <span class="nl">AutoAlignment</span>    <span class="p">:</span> <span class="n">UChar</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x168</span> <span class="nl">StackBase</span>        <span class="p">:</span> <span class="n">Ptr32</span> <span class="n">Void</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x16c</span> <span class="nl">SuspendApc</span>       <span class="p">:</span> <span class="n">_KAPC</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x19c</span> <span class="nl">SuspendSemaphore</span> <span class="p">:</span> <span class="n">_KSEMAPHORE</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x1b0</span> <span class="nl">ThreadListEntry</span>  <span class="p">:</span> <span class="n">_LIST_ENTRY</span><span class="c1">//双向链表，一个进程所有的线程都挂在一个链表中，挂的就是这个位置（这是第一个）
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="o">+</span><span class="mh">0x1b8</span> <span class="nl">FreezeCount</span>      <span class="p">:</span> <span class="n">Char</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x1b9</span> <span class="nl">SuspendCount</span>     <span class="p">:</span> <span class="n">Char</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x1ba</span> <span class="nl">IdealProcessor</span>   <span class="p">:</span> <span class="n">UChar</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x1bb</span> <span class="nl">DisableBoost</span>     <span class="p">:</span> <span class="n">UChar</span></span></span></code></pre></div><h3 id="ethread" class="heading-element"><span>ETHREAD</span>
  <a href="#ethread" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">kd</span><span class="o">&gt;</span> <span class="n">dt</span> <span class="n">_ETHREAD</span>
</span></span><span class="line"><span class="cl"><span class="n">ntdll</span><span class="o">!</span><span class="n">_ETHREAD</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x000</span> <span class="nl">Tcb</span>              <span class="p">:</span> <span class="n">_KTHREAD</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x1c0</span> <span class="nl">CreateTime</span>       <span class="p">:</span> <span class="n">_LARGE_INTEGER</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x1c0</span> <span class="nl">NestedFaultCount</span> <span class="p">:</span> <span class="n">Pos</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span> <span class="n">Bits</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x1c0</span> <span class="nl">ApcNeeded</span>        <span class="p">:</span> <span class="n">Pos</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span> <span class="n">Bit</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x1c8</span> <span class="nl">ExitTime</span>         <span class="p">:</span> <span class="n">_LARGE_INTEGER</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x1c8</span> <span class="nl">LpcReplyChain</span>    <span class="p">:</span> <span class="n">_LIST_ENTRY</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x1c8</span> <span class="nl">KeyedWaitChain</span>   <span class="p">:</span> <span class="n">_LIST_ENTRY</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x1d0</span> <span class="nl">ExitStatus</span>       <span class="p">:</span> <span class="n">Int4B</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x1d0</span> <span class="nl">OfsChain</span>         <span class="p">:</span> <span class="n">Ptr32</span> <span class="n">Void</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x1d4</span> <span class="nl">PostBlockList</span>    <span class="p">:</span> <span class="n">_LIST_ENTRY</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x1dc</span> <span class="nl">TerminationPort</span>  <span class="p">:</span> <span class="n">Ptr32</span> <span class="n">_TERMINATION_PORT</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x1dc</span> <span class="nl">ReaperLink</span>       <span class="p">:</span> <span class="n">Ptr32</span> <span class="n">_ETHREAD</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x1dc</span> <span class="nl">KeyedWaitValue</span>   <span class="p">:</span> <span class="n">Ptr32</span> <span class="n">Void</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x1e0</span> <span class="nl">ActiveTimerListLock</span> <span class="p">:</span> <span class="n">Uint4B</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x1e4</span> <span class="nl">ActiveTimerListHead</span> <span class="p">:</span> <span class="n">_LIST_ENTRY</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x1ec</span> <span class="nl">Cid</span>              <span class="p">:</span> <span class="n">_CLIENT_ID</span><span class="c1">//进程ID、线程ID
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="o">+</span><span class="mh">0x1f4</span> <span class="nl">LpcReplySemaphore</span> <span class="p">:</span> <span class="n">_KSEMAPHORE</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x1f4</span> <span class="nl">KeyedWaitSemaphore</span> <span class="p">:</span> <span class="n">_KSEMAPHORE</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x208</span> <span class="nl">LpcReplyMessage</span>  <span class="p">:</span> <span class="n">Ptr32</span> <span class="n">Void</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x208</span> <span class="nl">LpcWaitingOnPort</span> <span class="p">:</span> <span class="n">Ptr32</span> <span class="n">Void</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x20c</span> <span class="nl">ImpersonationInfo</span> <span class="p">:</span> <span class="n">Ptr32</span> <span class="n">_PS_IMPERSONATION_INFORMATION</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x210</span> <span class="nl">IrpList</span>          <span class="p">:</span> <span class="n">_LIST_ENTRY</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x218</span> <span class="nl">TopLevelIrp</span>      <span class="p">:</span> <span class="n">Uint4B</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x21c</span> <span class="nl">DeviceToVerify</span>   <span class="p">:</span> <span class="n">Ptr32</span> <span class="n">_DEVICE_OBJECT</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x220</span> <span class="nl">ThreadsProcess</span>   <span class="p">:</span> <span class="n">Ptr32</span> <span class="n">_EPROCESS</span><span class="c1">//指向自己所属进程
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="o">+</span><span class="mh">0x224</span> <span class="nl">StartAddress</span>     <span class="p">:</span> <span class="n">Ptr32</span> <span class="n">Void</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x228</span> <span class="nl">Win32StartAddress</span> <span class="p">:</span> <span class="n">Ptr32</span> <span class="n">Void</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x228</span> <span class="nl">LpcReceivedMessageId</span> <span class="p">:</span> <span class="n">Uint4B</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x22c</span> <span class="nl">ThreadListEntry</span>  <span class="p">:</span> <span class="n">_LIST_ENTRY</span><span class="c1">//双向链表 一个进程所有的线程 都挂在一个链表中 挂的就是这个位置（这是第二个）
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="o">+</span><span class="mh">0x234</span> <span class="nl">RundownProtect</span>   <span class="p">:</span> <span class="n">_EX_RUNDOWN_REF</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x238</span> <span class="nl">ThreadLock</span>       <span class="p">:</span> <span class="n">_EX_PUSH_LOCK</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x23c</span> <span class="nl">LpcReplyMessageId</span> <span class="p">:</span> <span class="n">Uint4B</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x240</span> <span class="nl">ReadClusterSize</span>  <span class="p">:</span> <span class="n">Uint4B</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x244</span> <span class="nl">GrantedAccess</span>    <span class="p">:</span> <span class="n">Uint4B</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x248</span> <span class="nl">CrossThreadFlags</span> <span class="p">:</span> <span class="n">Uint4B</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x248</span> <span class="nl">Terminated</span>       <span class="p">:</span> <span class="n">Pos</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span> <span class="n">Bit</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x248</span> <span class="nl">DeadThread</span>       <span class="p">:</span> <span class="n">Pos</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="n">Bit</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x248</span> <span class="nl">HideFromDebugger</span> <span class="p">:</span> <span class="n">Pos</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span> <span class="n">Bit</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x248</span> <span class="nl">ActiveImpersonationInfo</span> <span class="p">:</span> <span class="n">Pos</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span> <span class="n">Bit</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x248</span> <span class="nl">SystemThread</span>     <span class="p">:</span> <span class="n">Pos</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span> <span class="n">Bit</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x248</span> <span class="nl">HardErrorsAreDisabled</span> <span class="p">:</span> <span class="n">Pos</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">1</span> <span class="n">Bit</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x248</span> <span class="nl">BreakOnTermination</span> <span class="p">:</span> <span class="n">Pos</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">1</span> <span class="n">Bit</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x248</span> <span class="nl">SkipCreationMsg</span>  <span class="p">:</span> <span class="n">Pos</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">1</span> <span class="n">Bit</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x248</span> <span class="nl">SkipTerminationMsg</span> <span class="p">:</span> <span class="n">Pos</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">1</span> <span class="n">Bit</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x24c</span> <span class="nl">SameThreadPassiveFlags</span> <span class="p">:</span> <span class="n">Uint4B</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x24c</span> <span class="nl">ActiveExWorker</span>   <span class="p">:</span> <span class="n">Pos</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span> <span class="n">Bit</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x24c</span> <span class="nl">ExWorkerCanWaitUser</span> <span class="p">:</span> <span class="n">Pos</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="n">Bit</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x24c</span> <span class="nl">MemoryMaker</span>      <span class="p">:</span> <span class="n">Pos</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span> <span class="n">Bit</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x250</span> <span class="nl">SameThreadApcFlags</span> <span class="p">:</span> <span class="n">Uint4B</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x250</span> <span class="nl">LpcReceivedMsgIdValid</span> <span class="p">:</span> <span class="n">Pos</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span> <span class="n">Bit</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x250</span> <span class="nl">LpcExitThreadCalled</span> <span class="p">:</span> <span class="n">Pos</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="n">Bit</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x250</span> <span class="nl">AddressSpaceOwner</span> <span class="p">:</span> <span class="n">Pos</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span> <span class="n">Bit</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x254</span> <span class="nl">ForwardClusterOnly</span> <span class="p">:</span> <span class="n">UChar</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x255</span> <span class="nl">DisablePageFaultClustering</span> <span class="p">:</span> <span class="n">UChar</span></span></span></code></pre></div><p><img loading="lazy" src="/posts/2023-2-winkernel%E8%BF%9B%E7%A8%8B%E7%BA%BF%E7%A8%8B/image-20230119203755480.png" alt="image-20230119203755480" srcset="/posts/2023-2-winkernel%E8%BF%9B%E7%A8%8B%E7%BA%BF%E7%A8%8B/image-20230119203755480.png?size=small, /posts/2023-2-winkernel%E8%BF%9B%E7%A8%8B%E7%BA%BF%E7%A8%8B/image-20230119203755480.png?size=medium 1.5x, /posts/2023-2-winkernel%E8%BF%9B%E7%A8%8B%E7%BA%BF%E7%A8%8B/image-20230119203755480.png?size=large 2x" data-title="image-20230119203755480" style="--width: 1090px;--aspect-ratio: 1090 / 613;background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<h2 id="003kpcr" class="heading-element"><span>003.KPCR</span>
  <a href="#003kpcr" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><ol>
<li>KPCR结构体是CPU临时记录线程信息的一个结构体</li>
<li>KPCR是CPU快速查找线程信息用的，自己在上面做不了什么事情。</li>
<li>当线程进入0环时，FS:[0]指向KPCR(3环时FS:[0] -&gt; TEB)</li>
<li>每个CPU都有一个KPCR结构体(一个核一个)</li>
<li>KPCR中存储了CPU本身要用的一些重要数据：GDT、IDT以及线程相关的一些信息。</li>
<li>FS寄存器在三环时，记录的是TEB结构的地址。
在0环时，记录的是KPCR的地址。</li>
</ol>
<h3 id="kpcr" class="heading-element"><span>KPCR</span>
  <a href="#kpcr" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">kd</span><span class="o">&gt;</span> <span class="n">dt</span> <span class="n">_KPCR</span>
</span></span><span class="line"><span class="cl"><span class="n">nt</span><span class="o">!</span><span class="n">_KPCR</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x000</span> <span class="nl">NtTib</span>            <span class="p">:</span> <span class="n">_NT_TIB</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x01c</span> <span class="nl">SelfPcr</span>          <span class="p">:</span> <span class="n">Ptr32</span> <span class="n">_KPCR</span><span class="c1">//指向自己，方便寻址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="o">+</span><span class="mh">0x020</span> <span class="nl">Prcb</span>             <span class="p">:</span> <span class="n">Ptr32</span> <span class="n">_KPRCB</span><span class="c1">//指向拓展结构体PRCB  
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="o">+</span><span class="mh">0x024</span> <span class="nl">Irql</span>             <span class="p">:</span> <span class="n">UChar</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x028</span> <span class="nl">IRR</span>              <span class="p">:</span> <span class="n">Uint4B</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x02c</span> <span class="nl">IrrActive</span>        <span class="p">:</span> <span class="n">Uint4B</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x030</span> <span class="nl">IDR</span>              <span class="p">:</span> <span class="n">Uint4B</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x034</span> <span class="nl">KdVersionBlock</span>   <span class="p">:</span> <span class="n">Ptr32</span> <span class="n">Void</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x038</span> <span class="nl">IDT</span>              <span class="p">:</span> <span class="n">Ptr32</span> <span class="n">_KIDTENTRY</span><span class="c1">//IDT表基址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="o">+</span><span class="mh">0x03c</span> <span class="nl">GDT</span>              <span class="p">:</span> <span class="n">Ptr32</span> <span class="n">_KGDTENTRY</span><span class="c1">//GDT表基址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="o">+</span><span class="mh">0x040</span> <span class="nl">TSS</span>              <span class="p">:</span> <span class="n">Ptr32</span> <span class="n">_KTSS</span><span class="c1">//指针，指向TSS，每个CPU都有一个TSS
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="o">+</span><span class="mh">0x044</span> <span class="nl">MajorVersion</span>     <span class="p">:</span> <span class="n">Uint2B</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x046</span> <span class="nl">MinorVersion</span>     <span class="p">:</span> <span class="n">Uint2B</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x048</span> <span class="nl">SetMember</span>        <span class="p">:</span> <span class="n">Uint4B</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x04c</span> <span class="nl">StallScaleFactor</span> <span class="p">:</span> <span class="n">Uint4B</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x050</span> <span class="nl">DebugActive</span>      <span class="p">:</span> <span class="n">UChar</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x051</span> <span class="nl">Number</span>           <span class="p">:</span> <span class="n">UChar</span><span class="c1">//CPU编号：0 1 2 3 4 5。。。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="o">+</span><span class="mh">0x052</span> <span class="nl">Spare0</span>           <span class="p">:</span> <span class="n">UChar</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x053</span> <span class="nl">SecondLevelCacheAssociativity</span> <span class="p">:</span> <span class="n">UChar</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x054</span> <span class="nl">VdmAlert</span>         <span class="p">:</span> <span class="n">Uint4B</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x058</span> <span class="nl">KernelReserved</span>   <span class="p">:</span> <span class="p">[</span><span class="mi">14</span><span class="p">]</span> <span class="n">Uint4B</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x090</span> <span class="nl">SecondLevelCacheSize</span> <span class="p">:</span> <span class="n">Uint4B</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x094</span> <span class="nl">HalReserved</span>      <span class="p">:</span> <span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="n">Uint4B</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x0d4</span> <span class="nl">InterruptMode</span>    <span class="p">:</span> <span class="n">Uint4B</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x0d8</span> <span class="nl">Spare1</span>           <span class="p">:</span> <span class="n">UChar</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x0dc</span> <span class="nl">KernelReserved2</span>  <span class="p">:</span> <span class="p">[</span><span class="mi">17</span><span class="p">]</span> <span class="n">Uint4B</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x120</span> <span class="nl">PrcbData</span>         <span class="p">:</span> <span class="n">_KPRCB</span><span class="c1">//拓展结构体
</span></span></span></code></pre></div><h3 id="nt_tib" class="heading-element"><span>NT_TIB</span>
  <a href="#nt_tib" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">kd</span><span class="o">&gt;</span> <span class="n">dt</span> <span class="n">_NT_TIB</span>
</span></span><span class="line"><span class="cl"><span class="n">ntdll</span><span class="o">!</span><span class="n">_NT_TIB</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x000</span> <span class="nl">ExceptionList</span>    <span class="p">:</span> <span class="n">Ptr32</span> <span class="n">_EXCEPTION_REGISTRATION_RECORD</span><span class="c1">//当前线程内核异常链表(SEH)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="o">+</span><span class="mh">0x004</span> <span class="nl">StackBase</span>        <span class="p">:</span> <span class="n">Ptr32</span> <span class="n">Void</span><span class="c1">//当前线程内核栈的基址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="o">+</span><span class="mh">0x008</span> <span class="nl">StackLimit</span>       <span class="p">:</span> <span class="n">Ptr32</span> <span class="n">Void</span><span class="c1">//当前线程内核栈的大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="o">+</span><span class="mh">0x00c</span> <span class="nl">SubSystemTib</span>     <span class="p">:</span> <span class="n">Ptr32</span> <span class="n">Void</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x010</span> <span class="nl">FiberData</span>        <span class="p">:</span> <span class="n">Ptr32</span> <span class="n">Void</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x010</span> <span class="nl">Version</span>          <span class="p">:</span> <span class="n">Uint4B</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x014</span> <span class="nl">ArbitraryUserPointer</span> <span class="p">:</span> <span class="n">Ptr32</span> <span class="n">Void</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x018</span> <span class="nl">Self</span>             <span class="p">:</span> <span class="n">Ptr32</span> <span class="n">_NT_TIB</span><span class="c1">//指向自己(也就是指向KPCR结构) 
</span></span></span></code></pre></div><h3 id="kprcb" class="heading-element"><span>KPRCB</span>
  <a href="#kprcb" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">kd</span><span class="o">&gt;</span> <span class="n">dt</span> <span class="n">_KPRCB</span>
</span></span><span class="line"><span class="cl"><span class="n">ntdll</span><span class="o">!</span><span class="n">_KPRCB</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x000</span> <span class="nl">MinorVersion</span>     <span class="p">:</span> <span class="n">Uint2B</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x002</span> <span class="nl">MajorVersion</span>     <span class="p">:</span> <span class="n">Uint2B</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x004</span> <span class="nl">CurrentThread</span>    <span class="p">:</span> <span class="n">Ptr32</span> <span class="n">_KTHREAD</span><span class="c1">//当前线程
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="o">+</span><span class="mh">0x008</span> <span class="nl">NextThread</span>       <span class="p">:</span> <span class="n">Ptr32</span> <span class="n">_KTHREAD</span><span class="c1">//即将切换的下一个线程
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="o">+</span><span class="mh">0x00c</span> <span class="nl">IdleThread</span>       <span class="p">:</span> <span class="n">Ptr32</span> <span class="n">_KTHREAD</span><span class="c1">//空闲线程
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="o">+</span><span class="mh">0x010</span> <span class="nl">Number</span>           <span class="p">:</span> <span class="n">Char</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x011</span> <span class="nl">Reserved</span>         <span class="p">:</span> <span class="n">Char</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x012</span> <span class="nl">BuildType</span>        <span class="p">:</span> <span class="n">Uint2B</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x014</span> <span class="nl">SetMember</span>        <span class="p">:</span> <span class="n">Uint4B</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x018</span> <span class="nl">CpuType</span>          <span class="p">:</span> <span class="n">Char</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x019</span> <span class="nl">CpuID</span>            <span class="p">:</span> <span class="n">Char</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x01a</span> <span class="nl">CpuStep</span>          <span class="p">:</span> <span class="n">Uint2B</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x01c</span> <span class="nl">ProcessorState</span>   <span class="p">:</span> <span class="n">_KPROCESSOR_STATE</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x33c</span> <span class="nl">KernelReserved</span>   <span class="p">:</span> <span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="n">Uint4B</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x37c</span> <span class="nl">HalReserved</span>      <span class="p">:</span> <span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="n">Uint4B</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x3bc</span> <span class="nl">PrcbPad0</span>         <span class="p">:</span> <span class="p">[</span><span class="mi">92</span><span class="p">]</span> <span class="n">UChar</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x418</span> <span class="nl">LockQueue</span>        <span class="p">:</span> <span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="n">_KSPIN_LOCK_QUEUE</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x498</span> <span class="nl">PrcbPad1</span>         <span class="p">:</span> <span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="n">UChar</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x4a0</span> <span class="nl">NpxThread</span>        <span class="p">:</span> <span class="n">Ptr32</span> <span class="n">_KTHREAD</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x4a4</span> <span class="nl">InterruptCount</span>   <span class="p">:</span> <span class="n">Uint4B</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x4a8</span> <span class="nl">KernelTime</span>       <span class="p">:</span> <span class="n">Uint4B</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x4ac</span> <span class="nl">UserTime</span>         <span class="p">:</span> <span class="n">Uint4B</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x4b0</span> <span class="nl">DpcTime</span>          <span class="p">:</span> <span class="n">Uint4B</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x4b4</span> <span class="nl">DebugDpcTime</span>     <span class="p">:</span> <span class="n">Uint4B</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x4b8</span> <span class="nl">InterruptTime</span>    <span class="p">:</span> <span class="n">Uint4B</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x4bc</span> <span class="nl">AdjustDpcThreshold</span> <span class="p">:</span> <span class="n">Uint4B</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x4c0</span> <span class="nl">PageColor</span>        <span class="p">:</span> <span class="n">Uint4B</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x4c4</span> <span class="nl">SkipTick</span>         <span class="p">:</span> <span class="n">Uint4B</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x4c8</span> <span class="nl">MultiThreadSetBusy</span> <span class="p">:</span> <span class="n">UChar</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x4c9</span> <span class="nl">Spare2</span>           <span class="p">:</span> <span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="n">UChar</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x4cc</span> <span class="nl">ParentNode</span>       <span class="p">:</span> <span class="n">Ptr32</span> <span class="n">_KNODE</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x4d0</span> <span class="nl">MultiThreadProcessorSet</span> <span class="p">:</span> <span class="n">Uint4B</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x4d4</span> <span class="nl">MultiThreadSetMaster</span> <span class="p">:</span> <span class="n">Ptr32</span> <span class="n">_KPRCB</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x4d8</span> <span class="nl">ThreadStartCount</span> <span class="p">:</span> <span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="n">Uint4B</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x4e0</span> <span class="nl">CcFastReadNoWait</span> <span class="p">:</span> <span class="n">Uint4B</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x4e4</span> <span class="nl">CcFastReadWait</span>   <span class="p">:</span> <span class="n">Uint4B</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x4e8</span> <span class="nl">CcFastReadNotPossible</span> <span class="p">:</span> <span class="n">Uint4B</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x4ec</span> <span class="nl">CcCopyReadNoWait</span> <span class="p">:</span> <span class="n">Uint4B</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x4f0</span> <span class="nl">CcCopyReadWait</span>   <span class="p">:</span> <span class="n">Uint4B</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x4f4</span> <span class="nl">CcCopyReadNoWaitMiss</span> <span class="p">:</span> <span class="n">Uint4B</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x4f8</span> <span class="nl">KeAlignmentFixupCount</span> <span class="p">:</span> <span class="n">Uint4B</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x4fc</span> <span class="nl">KeContextSwitches</span> <span class="p">:</span> <span class="n">Uint4B</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x500</span> <span class="nl">KeDcacheFlushCount</span> <span class="p">:</span> <span class="n">Uint4B</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x504</span> <span class="nl">KeExceptionDispatchCount</span> <span class="p">:</span> <span class="n">Uint4B</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x508</span> <span class="nl">KeFirstLevelTbFills</span> <span class="p">:</span> <span class="n">Uint4B</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x50c</span> <span class="nl">KeFloatingEmulationCount</span> <span class="p">:</span> <span class="n">Uint4B</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x510</span> <span class="nl">KeIcacheFlushCount</span> <span class="p">:</span> <span class="n">Uint4B</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x514</span> <span class="nl">KeSecondLevelTbFills</span> <span class="p">:</span> <span class="n">Uint4B</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x518</span> <span class="nl">KeSystemCalls</span>    <span class="p">:</span> <span class="n">Uint4B</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x51c</span> <span class="nl">SpareCounter0</span>    <span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="n">Uint4B</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x520</span> <span class="nl">PPLookasideList</span>  <span class="p">:</span> <span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="n">_PP_LOOKASIDE_LIST</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x5a0</span> <span class="nl">PPNPagedLookasideList</span> <span class="p">:</span> <span class="p">[</span><span class="mi">32</span><span class="p">]</span> <span class="n">_PP_LOOKASIDE_LIST</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x6a0</span> <span class="nl">PPPagedLookasideList</span> <span class="p">:</span> <span class="p">[</span><span class="mi">32</span><span class="p">]</span> <span class="n">_PP_LOOKASIDE_LIST</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x7a0</span> <span class="nl">PacketBarrier</span>    <span class="p">:</span> <span class="n">Uint4B</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x7a4</span> <span class="nl">ReverseStall</span>     <span class="p">:</span> <span class="n">Uint4B</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x7a8</span> <span class="nl">IpiFrame</span>         <span class="p">:</span> <span class="n">Ptr32</span> <span class="n">Void</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x7ac</span> <span class="nl">PrcbPad2</span>         <span class="p">:</span> <span class="p">[</span><span class="mi">52</span><span class="p">]</span> <span class="n">UChar</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x7e0</span> <span class="nl">CurrentPacket</span>    <span class="p">:</span> <span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="n">Ptr32</span> <span class="n">Void</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x7ec</span> <span class="nl">TargetSet</span>        <span class="p">:</span> <span class="n">Uint4B</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x7f0</span> <span class="nl">WorkerRoutine</span>    <span class="p">:</span> <span class="n">Ptr32</span>     <span class="kt">void</span> 
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x7f4</span> <span class="nl">IpiFrozen</span>        <span class="p">:</span> <span class="n">Uint4B</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x7f8</span> <span class="nl">PrcbPad3</span>         <span class="p">:</span> <span class="p">[</span><span class="mi">40</span><span class="p">]</span> <span class="n">UChar</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x820</span> <span class="nl">RequestSummary</span>   <span class="p">:</span> <span class="n">Uint4B</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x824</span> <span class="nl">SignalDone</span>       <span class="p">:</span> <span class="n">Ptr32</span> <span class="n">_KPRCB</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x828</span> <span class="nl">PrcbPad4</span>         <span class="p">:</span> <span class="p">[</span><span class="mi">56</span><span class="p">]</span> <span class="n">UChar</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x860</span> <span class="nl">DpcListHead</span>      <span class="p">:</span> <span class="n">_LIST_ENTRY</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x868</span> <span class="nl">DpcStack</span>         <span class="p">:</span> <span class="n">Ptr32</span> <span class="n">Void</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x86c</span> <span class="nl">DpcCount</span>         <span class="p">:</span> <span class="n">Uint4B</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x870</span> <span class="nl">DpcQueueDepth</span>    <span class="p">:</span> <span class="n">Uint4B</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x874</span> <span class="nl">DpcRoutineActive</span> <span class="p">:</span> <span class="n">Uint4B</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x878</span> <span class="nl">DpcInterruptRequested</span> <span class="p">:</span> <span class="n">Uint4B</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x87c</span> <span class="nl">DpcLastCount</span>     <span class="p">:</span> <span class="n">Uint4B</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x880</span> <span class="nl">DpcRequestRate</span>   <span class="p">:</span> <span class="n">Uint4B</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x884</span> <span class="nl">MaximumDpcQueueDepth</span> <span class="p">:</span> <span class="n">Uint4B</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x888</span> <span class="nl">MinimumDpcRate</span>   <span class="p">:</span> <span class="n">Uint4B</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x88c</span> <span class="nl">QuantumEnd</span>       <span class="p">:</span> <span class="n">Uint4B</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x890</span> <span class="nl">PrcbPad5</span>         <span class="p">:</span> <span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="n">UChar</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x8a0</span> <span class="nl">DpcLock</span>          <span class="p">:</span> <span class="n">Uint4B</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x8a4</span> <span class="nl">PrcbPad6</span>         <span class="p">:</span> <span class="p">[</span><span class="mi">28</span><span class="p">]</span> <span class="n">UChar</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x8c0</span> <span class="nl">CallDpc</span>          <span class="p">:</span> <span class="n">_KDPC</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x8e0</span> <span class="nl">ChainedInterruptList</span> <span class="p">:</span> <span class="n">Ptr32</span> <span class="n">Void</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x8e4</span> <span class="nl">LookasideIrpFloat</span> <span class="p">:</span> <span class="n">Int4B</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x8e8</span> <span class="nl">SpareFields0</span>     <span class="p">:</span> <span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="n">Uint4B</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x900</span> <span class="nl">VendorString</span>     <span class="p">:</span> <span class="p">[</span><span class="mi">13</span><span class="p">]</span> <span class="n">UChar</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x90d</span> <span class="nl">InitialApicId</span>    <span class="p">:</span> <span class="n">UChar</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x90e</span> <span class="nl">LogicalProcessorsPerPhysicalProcessor</span> <span class="p">:</span> <span class="n">UChar</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x910</span> <span class="nl">MHz</span>              <span class="p">:</span> <span class="n">Uint4B</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x914</span> <span class="nl">FeatureBits</span>      <span class="p">:</span> <span class="n">Uint4B</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x918</span> <span class="nl">UpdateSignature</span>  <span class="p">:</span> <span class="n">_LARGE_INTEGER</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x920</span> <span class="nl">NpxSaveArea</span>      <span class="p">:</span> <span class="n">_FX_SAVE_AREA</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0xb30</span> <span class="nl">PowerState</span>       <span class="p">:</span> <span class="n">_PROCESSOR_POWER_STATE</span></span></span></code></pre></div><blockquote>
<p>特别强调：</p>
<p>我们课程里面讲解的内容，与《内核情景分析》《Windows内核原理与实现》均有不同。</p>
<p>ReactOS是开源免费的Windows NT系列(含NT4.0/2000/XP/2003)克隆操作系统</p>
<p>WRK 是微软针对教育和学术界开放的 Windows 内核的部分源码</p>
<p>而我们的课程是基于Windows XP SP2/SP3 二进制文件.</p>
<p>微软并不开源，很多内核成员的作用需要自己去分析.</p>
</blockquote>
<h2 id="004等待链表_调度链表" class="heading-element"><span>004.等待链表_调度链表</span>
  <a href="#004%e7%ad%89%e5%be%85%e9%93%be%e8%a1%a8_%e8%b0%83%e5%ba%a6%e9%93%be%e8%a1%a8" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><blockquote>
<p>回顾：</p>
<p>EPROCESS结构体有两个链表：0x50，0x190，里面圈着当前进程的所有线程。</p>
</blockquote>
<p><strong>对进程断链，程序可以正常运行，原因是CPU执行与调度是基于线程的，进程断链只是影响一些遍历系统进程的API，并不会影响程序执行。</strong></p>
<p><strong>对线程断链也是一样的，断链后在Windbg或者OD中无法看到被断掉的线程，但并不影响其执行(仍然再跑)。</strong></p>
<h3 id="线程的三种状态等待运行就绪" class="heading-element"><span>线程的三种状态：等待，运行，就绪</span>
  <a href="#%e7%ba%bf%e7%a8%8b%e7%9a%84%e4%b8%89%e7%a7%8d%e7%8a%b6%e6%80%81%e7%ad%89%e5%be%85%e8%bf%90%e8%a1%8c%e5%b0%b1%e7%bb%aa" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p>正在运行中的线程存储在KPCR中，就绪和等待的线程全在另外的33个链表中。一个等待链表，32个就绪链表：</p>
<p>这些链表都使用了_KTHREAD(0x060)这个位置，也就是说，线程在某一时刻，只能属于其中一个圈。</p>
<h4 id="等待链表" class="heading-element"><span>等待链表</span>
  <a href="#%e7%ad%89%e5%be%85%e9%93%be%e8%a1%a8" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h4><p>导致线程等待的原因有多种，例如调用了Sleep, WaitForSingleObject 等函数，或者在创建时和运行时让线程挂起的API，例如 SuspendThread 函数。</p>
<p>等待线程存储在等待链表头 KiWaitListHead 中， KiWaitListHead 是一个全局变量，可以 dd 查看。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">kd&gt; dd KiWaitListHead
</span></span><span class="line"><span class="cl">8055d4a8  863ee840 86407a30 <span class="m">00000011</span> <span class="m">00000000</span>
</span></span><span class="line"><span class="cl">8055d4b8  e57a42bd d6bf94d5 <span class="m">01000013</span> ffdff980
</span></span><span class="line"><span class="cl">8055d4c8  ffdff980 805032c6 <span class="m">00000000</span> 0000493c
</span></span><span class="line"><span class="cl">8055d4d8  <span class="m">00000000</span> ffdff9c0 8055d4e0 8055d4e0
</span></span><span class="line"><span class="cl">8055d4e8  <span class="m">00000000</span> <span class="m">00000000</span> 8055d4f0 8055d4f0
</span></span><span class="line"><span class="cl">8055d4f8  <span class="m">00000000</span> <span class="m">00000000</span> <span class="m">00000000</span> 865b5860
</span></span><span class="line"><span class="cl">8055d508  <span class="m">00000000</span> <span class="m">00000000</span> <span class="m">00040001</span> <span class="m">00000000</span>
</span></span><span class="line"><span class="cl">8055d518  865b58d0 865b58d0 <span class="m">00000000</span> <span class="m">00000000</span></span></span></code></pre></div><p>比如：线程调用了Sleep() 或者 WaitForSingleObject()等函数时，就挂到这个链表(查看等待线程)</p>
<p><code>0x8055d4a8</code>存储了 <code>KiWaitListHead</code> ，这是一个 <code>_LIST_ENTRY</code>，它属于某个线程 <code>_KTHREAD + 0x60</code> 的位置。</p>
<pre tabindex="0"><code>kd&gt; dt _KTHREAD 863ee840-60
ntdll!_KTHREAD
   +0x000 Header           : _DISPATCHER_HEADER
   +0x010 MutantListHead   : _LIST_ENTRY [ 0x863ee7f0 - 0x863ee7f0 ]
   +0x018 InitialStack     : 0xf6fd6000 Void
   +0x01c StackLimit       : 0xf6fd3000 Void
   +0x020 Teb              : 0x7ffd7000 Void
   +0x024 TlsArray         : (null) 
   +0x028 KernelStack      : 0xf6fd5c70 Void
   +0x02c DebugActive      : 0 &#39;&#39;
   +0x02d State            : 0x5 &#39;&#39;
   +0x02e Alerted          : [2]  &#34;&#34;
   +0x030 Iopl             : 0 &#39;&#39;
   +0x031 NpxState         : 0xa &#39;&#39;
   +0x032 Saturation       : 0 &#39;&#39;
   +0x033 Priority         : 11 &#39;&#39;
   +0x034 ApcState         : _KAPC_STATE
   +0x04c ContextSwitches  : 0x9d
   +0x050 IdleSwapBlock    : 0 &#39;&#39;
   +0x051 Spare0           : [3]  &#34;&#34;
   +0x054 WaitStatus       : 0n0
   +0x058 WaitIrql         : 0 &#39;&#39;
   +0x059 WaitMode         : 1 &#39;&#39;
   +0x05a WaitNext         : 0 &#39;&#39;
   +0x05b WaitReason       : 0xf &#39;&#39;
   +0x05c WaitBlockList    : 0x863ee850 _KWAIT_BLOCK
   +0x060 WaitListEntry    : _LIST_ENTRY [ 0x86031998 - 0x8055d4a8 ]
   +0x060 SwapListEntry    : _SINGLE_LIST_ENTRY
   +0x068 WaitTime         : 0x45bd
   +0x06c BasePriority     : 9 &#39;&#39;
   +0x06d DecrementCount   : 0 &#39;&#39;
   +0x06e PriorityDecrement : 0 &#39;&#39;
   +0x06f Quantum          : 5 &#39;&#39;
   +0x070 WaitBlock        : [4] _KWAIT_BLOCK
   +0x0d0 LegoData         : (null) 
   +0x0d4 KernelApcDisable : 0
   +0x0d8 UserAffinity     : 1
   +0x0dc SystemAffinityActive : 0 &#39;&#39;
   +0x0dd PowerState       : 0 &#39;&#39;
   +0x0de NpxIrql          : 0 &#39;&#39;
   +0x0df InitialNode      : 0 &#39;&#39;
   +0x0e0 ServiceTable     : 0x8055d700 Void
   +0x0e4 Queue            : 0x8605c290 _KQUEUE
   +0x0e8 ApcQueueLock     : 0
   +0x0f0 Timer            : _KTIMER
   +0x118 QueueListEntry   : _LIST_ENTRY [ 0x8605c2b0 - 0x864728c0 ]
   +0x120 SoftAffinity     : 1
   +0x124 Affinity         : 1
   +0x128 Preempted        : 0 &#39;&#39;
   +0x129 ProcessReadyQueue : 0 &#39;&#39;
   +0x12a KernelStackResident : 0x1 &#39;&#39;
   +0x12b NextProcessor    : 0 &#39;&#39;
   +0x12c CallbackStack    : (null) 
   +0x130 Win32Thread      : (null) 
   +0x134 TrapFrame        : 0xf6fd5d64 _KTRAP_FRAME
   +0x138 ApcStatePointer  : [2] 0x863ee814 _KAPC_STATE
   +0x140 PreviousMode     : 1 &#39;&#39;
   +0x141 EnableStackSwap  : 0x1 &#39;&#39;
   +0x142 LargeStack       : 0 &#39;&#39;
   +0x143 ResourceIndex    : 0 &#39;&#39;
   +0x144 KernelTime       : 0
   +0x148 UserTime         : 0
   +0x14c SavedApcState    : _KAPC_STATE
   +0x164 Alertable        : 0 &#39;&#39;
   +0x165 ApcStateIndex    : 0 &#39;&#39;
   +0x166 ApcQueueable     : 0x1 &#39;&#39;
   +0x167 AutoAlignment    : 0 &#39;&#39;
   +0x168 StackBase        : 0xf6fd6000 Void
   +0x16c SuspendApc       : _KAPC
   +0x19c SuspendSemaphore : _KSEMAPHORE
   +0x1b0 ThreadListEntry  : _LIST_ENTRY [ 0x863ee4b8 - 0x8649a9d8 ]
   +0x1b8 FreezeCount      : 0 &#39;&#39;
   +0x1b9 SuspendCount     : 0 &#39;&#39;
   +0x1ba IdealProcessor   : 0 &#39;&#39;
   +0x1bb DisableBoost     : 0 &#39;&#39;</code></pre><p>查看这个线程是那个进程的：</p>
<pre tabindex="0"><code>kd&gt; dt _ETHREAD 863ee840-60
nt_exe!_ETHREAD
   +0x000 Tcb              : _KTHREAD
   +0x1c0 CreateTime       : _LARGE_INTEGER 0x0eca09f4`d2f538a0
   +0x1c0 NestedFaultCount : 0y00
   +0x1c0 ApcNeeded        : 0y0
   +0x1c8 ExitTime         : _LARGE_INTEGER 0x863ee9a8`863ee9a8
   +0x1c8 LpcReplyChain    : _LIST_ENTRY [ 0x863ee9a8 - 0x863ee9a8 ]
   +0x1c8 KeyedWaitChain   : _LIST_ENTRY [ 0x863ee9a8 - 0x863ee9a8 ]
   +0x1d0 ExitStatus       : 0n0
   +0x1d0 OfsChain         : (null) 
   +0x1d4 PostBlockList    : _LIST_ENTRY [ 0x863ee9b4 - 0x863ee9b4 ]
   +0x1dc TerminationPort  : 0xe1726cd8 _TERMINATION_PORT
   +0x1dc ReaperLink       : 0xe1726cd8 _ETHREAD
   +0x1dc KeyedWaitValue   : 0xe1726cd8 Void
   +0x1e0 ActiveTimerListLock : 0
   +0x1e4 ActiveTimerListHead : _LIST_ENTRY [ 0x863ee9c4 - 0x863ee9c4 ]
   +0x1ec Cid              : _CLIENT_ID
   +0x1f4 LpcReplySemaphore : _KSEMAPHORE
   +0x1f4 KeyedWaitSemaphore : _KSEMAPHORE
   +0x208 LpcReplyMessage  : (null) 
   +0x208 LpcWaitingOnPort : (null) 
   +0x20c ImpersonationInfo : 0xe1581808 _PS_IMPERSONATION_INFORMATION
   +0x210 IrpList          : _LIST_ENTRY [ 0x86472548 - 0x86472548 ]
   +0x218 TopLevelIrp      : 0
   +0x21c DeviceToVerify   : (null) 
   +0x220 ThreadsProcess   : 0x86057748 _EPROCESS //这里
   +0x224 StartAddress     : 0x7c8106f9 Void
   +0x228 Win32StartAddress : 0x77e56c7d Void
   +0x228 LpcReceivedMessageId : 0x77e56c7d
   +0x22c ThreadListEntry  : _LIST_ENTRY [ 0x863ee534 - 0x8649aa54 ]
   +0x234 RundownProtect   : _EX_RUNDOWN_REF
   +0x238 ThreadLock       : _EX_PUSH_LOCK
...

kd&gt; dt _EPROCESS 0x86057748
nt_exe!_EPROCESS
   +0x000 Pcb              : _KPROCESS
  .....
   +0x174 ImageFileName    : [16]  &#34;lsass.exe&#34;//可以看到是这个进程的</code></pre><p><code>_KTHREAD + 0x60</code> 是一个共用体 union ，线程处于等待或者调度状态就会存到这个位置的链表里，如果是等待状态，这个地方就是等待链表；如果是调度状态，这里就是调度链表。</p>
<h4 id="运行链表" class="heading-element"><span>运行链表</span>
  <a href="#%e8%bf%90%e8%a1%8c%e9%93%be%e8%a1%a8" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h4><p>一个核只有一个运行中的线程，运行中的线程存储在 KPCR 中。</p>
<h4 id="调度链表" class="heading-element"><span>调度链表</span>
  <a href="#%e8%b0%83%e5%ba%a6%e9%93%be%e8%a1%a8" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h4><p>调度链表有32个圈，就是优先级:0 - 31  0最低  31最高</p>
<p>默认优先级一般是8</p>
<p>改变优先级就是从一个圈里面卸下来挂到另外一个圈上</p>
<p>这32个圈是正在调度中的线程：包括正在运行的和准备运行的</p>
<p>比如：只有一个CPU但有10个线程在运行，那么某一时刻，正在运行的线程在KPCR中，其他9个在这32个圈中。</p>
<pre tabindex="0"><code>既然有32个链表，就要有32个链表头。
kd&gt; dd KiDispatcherReadyListHead L70
8055df80  8055df80 8055df80 8055df88 8055df88
8055df90  8055df90 8055df90 8055df98 8055df98
8055dfa0  8055dfa0 8055dfa0 8055dfa8 8055dfa8
8055dfb0  8055dfb0 8055dfb0 8055dfb8 8055dfb8
8055dfc0  8055dfc0 8055dfc0 8055dfc8 8055dfc8
8055dfd0  8055dfd0 8055dfd0 8055dfd8 8055dfd8
8055dfe0  8055dfe0 8055dfe0 8055dfe8 8055dfe8
8055dff0  8055dff0 8055dff0 8055dff8 8055dff8
...</code></pre><p>每两个4字节就构成了一个 LIST_ENTRY，我们发现这里32个链表都是空的，原因是现在windbg把系统挂起了，所有线程都处于等待状态，不能被调度了。</p>
<p>32个链表对应32个优先级 0-31，默认优先级是8，优先级越高越优先。</p>
<h5 id="版本差异" class="heading-element"><span>版本差异</span>
  <a href="#%e7%89%88%e6%9c%ac%e5%b7%ae%e5%bc%82" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h5><p>XP只有一个33个圈，也就是说上面这个数组只有一个，多核也只有一个.</p>
<p>Win7也是一样的只有一个圈，如果是64位的，那就有64个圈.</p>
<p>服务器版本：</p>
<p><code>KiWaitListHead</code>整个系统只有一个，但<code>KiDispatcherReadyListHead</code>这个数组有几个CPU就有几组</p>
<h2 id="005模拟线程切换" class="heading-element"><span>005.模拟线程切换</span>
  <a href="#005%e6%a8%a1%e6%8b%9f%e7%ba%bf%e7%a8%8b%e5%88%87%e6%8d%a2" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><blockquote>
<p><a href="https://blog.csdn.net/Kwansy/article/details/109554283"target="_blank" rel="external nofollow noopener noreferrer">模拟线程切换</a></p>
</blockquote>
<p>3环模拟线程切换的代码：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">##include &lt;stdio.h&gt;
</span></span></span><span class="line"><span class="cl"><span class="cp">##include &lt;tchar.h&gt;
</span></span></span><span class="line"><span class="cl"><span class="cp">##include &lt;string.h&gt;
</span></span></span><span class="line"><span class="cl"><span class="cp">##include &lt;Windows.h&gt;
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">##pragma warning(disable: 4996)
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="c1">//--------------------------------------------------------------------------------------------
</span></span></span><span class="line"><span class="cl"><span class="c1">//--------------------------------------------------------------------------------------------
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cp">##define MAXGMTHREAD 0x100
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">##define GMTHREAD_CREATE		0x01
</span></span></span><span class="line"><span class="cl"><span class="cp">##define GMTHREAD_READY		0x02
</span></span></span><span class="line"><span class="cl"><span class="cp">##define GMTHREAD_RUNNING	0x04
</span></span></span><span class="line"><span class="cl"><span class="cp">##define GMTHREAD_SLEEP		0x08
</span></span></span><span class="line"><span class="cl"><span class="cp">##define GMTHREAD_EXIT		0x100
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">##define GMTHREADSTACKSIZE 0x80000
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="c1">//--------------------------------------------------------------------------------------------
</span></span></span><span class="line"><span class="cl"><span class="c1">//--------------------------------------------------------------------------------------------
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="c1">// 线程结构体（仿ETHREAD）
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>							<span class="c1">// 线程名，相当于线程TID
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="kt">int</span> <span class="n">Flags</span><span class="p">;</span>							<span class="c1">// 线程状态
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="kt">int</span> <span class="n">SleepMillisecondDot</span><span class="p">;</span>			<span class="c1">// 休眠时间
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="kt">void</span> <span class="o">*</span><span class="n">InitialStack</span><span class="p">;</span>					<span class="c1">// 线程堆栈起始位置
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="kt">void</span> <span class="o">*</span><span class="n">StackLimit</span><span class="p">;</span>					<span class="c1">// 线程堆栈界限
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="kt">void</span> <span class="o">*</span><span class="n">KernelStack</span><span class="p">;</span>					<span class="c1">// 线程堆栈当前位置，即ESP0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="kt">void</span> <span class="o">*</span><span class="n">lpParameter</span><span class="p">;</span>					<span class="c1">// 线程函数参数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">func</span><span class="p">)(</span><span class="kt">void</span> <span class="o">*</span><span class="n">lpParameter</span><span class="p">);</span>	<span class="c1">// 线程函数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span> <span class="n">GMThread_t</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//--------------------------------------------------------------------------------------------
</span></span></span><span class="line"><span class="cl"><span class="c1">//--------------------------------------------------------------------------------------------
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="c1">// 当前调度线程下标
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">int</span> <span class="n">CurrentThreadIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 线程调度队列
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">GMThread_t</span> <span class="n">GMThreadList</span><span class="p">[</span><span class="n">MAXGMTHREAD</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span> <span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="o">*</span><span class="n">WindowsStackLimit</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//--------------------------------------------------------------------------------------------
</span></span></span><span class="line"><span class="cl"><span class="c1">//--------------------------------------------------------------------------------------------
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">SwitchContext</span><span class="p">(</span><span class="n">GMThread_t</span> <span class="o">*</span><span class="n">OldGMThreadp</span><span class="p">,</span> <span class="n">GMThread_t</span> <span class="o">*</span><span class="n">NewGMThreadp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">GMThreadStartup</span><span class="p">(</span><span class="n">GMThread_t</span> <span class="o">*</span><span class="n">GMThreadp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">IdleGMThread</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">lpParameter</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">PushStack</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">**</span><span class="n">Stackpp</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">v</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">InitGMThread</span> <span class="p">(</span><span class="n">GMThread_t</span> <span class="o">*</span><span class="n">GMThreadp</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">func</span><span class="p">)(</span><span class="kt">void</span> <span class="o">*</span><span class="n">lpParameter</span><span class="p">),</span> <span class="kt">void</span> <span class="o">*</span><span class="n">lpParameter</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">RegisterGMThread</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">func</span><span class="p">)(</span><span class="kt">void</span> <span class="o">*</span><span class="n">lpParameter</span><span class="p">),</span> <span class="kt">void</span> <span class="o">*</span><span class="n">lpParameter</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">Scheduling</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">GMSleep</span><span class="p">(</span><span class="kt">int</span> <span class="n">Milliseconds</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">Thread1</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">lpParameter</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">Thread2</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">lpParameter</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">Thread3</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">lpParameter</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">Thread4</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">lpParameter</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//--------------------------------------------------------------------------------------------
</span></span></span><span class="line"><span class="cl"><span class="c1">//--------------------------------------------------------------------------------------------
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">_tmain</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="n">_TCHAR</span><span class="o">*</span> <span class="n">argv</span><span class="p">[])</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// 初始化线程环境
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">RegisterGMThread</span><span class="p">(</span><span class="s">&#34;Thread1&#34;</span><span class="p">,</span> <span class="n">Thread1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="nf">RegisterGMThread</span><span class="p">(</span><span class="s">&#34;Thread2&#34;</span><span class="p">,</span> <span class="n">Thread2</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="nf">RegisterGMThread</span><span class="p">(</span><span class="s">&#34;Thread3&#34;</span><span class="p">,</span> <span class="n">Thread3</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="nf">RegisterGMThread</span><span class="p">(</span><span class="s">&#34;Thread4&#34;</span><span class="p">,</span> <span class="n">Thread4</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// 仿Windows线程切换，模拟系统时钟中断，是被动切换
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">//Scheduling();
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">for</span> <span class="p">(;;)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nf">Sleep</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="nf">Scheduling</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// 如果回到主线程，说明没有找到就绪线程，CurrentThreadIndex 一定是 0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="c1">//printf(&#34;时钟中断. %d\n&#34;, CurrentThreadIndex);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 线程切换函数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kr">__declspec</span><span class="p">(</span><span class="kr">naked</span><span class="p">)</span> <span class="kt">void</span> <span class="nf">SwitchContext</span><span class="p">(</span><span class="n">GMThread_t</span> <span class="o">*</span><span class="n">OldGMThreadp</span><span class="p">,</span> <span class="n">GMThread_t</span> <span class="o">*</span><span class="n">NewGMThreadp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kr">__asm</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// 当前线程保存寄存器到自己的栈顶
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="n">push</span> <span class="n">ebp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">mov</span> <span class="n">ebp</span><span class="p">,</span><span class="n">esp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">push</span> <span class="n">edi</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">push</span> <span class="n">esi</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">push</span> <span class="n">ebx</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">push</span> <span class="n">ecx</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">push</span> <span class="n">edx</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">push</span> <span class="n">eax</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="n">mov</span> <span class="n">esi</span><span class="p">,</span><span class="n">OldGMThreadp</span><span class="p">;</span> <span class="c1">// mov esi, [ebp + 0x08]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="n">mov</span> <span class="n">edi</span><span class="p">,</span><span class="n">NewGMThreadp</span><span class="p">;</span> <span class="c1">// mov edi, [ebp + 0x0C]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">		<span class="n">mov</span> <span class="p">[</span><span class="n">esi</span> <span class="o">+</span> <span class="n">GMThread_t</span><span class="p">.</span><span class="n">KernelStack</span><span class="p">],</span> <span class="n">esp</span><span class="p">;</span> <span class="c1">// 保存旧ESP
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="n">mov</span> <span class="n">esp</span><span class="p">,[</span><span class="n">edi</span> <span class="o">+</span> <span class="n">GMThread_t</span><span class="p">.</span><span class="n">KernelStack</span><span class="p">];</span> <span class="c1">// 设置新ESP
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">		<span class="c1">// 从新线程的栈里恢复寄存器的值
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="n">pop</span> <span class="n">eax</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">pop</span> <span class="n">edx</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">pop</span> <span class="n">ecx</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">pop</span> <span class="n">ebx</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">pop</span> <span class="n">esi</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">pop</span> <span class="n">edi</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">pop</span> <span class="n">ebp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="c1">// 返回到新线程之前调用 SwitchContext 的地方；如果是第一次调度，则跳转到 GMThreadStartup
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="n">ret</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 此函数在 SwitchContext 的 ret 指令执行时调用，功能是调用线程入口函数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> <span class="nf">GMThreadStartup</span><span class="p">(</span><span class="n">GMThread_t</span> <span class="o">*</span><span class="n">GMThreadp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">GMThreadp</span><span class="o">-&gt;</span><span class="nf">func</span><span class="p">(</span><span class="n">GMThreadp</span><span class="o">-&gt;</span><span class="n">lpParameter</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">GMThreadp</span><span class="o">-&gt;</span><span class="n">Flags</span> <span class="o">=</span> <span class="n">GMTHREAD_EXIT</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="nf">Scheduling</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">	<span class="nf">printf</span><span class="p">(</span><span class="s">&#34;这句永远不会执行，因为修改线程状态为退出，Scheduling 永远不会返回到这里.</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 空闲线程，没事做就调用它
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> <span class="nf">IdleGMThread</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">lpParameter</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nf">printf</span><span class="p">(</span><span class="s">&#34;IdleGMThread-------------------</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="nf">Scheduling</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 模拟压栈
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> <span class="nf">PushStack</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">**</span><span class="n">Stackpp</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">v</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="o">*</span><span class="n">Stackpp</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="o">**</span><span class="n">Stackpp</span> <span class="o">=</span> <span class="n">v</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 初始化线程结构体和线程栈，设置状态为“就绪”
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> <span class="nf">InitGMThread</span> <span class="p">(</span><span class="n">GMThread_t</span> <span class="o">*</span><span class="n">GMThreadp</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">func</span><span class="p">)(</span><span class="kt">void</span> <span class="o">*</span><span class="n">lpParameter</span><span class="p">),</span> <span class="kt">void</span> <span class="o">*</span><span class="n">lpParameter</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">StackPages</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">ESP</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// 结构初始化赋值
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">GMThreadp</span><span class="o">-&gt;</span><span class="n">Flags</span> <span class="o">=</span> <span class="n">GMTHREAD_CREATE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">GMThreadp</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">GMThreadp</span><span class="o">-&gt;</span><span class="n">func</span> <span class="o">=</span> <span class="n">func</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">GMThreadp</span><span class="o">-&gt;</span><span class="n">lpParameter</span> <span class="o">=</span> <span class="n">lpParameter</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// 申请栈空间
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">StackPages</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="nf">VirtualAlloc</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span><span class="n">GMTHREADSTACKSIZE</span><span class="p">,</span> <span class="n">MEM_COMMIT</span><span class="p">,</span> <span class="n">PAGE_READWRITE</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// 清零
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">memset</span><span class="p">(</span><span class="n">StackPages</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">GMTHREADSTACKSIZE</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// 栈初始化地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">GMThreadp</span><span class="o">-&gt;</span><span class="n">InitialStack</span> <span class="o">=</span> <span class="p">(</span><span class="n">StackPages</span> <span class="o">+</span> <span class="n">GMTHREADSTACKSIZE</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// 栈限制
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">GMThreadp</span><span class="o">-&gt;</span><span class="n">StackLimit</span> <span class="o">=</span> <span class="n">StackPages</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// 栈地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">ESP</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="n">GMThreadp</span><span class="o">-&gt;</span><span class="n">InitialStack</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// 初始化线程栈
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">PushStack</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ESP</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">GMThreadp</span><span class="p">);</span>		<span class="c1">// 通过这个指针来找到：线程函数、函数参数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">PushStack</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ESP</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="mi">0</span><span class="p">);</span>				<span class="c1">// 平衡堆栈，此值无意义，详见 SwitchContext 函数注释
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">PushStack</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ESP</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">GMThreadStartup</span><span class="p">);</span>	<span class="c1">// 线程入口函数，这个函数负责调用线程函数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">PushStack</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ESP</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="mi">0</span><span class="p">);</span>				<span class="c1">// push ebp，此值无意义，是寄存器初始值
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">PushStack</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ESP</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="mi">0</span><span class="p">);</span>				<span class="c1">// push edi，此值无意义，是寄存器初始值
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">PushStack</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ESP</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="mi">0</span><span class="p">);</span>				<span class="c1">// push esi，此值无意义，是寄存器初始值
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">PushStack</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ESP</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="mi">0</span><span class="p">);</span>				<span class="c1">// push ebx，此值无意义，是寄存器初始值
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">PushStack</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ESP</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="mi">0</span><span class="p">);</span>				<span class="c1">// push ecx，此值无意义，是寄存器初始值
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">PushStack</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ESP</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="mi">0</span><span class="p">);</span>				<span class="c1">// push edx，此值无意义，是寄存器初始值
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">PushStack</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ESP</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="mi">0</span><span class="p">);</span>				<span class="c1">// push eax，此值无意义，是寄存器初始值
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">	<span class="n">GMThreadp</span><span class="o">-&gt;</span><span class="n">KernelStack</span> <span class="o">=</span> <span class="n">ESP</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">GMThreadp</span><span class="o">-&gt;</span><span class="n">Flags</span> <span class="o">=</span> <span class="n">GMTHREAD_READY</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 添加新线程到调度队列，然后初始化线程
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">int</span> <span class="nf">RegisterGMThread</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">func</span><span class="p">)(</span><span class="kt">void</span> <span class="o">*</span><span class="n">lpParameter</span><span class="p">),</span> <span class="kt">void</span> <span class="o">*</span><span class="n">lpParameter</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// 找一个空位置，或者是name已经存在的那个项
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// 下标0是当前正在运行的线程，所以从1开始遍历
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">GMThreadList</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="nf">stricmp</span><span class="p">(</span><span class="n">GMThreadList</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">		<span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// 初始化线程结构体
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">InitGMThread</span><span class="p">(</span><span class="o">&amp;</span><span class="n">GMThreadList</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">name</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">lpParameter</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="p">(</span><span class="n">i</span> <span class="o">|</span> <span class="mh">0x55AA0000</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 线程调度函数，功能是遍历调度队列，找到“就绪”线程，然后切换线程
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> <span class="nf">Scheduling</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">TickCount</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">GMThread_t</span> <span class="o">*</span><span class="n">OldGMThreadp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">GMThread_t</span> <span class="o">*</span><span class="n">NewGMThreadp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">TickCount</span> <span class="o">=</span> <span class="nf">GetTickCount</span><span class="p">();</span> <span class="c1">// GetTickCount 返回操作系统启动到目前为止经过的毫秒
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// 正在调度的线程，第一次是 GMThreadList[0]，这个表示主线程
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">OldGMThreadp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">GMThreadList</span><span class="p">[</span><span class="n">CurrentThreadIndex</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// 遍历线程调度队列，找第一个“就绪”线程
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// 如果找不到，就回到主函数，模拟时钟中断
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">NewGMThreadp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">GMThreadList</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>	
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">GMThreadList</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// 如果达到“等待时间”，就修改状态为“就绪”
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">if</span> <span class="p">(</span><span class="n">GMThreadList</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">Flags</span> <span class="o">&amp;</span> <span class="n">GMTHREAD_SLEEP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="p">(</span><span class="n">TickCount</span> <span class="o">&gt;</span> <span class="n">GMThreadList</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">SleepMillisecondDot</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="n">GMThreadList</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">Flags</span> <span class="o">=</span> <span class="n">GMTHREAD_READY</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// 找到“就绪”线程
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">if</span> <span class="p">(</span><span class="n">GMThreadList</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">Flags</span> <span class="o">&amp;</span> <span class="n">GMTHREAD_READY</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">NewGMThreadp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">GMThreadList</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">			<span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// 更新当前调度线程下标
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">CurrentThreadIndex</span> <span class="o">=</span> <span class="n">NewGMThreadp</span> <span class="o">-</span> <span class="n">GMThreadList</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// 线程切换
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">SwitchContext</span><span class="p">(</span><span class="n">OldGMThreadp</span><span class="p">,</span> <span class="n">NewGMThreadp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 正在运行的线程主动调用此函数，将自己设置成“等待”状态，然后让调度函数调度其他线程
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> <span class="nf">GMSleep</span><span class="p">(</span><span class="kt">int</span> <span class="n">Milliseconds</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">GMThread_t</span> <span class="o">*</span><span class="n">GMThreadp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">GMThreadp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">GMThreadList</span><span class="p">[</span><span class="n">CurrentThreadIndex</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">((</span><span class="n">GMThreadp</span><span class="o">-&gt;</span><span class="n">Flags</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">GMThreadp</span><span class="o">-&gt;</span><span class="n">SleepMillisecondDot</span> <span class="o">=</span> <span class="nf">GetTickCount</span><span class="p">()</span> <span class="o">+</span> <span class="n">Milliseconds</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">GMThreadp</span><span class="o">-&gt;</span><span class="n">Flags</span> <span class="o">=</span> <span class="n">GMTHREAD_SLEEP</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nf">Scheduling</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">Thread1</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">lpParameter</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Thread1</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="nf">GMSleep</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span> <span class="c1">// 主动切换，模拟WIN32 API
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">Thread2</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">lpParameter</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">while</span> <span class="p">(</span><span class="o">++</span><span class="n">i</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nf">printf</span><span class="p">(</span><span class="s">&#34;	Thread2(%d)</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="nf">GMSleep</span><span class="p">(</span><span class="mi">200</span><span class="p">);</span> <span class="c1">// 主动切换，模拟WIN32 API
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">Thread3</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">lpParameter</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">while</span> <span class="p">(</span><span class="o">++</span><span class="n">i</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nf">printf</span><span class="p">(</span><span class="s">&#34;		Thread3(%d)</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="nf">GMSleep</span><span class="p">(</span><span class="mi">200</span><span class="p">);</span> <span class="c1">// 主动切换，模拟WIN32 API
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">Thread4</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">lpParameter</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">while</span> <span class="p">(</span><span class="o">++</span><span class="n">i</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nf">printf</span><span class="p">(</span><span class="s">&#34;			Thread4(%d)</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="nf">GMSleep</span><span class="p">(</span><span class="mi">400</span><span class="p">);</span> <span class="c1">// 主动切换，模拟WIN32 API
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div><h3 id="registergmthread" class="heading-element"><span>RegisterGMThread</span>
  <a href="#registergmthread" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p>RegisterGMThread 函数负责创建线程，它遍历线程调度队列，找到一个空位作为新线程结构体，然后调用 InitGMThread 初始化。</p>
<h3 id="initgmthread" class="heading-element"><span>InitGMThread</span>
  <a href="#initgmthread" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p>InitGMThread 函数负责初始化线程结构体；为线程申请堆栈内存；向堆栈压入必要的初始数据，包括线程结构体指针</p>
<h3 id="gmthreadstartup" class="heading-element"><span>GMThreadStartup</span>
  <a href="#gmthreadstartup" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p>GMThreadStartup 函数指针，以及一堆寄存器的初始值，最后设置线程状态为“就绪”。</p>
<p><strong>这里所做的所有压栈操作，没有一个是多余的。</strong></p>
<p>所有线程都要通过 <code>GMThreadStartup</code> 函数调用自己的线程入口函数，而调用 <code>GMThreadStartup</code> 函数的地方以及传参的过程设计非常巧妙，这一步发生在 <code>SwitchContext</code> 函数中，恢复线程后，pop了7个寄存器，esp就指向了 <code>GMThreadStartup</code>，此时 <code>SwitchContext</code> 调用 ret (ret相当于pop eip)指令，就跳转到 <code>GMThreadStartup</code> 函数，完全模拟了 call 调用的堆栈，那个看起来没用的堆栈平衡值其实模拟的是 call 时压入堆栈的返回地址，而 GMThreadp 模拟的是 call 之前push的参数。进入 <code>GMThreadStartup</code> 后，函数从 ebp + 8 处取得参数1 GMThreadp 。</p>
<h3 id="scheduling-线程调度函数" class="heading-element"><span>Scheduling 线程调度函数</span>
  <a href="#scheduling-%e7%ba%bf%e7%a8%8b%e8%b0%83%e5%ba%a6%e5%87%bd%e6%95%b0" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p>Scheduling负责遍历线程调度队列，如果遍历到“等待”状态的线程，判断它是否已经完成了“等待”，如果是，那么修改其状态为就绪。通过遍历，找出第一个“就绪”线程，如果遍历完都没有发现新的就绪线程，那么就认为主函数是“就绪”线程。</p>
<p>最后，调用 SwitchContext 函数“切换”到刚才找到的“就绪”线程。</p>
<h3 id="switchcontext-切换线程函数" class="heading-element"><span>SwitchContext 切换线程函数</span>
  <a href="#switchcontext-%e5%88%87%e6%8d%a2%e7%ba%bf%e7%a8%8b%e5%87%bd%e6%95%b0" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p>旧线程调用 SwitchContext 时，首先把7个寄存器压到自己的栈顶，然后保存当前栈顶 esp 到 KernelStack，然后从新线程的线程结构体里取出 KernelStack 填到 esp，就完成了线程切换。</p>
<p>接下来就是从新线程的栈顶 pop 还原7个寄存器。pop 了那7个寄存器后，esp 一定是指向下一条指令的地址的，如果新线程尚未被调度过，那么栈顶一定是 GMThreadStartup；如果新线程曾被调度过，那么栈顶一定是新线程上一次调用 SwitchContext 的返回地址，即 Scheduling 函数的末尾。</p>
<p><img loading="lazy" src="watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0t3YW5zeQ==,size_16,color_FFFFFF,t_70#pic_center.png" alt="watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0t3YW5zeQ==,size_16,color_FFFFFF,t_70#pic_center.png" srcset="watermark%2ctype_ZmFuZ3poZW5naGVpdGk%2cshadow_10%2ctext_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0t3YW5zeQ==%2csize_16%2ccolor_FFFFFF%2ct_70#pic_center.png?size=small, watermark%2ctype_ZmFuZ3poZW5naGVpdGk%2cshadow_10%2ctext_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0t3YW5zeQ==%2csize_16%2ccolor_FFFFFF%2ct_70#pic_center.png?size=medium 1.5x, watermark%2ctype_ZmFuZ3poZW5naGVpdGk%2cshadow_10%2ctext_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0t3YW5zeQ==%2csize_16%2ccolor_FFFFFF%2ct_70#pic_center.png?size=large 2x" data-title="watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0t3YW5zeQ==,size_16,color_FFFFFF,t_70#pic_center.png" class="suffix-invalid suffix-invalid__small suffix-invalid__large" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<h3 id="总结" class="heading-element"><span>总结</span>
  <a href="#%e6%80%bb%e7%bb%93" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p>模拟线程切换总结：</p>
<ol>
<li>线程不是被动切换的，而是<strong>主动</strong>让出CPU.</li>
<li><strong>线程切换</strong>并<strong>没有使用TSS</strong>来保存寄存器，而是使用堆栈.</li>
<li>线程切换的过程就是堆栈切换的过程.</li>
</ol>
<h2 id="006windows线程切换_主动切换" class="heading-element"><span>006.Windows线程切换_主动切换</span>
  <a href="#006windows%e7%ba%bf%e7%a8%8b%e5%88%87%e6%8d%a2_%e4%b8%bb%e5%8a%a8%e5%88%87%e6%8d%a2" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><p>线程切换是操作系统的核心内容，几乎所有的内核API都会调用切换线程的函数。接下来逆向 <code>KiSwapContext</code> 和 <code>SwapContext</code> 这两个函数，看看Windows是怎么切换线程的。</p>
<h3 id="分析-kiswapcontext" class="heading-element"><span>分析 KiSwapContext</span>
  <a href="#%e5%88%86%e6%9e%90-kiswapcontext" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0040581</span><span class="nf">E</span> <span class="c1">; __fastcall KiSwapContext(x)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0040581</span><span class="nf">E</span> <span class="err">@</span><span class="no">KiSwapContext@4</span> <span class="no">proc</span> <span class="no">near</span>              <span class="c1">; CODE XREF: KiSwapThread()+33↓p
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0040581</span><span class="nf">E</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0040581</span><span class="nf">E</span> <span class="no">var_10</span>          <span class="err">=</span> <span class="no">dword</span> <span class="no">ptr</span> <span class="p">-</span><span class="mi">10</span><span class="no">h</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0040581</span><span class="nf">E</span> <span class="no">var_C</span>           <span class="err">=</span> <span class="no">dword</span> <span class="no">ptr</span> <span class="p">-</span><span class="mi">0</span><span class="no">Ch</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0040581</span><span class="nf">E</span> <span class="no">var_8</span>           <span class="err">=</span> <span class="no">dword</span> <span class="no">ptr</span> <span class="p">-</span><span class="mi">8</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0040581</span><span class="nf">E</span> <span class="no">var_4</span>           <span class="err">=</span> <span class="no">dword</span> <span class="no">ptr</span> <span class="p">-</span><span class="mi">4</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0040581</span><span class="nf">E</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0040581</span><span class="nf">E</span>                 <span class="no">sub</span>     <span class="no">esp</span><span class="p">,</span> <span class="mi">10</span><span class="no">h</span><span class="c1">;使用寄存器传参，因此要将使用到的寄存器暂时保存到堆栈中,和push等效
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00405821</span>                 <span class="nf">mov</span>     <span class="p">[</span><span class="no">esp</span><span class="err">+</span><span class="mi">10</span><span class="no">h</span><span class="err">+</span><span class="no">var_4</span><span class="p">],</span> <span class="no">ebx</span> <span class="c1">; KPCR
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00405825</span>                 <span class="nf">mov</span>     <span class="p">[</span><span class="no">esp</span><span class="err">+</span><span class="mi">10</span><span class="no">h</span><span class="err">+</span><span class="no">var_8</span><span class="p">],</span> <span class="no">esi</span> <span class="c1">; 新线程 _ETHREAD
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00405829</span>                 <span class="nf">mov</span>     <span class="p">[</span><span class="no">esp</span><span class="err">+</span><span class="mi">10</span><span class="no">h</span><span class="err">+</span><span class="no">var_C</span><span class="p">],</span> <span class="no">edi</span> <span class="c1">; 旧线程 _ETHREAD
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0040582</span><span class="nf">D</span>                 <span class="no">mov</span>     <span class="p">[</span><span class="no">esp</span><span class="err">+</span><span class="mi">10</span><span class="no">h</span><span class="err">+</span><span class="no">var_10</span><span class="p">],</span> <span class="no">ebp</span> <span class="c1">; ebp 没用
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00405830</span>                 <span class="nf">mov</span>     <span class="no">ebx</span><span class="p">,</span> <span class="no">large</span> <span class="no">fs</span><span class="p">:</span><span class="mi">1</span><span class="no">Ch</span> <span class="c1">; _KPCR.Self
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00405837</span>                 <span class="nf">mov</span>     <span class="no">esi</span><span class="p">,</span> <span class="no">ecx</span>        <span class="c1">; ecx：新线程的 _ETHREAD
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00405839</span>                 <span class="nf">mov</span>     <span class="no">edi</span><span class="p">,</span> <span class="p">[</span><span class="no">ebx</span><span class="err">+</span><span class="mi">124</span><span class="no">h</span><span class="p">]</span> <span class="c1">; edi：当前线程的 _ETHREAD
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00405839</span>                                         <span class="c1">; [ebx+_KPCR.PrcbData.CurrentThread]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0040583</span><span class="nf">F</span>                 <span class="no">mov</span>     <span class="p">[</span><span class="no">ebx</span><span class="err">+</span><span class="mi">124</span><span class="no">h</span><span class="p">],</span> <span class="no">esi</span> <span class="c1">; 修改 _KPCR，更新当前线程(124h同上
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00405845</span>                 <span class="nf">mov</span>     <span class="no">cl</span><span class="p">,</span> <span class="p">[</span><span class="no">edi</span><span class="err">+</span><span class="mi">58</span><span class="no">h</span><span class="p">]</span>   <span class="c1">; 58==[edi+_ETHREAD.Tcb.WaitIrql]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00405848</span>                 <span class="nf">call</span>    <span class="no">SwapContext</span>     <span class="c1">; 4个参数：
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00405848</span>                                         <span class="c1">; ebx: _KPCR
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00405848</span>                                         <span class="c1">; esi: 新线程 _ETHREAD
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00405848</span>                                         <span class="c1">; edi: 旧线程 _ETHREAD
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00405848</span>                                         <span class="c1">; cl:旧线程的 WaitIrql，这个参数用来控制是否执行APC
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00405848</span>                                         <span class="c1">;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00405848</span>                                         <span class="c1">; 调用 SwapContext 后，已经完成了线程切换
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00405848</span>                                         <span class="c1">; 后面就是新线程从它自己的堆栈里恢复寄存器的值的过程
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0040584</span><span class="nf">D</span>                 <span class="no">mov</span>     <span class="no">ebp</span><span class="p">,</span> <span class="p">[</span><span class="no">esp</span><span class="err">+</span><span class="mi">10</span><span class="no">h</span><span class="err">+</span><span class="no">var_10</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00405850</span>                 <span class="nf">mov</span>     <span class="no">edi</span><span class="p">,</span> <span class="p">[</span><span class="no">esp</span><span class="err">+</span><span class="mi">10</span><span class="no">h</span><span class="err">+</span><span class="no">var_C</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00405854</span>                 <span class="nf">mov</span>     <span class="no">esi</span><span class="p">,</span> <span class="p">[</span><span class="no">esp</span><span class="err">+</span><span class="mi">10</span><span class="no">h</span><span class="err">+</span><span class="no">var_8</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00405858</span>                 <span class="nf">mov</span>     <span class="no">ebx</span><span class="p">,</span> <span class="p">[</span><span class="no">esp</span><span class="err">+</span><span class="mi">10</span><span class="no">h</span><span class="err">+</span><span class="no">var_4</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0040585</span><span class="nf">C</span>                 <span class="no">add</span>     <span class="no">esp</span><span class="p">,</span> <span class="mi">10</span><span class="no">h</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0040585</span><span class="nf">F</span>                 <span class="no">retn</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0040585</span><span class="nf">F</span> <span class="err">@</span><span class="no">KiSwapContext@4</span> <span class="no">endp</span></span></span></code></pre></div><h3 id="分析-swapcontext" class="heading-element"><span>分析 SwapContext</span>
  <a href="#%e5%88%86%e6%9e%90-swapcontext" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p><code>SwapContext</code>是线程切换最终发生的地方。</p>
<h4 id="线程切换汇编语句" class="heading-element"><span>线程切换汇编语句</span>
  <a href="#%e7%ba%bf%e7%a8%8b%e5%88%87%e6%8d%a2%e6%b1%87%e7%bc%96%e8%af%ad%e5%8f%a5" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h4><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nf">mov</span>     <span class="no">esp</span><span class="p">,</span> <span class="p">[</span><span class="no">esi</span><span class="err">+</span><span class="no">_ETHREAD.Tcb.KernelStack</span><span class="p">]</span> <span class="err">;</span> <span class="err">此处是切换线程，切换线程本质是切换堆栈</span></span></span></code></pre></div><h4 id="线程切换是否会切换cr3" class="heading-element"><span>线程切换是否会切换CR3</span>
  <a href="#%e7%ba%bf%e7%a8%8b%e5%88%87%e6%8d%a2%e6%98%af%e5%90%a6%e4%bc%9a%e5%88%87%e6%8d%a2cr3" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h4><p>如果新旧线程属于同一个进程，就不换 cr3,；否则就要换。</p>
<p>判断是否属于同一进程的代码：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nf">mov</span>     <span class="no">eax</span><span class="p">,</span> <span class="p">[</span><span class="no">edi</span><span class="err">+</span><span class="no">_ETHREAD.Tcb.ApcState.Process</span><span class="p">]</span> <span class="c1">;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                        <span class="c1">; 通常情况下，ApcState.Process 和 _ETHREAD.ThreadsProcess 是同一个
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                        <span class="c1">; 但是当A进程调用API访问B进程的内存时，ApcState.Process 存的就是B进程
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nf">cmp</span>     <span class="no">eax</span><span class="p">,</span> <span class="p">[</span><span class="no">esi</span><span class="err">+</span><span class="no">_ETHREAD.Tcb.ApcState.Process</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nf">mov</span>     <span class="p">[</span><span class="no">edi</span><span class="err">+</span><span class="no">_ETHREAD.Tcb.IdleSwapBlock</span><span class="p">],</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="nf">jz</span>      <span class="no">short</span> <span class="no">loc_46A994</span> <span class="c1">; 如果是同一个进程内的线程切换，就跳转
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                        <span class="c1">;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                        <span class="err">;</span> <span class="err">如果不是同一个进程的，那么就要做额外的工作，主要就是切换</span><span class="nf">CR3</span></span></span></code></pre></div><p>切换 cr3 的代码：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nl">loc_46A975:</span>             <span class="c1">; 修改 LDT 寄存器
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nf">lldt</span>    <span class="no">ax</span>
</span></span><span class="line"><span class="cl"><span class="nf">xor</span>     <span class="no">eax</span><span class="p">,</span> <span class="no">eax</span>
</span></span><span class="line"><span class="cl"><span class="nf">mov</span>     <span class="no">gs</span><span class="p">,</span> <span class="no">eax</span>         <span class="c1">; gs 寄存器清零
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                        <span class="c1">; 这就是 Windows 不使用 gs 的依据
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nf">assume</span> <span class="no">gs</span><span class="p">:</span><span class="no">GAP</span>
</span></span><span class="line"><span class="cl"><span class="nf">mov</span>     <span class="no">eax</span><span class="p">,</span> <span class="p">[</span><span class="no">edi</span><span class="err">+</span><span class="no">_EPROCESS.Pcb.DirectoryTableBase</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nf">mov</span>     <span class="no">ebp</span><span class="p">,</span> <span class="p">[</span><span class="no">ebx</span><span class="err">+</span><span class="no">_KPCR.TSS</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nf">mov</span>     <span class="no">ecx</span><span class="p">,</span> <span class="no">dword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">edi</span><span class="err">+</span><span class="no">_EPROCESS.Pcb.IopmOffset</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nf">mov</span>     <span class="p">[</span><span class="no">ebp</span><span class="err">+</span><span class="no">TSS.CR3</span><span class="p">],</span> <span class="no">eax</span>
</span></span><span class="line"><span class="cl"><span class="nf">mov</span>     <span class="no">cr3</span><span class="p">,</span> <span class="no">eax</span>        <span class="c1">; 关键步骤：切换 cr3
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nf">mov</span>     <span class="p">[</span><span class="no">ebp</span><span class="err">+</span><span class="no">TSS.IOMap</span><span class="p">],</span> <span class="no">cx</span>
</span></span><span class="line"><span class="cl"><span class="nf">jmp</span>     <span class="no">short</span> <span class="no">loc_46A994</span></span></span></code></pre></div><h4 id="swapcontext全部分析" class="heading-element"><span>SwapContext全部分析</span>
  <a href="#swapcontext%e5%85%a8%e9%83%a8%e5%88%86%e6%9e%90" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h4><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0046</span><span class="nf">A8E0</span> <span class="c1">; 参数有4个，均通过寄存器保存
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0046</span><span class="nf">A8E0</span> <span class="c1">; ebx: _KPCR
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0046</span><span class="nf">A8E0</span> <span class="c1">; esi: 新线程 _ETHREAD
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0046</span><span class="nf">A8E0</span> <span class="c1">; edi: 旧线程 _ETHREAD
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0046</span><span class="nf">A8E0</span> <span class="c1">; cl: 旧线程的 WaitIrql，貌似用不到，直接覆盖了
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0046</span><span class="nf">A8E0</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0046</span><span class="nf">A8E0</span> <span class="no">SwapContext</span>     <span class="no">proc</span> <span class="no">near</span>               <span class="c1">; CODE XREF: KiUnlockDispatcherDatabase(x)+72↑p
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0046</span><span class="nf">A8E0</span>                                         <span class="c1">; KiSwapContext(x)+29↑p ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0046</span><span class="nf">A8E0</span>                 <span class="no">or</span>      <span class="no">cl</span><span class="p">,</span> <span class="no">cl</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0046</span><span class="nf">A8E2</span>                 <span class="no">mov</span>     <span class="no">es</span><span class="p">:[</span><span class="no">esi</span><span class="err">+</span><span class="no">_ETHREAD.Tcb.State</span><span class="p">],</span> <span class="mi">2</span> <span class="c1">; 修改新线程状态为 2
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0046</span><span class="nf">A8E2</span>                                         <span class="c1">; 1 就绪
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0046</span><span class="nf">A8E2</span>                                         <span class="c1">; 2 运行
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0046</span><span class="nf">A8E2</span>                                         <span class="c1">; 5 等待
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0046</span><span class="nf">A8E7</span>                 <span class="no">pushf</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0046</span><span class="nf">A8E8</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0046</span><span class="nf">A8E8</span> <span class="no">loc_46A8E8</span><span class="p">:</span>                             <span class="c1">; CODE XREF: KiIdleLoop()+5A↓j
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0046</span><span class="nf">A8E8</span>                 <span class="no">mov</span>     <span class="no">ecx</span><span class="p">,</span> <span class="p">[</span><span class="no">ebx</span><span class="err">+</span><span class="no">_KPCR.NtTib.ExceptionList</span><span class="p">]</span> <span class="c1">;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0046</span><span class="nf">A8E8</span>                                         <span class="c1">; 保存本线程切换时的内核seh链表
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0046</span><span class="nf">A8EA</span>                 <span class="no">cmp</span>     <span class="p">[</span><span class="no">ebx</span><span class="err">+</span><span class="no">_KPCR.PrcbData.DpcRoutineActive</span><span class="p">],</span> <span class="mi">0</span> <span class="c1">; 是否有DPC，有就蓝屏
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0046</span><span class="nf">A8F1</span>                 <span class="no">push</span>    <span class="no">ecx</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0046</span><span class="nf">A8F2</span>                 <span class="no">jnz</span>     <span class="no">loc_46AA2D</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0046</span><span class="nf">A8F8</span>                 <span class="no">cmp</span>     <span class="no">ds</span><span class="p">:</span><span class="no">_PPerfGlobalGroupMask</span><span class="p">,</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0046</span><span class="nf">A8FF</span>                 <span class="no">jnz</span>     <span class="no">loc_46AA04</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0046</span><span class="nf">A905</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0046</span><span class="nf">A905</span> <span class="no">loc_46A905</span><span class="p">:</span>                             <span class="c1">; CODE XREF: SwapContext+12C↓j
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0046</span><span class="nf">A905</span>                                         <span class="c1">; SwapContext+13D↓j ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0046</span><span class="nf">A905</span>                 <span class="no">mov</span>     <span class="no">ebp</span><span class="p">,</span> <span class="no">cr0</span>        <span class="c1">; cr0 控制寄存器可以判断当前环境是实模式还是保护模式，是否开启分页模式，写保护
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0046</span><span class="nf">A908</span>                 <span class="no">mov</span>     <span class="no">edx</span><span class="p">,</span> <span class="no">ebp</span>        <span class="c1">; edx = ebp = cr0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0046</span><span class="nf">A90A</span>                 <span class="no">mov</span>     <span class="no">cl</span><span class="p">,</span> <span class="p">[</span><span class="no">esi</span><span class="err">+</span><span class="no">_ETHREAD.Tcb.DebugActive</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0046</span><span class="nf">A90D</span>                 <span class="no">mov</span>     <span class="p">[</span><span class="no">ebx</span><span class="err">+</span><span class="no">_KPCR.DebugActive</span><span class="p">],</span> <span class="no">cl</span> <span class="c1">; 更新 _KPCR 中当前线程的调试状态位，此时存的是新线程的值
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0046</span><span class="nf">A910</span>                 <span class="no">cli</span>                     <span class="c1">; 屏蔽时钟中断
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0046</span><span class="nf">A911</span>                 <span class="no">mov</span>     <span class="p">[</span><span class="no">edi</span><span class="err">+</span><span class="no">_ETHREAD.Tcb.KernelStack</span><span class="p">],</span> <span class="no">esp</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0046</span><span class="nf">A914</span>                 <span class="no">mov</span>     <span class="no">eax</span><span class="p">,</span> <span class="p">[</span><span class="no">esi</span><span class="err">+</span><span class="no">_ETHREAD.Tcb.InitialStack</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0046</span><span class="nf">A917</span>                 <span class="no">mov</span>     <span class="no">ecx</span><span class="p">,</span> <span class="p">[</span><span class="no">esi</span><span class="err">+</span><span class="no">_ETHREAD.Tcb.StackLimit</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0046</span><span class="nf">A91A</span>                 <span class="no">sub</span>     <span class="no">eax</span><span class="p">,</span> <span class="mi">210</span><span class="no">h</span>       <span class="c1">; 线程堆栈的前 0x210 字节是浮点寄存器
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0046</span><span class="nf">A91A</span>                                         <span class="c1">; 此时 eax 指向 _KTRAP_FRAME.V86Gs
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0046</span><span class="nf">A91F</span>                 <span class="no">mov</span>     <span class="p">[</span><span class="no">ebx</span><span class="err">+</span><span class="no">_KPCR.NtTib.StackLimit</span><span class="p">],</span> <span class="no">ecx</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0046</span><span class="nf">A922</span>                 <span class="no">mov</span>     <span class="p">[</span><span class="no">ebx</span><span class="err">+</span><span class="no">_KPCR.NtTib.StackBase</span><span class="p">],</span> <span class="no">eax</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0046</span><span class="nf">A925</span>                 <span class="no">xor</span>     <span class="no">ecx</span><span class="p">,</span> <span class="no">ecx</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0046</span><span class="nf">A927</span>                 <span class="no">mov</span>     <span class="no">cl</span><span class="p">,</span> <span class="p">[</span><span class="no">esi</span><span class="err">+</span><span class="no">_ETHREAD.Tcb.NpxState</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0046</span><span class="nf">A92A</span>                 <span class="no">and</span>     <span class="no">edx</span><span class="p">,</span> <span class="mi">0</span><span class="no">FFFFFFF1h</span> <span class="c1">; 判断 NpxState 是否支持浮点
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0046</span><span class="nf">A92A</span>                                         <span class="c1">;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0046</span><span class="nf">A92A</span>                                         <span class="c1">; 根据判断结果决定是否更新 cr0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0046</span><span class="nf">A92D</span>                 <span class="no">or</span>      <span class="no">ecx</span><span class="p">,</span> <span class="no">edx</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0046</span><span class="nf">A92F</span>                 <span class="no">or</span>      <span class="no">ecx</span><span class="p">,</span> <span class="p">[</span><span class="no">eax</span><span class="err">+</span><span class="mi">20</span><span class="no">Ch</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0046</span><span class="nf">A935</span>                 <span class="no">cmp</span>     <span class="no">ebp</span><span class="p">,</span> <span class="no">ecx</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0046</span><span class="nf">A937</span>                 <span class="no">jnz</span>     <span class="no">loc_46A9FC</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0046</span><span class="nf">A93D</span>                 <span class="no">lea</span>     <span class="no">ecx</span><span class="p">,</span> <span class="p">[</span><span class="no">ecx</span><span class="err">+</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0046</span><span class="nf">A940</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0046</span><span class="nf">A940</span> <span class="no">loc_46A940</span><span class="p">:</span>                             <span class="c1">; CODE XREF: SwapContext+11F↓j
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0046</span><span class="nf">A940</span>                 <span class="no">test</span>    <span class="no">dword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">eax-1Ch</span><span class="p">],</span> <span class="mi">20000</span><span class="no">h</span> <span class="c1">; SegCs &amp; 20000h
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0046</span><span class="nf">A940</span>                                         <span class="c1">; 判断是否是虚拟8086模式，如果不是，直接减掉
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0046</span><span class="nf">A940</span>                                         <span class="c1">;    +0x07c V86Es            : Uint4B
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0046</span><span class="nf">A940</span>                                         <span class="c1">;    +0x080 V86Ds            : Uint4B
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0046</span><span class="nf">A940</span>                                         <span class="c1">;    +0x084 V86Fs            : Uint4B
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0046</span><span class="nf">A940</span>                                         <span class="c1">;    +0x088 V86Gs            : Uint4B
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0046</span><span class="nf">A940</span>                                         <span class="c1">;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0046</span><span class="nf">A940</span>                                         <span class="c1">; 如果是，那么就不减
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0046</span><span class="nf">A940</span>                                         <span class="c1">;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0046</span><span class="nf">A940</span>                                         <span class="c1">; 这样做了之后，eax 就指向了0环栈顶，接下来就会存储到 TSS 里
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0046</span><span class="nf">A940</span>                                         <span class="c1">; 以后这个线程进0环，不论是中断门还是快速调用，都会从 TSS 里获取 ESP0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0046</span><span class="nf">A947</span>                 <span class="no">jnz</span>     <span class="no">short</span> <span class="no">loc_46A94C</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0046</span><span class="nf">A949</span>                 <span class="no">sub</span>     <span class="no">eax</span><span class="p">,</span> <span class="mi">10</span><span class="no">h</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0046</span><span class="nf">A94C</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0046</span><span class="nf">A94C</span> <span class="no">loc_46A94C</span><span class="p">:</span>                             <span class="c1">; CODE XREF: SwapContext+67↑j
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0046</span><span class="nf">A94C</span>                 <span class="no">mov</span>     <span class="no">ecx</span><span class="p">,</span> <span class="p">[</span><span class="no">ebx</span><span class="err">+</span><span class="no">_KPCR.TSS</span><span class="p">]</span> <span class="c1">;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0046</span><span class="nf">A94C</span>                                         <span class="c1">; ecx 指向 TSS
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0046</span><span class="nf">A94C</span>                                         <span class="c1">; TSS 的用途是3环进0环时，要从 TSS 取 SS0 和 ESP0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0046</span><span class="nf">A94F</span>                 <span class="no">mov</span>     <span class="p">[</span><span class="no">ecx</span><span class="err">+</span><span class="no">TSS.ESP0</span><span class="p">],</span> <span class="no">eax</span> <span class="c1">; 更新 TSS 中存储的0环栈顶 ESP0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0046</span><span class="nf">A952</span>                 <span class="no">mov</span>     <span class="no">esp</span><span class="p">,</span> <span class="p">[</span><span class="no">esi</span><span class="err">+</span><span class="no">_ETHREAD.Tcb.KernelStack</span><span class="p">]</span> <span class="c1">; 此处是切换线程，切换线程本质是切换堆栈
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0046</span><span class="nf">A952</span>                                         <span class="c1">; 将 esp 修改为新线程的栈顶，然后就可以从堆栈里取数据恢复现场了
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0046</span><span class="nf">A955</span>                 <span class="no">mov</span>     <span class="no">eax</span><span class="p">,</span> <span class="p">[</span><span class="no">esi</span><span class="err">+</span><span class="no">_ETHREAD.Tcb.Teb</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0046</span><span class="nf">A958</span>                 <span class="no">mov</span>     <span class="p">[</span><span class="no">ebx</span><span class="err">+</span><span class="no">_KPCR.NtTib.Self</span><span class="p">],</span> <span class="no">eax</span> <span class="c1">; 暂时存储 TEB 到 ffdff000
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0046</span><span class="nf">A95B</span>                 <span class="no">sti</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0046</span><span class="nf">A95C</span>                 <span class="no">mov</span>     <span class="no">eax</span><span class="p">,</span> <span class="p">[</span><span class="no">edi</span><span class="err">+</span><span class="no">_ETHREAD.Tcb.ApcState.Process</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0046</span><span class="nf">A95F</span>                 <span class="no">cmp</span>     <span class="no">eax</span><span class="p">,</span> <span class="p">[</span><span class="no">esi</span><span class="err">+</span><span class="no">_ETHREAD.Tcb.ApcState.Process</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0046</span><span class="nf">A962</span>                 <span class="no">mov</span>     <span class="p">[</span><span class="no">edi</span><span class="err">+</span><span class="no">_ETHREAD.Tcb.IdleSwapBlock</span><span class="p">],</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0046</span><span class="nf">A966</span>                 <span class="no">jz</span>      <span class="no">short</span> <span class="no">loc_46A994</span> <span class="c1">; 如果是同一个进程内的线程切换，就跳转
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0046</span><span class="nf">A966</span>                                         <span class="c1">;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0046</span><span class="nf">A966</span>                                         <span class="c1">; 如果不是同一个进程的，那么就要做额外的工作，主要就是切换CR3
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0046</span><span class="nf">A968</span>                 <span class="no">mov</span>     <span class="no">edi</span><span class="p">,</span> <span class="p">[</span><span class="no">esi</span><span class="err">+</span><span class="no">_ETHREAD.Tcb.ApcState.Process</span><span class="p">]</span> <span class="c1">; edi: 新线程所属进程
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0046</span><span class="nf">A96B</span>                 <span class="no">test</span>    <span class="p">[</span><span class="no">edi</span><span class="err">+</span><span class="no">_EPROCESS.Pcb.LdtDescriptor.LimitLow</span><span class="p">],</span> <span class="mi">0</span><span class="no">FFFFh</span> <span class="c1">; 判断 LDT
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0046</span><span class="nf">A971</span>                 <span class="no">jnz</span>     <span class="no">short</span> <span class="no">loc_46A9CE</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0046</span><span class="nf">A973</span>                 <span class="no">xor</span>     <span class="no">eax</span><span class="p">,</span> <span class="no">eax</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0046</span><span class="nf">A975</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0046</span><span class="nf">A975</span> <span class="no">loc_46A975</span><span class="p">:</span>                             <span class="c1">; CODE XREF: SwapContext+117↓j
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0046</span><span class="nf">A975</span>                 <span class="no">lldt</span>    <span class="no">ax</span>              <span class="c1">; 修改 LDT 寄存器
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0046</span><span class="nf">A978</span>                 <span class="no">xor</span>     <span class="no">eax</span><span class="p">,</span> <span class="no">eax</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0046</span><span class="nf">A97A</span>                 <span class="no">mov</span>     <span class="no">gs</span><span class="p">,</span> <span class="no">eax</span>         <span class="c1">; gs 寄存器清零
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0046</span><span class="nf">A97A</span>                                         <span class="c1">; 这就是 Windows 不使用 gs 的依据
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0046</span><span class="nf">A97C</span>                 <span class="no">assume</span> <span class="no">gs</span><span class="p">:</span><span class="no">GAP</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0046</span><span class="nf">A97C</span>                 <span class="no">mov</span>     <span class="no">eax</span><span class="p">,</span> <span class="p">[</span><span class="no">edi</span><span class="err">+</span><span class="no">_EPROCESS.Pcb.DirectoryTableBase</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0046</span><span class="nf">A97F</span>                 <span class="no">mov</span>     <span class="no">ebp</span><span class="p">,</span> <span class="p">[</span><span class="no">ebx</span><span class="err">+</span><span class="no">_KPCR.TSS</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0046</span><span class="nf">A982</span>                 <span class="no">mov</span>     <span class="no">ecx</span><span class="p">,</span> <span class="no">dword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">edi</span><span class="err">+</span><span class="no">_EPROCESS.Pcb.IopmOffset</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0046</span><span class="nf">A985</span>                 <span class="no">mov</span>     <span class="p">[</span><span class="no">ebp</span><span class="err">+</span><span class="no">TSS.CR3</span><span class="p">],</span> <span class="no">eax</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0046</span><span class="nf">A988</span>                 <span class="no">mov</span>     <span class="no">cr3</span><span class="p">,</span> <span class="no">eax</span>        <span class="c1">; 关键步骤：切换 cr3
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0046</span><span class="nf">A98B</span>                 <span class="no">mov</span>     <span class="p">[</span><span class="no">ebp</span><span class="err">+</span><span class="no">TSS.IOMap</span><span class="p">],</span> <span class="no">cx</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0046</span><span class="nf">A98F</span>                 <span class="no">jmp</span>     <span class="no">short</span> <span class="no">loc_46A994</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0046</span><span class="nf">A98F</span> <span class="c1">; ---------------------------------------------------------------------------
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0046</span><span class="nf">A991</span>                 <span class="no">align</span> <span class="mi">4</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0046</span><span class="nf">A994</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0046</span><span class="nf">A994</span> <span class="no">loc_46A994</span><span class="p">:</span>                             <span class="c1">; CODE XREF: SwapContext+86↑j
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0046</span><span class="nf">A994</span>                                         <span class="c1">; SwapContext+AF↑j
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0046</span><span class="nf">A994</span>                 <span class="no">mov</span>     <span class="no">eax</span><span class="p">,</span> <span class="p">[</span><span class="no">ebx</span><span class="err">+</span><span class="no">_KPCR.NtTib.Self</span><span class="p">]</span> <span class="c1">;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0046</span><span class="nf">A994</span>                                         <span class="c1">; 此时 eax 指向了 TEB
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0046</span><span class="nf">A997</span>                 <span class="no">mov</span>     <span class="no">ecx</span><span class="p">,</span> <span class="p">[</span><span class="no">ebx</span><span class="err">+</span><span class="no">_KPCR.GDT</span><span class="p">]</span> <span class="c1">; 假设 GDT表在 0x8003f000
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0046</span><span class="nf">A997</span>                                         <span class="c1">; ecx = 0x8003f000
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0046</span><span class="nf">A997</span>                                         <span class="c1">; 3环 FS = 0x3B
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0046</span><span class="nf">A997</span>                                         <span class="c1">; 所以 FS 在 GDT表里的地址是 0x8003f03B
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0046</span><span class="nf">A997</span>                                         <span class="c1">; 下面的操作是修改 FS 的段描述符，这样3环 FS 就能找到 TEB 了
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0046</span><span class="nf">A997</span>                                         <span class="c1">; ;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0046</span><span class="nf">A99A</span>                 <span class="no">mov</span>     <span class="p">[</span><span class="no">ecx</span><span class="err">+</span><span class="mi">3</span><span class="no">Ah</span><span class="p">],</span> <span class="no">ax</span>   <span class="c1">; BaseAddress 15:00
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0046</span><span class="nf">A99E</span>                 <span class="no">shr</span>     <span class="no">eax</span><span class="p">,</span> <span class="mi">10</span><span class="no">h</span>        <span class="c1">; eax 指向 TEB 的地址高16位
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0046</span><span class="nf">A9A1</span>                 <span class="no">mov</span>     <span class="p">[</span><span class="no">ecx</span><span class="err">+</span><span class="mi">3</span><span class="no">Ch</span><span class="p">],</span> <span class="no">al</span>   <span class="c1">; BaseAddress 23:16
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0046</span><span class="nf">A9A4</span>                 <span class="no">mov</span>     <span class="p">[</span><span class="no">ecx</span><span class="err">+</span><span class="mi">3</span><span class="no">Fh</span><span class="p">],</span> <span class="no">ah</span>   <span class="c1">; BaseAddress 31:24
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0046</span><span class="nf">A9A7</span>                 <span class="no">inc</span>     <span class="p">[</span><span class="no">esi</span><span class="err">+</span><span class="no">_ETHREAD.Tcb.ContextSwitches</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0046</span><span class="nf">A9AA</span>                 <span class="no">inc</span>     <span class="p">[</span><span class="no">ebx</span><span class="err">+</span><span class="no">_KPCR.PrcbData.KeContextSwitches</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0046</span><span class="nf">A9B0</span>                 <span class="no">pop</span>     <span class="no">ecx</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0046</span><span class="nf">A9B1</span>                 <span class="no">mov</span>     <span class="p">[</span><span class="no">ebx</span><span class="p">],</span> <span class="no">ecx</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0046</span><span class="nf">A9B3</span>                 <span class="no">cmp</span>     <span class="p">[</span><span class="no">esi</span><span class="err">+</span><span class="no">_ETHREAD.Tcb.ApcState.KernelApcPending</span><span class="p">],</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0046</span><span class="nf">A9B7</span>                 <span class="no">jnz</span>     <span class="no">short</span> <span class="no">loc_46A9BD</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0046</span><span class="nf">A9B9</span>                 <span class="no">popf</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0046</span><span class="nf">A9BA</span>                 <span class="no">xor</span>     <span class="no">eax</span><span class="p">,</span> <span class="no">eax</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0046</span><span class="nf">A9BC</span>                 <span class="no">retn</span></span></span></code></pre></div><h2 id="007windows线程切换_时钟中断切换" class="heading-element"><span>007.Windows线程切换_时钟中断切换</span>
  <a href="#007windows%e7%ba%bf%e7%a8%8b%e5%88%87%e6%8d%a2_%e6%97%b6%e9%92%9f%e4%b8%ad%e6%96%ad%e5%88%87%e6%8d%a2" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><p>如何中断一个正在执行的程序?</p>
<ol>
<li>异常：比如缺页，或者INT N指令</li>
<li>中断：比如时钟中断</li>
</ol>
<p>Windows系统每隔10-20毫秒会触发一次时钟中断，可以调用 <code>GetSystemTimeAdjustment</code> 函数获取准确数值</p>
<p>时钟中断的中断号是0x30，中断请求级别IRQL是0，我们可以在IDT表里找到时钟中断处理函数 <code>KiStartUnexpectedRange</code> 。</p>
<p>时钟中断执行流程：</p>
<ol>
<li><code>KiStartUnexpectedRange</code></li>
<li><code>KiEndUnexpectedRange</code></li>
<li><code>KiUnexpectedInterruptTail</code></li>
<li><code>HalBeginSystemInterrupt</code></li>
<li><code>HalEndSystemInterrupt</code></li>
<li><code>KiDispatchInterrupt</code>：<code>KiDispatchInterrupt</code>会根据当前线程剩余时间片和备用线程的情况来决定下一步的调用</li>
<li><code>SwapContext</code></li>
</ol>
<h3 id="总结-1" class="heading-element"><span>总结</span>
  <a href="#%e6%80%bb%e7%bb%93-1" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p>线程切换的几种情况：</p>
<ol>
<li>主动调用API函数</li>
<li>时钟中断</li>
<li>异常处理</li>
</ol>
<h2 id="008windows线程切换_时间片管理" class="heading-element"><span>008.Windows线程切换_时间片管理</span>
  <a href="#008windows%e7%ba%bf%e7%a8%8b%e5%88%87%e6%8d%a2_%e6%97%b6%e9%97%b4%e7%89%87%e7%ae%a1%e7%90%86" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><p>时钟中断不一定会切换线程。</p>
<p>时钟中断时，两种情况会导致线程切换：</p>
<p>1、当前的线程CPU时间片到期</p>
<p>2、有备用线程(<code>KPCR.PrcbData.NextThread</code>)</p>
<h3 id="cpu时间片" class="heading-element"><span>CPU时间片</span>
  <a href="#cpu%e6%97%b6%e9%97%b4%e7%89%87" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><ol>
<li>当一个新的线程开始执行时，初始化程序会在<code>_KTHREAD.Quantum</code>赋初始值，该值的大小由<code>_KPROCESS.ThreadQuantum</code>决定(观察<code>ThreadQuantum</code>大小，默认是6)</li>
<li>每次时钟中断会调用<code>KeUpdateRunTime</code>函数，该函数每次将当前线程<code>Quantum</code>减少3个单位，如果减到0，则将<code>KPCR.PrcbData.QuantumEnd</code>的值设置为非0。</li>
<li><code>KiDispatchInterrupt</code>判断时间片到期：调用<code>KiQuantumEnd</code>(重新设置时间片、找到要运行的线程)</li>
</ol>
<h4 id="keupdateruntime" class="heading-element"><span>KeUpdateRunTime</span>
  <a href="#keupdateruntime" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h4><p>每次时钟中断会调用<code>KeUpdateRunTime</code>函数，该函数每次将当前线程<code>Quantum</code>减少3个单位，如果减到0，则将<code>KPCR.PrcbData.QuantumEnd</code>的值设置为非0。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0046</span><span class="nf">A1B8</span>                 <span class="no">sub</span>     <span class="p">[</span><span class="no">ebx</span><span class="err">+</span><span class="no">_KTHREAD.Quantum</span><span class="p">],</span> <span class="mi">3</span> <span class="c1">; 时间片 -3
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0046</span><span class="nf">A1BC</span>                 <span class="no">jg</span>      <span class="no">short</span> <span class="no">loc_46A1D7</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0046</span><span class="nf">A1BE</span>                 <span class="no">cmp</span>     <span class="no">ebx</span><span class="p">,</span> <span class="p">[</span><span class="no">eax</span><span class="err">+</span><span class="no">_KPCR.PrcbData.IdleThread</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0046</span><span class="nf">A1C4</span>                 <span class="no">jz</span>      <span class="no">short</span> <span class="no">loc_46A1D7</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0046</span><span class="nf">A1C6</span>                 <span class="no">mov</span>     <span class="p">[</span><span class="no">eax</span><span class="err">+</span><span class="no">_KPCR.PrcbData.QuantumEnd</span><span class="p">],</span> <span class="no">esp</span></span></span></code></pre></div><p>一个线程初始状态有6个时间片，每次中断会把当前线程时间片减3，这意味着一个线程要经过两次时钟中断时间片才会用完。</p>
<h4 id="kidispatchinterrupt" class="heading-element"><span>KiDispatchInterrupt</span>
  <a href="#kidispatchinterrupt" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h4><p><code>KiDispatchInterrupt</code> 函数会判断当前线程时间片，如果 <code>QuantumEnd</code> 是非0，表明时间片用完，然后就会调用 <code>KiQuantumEnd</code> 函数重新设置时间片，然后执行线程切换；如果时间片没用完，但是存在备用线程 <code>NextThread</code>，那么也会发生切换：</p>
<p><img loading="lazy" src="/posts/2023-2-winkernel%E8%BF%9B%E7%A8%8B%E7%BA%BF%E7%A8%8B/image-20230218163344642.png" alt="image-20230218163344642" srcset="/posts/2023-2-winkernel%E8%BF%9B%E7%A8%8B%E7%BA%BF%E7%A8%8B/image-20230218163344642.png?size=small, /posts/2023-2-winkernel%E8%BF%9B%E7%A8%8B%E7%BA%BF%E7%A8%8B/image-20230218163344642.png?size=medium 1.5x, /posts/2023-2-winkernel%E8%BF%9B%E7%A8%8B%E7%BA%BF%E7%A8%8B/image-20230218163344642.png?size=large 2x" data-title="image-20230218163344642" style="--width: 955px;--aspect-ratio: 955 / 675;background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<h4 id="kiquantumend" class="heading-element"><span>KiQuantumEnd</span>
  <a href="#kiquantumend" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h4><p><code>KiQuantumEnd</code> 函数主要工作就是重新设置时间片：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nf">mov</span>     <span class="no">al</span><span class="p">,</span> <span class="p">[</span><span class="no">eax</span><span class="err">+</span><span class="no">_EPROCESS.Pcb.ThreadQuantum</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nf">mov</span>     <span class="p">[</span><span class="no">esi</span><span class="err">+</span><span class="no">_ETHREAD.Tcb.Quantum</span><span class="p">],</span> <span class="no">al</span> <span class="err">;</span> <span class="err">重新设置一下当前线程的时间片</span></span></span></code></pre></div><p>之后调用 <code>KiFindReadyThread</code> 找新的就绪线程作为函数返回值：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nf">movzx</span>   <span class="no">ecx</span><span class="p">,</span> <span class="p">[</span><span class="no">esi</span><span class="err">+</span><span class="no">_ETHREAD.Tcb.NextProcessor</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nf">call</span>    <span class="err">@</span><span class="no">KiFindReadyThread@8</span> <span class="c1">; KiFindReadyThread(x,x)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nf">cmp</span>     <span class="no">eax</span><span class="p">,</span> <span class="no">ebx</span>
</span></span><span class="line"><span class="cl"><span class="nf">jz</span>      <span class="no">short</span> <span class="no">loc_428C4B</span></span></span></code></pre></div><h4 id="kireadythread" class="heading-element"><span>KiReadyThread</span>
  <a href="#kireadythread" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h4><p>作用是把旧线程 ETHREAD（ecx 传参）添加到就绪链表里，关键代码如下:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00429</span><span class="nf">A40</span> <span class="no">loc_429A40</span><span class="p">:</span>                             <span class="c1">; CODE XREF: KiReadyThread(x)+5E↑j
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00429</span><span class="nf">A40</span>                                         <span class="c1">; KiReadyThread(x)+12A↑j
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00429</span><span class="nf">A40</span>                 <span class="no">mov</span>     <span class="p">[</span><span class="no">eax</span><span class="err">+</span><span class="no">_ETHREAD.Tcb.State</span><span class="p">],</span> <span class="mi">1</span> <span class="c1">; 就绪状态
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00429</span><span class="nf">A44</span>                 <span class="no">add</span>     <span class="no">eax</span><span class="p">,</span> <span class="mi">60</span><span class="no">h</span>        <span class="c1">; ETHREAD + 0x60 是一个链表, WaitListEntry / SwapListEntry
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00429</span><span class="nf">A47</span>                 <span class="no">test</span>    <span class="no">bl</span><span class="p">,</span> <span class="no">bl</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00429</span><span class="nf">A49</span>                 <span class="no">lea</span>     <span class="no">edx</span><span class="p">,</span> <span class="no">_KiDispatcherReadyListHead</span><span class="p">[</span><span class="no">ecx</span><span class="p">*</span><span class="mi">8</span><span class="p">]</span> <span class="c1">; edx 指向对应优先级的链表头
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00429</span><span class="nf">A50</span>                 <span class="no">jz</span>      <span class="no">short</span> <span class="no">loc_429A60</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00429</span><span class="nf">A52</span>                 <span class="no">mov</span>     <span class="no">esi</span><span class="p">,</span> <span class="p">[</span><span class="no">edx</span><span class="p">]</span>      <span class="c1">; 下一个线程.FLink
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00429</span><span class="nf">A54</span>                 <span class="no">mov</span>     <span class="p">[</span><span class="no">eax</span><span class="p">],</span> <span class="no">esi</span>      <span class="c1">; ETHREAD.WaitListEntry.FLink 指向下一个线程
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00429</span><span class="nf">A56</span>                 <span class="no">mov</span>     <span class="p">[</span><span class="no">eax</span><span class="err">+</span><span class="mi">4</span><span class="p">],</span> <span class="no">edx</span>    <span class="c1">; ETHREAD.WaitListEntry.BLink 指向链表头
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00429</span><span class="nf">A59</span>                 <span class="no">mov</span>     <span class="p">[</span><span class="no">esi</span><span class="err">+</span><span class="mi">4</span><span class="p">],</span> <span class="no">eax</span>    <span class="c1">; 下一个线程.BLink 指向 ETHREAD.WaitListEntry
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00429</span><span class="nf">A5C</span>                 <span class="no">mov</span>     <span class="p">[</span><span class="no">edx</span><span class="p">],</span> <span class="no">eax</span>      <span class="c1">; 链表头.FLink = ETHREAD.WaitListEntry
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00429</span><span class="nf">A5E</span>                 <span class="no">jmp</span>     <span class="no">short</span> <span class="no">loc_429A6D</span></span></span></code></pre></div><h3 id="总结-2" class="heading-element"><span>总结</span>
  <a href="#%e6%80%bb%e7%bb%93-2" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p>线程切换的三种情况：</p>
<p>(1)、当前线程主动调用API：</p>
<p>API函数 -&gt; <code>KiSwapThread</code> -&gt; <code>KiSwapContext</code> -&gt; <strong><code>SwapContext</code></strong></p>
<p>(2)、当前线程时间片到期：</p>
<p><code>KiDispatchInterrupt</code> -&gt; <code>KiQuantumEnd</code> -&gt; <strong><code>SwapContext</code></strong></p>
<p>(3)、有备用线程(<code>KPCR.PrcbData.NextThread</code>)</p>
<p><code>KiDispatchInterrupt</code> -&gt; <strong><code>SwapContext</code></strong></p>
<h2 id="009windows线程切换_tss" class="heading-element"><span>009.Windows线程切换_TSS</span>
  <a href="#009windows%e7%ba%bf%e7%a8%8b%e5%88%87%e6%8d%a2_tss" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><p>内核堆栈：</p>
<p><img loading="lazy" src="/posts/2023-2-winkernel%E8%BF%9B%E7%A8%8B%E7%BA%BF%E7%A8%8B/image-20230218165731076.png" alt="image-20230218165731076" srcset="/posts/2023-2-winkernel%E8%BF%9B%E7%A8%8B%E7%BA%BF%E7%A8%8B/image-20230218165731076.png?size=small, /posts/2023-2-winkernel%E8%BF%9B%E7%A8%8B%E7%BA%BF%E7%A8%8B/image-20230218165731076.png?size=medium 1.5x, /posts/2023-2-winkernel%E8%BF%9B%E7%A8%8B%E7%BA%BF%E7%A8%8B/image-20230218165731076.png?size=large 2x" data-title="image-20230218165731076" style="--width: 419px;--aspect-ratio: 419 / 279;background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<p>内核堆栈结构：</p>
<p>(栈底开始往上0x210个字节存储浮点寄存器的值，以上都是<code>TrapFrame</code>结构（在api3环进0环已经讲过了，<code>系统调用</code>那一节）。)</p>
<p><img loading="lazy" src="/posts/2023-2-winkernel%E8%BF%9B%E7%A8%8B%E7%BA%BF%E7%A8%8B/image-20230218165835614.png" alt="image-20230218165835614" srcset="/posts/2023-2-winkernel%E8%BF%9B%E7%A8%8B%E7%BA%BF%E7%A8%8B/image-20230218165835614.png?size=small, /posts/2023-2-winkernel%E8%BF%9B%E7%A8%8B%E7%BA%BF%E7%A8%8B/image-20230218165835614.png?size=medium 1.5x, /posts/2023-2-winkernel%E8%BF%9B%E7%A8%8B%E7%BA%BF%E7%A8%8B/image-20230218165835614.png?size=large 2x" data-title="image-20230218165835614" style="--width: 332px;--aspect-ratio: 332 / 298;background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<p><strong>调用API进0环</strong></p>
<p>普通调用：通过<code>TSS.ESP0</code>得到0环堆栈</p>
<p>快速调用：从MSR得到一个临时0环栈，代码执行后仍然通过<code>TSS.esp0</code>得到当前线程0环堆栈。</p>
<p><code>KiFastCallEntry</code>：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0040689</span><span class="nf">F</span>                 <span class="no">mov</span>     <span class="no">ecx</span><span class="p">,</span> <span class="mi">23</span><span class="no">h</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">004068</span><span class="nf">A4</span>                 <span class="no">push</span>    <span class="mi">30</span><span class="no">h</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">004068</span><span class="nf">A6</span>                 <span class="no">pop</span>     <span class="no">fs</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">004068</span><span class="nf">A8</span>                 <span class="no">mov</span>     <span class="no">ds</span><span class="p">,</span> <span class="no">ecx</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">004068</span><span class="nf">AA</span>                 <span class="no">mov</span>     <span class="no">es</span><span class="p">,</span> <span class="no">ecx</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">004068</span><span class="nf">AC</span>                 <span class="no">mov</span>     <span class="no">ecx</span><span class="p">,</span> <span class="no">large</span> <span class="no">fs</span><span class="p">:</span><span class="mi">40</span><span class="no">h</span> <span class="c1">; KPCR.tss
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">004068</span><span class="nf">B3</span>                 <span class="no">mov</span>     <span class="no">esp</span><span class="p">,</span> <span class="p">[</span><span class="no">ecx</span><span class="err">+</span><span class="mi">4</span><span class="p">]</span>    <span class="c1">; tss.esp0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">004068</span><span class="nf">B6</span>                 <span class="no">push</span>    <span class="mi">23</span><span class="no">h</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">004068</span><span class="nf">B8</span>                 <span class="no">push</span>    <span class="no">edx</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">004068</span><span class="nf">B9</span>                 <span class="no">pushf</span></span></span></code></pre></div><h3 id="tss" class="heading-element"><span>TSS</span>
  <a href="#tss" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p>Intel设计TSS的目的是为了任务切换(线程切换)，但Windows与Linux并没有使用。而是采用堆栈来保存线程的各种寄存器。</p>
<p>一个CPU只有一个TSS，但是线程很多，如何用一个TSS来保存所有线程的ESP0呢?</p>
<p>swapContext部分代码：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nf">mov</span>     <span class="no">eax</span><span class="p">,</span> <span class="p">[</span><span class="no">esi</span><span class="err">+</span><span class="no">_ETHREAD.Tcb.InitialStack</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nf">sub</span>     <span class="no">eax</span><span class="p">,</span> <span class="mi">210</span><span class="no">h</span>       <span class="c1">; 线程堆栈的前 0x210 字节是浮点寄存器
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                        <span class="c1">; 此时 eax 指向 _KTRAP_FRAME.V86Gs
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nf">sub</span>     <span class="no">eax</span><span class="p">,</span> <span class="mi">10</span><span class="no">h</span><span class="c1">;虚拟8086模式下使用 TrapFrame结构
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="err">之后是：</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0046</span><span class="nf">A94C</span> <span class="no">loc_46A94C</span><span class="p">:</span>                             <span class="c1">; CODE XREF: SwapContext+67↑j
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0046</span><span class="nf">A94C</span>                 <span class="no">mov</span>     <span class="no">ecx</span><span class="p">,</span> <span class="p">[</span><span class="no">ebx</span><span class="err">+</span><span class="no">_KPCR.TSS</span><span class="p">]</span> <span class="c1">;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0046</span><span class="nf">A94C</span>                                         <span class="c1">; ecx 指向 TSS
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0046</span><span class="nf">A94C</span>                                         <span class="c1">; TSS 的用途是3环进0环时，要从 TSS 取 SS0 和 ESP0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0046</span><span class="nf">A94F</span>                 <span class="no">mov</span>     <span class="p">[</span><span class="no">ecx</span><span class="err">+</span><span class="no">TSS.ESP0</span><span class="p">],</span> <span class="no">eax</span> <span class="c1">; 更新 TSS 中存储的0环栈顶 ESP0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0046</span><span class="nf">A952</span>                 <span class="no">mov</span>     <span class="no">esp</span><span class="p">,</span> <span class="p">[</span><span class="no">esi</span><span class="err">+</span><span class="no">_ETHREAD.Tcb.KernelStack</span><span class="p">]</span> <span class="c1">; 此处是切换线程，切换线程本质是切换堆栈
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0046</span><span class="nf">A952</span>                                         <span class="c1">; 将 esp 修改为新线程的栈顶，然后就可以从堆栈里取数据恢复现场了
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0046</span><span class="nf">A955</span>                 <span class="no">mov</span>     <span class="no">eax</span><span class="p">,</span> <span class="p">[</span><span class="no">esi</span><span class="err">+</span><span class="no">_ETHREAD.Tcb.Teb</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0046</span><span class="nf">A958</span>                 <span class="no">mov</span>     <span class="p">[</span><span class="no">ebx</span><span class="err">+</span><span class="no">_KPCR.NtTib.Self</span><span class="p">],</span> <span class="no">eax</span> <span class="c1">; 暂时存储 TEB 到 ffdff000
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0046</span><span class="nf">A95B</span>                 <span class="no">sti</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0046</span><span class="nf">A95C</span>                 <span class="no">mov</span>     <span class="no">eax</span><span class="p">,</span> <span class="p">[</span><span class="no">edi</span><span class="err">+</span><span class="no">_ETHREAD.Tcb.ApcState.Process</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0046</span><span class="nf">A95F</span>                 <span class="no">cmp</span>     <span class="no">eax</span><span class="p">,</span> <span class="p">[</span><span class="no">esi</span><span class="err">+</span><span class="no">_ETHREAD.Tcb.ApcState.Process</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0046</span><span class="nf">A962</span>                 <span class="no">mov</span>     <span class="p">[</span><span class="no">edi</span><span class="err">+</span><span class="no">_ETHREAD.Tcb.IdleSwapBlock</span><span class="p">],</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0046</span><span class="nf">A966</span>                 <span class="no">jz</span>      <span class="no">short</span> <span class="no">loc_46A994</span> <span class="c1">; 如果是同一个进程内的线程切换，就跳转
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0046</span><span class="nf">A966</span>                                         <span class="c1">;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0046</span><span class="nf">A966</span>                                         <span class="c1">; 如果不是同一个进程的，那么就要做额外的工作，主要就是切换CR3
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0046</span><span class="nf">A968</span>                 <span class="no">mov</span>     <span class="no">edi</span><span class="p">,</span> <span class="p">[</span><span class="no">esi</span><span class="err">+</span><span class="no">_ETHREAD.Tcb.ApcState.Process</span><span class="p">]</span> <span class="c1">; edi: 新线程所属进程
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0046</span><span class="nf">A96B</span>                 <span class="no">test</span>    <span class="p">[</span><span class="no">edi</span><span class="err">+</span><span class="no">_EPROCESS.Pcb.LdtDescriptor.LimitLow</span><span class="p">],</span> <span class="mi">0</span><span class="no">FFFFh</span> <span class="c1">; 判断 LDT
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0046</span><span class="nf">A971</span>                 <span class="no">jnz</span>     <span class="no">short</span> <span class="no">loc_46A9CE</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0046</span><span class="nf">A973</span>                 <span class="no">xor</span>     <span class="no">eax</span><span class="p">,</span> <span class="no">eax</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0046</span><span class="nf">A975</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0046</span><span class="nf">A975</span> <span class="no">loc_46A975</span><span class="p">:</span>                             <span class="c1">; CODE XREF: SwapContext+117↓j
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0046</span><span class="nf">A975</span>                 <span class="no">lldt</span>    <span class="no">ax</span>              <span class="c1">; 修改 LDT 寄存器
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0046</span><span class="nf">A978</span>                 <span class="no">xor</span>     <span class="no">eax</span><span class="p">,</span> <span class="no">eax</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0046</span><span class="nf">A97A</span>                 <span class="no">mov</span>     <span class="no">gs</span><span class="p">,</span> <span class="no">eax</span>         <span class="c1">; gs 寄存器清零
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0046</span><span class="nf">A97A</span>                                         <span class="c1">; 这就是 Windows 不使用 gs 的依据
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0046</span><span class="nf">A97C</span>                 <span class="no">assume</span> <span class="no">gs</span><span class="p">:</span><span class="no">GAP</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0046</span><span class="nf">A97C</span>                 <span class="no">mov</span>     <span class="no">eax</span><span class="p">,</span> <span class="p">[</span><span class="no">edi</span><span class="err">+</span><span class="no">_EPROCESS.Pcb.DirectoryTableBase</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0046</span><span class="nf">A97F</span>                 <span class="no">mov</span>     <span class="no">ebp</span><span class="p">,</span> <span class="p">[</span><span class="no">ebx</span><span class="err">+</span><span class="no">_KPCR.TSS</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0046</span><span class="nf">A982</span>                 <span class="no">mov</span>     <span class="no">ecx</span><span class="p">,</span> <span class="no">dword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">edi</span><span class="err">+</span><span class="no">_EPROCESS.Pcb.IopmOffset</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0046</span><span class="nf">A985</span>                 <span class="no">mov</span>     <span class="p">[</span><span class="no">ebp</span><span class="err">+</span><span class="no">TSS.CR3</span><span class="p">],</span> <span class="no">eax</span><span class="c1">;将当前TSS中的CR3修改为目标进程的CR3
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0046</span><span class="nf">A988</span>                 <span class="no">mov</span>     <span class="no">cr3</span><span class="p">,</span> <span class="no">eax</span>        <span class="c1">; 关键步骤：切换 cr3
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0046</span><span class="nf">A98B</span>                 <span class="no">mov</span>     <span class="p">[</span><span class="no">ebp</span><span class="err">+</span><span class="no">TSS.IOMap</span><span class="p">],</span> <span class="no">cx</span><span class="c1">;存储IO权限位图到TSS 当前线程的IO权限位图 Windows2000以后不用了
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0046</span><span class="nf">A98F</span>                 <span class="no">jmp</span>     <span class="no">short</span> <span class="no">loc_46A994</span></span></span></code></pre></div><h2 id="010windows线程切换_fs" class="heading-element"><span>010.Windows线程切换_FS</span>
  <a href="#010windows%e7%ba%bf%e7%a8%8b%e5%88%87%e6%8d%a2_fs" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><p><code>FS:[0]</code>寄存器在3环时指向TEB，进入0环后<code>FS:[0]</code>指向KPCR</p>
<p>系统中同时存在很多个线程，这就意味着<code>FS:[0]</code>在3环时指向的TEB要有多个(每个线程一份)。</p>
<p><strong>思考</strong>：在实际的使用中我们发现，当我们在3环查看不同线程的FS寄存器时，FS的段选择子都是相同的，那么<strong>如何实现通过一个FS寄存器指向多个TEB</strong>？(线程切换的时候把基址给改了)</p>
<p>还是<code>SwapContext</code>的部分代码：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0046</span><span class="nf">A994</span> <span class="no">loc_46A994</span><span class="p">:</span>                             <span class="c1">; CODE XREF: SwapContext+86↑j
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0046</span><span class="nf">A994</span>                                         <span class="c1">; SwapContext+AF↑j
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0046</span><span class="nf">A994</span>                 <span class="no">mov</span>     <span class="no">eax</span><span class="p">,</span> <span class="p">[</span><span class="no">ebx</span><span class="err">+</span><span class="no">_KPCR.NtTib.Self</span><span class="p">]</span> <span class="c1">;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0046</span><span class="nf">A994</span>                                         <span class="c1">; 此时 eax 指向了 TEB
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0046</span><span class="nf">A997</span>                 <span class="no">mov</span>     <span class="no">ecx</span><span class="p">,</span> <span class="p">[</span><span class="no">ebx</span><span class="err">+</span><span class="no">_KPCR.GDT</span><span class="p">]</span> <span class="c1">; 假设 GDT表在 0x8003f000
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0046</span><span class="nf">A997</span>                                         <span class="c1">; ecx = 0x8003f000
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0046</span><span class="nf">A997</span>                                         <span class="c1">; 3环 FS = 0x3B
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0046</span><span class="nf">A997</span>                                         <span class="c1">; 所以 FS 在 GDT表里的地址是 0x8003f03B
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0046</span><span class="nf">A997</span>                                         <span class="c1">; 下面的操作是修改 FS 的段描述符，这样3环 FS 就能找到 TEB 了
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0046</span><span class="nf">A997</span>                                         <span class="c1">; ;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0046</span><span class="nf">A99A</span>                 <span class="no">mov</span>     <span class="p">[</span><span class="no">ecx</span><span class="err">+</span><span class="mi">3</span><span class="no">Ah</span><span class="p">],</span> <span class="no">ax</span>   <span class="c1">; BaseAddress 15:00
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0046</span><span class="nf">A99E</span>                 <span class="no">shr</span>     <span class="no">eax</span><span class="p">,</span> <span class="mi">10</span><span class="no">h</span>        <span class="c1">; eax 指向 TEB 的地址高16位
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0046</span><span class="nf">A9A1</span>                 <span class="no">mov</span>     <span class="p">[</span><span class="no">ecx</span><span class="err">+</span><span class="mi">3</span><span class="no">Ch</span><span class="p">],</span> <span class="no">al</span>   <span class="c1">; BaseAddress 23:16
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0046</span><span class="nf">A9A4</span>                 <span class="no">mov</span>     <span class="p">[</span><span class="no">ecx</span><span class="err">+</span><span class="mi">3</span><span class="no">Fh</span><span class="p">],</span> <span class="no">ah</span>   <span class="c1">; BaseAddress 31:24
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0046</span><span class="nf">A9A7</span>                 <span class="no">inc</span>     <span class="p">[</span><span class="no">esi</span><span class="err">+</span><span class="no">_ETHREAD.Tcb.ContextSwitches</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0046</span><span class="nf">A9AA</span>                 <span class="no">inc</span>     <span class="p">[</span><span class="no">ebx</span><span class="err">+</span><span class="no">_KPCR.PrcbData.KeContextSwitches</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0046</span><span class="nf">A9B0</span>                 <span class="no">pop</span>     <span class="no">ecx</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0046</span><span class="nf">A9B1</span>                 <span class="no">mov</span>     <span class="p">[</span><span class="no">ebx</span><span class="p">],</span> <span class="no">ecx</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0046</span><span class="nf">A9B3</span>                 <span class="no">cmp</span>     <span class="p">[</span><span class="no">esi</span><span class="err">+</span><span class="no">_ETHREAD.Tcb.ApcState.KernelApcPending</span><span class="p">],</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0046</span><span class="nf">A9B7</span>                 <span class="no">jnz</span>     <span class="no">short</span> <span class="no">loc_46A9BD</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0046</span><span class="nf">A9B9</span>                 <span class="no">popf</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0046</span><span class="nf">A9BA</span>                 <span class="no">xor</span>     <span class="no">eax</span><span class="p">,</span> <span class="no">eax</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0046</span><span class="nf">A9BC</span>                 <span class="no">retn</span></span></span></code></pre></div><h4 id="段描述符结构" class="heading-element"><span>段描述符结构</span>
  <a href="#%e6%ae%b5%e6%8f%8f%e8%bf%b0%e7%ac%a6%e7%bb%93%e6%9e%84" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h4><p><img loading="lazy" src="/posts/2023-2-winkernel%E8%BF%9B%E7%A8%8B%E7%BA%BF%E7%A8%8B/image-20230218174027106.png" alt="image-20230218174027106" srcset="/posts/2023-2-winkernel%E8%BF%9B%E7%A8%8B%E7%BA%BF%E7%A8%8B/image-20230218174027106.png?size=small, /posts/2023-2-winkernel%E8%BF%9B%E7%A8%8B%E7%BA%BF%E7%A8%8B/image-20230218174027106.png?size=medium 1.5x, /posts/2023-2-winkernel%E8%BF%9B%E7%A8%8B%E7%BA%BF%E7%A8%8B/image-20230218174027106.png?size=large 2x" data-title="image-20230218174027106" style="--width: 1028px;--aspect-ratio: 1028 / 537;background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<h2 id="011windows线程切换_线程优先级" class="heading-element"><span>011.Windows线程切换_线程优先级</span>
  <a href="#011windows%e7%ba%bf%e7%a8%8b%e5%88%87%e6%8d%a2_%e7%ba%bf%e7%a8%8b%e4%bc%98%e5%85%88%e7%ba%a7" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><p>回顾：</p>
<p>三种情况会导致线程切换：</p>
<ol>
<li>
<p>当前线程主动调用API：</p>
<p><code>KiSwapThread</code> -&gt; <code>KiSwapContext</code> -&gt; <code>SwapContext</code></p>
</li>
<li>
<p>当前线程时间片到期：</p>
<p><code>KiDispatchInterrupt</code> -&gt; <code>KiQuantumEnd</code> -&gt; <code>SwapContext</code></p>
</li>
<li>
<p>存在备用线程（<code>KPCR.PrcbData.NextThread</code>）</p>
<p><code>KiDispatchInterrupt</code> -&gt; <code>SwapContext</code></p>
</li>
</ol>
<p><strong>思考</strong>：在<strong>KiSwapThread与KiQuantumEnd</strong>函数中都是通过<strong>KiFindReadyThread</strong>来找下一个要切换的线程，<strong>KiFindReadyThread</strong>是根据什么条件来选择下一个要执行的线程呢?</p>
<h3 id="调度链表-1" class="heading-element"><span>调度链表</span>
  <a href="#%e8%b0%83%e5%ba%a6%e9%93%be%e8%a1%a8-1" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p><strong>描述</strong>：</p>
<ol>
<li>在<strong>Windows 32位</strong>操作系统中，共有<strong>32</strong>个双向链表（调度链表）</li>
<li>在<strong>Windows 64位</strong>操作系统中，共有<strong>64</strong>个双向链表（调度链表）</li>
<li>线程在调度链表的中下标表示<strong>线程优先级</strong>（0~31/64）</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">kd&gt; dd KiDispatcherReadyListHead L70
</span></span><span class="line"><span class="cl">8055df80  8055df80 8055df80 8055df88 8055df88
</span></span><span class="line"><span class="cl">8055df90  8055df90 8055df90 8055df98 8055df98
</span></span><span class="line"><span class="cl">8055dfa0  8055dfa0 8055dfa0 8055dfa8 8055dfa8
</span></span><span class="line"><span class="cl">8055dfb0  8055dfb0 8055dfb0 8055dfb8 8055dfb8
</span></span><span class="line"><span class="cl">8055dfc0  8055dfc0 8055dfc0 8055dfc8 8055dfc8
</span></span><span class="line"><span class="cl">8055dfd0  8055dfd0 8055dfd0 8055dfd8 8055dfd8
</span></span><span class="line"><span class="cl">8055dfe0  8055dfe0 8055dfe0 8055dfe8 8055dfe8
</span></span><span class="line"><span class="cl">8055dff0  8055dff0 8055dff0 8055dff8 8055dff8
</span></span><span class="line"><span class="cl">8055e000  8055e000 8055e000 8055e008 8055e008
</span></span><span class="line"><span class="cl">8055e010  8055e010 8055e010 8055e018 8055e018
</span></span><span class="line"><span class="cl">8055e020  8055e020 8055e020 8055e028 8055e028
</span></span><span class="line"><span class="cl">8055e030  8055e030 8055e030 8055e038 8055e038
</span></span><span class="line"><span class="cl">8055e040  8055e040 8055e040 8055e048 8055e048
</span></span><span class="line"><span class="cl">8055e050  8055e050 8055e050 8055e058 8055e058
</span></span><span class="line"><span class="cl">8055e060  8055e060 8055e060 8055e068 8055e068
</span></span><span class="line"><span class="cl">8055e070  8055e070 8055e070 8055e078 8055e078</span></span></code></pre></div><p><code>KiFindReadyThread</code>查找方式：</p>
<blockquote>
<p><strong>按照优先级别进行查找</strong>：31…30…29…28…
也就是说，在本次查找中，如果级别31的链表里面有线程，那么就不会查找级别为30的链表</p>
</blockquote>
<p>注意：</p>
<ol>
<li>
<p>Windows 32位操作系统中调度链表有32个，由于每次都从头开始查找效率太低，所以Windows通过一个DWORD类型的变量来记录：<code>_KiReadySummary</code></p>
</li>
<li>
<p>当向调度链表(32个)中挂入或者摘除某个线程时，会判断当前级别的链表是否为空，为空则将 <code>_KiReadySummary</code> 对应位置0，否则置1</p>
</li>
<li>
<p>若当前级别链表的链表头和链表尾的值相同，并且等于它们的地址，说明不存在等待调度的线程</p>
<p>若当前级别链表的链表头和链表尾的值相同，但不等于它们的地址，说明存在一个等待调度的线程</p>
</li>
<li>
<p>多cpu会随机寻找 KiDispatcherReadyListHead 指向的数组中的线程。线程可以绑定某个cpu（API：setThreadAffinityMask）</p>
</li>
<li>
<p>若当前CPU不存在就绪线程，则会执行空闲线程，每一个CPU都会指定一个空闲线程</p>
<pre tabindex="0"><code>nt!_KPRCB
   +0x004 CurrentThread    : Ptr32 _KTHREAD		//当前线程
   +0x008 NextThread       : Ptr32 _KTHREAD		//就绪线程
   +0x00c IdleThread       : Ptr32 _KTHREAD		//空闲线程</code></pre></li>
</ol>
<h3 id="kiswapthread" class="heading-element"><span>KiSwapThread</span>
  <a href="#kiswapthread" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p><img loading="lazy" src="/posts/2023-2-winkernel%E8%BF%9B%E7%A8%8B%E7%BA%BF%E7%A8%8B/image-20230218205639146.png" alt="image-20230218205639146" srcset="/posts/2023-2-winkernel%E8%BF%9B%E7%A8%8B%E7%BA%BF%E7%A8%8B/image-20230218205639146.png?size=small, /posts/2023-2-winkernel%E8%BF%9B%E7%A8%8B%E7%BA%BF%E7%A8%8B/image-20230218205639146.png?size=medium 1.5x, /posts/2023-2-winkernel%E8%BF%9B%E7%A8%8B%E7%BA%BF%E7%A8%8B/image-20230218205639146.png?size=large 2x" data-title="image-20230218205639146" style="--width: 694px;--aspect-ratio: 694 / 590;background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<h4 id="总结-3" class="heading-element"><span>总结</span>
  <a href="#%e6%80%bb%e7%bb%93-3" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h4><ol>
<li>调度链表的下标即线程优先级</li>
<li>CPU通过遍历调度链表判断是否存在需要调度的线程</li>
<li>若不存在需要调度的线程，则会执行空闲线程（<strong>_KPRCB.IdleThread</strong>）</li>
</ol>
<h2 id="012进程挂靠" class="heading-element"><span>012.进程挂靠</span>
  <a href="#012%e8%bf%9b%e7%a8%8b%e6%8c%82%e9%9d%a0" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><h3 id="进程线程关系" class="heading-element"><span>进程线程关系</span>
  <a href="#%e8%bf%9b%e7%a8%8b%e7%ba%bf%e7%a8%8b%e5%85%b3%e7%b3%bb" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p>进程为线程提供资源，也就是提供Cr3的值，Cr3中存储的是页目录表基址，Cr3确定了，线程能访问的内存也就确定了。</p>
<h4 id="代码分析" class="heading-element"><span>代码分析</span>
  <a href="#%e4%bb%a3%e7%a0%81%e5%88%86%e6%9e%90" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h4><p>来看这样一行代码：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nf">mov</span> <span class="no">eax</span><span class="p">,</span><span class="no">dword</span> <span class="no">ptr</span> <span class="no">ds</span><span class="p">:[</span><span class="mi">0x12345678</span><span class="p">]</span></span></span></code></pre></div><p>CPU如何解析0x12345678这个地址呢？</p>
<ol>
<li>CPU解析线性地址时，需要通过**页目录表（PDT）**来找到对应的物理页，页目录表基址存在Cr3寄存器中</li>
<li>当前的Cr3的值来源于当前的进程(<strong>_KPROCESS.DirectoryTableBase(+0x018)</strong>)</li>
</ol>
<h4 id="线程找进程" class="heading-element"><span>线程找进程</span>
  <a href="#%e7%ba%bf%e7%a8%8b%e6%89%be%e8%bf%9b%e7%a8%8b" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h4><p>线程找进程有两种情况：</p>
<ol>
<li><strong>KHTREAD.ApcState.Process</strong>(+0x44)：<strong>资源提供者</strong>（养父母），为这个线程提供资源（也就提供Cr3）</li>
<li><strong>ETHREAD.ThreadProcess</strong>(+0x220)：<strong>线程创建者</strong>（亲生父母）</li>
<li>一般情况下，<strong>_ETHREAD.Tcb.ApcState.Process</strong>和 <strong>_ETHREAD.ThreadsProcess</strong> 指向的是同一个进程</li>
<li>将当前Cr3的值改为其它进程的Cr3(进程切换)，称为“<strong>进程挂靠</strong>”</li>
</ol>
<p><img loading="lazy" src="/posts/2023-2-winkernel%E8%BF%9B%E7%A8%8B%E7%BA%BF%E7%A8%8B/image-20230219125142968.png" alt="image-20230219125142968" srcset="/posts/2023-2-winkernel%E8%BF%9B%E7%A8%8B%E7%BA%BF%E7%A8%8B/image-20230219125142968.png?size=small, /posts/2023-2-winkernel%E8%BF%9B%E7%A8%8B%E7%BA%BF%E7%A8%8B/image-20230219125142968.png?size=medium 1.5x, /posts/2023-2-winkernel%E8%BF%9B%E7%A8%8B%E7%BA%BF%E7%A8%8B/image-20230219125142968.png?size=large 2x" data-title="image-20230219125142968" style="--width: 440px;--aspect-ratio: 440 / 228;background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<p>有了上述概念后，我们知道了，正常情况下，Cr3的值是由养父母提供的，但是Cr3的值也可以改成和当前线程毫不相干的其它进程的<code>DirectoryTableBase</code>。</p>
<p>观察下面的代码：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nf">mov</span> <span class="no">cr3</span><span class="p">,</span><span class="no">A.DirectoryTableBase</span>
</span></span><span class="line"><span class="cl"><span class="nf">mov</span> <span class="no">eax</span><span class="p">,</span><span class="no">dword</span> <span class="no">ptr</span> <span class="no">ds</span><span class="p">:[</span><span class="mi">0x12345678</span><span class="p">]</span>		<span class="c1">//A进程的0x12345678内存
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nf">mov</span> <span class="no">cr3</span><span class="p">,</span><span class="no">B.DirectoryTableBase</span>
</span></span><span class="line"><span class="cl"><span class="nf">mov</span> <span class="no">eax</span><span class="p">,</span><span class="no">dword</span> <span class="no">ptr</span> <span class="no">ds</span><span class="p">:[</span><span class="mi">0x12345678</span><span class="p">]</span>		<span class="c1">//B进程的0x12345678内存
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nf">mov</span> <span class="no">cr3</span><span class="p">,</span><span class="no">C.DirectoryTableBase</span>
</span></span><span class="line"><span class="cl"><span class="nf">mov</span> <span class="no">eax</span><span class="p">,</span><span class="no">dword</span> <span class="no">ptr</span> <span class="no">ds</span><span class="p">:[</span><span class="mi">0x12345678</span><span class="p">]</span>		<span class="err">//</span><span class="no">C进程的0x12345678内存</span></span></span></code></pre></div><p>有了进程挂靠，就意味着可以读取其它进程的内存。</p>
<h3 id="分析ntreadvirtualmemory" class="heading-element"><span>分析NtReadVirtualMemory</span>
  <a href="#%e5%88%86%e6%9e%90ntreadvirtualmemory" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p><code>ReadProcessMemory</code>这个三环API是可以读取其它进程的内存的，该函数在0环的实现是<code>NtReadVirtualMemory</code></p>
<p><code>NtReadVirtualMemory</code>：读取某一个进程的内存</p>
<pre tabindex="0"><code>NtReadVirtualMemory =&gt;

KiAttachProcess =&gt;

修改养父母 =&gt;

修改Cr3 </code></pre><p>可不可以只修改Cr3而不修改养父母？不可以，如果不修改养父母的值,一旦产生线程切换，就会变成自己读自己！</p>
<p>如果我们自己来写这个代码，在切换Cr3后关闭中断，并且不调用会导致线程切换的API,就可以不用修改养父母的值。</p>
<p><code>NtReadVirtualMemory</code>比较复杂，挑重点说：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nl">PAGE:</span><span class="err">004</span><span class="nf">B05BE</span>                 <span class="no">push</span>    <span class="no">eax</span>             <span class="c1">; int
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">PAGE:</span><span class="err">004</span><span class="nf">B05BF</span>                 <span class="no">push</span>    <span class="no">dword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">ebp</span><span class="err">+</span><span class="no">AccessMode</span><span class="p">]</span> <span class="c1">; AccessMode
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">PAGE:</span><span class="err">004</span><span class="nf">B05C2</span>                 <span class="no">push</span>    <span class="no">esi</span>             <span class="c1">; Length
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">PAGE:</span><span class="err">004</span><span class="nf">B05C3</span>                 <span class="no">push</span>    <span class="p">[</span><span class="no">ebp</span><span class="err">+</span><span class="no">Buffer</span><span class="p">]</span>    <span class="c1">; 要存储的位置
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">PAGE:</span><span class="err">004</span><span class="nf">B05C6</span>                 <span class="no">push</span>    <span class="no">dword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">edi</span><span class="err">+</span><span class="no">_ETHREAD.Tcb.ApcState.Process</span><span class="p">]</span> <span class="c1">; PROCESS
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">PAGE:</span><span class="err">004</span><span class="nf">B05C9</span>                 <span class="no">push</span>    <span class="p">[</span><span class="no">ebp</span><span class="err">+</span><span class="no">BaseAddress</span><span class="p">]</span> <span class="c1">; 要存储的起始地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">PAGE:</span><span class="err">004</span><span class="nf">B05CC</span>                 <span class="no">push</span>    <span class="p">[</span><span class="no">ebp</span><span class="err">+</span><span class="no">Object</span><span class="p">]</span>    <span class="c1">; 要读取的进程的_KPROCESS
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">PAGE:</span><span class="err">004</span><span class="nf">B05CF</span>                 <span class="no">call</span>    <span class="no">_MmCopyVirtualMemory@28</span> <span class="c1">; COPY函数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">PAGE:</span><span class="err">004</span><span class="nf">B05D4</span>                 <span class="no">mov</span>     <span class="p">[</span><span class="no">ebp</span><span class="err">+</span><span class="no">var_1C</span><span class="p">],</span> <span class="no">eax</span>
</span></span><span class="line"><span class="cl"><span class="nl">PAGE:</span><span class="err">004</span><span class="nf">B05D7</span>                 <span class="no">mov</span>     <span class="no">ecx</span><span class="p">,</span> <span class="p">[</span><span class="no">ebp</span><span class="err">+</span><span class="no">Object</span><span class="p">]</span> <span class="c1">; Object
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">PAGE:</span><span class="err">004</span><span class="nf">B05DA</span>                 <span class="no">call</span>    <span class="err">@</span><span class="no">ObfDereferenceObject@4</span> <span class="err">;</span> <span class="no">ObfDereferenceObject</span><span class="p">(</span><span class="no">x</span><span class="p">)</span></span></span></code></pre></div><p><code>MmCopyVirtualMemory</code>：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nl">PAGE:</span><span class="err">004</span><span class="nf">AB0F5</span> <span class="no">loc_4AB0F5</span><span class="p">:</span>                             <span class="c1">; CODE XREF: MmCopyVirtualMemory(x,x,x,x,x,x,x)+7B771↓j
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">PAGE:</span><span class="err">004</span><span class="nf">AB0F5</span>                 <span class="no">push</span>    <span class="no">edi</span>             <span class="c1">; int
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">PAGE:</span><span class="err">004</span><span class="nf">AB0F6</span>                 <span class="no">push</span>    <span class="no">dword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">ebp</span><span class="err">+</span><span class="no">AccessMode</span><span class="p">]</span> <span class="c1">; char
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">PAGE:</span><span class="err">004</span><span class="nf">AB0F9</span>                 <span class="no">push</span>    <span class="p">[</span><span class="no">ebp</span><span class="err">+</span><span class="no">Length</span><span class="p">]</span>    <span class="c1">; Length
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">PAGE:</span><span class="err">004</span><span class="nf">AB0FC</span>                 <span class="no">push</span>    <span class="p">[</span><span class="no">ebp</span><span class="err">+</span><span class="no">Address</span><span class="p">]</span>   <span class="c1">; Address
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">PAGE:</span><span class="err">004</span><span class="nf">AB0FF</span>                 <span class="no">push</span>    <span class="p">[</span><span class="no">ebp</span><span class="err">+</span><span class="no">PROCESS</span><span class="p">]</span>   <span class="c1">; PROCESS
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">PAGE:</span><span class="err">004</span><span class="nf">AB102</span>                 <span class="no">push</span>    <span class="p">[</span><span class="no">ebp</span><span class="err">+</span><span class="no">arg_4</span><span class="p">]</span>     <span class="c1">; int
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">PAGE:</span><span class="err">004</span><span class="nf">AB105</span>                 <span class="no">push</span>    <span class="no">ebx</span>             <span class="c1">; PRKPROCESS
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">PAGE:</span><span class="err">004</span><span class="nf">AB106</span>                 <span class="no">call</span>    <span class="no">_MiDoPoolCopy@28</span> <span class="c1">; 真正的COPY函数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">PAGE:</span><span class="err">004</span><span class="nf">AB10B</span>                 <span class="no">mov</span>     <span class="no">esi</span><span class="p">,</span> <span class="no">eax</span></span></span></code></pre></div><p><code>MiDoPoolCopy</code>：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nl">PAGE:</span><span class="err">004</span><span class="nf">AB7B9</span> <span class="no">loc_4AB7B9</span><span class="p">:</span>                             <span class="c1">; CODE XREF: MiDoPoolCopy(x,x,x,x,x,x,x)+7B0C9↓j
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">PAGE:</span><span class="err">004</span><span class="nf">AB7B9</span>                 <span class="no">lea</span>     <span class="no">eax</span><span class="p">,</span> <span class="p">[</span><span class="no">ebp</span><span class="err">+</span><span class="no">ApcState</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nl">PAGE:</span><span class="err">004</span><span class="nf">AB7BC</span>                 <span class="no">push</span>    <span class="no">eax</span>             <span class="c1">; _KAPC_STATE
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">PAGE:</span><span class="err">004</span><span class="nf">AB7BD</span>                 <span class="no">push</span>    <span class="p">[</span><span class="no">ebp</span><span class="err">+</span><span class="no">arg_0</span><span class="p">]</span>     <span class="c1">; _KPROCESS
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">PAGE:</span><span class="err">004</span><span class="nf">AB7C0</span>                 <span class="no">call</span>    <span class="no">_KeStackAttachProcess@8</span> <span class="c1">; 进程挂靠
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">PAGE:</span><span class="err">004</span><span class="nf">AB7C5</span>                 <span class="no">xor</span>     <span class="no">esi</span><span class="p">,</span> <span class="no">esi</span></span></span></code></pre></div><p><code>KeStackAttachProcess</code>：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0041</span><span class="nf">AB80</span>                 <span class="no">push</span>    <span class="no">eax</span>             <span class="c1">; _KTHREAD -&gt; SavedApcState
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0041</span><span class="nf">AB81</span>                 <span class="no">push</span>    <span class="p">[</span><span class="no">ebp</span><span class="err">+</span><span class="no">PROCESS</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0041</span><span class="nf">AB84</span>                 <span class="no">push</span>    <span class="no">edi</span>             <span class="c1">; 要读取进程的_KPROCESS
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0041</span><span class="nf">AB85</span>                 <span class="no">push</span>    <span class="no">esi</span>             <span class="c1">; 当前进程的_KTHREAD
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0041</span><span class="nf">AB86</span>                 <span class="no">call</span>    <span class="no">_KiAttachProcess@16</span> <span class="err">;</span> <span class="no">KiAttachProcess</span><span class="p">(</span><span class="no">x</span><span class="p">,</span><span class="no">x</span><span class="p">,</span><span class="no">x</span><span class="p">,</span><span class="no">x</span><span class="p">)</span></span></span></code></pre></div><p><code>KiAttachProcess</code>：真正的挂靠函数</p>
<p>1）修改<strong>养父母</strong>，即<code>KTHREAD.ApcState.Process</code>的值，修改为将要访问的进程的<strong>进程结构体</strong></p>
<p>2）调用进程切换函数<code>KiSwapProcess</code>（<strong>本质是切换Cr3</strong>）</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="na">...</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0041</span><span class="nf">A2A2</span>                 <span class="no">cmp</span>     <span class="p">[</span><span class="no">ebp</span><span class="err">+</span><span class="no">arg_C</span><span class="p">],</span> <span class="no">eax</span> 
</span></span><span class="line"><span class="cl"><span class="no">.text</span><span class="p">:</span><span class="mi">0041</span><span class="no">A2A5</span>                 <span class="no">mov</span>     <span class="p">[</span><span class="no">esi</span><span class="err">+</span><span class="mi">44</span><span class="no">h</span><span class="p">],</span> <span class="no">edi</span> <span class="c1">; 修改养父母(KHTREAD.ApcState.Process)的值
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0041</span><span class="nf">A2A8</span>                 <span class="no">mov</span>     <span class="no">byte</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">esi</span><span class="err">+</span><span class="mi">48</span><span class="no">h</span><span class="p">],</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0041</span><span class="nf">A2AC</span>                 <span class="no">mov</span>     <span class="no">byte</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">esi</span><span class="err">+</span><span class="mi">49</span><span class="no">h</span><span class="p">],</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0041</span><span class="nf">A2B0</span>                 <span class="no">mov</span>     <span class="no">byte</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">esi</span><span class="err">+</span><span class="mi">4</span><span class="no">Ah</span><span class="p">],</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0041</span><span class="nf">A2B4</span>                 <span class="no">jnz</span>     <span class="no">short</span> <span class="no">loc_41A2C9</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0041</span><span class="nf">A2B6</span>                 <span class="no">mov</span>     <span class="p">[</span><span class="no">esi</span><span class="err">+</span><span class="mi">138</span><span class="no">h</span><span class="p">],</span> <span class="no">eax</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0041</span><span class="nf">A2BC</span>                 <span class="no">mov</span>     <span class="p">[</span><span class="no">esi</span><span class="err">+</span><span class="mi">13</span><span class="no">Ch</span><span class="p">],</span> <span class="no">ebx</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0041</span><span class="nf">A2C2</span>                 <span class="no">mov</span>     <span class="no">byte</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">esi</span><span class="err">+</span><span class="mi">165</span><span class="no">h</span><span class="p">],</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0041</span><span class="nf">A2C9</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0041</span><span class="nf">A2C9</span> <span class="no">loc_41A2C9</span><span class="p">:</span>                             <span class="c1">; CODE XREF: KiAttachProcess(x,x,x,x)+43↑j
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0041</span><span class="nf">A2C9</span>                 <span class="no">cmp</span>     <span class="no">byte</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">edi</span><span class="err">+</span><span class="mi">65</span><span class="no">h</span><span class="p">],</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0041</span><span class="nf">A2CD</span>                 <span class="no">jnz</span>     <span class="no">loc_44A88C</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0041</span><span class="nf">A2D3</span>                 <span class="no">lea</span>     <span class="no">esi</span><span class="p">,</span> <span class="p">[</span><span class="no">edi</span><span class="err">+</span><span class="mi">40</span><span class="no">h</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0041</span><span class="nf">A2D6</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0041</span><span class="nf">A2D6</span> <span class="no">loc_41A2D6</span><span class="p">:</span>                             <span class="c1">; CODE XREF: KiAttachProcess(x,x,x,x)+30611↓j
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0041</span><span class="nf">A2D6</span>                 <span class="no">mov</span>     <span class="no">eax</span><span class="p">,</span> <span class="p">[</span><span class="no">esi</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0041</span><span class="nf">A2D8</span>                 <span class="no">cmp</span>     <span class="no">eax</span><span class="p">,</span> <span class="no">esi</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0041</span><span class="nf">A2DA</span>                 <span class="no">jnz</span>     <span class="no">loc_44A869</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0041</span><span class="nf">A2E0</span>                 <span class="no">mov</span>     <span class="no">eax</span><span class="p">,</span> <span class="p">[</span><span class="no">ebp</span><span class="err">+</span><span class="no">arg_C</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0041</span><span class="nf">A2E3</span>                 <span class="no">push</span>    <span class="no">dword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">eax</span><span class="err">+</span><span class="mi">10</span><span class="no">h</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0041</span><span class="nf">A2E6</span>                 <span class="no">push</span>    <span class="no">edi</span>             <span class="c1">; 新的进程
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0041</span><span class="nf">A2E7</span>                 <span class="no">call</span>    <span class="no">_KiSwapProcess@8</span> <span class="c1">; 进程切换(即切换CR3)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="na">...</span></span></span></code></pre></div><p><code>KiSwapProcess</code>：</p>
<p>先从外部参数，获取到了将要访问的进程的Cr3，然后分别<strong>修改TSS.Cr3和KPROCESS+0x18（DirectoryTableBase）处的值</strong>，然后便完成了进程切换。可以发现，进程切换，实际上就是切换了Cr3</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00405</span><span class="nf">BA4</span> <span class="no">loc_405BA4</span><span class="p">:</span>                             <span class="c1">; CODE XREF: KiSwapProcess(x,x)+2D↑j
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00405</span><span class="nf">BA4</span>                 <span class="no">lldt</span>    <span class="no">ax</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00405</span><span class="nf">BA7</span>                 <span class="no">mov</span>     <span class="no">ecx</span><span class="p">,</span> <span class="no">large</span> <span class="no">fs</span><span class="p">:</span><span class="mi">20</span><span class="no">h</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00405</span><span class="nf">BAE</span>                 <span class="no">lea</span>     <span class="no">ecx</span><span class="p">,</span> <span class="p">[</span><span class="no">ecx</span><span class="err">+</span><span class="mi">420</span><span class="no">h</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00405</span><span class="nf">BB4</span>                 <span class="no">call</span>    <span class="err">@</span><span class="no">KeReleaseQueuedSpinLockFromDpcLevel@4</span> <span class="c1">; KeReleaseQueuedSpinLockFromDpcLevel(x)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00405</span><span class="nf">BB9</span>                 <span class="no">mov</span>     <span class="no">ecx</span><span class="p">,</span> <span class="no">large</span> <span class="no">fs</span><span class="p">:</span><span class="mi">40</span><span class="no">h</span> <span class="c1">; 取KPCR.TSS
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00405</span><span class="nf">BC0</span>                 <span class="no">mov</span>     <span class="no">edx</span><span class="p">,</span> <span class="p">[</span><span class="no">esp</span><span class="err">+</span><span class="no">arg_0</span><span class="p">]</span> <span class="c1">; 取新的KPROCESS
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00405</span><span class="nf">BC4</span>                 <span class="no">xor</span>     <span class="no">eax</span><span class="p">,</span> <span class="no">eax</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00405</span><span class="nf">BC6</span>                 <span class="no">mov</span>     <span class="no">gs</span><span class="p">,</span> <span class="no">eax</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00405</span><span class="nf">BC8</span>                 <span class="no">mov</span>     <span class="no">eax</span><span class="p">,</span> <span class="p">[</span><span class="no">edx</span><span class="err">+</span><span class="mi">18</span><span class="no">h</span><span class="p">]</span>  <span class="c1">; 获取新进程的KPRCESS+0x18(DirectoryTableBase)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00405</span><span class="nf">BCB</span>                 <span class="no">mov</span>     <span class="p">[</span><span class="no">ecx</span><span class="err">+</span><span class="mi">1</span><span class="no">Ch</span><span class="p">],</span> <span class="no">eax</span>  <span class="c1">; 要读取进程的CR3
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00405</span><span class="nf">BCE</span>                 <span class="no">mov</span>     <span class="no">cr3</span><span class="p">,</span> <span class="no">eax</span>        <span class="c1">; 修改CR3
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00405</span><span class="nf">BD1</span>                 <span class="no">mov</span>     <span class="no">ax</span><span class="p">,</span> <span class="p">[</span><span class="no">edx</span><span class="err">+</span><span class="mi">30</span><span class="no">h</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00405</span><span class="nf">BD5</span>                 <span class="no">mov</span>     <span class="p">[</span><span class="no">ecx</span><span class="err">+</span><span class="mi">66</span><span class="no">h</span><span class="p">],</span> <span class="no">ax</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00405</span><span class="nf">BD9</span>                 <span class="no">retn</span>    <span class="mi">8</span></span></span></code></pre></div><h4 id="ntreadvirtualmemory总结" class="heading-element"><span>NtReadVirtualMemory总结</span>
  <a href="#ntreadvirtualmemory%e6%80%bb%e7%bb%93" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h4><p><code>NtReadVirtualMemory</code>主要做了两件事：</p>
<ul>
<li><strong>修改线程养父母</strong></li>
<li><strong>修改进程Cr3</strong></li>
</ul>
<p><strong>思考</strong>：可不可以只修改Cr3而不修改养父母？
<strong>答案</strong>：不可以，假设刚刚修改完Cr3，还没读取内存时，发生了线程切换，当再次切换回来时，会根据养父母的值为Cr3赋值，Cr3又变回了原来的值，此时将变成自己读自己。如果我们自己来写这个代码，在切换Cr3后关闭中断，并且不调用会导致线程切换的API,就可以不用修改养父母的值</p>
<h3 id="进程挂靠总结" class="heading-element"><span>进程挂靠总结</span>
  <a href="#%e8%bf%9b%e7%a8%8b%e6%8c%82%e9%9d%a0%e6%80%bb%e7%bb%93" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><ol>
<li>正常情况下，当前线程使用的Cr3是由其所属进程提供的（<code>_ETHREAD.Tcb.ApcState.Process</code>），正是因为如此，A进程中的线程只能访问A的内存</li>
<li>如果要让A进程中的线程能够访问B进程的内存，就必须要修改Cr3的值为B进程的页目录表基址(B.DirectoryTableBase)，这就是所谓的“进程挂靠”</li>
</ol>
<h2 id="013跨进程读写内存" class="heading-element"><span>013.跨进程读写内存</span>
  <a href="#013%e8%b7%a8%e8%bf%9b%e7%a8%8b%e8%af%bb%e5%86%99%e5%86%85%e5%ad%98" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><p>如果如下操作的话，读取的内容还是放到了B进程的空间</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nf">mov</span> <span class="no">cr3</span><span class="p">,</span><span class="no">B.DirectoryTableBase</span>		<span class="c1">//切换Cr3的值为B进程
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nf">mov</span> <span class="no">eax</span><span class="p">,</span><span class="no">dword</span> <span class="no">ptr</span> <span class="no">ds</span><span class="p">:[</span><span class="mi">0x12345678</span><span class="p">]</span>		<span class="c1">//将进程B 0x12345678的值存的eax中
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nf">mov</span> <span class="no">dword</span> <span class="no">ptr</span> <span class="no">ds</span><span class="p">:[</span><span class="mi">0x00401234</span><span class="p">],</span><span class="no">eax</span>		<span class="c1">//将数据存储到0x00401234中
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nf">mov</span> <span class="no">cr3</span><span class="p">,</span><span class="no">A.DirectoryTableBase</span>		<span class="err">//切换回</span><span class="no">Cr3的值</span>	 </span></span></code></pre></div><h3 id="ntreadvirtualmemory跨进程读" class="heading-element"><span>NtReadVirtualMemory跨进程读</span>
  <a href="#ntreadvirtualmemory%e8%b7%a8%e8%bf%9b%e7%a8%8b%e8%af%bb" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p>执行流程：</p>
<ol>
<li>将<strong>当前线程</strong>的Cr3切换至<strong>目标进程</strong>的Cr3</li>
<li>将要读的数据复制到<strong>高2G</strong>（暂存区）</li>
<li>将<strong>当前线程</strong>的Cr3切换至<strong>原本进程</strong>的Cr3</li>
<li>将要读的数据从<strong>高2G</strong>复制到<strong>目标位置</strong></li>
</ol>
<h3 id="ntwritevirtualmemory跨进程写" class="heading-element"><span>NtWriteVirtualMemory跨进程写</span>
  <a href="#ntwritevirtualmemory%e8%b7%a8%e8%bf%9b%e7%a8%8b%e5%86%99" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><ol>
<li>将当前线程的数据复制到<strong>高2G</strong>（暂存区）</li>
<li>将<strong>当前线程</strong>的Cr3切换至<strong>目标进程</strong>的Cr3</li>
<li>将要写入的数据从<strong>高2G</strong>复制到<strong>目标位置</strong></li>
<li>将<strong>当前线程</strong>的Cr3切换至<strong>原本进程</strong>的Cr3</li>
</ol>
</div><div class="post-footer" id="post-footer">
  <div class="post-info">
    <div class="post-info-line">
      <div class="post-info-mod">
        <span title="更新于 2023-02-18 00:00:00">更新于 2023-02-18&nbsp;</span>
      </div><div class="post-info-license">
            <span><a rel="license external nofollow noopener noreferrer" href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a></span>
          </div></div><div class="post-info-line">
        <div class="post-info-md"></div>
        <div class="post-info-share">
          <span><a href="javascript:void(0);" title="分享到 X" data-sharer="twitter" data-url="http://ghostasky.github.io/posts/2023-2-winkernel%E8%BF%9B%E7%A8%8B%E7%BA%BF%E7%A8%8B/" data-title="Windows内核(四)——进程线程" data-hashtags="Win32"><i class="fa-brands fa-x-twitter fa-fw" aria-hidden="true"></i></a>
  <a href="javascript:void(0);" title="分享到 Facebook" data-sharer="facebook" data-url="http://ghostasky.github.io/posts/2023-2-winkernel%E8%BF%9B%E7%A8%8B%E7%BA%BF%E7%A8%8B/" data-hashtag="Win32"><i class="fa-brands fa-facebook-square fa-fw" aria-hidden="true"></i></a>
  <a href="javascript:void(0);" title="分享到 微博" data-sharer="weibo" data-url="http://ghostasky.github.io/posts/2023-2-winkernel%E8%BF%9B%E7%A8%8B%E7%BA%BF%E7%A8%8B/" data-title="Windows内核(四)——进程线程"><i class="fa-brands fa-weibo fa-fw" aria-hidden="true"></i></a>
  </span>
        </div>
      </div></div>

  <div class="post-info-more">
    <section class="post-tags"><i class="fa-solid fa-tags fa-fw me-1" aria-hidden="true"></i><a href="/tags/win32/" class="post-tag" title="标签 - Win32">Win32</a></section>
    <section>
      <span><a href="javascript:void(0);" onclick="window.history.back();">返回</a></span>&nbsp;|&nbsp;<span><a href="/">主页</a></span>
    </section>
  </div>

  <div class="post-nav"><a href="/posts/%E5%A4%A7%E5%AD%A6%E4%B9%8B%E8%B7%AF/" class="post-nav-item" rel="prev" title="《大学之路》书摘_吴军"><i class="fa-solid fa-angle-left fa-fw" aria-hidden="true"></i>《大学之路》书摘_吴军</a>
      <a href="/posts/2023-2-winkernel%E5%8F%A5%E6%9F%84%E8%A1%A8/" class="post-nav-item" rel="next" title="Windows内核(五)——句柄表">Windows内核(五)——句柄表<i class="fa-solid fa-angle-right fa-fw" aria-hidden="true"></i></a></div>
</div>
</article>

  <aside class="toc" id="toc-auto" aria-label="目录"><h2 class="toc-title">目录&nbsp;<i class="toc-icon fa-solid fa-angle-down fa-fw" aria-hidden="true"></i></h2>
      <div class="toc-content" id="toc-content-auto"></div></aside></main><footer class="footer">
    <div class="footer-container"><div class="footer-line powered">由 <a href="https://gohugo.io/" target="_blank" rel="external nofollow noopener noreferrer" title="Hugo 0.124.1"><img class="hugo-icon" src="/images/hugo.min.svg" alt="Hugo logo" /> Hugo</a> 强力驱动 | 主题 - <a href="https://github.com/hugo-fixit/FixIt" target="_blank" rel="external" title="FixIt v0.3.8-RC"><img class="fixit-icon" src="/images/fixit.min.svg" alt="FixIt logo" /> FixIt</a>
        </div><div class="footer-line copyright" itemscope itemtype="http://schema.org/CreativeWork"><i class="fa-regular fa-copyright fa-fw" aria-hidden="true"></i>
            <span itemprop="copyrightYear">2024</span><span class="author" itemprop="copyrightHolder">
              <a href="/">Ghostasky</a></span></div></div>
  </footer></div><div class="widgets"><div class="fixed-buttons animate__faster d-none"><div class="fixed-button back-to-top" role="button" aria-label="回到顶部"><i class="fa-solid fa-arrow-up fa-fw" aria-hidden="true"></i><span class="variant-numeric d-none">0%</span>
        </div></div><div id="mask"></div><noscript>
    <div class="noscript-warning">该网站在启用 JavaScript 的情况下效果最佳。</div>
  </noscript>
</div><link rel="preload" href="/lib/katex/katex.min.css" as="style" onload="this.removeAttribute('onload');this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="/lib/katex/katex.min.css"></noscript><link rel="stylesheet" href="/lib/cookieconsent/cookieconsent.min.css"><script src="/lib/sharer/sharer.min.js" async defer></script><script src="/lib/typeit/index.umd.js" defer></script><script src="/lib/katex/katex.min.js" defer></script><script src="/lib/katex/auto-render.min.js" defer></script><script src="/lib/katex/copy-tex.min.js" defer></script><script src="/lib/katex/mhchem.min.js" defer></script><script src="/lib/cookieconsent/cookieconsent.min.js" defer></script><script>window.config={"code":{"copyTitle":"复制到剪贴板","editLockTitle":"锁定可编辑代码块","editUnLockTitle":"解锁可编辑代码块","editable":true,"maxShownLines":10},"comment":{"enable":false},"cookieconsent":{"content":{"dismiss":"同意","link":"了解更多","message":"本网站使用 Cookies 来改善您的浏览体验。"},"enable":true,"palette":{"button":{"background":"#f0f0f0"},"popup":{"background":"#1aa3ff"}},"theme":"edgeless"},"math":{"delimiters":[{"display":true,"left":"$$","right":"$$"},{"display":true,"left":"\\[","right":"\\]"},{"display":true,"left":"\\begin{equation}","right":"\\end{equation}"},{"display":true,"left":"\\begin{equation*}","right":"\\end{equation*}"},{"display":true,"left":"\\begin{align}","right":"\\end{align}"},{"display":true,"left":"\\begin{align*}","right":"\\end{align*}"},{"display":true,"left":"\\begin{alignat}","right":"\\end{alignat}"},{"display":true,"left":"\\begin{alignat*}","right":"\\end{alignat*}"},{"display":true,"left":"\\begin{gather}","right":"\\end{gather}"},{"display":true,"left":"\\begin{CD}","right":"\\end{CD}"},{"display":false,"left":"$","right":"$"},{"display":false,"left":"\\(","right":"\\)"}],"strict":false},"typeit":{"cursorChar":"|","cursorSpeed":1000,"duration":-1,"loop":false,"speed":100},"version":"v0.3.8-RC"};</script><script src="/js/theme.min.js" defer></script></body>
</html>
