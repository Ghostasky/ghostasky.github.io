<!DOCTYPE html>
<html itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">
  <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
    
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
    <meta name="robots" content="noodp" />
    <title>Windows内核(七)——APC机制 - Ghostasky&#39;s Blog</title><meta name="author" content="">
<meta name="author-link" content="">
<meta name="description" content="" /><meta name="keywords" content='Win32' /><meta itemprop="name" content="Windows内核(七)——APC机制">
<meta itemprop="description" content=""><meta itemprop="datePublished" content="2023-02-26T00:00:00+00:00" />
<meta itemprop="dateModified" content="2023-02-26T00:00:00+00:00" />
<meta itemprop="wordCount" content="10002">
<meta itemprop="keywords" content="Win32," /><meta property="og:title" content="Windows内核(七)——APC机制" />
<meta property="og:description" content="" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://localhost:1313/posts/2023-2-winkernelapc/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-02-26T00:00:00+00:00" />
<meta property="article:modified_time" content="2023-02-26T00:00:00+00:00" />
<meta name="twitter:card" content="summary"/><meta name="twitter:title" content="Windows内核(七)——APC机制"/>
<meta name="twitter:description" content=""/>
<meta name="application-name" content="FixIt">
<meta name="apple-mobile-web-app-title" content="FixIt"><meta name="theme-color" data-light="#f8f8f8" data-dark="#252627" content="#f8f8f8"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="canonical" href="http://localhost:1313/posts/2023-2-winkernelapc/" /><link rel="prev" href="http://localhost:1313/posts/2023-2-winkernel%E4%BA%8B%E4%BB%B6%E7%AD%89%E5%BE%85/" /><link rel="next" href="http://localhost:1313/posts/2023-3-winkernel%E5%BC%82%E5%B8%B8/" /><link rel="stylesheet" href="/css/style.min.css"><link rel="preload" href="/lib/fontawesome-free/all.min.css" as="style" onload="this.removeAttribute('onload');this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"></noscript><link rel="preload" href="/lib/animate/animate.min.css" as="style" onload="this.removeAttribute('onload');this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="/lib/animate/animate.min.css"></noscript><script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "BlogPosting",
    "headline": "Windows内核(七)——APC机制",
    "inLanguage": "zh-CN",
    "mainEntityOfPage": {
      "@type": "WebPage",
      "@id": "http:\/\/localhost:1313\/posts\/2023-2-winkernelapc\/"
    },"genre": "posts","keywords": "Win32","wordcount":  10002 ,
    "url": "http:\/\/localhost:1313\/posts\/2023-2-winkernelapc\/","datePublished": "2023-02-26T00:00:00+00:00","dateModified": "2023-02-26T00:00:00+00:00","publisher": {
      "@type": "Organization",
      "name": ""},"author": {
        "@type": "Person",
        "name": "作者"
      },"description": ""
  }
  </script></head>
  <body data-header-desktop="sticky" data-header-mobile="auto"><script>(window.localStorage?.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('auto' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'auto' === 'dark')) && document.body.setAttribute('data-theme', 'dark');</script><div class="wrapper" data-page-style="normal"><header class="desktop animate__faster" id="header-desktop">
  <div class="header-wrapper">
    <div class="header-title">
      <a href="/" title="Ghostasky&#39;s Blog"><img loading="lazy" src="/images/fixit.png" alt="Ghostasky&#39;s Blog" data-title="Ghostasky&#39;s Blog" class="logo" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/><span class="header-title-text">Ghostasky&#39;s Blog</span></a><span class="header-subtitle"></span></div>
    <nav>
      <ul class="menu"><li class="menu-item">
              <a
                class="menu-link"
                href="/posts/"
                
                
              >文章</a></li><li class="menu-item">
              <a
                class="menu-link"
                href="/categories/"
                
                
              >分类</a></li><li class="menu-item">
              <a
                class="menu-link"
                href="/tags/"
                
                
              >标签</a></li><li class="menu-item">
              <a
                class="menu-link"
                href="/about/"
                
                
              >关于</a></li><li class="menu-item delimiter"></li><li class="menu-item theme-switch" title="切换主题">
          <i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i>
        </li></ul>
    </nav>
  </div>
</header><header class="mobile animate__faster" id="header-mobile">
  <div class="header-container">
    <div class="header-wrapper">
      <div class="header-title">
        <a href="/" title="Ghostasky&#39;s Blog"><img loading="lazy" src="/images/fixit.png" alt="/images/fixit.png" data-title="/images/fixit.png" class="logo" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/><span class="header-title-text">Ghostasky&#39;s Blog</span></a><span class="header-subtitle"></span></div>
      <div class="menu-toggle" id="menu-toggle-mobile">
        <span></span><span></span><span></span>
      </div>
    </div>
    <nav>
      <ul class="menu" id="menu-mobile"><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/posts/"
                  
                  
                >文章</a></li><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/categories/"
                  
                  
                >分类</a></li><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/tags/"
                  
                  
                >标签</a></li><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/about/"
                  
                  
                >关于</a></li><li class="menu-item menu-system">
          <span class="menu-system-item theme-switch" title="切换主题"><i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i></span></li>
      </ul>
    </nav>
  </div>
</header><main class="container"><aside class="aside-collection animate__animated animate__fadeIn animate__faster" aria-label="合集"></aside>

  <article class="page single">
    <div class="header"><h1 class="single-title animate__animated animate__flipInX"><span>Windows内核(七)——APC机制</span>
      </h1></div><div class="post-meta">
      <div class="post-meta-line"><span class="post-author"><span class="author"><i class="fa-solid fa-user-circle" aria-hidden="true"></i>
      Anonymous</span></span><span class="post-included-in">&nbsp;收录于 <a href="/categories/technology/" class="post-category" title="分类 - Technology"><i class="fa-regular fa-folder fa-fw" aria-hidden="true"></i> Technology</a></span></div><div class="post-meta-line"><span title="发布于 2023-02-26 00:00:00"><i class="fa-solid fa-calendar-days fa-fw me-1" aria-hidden="true"></i><time datetime="2023-02-26">2023-02-26</time></span>&nbsp;<span title="10002 字"><i class="fa-solid fa-pencil-alt fa-fw me-1" aria-hidden="true"></i>约 10100 字</span>&nbsp;<span><i class="fa-regular fa-clock fa-fw me-1" aria-hidden="true"></i>预计阅读 20 分钟</span>&nbsp;</div>
    </div><div class="details toc" id="toc-static" data-kept="false">
        <div class="details-summary toc-title">
          <span>目录</span>
          <span><i class="details-icon fa-solid fa-angle-right" aria-hidden="true"></i></span>
        </div>
        <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#01apc的本质">01.APC的本质</a>
      <ul>
        <li><a href="#apc队列">APC队列</a></li>
        <li><a href="#apc结构">APC结构</a></li>
        <li><a href="#kiserviceexit">KiServiceExit</a></li>
      </ul>
    </li>
    <li><a href="#02备用apc队列">02.备用APC队列</a>
      <ul>
        <li><a href="#savedapcstate">SavedApcState</a></li>
        <li><a href="#apcstateindex">ApcStateIndex</a></li>
        <li><a href="#apcstatepointer">ApcStatePointer</a></li>
        <li><a href="#apcqueueable">ApcQueueable</a></li>
      </ul>
    </li>
    <li><a href="#03apc挂入过程">03.APC挂入过程</a>
      <ul>
        <li><a href="#挂入过程">挂入过程</a></li>
      </ul>
    </li>
    <li><a href="#04内核apc执行过程">04.内核APC执行过程</a>
      <ul>
        <li><a href="#何时执行apc">何时执行APC</a></li>
        <li><a href="#内核apc执行流程">内核APC执行流程</a></li>
        <li><a href="#总结">总结</a></li>
      </ul>
    </li>
    <li><a href="#05用户apc执行过程">05.用户APC执行过程</a>
      <ul>
        <li><a href="#kideliverapc-1">KiDeliverApc</a></li>
        <li><a href="#kiinitializeuserapc">KiInitializeUserApc</a></li>
        <li><a href="#kiuserapcdispatcher">KiUserApcDispatcher</a></li>
        <li><a href="#总结-1">总结</a></li>
      </ul>
    </li>
  </ul>
</nav></div>
      </div><div class="content" id="content"><p>[toc]</p>
<h2 id="01apc的本质" class="heading-element">
  <a href="#01apc%e7%9a%84%e6%9c%ac%e8%b4%a8" class="heading-mark"></a>01.APC的本质</h2><ol>
<li>线程是不能被“杀掉”、“挂起”、“恢复”的，线程在执行的时候自己占据着CPU，别人不能控制它</li>
<li>举个极端的例子：如果不调用API，屏蔽中断，并保证代码不出现异常，线程将永久占用CPU</li>
<li>所以说线程如果想“死”，一定是自己执行代码把自己杀死，不存在“他杀”的情况</li>
</ol>
<p><strong>思考</strong>：那如果想改变一个线程的行为该怎么办
<strong>答案</strong>：可以给他提供一个函数，让它自己去调用：APC（Asyncroneus Procedure Call，异步过程调用）</p>
<h3 id="apc队列" class="heading-element">
  <a href="#apc%e9%98%9f%e5%88%97" class="heading-mark"></a>APC队列</h3><ul>
<li><code>ApcListHead</code>：
<ol>
<li>由两个双向链表组成，共占16个字节</li>
<li>提供的APC函数可能是<strong>用户函数</strong>，也可能是<strong>系统函数</strong>（简单的区分方法就是判断函数地址是否大于<strong>0x80000000</strong>）</li>
</ol>
</li>
<li><code>Process</code>：指向线程所属或者挂靠进程</li>
<li><code>KernelApcInProgress</code>：内核Apc是否正在执行</li>
<li><code>KernelApcPending</code>：是否存在等待状态的<strong>内核APC</strong>，存在则置1</li>
<li><code>UserApcPending</code>：是否存在等待状态的<strong>用户APC</strong>，存在则置1</li>
</ul>
<div class="highlight" id="id-1"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">kd</span><span class="o">&gt;</span> <span class="n">dt</span> <span class="n">_KTHREAD</span>
</span></span><span class="line"><span class="cl"><span class="n">ntdll</span><span class="o">!</span><span class="n">_KTHREAD</span>
</span></span><span class="line"><span class="cl">   <span class="p">...</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x034</span> <span class="nl">ApcState</span>         <span class="p">:</span> <span class="n">_KAPC_STATE</span>
</span></span><span class="line"><span class="cl">   <span class="p">...</span>
</span></span><span class="line"><span class="cl"><span class="n">kd</span><span class="o">&gt;</span> <span class="n">dt</span> <span class="n">_KAPC_STATE</span>
</span></span><span class="line"><span class="cl"><span class="n">ntdll</span><span class="o">!</span><span class="n">_KAPC_STATE</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x000</span> <span class="nl">ApcListHead</span>      <span class="p">:</span> <span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="n">_LIST_ENTRY</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x010</span> <span class="nl">Process</span>          <span class="p">:</span> <span class="n">Ptr32</span> <span class="n">_KPROCESS</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x014</span> <span class="nl">KernelApcInProgress</span> <span class="p">:</span> <span class="n">UChar</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x015</span> <span class="nl">KernelApcPending</span> <span class="p">:</span> <span class="n">UChar</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x016</span> <span class="nl">UserApcPending</span>   <span class="p">:</span> <span class="n">UChar</span></span></span></code></pre></div><h3 id="apc结构" class="heading-element">
  <a href="#apc%e7%bb%93%e6%9e%84" class="heading-mark"></a>APC结构</h3><div class="highlight" id="id-2"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">kd</span><span class="o">&gt;</span> <span class="n">dt</span> <span class="n">_KAPC</span>
</span></span><span class="line"><span class="cl"><span class="n">ntdll</span><span class="o">!</span><span class="n">_KAPC</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x000</span> <span class="nl">Type</span>             <span class="p">:</span> <span class="n">Int2B</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x002</span> <span class="nl">Size</span>             <span class="p">:</span> <span class="n">Int2B</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x004</span> <span class="nl">Spare0</span>           <span class="p">:</span> <span class="n">Uint4B</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x008</span> <span class="nl">Thread</span>           <span class="p">:</span> <span class="n">Ptr32</span> <span class="n">_KTHREAD</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x00c</span> <span class="nl">ApcListEntry</span>     <span class="p">:</span> <span class="n">_LIST_ENTRY</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x014</span> <span class="nl">KernelRoutine</span>    <span class="p">:</span> <span class="n">Ptr32</span>     <span class="kt">void</span> 
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x018</span> <span class="nl">RundownRoutine</span>   <span class="p">:</span> <span class="n">Ptr32</span>     <span class="kt">void</span> 
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x01c</span> <span class="nl">NormalRoutine</span>    <span class="p">:</span> <span class="n">Ptr32</span>     <span class="kt">void</span> <span class="c1">//找到提供的APC函数，并不完全等于APC函数的地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="o">+</span><span class="mh">0x020</span> <span class="nl">NormalContext</span>    <span class="p">:</span> <span class="n">Ptr32</span> <span class="n">Void</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x024</span> <span class="nl">SystemArgument1</span>  <span class="p">:</span> <span class="n">Ptr32</span> <span class="n">Void</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x028</span> <span class="nl">SystemArgument2</span>  <span class="p">:</span> <span class="n">Ptr32</span> <span class="n">Void</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x02c</span> <span class="nl">ApcStateIndex</span>    <span class="p">:</span> <span class="n">Char</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x02d</span> <span class="nl">ApcMode</span>          <span class="p">:</span> <span class="n">Char</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x02e</span> <span class="nl">Inserted</span>         <span class="p">:</span> <span class="n">UChar</span></span></span></code></pre></div><p>当前线程什么时候将会执行提供的APC</p>
<ol>
<li><code>KiServiceExit</code> 函数（<strong>系统调用</strong>、<strong>异常</strong>或<strong>中断</strong>返回用户控件的必经之路）</li>
<li><code>KiDeliverApc</code> 函数（负责<strong>执行</strong>APC函数）</li>
</ol>
<h3 id="kiserviceexit" class="heading-element">
  <a href="#kiserviceexit" class="heading-mark"></a>KiServiceExit</h3><div class="highlight" id="id-3"><pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">004069</span><span class="nf">CD</span> <span class="no">loc_4069CD</span><span class="p">:</span>                             <span class="c1">; CODE XREF: _KiServiceExit+8↑j
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">004069</span><span class="nf">CD</span>                                         <span class="c1">; _KiServiceExit+64↓j
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">004069</span><span class="nf">CD</span>                 <span class="no">mov</span>     <span class="no">ebx</span><span class="p">,</span> <span class="no">large</span> <span class="no">fs</span><span class="p">:</span><span class="mi">124</span><span class="no">h</span> <span class="c1">; 获取ETHREAD
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">004069</span><span class="nf">D4</span>                 <span class="no">mov</span>     <span class="no">byte</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">ebx</span><span class="err">+</span><span class="no">_KTHREAD.Alerted</span><span class="p">],</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">004069</span><span class="nf">D8</span>                 <span class="no">cmp</span>     <span class="no">byte</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">ebx</span><span class="err">+</span><span class="no">_KTHREAD.ApcState.UserApcPending</span><span class="p">],</span> <span class="mi">0</span> <span class="c1">; 检查是否有APC请求
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">004069</span><span class="nf">DC</span>                 <span class="no">jz</span>      <span class="no">short</span> <span class="no">loc_406A23</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">004069</span><span class="nf">DE</span>                 <span class="no">mov</span>     <span class="no">ebx</span><span class="p">,</span> <span class="no">ebp</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">004069</span><span class="nf">E0</span>                 <span class="no">mov</span>     <span class="p">[</span><span class="no">ebx</span><span class="err">+</span><span class="mi">44</span><span class="no">h</span><span class="p">],</span> <span class="no">eax</span>  <span class="c1">; 堆栈中_KTRAP_FREAME结构的eax
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">004069</span><span class="nf">E3</span>                 <span class="no">mov</span>     <span class="no">dword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">ebx</span><span class="err">+</span><span class="mi">50</span><span class="no">h</span><span class="p">],</span> <span class="mi">3</span><span class="no">Bh</span> <span class="c1">; &#39;;&#39; ; 堆栈中_KTRAP_FREAME结构的SegFs
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">004069</span><span class="nf">EA</span>                 <span class="no">mov</span>     <span class="no">dword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">ebx</span><span class="err">+</span><span class="mi">38</span><span class="no">h</span><span class="p">],</span> <span class="mi">23</span><span class="no">h</span> <span class="c1">; &#39;#&#39; ; 堆栈中_KTRAP_FREAME结构的SegDs
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">004069</span><span class="nf">F1</span>                 <span class="no">mov</span>     <span class="no">dword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">ebx</span><span class="err">+</span><span class="mi">34</span><span class="no">h</span><span class="p">],</span> <span class="mi">23</span><span class="no">h</span> <span class="c1">; &#39;#&#39; ; 堆栈中_KTRAP_FREAME结构的SegEs
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">004069</span><span class="nf">F8</span>                 <span class="no">mov</span>     <span class="no">dword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">ebx</span><span class="err">+</span><span class="mi">30</span><span class="no">h</span><span class="p">],</span> <span class="mi">0</span> <span class="c1">; 堆栈中_KTRAP_FREAME结构的SegGs
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">004069</span><span class="nf">FF</span>                 <span class="no">mov</span>     <span class="no">ecx</span><span class="p">,</span> <span class="mi">1</span>          <span class="c1">; APC_LEVEl参数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00406</span><span class="nf">A04</span>                 <span class="no">call</span>    <span class="no">ds</span><span class="p">:</span><span class="no">__imp_@KfRaiseIrql@4</span> <span class="c1">; KfRaiseIrql(x)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00406</span><span class="nf">A0A</span>                 <span class="no">push</span>    <span class="no">eax</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00406</span><span class="nf">A0B</span>                 <span class="no">sti</span>                     <span class="c1">; 关中断
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00406</span><span class="nf">A0C</span>                 <span class="no">push</span>    <span class="no">ebx</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00406</span><span class="nf">A0D</span>                 <span class="no">push</span>    <span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00406</span><span class="nf">A0F</span>                 <span class="no">push</span>    <span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00406</span><span class="nf">A11</span>                 <span class="no">call</span>    <span class="no">_KiDeliverApc@12</span> <span class="c1">; 执行内核APC并为用户空间的APC的执行进行准备
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00406</span><span class="nf">A16</span>                 <span class="no">pop</span>     <span class="no">ecx</span>             <span class="c1">; 将老的运行级别出栈
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00406</span><span class="nf">A17</span>                 <span class="no">call</span>    <span class="no">ds</span><span class="p">:</span><span class="no">__imp_@KfLowerIrql@4</span> <span class="c1">; 恢复原来的运行级别
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00406</span><span class="nf">A1D</span>                 <span class="no">mov</span>     <span class="no">eax</span><span class="p">,</span> <span class="p">[</span><span class="no">ebx</span><span class="err">+</span><span class="mi">44</span><span class="no">h</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00406</span><span class="nf">A20</span>                 <span class="no">cli</span>                     <span class="c1">; 开中断
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00406</span><span class="nf">A21</span>                 <span class="no">jmp</span>     <span class="no">short</span> <span class="no">loc_4069CD</span> <span class="err">;</span> <span class="err">获取</span><span class="no">ETHREAD</span></span></span></code></pre></div><h2 id="02备用apc队列" class="heading-element">
  <a href="#02%e5%a4%87%e7%94%a8apc%e9%98%9f%e5%88%97" class="heading-mark"></a>02.备用APC队列</h2><p>还是先看下线程结构体：</p>
<div class="highlight" id="id-4"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">kd</span><span class="o">&gt;</span> <span class="n">dt</span> <span class="n">_kthread</span>
</span></span><span class="line"><span class="cl"><span class="n">nt</span><span class="o">!</span><span class="n">_KTHREAD</span>
</span></span><span class="line"><span class="cl"><span class="p">...</span>
</span></span><span class="line"><span class="cl"><span class="o">+</span><span class="mh">0x034</span> <span class="nl">ApcState</span>         <span class="p">:</span> <span class="n">_KAPC_STATE</span><span class="c1">//APC
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">...</span>
</span></span><span class="line"><span class="cl"><span class="o">+</span><span class="mh">0x138</span> <span class="nl">ApcStatePointer</span>  <span class="p">:</span> <span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="n">Ptr32</span> <span class="n">_KAPC_STATE</span><span class="c1">//APC指针
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">...</span>
</span></span><span class="line"><span class="cl"><span class="o">+</span><span class="mh">0x14c</span> <span class="nl">SavedApcState</span>    <span class="p">:</span> <span class="n">_KAPC_STATE</span><span class="c1">//备用APC
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">...</span>
</span></span><span class="line"><span class="cl"><span class="o">+</span><span class="mh">0x165</span> <span class="nl">ApcStateIndex</span>    <span class="p">:</span> <span class="n">UChar</span><span class="c1">//线程状态
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">+</span><span class="mh">0x166</span> <span class="nl">ApcQueueable</span>     <span class="p">:</span> <span class="n">UChar</span><span class="c1">//当前成员是否允许插入APC
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">...</span></span></span></code></pre></div><h3 id="savedapcstate" class="heading-element">
  <a href="#savedapcstate" class="heading-mark"></a>SavedApcState</h3><ol>
<li>在 <code>_KTHREAD+0x14c</code> 位置处，同样也存在一个 <code>_KAPC_STATE</code> 结构体，叫做 <code>SavedApcState</code></li>
<li><strong>线程APC队列中的APC函数都是与进程相关联的</strong>，具体点说：A进程的T线程中的所有APC函数，要访问的内存地址都是A进程的</li>
<li>但线程是可以挂靠到其他的进程：比如A进程的线程T，通过修改Cr3(改为B进程的页目录基址)，就可以访问B进程地址空间，即所谓“进程挂靠”</li>
<li>当T线程挂靠B进程后，APC队列中存储的却仍然是原来的APC。具体点说，比如某个APC函数要读取一个地址为0x12345678的数据，如果此时进行读取，读到的将是B进程的地址空间，这样逻辑就错误了</li>
<li>为了避免混乱，在T线程挂靠B进程时，会将<code>ApcState</code>中的值暂时存储到<code>SavedApcState</code>中，等回到原进程A时，再将APC队列恢复。</li>
<li>因此，<code>SavedApcState</code>又称为备用APC队列</li>
</ol>
<pre tabindex="0"><code>A进程的T线程挂靠B进程  
	A是T的所属进程  
	B是T的挂靠进程
ApcState    	B进程相关的APC函数     
SavedApcState	A进程相关的APC函数</code></pre><h3 id="apcstateindex" class="heading-element">
  <a href="#apcstateindex" class="heading-mark"></a>ApcStateIndex</h3><p><strong>ApcStateIndex</strong> 用来标识当前线程处于什么状态，位于 <strong>_KTHREAD+0x165</strong></p>
<p><strong>0</strong>：正常状态
<strong>1</strong>：挂靠状态</p>
<h3 id="apcstatepointer" class="heading-element">
  <a href="#apcstatepointer" class="heading-mark"></a>ApcStatePointer</h3><p>为了操作方便，<strong>_KTHREAD</strong> 结构体中定义了一个指针数组 <strong>ApcStatePointer</strong> ，长度为2，位于 <strong>_KTHREAD+0x138</strong></p>
<p>正常情况下：</p>
<ul>
<li><code>ApcStatePointer[0]</code> 指向 ApcState</li>
<li><code>ApcStatePointer[1]</code> 指向 SavedApcState</li>
</ul>
<p>挂靠情况下：</p>
<ul>
<li><code>ApcStatePointer[0]</code> 指向 SavedApcState</li>
<li><code>ApcStatePointer[1]</code> 指向 ApcState</li>
</ul>
<h4 id="组合寻址" class="heading-element">
  <a href="#%e7%bb%84%e5%90%88%e5%af%bb%e5%9d%80" class="heading-mark"></a>组合寻址</h4><p>这样和<code>ApcStateIndex</code>就可以组合寻址了：</p>
<p>正常情况下，向<code>ApcState</code>队列中插入APC时：</p>
<ul>
<li><code>ApcStatePointer[0]</code> 指向 <code>ApcState</code>，此时 <code>ApcStateIndex</code> 的值为 0</li>
<li><code>ApcStatePointer[ApcStateIndex]</code> 指向 <code>ApcState</code></li>
</ul>
<p>挂靠情况下，向<code>ApcState</code>队列中插入APC时：</p>
<ul>
<li><code>ApcStatePointer[1]</code> 指向 <code>ApcState</code>，此时 <code>ApcStateIndex</code> 的值为 1</li>
<li><code>ApcStatePointer[ApcStateIndex]</code> 指向 <code>ApcState</code></li>
</ul>
<p>总结下来就是，无论什么环境下，<strong>ApcStatePointer[ApcStateIndex]</strong> 指向的都是 <strong>ApcState</strong>
<strong>ApcState</strong> 总是表示线程当前使用的apc状态</p>
<h3 id="apcqueueable" class="heading-element">
  <a href="#apcqueueable" class="heading-mark"></a>ApcQueueable</h3><ol>
<li>位于 <code>_KTHREAD+0x166</code>，表示是否可以向线程的APC队列中插入APC</li>
<li>当线程正在执行退出的代码时，会将这个值设置为0 ，如果此时执行插入APC的代码（<code>KeInsertQueueApc</code>），在插入函数中会判断这个值的状态，如果为0，则插入失败</li>
</ol>
<h2 id="03apc挂入过程" class="heading-element">
  <a href="#03apc%e6%8c%82%e5%85%a5%e8%bf%87%e7%a8%8b" class="heading-mark"></a>03.APC挂入过程</h2><ol>
<li>无论是正常状态还是挂靠状态，都有两个APC队列，一个<strong>内核队列</strong>，一个<strong>用户队列</strong></li>
<li>每当要挂入一个APC函数时，不管是内核APC还是用户APC，内核都要准备一个<strong>KAPC</strong>的数据结构，并且将这个KAPC结构挂到相应的APC队列中</li>
</ol>
<div class="highlight" id="id-6"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">kd</span><span class="o">&gt;</span> <span class="n">dt</span> <span class="n">_KAPC</span>
</span></span><span class="line"><span class="cl"><span class="n">ntdll</span><span class="o">!</span><span class="n">_KAPC</span>
</span></span><span class="line"><span class="cl">	<span class="o">+</span><span class="mh">0x000</span> <span class="nl">Type</span>             <span class="p">:</span> <span class="n">Int2B</span>				<span class="c1">//类型 APC类型为0x12
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="o">+</span><span class="mh">0x002</span> <span class="nl">Size</span>             <span class="p">:</span> <span class="n">Int2B</span>				<span class="c1">//本结构体的大小  0x30
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="o">+</span><span class="mh">0x004</span> <span class="nl">Spare0</span>           <span class="p">:</span> <span class="n">Uint4B</span>			<span class="c1">//未使用
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="o">+</span><span class="mh">0x008</span> <span class="nl">Thread</span>           <span class="p">:</span> <span class="n">Ptr32</span> <span class="n">_KTHREAD</span>	<span class="c1">//目标线程
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="o">+</span><span class="mh">0x00c</span> <span class="nl">ApcListEntry</span>     <span class="p">:</span> <span class="n">_LIST_ENTRY</span>		<span class="c1">//APC队列挂的位置
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="o">+</span><span class="mh">0x014</span> <span class="nl">KernelRoutine</span>    <span class="p">:</span> <span class="n">Ptr32</span>     <span class="kt">void</span> 	<span class="c1">//指向一个函数(调用ExFreePoolWithTag)APC执行完毕后，释放本结构内存
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="o">+</span><span class="mh">0x018</span> <span class="nl">RundownRoutine</span>   <span class="p">:</span> <span class="n">Ptr32</span>     <span class="kt">void</span> 	<span class="c1">//略
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="o">+</span><span class="mh">0x01c</span> <span class="nl">NormalRoutine</span>    <span class="p">:</span> <span class="n">Ptr32</span>     <span class="kt">void</span> 	<span class="c1">//用户APC总入口  或者 真正的内核apc函数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="o">+</span><span class="mh">0x020</span> <span class="nl">NormalContext</span>    <span class="p">:</span> <span class="n">Ptr32</span> <span class="n">Void</span>		<span class="c1">//内核APC：NULL  用户APC：真正的APC函数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="o">+</span><span class="mh">0x024</span> <span class="nl">SystemArgument1</span>  <span class="p">:</span> <span class="n">Ptr32</span> <span class="n">Void</span>		<span class="c1">//APC函数的参数1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="o">+</span><span class="mh">0x028</span> <span class="nl">SystemArgument2</span>  <span class="p">:</span> <span class="n">Ptr32</span> <span class="n">Void</span>		<span class="c1">//APC函数的参数2
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="o">+</span><span class="mh">0x02c</span> <span class="nl">ApcStateIndex</span>    <span class="p">:</span> <span class="n">Char</span>				<span class="c1">//挂哪个队列，有四个值：0 1 2 3
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="o">+</span><span class="mh">0x02d</span> <span class="nl">ApcMode</span>          <span class="p">:</span> <span class="n">Char</span>				<span class="c1">//内核APC 用户APC
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="o">+</span><span class="mh">0x02e</span> <span class="nl">Inserted</span>         <span class="p">:</span> <span class="n">UChar</span>				<span class="c1">//表示本apc是否已挂入队列 挂入前：0  挂入后  1
</span></span></span></code></pre></div><ul>
<li><strong>NormalRoutine</strong>:
<ul>
<li>如果当前的APC是内核APC，通过它就能找到内核APC函数。</li>
<li>如果当前的APC是用户APC，通过它找到的只是<strong>用户APC的总入口</strong>并不是用户APC函数。</li>
</ul>
</li>
<li><strong>NormalContext</strong>：如果是内核APC这个值为空；如果是用户APC这个值执行的就是用户APC函数</li>
<li><strong>+0x02c ApcStateIndex</strong>（<strong>KTHREAD(+0x165)</strong> 的属性同名，但含义不一样）：
<ul>
<li>=0：原始环境</li>
<li>=1：挂靠环境</li>
<li>=2：当前环境</li>
<li>=3：插入APC时的当前环境</li>
</ul>
</li>
</ul>
<h3 id="挂入过程" class="heading-element">
  <a href="#%e6%8c%82%e5%85%a5%e8%bf%87%e7%a8%8b" class="heading-mark"></a>挂入过程</h3><ul>
<li><strong>用户层调用</strong>：<code>QueueUserAPC</code>（kernel32.dll）=&gt;<code>NtQueueApcThread</code>（ntosker.exe）=&gt;内核层</li>
<li><strong>很多内核函数调用</strong>：<code>KeInitializeApc</code>（分配空间，初始化KAPC结构体）=&gt;<code>KeInsertQueueApc</code>=&gt;<code>KiInsertQueueApc</code>（将KAPC插入指定APC队列）</li>
</ul>
<h4 id="keinitializeapc" class="heading-element">
  <a href="#keinitializeapc" class="heading-mark"></a>KeInitializeApc</h4><div class="highlight" id="id-7"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">VOID</span> <span class="nf">KeInitializeApc</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span>
</span></span><span class="line"><span class="cl">	<span class="n">IN</span> <span class="n">PKAPC</span> <span class="n">Apc</span><span class="p">,</span>							<span class="c1">//KAPC指针
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">IN</span> <span class="n">PKTHREAD</span> <span class="n">Thread</span><span class="p">,</span>						<span class="c1">//目标线程
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">IN</span> <span class="n">KAPC_ENVIRONMENT</span> <span class="n">TargetEnvironment</span><span class="p">,</span>	<span class="c1">//0 1 2 3四种状态
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">IN</span> <span class="n">PKKERNEL_ROUTINE</span> <span class="n">KernelRoutine</span><span class="p">,</span>		<span class="c1">//销毁KAPC的函数地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">IN</span> <span class="n">PKRUNDOWN_ROUTINE</span> <span class="n">RundownRoutine</span> <span class="n">OPTIONAL</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="n">IN</span> <span class="n">PKNORMAL_ROUTINE</span> <span class="n">NormalRoutine</span><span class="p">,</span>		<span class="c1">//用户APC总入口或者内核apc函数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">IN</span> <span class="n">KPROCESSOR_MODE</span> <span class="n">Mode</span><span class="p">,</span>				<span class="c1">//要插入用户apc队列还是内核apc队列
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">IN</span> <span class="n">PVOID</span> <span class="n">Context</span>						<span class="c1">//内核APC：NULL  用户APC：真正的APC函数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">)</span> 
</span></span></code></pre></div><ol>
<li><code>Thread</code>传进来会挂到 <code>_KAPC.0x8 Thread</code></li>
<li><code>TargetEnvironment</code> 传进来会挂到<code>_KAPC.0x2c ApcStateIndex</code></li>
<li><code>KernelRoutine</code> 传进来会挂到<code>_KAPC.0x14 KernelPoutine</code></li>
<li><code>NormalRoutine</code> 传进来会挂到<code>_KAPC.0x1c NormalRoutine</code></li>
<li><code>Mode</code> 传进来会挂到<code>_KAPC.0x2d ApcMode</code></li>
<li><code>Context</code> 传进来会挂到<code>_KAPC.0x20 NormalRoutine</code></li>
</ol>
<h5 id="apcstateindex-1" class="heading-element">
  <a href="#apcstateindex-1" class="heading-mark"></a>ApcStateIndex</h5><p>0表示原始环境，1表示挂靠环境，这两个比较好理解，下面说一下2和3：</p>
<p>当值为2的时候，插入的是当前进程的队列。什么是当前队列，是我不管你环境是挂靠还是不挂靠，我就插入当前进程的<code>APC</code>队列里面，以初始化<code>APC</code>的时候为基准。</p>
<p>当值为3时，插入的是当前进程的<code>APC</code>队列，此时有修复<code>ApcStateIndex</code>的操作，以插入<code>APC</code>的时候为基准。</p>
<h4 id="keinsertqueueapc" class="heading-element">
  <a href="#keinsertqueueapc" class="heading-mark"></a>KeInsertQueueApc</h4><ol>
<li>根据<code>KAPC</code>结构中的<code>ApcStateIndex</code>找到对应的APC队列</li>
<li>再根据<code>KAPC</code>结构中的<code>ApcMode</code>确定是用户队列还是内核队列</li>
<li>将<code>KAPC</code>挂到对应的队列中(挂到<code>KAPC</code>的<code>ApcListEntry</code>处)</li>
<li>再根据<code>KAPC</code>结构中的<code>Inserted</code>置1，标识当前的KAPC为已插入状态</li>
<li>修改<code>KAPC_STATE</code>结构中的<code>KernelApcPending</code>/<code>UserApcPending</code></li>
</ol>
<div class="highlight" id="id-8"><pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00402</span><span class="nf">C6A</span> <span class="no">var_4</span>           <span class="err">=</span> <span class="no">dword</span> <span class="no">ptr</span> <span class="p">-</span><span class="mi">4</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00402</span><span class="nf">C6A</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00402</span><span class="nf">C6A</span> <span class="c1">; FUNCTION CHUNK AT .text:0040EEB3 SIZE 00000031 BYTES
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00402</span><span class="nf">C6A</span> <span class="c1">; FUNCTION CHUNK AT .text:0041049E SIZE 0000002C BYTES
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00402</span><span class="nf">C6A</span> <span class="c1">; FUNCTION CHUNK AT .text:004106A4 SIZE 00000031 BYTES
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00402</span><span class="nf">C6A</span> <span class="c1">; FUNCTION CHUNK AT .text:00412E89 SIZE 00000013 BYTES
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00402</span><span class="nf">C6A</span> <span class="c1">; FUNCTION CHUNK AT .text:0041C2D7 SIZE 0000001A BYTES
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00402</span><span class="nf">C6A</span> <span class="c1">; FUNCTION CHUNK AT .text:0042615A SIZE 0000000F BYTES
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00402</span><span class="nf">C6A</span> <span class="c1">; FUNCTION CHUNK AT .text:0042950C SIZE 0000001E BYTES
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00402</span><span class="nf">C6A</span> <span class="c1">; FUNCTION CHUNK AT .text:00432270 SIZE 0000000F BYTES
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00402</span><span class="nf">C6A</span> <span class="c1">; FUNCTION CHUNK AT .text:0044B3BF SIZE 0000001A BYTES
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00402</span><span class="nf">C6A</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00402</span><span class="nf">C6A</span>                 <span class="no">mov</span>     <span class="no">edi</span><span class="p">,</span> <span class="no">edi</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00402</span><span class="nf">C6C</span>                 <span class="no">push</span>    <span class="no">ebp</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00402</span><span class="nf">C6D</span>                 <span class="no">mov</span>     <span class="no">ebp</span><span class="p">,</span> <span class="no">esp</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00402</span><span class="nf">C6F</span>                 <span class="no">push</span>    <span class="no">ecx</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00402</span><span class="nf">C70</span>                 <span class="no">mov</span>     <span class="no">eax</span><span class="p">,</span> <span class="no">ecx</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00402</span><span class="nf">C72</span>                 <span class="no">cmp</span>     <span class="no">byte</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">eax</span><span class="err">+</span><span class="mi">2</span><span class="no">Eh</span><span class="p">],</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00402</span><span class="nf">C76</span>                 <span class="no">mov</span>     <span class="no">ecx</span><span class="p">,</span> <span class="p">[</span><span class="no">eax</span><span class="err">+</span><span class="mi">8</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00402</span><span class="nf">C79</span>                 <span class="no">mov</span>     <span class="p">[</span><span class="no">ebp</span><span class="err">+</span><span class="no">var_4</span><span class="p">],</span> <span class="no">edx</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00402</span><span class="nf">C7C</span>                 <span class="no">jnz</span>     <span class="no">loc_44B3BF</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00402</span><span class="nf">C82</span>                 <span class="no">cmp</span>     <span class="p">[</span><span class="no">eax</span><span class="err">+</span><span class="no">_KAPC.ApcStateIndex</span><span class="p">],</span> <span class="mi">3</span> <span class="c1">; 判断APCStateIndex是否为3
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00402</span><span class="nf">C86</span>                 <span class="no">jz</span>      <span class="no">loc_44B3C3</span>      <span class="c1">; 取出当前进程的ApcStateIndex
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00402</span><span class="nf">C8C</span>
</span></span><span class="line"><span class="cl"><span class="c1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0044</span><span class="nf">B3C3</span> <span class="no">loc_44B3C3</span><span class="p">:</span>                             <span class="c1">; CODE XREF: KiInsertQueueApc(x,x)+1C↑j
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0044</span><span class="nf">B3C3</span>                 <span class="no">mov</span>     <span class="no">dl</span><span class="p">,</span> <span class="p">[</span><span class="no">ecx</span><span class="err">+</span><span class="no">_ETHREAD.Tck.ApcStateIndex</span><span class="p">]</span> <span class="c1">; 取出当前进程的ApcStateIndex
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0044</span><span class="nf">B3C9</span>                 <span class="no">mov</span>     <span class="p">[</span><span class="no">eax</span><span class="err">+</span><span class="no">_KAPC.ApcStateIndex</span><span class="p">],</span> <span class="no">dl</span> <span class="c1">; 放入APC中
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0044</span><span class="nf">B3CC</span>                 <span class="no">jmp</span>     <span class="no">loc_402C8C</span>
</span></span><span class="line"><span class="cl"><span class="c1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00402</span><span class="nf">C8C</span> <span class="no">loc_402C8C</span><span class="p">:</span>                             <span class="c1">; CODE XREF: KiInsertQueueApc(x,x)+48762↓j
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00402</span><span class="nf">C8C</span>                 <span class="no">cmp</span>     <span class="p">[</span><span class="no">eax</span><span class="err">+</span><span class="no">_KAPC.NormalRoutine</span><span class="p">],</span> <span class="mi">0</span><span class="no">s</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00402</span><span class="nf">C90</span>                 <span class="no">movsx</span>   <span class="no">edx</span><span class="p">,</span> <span class="p">[</span><span class="no">eax</span><span class="err">+</span><span class="no">_KAPC.ApcStateIndex</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00402</span><span class="nf">C94</span>                 <span class="no">push</span>    <span class="no">ebx</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00402</span><span class="nf">C95</span>                 <span class="no">push</span>    <span class="no">esi</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00402</span><span class="nf">C96</span>                 <span class="no">push</span>    <span class="no">edi</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00402</span><span class="nf">C97</span>                 <span class="no">mov</span>     <span class="no">edi</span><span class="p">,</span> <span class="p">[</span><span class="no">ecx</span><span class="err">+</span><span class="no">edx</span><span class="p">*</span><span class="mi">4</span><span class="err">+</span><span class="no">_KTHREAD.ApcStatePointer</span><span class="p">]</span> <span class="c1">; l) 根据_ KAPC.ApcStateIndex找到要挂APC的队列: SaveApc/Apc
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00402</span><span class="nf">C9E</span>                 <span class="no">mov</span>     <span class="no">dl</span><span class="p">,</span> <span class="p">[</span><span class="no">eax</span><span class="err">+</span><span class="no">_KAPC.ApcMode</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00402</span><span class="nf">CA1</span>                 <span class="no">jnz</span>     <span class="no">loc_41049E</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00402</span><span class="nf">CA7</span>                 <span class="no">movsx</span>   <span class="no">esi</span><span class="p">,</span> <span class="no">dl</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00402</span><span class="nf">CAA</span>                 <span class="no">lea</span>     <span class="no">edi</span><span class="p">,</span> <span class="p">[</span><span class="no">edi</span><span class="err">+</span><span class="no">esi</span><span class="p">*</span><span class="mi">8</span><span class="p">]</span> <span class="c1">; 2)根据ApcMode找到是用户APC队列还是内核APC队列
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00402</span><span class="nf">CAD</span>                 <span class="no">mov</span>     <span class="no">esi</span><span class="p">,</span> <span class="p">[</span><span class="no">edi</span><span class="err">+</span><span class="mi">4</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00402</span><span class="nf">CB0</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00402</span><span class="nf">CB0</span> <span class="no">loc_402CB0</span><span class="p">:</span>                             <span class="c1">; CODE XREF: KiInsertQueueApc(x,x)+4876A↓j
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00402</span><span class="nf">CB0</span>                 <span class="no">cmp</span>     <span class="no">esi</span><span class="p">,</span> <span class="no">edi</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00402</span><span class="nf">CB2</span>                 <span class="no">jnz</span>     <span class="no">loc_42615A</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00402</span><span class="nf">CB8</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00402</span><span class="nf">CB8</span> <span class="no">loc_402CB8</span><span class="p">:</span>                             <span class="c1">; CODE XREF: KiInsertQueueApc(x,x)+234F4↓j
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00402</span><span class="nf">CB8</span>                 <span class="no">mov</span>     <span class="no">ebx</span><span class="p">,</span> <span class="p">[</span><span class="no">esi</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00402</span><span class="nf">CBA</span>                 <span class="no">lea</span>     <span class="no">edi</span><span class="p">,</span> <span class="p">[</span><span class="no">eax</span><span class="err">+</span><span class="no">_KAPC.ApcListEntry</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00402</span><span class="nf">CBD</span>                 <span class="no">mov</span>     <span class="p">[</span><span class="no">edi</span><span class="p">],</span> <span class="no">ebx</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00402</span><span class="nf">CBF</span>                 <span class="no">mov</span>     <span class="p">[</span><span class="no">edi</span><span class="err">+</span><span class="mi">4</span><span class="p">],</span> <span class="no">esi</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00402</span><span class="nf">CC2</span>                 <span class="no">mov</span>     <span class="p">[</span><span class="no">ebx</span><span class="err">+</span><span class="mi">4</span><span class="p">],</span> <span class="no">edi</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00402</span><span class="nf">CC5</span>                 <span class="no">mov</span>     <span class="p">[</span><span class="no">esi</span><span class="p">],</span> <span class="no">edi</span>      <span class="c1">; 3)将ApcStateIndex 挂到对应的队列中：ApcListEntry
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00402</span><span class="nf">CC7</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00402</span><span class="nf">CC7</span> <span class="no">loc_402CC7</span><span class="p">:</span>                             <span class="c1">; CODE XREF: KiInsertQueueApc(x,x)+D85B↓j
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00402</span><span class="nf">CC7</span>                                         <span class="c1">; KiInsertQueueApc(x,x)+268BB↓j
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00402</span><span class="nf">CC7</span>                 <span class="no">movsx</span>   <span class="no">edi</span><span class="p">,</span> <span class="p">[</span><span class="no">eax</span><span class="err">+</span><span class="no">_KAPC.ApcStateIndex</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00402</span><span class="nf">CCB</span>                 <span class="no">mov</span>     <span class="p">[</span><span class="no">eax</span><span class="err">+</span><span class="no">_KAPC.Inserted</span><span class="p">],</span> <span class="mi">1</span> <span class="c1">; 4)修改Inserted的值
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00402</span><span class="nf">CCF</span>                 <span class="no">movzx</span>   <span class="no">esi</span><span class="p">,</span> <span class="p">[</span><span class="no">ecx</span><span class="err">+</span><span class="no">_KTHREAD.ApcStateIndex</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00402</span><span class="nf">CD6</span>                 <span class="no">cmp</span>     <span class="no">edi</span><span class="p">,</span> <span class="no">esi</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00402</span><span class="nf">CD8</span>                 <span class="no">pop</span>     <span class="no">edi</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00402</span><span class="nf">CD9</span>                 <span class="no">pop</span>     <span class="no">esi</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00402</span><span class="nf">CDA</span>                 <span class="no">pop</span>     <span class="no">ebx</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00402</span><span class="nf">CDB</span>                 <span class="no">jnz</span>     <span class="no">short</span> <span class="no">loc_402D12</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00402</span><span class="nf">CDD</span>                 <span class="no">test</span>    <span class="no">dl</span><span class="p">,</span> <span class="no">dl</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00402</span><span class="nf">CDF</span>                 <span class="no">jnz</span>     <span class="no">loc_4106A4</span>      <span class="c1">; 若为用户模式APC，跳转
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00402</span><span class="nf">CE5</span>                 <span class="no">mov</span>     <span class="no">dl</span><span class="p">,</span> <span class="p">[</span><span class="no">ecx</span><span class="err">+</span><span class="no">_KTHREAD.State</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00402</span><span class="nf">CE8</span>                 <span class="no">cmp</span>     <span class="no">dl</span><span class="p">,</span> <span class="mi">2</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00402</span><span class="nf">CEB</span>                 <span class="no">mov</span>     <span class="p">[</span><span class="no">ecx</span><span class="err">+</span><span class="no">_KTHREAD.ApcState.KernelApcPending</span><span class="p">],</span> <span class="mi">1</span> <span class="c1">; 5)内核模式APC，修改KernelApcPending为1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00402</span><span class="nf">CEF</span>                 <span class="no">jnz</span>     <span class="no">loc_40EEB3</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00402</span><span class="nf">CF5</span>                 <span class="no">mov</span>     <span class="no">eax</span><span class="p">,</span> <span class="no">large</span> <span class="no">fs</span><span class="p">:</span><span class="no">_KTHREAD.Teb</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00402</span><span class="nf">CFB</span>                 <span class="no">mov</span>     <span class="no">cl</span><span class="p">,</span> <span class="p">[</span><span class="no">ecx</span><span class="err">+</span><span class="no">_KTHREAD.NextProcessor</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00402</span><span class="nf">D01</span>                 <span class="no">cmp</span>     <span class="p">[</span><span class="no">eax</span><span class="err">+</span><span class="mi">10</span><span class="no">h</span><span class="p">],</span> <span class="no">cl</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00402</span><span class="nf">D04</span>                 <span class="no">jnz</span>     <span class="no">loc_412E89</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00402</span><span class="nf">D0A</span>                 <span class="no">mov</span>     <span class="no">cl</span><span class="p">,</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00402</span><span class="nf">D0C</span>                 <span class="no">call</span>    <span class="no">ds</span><span class="p">:</span><span class="no">__imp_@HalRequestSoftwareInterrupt@4</span> <span class="c1">; HalRequestSoftwareInterrupt(x)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">004106</span><span class="nf">A4</span> <span class="c1">; START OF FUNCTION CHUNK FOR KiInsertQueueApc(x,x)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">004106</span><span class="nf">A4</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">004106</span><span class="nf">A4</span> <span class="no">loc_4106A4</span><span class="p">:</span>                             <span class="c1">; CODE XREF: KiInsertQueueApc(x,x)+75↑j
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">004106</span><span class="nf">A4</span>                 <span class="no">cmp</span>     <span class="p">[</span><span class="no">ecx</span><span class="err">+</span><span class="no">_KTHREAD.State</span><span class="p">],</span> <span class="mi">5</span> <span class="c1">; 判断线程是否为等待状态如果不是则跳转
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">004106</span><span class="nf">A8</span>                 <span class="no">jnz</span>     <span class="no">loc_402D12</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">004106</span><span class="nf">AE</span>                 <span class="no">cmp</span>     <span class="p">[</span><span class="no">ecx</span><span class="err">+</span><span class="no">_KTHREAD.WaitMode</span><span class="p">],</span> <span class="mi">1</span> <span class="c1">; 判断是否是用户导致的等待如果不是则跳转
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">004106</span><span class="nf">B2</span>                 <span class="no">jnz</span>     <span class="no">loc_402D12</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">004106</span><span class="nf">B8</span>                 <span class="no">cmp</span>     <span class="p">[</span><span class="no">ecx</span><span class="err">+</span><span class="no">_KTHREAD.Alertable</span><span class="p">],</span> <span class="mi">0</span> <span class="c1">; 判断是否可以吵醒线程(Alertble=1)如果不是 则跳转
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">004106</span><span class="nf">BF</span>                 <span class="no">jz</span>      <span class="no">loc_432270</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">004106</span><span class="nf">C5</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">004106</span><span class="nf">C5</span> <span class="no">loc_4106C5</span><span class="p">:</span>                             <span class="c1">; CODE XREF: KiInsertQueueApc(x,x)+2F610↓j
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">004106</span><span class="nf">C5</span>                 <span class="no">mov</span>     <span class="p">[</span><span class="no">ecx</span><span class="err">+</span><span class="no">_KTHREAD.ApcState.UserApcPending</span><span class="p">],</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">004106</span><span class="nf">C9</span>                 <span class="no">push</span>    <span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">004106</span><span class="nf">CB</span>                 <span class="no">mov</span>     <span class="no">edx</span><span class="p">,</span> <span class="mi">0</span><span class="no">C0h</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">004106</span><span class="nf">D0</span>                 <span class="no">jmp</span>     <span class="no">loc_40EED7</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0040</span><span class="nf">EED7</span> <span class="no">loc_40EED7</span><span class="p">:</span>                             <span class="c1">; CODE XREF: KiInsertQueueApc(x,x)+DA66↓j
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0040</span><span class="nf">EED7</span>                 <span class="no">push</span>    <span class="p">[</span><span class="no">ebp</span><span class="err">+</span><span class="no">var_4</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0040</span><span class="nf">EEDA</span>                 <span class="no">call</span>    <span class="err">@</span><span class="no">KiUnwaitThread@16</span> <span class="c1">; 将当前线程从等待链表转移到就绪列表
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0040</span><span class="nf">EEDA</span>                                         <span class="c1">; 即唤醒线程
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0040</span><span class="nf">EEDF</span>                 <span class="no">jmp</span>     <span class="no">loc_402D12</span></span></span></code></pre></div><h4 id="alertable" class="heading-element">
  <a href="#alertable" class="heading-mark"></a>Alertable</h4><p>该值指示线程是否运行被<code>APC</code>吵醒</p>
<ol>
<li><code>Alertable=0</code>，<code>UserApcPending = 0</code>：当前插入的APC函数未必有机会执行</li>
<li><code>Alertable=1</code> ，<code>UserApcPending = 1</code>：将目标线程唤醒(从等待链表中摘出来，并挂到调度链表)</li>
</ol>
<p>该属性在KTHREAD中：</p>
<div class="highlight" id="id-9"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">kd</span><span class="o">&gt;</span> <span class="n">dt</span> <span class="n">_KTHREAD</span>
</span></span><span class="line"><span class="cl"><span class="n">ntdll</span><span class="o">!</span><span class="n">_KTHREAD</span>
</span></span><span class="line"><span class="cl">   <span class="p">...</span>
</span></span><span class="line"><span class="cl">   <span class="o">+</span><span class="mh">0x164</span> <span class="nl">Alertable</span>        <span class="p">:</span> <span class="n">UChar</span>
</span></span><span class="line"><span class="cl">   <span class="p">...</span></span></span></code></pre></div><p>很多与线程相关的结尾带<code>Ex</code>的函数的参数都会有一个<code>bAlertable</code>，举例如下：</p>
<div class="highlight" id="id-10"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">DWORD</span> <span class="nf">SleepEx</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">  <span class="n">DWORD</span> <span class="n">dwMilliseconds</span><span class="p">,</span> <span class="c1">// time-out interval
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">BOOL</span> <span class="n">bAlertable</span>        <span class="c1">// early completion option
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">DWORD</span> <span class="nf">WaitForSingleObjectEx</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">  <span class="n">HANDLE</span> <span class="n">hHandle</span><span class="p">,</span>       <span class="c1">// handle to object
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">DWORD</span> <span class="n">dwMilliseconds</span><span class="p">,</span> <span class="c1">// time-out interval
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">BOOL</span> <span class="n">bAlertable</span>       <span class="c1">// alertable option
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">);</span></span></span></code></pre></div><h2 id="04内核apc执行过程" class="heading-element">
  <a href="#04%e5%86%85%e6%a0%b8apc%e6%89%a7%e8%a1%8c%e8%bf%87%e7%a8%8b" class="heading-mark"></a>04.内核APC执行过程</h2><h3 id="何时执行apc" class="heading-element">
  <a href="#%e4%bd%95%e6%97%b6%e6%89%a7%e8%a1%8capc" class="heading-mark"></a>何时执行APC</h3><p><code>APC</code>函数的执行与插入并不是同一个线程，具体点说在A线程中向B线程插入一个<code>APC</code>，插入的动作是在A线程中完成的，但什么时候执行则由B线程决定，所以叫“异步过程调用”</p>
<h4 id="线程切换" class="heading-element">
  <a href="#%e7%ba%bf%e7%a8%8b%e5%88%87%e6%8d%a2" class="heading-mark"></a>线程切换</h4><ol>
<li><code>SwapContext</code> 判断是否有内核APC</li>
<li><code>KiSwapThread</code></li>
<li><code>KiDeliverApc</code> 执行内核APC函数</li>
</ol>
<p>先看下<code>SwapContext</code>的最后部分：</p>
<div class="highlight" id="id-11"><pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl">                <span class="nf">cmp</span>     <span class="p">[</span><span class="no">esi</span><span class="err">+</span><span class="no">_KTHREAD.ApcState.KernelApcPending</span><span class="p">],</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">                <span class="nf">jnz</span>     <span class="no">short</span> <span class="no">loc_46A9BD</span>
</span></span><span class="line"><span class="cl">                <span class="nf">popf</span>
</span></span><span class="line"><span class="cl">                <span class="nf">xor</span>     <span class="no">eax</span><span class="p">,</span> <span class="no">eax</span>
</span></span><span class="line"><span class="cl">                <span class="nf">retn</span>
</span></span><span class="line"><span class="cl"><span class="c1">; ---------------------------------------------------------------------------
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="nl">loc_46A9BD:</span>                             <span class="c1">; CODE XREF: SwapContext+D7↑j
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="nf">popf</span>
</span></span><span class="line"><span class="cl">                <span class="nf">jnz</span>     <span class="no">short</span> <span class="no">loc_46A9C3</span>
</span></span><span class="line"><span class="cl">                <span class="nf">mov</span>     <span class="no">al</span><span class="p">,</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">                <span class="nf">retn</span></span></span></code></pre></div><p><code>KernelApcPending</code>是表示有没有内核<code>APC</code>处理的标志，如果是1，也就是有的话，就会使返回值置1；反之置0。</p>
<p>之后查看上一级函数：</p>
<div class="highlight" id="id-12"><pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0040581</span><span class="nf">E</span> <span class="c1">; __fastcall KiSwapContext(x)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0040581</span><span class="nf">E</span> <span class="err">@</span><span class="no">KiSwapContext@4</span> <span class="no">proc</span> <span class="no">near</span>              <span class="c1">; CODE XREF: KiSwapThread()+33↓p
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0040581</span><span class="nf">E</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0040581</span><span class="nf">E</span> <span class="no">var_10</span>          <span class="err">=</span> <span class="no">dword</span> <span class="no">ptr</span> <span class="p">-</span><span class="mi">10</span><span class="no">h</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0040581</span><span class="nf">E</span> <span class="no">var_C</span>           <span class="err">=</span> <span class="no">dword</span> <span class="no">ptr</span> <span class="p">-</span><span class="mi">0</span><span class="no">Ch</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0040581</span><span class="nf">E</span> <span class="no">var_8</span>           <span class="err">=</span> <span class="no">dword</span> <span class="no">ptr</span> <span class="p">-</span><span class="mi">8</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0040581</span><span class="nf">E</span> <span class="no">var_4</span>           <span class="err">=</span> <span class="no">dword</span> <span class="no">ptr</span> <span class="p">-</span><span class="mi">4</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0040581</span><span class="nf">E</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0040581</span><span class="nf">E</span>                 <span class="no">sub</span>     <span class="no">esp</span><span class="p">,</span> <span class="mi">10</span><span class="no">h</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00405821</span>                 <span class="nf">mov</span>     <span class="p">[</span><span class="no">esp</span><span class="err">+</span><span class="mi">10</span><span class="no">h</span><span class="err">+</span><span class="no">var_4</span><span class="p">],</span> <span class="no">ebx</span> <span class="c1">; KPCR
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00405825</span>                 <span class="nf">mov</span>     <span class="p">[</span><span class="no">esp</span><span class="err">+</span><span class="mi">10</span><span class="no">h</span><span class="err">+</span><span class="no">var_8</span><span class="p">],</span> <span class="no">esi</span> <span class="c1">; 新线程 _ETHREAD
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00405829</span>                 <span class="nf">mov</span>     <span class="p">[</span><span class="no">esp</span><span class="err">+</span><span class="mi">10</span><span class="no">h</span><span class="err">+</span><span class="no">var_C</span><span class="p">],</span> <span class="no">edi</span> <span class="c1">; 旧线程 _ETHREAD
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0040582</span><span class="nf">D</span>                 <span class="no">mov</span>     <span class="p">[</span><span class="no">esp</span><span class="err">+</span><span class="mi">10</span><span class="no">h</span><span class="err">+</span><span class="no">var_10</span><span class="p">],</span> <span class="no">ebp</span> <span class="c1">; ebp 没用
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00405830</span>                 <span class="nf">mov</span>     <span class="no">ebx</span><span class="p">,</span> <span class="no">large</span> <span class="no">fs</span><span class="p">:</span><span class="mi">1</span><span class="no">Ch</span> <span class="c1">; _KPCR.Self
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00405837</span>                 <span class="nf">mov</span>     <span class="no">esi</span><span class="p">,</span> <span class="no">ecx</span>        <span class="c1">; ecx：新线程的 _ETHREAD
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00405839</span>                 <span class="nf">mov</span>     <span class="no">edi</span><span class="p">,</span> <span class="p">[</span><span class="no">ebx</span><span class="err">+</span><span class="mi">124</span><span class="no">h</span><span class="p">]</span> <span class="c1">; edi：当前线程的 _ETHREAD
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00405839</span>                                         <span class="c1">; [ebx+_KPCR.PrcbData.CurrentThread]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0040583</span><span class="nf">F</span>                 <span class="no">mov</span>     <span class="p">[</span><span class="no">ebx</span><span class="err">+</span><span class="mi">124</span><span class="no">h</span><span class="p">],</span> <span class="no">esi</span> <span class="c1">; 修改 _KPCR，更新当前线程(124h同上
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00405845</span>                 <span class="nf">mov</span>     <span class="no">cl</span><span class="p">,</span> <span class="p">[</span><span class="no">edi</span><span class="err">+</span><span class="mi">58</span><span class="no">h</span><span class="p">]</span>   <span class="c1">; 58==[edi+_ETHREAD.Tcb.WaitIrql]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00405848</span>                 <span class="nf">call</span>    <span class="no">SwapContext</span>     <span class="c1">; 4个参数：
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00405848</span>                                         <span class="c1">; ebx: _KPCR
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00405848</span>                                         <span class="c1">; esi: 新线程 _ETHREAD
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00405848</span>                                         <span class="c1">; edi: 旧线程 _ETHREAD
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00405848</span>                                         <span class="c1">; cl:旧线程的 WaitIrql，这个参数用来控制是否执行APC
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00405848</span>                                         <span class="c1">;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00405848</span>                                         <span class="c1">; 调用 SwapContext 后，已经完成了线程切换
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00405848</span>                                         <span class="c1">; 后面就是新线程从它自己的堆栈里恢复寄存器的值的过程
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0040584</span><span class="nf">D</span>                 <span class="no">mov</span>     <span class="no">ebp</span><span class="p">,</span> <span class="p">[</span><span class="no">esp</span><span class="err">+</span><span class="mi">10</span><span class="no">h</span><span class="err">+</span><span class="no">var_10</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00405850</span>                 <span class="nf">mov</span>     <span class="no">edi</span><span class="p">,</span> <span class="p">[</span><span class="no">esp</span><span class="err">+</span><span class="mi">10</span><span class="no">h</span><span class="err">+</span><span class="no">var_C</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00405854</span>                 <span class="nf">mov</span>     <span class="no">esi</span><span class="p">,</span> <span class="p">[</span><span class="no">esp</span><span class="err">+</span><span class="mi">10</span><span class="no">h</span><span class="err">+</span><span class="no">var_8</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00405858</span>                 <span class="nf">mov</span>     <span class="no">ebx</span><span class="p">,</span> <span class="p">[</span><span class="no">esp</span><span class="err">+</span><span class="mi">10</span><span class="no">h</span><span class="err">+</span><span class="no">var_4</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0040585</span><span class="nf">C</span>                 <span class="no">add</span>     <span class="no">esp</span><span class="p">,</span> <span class="mi">10</span><span class="no">h</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0040585</span><span class="nf">F</span>                 <span class="no">retn</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0040585</span><span class="nf">F</span> <span class="err">@</span><span class="no">KiSwapContext@4</span> <span class="no">endp</span></span></span></code></pre></div><p>没有用到返回值，继续查看上一级函数：</p>
<div class="highlight" id="id-13"><pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0040</span><span class="nf">AB3B</span> <span class="no">loc_40AB3B</span><span class="p">:</span>                             <span class="c1">; CODE XREF: KiSwapThread()+5E33↓j
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0040</span><span class="nf">AB3B</span>                 <span class="no">mov</span>     <span class="no">ecx</span><span class="p">,</span> <span class="no">eax</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0040</span><span class="nf">AB3D</span>                 <span class="no">call</span>    <span class="err">@</span><span class="no">KiSwapContext@4</span> <span class="c1">; ebx: _KPCR
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0040</span><span class="nf">AB3D</span>                                         <span class="c1">; esi: 新线程 _ETHREAD
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0040</span><span class="nf">AB3D</span>                                         <span class="c1">; edi: 旧线程 _ETHREAD
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0040</span><span class="nf">AB3D</span>                                         <span class="c1">; 使用寄存器传参，因此要将使用到的寄存器暂时保存到堆栈中
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0040</span><span class="nf">AB3D</span>                                         <span class="c1">; 和push等效
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0040</span><span class="nf">AB42</span>                 <span class="no">test</span>    <span class="no">al</span><span class="p">,</span> <span class="no">al</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0040</span><span class="nf">AB44</span>                 <span class="no">mov</span>     <span class="no">cl</span><span class="p">,</span> <span class="p">[</span><span class="no">edi</span><span class="err">+</span><span class="mi">58</span><span class="no">h</span><span class="p">]</span>   <span class="c1">; NewIrql
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0040</span><span class="nf">AB47</span>                 <span class="no">mov</span>     <span class="no">edi</span><span class="p">,</span> <span class="p">[</span><span class="no">edi</span><span class="err">+</span><span class="mi">54</span><span class="no">h</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0040</span><span class="nf">AB4A</span>                 <span class="no">mov</span>     <span class="no">esi</span><span class="p">,</span> <span class="no">ds</span><span class="p">:</span><span class="no">__imp_@KfLowerIrql@4</span> <span class="c1">; KfLowerIrql(x)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0040</span><span class="nf">AB50</span>                 <span class="no">jnz</span>     <span class="no">loc_41BC76</span>
</span></span><span class="line"><span class="cl"><span class="c1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0041</span><span class="nf">BC76</span> <span class="no">loc_41BC76</span><span class="p">:</span>                             <span class="c1">; CODE XREF: KiSwapThread()+46↑j
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0041</span><span class="nf">BC76</span>                 <span class="no">mov</span>     <span class="no">cl</span><span class="p">,</span> <span class="mi">1</span>           <span class="c1">; NewIrql
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0041</span><span class="nf">BC78</span>                 <span class="no">call</span>    <span class="no">esi</span> <span class="c1">; KfLowerIrql(x) ; KfLowerIrql(x)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0041</span><span class="nf">BC7A</span>                 <span class="no">xor</span>     <span class="no">eax</span><span class="p">,</span> <span class="no">eax</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0041</span><span class="nf">BC7C</span>                 <span class="no">push</span>    <span class="no">eax</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0041</span><span class="nf">BC7D</span>                 <span class="no">push</span>    <span class="no">eax</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0041</span><span class="nf">BC7E</span>                 <span class="no">push</span>    <span class="no">eax</span><span class="c1">//第一个参数，0处理内核APC，1处理内核APC和用户APC
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0041</span><span class="nf">BC7F</span>                 <span class="no">call</span>    <span class="no">_KiDeliverApc@12</span> <span class="c1">; KiDeliverApc(x,x,x)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0041</span><span class="nf">BC84</span>                 <span class="no">xor</span>     <span class="no">cl</span><span class="p">,</span> <span class="no">cl</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0041</span><span class="nf">BC86</span>                 <span class="no">jmp</span>     <span class="no">loc_40AB56</span></span></span></code></pre></div><p>如果为1的话，也就是有内核<code>APC</code>执行，就会继续往下走，调用<code>KiDeliverApc</code>这个函数，也就是处理<code>APC</code>的函数，传递的三个参数都是0。</p>
<h4 id="系统调用中断或者异常_kiserviceexit" class="heading-element">
  <a href="#%e7%b3%bb%e7%bb%9f%e8%b0%83%e7%94%a8%e4%b8%ad%e6%96%ad%e6%88%96%e8%80%85%e5%bc%82%e5%b8%b8_kiserviceexit" class="heading-mark"></a>系统调用、中断或者异常(_KiServiceExit)</h4><h5 id="kiserviceexit-1" class="heading-element">
  <a href="#kiserviceexit-1" class="heading-mark"></a>KiServiceExit</h5><p>这个函数是系统调用、中断异常必经之处，和APC相关的：</p>
<div class="highlight" id="id-14"><pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">004069</span><span class="nf">CD</span> <span class="no">loc_4069CD</span><span class="p">:</span>                             <span class="c1">; CODE XREF: _KiServiceExit+8↑j
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">004069</span><span class="nf">CD</span>                                         <span class="c1">; _KiServiceExit+64↓j
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">004069</span><span class="nf">CD</span>                 <span class="no">mov</span>     <span class="no">ebx</span><span class="p">,</span> <span class="no">large</span> <span class="no">fs</span><span class="p">:</span><span class="mi">124</span><span class="no">h</span> <span class="c1">; 获取ETHREAD
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">004069</span><span class="nf">D4</span>                 <span class="no">mov</span>     <span class="no">byte</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">ebx</span><span class="err">+</span><span class="no">_KTHREAD.Alerted</span><span class="p">],</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">004069</span><span class="nf">D8</span>                 <span class="no">cmp</span>     <span class="no">byte</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">ebx</span><span class="err">+</span><span class="no">_KTHREAD.ApcState.UserApcPending</span><span class="p">],</span> <span class="mi">0</span> <span class="c1">; 检查是否有APC请求
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">004069</span><span class="nf">DC</span>                 <span class="no">jz</span>      <span class="no">short</span> <span class="no">loc_406A23</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">004069</span><span class="nf">DE</span>                 <span class="no">mov</span>     <span class="no">ebx</span><span class="p">,</span> <span class="no">ebp</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">004069</span><span class="nf">E0</span>                 <span class="no">mov</span>     <span class="p">[</span><span class="no">ebx</span><span class="err">+</span><span class="mi">44</span><span class="no">h</span><span class="p">],</span> <span class="no">eax</span>  <span class="c1">; 堆栈中_KTRAP_FREAME结构的eax
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">004069</span><span class="nf">E3</span>                 <span class="no">mov</span>     <span class="no">dword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">ebx</span><span class="err">+</span><span class="mi">50</span><span class="no">h</span><span class="p">],</span> <span class="mi">3</span><span class="no">Bh</span> <span class="c1">; &#39;;&#39; ; 堆栈中_KTRAP_FREAME结构的SegFs
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">004069</span><span class="nf">EA</span>                 <span class="no">mov</span>     <span class="no">dword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">ebx</span><span class="err">+</span><span class="mi">38</span><span class="no">h</span><span class="p">],</span> <span class="mi">23</span><span class="no">h</span> <span class="c1">; &#39;#&#39; ; 堆栈中_KTRAP_FREAME结构的SegDs
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">004069</span><span class="nf">F1</span>                 <span class="no">mov</span>     <span class="no">dword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">ebx</span><span class="err">+</span><span class="mi">34</span><span class="no">h</span><span class="p">],</span> <span class="mi">23</span><span class="no">h</span> <span class="c1">; &#39;#&#39; ; 堆栈中_KTRAP_FREAME结构的SegEs
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">004069</span><span class="nf">F8</span>                 <span class="no">mov</span>     <span class="no">dword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">ebx</span><span class="err">+</span><span class="mi">30</span><span class="no">h</span><span class="p">],</span> <span class="mi">0</span> <span class="c1">; 堆栈中_KTRAP_FREAME结构的SegGs
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">004069</span><span class="nf">FF</span>                 <span class="no">mov</span>     <span class="no">ecx</span><span class="p">,</span> <span class="mi">1</span>          <span class="c1">; APC_LEVEl参数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00406</span><span class="nf">A04</span>                 <span class="no">call</span>    <span class="no">ds</span><span class="p">:</span><span class="no">__imp_@KfRaiseIrql@4</span> <span class="c1">; KfRaiseIrql(x)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00406</span><span class="nf">A0A</span>                 <span class="no">push</span>    <span class="no">eax</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00406</span><span class="nf">A0B</span>                 <span class="no">sti</span>                     <span class="c1">; 关中断
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00406</span><span class="nf">A0C</span>                 <span class="no">push</span>    <span class="no">ebx</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00406</span><span class="nf">A0D</span>                 <span class="no">push</span>    <span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00406</span><span class="nf">A0F</span>                 <span class="no">push</span>    <span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00406</span><span class="nf">A11</span>                 <span class="no">call</span>    <span class="no">_KiDeliverApc@12</span> <span class="err">;</span> <span class="err">执行内核</span><span class="no">APC并为用户空间的APC的执行进行准备</span></span></span></code></pre></div><p>第一个参数是1，第二个参数是0，第三个就是所谓的<code>TrapFrame</code></p>
<h3 id="内核apc执行流程" class="heading-element">
  <a href="#%e5%86%85%e6%a0%b8apc%e6%89%a7%e8%a1%8c%e6%b5%81%e7%a8%8b" class="heading-mark"></a>内核APC执行流程</h3><h4 id="kideliverapc" class="heading-element">
  <a href="#kideliverapc" class="heading-mark"></a>KiDeliverApc</h4><p>执行过程：</p>
<ol>
<li>判断第一个链表是否为空</li>
<li>判断<code>KTHREAD.ApcState.KernelApcInProgress</code>是否为1</li>
<li>判断是否禁用内核APC(<code>KTHREAD.KernelApcDisable</code>是否为1)</li>
<li>将当前KAPC结构体从链表中摘除</li>
<li>执行<code>KAPC.KernelRoutine</code>指定的函数 释放KAPC结构体占用的空间</li>
<li>将<code>KTHREAD.ApcState.KernelApcInProgress</code>设置为1 标识正在执行内核APC</li>
<li>执行真正的内核APC函数(<code>KAPC.NormalRoutine</code>)</li>
<li>执行完毕 将<code>KernelApcInProgress</code>改为0</li>
<li>循环</li>
</ol>
<div class="highlight" id="id-15"><pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00405</span><span class="nf">E20</span> <span class="no">loc_405E20</span><span class="p">:</span>                             <span class="c1">; CODE XREF: KiDeliverApc(x,x,x)+D↑j
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00405</span><span class="nf">E20</span>                                         <span class="c1">; KiDeliverApc(x,x,x)+B580↓j ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00405</span><span class="nf">E20</span>                 <span class="no">push</span>    <span class="no">ebx</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00405</span><span class="nf">E21</span>                 <span class="no">push</span>    <span class="no">esi</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00405</span><span class="nf">E22</span>                 <span class="no">push</span>    <span class="no">edi</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00405</span><span class="nf">E23</span>                 <span class="no">mov</span>     <span class="no">eax</span><span class="p">,</span> <span class="no">large</span> <span class="no">fs</span><span class="p">:</span><span class="no">_KTHREAD</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00405</span><span class="nf">E29</span>                 <span class="no">mov</span>     <span class="no">esi</span><span class="p">,</span> <span class="no">eax</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00405</span><span class="nf">E2B</span>                 <span class="no">mov</span>     <span class="no">eax</span><span class="p">,</span> <span class="p">[</span><span class="no">esi</span><span class="err">+</span><span class="no">_KTHREAD.TrapFrame</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00405</span><span class="nf">E31</span>                 <span class="no">mov</span>     <span class="p">[</span><span class="no">ebp</span><span class="err">+</span><span class="no">var_1C</span><span class="p">],</span> <span class="no">eax</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00405</span><span class="nf">E34</span>                 <span class="no">mov</span>     <span class="no">eax</span><span class="p">,</span> <span class="p">[</span><span class="no">esi</span><span class="err">+</span><span class="no">_KTHREAD.ApcState.Process</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00405</span><span class="nf">E37</span>                 <span class="no">mov</span>     <span class="p">[</span><span class="no">esi</span><span class="err">+</span><span class="no">_KTHREAD.TrapFrame</span><span class="p">],</span> <span class="no">ecx</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00405</span><span class="nf">E3D</span>                 <span class="no">lea</span>     <span class="no">ecx</span><span class="p">,</span> <span class="p">[</span><span class="no">esi</span><span class="err">+</span><span class="no">_KTHREAD.ApcQueueLock</span><span class="p">]</span> <span class="c1">; SpinLock
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00405</span><span class="nf">E43</span>                 <span class="no">lea</span>     <span class="no">edx</span><span class="p">,</span> <span class="p">[</span><span class="no">ebp</span><span class="err">+</span><span class="no">LockHandle</span><span class="p">]</span> <span class="c1">; LockHandle
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00405</span><span class="nf">E46</span>                 <span class="no">mov</span>     <span class="p">[</span><span class="no">ebp</span><span class="err">+</span><span class="no">BugCheckParameter1</span><span class="p">],</span> <span class="no">eax</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00405</span><span class="nf">E49</span>                 <span class="no">call</span>    <span class="no">ds</span><span class="p">:</span><span class="no">__imp_@KeAcquireInStackQueuedSpinLock@8</span> <span class="c1">; KeAcquireInStackQueuedSpinLock(x,x)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00405</span><span class="nf">E4F</span>                 <span class="no">mov</span>     <span class="p">[</span><span class="no">esi</span><span class="err">+</span><span class="no">_KTHREAD.ApcState.KernelApcPending</span><span class="p">],</span> <span class="mi">0</span> <span class="c1">; 将KernelApcPending状态改为0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00405</span><span class="nf">E53</span>                 <span class="no">lea</span>     <span class="no">ebx</span><span class="p">,</span> <span class="p">[</span><span class="no">esi</span><span class="err">+</span><span class="no">_KTHREAD.ApcState</span><span class="p">]</span> <span class="c1">; 取出内核APC列表
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00405</span><span class="nf">E56</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00405</span><span class="nf">E56</span> <span class="no">loc_405E56</span><span class="p">:</span>                             <span class="c1">; CODE XREF: KiDeliverApc(x,x,x)+14FDD↓j
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00405</span><span class="nf">E56</span>                                         <span class="c1">; KiDeliverApc(x,x,x)+15E53↓j ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00405</span><span class="nf">E56</span>                 <span class="no">cmp</span>     <span class="p">[</span><span class="no">ebx</span><span class="p">],</span> <span class="no">ebx</span>      <span class="c1">; 判断第一个列表是否为空(内核APC队列)，如果内容与当前地址一样，说明没有空
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00405</span><span class="nf">E58</span>                 <span class="no">jnz</span>     <span class="no">loc_41BBEF</span>      <span class="c1">; 如果为空则跳转
</span></span></span><span class="line"><span class="cl"><span class="c1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0041</span><span class="nf">BBEF</span> <span class="no">loc_41BBEF</span><span class="p">:</span>                             <span class="c1">; CODE XREF: KiDeliverApc(x,x,x)+57↑j
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0041</span><span class="nf">BBEF</span>                 <span class="no">mov</span>     <span class="no">eax</span><span class="p">,</span> <span class="p">[</span><span class="no">ebx</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0041</span><span class="nf">BBF1</span>                 <span class="no">lea</span>     <span class="no">edi</span><span class="p">,</span> <span class="p">[</span><span class="no">eax-0Ch</span><span class="p">]</span>  <span class="c1">; 减0x0C就是KAPC的首地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0041</span><span class="nf">BBF4</span>                 <span class="no">mov</span>     <span class="no">ecx</span><span class="p">,</span> <span class="p">[</span><span class="no">edi</span><span class="err">+</span><span class="no">_KAPC.KernelRoutine</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0041</span><span class="nf">BBF7</span>                 <span class="no">mov</span>     <span class="p">[</span><span class="no">ebp</span><span class="err">+</span><span class="no">ms_exc.KernelRoutine</span><span class="p">],</span> <span class="no">ecx</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0041</span><span class="nf">BBFA</span>                 <span class="no">mov</span>     <span class="no">ecx</span><span class="p">,</span> <span class="p">[</span><span class="no">edi</span><span class="err">+</span><span class="no">_KAPC.NormalRoutine</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0041</span><span class="nf">BBFD</span>                 <span class="no">test</span>    <span class="no">ecx</span><span class="p">,</span> <span class="no">ecx</span>        <span class="c1">; 判断内核APC是否为空
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0041</span><span class="nf">BBFF</span>                 <span class="no">mov</span>     <span class="p">[</span><span class="no">ebp</span><span class="err">+</span><span class="no">ms_exc.NormalRoutine</span><span class="p">],</span> <span class="no">ecx</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0041</span><span class="nf">BC02</span>                 <span class="no">mov</span>     <span class="no">edx</span><span class="p">,</span> <span class="p">[</span><span class="no">edi</span><span class="err">+</span><span class="no">_KAPC.NormalContext</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0041</span><span class="nf">BC05</span>                 <span class="no">mov</span>     <span class="p">[</span><span class="no">ebp</span><span class="err">+</span><span class="no">ms_exc.NormalContext</span><span class="p">],</span> <span class="no">edx</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0041</span><span class="nf">BC08</span>                 <span class="no">mov</span>     <span class="no">edx</span><span class="p">,</span> <span class="p">[</span><span class="no">edi</span><span class="err">+</span><span class="no">_KAPC.SystemArgument1</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0041</span><span class="nf">BC0B</span>                 <span class="no">mov</span>     <span class="p">[</span><span class="no">ebp</span><span class="err">+</span><span class="no">ms_exc.SystemArgument1</span><span class="p">],</span> <span class="no">edx</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0041</span><span class="nf">BC0E</span>                 <span class="no">mov</span>     <span class="no">edx</span><span class="p">,</span> <span class="p">[</span><span class="no">edi</span><span class="err">+</span><span class="no">_KAPC.SystemArgument2</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0041</span><span class="nf">BC11</span>                 <span class="no">mov</span>     <span class="p">[</span><span class="no">ebp</span><span class="err">+</span><span class="no">ms_exc.SystemArgument2</span><span class="p">],</span> <span class="no">edx</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0041</span><span class="nf">BC14</span>                 <span class="no">jnz</span>     <span class="no">loc_41AD60</span>      <span class="c1">; 不为空跳转
</span></span></span><span class="line"><span class="cl"><span class="c1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0041</span><span class="nf">AD60</span> <span class="no">loc_41AD60</span><span class="p">:</span>                             <span class="c1">; CODE XREF: KiDeliverApc(x,x,x)+15E13↓j
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0041</span><span class="nf">AD60</span>                 <span class="no">cmp</span>     <span class="p">[</span><span class="no">esi</span><span class="err">+</span><span class="no">_KTHREAD.ApcState.KernelApcInProgress</span><span class="p">],</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0041</span><span class="nf">AD64</span>                 <span class="no">jnz</span>     <span class="no">loc_405E6B</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0041</span><span class="nf">AD6A</span>                 <span class="no">cmp</span>     <span class="p">[</span><span class="no">esi</span><span class="err">+</span><span class="no">_KTHREAD.KernelApcDisable</span><span class="p">],</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0041</span><span class="nf">AD71</span>                 <span class="no">jnz</span>     <span class="no">loc_405E6B</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0041</span><span class="nf">AD77</span>                 <span class="no">mov</span>     <span class="no">ecx</span><span class="p">,</span> <span class="p">[</span><span class="no">eax</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0041</span><span class="nf">AD79</span>                 <span class="no">mov</span>     <span class="no">eax</span><span class="p">,</span> <span class="p">[</span><span class="no">eax</span><span class="err">+</span><span class="mi">4</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0041</span><span class="nf">AD7C</span>                 <span class="no">mov</span>     <span class="p">[</span><span class="no">eax</span><span class="p">],</span> <span class="no">ecx</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0041</span><span class="nf">AD7E</span>                 <span class="no">mov</span>     <span class="p">[</span><span class="no">ecx</span><span class="err">+</span><span class="mi">4</span><span class="p">],</span> <span class="no">eax</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0041</span><span class="nf">AD81</span>                 <span class="no">lea</span>     <span class="no">ecx</span><span class="p">,</span> <span class="p">[</span><span class="no">ebp</span><span class="err">+</span><span class="no">LockHandle</span><span class="p">]</span> <span class="c1">; LockHandle
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0041</span><span class="nf">AD84</span>                 <span class="no">mov</span>     <span class="p">[</span><span class="no">edi</span><span class="err">+</span><span class="no">_KAPC.Inserted</span><span class="p">],</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0041</span><span class="nf">AD88</span>                 <span class="no">call</span>    <span class="no">ds</span><span class="p">:</span><span class="no">__imp_@KeReleaseInStackQueuedSpinLock@4</span> <span class="c1">; KeReleaseInStackQueuedSpinLock(x)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0041</span><span class="nf">AD8E</span>                 <span class="no">lea</span>     <span class="no">eax</span><span class="p">,</span> <span class="p">[</span><span class="no">ebp</span><span class="err">+</span><span class="no">ms_exc.SystemArgunent2</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0041</span><span class="nf">AD91</span>                 <span class="no">push</span>    <span class="no">eax</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0041</span><span class="nf">AD92</span>                 <span class="no">lea</span>     <span class="no">eax</span><span class="p">,</span> <span class="p">[</span><span class="no">ebp</span><span class="err">+</span><span class="no">ms_exc.SystemArgunent1</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0041</span><span class="nf">AD95</span>                 <span class="no">push</span>    <span class="no">eax</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0041</span><span class="nf">AD96</span>                 <span class="no">lea</span>     <span class="no">eax</span><span class="p">,</span> <span class="p">[</span><span class="no">ebp</span><span class="err">+</span><span class="no">ms_exc.NormalContext</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0041</span><span class="nf">AD99</span>                 <span class="no">push</span>    <span class="no">eax</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0041</span><span class="nf">AD9A</span>                 <span class="no">lea</span>     <span class="no">eax</span><span class="p">,</span> <span class="p">[</span><span class="no">ebp</span><span class="err">+</span><span class="no">ms_exc.NormalRoutine</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0041</span><span class="nf">AD9D</span>                 <span class="no">push</span>    <span class="no">eax</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0041</span><span class="nf">AD9E</span>                 <span class="no">push</span>    <span class="no">edi</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0041</span><span class="nf">AD9F</span>                 <span class="no">call</span>    <span class="p">[</span><span class="no">ebp</span><span class="err">+</span><span class="no">ms_exc.KernelRoutine</span><span class="p">]</span> <span class="c1">; 5)执行KAPC.KernelRoutine指定的函数释放KAPC结构体占用的空间
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0041</span><span class="nf">ADA2</span>                 <span class="no">cmp</span>     <span class="p">[</span><span class="no">ebp</span><span class="err">+</span><span class="no">ms_exc.NormalRoutine</span><span class="p">],</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0041</span><span class="nf">ADA6</span>                 <span class="no">jz</span>      <span class="no">short</span> <span class="no">loc_41ADCB</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0041</span><span class="nf">ADA8</span>                 <span class="no">xor</span>     <span class="no">cl</span><span class="p">,</span> <span class="no">cl</span>          <span class="c1">; NewIrql
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0041</span><span class="nf">ADAA</span>                 <span class="no">mov</span>     <span class="p">[</span><span class="no">esi</span><span class="err">+</span><span class="no">_KTHREAD.ApcState.KernelApcInProgress</span><span class="p">],</span> <span class="mi">1</span> <span class="c1">; 6)将KTHREAD.ApcState.KernelApcInProgress设置为1标识正在执行内核APC
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0041</span><span class="nf">ADAE</span>                 <span class="no">call</span>    <span class="no">ds</span><span class="p">:</span><span class="no">__imp_@KfLowerIrql@4</span> <span class="c1">; KfLowerIrql(x)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0041</span><span class="nf">ADB4</span>                 <span class="no">push</span>    <span class="p">[</span><span class="no">ebp</span><span class="err">+</span><span class="no">ms_exc.SystemArgunent2</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0041</span><span class="nf">ADB7</span>                 <span class="no">push</span>    <span class="p">[</span><span class="no">ebp</span><span class="err">+</span><span class="no">ms_exc.SystemArgunent1</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0041</span><span class="nf">ADBA</span>                 <span class="no">push</span>    <span class="p">[</span><span class="no">ebp</span><span class="err">+</span><span class="no">ms_exc.NormalContext</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0041</span><span class="nf">ADBD</span>                 <span class="no">call</span>    <span class="p">[</span><span class="no">ebp</span><span class="err">+</span><span class="no">ms_exc.NormalRoutine</span><span class="p">]</span> <span class="c1">; 7)执行真正的内核APC函数(KAPC.NormalRoutine)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0041</span><span class="nf">ADC0</span>                 <span class="no">mov</span>     <span class="no">cl</span><span class="p">,</span> <span class="mi">1</span>           <span class="c1">; NewIrql
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0041</span><span class="nf">ADC2</span>                 <span class="no">call</span>    <span class="no">ds</span><span class="p">:</span><span class="no">__imp_@KfRaiseIrql@4</span> <span class="c1">; KfRaiseIrql(x)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0041</span><span class="nf">ADC8</span>                 <span class="no">mov</span>     <span class="p">[</span><span class="no">ebp</span><span class="err">+</span><span class="no">LockHandle.OldIrql</span><span class="p">],</span> <span class="no">al</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0041</span><span class="nf">ADCB</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0041</span><span class="nf">ADCB</span> <span class="no">loc_41ADCB</span><span class="p">:</span>                             <span class="c1">; CODE XREF: KiDeliverApc(x,x,x)+14FA5↑j
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0041</span><span class="nf">ADCB</span>                 <span class="no">lea</span>     <span class="no">edx</span><span class="p">,</span> <span class="p">[</span><span class="no">ebp</span><span class="err">+</span><span class="no">LockHandle</span><span class="p">]</span> <span class="c1">; LockHandle
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0041</span><span class="nf">ADCE</span>                 <span class="no">lea</span>     <span class="no">ecx</span><span class="p">,</span> <span class="p">[</span><span class="no">esi</span><span class="err">+</span><span class="mi">0</span><span class="no">E8h</span><span class="p">]</span> <span class="c1">; SpinLock
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0041</span><span class="nf">ADD4</span>                 <span class="no">call</span>    <span class="no">ds</span><span class="p">:</span><span class="no">__imp_@KeAcquireInStackQueuedSpinLock@8</span> <span class="c1">; KeAcquireInStackQueuedSpinLock(x,x)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0041</span><span class="nf">ADDA</span>                 <span class="no">mov</span>     <span class="p">[</span><span class="no">esi</span><span class="err">+</span><span class="no">_KTHREAD.ApcState.KernelApcInProgress</span><span class="p">],</span> <span class="mi">0</span> <span class="c1">; 8)执行完毕，将KernelApcInProgress改为0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0041</span><span class="nf">ADDE</span>                 <span class="no">jmp</span>     <span class="no">loc_405E56</span>      <span class="c1">; 9)下一个循环
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0041</span><span class="nf">ADDE</span> <span class="err">;</span> <span class="no">END</span> <span class="no">OF</span> <span class="no">FUNCTION</span> <span class="no">CHUNK</span> <span class="no">FOR</span> <span class="no">KiDeliverApc</span><span class="p">(</span><span class="no">x</span><span class="p">,</span><span class="no">x</span><span class="p">,</span><span class="no">x</span><span class="p">)</span></span></span></code></pre></div><h3 id="总结" class="heading-element">
  <a href="#%e6%80%bb%e7%bb%93" class="heading-mark"></a>总结</h3><ol>
<li>线程切换的时候，这就意味着只要插入内核APC很快就会执行(<code>SwapContext</code>-&gt;<code>KiSwapThread</code>-&gt;<code>KiDeliverApc</code>)</li>
<li>如果有<strong>用户APC</strong>需要处理时，一定会<strong>先处理内核APC</strong></li>
<li>内核APC在内核空间执行，不需要换栈，一个循环全部执行完毕</li>
</ol>
<h2 id="05用户apc执行过程" class="heading-element">
  <a href="#05%e7%94%a8%e6%88%b7apc%e6%89%a7%e8%a1%8c%e8%bf%87%e7%a8%8b" class="heading-mark"></a>05.用户APC执行过程</h2><p>当产生系统调用、中断或者异常，线程在返回用户空间前都会调用<code>_KiServiceExit</code>函数，在<code>_KiServiceExit</code>会判断是否有要执行的用户APC，如果有则调用<code>KiDeliverApc</code>函数(第一个参数为1)进行处理。</p>
<p>执行用户APC时的堆栈操作：</p>
<ol>
<li>当线程从用户层进入内核层时，要保留原来的运行环境，比如各种寄存器，栈的位置等等 (<code>_Trap_Frame</code>)，然后切换成内核的堆栈，如果正常返回，恢复堆栈环境即可。</li>
<li>但如果有用户APC要执行的话，就意味着线程要提前返回到用户空间去执行，而且返回的位置不是线程进入内核时的位置，而是返回到其他的位置，每处理一个用户APC都会涉及到：
<code>内核</code>–&gt;<code>用户空间</code>–&gt;<code>再回到内核空间</code></li>
<li>堆栈的操作比较复杂，如果不了解堆栈的操作细节不可能理解用户APC是如何执行的</li>
</ol>
<h3 id="kideliverapc-1" class="heading-element">
  <a href="#kideliverapc-1" class="heading-mark"></a>KiDeliverApc</h3><p>执行过程：</p>
<ol>
<li>判断用户APC链表是否为空</li>
<li>判断第一个参数是为1</li>
<li>判断<code>ApcState.UserApcPending</code>是否为1</li>
<li>将<code>ApcState.UserApcPending</code>设置为0</li>
<li>链表操作 将当前APC从用户队列中拆除</li>
<li>调用函数(<code>KAPC.KernelRoutine</code>)释放KAPC结构体内存空间</li>
<li>调用<code>KiInitializeUserApc</code>函数</li>
</ol>
<div class="highlight" id="id-16"><pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00405</span><span class="nf">E56</span> <span class="no">loc_405E56</span><span class="p">:</span>                             <span class="c1">; CODE XREF: KiDeliverApc(x,x,x)+14FDD↓j
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00405</span><span class="nf">E56</span>                                         <span class="c1">; KiDeliverApc(x,x,x)+15E53↓j ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00405</span><span class="nf">E56</span>                 <span class="no">cmp</span>     <span class="p">[</span><span class="no">ebx</span><span class="p">],</span> <span class="no">ebx</span>      <span class="c1">; 判断第一个列表是否为空(内核APC队列)，如果内容与当前地址一样，说明没有空
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00405</span><span class="nf">E58</span>                 <span class="no">jnz</span>     <span class="no">loc_41BBEF</span>      <span class="c1">; 如果为空则跳转
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00405</span><span class="nf">E5E</span>                 <span class="no">lea</span>     <span class="no">ecx</span><span class="p">,</span> <span class="p">[</span><span class="no">esi</span><span class="err">+</span><span class="p">(</span><span class="no">_KTHREAD.ApcState.ApcListHead.Flink</span><span class="err">+</span><span class="mi">8</span><span class="p">)]</span> <span class="c1">; 取第二个链表，也就是用户APC队列
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00405</span><span class="nf">E61</span>                 <span class="no">mov</span>     <span class="no">eax</span><span class="p">,</span> <span class="p">[</span><span class="no">ecx</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00405</span><span class="nf">E63</span>                 <span class="no">cmp</span>     <span class="no">eax</span><span class="p">,</span> <span class="no">ecx</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00405</span><span class="nf">E65</span>                 <span class="no">jnz</span>     <span class="no">loc_4104CA</span>
</span></span><span class="line"><span class="cl"><span class="c1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">004104</span><span class="nf">CA</span> <span class="no">loc_4104CA</span><span class="p">:</span>                             <span class="c1">; CODE XREF: KiDeliverApc(x,x,x)+64↑j
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">004104</span><span class="nf">CA</span>                 <span class="no">cmp</span>     <span class="p">[</span><span class="no">ebp</span><span class="err">+</span><span class="no">arg_0</span><span class="p">],</span> <span class="mi">1</span>  <span class="c1">; 2)判断第一个参数是为1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">004104</span><span class="nf">CE</span>                 <span class="no">jnz</span>     <span class="no">loc_405E6B</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">004104</span><span class="nf">D4</span>                 <span class="no">cmp</span>     <span class="p">[</span><span class="no">esi</span><span class="err">+</span><span class="no">_KTHREAD.ApcState.UserApcPending</span><span class="p">],</span> <span class="mi">0</span> <span class="c1">; 3)判断ApcState.UserApcPending是否为1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">004104</span><span class="nf">D8</span>                 <span class="no">jz</span>      <span class="no">loc_405E6B</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">004104</span><span class="nf">DE</span>                 <span class="no">mov</span>     <span class="p">[</span><span class="no">esi</span><span class="err">+</span><span class="no">_KTHREAD.ApcState.UserApcPending</span><span class="p">],</span> <span class="mi">0</span> <span class="c1">; 4)将ApcState.UserApcPending设置为0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">004104</span><span class="nf">E2</span>                 <span class="no">lea</span>     <span class="no">edi</span><span class="p">,</span> <span class="p">[</span><span class="no">eax-0Ch</span><span class="p">]</span>  <span class="c1">; 减0xc得到KAPC首地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">004104</span><span class="nf">E5</span>                 <span class="no">mov</span>     <span class="no">ecx</span><span class="p">,</span> <span class="p">[</span><span class="no">edi</span><span class="err">+</span><span class="no">_KAPC.NormalRoutine</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">004104</span><span class="nf">E8</span>                 <span class="no">mov</span>     <span class="no">ebx</span><span class="p">,</span> <span class="p">[</span><span class="no">edi</span><span class="err">+</span><span class="no">_KAPC.KernelRoutine</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">004104</span><span class="nf">EB</span>                 <span class="no">mov</span>     <span class="p">[</span><span class="no">ebp</span><span class="err">+</span><span class="no">NormalRoutine</span><span class="p">],</span> <span class="no">ecx</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">004104</span><span class="nf">EE</span>                 <span class="no">mov</span>     <span class="no">ecx</span><span class="p">,</span> <span class="p">[</span><span class="no">edi</span><span class="err">+</span><span class="no">_KAPC.NormalContext</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">004104</span><span class="nf">F1</span>                 <span class="no">mov</span>     <span class="p">[</span><span class="no">ebp</span><span class="err">+</span><span class="no">NormalContext</span><span class="p">],</span> <span class="no">ecx</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">004104</span><span class="nf">F4</span>                 <span class="no">mov</span>     <span class="no">ecx</span><span class="p">,</span> <span class="p">[</span><span class="no">edi</span><span class="err">+</span><span class="no">_KAPC.SystemArgument1</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">004104</span><span class="nf">F7</span>                 <span class="no">mov</span>     <span class="p">[</span><span class="no">ebp</span><span class="err">+</span><span class="no">SystemArgument1</span><span class="p">],</span> <span class="no">ecx</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">004104</span><span class="nf">FA</span>                 <span class="no">mov</span>     <span class="no">ecx</span><span class="p">,</span> <span class="p">[</span><span class="no">edi</span><span class="err">+</span><span class="no">_KAPC.SystemArgument2</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">004104</span><span class="nf">FD</span>                 <span class="no">mov</span>     <span class="p">[</span><span class="no">ebp</span><span class="err">+</span><span class="no">SystemArgument2</span><span class="p">],</span> <span class="no">ecx</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00410500</span>                 <span class="nf">mov</span>     <span class="no">ecx</span><span class="p">,</span> <span class="p">[</span><span class="no">eax</span><span class="p">]</span>      <span class="c1">; 5)链表操作将当前APC从用户队列中拆除
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00410502</span>                 <span class="nf">mov</span>     <span class="no">eax</span><span class="p">,</span> <span class="p">[</span><span class="no">eax</span><span class="err">+</span><span class="mi">4</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00410505</span>                 <span class="nf">mov</span>     <span class="p">[</span><span class="no">eax</span><span class="p">],</span> <span class="no">ecx</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00410507</span>                 <span class="nf">mov</span>     <span class="p">[</span><span class="no">ecx</span><span class="err">+</span><span class="mi">4</span><span class="p">],</span> <span class="no">eax</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0041050</span><span class="nf">A</span>                 <span class="no">lea</span>     <span class="no">ecx</span><span class="p">,</span> <span class="p">[</span><span class="no">ebp</span><span class="err">+</span><span class="no">LockHandle</span><span class="p">]</span> <span class="c1">; LockHandle
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0041050</span><span class="nf">D</span>                 <span class="no">mov</span>     <span class="p">[</span><span class="no">edi</span><span class="err">+</span><span class="no">_KAPC.Inserted</span><span class="p">],</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00410511</span>                 <span class="nf">call</span>    <span class="no">ds</span><span class="p">:</span><span class="no">__imp_@KeReleaseInStackQueuedSpinLock@4</span> <span class="c1">; KeReleaseInStackQueuedSpinLock(x)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00410517</span>                 <span class="nf">lea</span>     <span class="no">eax</span><span class="p">,</span> <span class="p">[</span><span class="no">ebp</span><span class="err">+</span><span class="no">var_8</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0041051</span><span class="nf">A</span>                 <span class="no">push</span>    <span class="no">eax</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0041051</span><span class="nf">B</span>                 <span class="no">lea</span>     <span class="no">eax</span><span class="p">,</span> <span class="p">[</span><span class="no">ebp</span><span class="err">+</span><span class="no">var_C</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0041051</span><span class="nf">E</span>                 <span class="no">push</span>    <span class="no">eax</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0041051</span><span class="nf">F</span>                 <span class="no">lea</span>     <span class="no">eax</span><span class="p">,</span> <span class="p">[</span><span class="no">ebp</span><span class="err">+</span><span class="no">var_10</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00410522</span>                 <span class="nf">push</span>    <span class="no">eax</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00410523</span>                 <span class="nf">lea</span>     <span class="no">eax</span><span class="p">,</span> <span class="p">[</span><span class="no">ebp</span><span class="err">+</span><span class="no">var_4</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00410526</span>                 <span class="nf">push</span>    <span class="no">eax</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00410527</span>                 <span class="nf">push</span>    <span class="no">edi</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00410528</span>                 <span class="nf">call</span>    <span class="no">ebx</span>             <span class="c1">; 6)调用函数KAPC.KernelRoutine释放KAPC结构体内存空间
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0041052</span><span class="nf">A</span>                 <span class="no">cmp</span>     <span class="p">[</span><span class="no">ebp</span><span class="err">+</span><span class="no">ms_exc.NormalRoutine</span><span class="p">],</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0041052</span><span class="nf">E</span>                 <span class="no">jz</span>      <span class="no">loc_44B394</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00410534</span>                 <span class="nf">push</span>    <span class="p">[</span><span class="no">ebp</span><span class="err">+</span><span class="no">ms_exc.SystemArgunent2</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00410537</span>                 <span class="nf">push</span>    <span class="p">[</span><span class="no">ebp</span><span class="err">+</span><span class="no">ms_exc.SystemArgunent1</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0041053</span><span class="nf">A</span>                 <span class="no">push</span>    <span class="p">[</span><span class="no">ebp</span><span class="err">+</span><span class="no">ms_exc.NormalContext</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0041053</span><span class="nf">D</span>                 <span class="no">push</span>    <span class="p">[</span><span class="no">ebp</span><span class="err">+</span><span class="no">ms_exc.NormalRoutine</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00410540</span>                 <span class="nf">push</span>    <span class="p">[</span><span class="no">ebp</span><span class="err">+</span><span class="no">arg_8</span><span class="p">]</span>     <span class="c1">; TrapFrame
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00410543</span>                 <span class="nf">push</span>    <span class="p">[</span><span class="no">ebp</span><span class="err">+</span><span class="no">arg_4</span><span class="p">]</span>     <span class="c1">; ExceptionFrame
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00410546</span>                 <span class="nf">call</span>    <span class="no">_KiInitializeUserApc@24</span> <span class="c1">; 这里并未直接调用处理用户APC的函数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00410546</span>                                         <span class="c1">; 原因是当前堆栈在0环用户APC需要到3环去执行
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0041054</span><span class="nf">B</span>                 <span class="no">jmp</span>     <span class="no">loc_405E74</span></span></span></code></pre></div><h3 id="kiinitializeuserapc" class="heading-element">
  <a href="#kiinitializeuserapc" class="heading-mark"></a>KiInitializeUserApc</h3><ol>
<li>
<p>线程进0环时，原来的运行环境(寄存器栈顶等)保存到 <code>_Trap_Frame</code> 结构体中，如果要提前返回3环去处理用户APC，就必须要修改 <code>_Trap_Frame</code> 结构体：</p>
</li>
<li>
<p>比如：进0环时的位置存储在EIP中，现在要提前返回，而且返回的并不是原来的位置，那就意味着必须要修改EIP为新的返回位置。还有堆栈ESP，也要修改为处理APC需要的堆栈。那原来的值怎么办呢?处理完APC后该如何返回原来的位置呢？</p>
</li>
<li>
<p><code>KiInitializeUserApc</code>要做的第一件事就是备份：</p>
<p>将原来 <code>_Trap_Frame</code> 的值备份到一个新的结构体中( <code>CONTEXT</code> ),这个功能由其子函数<code>KeContextFromKframes</code>来完成</p>
</li>
</ol>
<div class="highlight" id="id-17"><pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00410555</span> <span class="nf">_KiInitializeUserApc@24</span> <span class="no">proc</span> <span class="no">near</span>       <span class="c1">; CODE XREF: KiDeliverApc(x,x,x)+A745↑p
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00410555</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00410555</span> <span class="nf">ExceptionRecord</span> <span class="err">=</span> <span class="no">_EXCEPTION_RECORD</span> <span class="no">ptr</span> <span class="p">-</span><span class="mi">34</span><span class="no">Ch</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00410555</span> <span class="nf">var_2FC</span>         <span class="err">=</span> <span class="no">dword</span> <span class="no">ptr</span> <span class="p">-</span><span class="mi">2</span><span class="no">FCh</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00410555</span> <span class="nf">var_2F8</span>         <span class="err">=</span> <span class="no">dword</span> <span class="no">ptr</span> <span class="p">-</span><span class="mi">2</span><span class="no">F8h</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00410555</span> <span class="nf">var_2F4</span>         <span class="err">=</span> <span class="no">dword</span> <span class="no">ptr</span> <span class="p">-</span><span class="mi">2</span><span class="no">F4h</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00410555</span> <span class="nf">BugCheckParameter3</span><span class="err">=</span> <span class="no">dword</span> <span class="no">ptr</span> <span class="p">-</span><span class="mi">2</span><span class="no">F0h</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00410555</span> <span class="nf">var_2EC</span>         <span class="err">=</span> <span class="no">dword</span> <span class="no">ptr</span> <span class="p">-</span><span class="mi">2</span><span class="no">ECh</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00410555</span> <span class="nf">var_2E8_CONTEXT</span> <span class="err">=</span> <span class="no">dword</span> <span class="no">ptr</span> <span class="p">-</span><span class="mi">2</span><span class="no">E8h</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00410555</span> <span class="nf">var_228</span>         <span class="err">=</span> <span class="no">dword</span> <span class="no">ptr</span> <span class="p">-</span><span class="mi">228</span><span class="no">h</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00410555</span> <span class="nf">var_224_CONTEXT.esp</span><span class="err">=</span> <span class="no">dword</span> <span class="no">ptr</span> <span class="p">-</span><span class="mi">224</span><span class="no">h</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00410555</span> <span class="nf">var_1C</span>          <span class="err">=</span> <span class="no">dword</span> <span class="no">ptr</span> <span class="p">-</span><span class="mi">1</span><span class="no">Ch</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00410555</span> <span class="nf">ms_exc</span>          <span class="err">=</span> <span class="no">CPPEH_RECORD</span> <span class="no">ptr</span> <span class="p">-</span><span class="mi">18</span><span class="no">h</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00410555</span> <span class="nf">a1</span>              <span class="err">=</span> <span class="no">dword</span> <span class="no">ptr</span>  <span class="mi">8</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00410555</span> <span class="nf">TrapFrame_Address</span><span class="err">=</span> <span class="no">dword</span> <span class="no">ptr</span>  <span class="mi">0</span><span class="no">Ch</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00410555</span> <span class="nf">arg_NormalRoutine</span><span class="err">=</span> <span class="no">dword</span> <span class="no">ptr</span>  <span class="mi">10</span><span class="no">h</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00410555</span> <span class="nf">NormalContext</span>   <span class="err">=</span> <span class="no">dword</span> <span class="no">ptr</span>  <span class="mi">14</span><span class="no">h</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00410555</span> <span class="nf">SystemArgument1</span> <span class="err">=</span> <span class="no">dword</span> <span class="no">ptr</span>  <span class="mi">18</span><span class="no">h</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00410555</span> <span class="nf">SystemArgument2</span> <span class="err">=</span> <span class="no">dword</span> <span class="no">ptr</span>  <span class="mi">1</span><span class="no">Ch</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00410555</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00410555</span> <span class="c1">; FUNCTION CHUNK AT .text:0043C680 SIZE 00000009 BYTES
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00410555</span> <span class="c1">; FUNCTION CHUNK AT .text:0044B92B SIZE 0000001F BYTES
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00410555</span> <span class="c1">; FUNCTION CHUNK AT .text:0044B94F SIZE 00000012 BYTES
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00410555</span> <span class="c1">; FUNCTION CHUNK AT .text:0044B966 SIZE 0000002E BYTES
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00410555</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00410555</span> <span class="c1">; __unwind { // __SEH_prolog
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00410555</span>                 <span class="nf">push</span>    <span class="mi">33</span><span class="no">Ch</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0041055</span><span class="nf">A</span>                 <span class="no">push</span>    <span class="no">offset</span> <span class="no">stru_410698</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0041055</span><span class="nf">F</span>                 <span class="no">call</span>    <span class="no">__SEH_prolog</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00410564</span>                 <span class="nf">mov</span>     <span class="no">eax</span><span class="p">,</span> <span class="no">ds</span><span class="p">:</span><span class="no">___security_cookie</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00410569</span>                 <span class="nf">mov</span>     <span class="p">[</span><span class="no">ebp</span><span class="err">+</span><span class="no">var_1C</span><span class="p">],</span> <span class="no">eax</span> <span class="c1">; 暂存___security_cookie
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0041056</span><span class="nf">C</span>                 <span class="no">mov</span>     <span class="no">eax</span><span class="p">,</span> <span class="p">[</span><span class="no">ebp</span><span class="err">+</span><span class="no">a1</span><span class="p">]</span>   <span class="c1">; ExceptionFrame
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0041056</span><span class="nf">F</span>                 <span class="no">mov</span>     <span class="p">[</span><span class="no">ebp</span><span class="err">+</span><span class="no">var_2F4</span><span class="p">],</span> <span class="no">eax</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00410575</span>                 <span class="nf">mov</span>     <span class="no">ebx</span><span class="p">,</span> <span class="p">[</span><span class="no">ebp</span><span class="err">+</span><span class="no">TrapFrame_Address</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00410578</span>                 <span class="nf">mov</span>     <span class="p">[</span><span class="no">ebp</span><span class="err">+</span><span class="no">BugCheckParameter3</span><span class="p">],</span> <span class="no">ebx</span> <span class="c1">; 暂存TrapFrame
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0041057</span><span class="nf">E</span>                 <span class="no">test</span>    <span class="no">byte</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">ebx</span><span class="err">+</span><span class="mi">72</span><span class="no">h</span><span class="p">],</span> <span class="mi">2</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00410582</span>                 <span class="nf">jnz</span>     <span class="no">loc_410681</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00410588</span>                 <span class="nf">mov</span>     <span class="p">[</span><span class="no">ebp</span><span class="err">+</span><span class="no">var_2E8_CONTEXT</span><span class="p">],</span> <span class="mi">10017</span><span class="no">h</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00410592</span>                 <span class="nf">lea</span>     <span class="no">ecx</span><span class="p">,</span> <span class="p">[</span><span class="no">ebp</span><span class="err">+</span><span class="no">var_2E8_CONTEXT</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00410598</span>                 <span class="nf">push</span>    <span class="no">ecx</span>             <span class="c1">; CONTEXT对象的首地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00410599</span>                 <span class="nf">push</span>    <span class="no">eax</span>             <span class="c1">; ExceptionFrame
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0041059</span><span class="nf">A</span>                 <span class="no">push</span>    <span class="no">ebx</span>             <span class="c1">; TrapFrame地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0041059</span><span class="nf">B</span>                 <span class="no">call</span>    <span class="no">_KeContextFromKframes@12</span> <span class="c1">; 将TrapFrame备份到Context，这时候还在r0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">004105</span><span class="nf">A0</span>                 <span class="no">and</span>     <span class="p">[</span><span class="no">ebp</span><span class="err">+</span><span class="no">ms_exc.registration.TryLevel</span><span class="p">],</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">004105</span><span class="nf">A4</span>                 <span class="no">mov</span>     <span class="no">eax</span><span class="p">,</span> <span class="mi">2</span><span class="no">DCh</span>       <span class="c1">; 2DC =  CONTEXT 结构体的大小+用户APC所需要的4个参数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">004105</span><span class="nf">A9</span>                 <span class="no">mov</span>     <span class="p">[</span><span class="no">ebp</span><span class="err">+</span><span class="no">var_2F8</span><span class="p">],</span> <span class="no">eax</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">004105</span><span class="nf">AF</span>                 <span class="no">mov</span>     <span class="no">esi</span><span class="p">,</span> <span class="p">[</span><span class="no">ebp</span><span class="err">+</span><span class="no">var_224_CONTEXT.esp</span><span class="p">]</span> <span class="c1">; 2E8-224=C4 刚好是CONTEXT结构体ESP的偏移
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">004105</span><span class="nf">B5</span>                 <span class="no">and</span>     <span class="no">esi</span><span class="p">,</span> <span class="mi">0</span><span class="no">FFFFFFFCh</span> <span class="c1">; 进行4字节对齐
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">004105</span><span class="nf">B8</span>                 <span class="no">sub</span>     <span class="no">esi</span><span class="p">,</span> <span class="no">eax</span>        <span class="c1">; 在0环直接修改3环的栈 将用户3环的栈减0x2DC个字节
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">004105</span><span class="nf">BA</span>                 <span class="no">mov</span>     <span class="p">[</span><span class="no">ebp</span><span class="err">+</span><span class="no">var_2EC</span><span class="p">],</span> <span class="no">esi</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">004105</span><span class="nf">C0</span>                 <span class="no">push</span>    <span class="mi">4</span>               <span class="c1">; Alignment
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">004105</span><span class="nf">C2</span>                 <span class="no">push</span>    <span class="no">eax</span>             <span class="c1">; Length
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">004105</span><span class="nf">C3</span>                 <span class="no">push</span>    <span class="no">esi</span>             <span class="c1">; Address
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">004105</span><span class="nf">C4</span>                 <span class="no">call</span>    <span class="no">_ProbeForWrite@12</span> <span class="c1">; 修改新增部分的内存属性
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">004105</span><span class="nf">C9</span>                 <span class="no">lea</span>     <span class="no">edi</span><span class="p">,</span> <span class="p">[</span><span class="no">esi</span><span class="err">+</span><span class="mi">10</span><span class="no">h</span><span class="p">]</span>  <span class="c1">; 这里edi指向r3的Context
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">004105</span><span class="nf">CC</span>                 <span class="no">mov</span>     <span class="no">ecx</span><span class="p">,</span> <span class="mi">0</span><span class="no">B3h</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">004105</span><span class="nf">D1</span>                 <span class="no">lea</span>     <span class="no">esi</span><span class="p">,</span> <span class="p">[</span><span class="no">ebp</span><span class="err">+</span><span class="no">var_2E8_CONTEXT</span><span class="p">]</span> <span class="c1">; 这里esi指向r0的context头
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">004105</span><span class="nf">D7</span>                 <span class="no">rep</span> <span class="no">movsd</span>               <span class="c1">; 从esi复制ecx个dword到edi
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">004105</span><span class="nf">D9</span>                 <span class="no">mov</span>     <span class="p">[</span><span class="no">ebx</span><span class="err">+</span><span class="no">_KTRAP_FRAME.SegCs</span><span class="p">],</span> <span class="mi">1</span><span class="no">Bh</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">004105</span><span class="nf">E0</span>                 <span class="no">push</span>    <span class="mi">23</span><span class="no">h</span> <span class="c1">; &#39;#&#39;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">004105</span><span class="nf">E2</span>                 <span class="no">pop</span>     <span class="no">eax</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">004105</span><span class="nf">E3</span>                 <span class="no">mov</span>     <span class="p">[</span><span class="no">ebx</span><span class="err">+</span><span class="no">_KTRAP_FRAME.HardwareSegSs</span><span class="p">],</span> <span class="no">eax</span> <span class="c1">; 修改Trap_Frame中的SS
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">004105</span><span class="nf">E6</span>                 <span class="no">mov</span>     <span class="p">[</span><span class="no">ebx</span><span class="err">+</span><span class="no">_KTRAP_FRAME.SegDs</span><span class="p">],</span> <span class="no">eax</span> <span class="c1">; 修改Trap_Frame中的DS
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">004105</span><span class="nf">E9</span>                 <span class="no">mov</span>     <span class="p">[</span><span class="no">ebx</span><span class="err">+</span><span class="no">_KTRAP_FRAME.SegEs</span><span class="p">],</span> <span class="no">eax</span> <span class="c1">; 修改Trap_Frame中的ES
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">004105</span><span class="nf">EC</span>                 <span class="no">mov</span>     <span class="p">[</span><span class="no">ebx</span><span class="err">+</span><span class="no">_KTRAP_FRAME.SegFs</span><span class="p">],</span> <span class="mi">3</span><span class="no">Bh</span> <span class="c1">; &#39;;&#39; ; 修改Trap_Frame中的FS
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">004105</span><span class="nf">F3</span>                 <span class="no">and</span>     <span class="p">[</span><span class="no">ebx</span><span class="err">+</span><span class="no">_KTRAP_FRAME.SegGs</span><span class="p">],</span> <span class="mi">0</span> <span class="c1">; 修改Trap_Frame中的GS
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">004105</span><span class="nf">F7</span>                 <span class="no">mov</span>     <span class="no">ecx</span><span class="p">,</span> <span class="p">[</span><span class="no">ebp</span><span class="err">+</span><span class="no">var_228</span><span class="p">]</span> <span class="c1">; 2E8 - 228=C0：是EFLAGS寄存器
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">004105</span><span class="nf">FD</span>                 <span class="no">test</span>    <span class="no">ecx</span><span class="p">,</span> <span class="mi">20000</span><span class="no">h</span>     <span class="c1">; 判断EFLAGS
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00410603</span>                 <span class="nf">jnz</span>     <span class="no">loc_44B92B</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00410609</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00410609</span> <span class="nl">loc_410609:</span>                             <span class="c1">; CODE XREF: KiInitializeUserApc(x,x,x,x,x,x)+3B3DD↓j
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00410609</span>                 <span class="nf">and</span>     <span class="no">ecx</span><span class="p">,</span> <span class="mi">3</span><span class="no">E0DD7h</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0041060</span><span class="nf">F</span>                 <span class="no">or</span>      <span class="no">ecx</span><span class="p">,</span> <span class="mi">200</span><span class="no">h</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00410615</span>                 <span class="nf">mov</span>     <span class="no">eax</span><span class="p">,</span> <span class="no">ecx</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00410617</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00410617</span> <span class="nl">loc_410617:</span>                             <span class="c1">; CODE XREF: KiInitializeUserApc(x,x,x,x,x,x)+3B3F0↓j
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00410617</span>                 <span class="nf">mov</span>     <span class="p">[</span><span class="no">ebx</span><span class="err">+</span><span class="no">_KTRAP_FRAME.EFlags</span><span class="p">],</span> <span class="no">eax</span> <span class="c1">; 修改Trap_Frame中的EFLAGS
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0041061</span><span class="nf">A</span>                 <span class="no">mov</span>     <span class="no">eax</span><span class="p">,</span> <span class="no">large</span> <span class="no">fs</span><span class="p">:</span><span class="no">_KTHREAD.Affinity</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00410620</span>                 <span class="nf">mov</span>     <span class="p">[</span><span class="no">ebp-var_CurrentThread</span><span class="p">],</span> <span class="no">eax</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00410626</span>                 <span class="nf">cmp</span>     <span class="no">byte</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">eax</span><span class="err">+</span><span class="no">_KTRAP_FRAME.SegGs</span><span class="p">],</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0041062</span><span class="nf">A</span>                 <span class="no">jnz</span>     <span class="no">loc_43C680</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00410630</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00410630</span> <span class="nl">loc_410630:</span>                             <span class="c1">; CODE XREF: KiInitializeUserApc(x,x,x,x,x,x)+2C12F↓j
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00410630</span>                 <span class="nf">mov</span>     <span class="no">eax</span><span class="p">,</span> <span class="p">[</span><span class="no">ebp</span><span class="err">+</span><span class="no">var_2EC</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00410636</span>                 <span class="nf">mov</span>     <span class="p">[</span><span class="no">ebx</span><span class="err">+</span><span class="no">_KTRAP_FRAME.HardwareEsp</span><span class="p">],</span> <span class="no">eax</span> <span class="c1">; 修改Trap_Frame中的ESP
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00410639</span>                 <span class="nf">mov</span>     <span class="no">ecx</span><span class="p">,</span> <span class="no">ds</span><span class="p">:</span><span class="no">_KeUserApcDispatcher</span> <span class="c1">; ntdll.KiUserApcDispatcher
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0041063</span><span class="nf">F</span>                 <span class="no">mov</span>     <span class="p">[</span><span class="no">ebx</span><span class="err">+</span><span class="no">_KTRAP_FRAME._Eip</span><span class="p">],</span> <span class="no">ecx</span> <span class="c1">; 修改Trap_Frame的eip,由KiUserApcDispatcher执行用户APC
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00410642</span>                 <span class="nf">and</span>     <span class="p">[</span><span class="no">ebx</span><span class="err">+</span><span class="no">_KTRAP_FRAME.ErrCode</span><span class="p">],</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00410646</span>                 <span class="nf">mov</span>     <span class="no">ecx</span><span class="p">,</span> <span class="p">[</span><span class="no">ebp</span><span class="err">+</span><span class="no">arg_NormalRoutine</span><span class="p">]</span> <span class="c1">; 将APC用到的4个值放到堆栈
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00410649</span>                 <span class="nf">mov</span>     <span class="p">[</span><span class="no">eax</span><span class="p">],</span> <span class="no">ecx</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0041064</span><span class="nf">B</span>                 <span class="no">push</span>    <span class="mi">4</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0041064</span><span class="nf">D</span>                 <span class="no">pop</span>     <span class="no">ecx</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0041064</span><span class="nf">E</span>                 <span class="no">add</span>     <span class="no">eax</span><span class="p">,</span> <span class="no">ecx</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00410650</span>                 <span class="nf">mov</span>     <span class="p">[</span><span class="no">ebp</span><span class="err">+</span><span class="no">var_2EC</span><span class="p">],</span> <span class="no">eax</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00410656</span>                 <span class="nf">mov</span>     <span class="no">edx</span><span class="p">,</span> <span class="p">[</span><span class="no">ebp</span><span class="err">+</span><span class="no">NormalContext</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00410659</span>                 <span class="nf">mov</span>     <span class="p">[</span><span class="no">eax</span><span class="p">],</span> <span class="no">edx</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0041065</span><span class="nf">B</span>                 <span class="no">add</span>     <span class="no">eax</span><span class="p">,</span> <span class="no">ecx</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0041065</span><span class="nf">D</span>                 <span class="no">mov</span>     <span class="p">[</span><span class="no">ebp</span><span class="err">+</span><span class="no">var_2EC</span><span class="p">],</span> <span class="no">eax</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00410663</span>                 <span class="nf">mov</span>     <span class="no">edx</span><span class="p">,</span> <span class="p">[</span><span class="no">ebp</span><span class="err">+</span><span class="no">SystemArgument1</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00410666</span>                 <span class="nf">mov</span>     <span class="p">[</span><span class="no">eax</span><span class="p">],</span> <span class="no">edx</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00410668</span>                 <span class="nf">add</span>     <span class="no">eax</span><span class="p">,</span> <span class="no">ecx</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0041066</span><span class="nf">A</span>                 <span class="no">mov</span>     <span class="p">[</span><span class="no">ebp</span><span class="err">+</span><span class="no">var_2EC</span><span class="p">],</span> <span class="no">eax</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00410670</span>                 <span class="nf">mov</span>     <span class="no">edx</span><span class="p">,</span> <span class="p">[</span><span class="no">ebp</span><span class="err">+</span><span class="no">SystemArgument2</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00410673</span>                 <span class="nf">mov</span>     <span class="p">[</span><span class="no">eax</span><span class="p">],</span> <span class="no">edx</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00410675</span>                 <span class="nf">add</span>     <span class="no">eax</span><span class="p">,</span> <span class="no">ecx</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00410677</span>                 <span class="nf">mov</span>     <span class="p">[</span><span class="no">ebp</span><span class="err">+</span><span class="no">var_2EC</span><span class="p">],</span> <span class="no">eax</span> <span class="c1">; 修复r3堆栈栈顶
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0041067</span><span class="nf">D</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0041067</span><span class="nf">D</span> <span class="no">loc_41067D</span><span class="p">:</span>                             <span class="c1">; CODE XREF: KiInitializeUserApc(x,x,x,x,x,x)+3B43A↓j
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0041067</span><span class="nf">D</span>                 <span class="no">or</span>      <span class="p">[</span><span class="no">ebp</span><span class="err">+</span><span class="no">ms_exc.registration.TryLevel</span><span class="p">],</span> <span class="mi">0</span><span class="no">FFFFFFFFh</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00410681</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00410681</span> <span class="nl">loc_410681:</span>                             <span class="c1">; CODE XREF: KiInitializeUserApc(x,x,x,x,x,x)+2D↑j
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">00410681</span>                 <span class="nf">mov</span>     <span class="no">ecx</span><span class="p">,</span> <span class="p">[</span><span class="no">ebp</span><span class="err">+</span><span class="no">var_1C</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00410684</span>                 <span class="nf">call</span>    <span class="no">sub_403063</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00410689</span>                 <span class="nf">call</span>    <span class="no">__SEH_epilog</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0041068</span><span class="nf">E</span>                 <span class="no">retn</span>    <span class="mi">18</span><span class="no">h</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0041068</span><span class="nf">E</span> <span class="c1">; } // starts at 410555
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">0041068</span><span class="nf">E</span> <span class="no">_KiInitializeUserApc@24</span> <span class="no">endp</span></span></span></code></pre></div><p><img loading="lazy" src="/posts/2023-2-winkernelapc/image-20230224142512175.png" alt="image-20230224142512175" srcset="/posts/2023-2-winkernelapc/image-20230224142512175.png?size=small, /posts/2023-2-winkernelapc/image-20230224142512175.png?size=medium 1.5x, /posts/2023-2-winkernelapc/image-20230224142512175.png?size=large 2x" data-title="image-20230224142512175" style="--width: 736px;--aspect-ratio: 736 / 463;background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<h3 id="kiuserapcdispatcher" class="heading-element">
  <a href="#kiuserapcdispatcher" class="heading-mark"></a>KiUserApcDispatcher</h3><ol>
<li>当用户在3环调用<code>QueueUserAPC</code>函数来插入APC时，不需要提供<code>NormalRoutine</code>，这个参数是在<code>QueueUserAPC</code>内部指定的：<code>Kernel.BaseDispatchAPC</code></li>
<li><code>ZwContinue</code>函数的意义：
<ol>
<li>返回内核，如果还有用户APC，重复上面的执行过程</li>
<li>如果没有需要执行的用户APC，会将 CONTEXT 赋值给 <code>Trap_Frame</code> 结构体，就像从来没有修改过一样；<code>ZwContinue</code>后面的代码不会执行，线程从哪里进0环仍然会从哪里回去</li>
</ol>
</li>
</ol>
<div class="highlight" id="id-18"><pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">7</span><span class="nf">C92E430</span> <span class="no">_KiUserApcDispatcher@20</span> <span class="no">proc</span> <span class="no">near</span>       <span class="c1">; DATA XREF: .text:off_7C923428↑o
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">7</span><span class="nf">C92E430</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">7</span><span class="nf">C92E430</span> <span class="no">arg_C</span>           <span class="err">=</span> <span class="no">byte</span> <span class="no">ptr</span>  <span class="mi">10</span><span class="no">h</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">7</span><span class="nf">C92E430</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">7</span><span class="nf">C92E430</span>                 <span class="no">lea</span>     <span class="no">edi</span><span class="p">,</span> <span class="p">[</span><span class="no">esp</span><span class="err">+</span><span class="no">arg_C</span><span class="p">]</span> <span class="c1">; +10是r3的context
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">7</span><span class="nf">C92E434</span>                 <span class="no">pop</span>     <span class="no">eax</span>             <span class="c1">; 处理用户APC的总入口，NormalRoutine
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">7</span><span class="nf">C92E435</span>                 <span class="no">call</span>    <span class="no">eax</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">7</span><span class="nf">C92E437</span>                 <span class="no">push</span>    <span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">7</span><span class="nf">C92E439</span>                 <span class="no">push</span>    <span class="no">edi</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">7</span><span class="nf">C92E43A</span>                 <span class="no">call</span>    <span class="no">_ZwContinue@8</span>   <span class="c1">; 返回到用户内核
</span></span></span><span class="line"><span class="cl"><span class="c1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">7</span><span class="nf">C92D040</span> <span class="no">_ZwContinue@8</span>   <span class="no">proc</span> <span class="no">near</span>               <span class="c1">; CODE XREF: KiUserApcDispatcher(x,x,x,x,x)+A↓p
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">7</span><span class="nf">C92D040</span>                                         <span class="c1">; KiUserExceptionDispatcher(x,x)+17↓p ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">7</span><span class="nf">C92D040</span>                 <span class="no">mov</span>     <span class="no">eax</span><span class="p">,</span> <span class="mi">20</span><span class="no">h</span> <span class="c1">; &#39; &#39;  ; NtContinue
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">7</span><span class="nf">C92D045</span>                 <span class="no">mov</span>     <span class="no">edx</span><span class="p">,</span> <span class="mi">7</span><span class="no">FFE0300h</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">7</span><span class="nf">C92D04A</span>                 <span class="no">call</span>    <span class="no">dword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">edx</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">7</span><span class="nf">C92D04C</span>                 <span class="no">retn</span>    <span class="mi">8</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">7</span><span class="nf">C92D04C</span> <span class="no">_ZwContinue@8</span>   <span class="no">endp</span></span></span></code></pre></div><p>以上可以用一张图表示：</p>
<p><img loading="lazy" src="/posts/2023-2-winkernelapc/1827556-20191103170141163-71115727.png" alt="img" srcset="/posts/2023-2-winkernelapc/1827556-20191103170141163-71115727.png?size=small, /posts/2023-2-winkernelapc/1827556-20191103170141163-71115727.png?size=medium 1.5x, /posts/2023-2-winkernelapc/1827556-20191103170141163-71115727.png?size=large 2x" data-title="img" style="--width: 1464px;--aspect-ratio: 1464 / 707;background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<h3 id="总结-1" class="heading-element">
  <a href="#%e6%80%bb%e7%bb%93-1" class="heading-mark"></a>总结</h3><ol>
<li>内核APC在线程切换时执行，不需要换栈，比较简单，一个循环执行完毕</li>
<li>用户APC在系统调用、中断或异常返回3环前会进行判断，如果有要执行的用户APC，再执行</li>
<li>用户APC执行前会先执行内核APC</li>
</ol>
</div><div class="post-footer" id="post-footer">
  <div class="post-info">
    <div class="post-info-line">
      <div class="post-info-mod">
        <span title="更新于 2023-02-26 00:00:00">更新于 2023-02-26&nbsp;</span>
      </div><div class="post-info-license">
            <span><a rel="license external nofollow noopener noreferrer" href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a></span>
          </div></div><div class="post-info-line">
        <div class="post-info-md"></div>
        <div class="post-info-share">
          <span><a href="javascript:void(0);" title="分享到 Twitter" data-sharer="twitter" data-url="http://localhost:1313/posts/2023-2-winkernelapc/" data-title="Windows内核(七)——APC机制" data-hashtags="Win32"><i class="fa-brands fa-twitter fa-fw" aria-hidden="true"></i></a>
  <a href="javascript:void(0);" title="分享到 Facebook" data-sharer="facebook" data-url="http://localhost:1313/posts/2023-2-winkernelapc/" data-hashtag="Win32"><i class="fa-brands fa-facebook-square fa-fw" aria-hidden="true"></i></a>
  <a href="javascript:void(0);" title="分享到 微博" data-sharer="weibo" data-url="http://localhost:1313/posts/2023-2-winkernelapc/" data-title="Windows内核(七)——APC机制"><i class="fa-brands fa-weibo fa-fw" aria-hidden="true"></i></a>
  </span>
        </div>
      </div></div>

  <div class="post-info-more">
    <section class="post-tags"><i class="fa-solid fa-tags fa-fw me-1" aria-hidden="true"></i><a href="/tags/win32/" class="post-tag" title="标签 - Win32">Win32</a></section>
    <section>
      <span><a href="javascript:void(0);" onclick="window.history.back();">返回</a></span>&nbsp;|&nbsp;<span><a href="/">主页</a></span>
    </section>
  </div>

  <div class="post-nav"><a href="/posts/2023-2-winkernel%E4%BA%8B%E4%BB%B6%E7%AD%89%E5%BE%85/" class="post-nav-item" rel="prev" title="Windows内核(六)——事件等待"><i class="fa-solid fa-angle-left fa-fw" aria-hidden="true"></i>Windows内核(六)——事件等待</a>
      <a href="/posts/2023-3-winkernel%E5%BC%82%E5%B8%B8/" class="post-nav-item" rel="next" title="Windows内核(八)——异常">Windows内核(八)——异常<i class="fa-solid fa-angle-right fa-fw" aria-hidden="true"></i></a></div>
</div>
</article>

  <aside class="toc" id="toc-auto" aria-label="目录"><h2 class="toc-title">目录&nbsp;<i class="toc-icon fa-solid fa-angle-down fa-fw" aria-hidden="true"></i></h2>
      <div class="toc-content" id="toc-content-auto"></div></aside></main><footer class="footer">
    <div class="footer-container"><div class="footer-line powered">由 <a href="https://gohugo.io/" target="_blank" rel="external nofollow noopener noreferrer" title="Hugo 0.124.1"><img class="hugo-icon" src="/images/hugo.min.svg" alt="Hugo logo" /> Hugo</a> 强力驱动 | 主题 - <a href="https://github.com/hugo-fixit/FixIt" target="_blank" rel="external" title="FixIt v0.3.2"><img class="fixit-icon" src="/images/fixit.min.svg" alt="FixIt logo" /> FixIt</a>
        </div><div class="footer-line copyright" itemscope itemtype="http://schema.org/CreativeWork"><i class="fa-regular fa-copyright fa-fw" aria-hidden="true"></i>
            <span itemprop="copyrightYear">2024</span><span class="author" itemprop="copyrightHolder">
              <a href="/"></a></span></div></div>
  </footer></div><div class="widgets"><div class="fixed-buttons animate__faster d-none"><div class="fixed-button back-to-top" role="button" aria-label="回到顶部"><i class="fa-solid fa-arrow-up fa-fw" aria-hidden="true"></i><span class="variant-numeric d-none">0%</span>
        </div></div><div id="mask"></div><noscript>
    <div class="noscript-warning">FixIt 主题在启用 JavaScript 的情况下效果最佳。</div>
  </noscript>
</div><link rel="preload" href="/lib/katex/katex.min.css" as="style" onload="this.removeAttribute('onload');this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="/lib/katex/katex.min.css"></noscript><link rel="stylesheet" href="/lib/cookieconsent/cookieconsent.min.css"><script src="/lib/sharer/sharer.min.js" async defer></script><script src="/lib/katex/katex.min.js" defer></script><script src="/lib/katex/auto-render.min.js" defer></script><script src="/lib/katex/copy-tex.min.js" defer></script><script src="/lib/katex/mhchem.min.js" defer></script><script src="/lib/cookieconsent/cookieconsent.min.js" defer></script><script>window.config={"code":{"copyTitle":"复制到剪贴板","editLockTitle":"锁定可编辑代码块","editUnLockTitle":"解锁可编辑代码块","editable":true,"maxShownLines":10},"comment":{"enable":false},"cookieconsent":{"content":{"dismiss":"同意","link":"了解更多","message":"本网站使用 Cookies 来改善您的浏览体验。"},"enable":true,"palette":{"button":{"background":"#f0f0f0"},"popup":{"background":"#1aa3ff"}},"theme":"edgeless"},"math":{"delimiters":[{"display":true,"left":"$$","right":"$$"},{"display":true,"left":"\\[","right":"\\]"},{"display":true,"left":"\\begin{equation}","right":"\\end{equation}"},{"display":true,"left":"\\begin{equation*}","right":"\\end{equation*}"},{"display":true,"left":"\\begin{align}","right":"\\end{align}"},{"display":true,"left":"\\begin{align*}","right":"\\end{align*}"},{"display":true,"left":"\\begin{alignat}","right":"\\end{alignat}"},{"display":true,"left":"\\begin{alignat*}","right":"\\end{alignat*}"},{"display":true,"left":"\\begin{gather}","right":"\\end{gather}"},{"display":true,"left":"\\begin{CD}","right":"\\end{CD}"},{"display":false,"left":"$","right":"$"},{"display":false,"left":"\\(","right":"\\)"}],"strict":false}};</script><script src="/js/theme.min.js" defer></script></body>
</html>
